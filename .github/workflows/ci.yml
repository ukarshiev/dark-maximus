name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Install Node.js dependencies
      run: |
        npm install
    
    - name: Install codex.docs dependencies
      run: |
        cd codex.docs && yarn install --frozen-lockfile || npm install
      continue-on-error: true
    
    - name: Run Python linting (pylint)
      run: |
        pylint src/shop_bot/ --disable=C0111,C0103 --fail-under=7.0
    
    - name: Run Python formatting check (black)
      run: |
        black --check src/shop_bot/
    
    - name: Run Jinja2 templates linting (djlint)
      run: |
        djlint --check src/shop_bot/webhook_server/templates/ apps/user-cabinet/templates/ || true
    
    - name: Run TypeScript linting (codex.docs)
      run: |
        cd codex.docs && yarn lint || npm run lint
      continue-on-error: true
    
    - name: Run JavaScript linting (eslint)
      run: |
        eslint apps/user-cabinet/static/js/ src/shop_bot/webhook_server/static/js/ apps/web-interface/server.js || true
    
    - name: Run HTML linting (htmlhint)
      run: |
        htmlhint apps/web-interface/src/*.html || true
    
    - name: Run CSS linting (stylelint)
      run: |
        stylelint "src/shop_bot/webhook_server/static/css/*.css" "apps/user-cabinet/static/css/*.css" --ignore-path .stylelintignore || true

  test:
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install -e ".[test]"
    
    - name: Check if bot can start
      run: |
        python -c "from shop_bot import __main__; print('âœ… Bot imports successfully')"
    
    - name: Run tests with Allure
      run: |
        pytest tests/ --alluredir=allure-results -v
      continue-on-error: true
    
    - name: Install Allure CLI
      uses: simple-elf/allure-report-action@master
      if: always()
      with:
        allure_results: allure-results
        allure_history: allure-history
        keep_reports: 20
    
    - name: Generate Allure Report with Categories
      if: always()
      run: |
        if [ -f allure-categories.json ]; then
          allure generate allure-results -o allure-report --clean --categories allure-categories.json
        else
          allure generate allure-results -o allure-report --clean
        fi
    
    - name: Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: allure-report
        path: allure-report/
        retention-days: 30
    
    - name: Analyze Allure Defects
      if: always()
      run: |
        python tests/ad-hoc/export_allure_defects.py
        python tests/ad-hoc/analyze_allure_defects.py
      continue-on-error: true
    
    - name: Upload Defects Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: allure-defects-report
        path: tests/ad-hoc/reports/allure-defects-report.md
        retention-days: 30

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: dark-maximus:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
