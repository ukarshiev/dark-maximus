services:
  bot:
    build: .
    container_name: dark-maximus-bot
    restart: unless-stopped
    ports:
      - '127.0.0.1:50000:50000'
    volumes:
      - ./users.db:/app/project/users.db
      - ./logs:/app/project/logs
      - ./backups:/app/project/backups
      - ./instructions:/app/project/instructions
      - ./video_instructions:/app/project/video_instructions
      - ./sessions:/app/sessions
      # Volume-маппинги для исходного кода (позволяют изменения без пересборки)
      - ./src:/app/project/src
      - ./src/shop_bot/webhook_server/templates:/app/project/src/shop_bot/webhook_server/templates
      - ./src/shop_bot/webhook_server/static:/app/project/src/shop_bot/webhook_server/static
      # Маппинг корневых файлов проекта
      - ./pyproject.toml:/app/project/pyproject.toml
      - ./CHANGELOG.md:/app/project/CHANGELOG.md
      # Docker socket для управления контейнерами из панели
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY}
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - dark-maximus-network

  docs:
    build:
      context: .
      dockerfile: Dockerfile.docs
    container_name: dark-maximus-docs
    restart: unless-stopped
    ports:
      - '127.0.0.1:3001:80'
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - dark-maximus-network

  codex-docs:
    build:
      context: .
      dockerfile: Dockerfile.codex-docs
    container_name: dark-maximus-codex-docs
    restart: unless-stopped
    ports:
      - '127.0.0.1:3002:3000'
    volumes:
      - ./codex.docs/uploads:/usr/src/app/uploads
      - ./codex.docs/db:/usr/src/app/db
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - dark-maximus-network

  user-cabinet:
    build:
      context: ./apps/user-cabinet
      dockerfile: Dockerfile
    container_name: dark-maximus-user-cabinet
    restart: unless-stopped
    ports:
      - '127.0.0.1:3003:3003'
    volumes:
      - ./users.db:/app/project/users.db
      - ./src:/app/project/src
    environment:
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY}
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3003 || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - dark-maximus-network

networks:
  dark-maximus-network:
    driver: bridge
    name: dark-maximus-network