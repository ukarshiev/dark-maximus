# Инструкция по откату лишних начислений бонусов на продакшне

## Проблема

Пользователи 6044240344 и 976124857 многократно активировали промокод FIVEH, что привело к многократному начислению бонусов:
- Пользователь 6044240344: баланс 1470 RUB (должен быть 500 RUB)
- Пользователь 976124857: баланс 1000 RUB (должен быть 500 RUB)

## Решение

Использовать скрипт `rollback_promo_bonus.py` для отката лишних начислений.

## Шаги выполнения

### 1. Подключение к продакшн серверу

```bash
ssh root@31.56.27.129
```

### 2. Переход в директорию проекта

```bash
cd /root/dark-maximus
```

### 3. Проверка текущего состояния (DRY RUN)

Сначала выполняем проверку без изменений:

```bash
python tests/ad-hoc/utils/rollback_promo_bonus.py \
    --dry-run \
    --db-path /root/dark-maximus/users.db \
    --promo-code FIVEH \
    --specific-users 6044240344,976124857
```

**Ожидаемый вывод:**
```
================================================================================
Скрипт отката лишних начислений бонусов по промокодам
Дата запуска: 2025-11-29 XX:XX:XX
Режим: DRY RUN (без изменений)
БД: /root/dark-maximus/users.db
Промокод: FIVEH
================================================================================
Промокод 'FIVEH' (ID: X), бонус: 500.0 RUB
Найдено пользователей с многократными начислениями: 2
Фильтрация по user_id: [6044240344, 976124857]
Пользователей после фильтрации: 2

Пользователь: 6044240344 (@k4rum_fwd)
  Текущий баланс: 1470.0 RUB
  Количество применений промокода: 3
  Ожидаемый бонус: 500.0 RUB
  Фактически начислено: 1500.0 RUB
  Лишнее начисление: 1000.0 RUB

Пользователь: 976124857 (@Lo170)
  Текущий баланс: 1000.0 RUB
  Количество применений промокода: 2
  Ожидаемый бонус: 500.0 RUB
  Фактически начислено: 1000.0 RUB
  Лишнее начисление: 500.0 RUB

Общая сумма лишних начислений: 1500.0 RUB

[DRY RUN] Пользователь 6044240344: баланс 1470.0 -> 470.0 (откат 1000.0 RUB)
[DRY RUN] Пользователь 6044240344, промокод X: оставить запись Y, удалить 2 дублей
[DRY RUN] Пользователь 976124857: баланс 1000.0 -> 500.0 (откат 500.0 RUB)
[DRY RUN] Пользователь 976124857, промокод X: оставить запись Z, удалить 1 дубль

================================================================================
Обработано пользователей: 2
Успешно: 2
Ошибок: 0
Откачено бонусов: 1500.0 RUB
================================================================================
```

### 4. Резервное копирование БД

**КРИТИЧЕСКИ ВАЖНО:** Перед выполнением отката создайте резервную копию БД!

```bash
cp /root/dark-maximus/users.db /root/dark-maximus/users.db.backup.$(date +%Y%m%d_%H%M%S)
```

Проверьте, что резервная копия создана:

```bash
ls -lh /root/dark-maximus/users.db.backup.*
```

### 5. Выполнение отката (PRODUCTION)

**ВНИМАНИЕ:** Эта команда изменит данные в продакшн БД!

```bash
python tests/ad-hoc/utils/rollback_promo_bonus.py \
    --db-path /root/dark-maximus/users.db \
    --promo-code FIVEH \
    --specific-users 6044240344,976124857
```

Скрипт запросит подтверждение:
```
Выполнить откат? (yes/no):
```

Введите `yes` для подтверждения.

**Ожидаемый результат:**
```
Пользователь 6044240344: баланс откачен 1470.0 -> 470.0 (откат 1000.0 RUB)
Удалена запись X (дата: ..., статус: applied)
Удалена запись Y (дата: ..., статус: applied)
Пользователь 6044240344, промокод Z: удалено 2 дублирующихся записей

Пользователь 976124857: баланс откачен 1000.0 -> 500.0 (откат 500.0 RUB)
Удалена запись X (дата: ..., статус: applied)
Пользователь 976124857, промокод Z: удалено 1 дублирующихся записей

================================================================================
Обработано пользователей: 2
Успешно: 2
Ошибок: 0
Откачено бонусов: 1500.0 RUB
================================================================================
```

### 6. Проверка результата

Проверьте баланс пользователей после отката:

```bash
sqlite3 /root/dark-maximus/users.db "SELECT telegram_id, username, balance FROM users WHERE telegram_id IN (6044240344, 976124857);"
```

**Ожидаемый результат:**
```
6044240344|k4rum_fwd|470.0
976124857|Lo170|500.0
```

Проверьте записи в `promo_code_usage`:

```bash
sqlite3 /root/dark-maximus/users.db "SELECT user_id, promo_id, status, used_at FROM promo_code_usage WHERE user_id IN (6044240344, 976124857) ORDER BY user_id, used_at;"
```

**Ожидаемый результат:** Для каждого пользователя должна быть только одна запись.

### 7. Проверка других пользователей

Проверьте, нет ли других пользователей с аналогичной проблемой:

```bash
python tests/ad-hoc/utils/rollback_promo_bonus.py \
    --dry-run \
    --db-path /root/dark-maximus/users.db \
    --promo-code FIVEH
```

Если найдены другие пользователи, повторите шаги 4-6 для них.

## Восстановление из резервной копии (если что-то пошло не так)

Если откат прошел некорректно, восстановите БД из резервной копии:

```bash
# Остановите бота
docker compose stop bot

# Восстановите БД
cp /root/dark-maximus/users.db.backup.YYYYMMDD_HHMMSS /root/dark-maximus/users.db

# Запустите бота
docker compose start bot
```

## Логи

Все операции логируются в файл:
```
/root/dark-maximus/logs/rollback_promo_bonus.log
```

Просмотр логов:
```bash
tail -f /root/dark-maximus/logs/rollback_promo_bonus.log
```

## Проверка исправления кода

После отката проверьте, что исправление кода работает корректно:

1. Перейдите по deeplink ссылке с промокодом FIVEH
2. Проверьте баланс пользователя
3. Повторно перейдите по той же ссылке
4. Проверьте, что баланс не изменился

**Deeplink ссылка для тестирования:**
```
https://t.me/maximus_vpn_bot?start=eyJnIjoiZnJpZW5kcyIsInAiOiJGSVZFSCJ9
```

## Контакты для поддержки

Если возникли проблемы при выполнении отката, обратитесь к разработчику.

