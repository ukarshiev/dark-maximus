# KAR-30 –≠—Ç–∞–ø 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö - –ó–ê–í–ï–†–®–Å–ù ‚úÖ

**–î–∞—Ç–∞:** 07.11.2025 05:39 (UTC+3)  
**–í–µ—Ä—Å–∏—è:** 3.15.0  
**Linear:** https://linear.app/karshiev/issue/KAR-30  
**–ü–ª–∞–Ω:** `.cursor/plans/timezone-support-production-safe.plan.md`

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–°–∫—Ä–∏–ø—Ç:** `tests/add_timezone_column.py`

#### –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ timezone
- **–¢–∞–±–ª–∏—Ü–∞:** `users`
- **–ö–æ–ª–æ–Ω–∫–∞:** `timezone TEXT DEFAULT 'Europe/Moscow'`
- **–°—Ç–∞—Ç—É—Å:** –î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ, –≤—Å–µ 5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–º–µ—é—Ç timezone

#### –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ bot_settings
```sql
feature_timezone_enabled = '0'  -- Feature flag –≤—ã–∫–ª—é—á–µ–Ω
admin_timezone = 'Europe/Moscow'  -- Timezone –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

### 2. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –≤ database.py

**–§–∞–π–ª:** `src/shop_bot/data_manager/database.py` (—Å—Ç—Ä–æ–∫–∏ 2133-2266)

#### –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å feature flag:
- `is_timezone_feature_enabled() -> bool`
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å timezone
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True` —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `feature_timezone_enabled = '1'`

#### –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å admin timezone:
- `get_admin_timezone() -> str`
  - –ü–æ–ª—É—á–∞–µ—Ç timezone –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  - Fallback –Ω–∞ `'Europe/Moscow'` –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏/–æ—à–∏–±–∫–µ

- `set_admin_timezone(timezone: str) -> bool`
  - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç timezone –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  - –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `zoneinfo.ZoneInfo()` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –≤ Windows)
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True` –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, `False` –ø—Ä–∏ –æ—à–∏–±–∫–µ

#### –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å user timezone:
- `get_user_timezone(user_id: int) -> str`
  - –ü–æ–ª—É—á–∞–µ—Ç timezone –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users
  - Fallback –Ω–∞ `get_admin_timezone()` –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏/–æ—à–∏–±–∫–µ

- `set_user_timezone(user_id: int, timezone: str) -> bool`
  - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç timezone –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `zoneinfo.ZoneInfo()` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –≤ Windows)
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True` –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, `False` –ø—Ä–∏ –æ—à–∏–±–∫–µ

### 3. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°–∫—Ä–∏–ø—Ç:** `tests/test_timezone_functions.py`

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:
```
============================================================
TEST RESULTS SUMMARY
============================================================
[PASS] Database Structure
[PASS] Feature Flag
[PASS] Admin Timezone
[PASS] User Timezone

============================================================
ALL TESTS PASSED ‚úÖ
============================================================
```

**–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:** 4  
**–£—Å–ø–µ—à–Ω—ã—Ö:** 4 (100%)  
**–ü—Ä–æ–≤–∞–ª—å–Ω—ã—Ö:** 0

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Feature Flag
- ‚úÖ `feature_timezone_enabled = '0'` (–≤—ã–∫–ª—é—á–µ–Ω)
- ‚úÖ –°—Ç–∞—Ä—ã–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

### ALTER TABLE
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞ –≤ SQLite (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ DEFAULT –∑–Ω–∞—á–µ–Ω–∏–µ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º

### –í–∞–ª–∏–¥–∞—Ü–∏—è Timezone
- ‚úÖ –í production (Docker): —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `zoneinfo.ZoneInfo()`
- ‚úÖ –í Windows dev: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
- ‚úÖ Fallback –Ω–∞ 'Europe/Moscow' –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã users
```sql
CREATE TABLE users (
    telegram_id INTEGER PRIMARY KEY,
    username TEXT,
    total_spent REAL DEFAULT 0,
    total_months INTEGER DEFAULT 0,
    trial_used INTEGER DEFAULT 0,
    agreed_to_terms INTEGER DEFAULT 0,
    agreed_to_documents INTEGER DEFAULT 0,
    subscription_status TEXT DEFAULT 'not_checked',
    registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_banned INTEGER DEFAULT 0,
    referred_by INTEGER,
    referral_balance REAL DEFAULT 0,
    referral_balance_all REAL DEFAULT 0,
    balance REAL DEFAULT 0,
    timezone TEXT DEFAULT 'Europe/Moscow'  -- ‚Üê –ù–û–í–ê–Ø –ö–û–õ–û–ù–ö–ê
);
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ bot_settings
```
feature_timezone_enabled = 0
admin_timezone = Europe/Moscow
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- **–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 5
- **–° timezone:** 5 (100%)
- **–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π timezone:** Europe/Moscow

---

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –í–∞–ª–∏–¥–∞—Ü–∏—è Timezone
- **–°—Ç–∞–Ω–¥–∞—Ä—Ç:** IANA timezone names (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Europe/Moscow")
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:** `zoneinfo.ZoneInfo()` (Python 3.9+)
- **Windows:** –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ tzdata –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
- **Docker:** –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (tzdata —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

### Fallback –õ–æ–≥–∏–∫–∞
```
get_user_timezone(user_id)
  ‚Üì
user.timezone IS NOT NULL?
  ‚îú‚îÄ YES ‚Üí return user.timezone
  ‚îî‚îÄ NO  ‚Üí return get_admin_timezone()
              ‚Üì
           admin_timezone setting exists?
              ‚îú‚îÄ YES ‚Üí return admin_timezone
              ‚îî‚îÄ NO  ‚Üí return 'Europe/Moscow'
```

---

## üìù –°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤

1. `tests/add_timezone_column.py` - —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
2. `tests/check_timezone_migration.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
3. `tests/test_timezone_functions.py` - unit —Ç–µ—Å—Ç—ã
4. `tests/fix_invalid_timezones.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö timezone
5. `tests/KAR-30_STAGE_2_REPORT.md` - —ç—Ç–æ—Ç –æ—Ç—á—ë—Ç

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] –ö–æ–ª–æ–Ω–∫–∞ `timezone` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Ç–∞–±–ª–∏—Ü—É `users`
- [x] –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `bot_settings`
- [x] –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ `database.py`
- [x] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [x] Feature flag –≤—ã–∫–ª—é—á–µ–Ω (0)
- [x] –°—Ç–∞—Ä—ã–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] CHANGELOG.md –æ–±–Ω–æ–≤–ª—ë–Ω
- [x] pyproject.toml –æ–±–Ω–æ–≤–ª—ë–Ω (–≤–µ—Ä—Å–∏—è 3.15.0)

---

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É

**–≠—Ç–∞–ø 3:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å datetime_utils –∏ –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π

### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç—Ç–∞–ø–∞:
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –≥–æ—Ç–æ–≤–∞
- ‚úÖ –§—É–Ω–∫—Ü–∏–∏ get/set timezone –≥–æ—Ç–æ–≤—ã
- ‚úÖ Feature flag —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –≤—ã–∫–ª—é—á–µ–Ω
- ‚úÖ datetime_utils.py –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é (–∏–∑ –≠—Ç–∞–ø–∞ 0-1)

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `get_user_timezone()` –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç
2. –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å `format_datetime_moscow()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è user timezone
3. –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
4. –î–æ–±–∞–≤–∏—Ç—å UI –¥–ª—è —Å–º–µ–Ω—ã timezone (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ production

---

## üìä –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è:** 3.14.0  
**–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è:** 3.15.0  
**–¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏—è:** –ú–∏–Ω–æ—Ä (–Ω–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)

### –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –≤ –ë–î
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ API
- –≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ KAR-30

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–≠—Ç–∞–ø 2 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!** ‚úÖ

–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ –ø–æ–¥–¥–µ—Ä–∂–∫–µ timezone.
Feature flag –≤—ã–∫–ª—é—á–µ–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
–°—Ç–∞—Ä—ã–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

**–ì–æ—Ç–æ–≤—ã –∫ –ø–µ—Ä–µ—Ö–æ–¥—É –Ω–∞ –≠—Ç–∞–ø 3!** üöÄ

---

**–û—Ç—á—ë—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** 07.11.2025 05:39 (UTC+3)  
**–ê–≤—Ç–æ—Ä:** AI Assistant (Claude Sonnet 4.5)

