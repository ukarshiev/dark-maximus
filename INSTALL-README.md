# Инструкция по установке dark-maximus

## Быстрая установка

### 1. Основная установка (HTTP)
```bash
curl -sSL https://raw.githubusercontent.com/ukarshiev/dark-maximus/main/install.sh | sudo bash
```

Этот скрипт:
- Установит все необходимые зависимости (Docker, nginx, certbot)
- Создаст самоподписанные SSL сертификаты
- Настроит nginx-прокси для работы по HTTP
- Запустит все сервисы

### 2. Настройка SSL (HTTPS)
После успешной установки и настройки DNS записей:

```bash
cd dark-maximus
chmod +x setup-ssl.sh
sudo ./setup-ssl.sh
```

Этот скрипт:
- Проверит DNS записи
- Выпустит Let's Encrypt SSL сертификаты
- Настроит nginx для работы по HTTPS
- Настроит автообновление сертификатов

## Что исправлено

### Проблемы в старом install.sh:
1. **Неправильные пути к SSL сертификатам**: Использовались `.crt/.key`, а Let's Encrypt создает `.pem`
2. **Неправильное монтирование volume**: Путь `/etc/letsencrypt/live` не монтировался в контейнер
3. **Неправильная логика замены**: sed команды не работали с многострочными блоками nginx
4. **Конфликт конфигураций**: nginx.conf содержал SSL, но docker-compose.yml не монтировал сертификаты

### Решения:
1. **Пошаговая установка**: Сначала HTTP, потом SSL
2. **Динамическая генерация конфигураций**: Вместо sed замен - полная генерация файлов
3. **Правильные volume**: Корректное монтирование Let's Encrypt сертификатов
4. **Проверка DNS**: Обязательная проверка перед выпуском сертификатов
5. **Отдельный SSL скрипт**: setup-ssl.sh для настройки SSL после основной установки

## Структура файлов

- `install.sh` - Основной скрипт установки (HTTP)
- `setup-ssl.sh` - Скрипт настройки SSL (HTTPS)
- `nginx/nginx.conf` - Конфигурация nginx без SSL
- `nginx/nginx-ssl.conf` - Эталонная конфигурация nginx с SSL
- `docker-compose.yml` - Docker конфигурация (обновляется динамически)

## Требования

- Ubuntu 20.04+ или Debian 10+
- Root доступ или sudo права
- Настроенные DNS A-записи для всех поддоменов
- Открытые порты 80, 443, 1488

## Поддомены

- `panel.yourdomain.com` - Панель управления ботом
- `docs.yourdomain.com` - Пользовательская документация  
- `help.yourdomain.com` - Админская документация

## Диагностика

### Проверка статуса контейнеров:
```bash
docker compose ps
```

### Проверка логов nginx-прокси:
```bash
docker compose logs nginx-proxy
```

### Проверка SSL сертификатов:
```bash
sudo certbot certificates
```

### Проверка nginx конфигурации:
```bash
docker exec dark-maximus-nginx-proxy nginx -t
```

## Устранение проблем

### Если nginx-прокси не запускается:
1. Проверьте логи: `docker compose logs nginx-proxy`
2. Проверьте конфигурацию: `docker exec dark-maximus-nginx-proxy nginx -t`
3. Убедитесь, что порты 80/443 свободны

### Если SSL не работает:
1. Проверьте DNS записи: `dig yourdomain.com`
2. Убедитесь, что сертификаты выпущены: `sudo certbot certificates`
3. Проверьте монтирование volume в docker-compose.yml

### Если сервисы недоступны:
1. Проверьте статус всех контейнеров: `docker compose ps`
2. Проверьте логи конкретного сервиса: `docker compose logs service_name`
3. Убедитесь, что все контейнеры в статусе "Up" или "healthy"

## Автообновление

Скрипт автоматически настраивает автообновление Let's Encrypt сертификатов через cron:
- Запуск каждый день в 2:30 утра
- Автоматический перезапуск nginx при обновлении сертификатов
- Логирование в `/var/log/cron.log`

## Безопасность

- Используются только доверенные Let's Encrypt сертификаты
- Современные SSL/TLS настройки (TLS 1.2/1.3)
- Автоматическое обновление сертификатов
- Правильная настройка nginx для безопасности
