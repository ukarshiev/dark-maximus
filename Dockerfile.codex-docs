# Multi-stage Dockerfile для админской документации (Codex.docs)
# Следует best practices из Docker документации

# =========================================
# Stage 1: Сборка Codex.docs
# =========================================
FROM node:20.18-alpine3.19 AS builder

WORKDIR /build

# Обновляем системные пакеты для устранения уязвимостей безопасности
RUN apk update && apk upgrade && apk add --no-cache libc6-compat

# Копируем package.json и yarn.lock для установки зависимостей
COPY codex.docs/package.json codex.docs/yarn.lock ./

# Устанавливаем зависимости
RUN yarn install --frozen-lockfile

# Копируем исходный код
COPY codex.docs/ ./

# Создаем папку dist и собираем проект
RUN mkdir -p dist && \
    echo "Начинаем сборку проекта..." && \
    yarn build-all && \
    echo "Сборка завершена. Проверяем результат..." && \
    ls -la dist/ && \
    ls -la public/dist/ && \
    test -d dist/backend && echo "✅ Папка dist/backend создана" || echo "❌ ОШИБКА: Папка dist/backend не создана!" && \
    test -f dist/backend/app.js && echo "✅ Файл dist/backend/app.js создан" || echo "❌ ОШИБКА: Файл dist/backend/app.js не создан!" && \
    test -d public/dist && echo "✅ Папка public/dist создана" || echo "❌ ОШИБКА: Папка public/dist не создана!" && \
    test -f public/dist/main.js && echo "✅ Файл public/dist/main.js создан" || echo "❌ ОШИБКА: Файл public/dist/main.js не создан!" && \
    test -f public/dist/main.css && echo "✅ Файл public/dist/main.css создан" || echo "❌ КРИТИЧЕСКАЯ ОШИБКА: Файл public/dist/main.css не создан!" && \
    test -f public/dist/theme.js && echo "✅ Файл public/dist/theme.js создан" || echo "❌ ОШИБКА: Файл public/dist/theme.js не создан!" && \
    echo "Проверка содержимого public/dist:" && \
    ls -lah public/dist/ && \
    echo "Размер main.css:" && \
    du -h public/dist/main.css || echo "❌ main.css отсутствует!"

# =========================================
# Stage 2: Подготовка конфигурации и контента
# =========================================
FROM alpine:3.19 AS config-builder

WORKDIR /build

# Копируем конфигурацию Codex.docs
COPY codex.docs/docs-config.yaml ./docs-config.yaml

# Копируем собранный контент из builder stage
COPY --from=builder /build/dist ./dist
COPY --from=builder /build/public ./public

# Проверяем, что папки были скопированы
RUN echo "Проверяем скопированную папку dist..." && \
    ls -la dist/ && \
    test -d dist/backend && echo "✅ Папка dist/backend скопирована" || echo "❌ ОШИБКА: Папка dist/backend не скопирована!" && \
    test -f dist/backend/app.js && echo "✅ Файл dist/backend/app.js скопирован" || echo "❌ ОШИБКА: Файл dist/backend/app.js не скопирован!" && \
    echo "Проверяем скопированную папку public..." && \
    ls -la public/ && \
    test -d public/dist && echo "✅ Папка public/dist скопирована" || echo "❌ ОШИБКА: Папка public/dist не скопирована!" && \
    test -f public/dist/main.js && echo "✅ Файл public/dist/main.js скопирован" || echo "❌ ОШИБКА: Файл public/dist/main.js не скопирован!" && \
    test -f public/dist/main.css && echo "✅ Файл public/dist/main.css скопирован" || echo "❌ ОШИБКА: Файл public/dist/main.css не скопирован!" && \
    test -f public/favicon.png && echo "✅ Файл public/favicon.png скопирован" || echo "⚠️  Предупреждение: Файл public/favicon.png не найден (может быть загружен динамически)"

# =========================================
# Stage 3: Codex.docs runtime
# =========================================
FROM ghcr.io/codex-team/codex.docs:v2.0.0-rc.8

# Устанавливаем netcat для healthcheck
RUN apk add --no-cache netcat-openbsd

# Копируем конфигурацию из builder stage
COPY --from=config-builder /build/docs-config.yaml /usr/src/app/docs-config.yaml

# Копируем предсобранный контент
COPY --from=config-builder /build/dist /usr/src/app/dist

# КРИТИЧЕСКИ ВАЖНО: Удаляем старую папку dist из public базового образа (если есть)
# и копируем только нашу собранную папку dist со стилями
RUN rm -rf /usr/src/app/public/dist || true
COPY --from=config-builder /build/public/dist /usr/src/app/public/dist

# Копируем остальные файлы из public (favicon и т.д.), если они есть в сборке
# Favicon копируется из config-builder stage, если он там есть
RUN if [ -f /usr/src/app/public/favicon.png ]; then echo "✅ favicon.png уже на месте"; else echo "⚠️  favicon.png не найден (не критично)"; fi || true

# Проверяем, что стили скопированы (эта проверка выполнится при сборке)
RUN echo "Проверка финальной структуры public/dist:" && \
    ls -lah /usr/src/app/public/dist/ && \
    test -f /usr/src/app/public/dist/main.css && echo "✅ main.css на месте ($(du -h /usr/src/app/public/dist/main.css | cut -f1))" || (echo "❌ КРИТИЧЕСКАЯ ОШИБКА: main.css отсутствует!" && exit 1) && \
    test -f /usr/src/app/public/dist/main.js && echo "✅ main.js на месте" || (echo "❌ ОШИБКА: main.js отсутствует!" && exit 1) && \
    test -f /usr/src/app/public/dist/theme.js && echo "✅ theme.js на месте" || echo "⚠️  Предупреждение: theme.js отсутствует"

# Volumes для данных (будут монтироваться через docker-compose)
# - /usr/src/app/uploads
# - /usr/src/app/db

# Expose порт
EXPOSE 50002

# Healthcheck
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost:50002/ || exit 1

# Команда запуска определена в базовом образе

