# API –¥–∏–∞–ª–æ–≥–æ–≤ {{PROJECT_NAME}}

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
- [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–¥–∏–∞–ª–æ–≥–æ–≤)
- [–°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π](#—Å–æ—Å—Ç–æ—è–Ω–∏—è-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- [–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥](#–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏-–∫–æ–º–∞–Ω–¥)
- [–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å](#–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã-–∏-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
- [–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û](#–ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ-–ø–æ)
- [–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π](#—Å–∏—Å—Ç–µ–º–∞-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
- [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-–ø–ª–∞—Ç–µ–∂–∞–º–∏)
- [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
- [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-–¥–∏–∞–ª–æ–≥–æ–≤)

## –û–±–∑–æ—Ä

API –¥–∏–∞–ª–æ–≥–æ–≤ {{PROJECT_NAME}} –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ aiogram 3.x –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ Telegram. –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–µ –¥–∏–∞–ª–æ–≥–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏, –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–µ–π, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ VPN-–∫–ª—é—á–∞–º–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏.

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **Handlers** - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- **Keyboards** - –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **Middlewares** - –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û
- **States** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **Callbacks** - –û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∑–∞–ø—Ä–æ—Å–æ–≤

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤

### –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Telegram      ‚îÇ    ‚îÇ   Bot Handler   ‚îÇ    ‚îÇ   Middleware    ‚îÇ
‚îÇ   User          ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ                 ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ                 ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ  - Commands     ‚îÇ    ‚îÇ  - Auth         ‚îÇ
‚îÇ  - Messages     ‚îÇ    ‚îÇ  - Messages     ‚îÇ    ‚îÇ  - Logging      ‚îÇ
‚îÇ  - Callbacks    ‚îÇ    ‚îÇ  - Callbacks    ‚îÇ    ‚îÇ  - Rate Limit   ‚îÇ
‚îÇ  - Payments     ‚îÇ    ‚îÇ  - States       ‚îÇ    ‚îÇ  - Validation   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                       ‚îÇ   Business      ‚îÇ
                       ‚îÇ   Logic         ‚îÇ
                       ‚îÇ                 ‚îÇ
                       ‚îÇ  - Database     ‚îÇ
                       ‚îÇ  - Payments     ‚îÇ
                       ‚îÇ  - VPN Keys     ‚îÇ
                       ‚îÇ  - Notifications‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–∏–Ω—Ü–∏–ø—ã –¥–∏–∑–∞–π–Ω–∞
1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** - –ö–∞–∂–¥—ã–π handler –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
2. **–°–æ—Å—Ç–æ—è–Ω–∏–µ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** - –î–∏–∞–ª–æ–≥–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
3. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - Graceful handling –≤—Å–µ—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ü–æ–ª–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
```python
from aiogram.fsm.state import State, StatesGroup

class MainMenu(StatesGroup):
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    main = State()

class KeyPurchase(StatesGroup):
    """–ü—Ä–æ—Ü–µ—Å—Å –ø–æ–∫—É–ø–∫–∏ –∫–ª—é—á–∞."""
    choose_plan = State()
    choose_payment = State()
    processing_payment = State()
    payment_success = State()

class ProfileManagement(StatesGroup):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º."""
    view_profile = State()
    view_keys = State()
    view_transactions = State()

class SupportDialog(StatesGroup):
    """–î–∏–∞–ª–æ–≥ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."""
    waiting_message = State()
    in_support = State()

class AdminPanel(StatesGroup):
    """–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å."""
    main = State()
    user_management = State()
    server_management = State()
    analytics = State()
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
```python
from aiogram.fsm.context import FSMContext

async def start_purchase_flow(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–∫—É–ø–∫–∏ –∫–ª—é—á–∞."""
    await state.set_state(KeyPurchase.choose_plan)
    await show_plans_keyboard(message)

async def handle_plan_selection(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞."""
    plan_id = callback.data.split('_')[1]
    await state.update_data(selected_plan=plan_id)
    await state.set_state(KeyPurchase.choose_payment)
    await show_payment_methods(callback.message)

async def reset_to_main_menu(message: Message, state: FSMContext):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."""
    await state.clear()
    await state.set_state(MainMenu.main)
    await show_main_menu(message)
```

## –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

#### 1. –ö–æ–º–∞–Ω–¥–∞ /start
```python
@router.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start."""
    user_id = message.from_user.id
    username = message.from_user.username or "Unknown"
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await register_user_if_not_exists(user_id, username)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞)
    if await check_subscription_required():
        if not await check_user_subscription(user_id):
            await show_subscription_required(message)
            return
    
    # –ü–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    await state.set_state(MainMenu.main)
    await show_main_menu(message)
```

#### 2. –ö–æ–º–∞–Ω–¥–∞ /help
```python
@router.message(Command("help"))
async def cmd_help(message: Message):
    """–ü–æ–∫–∞–∑ —Å–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."""
    help_text = """
ü§ñ <b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É {{PROJECT_NAME}}</b>

<b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
/profile - –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
/keys - –ú–æ–∏ –∫–ª—é—á–∏
/balance - –ú–æ–π –±–∞–ª–∞–Ω—Å
/support - –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π

<b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</b>
1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
2. –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
3. –û–ø–ª–∞—Ç–∏—Ç–µ –∑–∞–∫–∞–∑
4. –ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

<b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞:</b>
–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É —á–µ—Ä–µ–∑ /support
    """
    await message.answer(help_text, parse_mode="HTML")
```

#### 3. –ö–æ–º–∞–Ω–¥–∞ /profile
```python
@router.message(Command("profile"))
async def cmd_profile(message: Message, state: FSMContext):
    """–ü–æ–∫–∞–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user_id = message.from_user.id
    user_data = await get_user_data(user_id)
    
    if not user_data:
        await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start")
        return
    
    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è
    profile_text = format_user_profile(user_data)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø—Ä–æ—Ñ–∏–ª—è
    keyboard = create_profile_keyboard()
    
    await state.set_state(ProfileManagement.view_profile)
    await message.answer(profile_text, reply_markup=keyboard, parse_mode="HTML")
```

### Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

#### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞
```python
@router.callback_query(F.data.startswith("plan_"))
async def handle_plan_selection(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞."""
    plan_id = int(callback.data.split("_")[1])
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–∞—Ä–∏—Ñ–µ
    plan_data = await get_plan_by_id(plan_id)
    if not plan_data:
        await callback.answer("‚ùå –¢–∞—Ä–∏—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
    await state.update_data(selected_plan=plan_data)
    await state.set_state(KeyPurchase.choose_payment)
    
    # –ü–æ–∫–∞–∑ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã
    payment_keyboard = create_payment_methods_keyboard(plan_data)
    await callback.message.edit_text(
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏ {host_name}: {plan_data['plan_name']} - {plan_data['price']:.0f} RUB\n\n"
        f"–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:",
        reply_markup=payment_keyboard,
        parse_mode="HTML"
    )
    await callback.answer()
```

#### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
```python
@router.callback_query(F.data.startswith("payment_"))
async def handle_payment_selection(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã."""
    payment_method = callback.data.split("_")[1]
    user_data = await state.get_data()
    plan_data = user_data.get("selected_plan")
    
    if not plan_data:
        await callback.answer("‚ùå –¢–∞—Ä–∏—Ñ –Ω–µ –≤—ã–±—Ä–∞–Ω", show_alert=True)
        return
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
    payment_result = await create_payment(
        user_id=callback.from_user.id,
        plan_data=plan_data,
        payment_method=payment_method
    )
    
    if payment_result["success"]:
        await state.set_state(KeyPurchase.processing_payment)
        await show_payment_instructions(callback.message, payment_result)
    else:
        await callback.answer(f"‚ùå –û—à–∏–±–∫–∞: {payment_result['error']}", show_alert=True)
    
    await callback.answer()
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

#### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
```python
@router.message(SupportDialog.waiting_message)
async def handle_support_message(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."""
    user_id = message.from_user.id
    username = message.from_user.username or "Unknown"
    support_text = message.text
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
    support_result = await send_to_support(
        user_id=user_id,
        username=username,
        message=support_text
    )
    
    if support_result["success"]:
        await message.answer(
            "‚úÖ –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É. "
            "–ú—ã –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
        )
        await state.set_state(MainMenu.main)
        await show_main_menu(message)
    else:
        await message.answer(
            "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )
```

## –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

#### 1. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
```python
def create_main_menu_keyboard() -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é."""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üõí –ö—É–ø–∏—Ç—å –∫–ª—é—á", callback_data="buy_key"),
            InlineKeyboardButton(text="üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data="profile")
        ],
        [
            InlineKeyboardButton(text="üîë –ú–æ–∏ –∫–ª—é—á–∏", callback_data="my_keys"),
            InlineKeyboardButton(text="üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="balance")
        ],
        [
            InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats"),
            InlineKeyboardButton(text="‚ùì –ü–æ–¥–¥–µ—Ä–∂–∫–∞", callback_data="support")
        ],
        [
            InlineKeyboardButton(text="‚ÑπÔ∏è –û –±–æ—Ç–µ", callback_data="about")
        ]
    ])
    return keyboard
```

#### 2. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ç–∞—Ä–∏—Ñ–æ–≤
```python
def create_plans_keyboard(plans: List[Dict]) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏."""
    keyboard_buttons = []
    
    for plan in plans:
        button_text = f"{plan['plan_name']} - {plan['price']} RUB"
        callback_data = f"plan_{plan['plan_id']}"
        keyboard_buttons.append([
            InlineKeyboardButton(text=button_text, callback_data=callback_data)
        ])
    
    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    keyboard_buttons.append([
        InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")
    ])
    
    return InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
```

#### 3. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã
```python
def create_payment_methods_keyboard(plan_data: Dict) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã."""
    keyboard_buttons = []
    
    # YooKassa (–∫–∞—Ä—Ç—ã –∏ –°–ë–ü)
    keyboard_buttons.append([
        InlineKeyboardButton(
            text="üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ / –°–ë–ü", 
            callback_data="payment_yookassa"
        )
    ])
    
    # CryptoBot
    keyboard_buttons.append([
        InlineKeyboardButton(
            text="‚Çø CryptoBot", 
            callback_data="payment_cryptobot"
        )
    ])
    
    # TON Connect
    keyboard_buttons.append([
        InlineKeyboardButton(
            text="üíé TON Connect", 
            callback_data="payment_ton"
        )
    ])
    
    # Telegram Stars
    keyboard_buttons.append([
        InlineKeyboardButton(
            text="‚≠ê Telegram Stars", 
            callback_data="payment_stars"
        )
    ])
    
    # –ë–∞–ª–∞–Ω—Å (–µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤)
    if plan_data["price"] <= user_balance:
        keyboard_buttons.append([
            InlineKeyboardButton(
                text=f"üí∞ –° –±–∞–ª–∞–Ω—Å–∞ ({user_balance} RUB)", 
                callback_data="payment_balance"
            )
        ])
    
    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    keyboard_buttons.append([
        InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_plans")
    ])
    
    return InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
```

### Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

#### 1. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (Reply)
```python
def create_reply_keyboard() -> ReplyKeyboardMarkup:
    """–°–æ–∑–¥–∞–Ω–∏–µ Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã."""
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            ["üõí –ö—É–ø–∏—Ç—å –∫–ª—é—á", "üë§ –ü—Ä–æ—Ñ–∏–ª—å"],
            ["üîë –ú–æ–∏ –∫–ª—é—á–∏", "üí∞ –ë–∞–ª–∞–Ω—Å"],
            ["‚ùì –ü–æ–¥–¥–µ—Ä–∂–∫–∞", "‚ÑπÔ∏è –°–ø—Ä–∞–≤–∫–∞"]
        ],
        resize_keyboard=True,
        one_time_keyboard=False
    )
    return keyboard
```

## –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û

### 1. Middleware –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
```python
class AuthMiddleware(BaseMiddleware):
    """Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
    
    async def __call__(self, handler, event, data):
        user = event.from_user
        
        if not user:
            return await handler(event, data)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if await is_user_banned(user.id):
            await event.answer("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ")
            return
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
        await register_user_if_not_exists(user.id, user.username)
        
        return await handler(event, data)
```

### 2. Middleware –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```python
class LoggingMiddleware(BaseMiddleware):
    """Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
    
    async def __call__(self, handler, event, data):
        user = event.from_user
        action = "unknown"
        
        if isinstance(event, Message):
            action = f"message: {event.text[:50]}"
        elif isinstance(event, CallbackQuery):
            action = f"callback: {event.data}"
        
        logger.info(f"User {user.id} ({user.username}): {action}")
        
        return await handler(event, data)
```

### 3. Middleware rate limiting
```python
class RateLimitMiddleware(BaseMiddleware):
    """Middleware –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤."""
    
    def __init__(self):
        self.user_requests = {}
        self.max_requests = 10  # –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤
        self.time_window = 60   # –ó–∞ 60 —Å–µ–∫—É–Ω–¥
    
    async def __call__(self, handler, event, data):
        user_id = event.from_user.id
        current_time = time.time()
        
        # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
        if user_id in self.user_requests:
            self.user_requests[user_id] = [
                req_time for req_time in self.user_requests[user_id]
                if current_time - req_time < self.time_window
            ]
        else:
            self.user_requests[user_id] = []
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
        if len(self.user_requests[user_id]) >= self.max_requests:
            await event.answer("‚è∞ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            return
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        self.user_requests[user_id].append(current_time)
        
        return await handler(event, data)
```

## –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 1. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```python
async def send_notification_to_user(
    user_id: int, 
    notification_type: str, 
    title: str, 
    message: str,
    **kwargs
) -> bool:
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."""
    try:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ë–î
        notification_id = await log_notification(
            user_id=user_id,
            notification_type=notification_type,
            title=title,
            message=message,
            **kwargs
        )
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        await bot.send_message(
            chat_id=user_id,
            text=f"üîî <b>{title}</b>\n\n{message}",
            parse_mode="HTML"
        )
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        await update_notification_status(notification_id, "sent")
        return True
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
        await update_notification_status(notification_id, "failed")
        return False
```

### 2. –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```python
class NotificationTypes:
    """–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π."""
    
    # –ü–ª–∞—Ç–µ–∂–∏
    PAYMENT_SUCCESS = "payment_success"
    PAYMENT_FAILED = "payment_failed"
    PAYMENT_PENDING = "payment_pending"
    
    # –ö–ª—é—á–∏
    KEY_CREATED = "key_created"
    KEY_EXPIRING = "key_expiring"
    KEY_EXPIRED = "key_expired"
    
    # –†–µ—Ñ–µ—Ä–∞–ª—ã
    REFERRAL_BONUS = "referral_bonus"
    REFERRAL_SIGNUP = "referral_signup"
    
    # –°–∏—Å—Ç–µ–º–Ω—ã–µ
    SYSTEM_MAINTENANCE = "system_maintenance"
    SYSTEM_UPDATE = "system_update"
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```python
async def check_expiring_keys():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –∫–ª—é—á–µ–π."""
    expiring_keys = await get_expiring_keys(hours=24)  # –ó–∞ 24 —á–∞—Å–∞
    
    for key in expiring_keys:
        await send_notification_to_user(
            user_id=key["user_id"],
            notification_type=NotificationTypes.KEY_EXPIRING,
            title="‚è∞ –ö–ª—é—á —Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç",
            message=f"–í–∞—à –∫–ª—é—á #{key['key_id']} –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ {key['hours_left']} —á–∞—Å–æ–≤",
            key_id=key["key_id"]
        )
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤
```python
@router.message(F.text.startswith("payment_"))
async def handle_payment_webhook(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤ –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º."""
    payment_data = json.loads(message.text)
    
    if payment_data["system"] == "yookassa":
        await handle_yookassa_webhook(payment_data)
    elif payment_data["system"] == "cryptobot":
        await handle_cryptobot_webhook(payment_data)
    elif payment_data["system"] == "ton":
        await handle_ton_webhook(payment_data)
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
```python
async def handle_successful_payment(payment_data: Dict):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞."""
    user_id = payment_data["user_id"]
    plan_data = payment_data["plan_data"]
    
    # –°–æ–∑–¥–∞–Ω–∏–µ VPN –∫–ª—é—á–∞
    key_result = await create_vpn_key(user_id, plan_data)
    
    if key_result["success"]:
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await send_notification_to_user(
            user_id=user_id,
            notification_type=NotificationTypes.PAYMENT_SUCCESS,
            title="‚úÖ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω",
            message=f"–í–∞—à –∫–ª—é—á #{key_result['key_id']} –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!",
            key_id=key_result["key_id"]
        )
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª—é—á–∞
        await send_vpn_key_to_user(user_id, key_result["key_data"])
    else:
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        await send_notification_to_user(
            user_id=user_id,
            notification_type=NotificationTypes.PAYMENT_FAILED,
            title="‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞",
            message="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—é—á–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
        )
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 1. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
```python
@router.error()
async def error_handler(event, exception):
    """–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫."""
    logger.error(f"–û—à–∏–±–∫–∞ –≤ –¥–∏–∞–ª–æ–≥–µ: {exception}", exc_info=True)
    
    if isinstance(event, Message):
        await event.answer(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
        )
    elif isinstance(event, CallbackQuery):
        await event.answer(
            "‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞", 
            show_alert=True
        )

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
dp.error.register(error_handler)
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
```python
@router.callback_query(F.data.startswith("plan_"))
async def handle_plan_selection(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫."""
    try:
        plan_id = int(callback.data.split("_")[1])
        plan_data = await get_plan_by_id(plan_id)
        
        if not plan_data:
            raise ValueError("–¢–∞—Ä–∏—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞...
        
    except ValueError as e:
        await callback.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}", show_alert=True)
    except DatabaseError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∞—Ä–∏—Ñ–∞: {e}")
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö", show_alert=True)
    except Exception as e:
        logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∞—Ä–∏—Ñ–∞: {e}")
        await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞", show_alert=True)
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤

### 1. Unit —Ç–µ—Å—Ç—ã –¥–ª—è handlers
```python
import pytest
from unittest.mock import AsyncMock, MagicMock
from aiogram.types import Message, CallbackQuery, User

@pytest.mark.asyncio
async def test_start_command():
    """–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥—ã /start."""
    # –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–∫-–æ–±—ä–µ–∫—Ç–æ–≤
    message = MagicMock(spec=Message)
    message.from_user.id = 12345
    message.from_user.username = "testuser"
    message.answer = AsyncMock()
    
    state = MagicMock()
    state.set_state = AsyncMock()
    
    # –í—ã–∑–æ–≤ handler'–∞
    await cmd_start(message, state)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∏
    message.answer.assert_called_once()
    state.set_state.assert_called_once_with(MainMenu.main)
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
```python
@pytest.mark.asyncio
async def test_purchase_flow():
    """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–∫—É–ø–∫–∏."""
    # –ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
    message = create_test_message("/start")
    await cmd_start(message, state)
    
    # –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞
    callback = create_test_callback("plan_1")
    await handle_plan_selection(callback, state)
    
    # –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
    callback = create_test_callback("payment_yookassa")
    await handle_payment_selection(callback, state)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    current_state = await state.get_state()
    assert current_state == KeyPurchase.processing_payment
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä
```python
def test_main_menu_keyboard():
    """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é."""
    keyboard = create_main_menu_keyboard()
    
    assert len(keyboard.inline_keyboard) == 4  # 4 —Ä—è–¥–∞ –∫–Ω–æ–ø–æ–∫
    assert len(keyboard.inline_keyboard[0]) == 2  # –ü–µ—Ä–≤—ã–π —Ä—è–¥ - 2 –∫–Ω–æ–ø–∫–∏
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–æ–∫
    first_row = keyboard.inline_keyboard[0]
    assert first_row[0].text == "üõí –ö—É–ø–∏—Ç—å –∫–ª—é—á"
    assert first_row[1].text == "üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"
```

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ {{DATE}}*
*–í–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ–µ–∫—Ç–∞: {{OWNER}}*
