# –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –ª–æ–≥–∞—É—Ç–æ–º

> –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 19.11.2025

## üîç –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ö–∞–±–∏–Ω–µ—Ç" (–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `localhost:50003`) –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (`localhost:50000`) —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–æ–≥–∞—É—Ç.

## ‚úÖ –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ (100% –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –ª–æ–≥–∞–º–∏)

**–ü—Ä–æ–±–ª–µ–º–∞:** `regenerate()` –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç race condition —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π.

### –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ü—Ä–∏ –ª–æ–≥–∏–Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `regenerate()`:**
   ```python
   current_app.session_interface.regenerate(session)
   ```

2. **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
   - `regenerate()` —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π session ID
   - Flask-Session –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –≤ —Ñ–∞–π–ª
   - –ù–æ —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ –∫–æ–Ω—Ü–µ –∑–∞–ø—Ä–æ—Å–∞
   - –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí `FileNotFoundError`

3. **–õ–æ–≥–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç:**
   ```
   17:34:38 - [LOGIN] –°–µ—Å—Å–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: logged_in=True
   17:34:38.804 - [WARNING] Exception raised while handling cache file '/app/sessions/7e19f40b695bfb59ff7b48412be4f2d7'
   FileNotFoundError: [Errno 2] No such file or directory
   17:34:43 - [AUTH] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: logged_in=False, cookie_in_request=present
   ```

4. **–ü–æ—á–µ–º—É cookie –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–æ —Å–µ—Å—Å–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è:**
   - Cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è (`cookie_in_request=present`)
   - –ù–æ —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (`FileNotFoundError`)
   - Flask-Session –Ω–µ –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
   - `logged_in=False` ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω

## üîß –†–µ—à–µ–Ω–∏–µ

**–£–±—Ä–∞—Ç—å `regenerate()` –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ.**

### –ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ:

1. **–†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è session ID –≤–∞–∂–Ω–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞**, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
2. **–ü—Ä–∏ –ª–æ–≥–∏–Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è** - —Å—Ç–∞—Ä—ã–π session ID –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
3. **Race condition —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π** –≤—ã–∑—ã–≤–∞–µ—Ç –ø–æ—Ç–µ—Ä—é —Å–µ—Å—Å–∏–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è:

```python
# –ë–´–õ–û:
current_app.session_interface.regenerate(session)
session['logged_in'] = True
session.permanent = True
session.modified = True

# –°–¢–ê–õ–û:
session['logged_in'] = True
session.permanent = True
session.modified = True
# regenerate() —É–±—Ä–∞–Ω - —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ Flask-Session
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –§–∞–π–ª —Å–µ—Å—Å–∏–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ race condition
- ‚úÖ –°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ
- ‚úÖ Cookie —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ù–µ—Ç `FileNotFoundError` –≤ –ª–æ–≥–∞—Ö

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `src/shop_bot/webhook_server/app.py` - –ª–æ–≥–∏–Ω –±–µ–∑ regenerate()
- `src/shop_bot/webhook_server/auth_utils.py` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Å—Å–∏–π

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- `SESSION_REFRESH_EACH_REQUEST = True` –æ—Å—Ç–∞–µ—Ç—Å—è - —ç—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç cookie –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- `session.modified = True` –æ—Å—Ç–∞–µ—Ç—Å—è - —ç—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- `regenerate()` –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞), –Ω–æ –Ω–µ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

