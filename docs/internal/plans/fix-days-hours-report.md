# –û—Ç—á–µ—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–Ω–µ–π –∏ —á–∞—Å–æ–≤ –≤ –ø–ª–∞—Ç–µ–∂–∞—Ö

**–î–∞—Ç–∞:** 09.11.2025 15:54  
**–í–µ—Ä—Å–∏—è:** 3.23.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –ø–ª–∞–Ω–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö —Ç–æ–ª—å–∫–æ –¥–Ω–∏/—á–∞—Å—ã (–±–µ–∑ –º–µ—Å—è—Ü–µ–≤), –≤ metadata –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä `months=0`, –Ω–æ –Ω–µ `days` –∏ `hours`. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –∫–ª—é—á–µ–π —Å –Ω–µ–≤–µ—Ä–Ω—ã–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è.

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–ª–∞–Ω—ã

| Plan ID | –ù–∞–∑–≤–∞–Ω–∏–µ | Months | Days | Hours | –ò—Ç–æ–≥–æ –¥–Ω–µ–π | –ü—Ä–æ–±–ª–µ–º–∞ |
|---------|----------|--------|------|-------|------------|----------|
| 56 | –ü1 | 1 | 1 | 1 | 31.04 | ‚ö†Ô∏è –î–Ω–∏/—á–∞—Å—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å |
| 58 | –ü3 | 0 | 1 | 0 | 1.00 | ‚ùå –°–æ–∑–¥–∞–≤–∞–ª—Å—è –Ω–∞ 0 –¥–Ω–µ–π |
| 59 | #1 | 1 | 1 | 1 | 31.04 | ‚ö†Ô∏è –î–Ω–∏/—á–∞—Å—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å |
| 60 | –ü2 | 0 | 3 | 1 | 3.04 | ‚ùå –°–æ–∑–¥–∞–≤–∞–ª—Å—è –Ω–∞ 0 –¥–Ω–µ–π |
| 61 | –ü3 | 0 | 2 | 1 | 2.04 | ‚ùå –°–æ–∑–¥–∞–≤–∞–ª—Å—è –Ω–∞ 0 –¥–Ω–µ–π |
| 62 | –ß–∞—Å | 0 | 0 | 1 | 0.04 | ‚ùå –°–æ–∑–¥–∞–≤–∞–ª—Å—è –Ω–∞ 0 –¥–Ω–µ–π |

## –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

#### 1. YooKassa (`handlers.py:4529-4764`)

**–î–æ:**
```python
months = plan['months']
# days –∏ hours –ù–ï –∏–∑–≤–ª–µ–∫–∞–ª–∏—Å—å –∏–∑ –ø–ª–∞–Ω–∞

metadata = {
    "months": months,
    # "days": –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    # "hours": –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    ...
}
```

**–ü–æ—Å–ª–µ:**
```python
months = plan['months']
days = int(plan.get('days') or 0)
hours = int(plan.get('hours') or 0)

metadata = {
    "months": months,
    "days": days,      # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
    "hours": hours,    # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
    ...
}
```

#### 2. Stars (`handlers.py:5209-5268`)

**–î–æ:**
```python
months = int(data.get('months') or 0) or int((plan or {}).get('months') or 0)

stars_metadata = {
    "months": months,
    # "days": –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    # "hours": –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
}
```

**–ü–æ—Å–ª–µ:**
```python
months = int(data.get('months') or 0) or int((plan or {}).get('months') or 0)
days = int(plan.get('days') or 0)
hours = int(plan.get('hours') or 0)

stars_metadata = {
    "months": months,
    "days": days,      # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
    "hours": hours,    # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
}
```

#### 3. TON Connect (`handlers.py:5120`)

**–î–æ:**
```python
metadata = {
    "months": plan['months'],
    # "days": –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    # "hours": –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    ...
}
```

**–ü–æ—Å–ª–µ:**
```python
metadata = {
    "months": plan['months'],
    "days": int(plan.get('days') or 0),      # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
    "hours": int(plan.get('hours') or 0),    # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
    ...
}
```

#### 4. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (`handlers.py:6305-6307, 6378-6394`)

**–ü–∞—Ä—Å–∏–Ω–≥ metadata:**
```python
months = _to_int(metadata.get('months'))
days = _to_int(metadata.get('days', 0))      # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
hours = _to_int(metadata.get('hours', 0))    # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
```

**–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–æ–∫–∞:**
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º days/hours –∏–∑ metadata (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ –∏–∑ –ø–ª–∞–Ω–∞ (fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
extra_days = days if days > 0 else (int(plan.get('days') or 0) if plan else 0)
extra_hours = hours if hours > 0 else (int(plan.get('hours') or 0) if plan else 0)

days_to_add = months * 30 + extra_days + (extra_hours / 24)

logger.info(
    f"[PAYMENT_PROCESSING] Calculating days_to_add: months={months}, days={extra_days}, "
    f"hours={extra_hours}, total_days={days_to_add:.2f}"
)
```

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- ‚úÖ `src/shop_bot/bot/handlers.py` (4 –º–µ—Å—Ç–∞)
- ‚úÖ `docs/troubleshooting/yookassa-stuck-payments.md` (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
- ‚úÖ `CHANGELOG.md` (–∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- ‚úÖ `pyproject.toml` (–≤–µ—Ä—Å–∏—è: 3.22.6 ‚Üí 3.23.0)

### –§–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã

- üóëÔ∏è `tests/test_check_plan_55.py`
- üóëÔ∏è `tests/test_check_all_plans.py`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–Ω–æ–≤

```bash
python tests/test_check_all_plans.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–ù–∞–π–¥–µ–Ω–æ –ø–ª–∞–Ω–æ–≤: 7

Plan ID  56: –ü1  | M: 1 D: 1 H: 1 = 31.04 days | 1.00 RUB <- –ï—Å—Ç—å –¥–Ω–∏/—á–∞—Å—ã!
Plan ID  57: –ü2  | M: 1 D: 0 H: 0 = 30.00 days | 1.00 RUB
Plan ID  58: –ü3  | M: 0 D: 1 H: 0 =  1.00 days | 1.00 RUB <- –ï—Å—Ç—å –¥–Ω–∏/—á–∞—Å—ã!
Plan ID  59: #1  | M: 1 D: 1 H: 1 = 31.04 days | 10.00 RUB <- –ï—Å—Ç—å –¥–Ω–∏/—á–∞—Å—ã!
Plan ID  60: –ü2  | M: 0 D: 3 H: 1 =  3.04 days | 5.00 RUB <- –ï—Å—Ç—å –¥–Ω–∏/—á–∞—Å—ã!
Plan ID  61: –ü3  | M: 0 D: 2 H: 1 =  2.04 days | 5.00 RUB <- –ï—Å—Ç—å –¥–Ω–∏/—á–∞—Å—ã!
Plan ID  62: –ß–∞—Å | M: 0 D: 0 H: 1 =  0.04 days | 1.00 RUB <- –ï—Å—Ç—å –¥–Ω–∏/—á–∞—Å—ã!
```

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)**
```python
# –ü–ª–∞–Ω 60: M:0 D:3 H:1
metadata = {"months": 0, "days": 3, "hours": 1}

# –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ:
extra_days = 3  # –∏–∑ metadata
extra_hours = 1  # –∏–∑ metadata
days_to_add = 0 * 30 + 3 + (1 / 24) = 3.04 –¥–Ω—è  ‚úÖ
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –°—Ç–∞—Ä—ã–π –ø–ª–∞—Ç–µ–∂ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, fallback)**
```python
# metadata –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç days/hours
metadata = {"months": 0}

# –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ:
extra_days = 0  # –∏–∑ metadata (–Ω–µ—Ç), fallback –Ω–∞ –ø–ª–∞–Ω: 3
extra_hours = 0  # –∏–∑ metadata (–Ω–µ—Ç), fallback –Ω–∞ –ø–ª–∞–Ω: 1
days_to_add = 0 * 30 + 3 + (1 / 24) = 3.04 –¥–Ω—è  ‚úÖ
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. **YooKassa**: –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ—Ç `days` –∏ `hours` –≤ metadata
2. **Stars**: –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ—Ç `days` –∏ `hours` –≤ metadata
3. **TON Connect**: –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ—Ç `days` –∏ `hours` –≤ metadata
4. **CryptoBot**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å fallback
5. **Balance**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å fallback

### ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –±—É–¥—É—â–∏—Ö –ø—Ä–æ–±–ª–µ–º

- Fallback –º–µ—Ö–∞–Ω–∏–∑–º: –µ—Å–ª–∏ metadata –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç days/hours, –±–µ—Ä—É—Ç—Å—è –∏–∑ –ø–ª–∞–Ω–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: —Ç–µ–ø–µ—Ä—å –≤—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ª–æ–≥
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –ø—Ä–æ–±–ª–µ–º–µ

### ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- –°—Ç–∞—Ä—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–±–µ–∑ days/hours –≤ metadata) –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —á–µ—Ä–µ–∑ fallback
- –ù–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –±—É–¥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π —Å days/hours
3. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–ª—é—á–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å—Ä–æ–∫–æ–º

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π](../../.cursor/plans/fix-y-4189d2-dc908c8c.plan.md)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ YooKassa](../troubleshooting/yookassa-stuck-payments.md)
- [CHANGELOG](../../CHANGELOG.md)

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 09.11.2025 15:54  
**–í–µ—Ä—Å–∏—è:** 1.0

