# Настройка YooKassa

*Последнее обновление: 31.01.2025*

## Обзор
YooKassa — это платежная система для приема платежей банковскими картами и через СБП (Система быстрых платежей) в России.

## Структура настроек

Интерфейс настроек YooKassa разделен на три логических блока:

### 🔧 Общие настройки
- **Включить оплату через СБП** - активация Системы быстрых платежей
- **Режим работы YooKassa** - переключатель между боевым и тестовым режимом
  - 🧪 **Тестовый** (OFF) - используются тестовые ключи и данные
  - 🔴 **Боевой** (ON) - используются реальные ключи для продакшена
- **Почта для чеков** - email для отправки чеков

### 🔴 Боевые настройки
- **API URL** - базовый URL API YooKassa (по умолчанию: https://api.yookassa.ru/v3)
- **Проверять SSL сертификаты** - проверка SSL для безопасности
- **Shop ID** - идентификатор магазина в YooKassa
- **Secret Key** - секретный ключ для API

### 🧪 Тестовые настройки
- **API URL (тест)** - URL тестового API (по умолчанию: https://api.test.yookassa.ru/v3)
- **Проверять SSL сертификаты (тест)** - проверка SSL для тестового режима
- **Shop ID (тест)** - идентификатор тестового магазина
- **Test Secret Key (тест)** - секретный ключ для тестового API

## Переключатель режима работы

В интерфейсе настроек YooKassa добавлен удобный переключатель режима работы:

### 🎛️ Как работает переключатель
- **Красный (OFF)** = 🧪 Тестовый режим
- **Зеленый (ON)** = 🔴 Боевой режим

### 🔄 Переключение режимов
1. **Для тестирования**: Переключатель в положении OFF (красный)
   - Используются тестовые ключи из раздела "Тестовые настройки"
   - Создаются тестовые платежи с флагом `test: true`
   - Безопасно для экспериментов

2. **Для продакшена**: Переключатель в положении ON (зеленый)
   - Используются боевые ключи из раздела "Боевые настройки"
   - Создаются реальные платежи
   - Только для реальных транзакций

### 💡 Динамическое описание
При переключении режима автоматически обновляется описание:
- "Тестовый режим: используются тестовые ключи и данные"
- "Боевой режим: используются реальные ключи для продакшена"

### 📝 Описание платежа
Все платежи YooKassa создаются с единым описанием: **"Подписка на сервис"**
Это упрощает идентификацию платежей в личном кабинете YooKassa и улучшает пользовательский опыт.

## Получение ключей

### 1. Регистрация в YooKassa
1. Перейдите на https://yookassa.ru/
2. Зарегистрируйтесь или войдите в личный кабинет
3. Пройдите верификацию (потребуются документы)

### 2. Получение Shop ID (Account ID)
1. В личном кабинете перейдите в раздел **Интеграция → Ключи API**
2. Найдите ваш **Shop ID** (например: `1174374` для боевого, `1176024` для тестового)
3. Скопируйте этот номер

### 3. Получение Secret Key
1. В том же разделе **Интеграция → Ключи API**
2. В блоке "Секретный ключ" нажмите **Выпустить ключ**
3. Подтвердите выпуск SMS-кодом
4. **ВАЖНО**: Ключ показывается только один раз! Скопируйте его сразу
5. Ключ выглядит как: `test_*gmysOmvdVtnlrvcBXhcflxMURT7tBTnHfRBRqzMHdGFY`

## Настройка в боте

### 1. Через веб-интерфейс
1. Откройте веб-панель бота
2. Перейдите в **Настройки → Платежные системы**
3. Выберите режим работы:
   - **🧪 Тестовый режим YooKassa** - для тестирования (по умолчанию)
   - **Боевой режим** - для реальных платежей

#### Тестовый режим (рекомендуется для начала)
**ВАЖНО**: Для тестового режима нужен **тестовый шлюз** с отдельными ключами!

1. **Создайте тестовый шлюз** в личном кабинете YooKassa:
   - Зайдите в https://yookassa.ru/my/gate/integration/api-keys
   - Нажмите "Добавить тестовый шлюз"
   - Выберите "Новый API"
   - Заполните данные и создайте шлюз

2. **Получите тестовые ключи** из созданного тестового шлюза:
   - **YooKassa Test Shop ID**: ID тестового шлюза (например, `1176024`)
   - **YooKassa Test Secret Key**: Секретный ключ тестового шлюза (начинается с `test_`)

**Примечание**: Тестовые ключи работают с API YooKassa только для тестового шлюза!

#### Боевой режим (для продакшена)
- **YooKassa Shop ID (Боевой)**: `1174374` (ваш реальный Shop ID)
- **YooKassa Secret Key (Боевой)**: `live_yJ7KJRpRavcZWeR5XrzUJYZ1YHmyOz8yyT9jCWTb38s` (ваш реальный Secret Key)

4. Вкладка также содержит расширенные параметры API:
   - **YooKassa API URL (Боевой/Тестовый)** — базовый адрес REST API. По умолчанию используется https://api.yookassa.ru/v3. Для тестового шлюза можно указать https://api.test.yookassa.ru/v3 или другой предоставленный YooKassa endpoint.
   - **Проверять SSL сертификаты** — оставьте включенной для боевого режима. Отключайте только если тестовое окружение использует нестандартный сертификат.
5. Нажмите **Сохранить**

### 2. Через базу данных (альтернативный способ)

#### Тестовый режим
```sql
UPDATE bot_settings SET value = 'true' WHERE key = 'yookassa_test_mode';
UPDATE bot_settings SET value = '1176024' WHERE key = 'yookassa_test_shop_id';
UPDATE bot_settings SET value = 'test_5eset-lka5BIe5ZLqOgC7vma2fGXhPbPLjXkQv-0BJw' WHERE key = 'yookassa_test_secret_key';
UPDATE bot_settings SET value = 'true' WHERE key = 'sbp_enabled';
```

#### Боевой режим
```sql
UPDATE bot_settings SET value = 'false' WHERE key = 'yookassa_test_mode';
UPDATE bot_settings SET value = '1174374' WHERE key = 'yookassa_shop_id';
UPDATE bot_settings SET value = 'live_yJ7KJRpRavcZWeR5XrzUJYZ1YHmyOz8yyT9jCWTb38s' WHERE key = 'yookassa_secret_key';
UPDATE bot_settings SET value = 'true' WHERE key = 'sbp_enabled';
```

## Разница между режимами

### 🧪 Тестовый режим
- **Ключи**: Используются реальные ключи из личного кабинета YooKassa
- **Платежи**: Создаются реальные платежи, но с тестовыми данными
- **Безопасность**: Безопасно для тестирования, так как используются тестовые суммы
- **Логирование**: В логах помечается как "тестовый режим"

### 🔴 Боевой режим
- **Ключи**: Используются реальные ключи из личного кабинета YooKassa
- **Платежи**: Создаются реальные платежи для продакшена
- **Безопасность**: Только для реальных платежей
- **Логирование**: В логах помечается как "боевой режим"

## Переключение режимов

### Тестовый режим → Боевой режим
1. В веб-панели отключите **🧪 Тестовый режим YooKassa**
2. Убедитесь, что заполнены поля **Боевого режима**:
   - Shop ID и Secret Key из реального магазина
3. Сохраните настройки
4. Перезапустите бота: `docker compose restart bot`

### Боевой режим → Тестовый режим
1. В веб-панели включите **🧪 Тестовый режим YooKassa**
2. Убедитесь, что заполнены поля **Тестового режима**:
   - Test Shop ID и Test Secret Key (те же, что и в боевом режиме)
3. Сохраните настройки
4. Перезапустите бота: `docker compose restart bot`

## Тестирование

### Автоматическое тестирование
Для проверки работы ЮKassa используйте готовые тестовые скрипты:

#### Тест тестового режима
```bash
python test_yookassa_api.py
```

#### Тест боевого режима (только подключение)
```bash
python test_yookassa_live.py
```

### Тестовые карты
Для тестирования используйте:
- **Успешный платеж**: `5555 5555 5555 4444`
- **Недостаточно средств**: `5555 5555 5555 4445`
- **Отклоненный банком**: `5555 5555 5555 4446`

### Проверка работы
1. Создайте тестовый заказ в боте
2. Выберите "🏦 СБП / Банковская карта"
3. Используйте тестовую карту
4. Проверьте, что платеж проходит

### Результаты тестирования (30.01.2025)
✅ **Тестовый режим**: Работает корректно
- Shop ID: `1176024`
- API: `https://api.test.yookassa.ru/v3`
- Создание платежей: Успешно
- SSL: Отключен для тестового режима

✅ **Боевой режим**: Работает корректно
- Shop ID: `1174374`
- API: `https://api.yookassa.ru/v3`
- Подключение: Успешно
- SSL: Включен для безопасности

## Webhook настройка

### 1. URL webhook
```
https://ваш-домен.com/yookassa-webhook
```

### 2. Настройка в YooKassa
1. В личном кабинете перейдите в **Настройки → HTTP-уведомления**
2. Добавьте URL webhook
3. Выберите события: `payment.succeeded`
4. Сохраните настройки

### 3. Обрабатываемые данные
При успешном платеже система автоматически извлекает и сохраняет следующие данные:

- **ID платежа YooKassa** - уникальный идентификатор платежа (например: `306e38e2-000f-5000-b000-1e7b12763cf4`)
- **RRN** - номер операции для банка получателя (например: `187843990849311`)
- **Код авторизации** - код авторизации транзакции (например: `803881`)
- **Способ оплаты** - тип платежного метода (`bank_card`, `sbp`, `apple_pay`, `google_pay` и др.)

Все данные сохраняются в таблице `transactions` для удобного поиска и анализа платежей.

## Возможные проблемы

### "Не удалось создать ссылку на оплату"
**Причины:**
- Неверный Shop ID
- Неверный Secret Key
- Неправильная настройка Configuration

**Решение:**
1. Проверьте правильность ключей в настройках
2. Убедитесь, что ключи скопированы полностью
3. Перезапустите бота после изменения настроек

### "Invalid credentials"
**Причины:**
- Неверный Secret Key
- Ключ истек или был перевыпущен

**Решение:**
1. Перевыпустите Secret Key в личном кабинете
2. Обновите ключ в настройках бота
3. Перезапустите бота

### "gate_id" ошибка
**Причины:**
- Используется устаревший параметр `gate_id` вместо `account_id`

**Решение:**
- Обновите код до последней версии (уже исправлено)

## Безопасность

### Рекомендации
1. **Никогда не публикуйте Secret Key** в открытом доступе
2. Используйте переменные окружения для продакшена
3. Регулярно перевыпускайте ключи
4. Мониторьте логи на предмет подозрительной активности

### Переменные окружения
```bash
YOOKASSA_SHOP_ID=1174374
YOOKASSA_SECRET_KEY=live_yJ7KJRpRavcZWeR5XrzUJYZ1YHmyOz8yyT9jCWTb38s
```

## Поддерживаемые платежи

### Способы оплаты
- ✅ Банковские карты (Visa, MasterCard, МИР)
- ✅ СБП (Система быстрых платежей)
- ✅ Apple Pay
- ✅ Google Pay
- ✅ Samsung Pay

### Валюты
- ✅ RUB (российский рубль)

## Лимиты

### Тестовый режим
- Минимальная сумма: 1 рубль
- Максимальная сумма: 100 000 рублей

### Продакшн
- Минимальная сумма: 1 рубль
- Максимальная сумма: 1 000 000 рублей
- Лимиты зависят от верификации аккаунта

---

*Последнее обновление: 29.01.2025*

