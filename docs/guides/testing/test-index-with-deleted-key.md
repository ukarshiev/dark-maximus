# –ê–Ω–∞–ª–∏–∑ —Ç–µ—Å—Ç–∞ `test_index_with_deleted_key`

> **–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–¥–∞–∫—Ü–∏–∏:** 27.01.2025

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-01-27  
**–¢–µ—Å—Ç:** `TestUserCabinet#test_index_with_deleted_key`  
**–§–∞–π–ª:** `tests/unit/test_user_cabinet/test_cabinet.py:265-282`

---

## üìã –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞

### –¶–µ–ª—å —Ç–µ—Å—Ç–∞
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ (`/`) –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ—Å—Ç—É–ø–∞ —Å —Ç–æ–∫–µ–Ω–æ–º, —Å–≤—è–∑–∞–Ω–Ω—ã–º —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º –∫–ª—é—á–æ–º.

### –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω** —á–µ—Ä–µ–∑ —Ñ–∏–∫—Å—Ç—É—Ä—É `test_user`:
   - `user_id`: 123456789
   - `key_id`: —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `create_key_with_stats_atomic()`
   - `key_email`: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `test_{uuid}@example.com`
   - `token`: —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `get_or_create_permanent_token(user_id, key_id)`

2. **–í—Ä–µ–º–µ–Ω–Ω–∞—è –ë–î** (`temp_db`) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ç–µ—Å—Ç–∞

3. **Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ —á–µ—Ä–µ–∑ —Ñ–∏–∫—Å—Ç—É—Ä—É `flask_app`

### –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞

1. **–ü–∞—Ç—á–∏–Ω–≥ DB_FILE**
   ```python
   original_db_file = database.DB_FILE
   database.DB_FILE = temp_db
   ```
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –ë–î
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—É—Ç—å –∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ë–î –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

2. **–£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞**
   ```python
   delete_key_by_email(test_user['key_email'])
   ```
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è `delete_key_by_email()` —Å email —É–¥–∞–ª—è–µ–º–æ–≥–æ –∫–ª—é—á–∞
   - **–ö–†–ò–¢–ò–ß–ù–û:** –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–∞–∫–∂–µ —É–¥–∞–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `user_tokens` (—Å—Ç—Ä–æ–∫–∞ 6579 –≤ `database.py`)

3. **–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ**
   ```python
   response = flask_app.get(f'/?token={test_user["token"]}')
   ```
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è GET-–∑–∞–ø—Ä–æ—Å –∫ `/` —Å —Ç–æ–∫–µ–Ω–æ–º –≤ query-–ø–∞—Ä–∞–º–µ—Ç—Ä–µ
   - –¢–æ–∫–µ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω –¥–æ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–≤–µ—Ç–∞**
   ```python
   assert response.status_code == 404
   ```
   - –û–∂–∏–¥–∞–µ—Ç—Å—è HTTP —Å—Ç–∞—Ç—É—Å 404 (Not Found)

5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ**
   ```python
   assert '–ö–ª—é—á —É–¥–∞–ª–µ–Ω'.encode('utf-8') in response.data
   ```
   - –û–∂–∏–¥–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö–ª—é—á —É–¥–∞–ª–µ–Ω" –≤ —Ç–µ–ª–µ –æ—Ç–≤–µ—Ç–∞

### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- HTTP —Å—Ç–∞—Ç—É—Å: **404**
- –°–æ–æ–±—â–µ–Ω–∏–µ: **"–ö–ª—é—á —É–¥–∞–ª–µ–Ω"**
- –û–ø–∏—Å–∞–Ω–∏–µ: "–°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞, –Ω–æ –∫–ª—é—á –±—ã–ª —É–¥–∞–ª–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á."

---

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `delete_key_by_email`

**–§–∞–π–ª:** `src/shop_bot/data_manager/database.py:6564-6594`

```python
def delete_key_by_email(email: str):
    # ...
    # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º key_id –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
    cursor.execute("SELECT key_id FROM vpn_keys WHERE key_email = ? LIMIT 1", (email,))
    row = cursor.fetchone()
    
    if row:
        key_id = row[0]
        # –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∫–ª—é—á–∞
        cursor.execute("DELETE FROM user_tokens WHERE key_id = ?", (key_id,))
        # ...
    
    # –£–¥–∞–ª—è–µ–º –∫–ª—é—á
    cursor.execute("DELETE FROM vpn_keys WHERE key_email = ?", (email,))
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ `user_tokens` **–ø–µ—Ä–µ–¥** —É–¥–∞–ª–µ–Ω–∏–µ–º –∫–ª—é—á–∞.

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `validate_permanent_token`

**–§–∞–π–ª:** `src/shop_bot/data_manager/database.py:7033-7112`

```python
def validate_permanent_token(token: str) -> dict | None:
    # ...
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ user_tokens
    cursor.execute('''
        SELECT token, user_id, key_id, created_at, last_used_at, access_count
        FROM user_tokens
        WHERE token = ?
    ''', (token,))
    
    token_row = cursor.fetchone()
    
    if not token_row:
        logging.info(f"Permanent token {token_preview} not found in user_tokens table")
        return None  # ‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è None
    
    # ...
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ LEFT JOIN
    cursor.execute('''
        SELECT ut.token, ut.user_id, ut.key_id, ut.created_at, ut.last_used_at, ut.access_count,
               k.expiry_date, k.status, k.enabled, k.subscription_link
        FROM user_tokens ut
        LEFT JOIN vpn_keys k ON ut.key_id = k.key_id
        WHERE ut.token = ?
    ''', (token,))
    
    # ...
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞
    if token_data.get('expiry_date') is None:
        # –ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω - —Ç–æ–∫–µ–Ω –µ—Å—Ç—å, –Ω–æ –∫–ª—é—á —É–¥–∞–ª–µ–Ω
        token_data['key_deleted'] = True  # ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ñ–ª–∞–≥ key_deleted
```

**–õ–æ–≥–∏–∫–∞:** 
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç –≤ `user_tokens` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `None`
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å, –Ω–æ –∫–ª—é—á–∞ –Ω–µ—Ç (LEFT JOIN –≤–µ—Ä–Ω—É–ª NULL –¥–ª—è `expiry_date`) ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–ª–æ–≤–∞—Ä—å —Å `key_deleted = True`

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ `user-cabinet`

**–§–∞–π–ª:** `apps/user-cabinet/app.py:249-314`

#### –í —Ñ—É–Ω–∫—Ü–∏–∏ `index()` (—Å—Ç—Ä–æ–∫–∏ 249-314):

```python
@app.route('/')
def index():
    token = request.args.get('token') or session.get('token')
    
    if token:
        token_data = validate_permanent_token(token)
        
        if token_data:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∫–ª—é—á —É–¥–∞–ª–µ–Ω
            if token_data.get('key_deleted'):
                return render_template('error.html',
                                     error_title="–ö–ª—é—á —É–¥–∞–ª–µ–Ω",
                                     error_message="..."), 404  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        else:
            # ‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 403
            return render_template('error.html',
                                 error_title="–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞",
                                 error_message="..."), 403
```

#### –í –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–µ `require_token()` (—Å—Ç—Ä–æ–∫–∏ 188-237):

```python
def require_token(f):
    token_data = validate_permanent_token(token)
    
    if not token_data:
        return render_template('error.html',
                             error_title="–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞",
                             error_message="..."), 403  # ‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∫–ª—é—á —É–¥–∞–ª–µ–Ω
    if token_data.get('key_deleted'):
        return render_template('error.html',
                             error_title="–ö–ª—é—á —É–¥–∞–ª–µ–Ω",
                             error_message="..."), 404  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
```

---

## üêõ –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –¶–µ–ø–æ—á–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ —Ç–µ—Å—Ç–µ:

1. **–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ –∏ —Ç–æ–∫–µ–Ω–∞** (—á–µ—Ä–µ–∑ `test_user`):
   - –ö–ª—é—á —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ `vpn_keys`
   - –¢–æ–∫–µ–Ω —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ `user_tokens` —Å `key_id`

2. **–£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞** (`delete_key_by_email`):
   - ‚ùå **–¢–æ–∫–µ–Ω —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ `user_tokens`** (—Å—Ç—Ä–æ–∫–∞ 6579)
   - –ö–ª—é—á —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ `vpn_keys`

3. **–ü–æ–ø—ã—Ç–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞** (`validate_permanent_token`):
   - –ó–∞–ø—Ä–æ—Å –∫ `user_tokens` –ø–æ —Ç–æ–∫–µ–Ω—É ‚Üí **–Ω–µ –Ω–∞–π–¥–µ–Ω** (—Ç–æ–∫–µ–Ω —É–∂–µ —É–¥–∞–ª–µ–Ω)
   - –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏**:
   - `token_data` = `None`
   - –£—Å–ª–æ–≤–∏–µ `if token_data:` –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è **403** —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞"

### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ vs –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

| –®–∞–≥ | –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ | –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ |
|-----|----------------|----------------------|
| –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ | –¢–æ–∫–µ–Ω –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –ë–î | ‚ùå –¢–æ–∫–µ–Ω —É–¥–∞–ª—è–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –∫–ª—é—á–æ–º |
| –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ | `token_data` —Å `key_deleted=True` | ‚ùå `token_data = None` |
| HTTP —Å—Ç–∞—Ç—É—Å | **404** | ‚ùå **403** |
| –°–æ–æ–±—â–µ–Ω–∏–µ | "–ö–ª—é—á —É–¥–∞–ª–µ–Ω" | ‚ùå "–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞" |

---

## üí° –†–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ù–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–∫–µ–Ω –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª—é—á–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ `delete_key_by_email`:**

```python
def delete_key_by_email(email: str):
    # ...
    # –ù–ï —É–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω - –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É–¥–∞–ª–µ–Ω–Ω–æ–º –∫–ª—é—á–µ
    # cursor.execute("DELETE FROM user_tokens WHERE key_id = ?", (key_id,))  # ‚ùå –£–±—Ä–∞—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
    
    # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª—é—á
    cursor.execute("DELETE FROM vpn_keys WHERE key_email = ?", (email,))
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –¢–æ–∫–µ–Ω –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- ‚úÖ `validate_permanent_token` –≤–µ—Ä–Ω–µ—Ç `key_deleted=True`
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–µ—Ä–Ω–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å 404 —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "–ö–ª—é—á —É–¥–∞–ª–µ–Ω"
- ‚úÖ –¢–µ—Å—Ç –±—É–¥–µ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –¢–æ–∫–µ–Ω—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ë–î –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—á–∏—Å—Ç–∫—É —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—É—é –∑–∞–¥–∞—á—É)

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É —Ç–µ—Å—Ç–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–µ:**

```python
def test_index_with_deleted_key(self, flask_app, test_user, temp_db):
    # ...
    # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª—é—á, –ù–ï —Ç–æ–∫–µ–Ω
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π SQL –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ delete_key_by_email
    import sqlite3
    with sqlite3.connect(temp_db) as conn:
        cursor = conn.cursor()
        cursor.execute("DELETE FROM vpn_keys WHERE key_email = ?", (test_user['key_email'],))
        conn.commit()
    
    # –¢–µ–ø–µ—Ä—å —Ç–æ–∫–µ–Ω –æ—Å—Ç–∞–ª—Å—è, –Ω–æ –∫–ª—é—á —É–¥–∞–ª–µ–Ω
    response = flask_app.get(f'/?token={test_user["token"]}')
    assert response.status_code == 404
    assert '–ö–ª—é—á —É–¥–∞–ª–µ–Ω'.encode('utf-8') in response.data
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ `delete_key_by_email`
- ‚ùå –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–º—É —Å—Ü–µ–Ω–∞—Ä–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É `delete_key_by_email` —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ `delete_key_by_email`:**

```python
def delete_key_by_email(email: str, delete_tokens: bool = False):
    # ...
    if row:
        key_id = row[0]
        if delete_tokens:
            # –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ
            cursor.execute("DELETE FROM user_tokens WHERE key_id = ?", (key_id,))
    # ...
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –£—Å–ª–æ–∂–Ω—è–µ—Ç API —Ñ—É–Ω–∫—Ü–∏–∏
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö –≤—ã–∑–æ–≤–∞

---

## üìä –í—ã–≤–æ–¥—ã

### –ü—Ä–æ–±–ª–µ–º–∞
–¢–µ—Å—Ç –ø–∞–¥–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `delete_key_by_email` —É–¥–∞–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ `user_tokens` –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∫–ª—é—á–∞. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:
- `validate_permanent_token` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` (—Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω)
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **403** –≤–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ **404**
- –°–æ–æ–±—â–µ–Ω–∏–µ "–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞" –≤–º–µ—Å—Ç–æ "–ö–ª—é—á —É–¥–∞–ª–µ–Ω"

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
**–í–∞—Ä–∏–∞–Ω—Ç 1** ‚Äî –Ω–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–∫–µ–Ω –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª—é—á–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç:
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö–ª—é—á —É–¥–∞–ª–µ–Ω" –≤–º–µ—Å—Ç–æ "–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞"
- –†–∞–∑–ª–∏—á–∞—Ç—å —Å–ª—É—á–∞–∏: —Ç–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω (403) vs –∫–ª—é—á —É–¥–∞–ª–µ–Ω (404)
- –¢–µ—Å—Ç –±—É–¥–µ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—É—é –∑–∞–¥–∞—á—É
- –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞: –µ—Å–ª–∏ –∫–ª—é—á —É–¥–∞–ª–µ–Ω –±–æ–ª–µ–µ N –¥–Ω–µ–π –Ω–∞–∑–∞–¥, —É–¥–∞–ª—è—Ç—å —Ç–æ–∫–µ–Ω

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `tests/unit/test_user_cabinet/test_cabinet.py:265-282` ‚Äî —Ç–µ—Å—Ç
- `src/shop_bot/data_manager/database.py:6564-6594` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è `delete_key_by_email`
- `src/shop_bot/data_manager/database.py:7033-7112` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è `validate_permanent_token`
- `apps/user-cabinet/app.py:249-314` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ `/`
- `apps/user-cabinet/app.py:188-237` ‚Äî –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `require_token`

