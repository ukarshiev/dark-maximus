# Анализ расхождения между терминалом и Allure

**Дата:** 18.11.2025  
**Проблема:** В терминале показывается 449 тестов (43 failed, 403 passed, 3 skipped, 374 warnings), а в Allure только 412 test cases (14 failed).

## Результаты исследования

### Факты

1. **В allure-results накоплено 4579 файлов результатов** за все время запусков тестов
2. **Уникальных testCaseId: 405** - это означает, что один и тот же тест запускался много раз
3. **В последних 500 результатах:**
   - passed: 402
   - failed: 58
   - skipped: 16
   - broken: 24
   - Всего: 500

### Причины расхождения

1. **Allure группирует тесты по testCaseId**
   - Allure показывает только уникальные testCaseId (405), а не все запуски
   - При настройке `KEEP_HISTORY=1` Allure сохраняет историю и группирует тесты по testCaseId
   - В отчете показывается только последний результат для каждого testCaseId

2. **Warnings не записываются в Allure**
   - В `pytest.ini` была опция `--disable-warnings`, которая полностью отключала warnings
   - Warnings не попадают в файлы результатов Allure
   - В терминале показывается 374 warnings, но в Allure их нет

3. **Skipped тесты записываются, но могут не отображаться**
   - Skipped тесты записываются в allure-results (найдено 94 skipped в истории)
   - Но в отчете Allure они могут не отображаться из-за группировки по testCaseId

## Решение

### 1. Настройка pytest для записи warnings

Изменено в `pytest.ini`:
- Убрано: `--disable-warnings`
- Добавлено: `-W default::Warning` (показывает warnings, но не останавливает выполнение)

### 2. Очистка старых результатов

Создан скрипт `tests/ad-hoc/clear_allure_results.ps1` для очистки старых результатов перед новым запуском тестов.

**Использование:**
```powershell
powershell -ExecutionPolicy Bypass -File tests/ad-hoc/clear_allure_results.ps1
```

Это гарантирует, что Allure покажет все тесты из текущего запуска, а не только уникальные testCaseId из истории.

### 3. Рекомендации по настройке Allure Service

Текущие настройки в `docker-compose.yml`:
- `KEEP_HISTORY=1` - сохраняет историю запусков
- `KEEP_HISTORY_LATEST=100` - сохраняет последние 100 запусков

**Важно:** Для отображения всех тестов из текущего запуска нужно:
1. Очистить старые результаты перед запуском тестов
2. Или настроить Allure для показа всех запусков (не только последнего)

## Проверка решения

После применения изменений:

1. Очистить старые результаты:
   ```powershell
   powershell -ExecutionPolicy Bypass -File tests/ad-hoc/clear_allure_results.ps1
   ```

2. Запустить тесты:
   ```powershell
   docker compose exec autotest pytest -v
   ```

3. Проверить отчет Allure:
   - Должно показываться 449 тестов (как в терминале)
   - Должно показываться 43 failed
   - Должно показываться 3 skipped
   - Warnings должны быть видны в деталях тестов

## Дополнительные рекомендации

1. **Автоматическая очистка перед запуском тестов:**
   - Можно добавить очистку в скрипт запуска тестов
   - Или настроить CI/CD для очистки перед каждым запуском

2. **Настройка категорий для warnings:**
   - Можно добавить категорию "Warnings" в `allure-categories.json` для группировки тестов с warnings

3. **Мониторинг расхождений:**
   - Регулярно проверять соответствие данных в терминале и Allure
   - Использовать скрипт `tests/ad-hoc/analyze_allure_discrepancy.ps1` для анализа

## Связанные файлы

- `pytest.ini` - конфигурация pytest
- `docker-compose.yml` - настройки Allure Service
- `allure-categories.json` - категории для группировки тестов
- `tests/ad-hoc/clear_allure_results.ps1` - скрипт очистки результатов
- `tests/ad-hoc/analyze_allure_discrepancy.ps1` - скрипт анализа расхождений

