# üìã –ê–Ω–∞–ª–∏–∑ —Ç–µ—Å—Ç–∞ `test_auto_renewal_process_plan_unavailable`

> **–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–¥–∞–∫—Ü–∏–∏:** 27.01.2025

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 16.11.2025  
**–¢–µ—Å—Ç:** `tests/integration/test_auto_renewal/test_auto_renewal_process.py::TestAutoRenewalProcess::test_auto_renewal_process_plan_unavailable`  
**–°—Ç–∞—Ç—É—Å:** ‚ùå –ü–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π `NameError: name 'get_user_balance' is not defined`

---

## üìù –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è VPN-–∫–ª—é—á–µ–π –≤ —Å–ª—É—á–∞–µ, –∫–æ–≥–¥–∞ —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (—É–¥–∞–ª–µ–Ω –∏–ª–∏ —Å–∫—Ä—ã—Ç). –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ:

1. –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ **–ù–ï** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ
2. –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–ù–ï** —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
3. –ö–ª—é—á –æ—Å—Ç–∞–µ—Ç—Å—è —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è

### –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

#### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (Arrange)
```python
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_id = 123463
register_user_if_not_exists(user_id, "test_user4", referrer_id=None)

# –°–æ–∑–¥–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞ (—Å–µ—Ä–≤–µ—Ä–∞)
create_host("test_host", "http://test.com", "user", "pass", 1, "testcode")

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è
add_to_user_balance(user_id, 200.0)  # –î–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –±–∞–ª–∞–Ω—Å
set_auto_renewal_enabled(user_id, True)  # –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
```

#### 2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º
```python
# –ö–ª—é—á —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è (1 —á–∞—Å –Ω–∞–∑–∞–¥)
expiry_date = datetime.now(timezone.utc) - timedelta(hours=1)

key_id = add_new_key(
    user_id=123463,
    host_name="test_host",
    xui_client_uuid="test-uuid-unavailable",
    key_email=f"user{user_id}-key1@testcode.bot",
    expiry_timestamp_ms=int(expiry_date.timestamp() * 1000),
    connection_string="vless://test",
    plan_name="Unavailable Plan",  # –ü–ª–∞–Ω –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    price=100.0,
)
```

#### 3. –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏–π (Mock)
```python
# –ú–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–ª—é—á–µ–π –∏–∑ –ë–î
with patch('shop_bot.data_manager.database.get_all_keys') as mock_get_keys:
    mock_get_keys.return_value = [{
        'key_id': key_id,
        'user_id': user_id,
        'host_name': 'test_host',
        'plan_name': 'Unavailable Plan',
        'expiry_date': expiry_date.isoformat(),
        'price': 100.0,
    }]
    
    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ú–û–ö: –¢–∞—Ä–∏—Ñ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    with patch('shop_bot.data_manager.scheduler._get_plan_info_for_key', 
               return_value=(None, 0.0, 0, None, False)):
        # is_plan_available = False –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–ª–∞–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        await perform_auto_renewals(mock_bot)
```

#### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ (Assert)
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–∞–ª–∞–Ω—Å –ù–ï –∏–∑–º–µ–Ω–∏–ª—Å—è (–¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è 200.0)
balance = get_user_balance(user_id)
assert balance == 200.0
```

### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

1. ‚úÖ `perform_auto_renewals` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å—Ç–µ–∫—à–∏—Ö –∫–ª—é—á–µ–π
2. ‚úÖ –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç –∫–ª—é—á —á–µ—Ä–µ–∑ `get_all_keys()`
3. ‚úÖ `_get_plan_info_for_key()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `(None, 0.0, 0, None, False)` ‚Äî –ø–ª–∞–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
4. ‚úÖ –í —Ñ—É–Ω–∫—Ü–∏–∏ `perform_auto_renewals` –Ω–∞ —Å—Ç—Ä–æ–∫–µ **924** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —É—Å–ª–æ–≤–∏–µ:
   ```python
   if not plan_info or not plan_has_duration or not plan_id or price_to_renew <= 0 or not is_plan_available:
       continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
   ```
5. ‚úÖ –¢–∞–∫ –∫–∞–∫ `is_plan_available = False`, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ **–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å** –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
6. ‚úÖ –ë–∞–ª–∞–Ω—Å –æ—Å—Ç–∞–µ—Ç—Å—è **200.0** (–Ω–µ —Å–ø–∏—Å–∞–Ω)

---

## üîç –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–∫–∏ `NameError: name 'get_user_balance' is not defined`

### –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏

**–û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –≤ —Å—Ç—Ä–æ–∫–µ 260 —Ç–µ—Å—Ç–∞:**
```python
balance = get_user_balance(user_id)  # ‚ùå NameError –∑–¥–µ—Å—å
```

### –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤

#### –í —Ç–µ—Å—Ç–µ (—Å—Ç—Ä–æ–∫–∞ 218):
```python
from shop_bot.data_manager.database import (
    register_user_if_not_exists,
    add_new_key,
    add_to_user_balance,
    get_user_balance,  # ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∑–¥–µ—Å—å
    set_auto_renewal_enabled,
    create_host,
)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–º–ø–æ—Ä—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∞**, –Ω–æ **–¥–æ** –±–ª–æ–∫–æ–≤ `with patch()`. –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏, –∏–º–ø–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å—Ç—Ä–æ–∫–µ 260.

#### –í `perform_auto_renewals` (—Å—Ç—Ä–æ–∫–∞ 929):
```python
from shop_bot.data_manager.database import get_user_balance, add_to_user_balance, log_transaction, get_user, get_key_by_id
current_balance = float(get_user_balance(user_id) or 0.0)
```

**–ó–¥–µ—Å—å –∏–º–ø–æ—Ä—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `get_user_balance` –ª–æ–∫–∞–ª—å–Ω–æ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ—ë.

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏

#### 1. ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–∞—Ç—á–∏–Ω–≥–æ–º –º–æ–¥—É–ª–µ–π

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `patch('shop_bot.data_manager.database.get_all_keys')` –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è `database`, —á—Ç–æ –º–æ–∂–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç–µ—Å—Ç–∞.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
# –°—Ç—Ä–æ–∫–∞ 247: –ü–∞—Ç—á–∏—Ç—Å—è get_all_keys –∏–∑ database
with patch('shop_bot.data_manager.database.get_all_keys') as mock_get_keys:
    # –°—Ç—Ä–æ–∫–∞ 256: –ü–∞—Ç—á–∏—Ç—Å—è _get_plan_info_for_key –∏–∑ scheduler
    with patch('shop_bot.data_manager.scheduler._get_plan_info_for_key', ...):
        # –°—Ç—Ä–æ–∫–∞ 257: –í—ã–∑—ã–≤–∞–µ—Ç—Å—è perform_auto_renewals
        await perform_auto_renewals(mock_bot)
```

**–ì–∏–ø–æ—Ç–µ–∑–∞:** –ü–∞—Ç—á–∏–Ω–≥ `database.get_all_keys` –º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–æ–≤ –≤ —Ç–µ—Å—Ç–µ.

#### 2. ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–±–ª–∞—Å—Ç—å—é –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `async`

–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `perform_auto_renewals` –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –≥–¥–µ –∏–º–ø–æ—Ä—Ç—ã –∏–∑ —Ç–µ—Å—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –Ω–æ —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –≤–ª–∏—è—Ç—å –Ω–∞ **–ª–æ–∫–∞–ª—å–Ω—É—é** –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `get_user_balance` –≤ —Ç–µ—Å—Ç–µ.

#### 3. ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ—Ä—è–¥–∫–æ–º –∏–º–ø–æ—Ä—Ç–æ–≤

–ï—Å–ª–∏ `perform_auto_renewals` –∏–ª–∏ –∫–∞–∫–∞—è-—Ç–æ –≤—ã–∑–≤–∞–Ω–Ω–∞—è –∏–∑ –Ω–µ—ë —Ñ—É–Ω–∫—Ü–∏—è –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `get_user_balance` **–¥–æ** –µ—ë –∏–º–ø–æ—Ä—Ç–∞ –≤ `perform_auto_renewals`, –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –æ—à–∏–±–∫–∞.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ `perform_auto_renewals`:**

```python
# –°—Ç—Ä–æ–∫–∞ 913: _get_plan_info_for_key –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ü–ï–†–ï–î –∏–º–ø–æ—Ä—Ç–æ–º get_user_balance
plan_info, price_to_renew, months_to_renew, plan_id, is_plan_available = _get_plan_info_for_key(key)

# –°—Ç—Ä–æ–∫–∞ 929: get_user_balance –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –ó–î–ï–°–¨
from shop_bot.data_manager.database import get_user_balance, ...

# –°—Ç—Ä–æ–∫–∞ 930: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞
current_balance = float(get_user_balance(user_id) or 0.0)
```

**–í—ã–≤–æ–¥:** –í `perform_auto_renewals` –∏–º–ø–æ—Ä—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–¥–æ** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –∑–¥–µ—Å—å.

#### 4. ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê –° –ü–ê–¢–ß–ò–ù–ì–û–ú –ò –õ–û–ö–ê–õ–¨–ù–´–ú–ò –ò–ú–ü–û–†–¢–ê–ú–ò

**–ù–ê–ô–î–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ö–æ–≥–¥–∞ –º—ã –ø–∞—Ç—á–∏–º `shop_bot.data_manager.database.get_all_keys`, Python –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å `database`, —á—Ç–æ –º–æ–∂–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ **–ª–æ–∫–∞–ª—å–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –∏–º–µ–Ω —Ç–µ—Å—Ç–∞**.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–∞ **–ª–æ–∫–∞–ª—å–Ω–æ** —Ç–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ:
```
tests\integration\test_auto_renewal\test_auto_renewal_process.py::TestAutoRenewalProcess::test_auto_renewal_process_plan_unavailable PASSED [100%]
```

**–í—ã–≤–æ–¥:** –ü—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å:
1. –í –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ Allure)
2. –ò–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –º–æ–¥—É–ª–µ–π Python
3. –ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤

---

## üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –º–æ–¥—É–ª—è

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–µ:**
```python
# –í –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞, –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è
from shop_bot.data_manager.database import (
    register_user_if_not_exists,
    add_new_key,
    add_to_user_balance,
    get_user_balance,  # ‚úÖ –ò–º–ø–æ—Ä—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è
    set_auto_renewal_enabled,
    create_host,
)

class TestAutoRenewalProcess:
    @pytest.mark.asyncio
    async def test_auto_renewal_process_plan_unavailable(self, temp_db, mock_bot):
        # –¢–µ–ø–µ—Ä—å get_user_balance –¥–æ—Å—Ç—É–ø–Ω–∞ –±–µ–∑ –∏–º–ø–æ—Ä—Ç–∞ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
        # ...
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π –∏–º–ø–æ—Ä—Ç –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫–µ 260:**
```python
# –°—Ç—Ä–æ–∫–∞ 259-260: –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –ü–ï–†–ï–î –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
from shop_bot.data_manager.database import get_user_balance
balance = get_user_balance(user_id)
assert balance == 200.0
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `importlib.reload` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π –º–æ–¥—É–ª–µ–π –ø—Ä–∏ –ø–∞—Ç—á–∏–Ω–≥–µ, –º–æ–∂–Ω–æ —è–≤–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å:

```python
import importlib
from shop_bot.data_manager import database

# –ü–æ—Å–ª–µ –ø–∞—Ç—á–∏–Ω–≥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å
importlib.reload(database)
from shop_bot.data_manager.database import get_user_balance
balance = get_user_balance(user_id)
```

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—á–∏–Ω–≥ —á–µ—Ä–µ–∑ `monkeypatch` –≤–º–µ—Å—Ç–æ `patch`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
```python
@pytest.mark.asyncio
async def test_auto_renewal_process_plan_unavailable(self, temp_db, mock_bot, monkeypatch):
    # ...
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º monkeypatch –≤–º–µ—Å—Ç–æ patch
    def mock_get_all_keys():
        return [{...}]
    
    def mock_get_plan_info_for_key(key):
        return (None, 0.0, 0, None, False)
    
    monkeypatch.setattr('shop_bot.data_manager.database.get_all_keys', mock_get_all_keys)
    monkeypatch.setattr('shop_bot.data_manager.scheduler._get_plan_info_for_key', mock_get_plan_info_for_key)
    
    await perform_auto_renewals(mock_bot)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    balance = get_user_balance(user_id)
    assert balance == 200.0
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–∞

```
test_auto_renewal_process_plan_unavailable
‚îú‚îÄ‚îÄ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (Arrange)
‚îÇ   ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–ª–∞–Ω—Å–∞ (200.0)
‚îÇ   ‚îú‚îÄ‚îÄ –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º
‚îú‚îÄ‚îÄ –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ (Mock)
‚îÇ   ‚îú‚îÄ‚îÄ get_all_keys() ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª—é—á
‚îÇ   ‚îî‚îÄ‚îÄ _get_plan_info_for_key() ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç (None, 0.0, 0, None, False)
‚îú‚îÄ‚îÄ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (Act)
‚îÇ   ‚îî‚îÄ‚îÄ perform_auto_renewals(mock_bot)
‚îî‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ (Assert)
    ‚îî‚îÄ‚îÄ balance == 200.0 ‚úÖ
```

---

## üéØ –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –í—ã–≤–æ–¥—ã
1. ‚úÖ –¢–µ—Å—Ç **–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
2. ‚úÖ –õ–æ–≥–∏–∫–∞ —Ç–µ—Å—Ç–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
3. ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å `NameError` –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –ø–∞—Ç—á–∏–Ω–≥–æ–º –∏ –æ–±–ª–∞—Å—Ç—å—é –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–æ–≤
4. ‚ö†Ô∏è –¢–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –ø–∞–¥–∞–µ—Ç –≤ Allure (–≤–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –í–∞—Ä–∏–∞–Ω—Ç 2** (–∏–º–ø–æ—Ä—Ç –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º) ‚Äî —Å–∞–º–æ–µ –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ—Ç –ª–∏ –ø—Ä–æ–±–ª–µ–º —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Ç–µ—Å—Ç–æ–≤
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤ `conftest.py` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Ñ–∏–∫—Å—Ç—É—Ä—ã
4. –î–æ–±–∞–≤–∏—Ç—å —è–≤–Ω—ã–π –∏–º–ø–æ—Ä—Ç `get_user_balance` –ø–µ—Ä–µ–¥ —Å—Ç—Ä–æ–∫–æ–π 260 –≤ —Ç–µ—Å—Ç–µ

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 16.11.2025  
**–ê–≤—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞:** AI Assistant

