# Ручные уведомления панели

**Дата последней редакции:** 13.11.2025 06:50 (UTC+3)  
**Версия:** 1.0

Краткое описание: как администратору вручную отправлять системные уведомления из вкладки «Уведомления» панели, какие шаблоны доступны и какие параметры должны быть указаны.

## Доступные шаблоны

| Код шаблона | Название | Когда использовать | Допустимые маркеры времени |
|-------------|----------|--------------------|-----------------------------|
| `subscription_expiry` | Окончание подписки | Тариф доступен и требуется стандартное напоминание | 72, 48, 24, 1 час |
| `subscription_plan_unavailable` | Тариф недоступен | План удалён/скрыт, автопродление невозможно | 72, 48, 24, 1 час |
| `subscription_autorenew_notice` | Автопродление с баланса | Баланс ≥ стоимости, автопродление включено | 24, 1 час |
| `subscription_autorenew_disabled` | Автопродление отключено | Баланс ≥ стоимости, автопродление выключено | 24, 1 час |

- Для повторной отправки уже существующего уведомления отметьте чекбокс «Отправить повторно».
- Шаблоны, требующие проверки условий (доступность тарифа, баланс, статус автопродления), вернут ошибку 409 при несоблюдении ограничений.

## Обновлённый интерфейс панели

1. Нажмите кнопку «Создать» на странице `Админка → Уведомления`.
2. Выберите пользователя через поиск по ID или username.
3. В выпадающем списке «Тип уведомления» выберите нужный шаблон. Описание шаблона выводится под списком.
4. Если шаблон поддерживает выбор маркера, выберите момент отправки (например, «через 1 день»).
5. По необходимости включите чекбокс «Отправить повторно (игнорировать защиту от дублей)». Эта опция доступна только для шаблонов, где разрешён повтор.
6. Нажмите «Запустить» — уведомление уйдёт в очередь отправки. После ответа сервера страница обновится.

## API

### `GET /api/notification-templates`

Возвращает структуру:

```json
{
  "templates": [
    {
      "code": "subscription_expiry",
      "name": "Окончание подписки",
      "description": "...",
      "markers": [
        { "hours": 72, "label": "через 3 дня" },
        { "hours": 48, "label": "через 2 дня" },
        { "hours": 24, "label": "через 1 день" },
        { "hours": 1, "label": "через 1 час" }
      ],
      "default_marker": 24,
      "supports_force": true,
      "conditions": {
        "require_plan_available": true,
        "require_balance_covers": false,
        "require_autorenew_enabled": false,
        "require_autorenew_disabled": false
      }
    }
  ]
}
```

### `POST /create-notification`

Тело запроса:

```json
{
  "user_id": 6044240344,
  "template_code": "subscription_plan_unavailable",
  "marker_hours": 24,
  "force": true
}
```

- `marker_hours` обязателен только для шаблонов с доступными маркерами.
- `force=true` позволяет повторно отправить уведомление даже при наличии записи в журнале (для шаблонов с поддержкой повтора).

## Проверка результата

- Все вручную созданные уведомления попадают в таблицу `notifications` с полем `status`. Повторные запускаются со статусом `resent`.
- Для диагностики используйте таблицу на вкладке «Уведомления» или прямой запрос к базе:  
  `SELECT notification_id, type, status, created_date FROM notifications ORDER BY created_date DESC;`


