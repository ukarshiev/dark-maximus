# –ß–µ–∫-–ª–∏—Å—Ç —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è Timezone Support (KAR-30)

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–¥–∞–∫—Ü–∏–∏:** 07.11.2025

## –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
- [x] Unit —Ç–µ—Å—Ç—ã: 17/17 –ø—Ä–æ–π–¥–µ–Ω–æ
- [x] Integration —Ç–µ—Å—Ç—ã: 8/8 –ø—Ä–æ–π–¥–µ–Ω–æ

### ‚è≥ –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á —Å –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ 1 —á–∞—Å
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –ë–î expiry_date –≤ UTC (–±–µ–∑ tzinfo)
- [ ] –î–æ–∂–¥–∞—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 1 —á–∞—Å (–¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ –≤–æ–≤—Ä–µ–º—è!)
- [ ] –°–º–µ–Ω–∏—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –Ω–∞ UTC+10
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ (+10 —á–∞—Å–æ–≤)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –±–∞–ª–∞–Ω—Å)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (admin_timezone)

---

## –ü–ª–∞–Ω —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è

### üìÖ –î–µ–Ω—å 1: –î–µ–ø–ª–æ–π –∫–æ–¥–∞ (feature_flag = 0)

**–¶–µ–ª—å:** –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥ –±–µ–∑ –≤–∫–ª—é—á–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

#### –®–∞–≥–∏:
1. **–°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –ë–î**
   ```bash
   python tests/backup_before_timezone_migration.py
   ```
   –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å–æ–∑–¥–∞—Å—Ç—Å—è —Ñ–∞–π–ª `users_backup_YYYYMMDD_HHMMSS.db`

2. **–î–µ–ø–ª–æ–π –∫–æ–¥–∞**
   ```bash
   git checkout main
   git pull
   # –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è
   npx nx build bot
   npx nx serve bot
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ**
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞—Ç—ã (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å Moscow –≤—Ä–µ–º—è)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:
- ‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –î–∞—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ Moscow –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –≤–æ–≤—Ä–µ–º—è

---

### üìÖ –î–µ–Ω—å 2: –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É timezone –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ

#### –®–∞–≥–∏:
1. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É timezone**
   ```bash
   python tests/add_timezone_column.py
   ```
   –ü—Ä–æ–≤–µ—Ä–∫–∞:
   ```sql
   PRAGMA table_info(users);
   -- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∞: timezone TEXT DEFAULT 'Europe/Moscow'
   ```

2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ (dry-run)**
   ```bash
   python tests/migrate_expiry_dates_to_utc.py --dry-run
   ```
   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫–∏–µ –∫–ª—é—á–∏ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã

3. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é**
   ```bash
   python tests/migrate_expiry_dates_to_utc.py --apply
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î**
   ```sql
   -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –∫–ª—é—á–∏ —Ç–µ–ø–µ—Ä—å –≤ UTC
   SELECT user_id, key, expiry_date, timezone FROM users LIMIT 10;
   
   -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
   SELECT 
     COUNT(*) as total_keys,
     COUNT(CASE WHEN timezone IS NOT NULL THEN 1 END) as with_timezone
   FROM users;
   ```

#### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:
- ‚úÖ –ö–æ–ª–æ–Ω–∫–∞ timezone –¥–æ–±–∞–≤–ª–µ–Ω–∞
- ‚úÖ –í—Å–µ –¥–∞—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ UTC
- ‚úÖ –ë–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫

---

### üìÖ –î–µ–Ω—å 3: –¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

**–¶–µ–ª—å:** –í–∫–ª—é—á–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### –®–∞–≥–∏:
1. **–í–∫–ª—é—á–∏—Ç—å feature flag**
   ```sql
   UPDATE bot_settings 
   SET value = '1' 
   WHERE key = 'feature_timezone_enabled';
   ```

2. **–í—ã–±—Ä–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
   - –ê–¥–º–∏–Ω—ã
   - –¢–µ—Å—Ç–µ—Ä—ã
   - –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å –∏—Ö —Å–æ–≥–ª–∞—Å–∏—è)

3. **–ü–æ–ø—Ä–æ—Å–∏—Ç—å —Ç–µ—Å—Ç–µ—Ä–æ–≤ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å**
   - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–π
   - –°–º–µ–Ω—É timezone —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:
- ‚úÖ –¢–µ—Å—Ç–µ—Ä—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã
- ‚úÖ –ù–µ—Ç –∂–∞–ª–æ–± –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –≤–æ–≤—Ä–µ–º—è

---

### üìÖ –î–µ–Ω—å 4+: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ

**–¶–µ–ª—å:** –í–∫–ª—é—á–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º

#### –®–∞–≥–∏:
1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ (–ø–µ—Ä–≤—ã–µ 24-48 —á–∞—Å–æ–≤)**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–¥–æ–ª–∂–Ω–æ = 0)
   - –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Ç–æ—á–Ω–æ—Å—Ç—å ¬±1 –º–∏–Ω—É—Ç–∞)
   - –û—à–∏–±–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ timezone (–≤ –ª–æ–≥–∞—Ö)
   - –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ë–î

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏**
   ```bash
   npx nx logs bot --tail=500 | grep -i "timezone\|expiry\|notification"
   ```

3. **–ï—Å–ª–∏ –≤—Å—ë —Ö–æ—Ä–æ—à–æ ‚Üí –≤–∫–ª—é—á–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö**
   ```sql
   -- Feature flag —É–∂–µ –≤–∫–ª—é—á–µ–Ω —Å –î–Ω—è 3
   -- –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   ```

#### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –≤ –Ω–æ—Ä–º–µ
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∂–∞–ª—É—é—Ç—Å—è

---

## Rollback –ü–ª–∞–Ω

### üö® –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

#### –£—Ä–æ–≤–µ–Ω—å 1: –í—ã–∫–ª—é—á–∏—Ç—å feature flag
```sql
UPDATE bot_settings 
SET value = '0' 
WHERE key = 'feature_timezone_enabled';
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –í–µ—Ä–Ω—ë—Ç —Å–∏—Å—Ç–µ–º—É –∫ legacy —Ä–µ–∂–∏–º—É (Moscow –≤—Ä–µ–º—è –¥–ª—è –≤—Å–µ—Ö)

#### –£—Ä–æ–≤–µ–Ω—å 2: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î (–µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ)
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç
npx nx stop bot

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î –∏–∑ –±—ç–∫–∞–ø–∞
cp users_backup_YYYYMMDD_HHMMSS.db users.db

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç
npx nx serve bot
```

#### –£—Ä–æ–≤–µ–Ω—å 3: –û—Ç–∫–∞—Ç–∏—Ç—å –∫–æ–¥
```bash
git log --oneline -10  # –ù–∞–π—Ç–∏ commit –¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π
git revert <commit_hash>
git push
# –ü–µ—Ä–µ–¥–µ–ø–ª–æ–∏—Ç—å
```

---

## –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
1. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞–¥–µ—Ä–∂–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

2. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è timezone**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ fallback –Ω–∞ Moscow

3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è scheduler
   - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
npx nx logs bot | grep "Notification sent"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏ timezone
npx nx logs bot | grep "timezone.*error\|Invalid timezone"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å scheduler
npx nx logs bot | grep "Scheduler"
```

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **Linear –∑–∞–¥–∞—á–∞:** https://linear.app/karshiev/issue/KAR-30
- **–ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** `.cursor/plans/timezone-support-production-safe.plan.md`
- **–¢–µ—Å—Ç—ã:** `tests/test_timezone_integration.py`
- **–£—Ç–∏–ª–∏—Ç—ã:** `src/shop_bot/utils/datetime_utils.py`

---

## –ß–µ–∫-–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [ ] –í—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ
- [ ] –ë—ç–∫–∞–ø –ë–î —Å–æ–∑–¥–∞–Ω
- [ ] –ö–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω (–î–µ–Ω—å 1)
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –≤—ã–ø–æ–ª–Ω–µ–Ω—ã (–î–µ–Ω—å 2)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ (–î–µ–Ω—å 3)
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 24-48 —á–∞—Å–æ–≤ (–î–µ–Ω—å 4+)
- [ ] Feature –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤—Å–µ—Ö
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –ó–∞–¥–∞—á–∞ KAR-30 –∑–∞–∫—Ä—ã—Ç–∞ –≤ Linear

---

**–°—Ç–∞—Ç—É—Å:** ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

