# Сводка по тестированию Timezone Support

**Дата последней редакции:** 07.11.2025

## Результаты автоматического тестирования

### Unit тесты (test_timezone_utils.py)
**Статус:** ✅ 17/17 пройдено

**Охват:**
- ✅ `ensure_utc_datetime()` - конвертация в UTC
- ✅ `timestamp_to_utc_datetime()` - конвертация timestamp
- ✅ `format_datetime_moscow()` - форматирование для Moscow
- ✅ `format_datetime_for_user()` - форматирование с timezone
- ✅ `get_current_utc_naive()` - получение текущего UTC
- ✅ `get_moscow_now()` - получение Moscow времени
- ✅ `calculate_remaining_seconds()` - вычисление оставшегося времени

**Запуск:**
```bash
python tests/test_timezone_utils.py
```

---

### Integration тесты (test_timezone_integration.py)
**Статус:** ✅ 8/8 пройдено

**Тесты:**

#### 1. Создание ключа → сохранение UTC в БД
- ✅ Создаёт тестового пользователя с ключом
- ✅ Проверяет, что `expiry_date` сохранён в UTC (naive)
- ✅ Проверяет точность даты (±1 секунда)

#### 2. Уведомление → правильное время
- ✅ Создаёт ключ с истечением через 1 час
- ✅ Вычисляет `remaining_seconds` (~3600)
- ✅ Проверяет, что уведомление придёт вовремя

#### 3. Смена timezone → корректное отображение
- ✅ Проверяет отображение для Moscow (UTC+3)
- ✅ Проверяет отображение для Yekaterinburg (UTC+5)
- ✅ Проверяет отображение для UTC
- ⚠️ На Windows используется fallback на Moscow (ожидаемо)

#### 4. Feature flag выключен → Moscow
- ✅ При `feature_enabled=False` используется Moscow
- ✅ Игнорирует `user_timezone` параметр

#### 5. Автопродление → правильное время
- ✅ Проверяет срабатывание автопродления за 1 час
- ✅ Проверяет, что `expiry_date` в UTC

#### 6. Обратная совместимость → старые ключи
- ✅ Старые ключи (без timezone) работают корректно
- ✅ Форматирование работает с дефолтным timezone

#### 7. Граничный случай → истекший ключ
- ✅ Для истекшего ключа возвращает 0 секунд

#### 8. Граничный случай → невалидный timezone
- ✅ Fallback на Moscow при невалидном timezone

**Запуск:**
```bash
python tests/test_timezone_integration.py
```

---

## Скрипты миграции

### 1. Бэкап БД (backup_before_timezone_migration.py)
**Назначение:** Создаёт резервную копию БД перед миграцией

**Использование:**
```bash
python tests/backup_before_timezone_migration.py
```

**Результат:**
- Создаёт файл `users_backup_YYYYMMDD_HHMMSS.db`
- Проверяет размер файла
- Выводит инструкции по восстановлению

---

### 2. Добавление колонки timezone (add_timezone_column.py)
**Назначение:** Добавляет колонку `timezone` в таблицу `users`

**Использование:**
```bash
python tests/add_timezone_column.py
```

**Изменения в БД:**
```sql
ALTER TABLE users 
ADD COLUMN timezone TEXT DEFAULT 'Europe/Moscow';
```

**Проверка:**
```sql
PRAGMA table_info(users);
-- Должна быть колонка: timezone TEXT DEFAULT 'Europe/Moscow'
```

---

### 3. Миграция дат в UTC (migrate_expiry_dates_to_utc.py)
**Назначение:** Конвертирует существующие `expiry_date` из Moscow в UTC

**Использование:**
```bash
# Dry-run (без изменений)
python tests/migrate_expiry_dates_to_utc.py --dry-run

# Применить изменения
python tests/migrate_expiry_dates_to_utc.py --apply
```

**Что делает:**
1. Находит все ключи с `expiry_date`
2. Конвертирует из Moscow в UTC (вычитает 3 часа)
3. Обновляет записи в БД
4. Выводит статистику

**Безопасность:**
- Есть dry-run режим
- Создаёт бэкап перед применением
- Rollback при ошибках

---

## Ручное тестирование

### Чек-лист ручного тестирования

#### 1. Создать тестовый ключ
```
/start → Купить тариф → Выбрать тариф на 1 час
```
**Проверка:**
- Ключ создан
- В сообщении показано время истечения

#### 2. Проверить БД
```sql
SELECT user_id, key, expiry_date, timezone 
FROM users 
WHERE user_id = <ваш_telegram_id>
LIMIT 1;
```
**Ожидание:**
- `expiry_date` в формате `YYYY-MM-DDTHH:MM:SS` (без Z в конце)
- `timezone` = `'Europe/Moscow'` (по умолчанию)

#### 3. Дождаться уведомления
**Через ~59 минут должно прийти уведомление:**
```
⏰ Ваш ключ истекает через 1 час!
Ключ: <key>
Истекает: <date>
```

**Проверка:**
- Уведомление пришло вовремя (±1 минута)
- Время в уведомлении правильное

#### 4. Сменить timezone
```
/settings → Изменить часовой пояс → Выбрать UTC+10
```

**Проверка:**
- Время отображения изменилось (+10 часов от UTC)
- Бот продолжает работать

#### 5. Проверить автопродление
**Условия:**
- Баланс > 0
- Автопродление включено

**Проверка:**
- За 1 час до истечения ключ продлевается
- Уведомление об автопродлении приходит

#### 6. Проверить веб-интерфейс
```
Открыть веб-панель → Настройки → Admin Timezone
```

**Проверка:**
- Можно выбрать timezone для админа
- Даты в интерфейсе отображаются правильно

---

## Метрики для мониторинга

### Критические метрики

#### Уведомления
```bash
# Количество отправленных уведомлений
npx nx logs bot | grep "Notification sent" | wc -l

# Количество пропущенных уведомлений
npx nx logs bot | grep "Notification missed" | wc -l

# Задержки уведомлений
npx nx logs bot | grep "Notification delay"
```

**Норма:**
- Пропущенных = 0
- Задержка < 1 минута

#### Конвертация timezone
```bash
# Ошибки конвертации
npx nx logs bot | grep -i "timezone.*error"

# Fallback на Moscow
npx nx logs bot | grep "fallback.*Moscow"
```

**Норма:**
- Ошибок = 0
- Fallback только для невалидных timezone

#### Производительность
```bash
# Время выполнения scheduler
npx nx logs bot | grep "Scheduler.*completed"

# Медленные запросы к БД
npx nx logs bot | grep "slow query"
```

**Норма:**
- Scheduler < 1 секунда
- Нет медленных запросов

---

## Rollback сценарии

### Сценарий 1: Неправильное отображение времени
**Симптомы:**
- Пользователи жалуются на неправильное время
- Уведомления приходят не вовремя

**Решение:**
```sql
-- Выключить feature flag
UPDATE bot_settings 
SET value = '0' 
WHERE key = 'feature_timezone_enabled';
```

**Эффект:**
- Возврат к legacy режиму (Moscow для всех)
- Функциональность продолжает работать

---

### Сценарий 2: Ошибки в БД после миграции
**Симптомы:**
- Ошибки при чтении `expiry_date`
- Бот не может создать новые ключи

**Решение:**
```bash
# Остановить бот
npx nx stop bot

# Восстановить БД из бэкапа
# Windows:
Copy-Item -Path "users_backup_YYYYMMDD_HHMMSS.db" -Destination "users.db" -Force

# Linux/Mac:
cp users_backup_YYYYMMDD_HHMMSS.db users.db

# Запустить бот
npx nx serve bot
```

---

### Сценарий 3: Критические ошибки
**Симптомы:**
- Бот не запускается
- Массовые ошибки в логах

**Решение:**
```bash
# Откатить код
git log --oneline -10  # Найти commit до изменений
git revert <commit_hash>
git push

# Восстановить БД (см. Сценарий 2)

# Передеплоить
npx nx build bot
npx nx serve bot
```

---

## Контрольные точки

### ✅ Перед началом развёртывания
- [ ] Все unit тесты пройдены (17/17)
- [ ] Все integration тесты пройдены (8/8)
- [ ] Ручное тестирование пройдено
- [ ] Скрипты миграции протестированы
- [ ] Rollback план подготовлен

### ✅ День 1: Деплой кода
- [ ] Бэкап БД создан
- [ ] Код задеплоен
- [ ] Бот запущен и работает
- [ ] Feature flag = 0 (выключен)

### ✅ День 2: Миграции БД
- [ ] Колонка timezone добавлена
- [ ] Данные мигрированы (dry-run)
- [ ] Данные мигрированы (apply)
- [ ] БД проверена

### ✅ День 3: Тестовая группа
- [ ] Feature flag включен
- [ ] Тестеры подтвердили корректность
- [ ] Мониторинг запущен

### ✅ День 4+: Полное развёртывание
- [ ] Метрики в норме
- [ ] Нет ошибок в логах
- [ ] Функциональность для всех

---

## Итоговый статус

**Дата:** 07.11.2025  
**Статус:** ⏳ Готов к развёртыванию  

**Следующие шаги:**
1. Провести ручное тестирование
2. Создать бэкап БД
3. Начать развёртывание (День 1)

**Ссылки:**
- Linear: https://linear.app/karshiev/issue/KAR-30
- План: `.cursor/plans/timezone-support-production-safe.plan.md`
- Чек-лист: `docs/guides/deployment/timezone-rollout-checklist.md`

