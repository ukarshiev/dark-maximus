> Обновлено: 24.09.2025

# API управления ключами

Эти эндпоинты используются административной панелью для загрузки хостов и синхронизации данных ключей с панелями 3x-ui. Все запросы выполняются в рамках авторизованной сессии Flask (cookie `logged_in`).

## GET /api/hosts
- **Назначение**: получить список доступных хостов без чувствительных данных.
- **Ответ** (`200 OK`):
  ```json
  {
    "success": true,
    "hosts": [
      {"host_name": "fra-1", "host_url": "https://example.com"}
    ]
  }
  ```
- **Ошибки**: при сбое возвращает `500` и поле `error` с описанием.

## POST /refresh-user-keys
- **Назначение**: обновить ключи конкретного пользователя по `user_id`.
- **Тело запроса**:
  ```json
  {
    "user_id": 123456789
  }
  ```
- **Успешный ответ** (`200 OK`):
  ```json
  {
    "success": true,
    "status": "success",
    "updated_count": 2,
    "message": "Ключи обновлены: 2",
    "user_id": 123456789
  }
  ```
- **Частичный успех**: `success = false`, `status = "partial"`, массив `errors` с деталями проблемных ключей.
- **Ошибки валидации**: `400 Bad Request` с описанием в поле `error`.

## POST /refresh-keys-by-host
- **Назначение**: обновить все ключи, привязанные к конкретному хосту.
- **Тело запроса**:
  ```json
  {
    "host_name": "fra-1"
  }
  ```
- **Успешный ответ** (`200 OK`):
  ```json
  {
    "success": true,
    "status": "success",
    "updated_count": 15,
    "message": "Ключи обновлены: 15",
    "host_name": "fra-1"
  }
  ```
- **Частичный успех**: `success = false`, `status = "partial"`, присутствует массив `errors`.
- **Не найден хост**: `404 Not Found` с полем `error`.

## Поле errors
Каждый объект в массиве `errors` содержит `email`, `host_name`, `xui_client_uuid`, даты и текст ошибки. Это помогает быстро выявить проблемные записи и принять решение о повторной синхронизации или удалении ключа.
