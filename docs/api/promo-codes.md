# API Промокодов

> Обновлено: 22.10.2025 21:15

Документация по работе с API промокодов в системе Dark Maximus.

## Обзор

API промокодов предоставляет полный функционал для управления промокодами, включая создание, редактирование, удаление и отслеживание использования.

## Веб-интерфейс

Система промокодов включает современный веб-интерфейс с системой вкладок и двумя режимами отображения:

### Система вкладок

Интерфейс разделен на две основные вкладки:

#### Вкладка "Промокоды"
- Управление промокодами (создание, редактирование, удаление)
- Карточный и табличный режимы просмотра
- Применённые промокоды пользователя (при наличии user_id в URL)

#### Вкладка "История"
- Полная история использования всех промокодов
- Расширенная система фильтрации:
  - По дате (диапазон от-до)
  - По пользователю (ID или username)
  - По статусу (применён/использован)
  - По боту (shop/support)
  - По промокоду (текстовый поиск)
- Кнопка "Обновить" для перезагрузки данных
- Отображение всех атрибутов использования

### Карточный вид (по умолчанию)
- Современные карточки с информацией о промокодах
- Анимированные скелетоны загрузки
- Hover-эффекты и плавные переходы
- Адаптивная сетка для разных размеров экрана
- Цветовая индикация статуса (активен/неактивен)

### Табличный вид
- Классическая таблица с сортировкой
- Компактное отображение данных
- Быстрый доступ к действиям

### Особенности интерфейса
- **Счетчик промокодов** в заголовке
- **Пустое состояние** с призывом к действию
- **Подсказки** для всех интерактивных элементов
- **Переключение режимов** просмотра
- **Адаптивный дизайн** для мобильных устройств
 - **Вкладка «Резюме»** в карточке промокода: формирует краткое описание на основе введённых полей (код, ссылка, тариф(ы), скидки, квота, срок сгорания, «действителен до», группы). Пустые поля не выводятся. Текст доступен для копирования.

### Генерация ссылки

Ссылка на применение промокода формируется из реального username Telegram-бота и кода:

```
https://t.me/<USERNAME_БОТА>?start=promo_<КОД>
```

Например: `https://t.me/darkmaxi_vpn_bot?start=promo_TEST1`.

На странице промокодов UI подставляет `telegram_bot_username` из настроек в выпадающем списке и формирует ссылку автоматически при выборе бота и вводе кода.

### Поведение при переходе по ссылке

При запуске бота по deep-link `/start=promo_<КОД>` бот проверяет валидность промокода и показывает пользователю сообщение:

```
✅ Применен промо-код <КОД>
```

Если промокод недействителен или уже использован — отправляется уведомление об ошибке.

### Таблица использования промокодов

В карточке редактирования промокода (drawer) во вкладке "Использования" отображается расширенная таблица с колонками:

1. **Меню** - действия с записью использования (удаление)
2. **ID** - уникальный идентификатор записи использования (usage_id)
3. **Пользователь** - ID пользователя в Telegram
4. **Username** - имя пользователя в Telegram
5. **Бот** - бот, в котором использован промокод (shop/support)
6. **Скидка ₽|%|Б** - объединённое отображение скидок:
   - Показывает только заполненные значения (например: "50₽ и 10%" или "20Б")
   - Если все значения пустые, отображается "-"
7. **План** - название тарифного плана
8. **Дата использования** - время применения промокода
9. **Статус** - текущий статус использования:
   - "Применён" (синий badge) - промокод применён, но покупка не совершена
   - "Использован" (зелёный badge) - промокод использован при покупке
10. **Метаданные** - дополнительная информация в формате JSON (отображается в tooltip)

## Система статусов промокодов

Система использует два статуса для отслеживания использования промокодов:

### Статус `applied` (применен)
- Устанавливается при активации промокода (через deep-link или форму)
- Промокод проверен, данные сохранены в базу, бонус зачислен (если есть)
- Покупка еще не совершена
- Пользователь может повторно применить тот же промокод (обновляется дата)

### Статус `used` (использован)
- Устанавливается при успешной оплате (`status='succeeded'`)
- Покупка завершена, скидка фактически применена
- Пользователь не может повторно использовать этот промокод

### Логика работы

1. **Применение промокода** (deep-link или форма):
   - Проверяются все условия (активность, лимит, сроки, группы)
   - Записывается в `promo_code_usage` со статусом `'applied'`
   - Зачисляется бонус на баланс (если есть)
   - Сохраняется `usage_id` в state для связи с транзакцией

2. **Покупка тарифа**:
   - Читаются данные промокода из `promo_code_usage` где `status='applied'`
   - Проверяется соответствие тарифа (если указан `target_plan_id`)
   - Применяется скидка к цене
   - При успешной оплате: обновляется статус на `'used'` + добавляется `plan_id`

### Преимущества новой системы

- **Исправлена критическая ошибка**: промокоды больше не "сгорают" при переходе по ссылке
- **Гибкость**: пользователь может применять разные промокоды
- **Защита**: один промокод нельзя использовать дважды
- **Отслеживание**: четкое разделение между применением и использованием

## Эндпоинты

### Получить все промокоды

**GET** `/api/promo-codes`

Возвращает список всех промокодов с информацией об использовании.

**Ответ:**
```json
{
  "success": true,
  "promo_codes": [
    {
      "promo_id": 1,
      "code": "WELCOME2025",
      "bot": "shop",
      "vpn_plan_id": 1,
      "tariff_code": null,
      "discount_amount": 100.0,
      "discount_percent": 0.0,
      "discount_bonus": 0.0,
      "usage_limit_per_bot": 1,
      "is_active": 1,
      "created_at": "2025-01-21 10:00:00",
      "updated_at": "2025-01-21 10:00:00",
      "plan_name": "Basic VPN",
      "host_name": "Server 1",
      "usage_count": 5
    }
  ]
}
```

### Создать промокод

**POST** `/api/promo-codes`

Создает новый промокод.

**Тело запроса:**
```json
{
  "code": "NEWYEAR2025",
  "bot": "shop",
  "vpn_plan_id": 1,
  "tariff_code": null,
  "discount_amount": 50.0,
  "discount_percent": 10.0,
  "discount_bonus": 25.0,
  "usage_limit_per_bot": 1,
  "is_active": true
}
```

**Обязательные поля:**
- `code` - уникальный код промокода
- `bot` - бот для применения (только `shop`)

**Ответ:**
```json
{
  "success": true,
  "message": "Промокод создан"
}
```

### Получить промокод по ID

**GET** `/api/promo-codes/{promo_id}`

Возвращает информацию о конкретном промокоде.

**Ответ:**
```json
{
  "success": true,
  "promo_code": {
    "promo_id": 1,
    "code": "WELCOME2025",
    "bot": "shop",
    "vpn_plan_id": 1,
    "tariff_code": null,
    "discount_amount": 100.0,
    "discount_percent": 0.0,
    "discount_bonus": 0.0,
    "usage_limit_per_bot": 1,
    "is_active": 1,
    "created_at": "2025-01-21 10:00:00",
    "updated_at": "2025-01-21 10:00:00",
    "plan_name": "Basic VPN",
    "host_name": "Server 1"
  }
}
```

### Обновить промокод

**PUT** `/api/promo-codes/{promo_id}`

Обновляет существующий промокод.

**Тело запроса:** (аналогично созданию)

**Ответ:**
```json
{
  "success": true,
  "message": "Промокод обновлен"
}
```

### Удалить промокод

**DELETE** `/api/promo-codes/{promo_id}`

Удаляет промокод и всю историю его использования.

**Ответ:**
```json
{
  "success": true,
  "message": "Промокод удален"
}
```

### Получить историю использования промокода

**GET** `/api/promo-codes/{promo_id}/usage`

Возвращает список всех использований конкретного промокода.

**Ответ:**
```json
{
  "success": true,
  "usage_history": [
    {
      "usage_id": 1,
      "promo_id": 1,
      "user_id": 123456789,
      "username": "john_doe",
      "bot": "shop",
      "discount_amount": 100.0,
      "discount_percent": 0.0,
      "discount_bonus": 0.0,
      "plan_id": 1,
      "plan_name": "Basic VPN",
      "used_at": "2025-01-21 12:00:00",
      "status": "used",
      "metadata": "{\"payment_id\": \"12345\"}"
    }
  ]
}
```

### Получить всю историю использования промокодов

**GET** `/api/promo-codes-usage-history`

Возвращает полную историю использования всех промокодов с возможностью фильтрации на клиенте.

**Ответ:**
```json
{
  "success": true,
  "usage_history": [
    {
      "usage_id": 1,
      "promo_id": 1,
      "code": "WELCOME2025",
      "user_id": 123456789,
      "username": "john_doe",
      "bot": "shop",
      "discount_amount": 100.0,
      "discount_percent": 0.0,
      "discount_bonus": 0.0,
      "plan_id": 1,
      "plan_name": "Basic VPN",
      "host_name": "Server 1",
      "used_at": "2025-01-21 12:00:00",
      "status": "used",
      "metadata": "{\"payment_id\": \"12345\"}"
    }
  ]
}
```

### Удалить запись использования промокода (по пользователю)

Позволяет удалить конкретное использование промокода, чтобы пользователь мог применить промокод повторно.

**DELETE** `/api/user-promo-codes/{usage_id}`

**Тело запроса:**
```json
{
  "user_id": 123456789,
  "bot": "shop"
}
```

**Ответ (успех):**
```json
{
  "success": true,
  "message": "Промокод удалён из вашего списка"
}
```

**Ответ (ошибка):**
```json
{
  "success": false,
  "message": "Промокод не найден или уже удалён"
}
```

### Валидация промокода

**POST** `/api/validate-promo-code`

Проверяет, может ли пользователь использовать промокод.

**Тело запроса:**
```json
{
  "user_id": 123456789,
  "promo_code": "WELCOME2025",
  "bot": "shop"
}
```

**Ответ:**
```json
{
  "success": true,
  "can_use": true,
  "message": "Промокод можно использовать",
  "promo_data": {
    "promo_id": 1,
    "code": "WELCOME2025",
    "discount_amount": 100.0,
    "discount_percent": 0.0,
    "discount_bonus": 0.0
  }
}
```

### Получить все VPN планы

**GET** `/api/vpn-plans`

Возвращает список всех доступных VPN планов для выпадающих списков.

**Ответ:**
```json
{
  "success": true,
  "plans": [
    {
      "plan_id": 1,
      "host_name": "Server 1",
      "plan_name": "Basic VPN",
      "months": 1,
      "price": 100.0,
      "days": 30,
      "traffic_gb": 10.0,
      "hours": 0
    }
  ]
}
```

## Коды ошибок

- `400` - Неверные данные запроса
- `404` - Промокод не найден
- `500` - Внутренняя ошибка сервера

## Правила валидации

1. **Уникальность кода:** Каждый промокод должен иметь уникальный код
2. **Одно использование на бота:** Пользователь может использовать промокод только один раз в рамках одного бота
3. **Лимит использований:** Промокод имеет ограничение на количество использований на одного бота
4. **Активность:** Только активные промокоды могут быть использованы

## Типы скидок

- **discount_amount** - фиксированная скидка в рублях
- **discount_percent** - процентная скидка (0-100%)
- **discount_bonus** - бонусная скидка в бонусах

## Интеграция с ботами

Промокоды доступны только для бота магазина:
- `shop` - бот магазина

**Важно:** Бот поддержки (`support`) не поддерживает промокоды, так как предназначен исключительно для обработки тикетов и общения с пользователями.

## Технические детали

### CSS Переменные
Система использует CSS-переменные для единообразного стиля:
```css
--promo-card-bg: var(--bg-surface);
--promo-card-border: var(--border-color);
--promo-card-hover: var(--bg-elevated);
--promo-card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
--promo-card-shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.15);
--promo-card-radius: 12px;
--promo-card-padding: 20px;
--promo-card-gap: 20px;
```

### JavaScript Функции
- `loadPromoCodes()` - загрузка данных с сервера
- `renderPromoCards()` - отрисовка карточного вида
- `renderPromoCodesTable()` - отрисовка табличного вида
- `toggleViewMode()` - переключение между режимами
- `showLoadingState()` - отображение состояния загрузки
- `showEmptyState()` - отображение пустого состояния

### Адаптивность
- **Desktop**: 2-3 карточки в ряд
- **Tablet**: 1-2 карточки в ряд
- **Mobile**: 1 карточка в ряд, вертикальная компоновка

---

*Дата последнего обновления: 20.10.2025*
