# API Промокодов

Документация по работе с API промокодов в системе Dark Maximus.

## Обзор

API промокодов предоставляет полный функционал для управления промокодами, включая создание, редактирование, удаление и отслеживание использования.

## Веб-интерфейс

Система промокодов включает современный веб-интерфейс с двумя режимами отображения:

### Карточный вид (по умолчанию)
- Современные карточки с информацией о промокодах
- Анимированные скелетоны загрузки
- Hover-эффекты и плавные переходы
- Адаптивная сетка для разных размеров экрана
- Цветовая индикация статуса (активен/неактивен)

### Табличный вид
- Классическая таблица с сортировкой
- Компактное отображение данных
- Быстрый доступ к действиям

### Особенности интерфейса
- **Счетчик промокодов** в заголовке
- **Пустое состояние** с призывом к действию
- **Подсказки** для всех интерактивных элементов
- **Переключение режимов** просмотра
- **Адаптивный дизайн** для мобильных устройств

## Эндпоинты

### Получить все промокоды

**GET** `/api/promo-codes`

Возвращает список всех промокодов с информацией об использовании.

**Ответ:**
```json
{
  "success": true,
  "promo_codes": [
    {
      "promo_id": 1,
      "code": "WELCOME2025",
      "bot": "shop",
      "vpn_plan_id": 1,
      "tariff_code": null,
      "discount_amount": 100.0,
      "discount_percent": 0.0,
      "discount_bonus": 0.0,
      "usage_limit_per_bot": 1,
      "is_active": 1,
      "created_at": "2025-01-21 10:00:00",
      "updated_at": "2025-01-21 10:00:00",
      "plan_name": "Basic VPN",
      "host_name": "Server 1",
      "usage_count": 5
    }
  ]
}
```

### Создать промокод

**POST** `/api/promo-codes`

Создает новый промокод.

**Тело запроса:**
```json
{
  "code": "NEWYEAR2025",
  "bot": "shop",
  "vpn_plan_id": 1,
  "tariff_code": null,
  "discount_amount": 50.0,
  "discount_percent": 10.0,
  "discount_bonus": 25.0,
  "usage_limit_per_bot": 1,
  "is_active": true
}
```

**Обязательные поля:**
- `code` - уникальный код промокода
- `bot` - бот для применения (только `shop`)

**Ответ:**
```json
{
  "success": true,
  "message": "Промокод создан"
}
```

### Получить промокод по ID

**GET** `/api/promo-codes/{promo_id}`

Возвращает информацию о конкретном промокоде.

**Ответ:**
```json
{
  "success": true,
  "promo_code": {
    "promo_id": 1,
    "code": "WELCOME2025",
    "bot": "shop",
    "vpn_plan_id": 1,
    "tariff_code": null,
    "discount_amount": 100.0,
    "discount_percent": 0.0,
    "discount_bonus": 0.0,
    "usage_limit_per_bot": 1,
    "is_active": 1,
    "created_at": "2025-01-21 10:00:00",
    "updated_at": "2025-01-21 10:00:00",
    "plan_name": "Basic VPN",
    "host_name": "Server 1"
  }
}
```

### Обновить промокод

**PUT** `/api/promo-codes/{promo_id}`

Обновляет существующий промокод.

**Тело запроса:** (аналогично созданию)

**Ответ:**
```json
{
  "success": true,
  "message": "Промокод обновлен"
}
```

### Удалить промокод

**DELETE** `/api/promo-codes/{promo_id}`

Удаляет промокод и всю историю его использования.

**Ответ:**
```json
{
  "success": true,
  "message": "Промокод удален"
}
```

### Получить историю использования промокода

**GET** `/api/promo-codes/{promo_id}/usage`

Возвращает список всех использований конкретного промокода.

**Ответ:**
```json
{
  "success": true,
  "usage_history": [
    {
      "usage_id": 1,
      "promo_id": 1,
      "user_id": 123456789,
      "username": "john_doe",
      "bot": "shop",
      "plan_id": 1,
      "plan_name": "Basic VPN",
      "used_at": "2025-01-21 12:00:00"
    }
  ]
}
```

### Валидация промокода

**POST** `/api/validate-promo-code`

Проверяет, может ли пользователь использовать промокод.

**Тело запроса:**
```json
{
  "user_id": 123456789,
  "promo_code": "WELCOME2025",
  "bot": "shop"
}
```

**Ответ:**
```json
{
  "success": true,
  "can_use": true,
  "message": "Промокод можно использовать",
  "promo_data": {
    "promo_id": 1,
    "code": "WELCOME2025",
    "discount_amount": 100.0,
    "discount_percent": 0.0,
    "discount_bonus": 0.0
  }
}
```

### Получить все VPN планы

**GET** `/api/vpn-plans`

Возвращает список всех доступных VPN планов для выпадающих списков.

**Ответ:**
```json
{
  "success": true,
  "plans": [
    {
      "plan_id": 1,
      "host_name": "Server 1",
      "plan_name": "Basic VPN",
      "months": 1,
      "price": 100.0,
      "days": 30,
      "traffic_gb": 10.0,
      "hours": 0
    }
  ]
}
```

## Коды ошибок

- `400` - Неверные данные запроса
- `404` - Промокод не найден
- `500` - Внутренняя ошибка сервера

## Правила валидации

1. **Уникальность кода:** Каждый промокод должен иметь уникальный код
2. **Одно использование на бота:** Пользователь может использовать промокод только один раз в рамках одного бота
3. **Лимит использований:** Промокод имеет ограничение на количество использований на одного бота
4. **Активность:** Только активные промокоды могут быть использованы

## Типы скидок

- **discount_amount** - фиксированная скидка в рублях
- **discount_percent** - процентная скидка (0-100%)
- **discount_bonus** - бонусная скидка в бонусах

## Интеграция с ботами

Промокоды доступны только для бота магазина:
- `shop` - бот магазина

**Важно:** Бот поддержки (`support`) не поддерживает промокоды, так как предназначен исключительно для обработки тикетов и общения с пользователями.

## Технические детали

### CSS Переменные
Система использует CSS-переменные для единообразного стиля:
```css
--promo-card-bg: var(--bg-surface);
--promo-card-border: var(--border-color);
--promo-card-hover: var(--bg-elevated);
--promo-card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
--promo-card-shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.15);
--promo-card-radius: 12px;
--promo-card-padding: 20px;
--promo-card-gap: 20px;
```

### JavaScript Функции
- `loadPromoCodes()` - загрузка данных с сервера
- `renderPromoCards()` - отрисовка карточного вида
- `renderPromoCodesTable()` - отрисовка табличного вида
- `toggleViewMode()` - переключение между режимами
- `showLoadingState()` - отображение состояния загрузки
- `showEmptyState()` - отображение пустого состояния

### Адаптивность
- **Desktop**: 2-3 карточки в ряд
- **Tablet**: 1-2 карточки в ряд
- **Mobile**: 1 карточка в ряд, вертикальная компоновка

---

*Дата последнего обновления: 20.10.2025*
