# –û–±–∑–æ—Ä –º–æ–¥—É–ª–µ–π {{PROJECT_NAME}}

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
- [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –º–æ–¥—É–ª–µ–π](#–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã-–º–æ–¥—É–ª–µ–π)
- [–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏](#–æ—Å–Ω–æ–≤–Ω—ã–µ-–º–æ–¥—É–ª–∏)
- [–ú–æ–¥—É–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#–º–æ–¥—É–ª–∏-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
- [–°–ª—É–∂–µ–±–Ω—ã–µ –º–æ–¥—É–ª–∏](#—Å–ª—É–∂–µ–±–Ω—ã–µ-–º–æ–¥—É–ª–∏)
- [–í–µ–±-–º–æ–¥—É–ª–∏](#–≤–µ–±-–º–æ–¥—É–ª–∏)
- [–ú–æ–¥—É–ª–∏ –¥–∞–Ω–Ω—ã—Ö](#–º–æ–¥—É–ª–∏-–¥–∞–Ω–Ω—ã—Ö)
- [–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏](#–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏-–º–µ–∂–¥—É-–º–æ–¥—É–ª—è–º–∏)
- [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-–º–æ–¥—É–ª–µ–π)
- [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-–º–æ–¥—É–ª–µ–π)

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –º–æ–¥—É–ª–µ–π

–ü—Ä–æ–µ–∫—Ç {{PROJECT_NAME}} –ø–æ—Å—Ç—Ä–æ–µ–Ω –ø–æ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –≥–¥–µ –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å. –ú–æ–¥—É–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –≤ –ø–∞–∫–µ—Ç—ã –∏ —Å–ª–µ–¥—É—é—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º:

- **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å** - –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å —Ä–µ—à–∞–µ—Ç –æ–¥–Ω—É –∑–∞–¥–∞—á—É
- **–°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å** - –ú–æ–¥—É–ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç —á–µ—Ä–µ–∑ —á–µ—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- **–í—ã—Å–æ–∫–∞—è —Å–ø–ª–æ—á–µ–Ω–Ω–æ—Å—Ç—å** - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–æ–¥—É–ª—è —Ç–µ—Å–Ω–æ —Å–≤—è–∑–∞–Ω—ã
- **–ò–Ω–≤–µ—Ä—Å–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** - –ú–æ–¥—É–ª–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π, –∞ –Ω–µ –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π
```
src/shop_bot/
‚îú‚îÄ‚îÄ __init__.py                 # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–∫–µ—Ç–∞
‚îú‚îÄ‚îÄ __main__.py                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ config.py                   # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ bot_controller.py           # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –±–æ—Ç–∞
‚îú‚îÄ‚îÄ ton_monitor.py              # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TON
‚îú‚îÄ‚îÄ bot/                        # Telegram Bot –º–æ–¥—É–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ handlers.py             # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ keyboards.py            # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îî‚îÄ‚îÄ middlewares.py          # –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û
‚îú‚îÄ‚îÄ data_manager/               # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ database.py             # –†–∞–±–æ—Ç–∞ —Å –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ scheduler.py            # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
‚îú‚îÄ‚îÄ modules/                    # –ú–æ–¥—É–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ xui_api.py              # API 3x-ui
‚îî‚îÄ‚îÄ webhook_server/             # –í–µ–±-–ø–∞–Ω–µ–ª—å
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ app.py                  # Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    ‚îú‚îÄ‚îÄ templates/              # HTML —à–∞–±–ª–æ–Ω—ã
    ‚îî‚îÄ‚îÄ static/                 # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏

### 1. config.py - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
- –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥—Ä—É–≥–∏–º –º–æ–¥—É–ª—è–º

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
class Config:
    """–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏."""
    
    # Telegram Bot
    TELEGRAM_BOT_TOKEN: str
    TELEGRAM_BOT_USERNAME: str
    ADMIN_TELEGRAM_ID: int
    
    # 3x-ui Panel
    XUI_PANEL_URL: str
    XUI_PANEL_USERNAME: str
    XUI_PANEL_PASSWORD: str
    
    # –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
    YOOKASSA_SHOP_ID: str
    YOOKASSA_SECRET_KEY: str
    CRYPTOBOT_TOKEN: str
    TON_WALLET_ADDRESS: str
    TONAPI_KEY: str
    
    # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    DATABASE_URL: str
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    DEBUG: bool
    LOG_LEVEL: str
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```python
from shop_bot.config import settings

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
bot_token = settings.TELEGRAM_BOT_TOKEN

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ –æ—Ç–ª–∞–¥–∫–∏
if settings.DEBUG:
    print("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏")
```

### 2. bot_controller.py - –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –±–æ—Ç–∞
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Telegram –±–æ—Ç–æ–º.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ middleware
- –ó–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
class BotController:
    """–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä Telegram –±–æ—Ç–∞."""
    
    def __init__(self, config: Config):
        self.config = config
        self.bot = Bot(token=config.TELEGRAM_BOT_TOKEN)
        self.dp = Dispatcher()
        self._setup_handlers()
        self._setup_middlewares()
    
    async def start(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞."""
        await self.dp.start_polling(self.bot)
    
    async def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞."""
        await self.bot.session.close()
    
    def _setup_handlers(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤."""
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
        pass
    
    def _setup_middlewares(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ middleware."""
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è middleware
        pass
```

### 3. ton_monitor.py - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TON
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TON-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö TON-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—É–º–º –ø–ª–∞—Ç–µ–∂–∞–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞—Ç–µ–∂–µ–π

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
class TONMonitor:
    """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TON-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π."""
    
    def __init__(self, tonapi_key: str, wallet_address: str):
        self.tonapi_key = tonapi_key
        self.wallet_address = wallet_address
        self.is_running = False
    
    async def start_monitoring(self):
        """–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞."""
        self.is_running = True
        while self.is_running:
            await self._check_transactions()
            await asyncio.sleep(30)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    
    async def _check_transactions(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π."""
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        # –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –æ–∂–∏–¥–∞—é—â–∏–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏
        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        pass
```

## –ú–æ–¥—É–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. modules/xui_api.py - API 3x-ui –ø–∞–Ω–µ–ª–∏
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–∞–Ω–µ–ª—å—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è 3x-ui –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è VPN —Å–µ—Ä–≤–µ—Ä–∞–º–∏.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
- –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ VPN –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
class XUIApiClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å 3x-ui API."""
    
    def __init__(self, panel_url: str, username: str, password: str):
        self.panel_url = panel_url
        self.username = username
        self.password = password
        self.session = None
    
    async def authenticate(self) -> bool:
        """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ –ø–∞–Ω–µ–ª–∏."""
        # –õ–æ–≥–∏–Ω –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        pass
    
    async def create_client(self, host_name: str, plan_data: dict) -> dict:
        """–°–æ–∑–¥–∞–Ω–∏–µ VPN –∫–ª–∏–µ–Ω—Ç–∞."""
        # –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        pass
    
    async def delete_client(self, host_name: str, client_uuid: str) -> bool:
        """–£–¥–∞–ª–µ–Ω–∏–µ VPN –∫–ª–∏–µ–Ω—Ç–∞."""
        # –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
        pass
    
    async def get_client_stats(self, host_name: str, client_uuid: str) -> dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞."""
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
        pass
    
    async def update_client_expiry(self, host_name: str, client_uuid: str, 
                                  expiry_timestamp: int) -> bool:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞."""
        # –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
        pass
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```python
from shop_bot.modules.xui_api import XUIApiClient

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
xui_client = XUIApiClient(
    panel_url="https://panel.example.com",
    username="admin",
    password="password"
)

# –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
await xui_client.authenticate()

# –°–æ–∑–¥–∞–Ω–∏–µ VPN –∫–ª–∏–µ–Ω—Ç–∞
client_data = await xui_client.create_client(
    host_name="server1",
    plan_data={
        "email": "user@example.com",
        "expiry_time": 1640995200000,
        "protocol": "vless"
    }
)
```

### 2. modules/payment_processors.py - –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏.

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–∏—Å—Ç–µ–º—ã**:
- YooKassa (–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã, –°–ë–ü)
- CryptoBot (–∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã)
- TON Connect (TON –±–ª–æ–∫—á–µ–π–Ω)
- Telegram Stars (–≤–Ω—É—Ç—Ä–∏–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏)
- Heleket (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã)

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
class PaymentProcessor(ABC):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤."""
    
    @abstractmethod
    async def create_payment(self, amount: float, currency: str, 
                           metadata: dict) -> dict:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞."""
        pass
    
    @abstractmethod
    async def verify_payment(self, payment_id: str) -> dict:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞."""
        pass

class YooKassaProcessor(PaymentProcessor):
    """–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä YooKassa."""
    
    def __init__(self, shop_id: str, secret_key: str):
        self.shop_id = shop_id
        self.secret_key = secret_key
        self.client = Client(shop_id, secret_key)
    
    async def create_payment(self, amount: float, currency: str, 
                           metadata: dict) -> dict:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ YooKassa."""
        payment = Payment.create({
            "amount": {"value": str(amount), "currency": currency},
            "confirmation": {"type": "redirect"},
            "metadata": metadata
        })
        return {
            "payment_id": payment.id,
            "payment_url": payment.confirmation.confirmation_url,
            "status": payment.status
        }

class CryptoBotProcessor(PaymentProcessor):
    """–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä CryptoBot."""
    
    def __init__(self, token: str):
        self.token = token
        self.api_url = f"https://pay.crypt.bot/api/{token}"
    
    async def create_payment(self, amount: float, currency: str, 
                           metadata: dict) -> dict:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ CryptoBot."""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
        pass
```

## –°–ª—É–∂–µ–±–Ω—ã–µ –º–æ–¥—É–ª–∏

### 1. data_manager/database.py - –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö SQLite.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
class DatabaseManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."""
    
    def __init__(self, db_path: str):
        self.db_path = db_path
        self._init_database()
    
    def _init_database(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."""
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
        # –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
        pass
    
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    async def create_user(self, user_data: dict) -> int:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        pass
    
    async def get_user(self, user_id: int) -> dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        pass
    
    async def update_user_balance(self, user_id: int, amount: float) -> bool:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        pass
    
    # VPN –∫–ª—é—á–∏
    async def create_vpn_key(self, key_data: dict) -> int:
        """–°–æ–∑–¥–∞–Ω–∏–µ VPN –∫–ª—é—á–∞."""
        pass
    
    async def get_user_keys(self, user_id: int) -> list:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        pass
    
    async def update_key_expiry(self, key_id: int, expiry_date: datetime) -> bool:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è –∫–ª—é—á–∞."""
        pass
    
    # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    async def create_transaction(self, transaction_data: dict) -> int:
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏."""
        pass
    
    async def update_transaction_status(self, payment_id: str, status: str) -> bool:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏."""
        pass
```

### 2. data_manager/scheduler.py - –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –∫–ª—é—á–µ–π
- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
class TaskScheduler:
    """–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á."""
    
    def __init__(self, database_manager: DatabaseManager):
        self.db = database_manager
        self.tasks = []
        self.is_running = False
    
    async def start(self):
        """–ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞."""
        self.is_running = True
        await self._run_tasks()
    
    async def _run_tasks(self):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á."""
        while self.is_running:
            await self._check_expiring_keys()
            await self._send_notifications()
            await self._cleanup_old_data()
            await asyncio.sleep(300)  # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    
    async def _check_expiring_keys(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –∫–ª—é—á–µ–π."""
        # –ü–æ–∏—Å–∫ –∫–ª—é—á–µ–π, –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –≤ –±–ª–∏–∂–∞–π—à–∏–µ 24 —á–∞—Å–∞
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        pass
    
    async def _send_notifications(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π."""
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram Bot API
        pass
    
    async def _cleanup_old_data(self):
        """–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö."""
        # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤
        # –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        pass
```

## –í–µ–±-–º–æ–¥—É–ª–∏

### 1. webhook_server/app.py - Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –í–µ–±-–ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å
- API –¥–ª—è webhook'–æ–≤ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Å–µ—Ä–≤–µ—Ä–∞–º–∏

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
from flask import Flask, render_template, request, jsonify
from shop_bot.data_manager.database import DatabaseManager

app = Flask(__name__)

class WebhookServer:
    """–í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏."""
    
    def __init__(self, database_manager: DatabaseManager):
        self.db = database_manager
        self.app = Flask(__name__)
        self._setup_routes()
    
    def _setup_routes(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤."""
        
        @self.app.route('/')
        def dashboard():
            """–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å."""
            stats = self.db.get_system_stats()
            return render_template('dashboard.html', stats=stats)
        
        @self.app.route('/users')
        def users():
            """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏."""
            users = self.db.get_all_users()
            return render_template('users.html', users=users)
        
        @self.app.route('/api/webhook/yookassa', methods=['POST'])
        def yookassa_webhook():
            """Webhook –¥–ª—è YooKassa."""
            data = request.json
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ
            return jsonify({"status": "ok"})
        
        @self.app.route('/api/webhook/cryptobot', methods=['POST'])
        def cryptobot_webhook():
            """Webhook –¥–ª—è CryptoBot."""
            data = request.json
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ
            return jsonify({"status": "ok"})
```

### 2. webhook_server/templates/ - HTML —à–∞–±–ª–æ–Ω—ã
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –®–∞–±–ª–æ–Ω—ã –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

**–û—Å–Ω–æ–≤–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã**:
- `base.html` - –ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω
- `dashboard.html` - –ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å
- `users.html` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- `keys.html` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏
- `transactions.html` - –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- `settings.html` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã

**–ü—Ä–∏–º–µ—Ä –±–∞–∑–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω–∞**:
```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{PROJECT_NAME}} - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">{{PROJECT_NAME}}</a>
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ –º–µ–Ω—é -->
        </div>
    </nav>
    
    <main class="container mt-4">
        {% block content %}{% endblock %}
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>
```

### 3. webhook_server/static/ - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: CSS, JavaScript –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
```
static/
‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îî‚îÄ‚îÄ style.css          # –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏
‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îî‚îÄ‚îÄ script.js          # JavaScript —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
‚îú‚îÄ‚îÄ img/
‚îÇ   ‚îú‚îÄ‚îÄ logo.png           # –õ–æ–≥–æ—Ç–∏–ø
‚îÇ   ‚îî‚îÄ‚îÄ burger.png         # –ò–∫–æ–Ω–∫–∞ –º–µ–Ω—é
‚îî‚îÄ‚îÄ logo.svg               # SVG –ª–æ–≥–æ—Ç–∏–ø
```

## –ú–æ–¥—É–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. bot/handlers.py - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram.

**–û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏**:
- –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ (`/start`, `/help`, `/profile`)
- Callback-–∑–∞–ø—Ä–æ—Å—ã –æ—Ç inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä
- –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∏ webhook'–æ–≤

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext

router = Router()

@router.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start."""
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # –ü–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    pass

@router.callback_query(F.data.startswith("plan_"))
async def handle_plan_selection(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞."""
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–∞
    # –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≤—ã–±–æ—Ä—É —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
    pass

@router.callback_query(F.data.startswith("payment_"))
async def handle_payment_selection(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã."""
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
    # –ü–æ–∫–∞–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –æ–ø–ª–∞—Ç–µ
    pass
```

### 2. bot/keyboards.py - –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–æ–∑–¥–∞–Ω–∏–µ inline –∏ reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞.

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã**:
- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–æ–≤
- –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup

def create_main_menu_keyboard() -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é."""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üõí –ö—É–ø–∏—Ç—å –∫–ª—é—á", callback_data="buy_key"),
            InlineKeyboardButton(text="üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data="profile")
        ],
        [
            InlineKeyboardButton(text="üîë –ú–æ–∏ –∫–ª—é—á–∏", callback_data="my_keys"),
            InlineKeyboardButton(text="üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="balance")
        ]
    ])
    return keyboard

def create_plans_keyboard(plans: list) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Ç–∞—Ä–∏—Ñ–æ–≤."""
    keyboard_buttons = []
    for plan in plans:
        button_text = f"{plan['plan_name']} - {plan['price']} RUB"
        callback_data = f"plan_{plan['plan_id']}"
        keyboard_buttons.append([
            InlineKeyboardButton(text=button_text, callback_data=callback_data)
        ])
    
    keyboard_buttons.append([
        InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")
    ])
    
    return InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
```

### 3. bot/middlewares.py - –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: Middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.

**–û—Å–Ω–æ–≤–Ω—ã–µ middleware**:
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
- Rate limiting
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
from aiogram import BaseMiddleware
from aiogram.types import Message, CallbackQuery

class AuthMiddleware(BaseMiddleware):
    """Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏."""
    
    async def __call__(self, handler, event, data):
        user = event.from_user
        if not user:
            return await handler(event, data)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        if await is_user_banned(user.id):
            await event.answer("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ")
            return
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await register_user_if_not_exists(user.id, user.username)
        
        return await handler(event, data)

class LoggingMiddleware(BaseMiddleware):
    """Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è."""
    
    async def __call__(self, handler, event, data):
        user = event.from_user
        action = "unknown"
        
        if isinstance(event, Message):
            action = f"message: {event.text[:50]}"
        elif isinstance(event, CallbackQuery):
            action = f"callback: {event.data}"
        
        logger.info(f"User {user.id} ({user.username}): {action}")
        return await handler(event, data)
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏

### –î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   bot_controller‚îÇ    ‚îÇ  webhook_server ‚îÇ    ‚îÇ   ton_monitor   ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ                           ‚îÇ
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ data_manager  ‚îÇ           ‚îÇ    modules    ‚îÇ
            ‚îÇ               ‚îÇ           ‚îÇ               ‚îÇ
            ‚îÇ - database    ‚îÇ           ‚îÇ - xui_api     ‚îÇ
            ‚îÇ - scheduler   ‚îÇ           ‚îÇ - payments    ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ    config     ‚îÇ
            ‚îÇ               ‚îÇ
            ‚îÇ - settings    ‚îÇ
            ‚îÇ - validation  ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–∞–≤–∏–ª–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
1. **config** - –ù–µ –∑–∞–≤–∏—Å–∏—Ç –Ω–∏ –æ—Ç –∫–æ–≥–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Å–µ–º–∏
2. **data_manager** - –ó–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç config
3. **modules** - –ó–∞–≤–∏—Å—è—Ç –æ—Ç config –∏ data_manager
4. **bot_controller** - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
5. **webhook_server** - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç data_manager –∏ modules
6. **ton_monitor** - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç data_manager –∏ modules

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π
```python
# main.py
from shop_bot.config import Config
from shop_bot.data_manager.database import DatabaseManager
from shop_bot.modules.xui_api import XUIApiClient
from shop_bot.bot_controller import BotController
from shop_bot.webhook_server.app import WebhookServer

async def main():
    # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    config = Config()
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    db_manager = DatabaseManager(config.DATABASE_URL)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
    xui_client = XUIApiClient(
        config.XUI_PANEL_URL,
        config.XUI_PANEL_USERNAME,
        config.XUI_PANEL_PASSWORD
    )
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –±–æ—Ç–∞
    bot_controller = BotController(config, db_manager, xui_client)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
    webhook_server = WebhookServer(config, db_manager)
    
    # –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
    await asyncio.gather(
        bot_controller.start(),
        webhook_server.start(),
        ton_monitor.start()
    )
```

### 2. Dependency Injection
```python
class ServiceContainer:
    """–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π."""
    
    def __init__(self, config: Config):
        self.config = config
        self._services = {}
    
    def get_database_manager(self) -> DatabaseManager:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."""
        if 'database_manager' not in self._services:
            self._services['database_manager'] = DatabaseManager(self.config.DATABASE_URL)
        return self._services['database_manager']
    
    def get_xui_client(self) -> XUIApiClient:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ 3x-ui."""
        if 'xui_client' not in self._services:
            self._services['xui_client'] = XUIApiClient(
                self.config.XUI_PANEL_URL,
                self.config.XUI_PANEL_USERNAME,
                self.config.XUI_PANEL_PASSWORD
            )
        return self._services['xui_client']
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π

### 1. Unit —Ç–µ—Å—Ç—ã
```python
# tests/test_database_manager.py
import pytest
from unittest.mock import Mock, patch
from shop_bot.data_manager.database import DatabaseManager

class TestDatabaseManager:
    def test_create_user(self):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        db_manager = DatabaseManager(":memory:")
        
        user_data = {
            "telegram_id": 12345,
            "username": "testuser"
        }
        
        user_id = db_manager.create_user(user_data)
        assert user_id is not None
        
        user = db_manager.get_user(user_id)
        assert user["telegram_id"] == 12345
        assert user["username"] == "testuser"
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
```python
# tests/test_payment_flow.py
import pytest
from shop_bot.modules.payment_processors import YooKassaProcessor
from shop_bot.data_manager.database import DatabaseManager

class TestPaymentFlow:
    @pytest.mark.asyncio
    async def test_yookassa_payment_creation(self):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ YooKassa."""
        processor = YooKassaProcessor("test_shop_id", "test_secret_key")
        
        with patch('yookassa.Payment.create') as mock_create:
            mock_create.return_value = Mock(
                id="test_payment_id",
                confirmation=Mock(confirmation_url="https://example.com/pay"),
                status="pending"
            )
            
            result = await processor.create_payment(
                amount=100.0,
                currency="RUB",
                metadata={"user_id": 12345}
            )
            
            assert result["payment_id"] == "test_payment_id"
            assert result["status"] == "pending"
```

### 3. E2E —Ç–µ—Å—Ç—ã
```python
# tests/test_bot_commands.py
import pytest
from aiogram.testing import make_request
from shop_bot.bot_controller import BotController

class TestBotCommands:
    @pytest.mark.asyncio
    async def test_start_command(self):
        """–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥—ã /start."""
        bot_controller = BotController(test_config)
        
        # –°–∏–º—É–ª—è—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã /start
        request = make_request("/start", user_id=12345, username="testuser")
        response = await bot_controller.handle_message(request)
        
        assert response.text.startswith("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å")
        assert response.reply_markup is not None
```

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ {{DATE}}*
*–í–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ–µ–∫—Ç–∞: {{OWNER}}*
