# Режимы предоставления ключей и подписок

**Последнее обновление:** 08.10.2025

## Описание

В системе реализована возможность выбора режима предоставления VPN доступа пользователям при покупке тарифа. Администратор может настроить для каждого тарифа один из трех режимов:

1. **Ключ** (по умолчанию) - пользователь получает только VLESS ключ
2. **Подписка** - пользователь получает только URL подписки
3. **Ключ + Подписка** - пользователь получает и ключ, и подписку

## Настройка режима

### В веб-панели

1. Перейдите в раздел **Настройки → Серверы**
2. Выберите хост и нажмите **Добавить тариф** или откройте существующий тариф для редактирования
3. В поле **"Режим предоставления"** выберите один из вариантов:
   - Ключ
   - Подписка
   - Ключ + Подписка
4. Сохраните изменения

### В базе данных

Режим хранится в поле `key_provision_mode` таблицы `plans`:
- `'key'` - только ключ (default)
- `'subscription'` - только подписка
- `'both'` - ключ и подписка

## Технические детали

### API 3x-ui

Для получения subscription link используется следующая логика:

1. При создании клиента в 3x-ui автоматически генерируется `subId`
2. Система получает настройки подписки с панели через API `/panel/setting/all`
3. Формируется subscription link: `{subURI}{subId}`

### Пример subscription link

```
https://serv1.dark-maximus.com/subs/h6ld5dncl3vx8izf
```

### Обработка ошибок

Если не удается получить subscription link (например, не настроен subURI на панели 3x-ui), система автоматически переключается на режим "только ключ" и логирует предупреждение.

## Преимущества подписки

- **Автоматическое обновление** - при изменении конфигурации сервера пользователю не нужно обновлять ключ вручную
- **Удобство** - достаточно один раз добавить подписку в VPN приложение
- **Множественные серверы** - подписка может содержать несколько серверов

## Использование в коде

### Получение subscription link

```python
from shop_bot.modules import xui_api

subscription_link = await xui_api.get_client_subscription_link(
    host_name="serv1",
    client_email="user123-key1@serv1.bot"
)
```

### Отправка сообщения с ключом/подпиской

```python
from shop_bot.config import get_purchase_success_text

final_text = get_purchase_success_text(
    action="создан",
    key_number=1,
    expiry_date=datetime.now(),
    connection_string="vless://...",  # Опционально
    subscription_link="https://...",   # Опционально
    provision_mode="both"              # 'key', 'subscription', 'both'
)
```

## Миграция существующих тарифов

При обновлении системы все существующие тарифы автоматически получают режим `'key'` (только ключ), что соответствует текущему поведению.

## См. также

- [Архитектура системы](architecture-rules.md)
- [Работа с 3x-ui API](modules.md)
- [База данных](database.md)

