# –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ Dark Maximus

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 19.01.2025 12:45

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
- [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
- [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è-–ø—Ä–æ–≥—Ä–∞–º–º–∞)
- [–ù–∞—Å—Ç—Ä–æ–π–∫–∏](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
- [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
- [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
- [API —Ñ—É–Ω–∫—Ü–∏–∏](#api-—Ñ—É–Ω–∫—Ü–∏–∏)
- [–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è](#–∏–∑–≤–µ—Å—Ç–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã-–∏-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

## –û–±–∑–æ—Ä

–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ Dark Maximus –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞—Ç—å –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ —Å –∫–∞–∂–¥–æ–π –∏—Ö –ø–æ–∫—É–ø–∫–∏. –°–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è:

- **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏** - —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥—Ä—É–∑–µ–π
- **–°–∫–∏–¥–∫–∏ –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤** - —Å–∫–∏–¥–∫–∞ –Ω–∞ –ø–µ—Ä–≤—É—é –ø–æ–∫—É–ø–∫—É –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã** - –ø—Ä–æ—Ü–µ–Ω—Ç —Å –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
- **–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ –≤–∏–¥–∞:
```
https://t.me/BOT_USERNAME?start=ref_USER_ID
```

–°–∏—Å—Ç–µ–º–∞:
1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç ID —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `ref_USER_ID`
2. –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `referred_by = USER_ID` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. –°–≤—è–∑—å –º–µ–∂–¥—É —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–º –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞

**–ö–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:**
```python
# src/shop_bot/bot/handlers.py:493-500
potential_referrer_id = int(command.args.split('_')[1])
if potential_referrer_id != user_id:
    referrer_id = potential_referrer_id
    logger.info(f"New user {user_id} was referred by {referrer_id}")

register_user_if_not_exists(user_id, username, referrer_id, message.from_user.full_name)
```

### 2. –°–∫–∏–¥–∫–∞ –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–µ

–ü—Ä–∏ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–µ (–∫–æ–≥–¥–∞ `total_spent == 0`) —Ä–µ—Ñ–µ—Ä–∞–ª –ø–æ–ª—É—á–∞–µ—Ç —Å–∫–∏–¥–∫—É:

**–†–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏:** –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `referral_discount` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5%)

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏:**
```python
# src/shop_bot/bot/handlers.py:2599-2611
if user_data.get('referred_by') and user_data.get('total_spent', 0) == 0:
    discount_percentage_str = get_setting("referral_discount") or "0"
    discount_percentage = Decimal(discount_percentage_str)
    
    if discount_percentage > 0:
        discount_amount = (price * discount_percentage / 100).quantize(Decimal("0.01"))
        final_price = price - discount_amount
```

**–í–∞–∂–Ω–æ:** –°–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ - –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–µ.

### 3. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞

–ü—Ä–∏ –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ (–≤–∫–ª—é—á–∞—è –ø–µ—Ä–≤—É—é) —Ä–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Å—É–º–º—ã –ø–æ–∫—É–ø–∫–∏:

**–†–∞–∑–º–µ—Ä –±–æ–Ω—É—Å–∞:** –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `referral_percentage` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10%)

**–†–∞—Å—á–µ—Ç –±–æ–Ω—É—Å–∞:**
```python
# src/shop_bot/bot/handlers.py:4795-4812
if referrer_id:
    percentage = Decimal(get_setting("referral_percentage") or "0")
    
    reward = (Decimal(str(price)) * percentage / 100).quantize(Decimal("0.01"))
    
    if float(reward) > 0:
        add_to_referral_balance(referrer_id, float(reward))
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ—Ä—É
        try:
            buyer_username = user_data.get('username', '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')
            await bot.send_message(
                referrer_id,
                f"üéâ –í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª @{buyer_username} —Å–æ–≤–µ—Ä—à–∏–ª –ø–æ–∫—É–ø–∫—É –Ω–∞ —Å—É–º–º—É {price:.2f} RUB!\n"
                f"üí∞ –ù–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å –Ω–∞—á–∏—Å–ª–µ–Ω–æ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ: {reward:.2f} RUB."
            )
        except Exception as e:
            logger.warning(f"Could not send referral reward notification to {referrer_id}: {e}")
```

**–í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ë–æ–Ω—É—Å –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π —Å—É–º–º—ã (—Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Å–∫–∏–¥–æ–∫ –∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤)
- –ë–æ–Ω—É—Å –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
- –†–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª–∞

### 4. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å

–£ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –¥–≤–∞ –±–∞–ª–∞–Ω—Å–∞:
- `referral_balance` - —Ç–µ–∫—É—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –≤—ã–≤–æ–¥–∞
- `referral_balance_all` - –æ–±—â–∏–π –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å (–¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ:**
–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å" —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –ï—Å–ª–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, —Å—Ç—Ä–æ–∫–∞ —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è.

**–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ:**
```python
# src/shop_bot/data_manager/database.py:2706-2720
def add_to_referral_balance(user_id: int, amount: float):
    try:
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()
            cursor.execute("UPDATE users SET referral_balance = referral_balance + ? WHERE telegram_id = ?", 
                         (amount, user_id))
            conn.commit()
    except sqlite3.Error as e:
        logging.error(f"Failed to add to referral balance for user {user_id}: {e}")
```

### 5. –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤

**–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞:** 100 RUB (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `minimum_withdrawal`)

**–ü—Ä–æ—Ü–µ—Å—Å –≤—ã–≤–æ–¥–∞:**

#### –®–∞–≥ 1: –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –≤—ã–≤–æ–¥–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "üí∏ –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥" –∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–±:
- üì± –ü–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ **(–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)**
- üí≥ –ü–æ –Ω–æ–º–µ—Ä—É –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã

#### –®–∞–≥ 2: –í—ã–±–æ—Ä –±–∞–Ω–∫–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ç–µ–ª–µ—Ñ–æ–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –±–∞–Ω–∫ –∏–∑ —Å–ø–∏—Å–∫–∞:
- üè¶ –°–±–µ—Ä–±–∞–Ω–∫
- üè¶ –í–¢–ë
- üè¶ –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫
- üè¶ –¢–∏–Ω—å–∫–æ—Ñ—Ñ
- üè¶ –ì–∞–∑–ø—Ä–æ–º–±–∞–Ω–∫
- üè¶ –†–∞–π—Ñ—Ñ–∞–π–∑–µ–Ω–±–∞–Ω–∫
- üè¶ –î—Ä—É–≥–æ–π –±–∞–Ω–∫

**–í–∞–∂–Ω–æ:** –ö–æ–º–∏—Å—Å–∏—è –±–∞–Ω–∫–∞ (–¥–æ 50 —Ä—É–±–ª–µ–π) –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞–º–∏.

#### –®–∞–≥ 3: –í–≤–æ–¥ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
–í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–ø–æ—Å–æ–±–∞:
- **–î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞:** –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Ñ–æ—Ä–º–∞—Ç: +7XXXXXXXXXX)
- **–î–ª—è –∫–∞—Ä—Ç—ã:** –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã (—Ñ–æ—Ä–º–∞—Ç: XXXX XXXX XXXX XXXX)

#### –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏
–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å inline-–∫–Ω–æ–ø–∫–∞–º–∏ "‚úÖ –û–¥–æ–±—Ä–∏—Ç—å" –∏ "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å"

#### –®–∞–≥ 5: –û–¥–æ–±—Ä–µ–Ω–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏.

**–ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏:**
1. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å"
2. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
3. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–≤–æ–¥–∏—Ç –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–û—à–∏–±–∫–∞ –≤ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞—Ö", "–í—ã—Å–æ–∫–∞—è –∫–æ–º–∏—Å—Å–∏—è –±–∞–Ω–∫–∞")
4. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∏ –∏ –ø—Ä–∏—á–∏–Ω–æ–π –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
5. –ó–∞—è–≤–∫–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω–∞—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—Ä–∏—á–∏–Ω—ã

**–ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø—Ä–∏—á–∏–Ω—ã:**
```
üìù –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏

–î–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @username
üí∞ –°—É–º–º–∞: 250.00 RUB
üì± –°–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞: –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
üè¶ –ë–∞–Ω–∫: –°–±–µ—Ä–±–∞–Ω–∫
üì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +79991234567

–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏. –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
```

**–ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏:**
```
‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞

–î–∞–Ω–Ω—ã–µ –≤–∞—à–µ–π –∑–∞—è–≤–∫–∏:
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @username
üí∞ –°—É–º–º–∞: 250.00 RUB
üì± –°–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞: –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
üè¶ –ë–∞–Ω–∫: –°–±–µ—Ä–±–∞–Ω–∫
üì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +79991234567

‚ö†Ô∏è –ü—Ä–∏—á–∏–Ω–∞: –û—à–∏–±–∫–∞ –≤ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞—Ö
–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.
```

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω):**
```
üí∏ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @username (ID: 12345)
üí∞ –°—É–º–º–∞: 250.00 RUB
üì± –°–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞: –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
üè¶ –ë–∞–Ω–∫: –°–±–µ—Ä–±–∞–Ω–∫
üì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +79991234567
```

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∫–∞—Ä—Ç–∞):**
```
üí∏ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @username (ID: 12345)
üí∞ –°—É–º–º–∞: 250.00 RUB
üí≥ –°–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞: –ø–æ –Ω–æ–º–µ—Ä—É –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã
üí≥ –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: 1234 5678 9012 3456
```

**–û–¥–æ–±—Ä–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É:**
```python
# src/shop_bot/bot/handlers.py:1597-1640
@user_router.callback_query(F.data.startswith("approve_withdraw_"))
async def approve_withdraw_callback(callback: types.CallbackQuery):
    user_id = int(callback.data.split("_")[-1])
    user = get_user(user_id)
    balance = user.get('referral_balance', 0)
    
    set_referral_balance(user_id, 0)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞—è–≤–∫–æ–π
    await callback.message.edit_text(
        f"‚úÖ <b>–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞</b>\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.get('username', 'N/A')} (ID: <code>{user_id}</code>)\n"
        f"üí∞ –í—ã–ø–ª–∞—á–µ–Ω–æ: <b>{balance:.2f} RUB</b>",
        parse_mode="HTML"
    )
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await callback.bot.send_message(
        user_id,
        f"‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ {balance:.2f} RUB –æ–¥–æ–±—Ä–µ–Ω–∞. –î–µ–Ω—å–≥–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
    )
```

**–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É:**
```python
# src/shop_bot/bot/handlers.py:1813-1844
@user_router.callback_query(F.data.startswith("decline_withdraw_"))
async def decline_withdraw_callback(callback: types.CallbackQuery, state: FSMContext):
    user_id = int(callback.data.split("_")[-1])
    user = get_user(user_id)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º user_id –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    await state.update_data(decline_user_id=user_id, decline_message_id=callback.message.message_id)
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
    await callback.message.edit_text(
        f"üìù <b>–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏</b>\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.get('username', 'N/A')} (ID: <code>{user_id}</code>)\n\n"
        f"–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏. –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.",
        parse_mode="HTML"
    )
    
    await state.set_state(DeclineWithdrawStates.waiting_for_decline_reason)
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:**
```python
# src/shop_bot/bot/handlers.py:1894-1984
@user_router.message(DeclineWithdrawStates.waiting_for_decline_reason)
async def decline_withdraw_reason_handler(message: types.Message, state: FSMContext):
    data = await state.get_data()
    user_id = data.get('decline_user_id')
    reason = message.text
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    username = data.get('decline_username', user.get('username', 'N/A'))
    amount = data.get('decline_amount', '0.00')
    method_text = data.get('decline_method_text', '–Ω–µ —É–∫–∞–∑–∞–Ω')
    bank_name = data.get('decline_bank_name')
    details = data.get('decline_details')
    method_icon = data.get('decline_method_icon', 'üí≥')
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∏
    user_message = (
        f"‚ùå <b>–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞</b>\n\n"
        f"<b>–î–∞–Ω–Ω—ã–µ –≤–∞—à–µ–π –∑–∞—è–≤–∫–∏:</b>\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{username}\n"
        f"üí∞ –°—É–º–º–∞: {amount} RUB\n"
        f"{method_icon} –°–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞: {method_text}"
    )
    
    if bank_name:
        user_message += f"\nüè¶ –ë–∞–Ω–∫: {bank_name}"
    
    if details:
        if method_icon == "üì±":
            user_message += f"\nüì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: {details}"
        else:
            user_message += f"\nüí≥ –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: {details}"
    
    user_message += f"\n\n‚ö†Ô∏è <b>–ü—Ä–∏—á–∏–Ω–∞:</b> {reason}\n\n"
    user_message += "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await message.bot.send_message(user_id, user_message, parse_mode="HTML")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞—è–≤–∫–æ–π
    await message.bot.edit_message_text(
        f"‚ùå <b>–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞</b>\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {username} (ID: <code>{user_id}</code>)\n\n"
        f"üìù <b>–ü—Ä–∏—á–∏–Ω–∞:</b> {reason}",
        chat_id=admin_id,
        message_id=message_id,
        parse_mode="HTML"
    )
    
    await state.clear()
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML:**
–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML-—Å—É—â–Ω–æ—Å—Ç–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞—Ö), —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```python
# src/shop_bot/bot/handlers.py:1544-1564
try:
    await message.bot.send_message(admin_id, text, parse_mode="HTML", reply_markup=keyboard)
except TelegramBadRequest as e:
    error_msg = str(e)
    if "can't parse entities" in error_msg or "unsupported start tag" in error_msg:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        text_plain = (
            f"üí∏ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{username} (ID: {user_id})\n"
            f"üí∞ –°—É–º–º–∞: {balance:.2f} RUB\n"
            f"üìÑ –†–µ–∫–≤–∏–∑–∏—Ç—ã: {details}"
        )
        await message.bot.send_message(admin_id, text_plain, reply_markup=keyboard)
```

**–í–∞–∂–Ω–æ:** 
- –ü—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –≤—ã–≤–æ–¥–∞ `referral_balance` –æ–±–Ω—É–ª—è–µ—Ç—Å—è, –∞ `referral_balance_all` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è (–¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
- –ö–æ–º–∞–Ω–¥—ã `/approve_withdraw` –∏ `/decline_withdraw` –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —Ä–∞–±–æ—Ç–∞—é—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞—è–≤–∫–æ–π –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç–∞—Ç—É—Å–µ

### 6. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É:
```
https://t.me/BOT_USERNAME?start=ref_USER_ID
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏:**
```python
# src/shop_bot/bot/handlers.py:1127
bot_username = (await message.bot.get_me()).username
referral_link = f"https://t.me/{bot_username}?start=ref_{user_id}"
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `settings`:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|----------|----------|----------------------|
| `enable_referrals` | –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É | `true` |
| `referral_percentage` | –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –ø–æ–∫—É–ø–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –¥–ª—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ | `10` |
| `referral_discount` | –°–∫–∏–¥–∫–∞ –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –Ω–∞ –ø–µ—Ä–≤—É—é –ø–æ–∫—É–ø–∫—É (%) | `5` |
| `minimum_withdrawal` | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ (RUB) | `100` |

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
```python
# src/shop_bot/data_manager/database.py:394-400
"enable_referrals": "true",
"referral_percentage": "10",
"referral_discount": "5",
"minimum_withdrawal": "100",
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ                       ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è   ‚îÇ      ‚îÇ   –ü–æ–∫—É–ø–∫–∞    ‚îÇ
        ‚îÇ   –ø–æ —Å—Å—ã–ª–∫–µ    ‚îÇ      ‚îÇ  —Ä–µ—Ñ–µ—Ä–∞–ª–∞    ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ                      ‚îÇ
                ‚îÇ                      ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ    ‚îÇ      ‚îÇ  –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ  ‚îÇ
        ‚îÇ  referred_by   ‚îÇ      ‚îÇ    –±–æ–Ω—É—Å–∞    ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                       ‚îÇ
                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚îÇ  –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ    ‚îÇ
                              ‚îÇ    —Ä–µ—Ñ–µ—Ä–µ—Ä–∞     ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**
   ```
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /start ref_12345 ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ referred_by=12345
   ```

2. **–ü–æ–∫—É–ø–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞:**
   ```
   –†–µ—Ñ–µ—Ä–∞–ª –ø–æ–∫—É–ø–∞–µ—Ç ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ referred_by ‚Üí –†–∞—Å—á–µ—Ç –±–æ–Ω—É—Å–∞ ‚Üí 
   –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞ referral_balance ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
   ```

3. **–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤:**
   ```
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ ‚Üí –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ‚Üí –û–¥–æ–±—Ä–µ–Ω–∏–µ ‚Üí 
   –û–±–Ω—É–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `users`

```sql
CREATE TABLE users (
    telegram_id INTEGER PRIMARY KEY,
    username TEXT,
    referred_by INTEGER,              -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≥–ª–∞—Å–∏–ª
    referral_balance REAL DEFAULT 0,   -- –¢–µ–∫—É—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å
    referral_balance_all REAL DEFAULT 0, -- –û–±—â–∏–π –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å
    total_spent REAL DEFAULT 0,        -- –û–±—â–∞—è —Å—É–º–º–∞ –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
    ...
);
```

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_users_referred_by ON users(referred_by);
```

### –¢–∞–±–ª–∏—Ü–∞ `settings`

```sql
CREATE TABLE settings (
    key TEXT PRIMARY KEY,
    value TEXT
);
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã:**
```sql
INSERT INTO settings (key, value) VALUES 
    ('enable_referrals', 'true'),
    ('referral_percentage', '10'),
    ('referral_discount', '5'),
    ('minimum_withdrawal', '100');
```

## API —Ñ—É–Ω–∫—Ü–∏–∏

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤

```python
def get_referral_count(user_id: int) -> int:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    cursor.execute("SELECT COUNT(*) FROM users WHERE referred_by = ?", (user_id,))
    return cursor.fetchone()[0] or 0
```

### –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞

```python
def add_to_referral_balance(user_id: int, amount: float):
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Å—É–º–º—É –Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    cursor.execute("UPDATE users SET referral_balance = referral_balance + ? WHERE telegram_id = ?", 
                  (amount, user_id))
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞

```python
def set_referral_balance(user_id: int, value: float):
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å"""
    cursor.execute("UPDATE users SET referral_balance = ? WHERE telegram_id = ?", 
                  (value, user_id))
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—â–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞

```python
def set_referral_balance_all(user_id: int, value: float):
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—â–∏–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å"""
    cursor.execute("UPDATE users SET referral_balance_all = ? WHERE telegram_id = ?", 
                  (value, user_id))
```

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç 19.01.2025 12:00

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–∫–∞–∑–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏.

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å" –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å—É–º–º–∞, —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞, –±–∞–Ω–∫, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã)
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω —É–∫–∞–∑–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
- –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –≤–∏–¥–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∏
- –í —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å –∑–∞—è–≤–∫–æ–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏—á–∏–Ω–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
- –£–ª—É—á—à–µ–Ω UX: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏—á–∏–Ω–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –∏ –≤–∏–¥–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–≤–æ–µ–π –∑–∞—è–≤–∫–∏

**–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:**
- "–û—à–∏–±–∫–∞ –≤ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞—Ö"
- "–í—ã—Å–æ–∫–∞—è –∫–æ–º–∏—Å—Å–∏—è –±–∞–Ω–∫–∞"
- "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
- "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã"

**–ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø—Ä–∏—á–∏–Ω—ã:**
```
üìù –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏

–î–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @username
üí∞ –°—É–º–º–∞: 250.00 RUB
üì± –°–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞: –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
üè¶ –ë–∞–Ω–∫: –°–±–µ—Ä–±–∞–Ω–∫
üì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +79991234567

–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏. –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
```

**–ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏:**
```
‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞

–î–∞–Ω–Ω—ã–µ –≤–∞—à–µ–π –∑–∞—è–≤–∫–∏:
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @username
üí∞ –°—É–º–º–∞: 250.00 RUB
üì± –°–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞: –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
üè¶ –ë–∞–Ω–∫: –°–±–µ—Ä–±–∞–Ω–∫
üì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +79991234567

‚ö†Ô∏è –ü—Ä–∏—á–∏–Ω–∞: –û—à–∏–±–∫–∞ –≤ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞—Ö
–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.
```

**–ö–æ–¥:**
```python
# src/shop_bot/bot/handlers.py:141-142
class DeclineWithdrawStates(StatesGroup):
    waiting_for_decline_reason = State()
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏—á–∏–Ω—ã:**
```python
# src/shop_bot/bot/handlers.py:1813-1892
@user_router.callback_query(F.data.startswith("decline_withdraw_"))
async def decline_withdraw_callback(callback: types.CallbackQuery, state: FSMContext):
    user_id = int(callback.data.split("_")[-1])
    user = get_user(user_id)
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    message_text = callback.message.text or callback.message.caption or ""
    
    # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    username_match = re.search(r'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @?([^\s]+)', message_text)
    amount_match = re.search(r'üí∞ –°—É–º–º–∞: ([0-9.]+) RUB', message_text)
    method_match = re.search(r'üì± –°–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞: ([^\n]+)', message_text)
    bank_match = re.search(r'üè¶ –ë–∞–Ω–∫: ([^\n]+)', message_text)
    phone_match = re.search(r'üì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: ([^\n]+)', message_text)
    card_match = re.search(r'üí≥ –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: ([^\n]+)', message_text)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.update_data(
        decline_user_id=user_id,
        decline_message_id=callback.message.message_id,
        decline_username=username,
        decline_amount=amount,
        decline_method_text=method_text,
        decline_bank_name=bank_name,
        decline_details=details,
        decline_method_icon=method_icon
    )
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∏
    request_text = (
        f"üìù <b>–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏</b>\n\n"
        f"<b>–î–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</b>\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{username}\n"
        f"üí∞ –°—É–º–º–∞: {amount} RUB\n"
        f"{method_icon} –°–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞: {method_text}"
    )
    
    if bank_name:
        request_text += f"\nüè¶ –ë–∞–Ω–∫: {bank_name}"
    
    if phone:
        request_text += f"\nüì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: {phone}"
    elif card:
        request_text += f"\nüí≥ –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: {card}"
    
    request_text += "\n\n–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏. –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."
    
    await callback.message.edit_text(request_text, parse_mode="HTML")
    await state.set_state(DeclineWithdrawStates.waiting_for_decline_reason)
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏ —Ñ–æ—Ç–æ):**
```python
# src/shop_bot/bot/handlers.py:1913-2029
@user_router.message(DeclineWithdrawStates.waiting_for_decline_reason)
async def decline_withdraw_reason_handler(message: types.Message, state: FSMContext):
    data = await state.get_data()
    user_id = data.get('decline_user_id')
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–∏—á–∏–Ω—ã (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –≤ –ø–æ–¥–ø–∏—Å–∏ –∫ —Ñ–æ—Ç–æ)
    reason = message.text or message.caption or ""
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å —Ç–µ–∫—Å—Ç–æ–º
    if message.photo:
        photo = message.photo[-1]
        await message.bot.send_photo(
            user_id,
            photo.file_id,
            caption=user_message,
            parse_mode="HTML"
        )
    else:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
        await message.bot.send_message(
            user_id,
            user_message,
            parse_mode="HTML"
        )
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞—è–≤–∫–æ–π
    decline_status = f"üìù <b>–ü—Ä–∏—á–∏–Ω–∞:</b> {reason}"
    if message.photo:
        decline_status += " (—Å–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º)"
    
    await message.bot.edit_message_text(
        f"‚ùå <b>–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞</b>\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {username} (ID: <code>{user_id}</code>)\n\n"
        f"{decline_status}",
        chat_id=admin_id,
        message_id=message_id,
        parse_mode="HTML"
    )
    
    await state.clear()
```

**–ù–æ–≤–æ–µ:** –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–æ—Ç–æ (—Å–∫—Ä–∏–Ω—à–æ—Ç –æ—à–∏–±–∫–∏) –≤–º–µ—Å—Ç–µ —Å —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è. –§–æ—Ç–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–º–µ—Å—Ç–µ —Å –ø—Ä–∏—á–∏–Ω–æ–π.

**–§–∞–π–ª—ã:** `src/shop_bot/bot/handlers.py`

### –£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç 14.10.2025 00:12

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –£–ª—É—á—à–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ —Å –≤—ã–±–æ—Ä–æ–º –±–∞–Ω–∫–∞.

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–µ—Ç–∫–∞ "(–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)" –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- –î–æ–±–∞–≤–ª–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π —à–∞–≥ –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω
- –°–æ–∑–¥–∞–Ω —Å–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –±–∞–Ω–∫–æ–≤: –°–±–µ—Ä–±–∞–Ω–∫, –í–¢–ë, –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫, –¢–∏–Ω—å–∫–æ—Ñ—Ñ, –ì–∞–∑–ø—Ä–æ–º–±–∞–Ω–∫, –†–∞–π—Ñ—Ñ–∞–π–∑–µ–Ω–±–∞–Ω–∫, –î—Ä—É–≥–æ–π –±–∞–Ω–∫
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–∏—Å—Å–∏–∏ –±–∞–Ω–∫–∞ (–¥–æ 50 —Ä—É–±–ª–µ–π), –∫–æ—Ç–æ—Ä–∞—è –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞–º–∏
- –í –∑–∞—è–≤–∫–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Ç–µ–ø–µ—Ä—å –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –±–∞–Ω–∫ –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- –î–ª—è –≤—ã–≤–æ–¥–∞ –Ω–∞ –∫–∞—Ä—Ç—É –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ "–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã"
- –£–ª—É—á—à–µ–Ω UX: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–∫ –ø–µ—Ä–µ–¥ –≤–≤–æ–¥–æ–º –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞

**–ö–æ–¥ –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–∞:**
```python
# src/shop_bot/bot/handlers.py:1535-1571
if method == "phone":
    text = (
        "üè¶ <b>–í—ã–±–æ—Ä –±–∞–Ω–∫–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω –ø–µ—Ä–µ–≤–æ–¥.\n\n"
        "üí° <i>–ö–æ–º–∏—Å—Å–∏—è –±–∞–Ω–∫–∞ (–¥–æ 50 —Ä—É–±–ª–µ–π) –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞–º–∏.</i>"
    )
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ –±–∞–Ω–∫–∞–º–∏
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üè¶ –°–±–µ—Ä–±–∞–Ω–∫", callback_data="bank_sberbank")
        ],
        [
            InlineKeyboardButton(text="üè¶ –í–¢–ë", callback_data="bank_vtb")
        ],
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–∞–Ω–∫–∏
    ])
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –±–∞–Ω–∫–∞:**
```python
# src/shop_bot/bot/handlers.py:1582-1613
@user_router.callback_query(WithdrawStates.waiting_for_bank, F.data.startswith("bank_"))
@registration_required
async def withdraw_bank_handler(callback: types.CallbackQuery, state: FSMContext):
    bank_key = callback.data.replace("bank_", "")
    bank_names = {
        "sberbank": "–°–±–µ—Ä–±–∞–Ω–∫",
        "vtb": "–í–¢–ë",
        "alfabank": "–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫",
        "tinkoff": "–¢–∏–Ω—å–∫–æ—Ñ—Ñ",
        "gazprombank": "–ì–∞–∑–ø—Ä–æ–º–±–∞–Ω–∫",
        "raiffeisenbank": "–†–∞–π—Ñ—Ñ–∞–π–∑–µ–Ω–±–∞–Ω–∫",
        "other": "–î—Ä—É–≥–æ–π –±–∞–Ω–∫"
    }
    bank_name = bank_names.get(bank_key, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –±–∞–Ω–∫")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–∫ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.update_data(bank_name=bank_name)
    
    # –ü—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    text = (
        "üì± <b>–í–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</b>\n\n"
        f"–í—ã–±—Ä–∞–Ω –±–∞–Ω–∫: <b>{bank_name}</b>\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞.\n\n"
        "–§–æ—Ä–º–∞—Ç: +7XXXXXXXXXX"
    )
```

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ —Å –±–∞–Ω–∫–æ–º:**
```python
# src/shop_bot/bot/handlers.py:1648-1667
if method == "phone" and bank_name:
    # –î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–∫ –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    text = (
        f"üí∏ <b>–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</b>\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{username_safe} (ID: <code>{user_id}</code>)\n"
        f"üí∞ –°—É–º–º–∞: <b>{balance:.2f} RUB</b>\n"
        f"{method_icon} –°–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞: <b>{method_text}</b>\n"
        f"üè¶ –ë–∞–Ω–∫: <b>{bank_name}</b>\n"
        f"üì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: <code>{details_safe}</code>"
    )
```

**–§–∞–π–ª—ã:** `src/shop_bot/bot/handlers.py`

### –£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç 14.10.2025 00:05

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ –≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ.

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- –ü–µ—Ä–µ–¥ –≤–≤–æ–¥–æ–º —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏
- –î–æ—Å—Ç—É–ø–Ω—ã –¥–≤–∞ —Å–ø–æ—Å–æ–±–∞: "üì± –ü–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞" –∏ "üí≥ –ü–æ –Ω–æ–º–µ—Ä—É –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã"
- –í—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∑–∞—è–≤–∫–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ —Å–ø–æ—Å–æ–±–∞ –≤—ã–≤–æ–¥–∞ (üì± –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞, üí≥ –¥–ª—è –∫–∞—Ä—Ç—ã) –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∞–¥–º–∏–Ω—É
- –£–ª—É—á—à–µ–Ω UX: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ñ–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–ø–æ—Å–æ–±–∞

**–ö–æ–¥:**
```python
# src/shop_bot/bot/handlers.py:1495-1519
@user_router.callback_query(F.data == "withdraw_request")
@registration_required
async def withdraw_request_handler(callback: types.CallbackQuery, state: FSMContext):
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –≤—ã–≤–æ–¥–∞
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üì± –ü–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞", callback_data="withdraw_method_phone")
        ],
        [
            InlineKeyboardButton(text="üí≥ –ü–æ –Ω–æ–º–µ—Ä—É –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã", callback_data="withdraw_method_card")
        ],
        [
            InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="show_referral_program")
        ]
    ])
    
    await callback.message.edit_text(
        "üí∏ <b>–í—ã–≤–æ–¥ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤:",
        reply_markup=keyboard,
        parse_mode="HTML"
    )
    await state.set_state(WithdrawStates.waiting_for_payment_method)
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞:**
```python
# src/shop_bot/bot/handlers.py:1521-1548
@user_router.callback_query(WithdrawStates.waiting_for_payment_method, F.data.in_(["withdraw_method_phone", "withdraw_method_card"]))
@registration_required
async def withdraw_method_handler(callback: types.CallbackQuery, state: FSMContext):
    method = "phone" if callback.data == "withdraw_method_phone" else "card"
    method_text = "–ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞" if method == "phone" else "–ø–æ –Ω–æ–º–µ—Ä—É –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.update_data(withdrawal_method=method, withdrawal_method_text=method_text)
    
    # –ü—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
    if method == "phone":
        text = (
            "üì± <b>–í—ã–≤–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞</b>\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –±–∞–Ω–∫ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞.\n\n"
            "–§–æ—Ä–º–∞—Ç: +7XXXXXXXXXX, –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞"
        )
    else:
        text = (
            "üí≥ <b>–í—ã–≤–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã</b>\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞.\n\n"
            "–§–æ—Ä–º–∞—Ç: XXXX XXXX XXXX XXXX"
        )
    
    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(WithdrawStates.waiting_for_details)
```

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞ –≤—ã–≤–æ–¥–∞ –≤ –∑–∞—è–≤–∫–µ:**
```python
# src/shop_bot/bot/handlers.py:1550-1588
# –ü–æ–ª—É—á–∞–µ–º —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
data = await state.get_data()
method = data.get('withdrawal_method', 'unknown')
method_text = data.get('withdrawal_method_text', '–Ω–µ —É–∫–∞–∑–∞–Ω')

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ø–æ—Å–æ–±–∞ –≤—ã–≤–æ–¥–∞
method_icon = "üì±" if method == "phone" else "üí≥"

text = (
    f"üí∏ <b>–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</b>\n"
    f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{username_safe} (ID: <code>{user_id}</code>)\n"
    f"üí∞ –°—É–º–º–∞: <b>{balance:.2f} RUB</b>\n"
    f"{method_icon} –°–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞: <b>{method_text}</b>\n"
    f"üìÑ –†–µ–∫–≤–∏–∑–∏—Ç—ã: <code>{details_safe}</code>"
)
```

**–§–∞–π–ª—ã:** `src/shop_bot/bot/handlers.py`

### –£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç 14.10.2025 00:01

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –Ω–∞ inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥.

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- –í–º–µ—Å—Ç–æ –∫–æ–º–∞–Ω–¥ `/approve_withdraw {user_id}` –∏ `/decline_withdraw {user_id}` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è inline-–∫–Ω–æ–ø–∫–∏
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–Ω–æ–ø–∫–∏ "‚úÖ –û–¥–æ–±—Ä–∏—Ç—å" –∏ "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å" –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å –∑–∞—è–≤–∫–æ–π
- –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç–∞—Ç—É—Å–µ –∑–∞—è–≤–∫–∏
- –£–ª—É—á—à–µ–Ω UX: –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã

**–ö–æ–¥:**
```python
# src/shop_bot/bot/handlers.py:1534-1540
keyboard = InlineKeyboardMarkup(inline_keyboard=[
    [
        InlineKeyboardButton(text="‚úÖ –û–¥–æ–±—Ä–∏—Ç—å", callback_data=f"approve_withdraw_{user_id}"),
        InlineKeyboardButton(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"decline_withdraw_{user_id}")
    ]
])
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML:**
–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML-—Å—É—â–Ω–æ—Å—Ç–µ–π:
- –ü—Ä–∏ –æ—à–∏–±–∫–µ "can't parse entities" —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –±–µ–∑ HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –û—à–∏–±–∫–∞ "unsupported start tag" —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π HTML-—Ç–µ–≥ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏"

**–§–∞–π–ª—ã:** `src/shop_bot/bot/handlers.py`, `src/shop_bot/utils/error_handler.py`

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç 09.01.2025

**–ü—Ä–æ–±–ª–µ–º–∞:** –í —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä—É –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è username –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –≤–º–µ—Å—Ç–æ username —Ä–µ—Ñ–µ—Ä–∞–ª–∞.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ:
referrer_username = user_data.get('username', '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')

# –°—Ç–∞–ª–æ:
buyer_username = user_data.get('username', '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')
```

**–§–∞–π–ª:** `src/shop_bot/bot/handlers.py:4804`

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A (ID: 12345) ‚Üí –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞: https://t.me/bot?start=ref_12345
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B ‚Üí –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí referred_by = 12345
```

### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–∫—É–ø–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B (—Ä–µ—Ñ–µ—Ä–∞–ª) ‚Üí –ü–æ–∫—É–ø–∞–µ—Ç —Ç–∞—Ä–∏—Ñ –∑–∞ 1000 RUB
‚Üí –°–∫–∏–¥–∫–∞ 5% = 50 RUB ‚Üí –§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ = 950 RUB
‚Üí –†–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç 10% –æ—Ç 950 RUB = 95 RUB
‚Üí –†–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "–í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª @username —Å–æ–≤–µ—Ä—à–∏–ª –ø–æ–∫—É–ø–∫—É –Ω–∞ —Å—É–º–º—É 950.00 RUB! –ù–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å –Ω–∞—á–∏—Å–ª–µ–Ω–æ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ: 95.00 RUB."
```

### –ü—Ä–∏–º–µ—Ä 3: –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤

```
–†–µ—Ñ–µ—Ä–µ—Ä ‚Üí –ë–∞–ª–∞–Ω—Å: 250 RUB ‚Üí –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ ‚Üí –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ‚Üí –û–¥–æ–±—Ä–µ–Ω–∏–µ
‚Üí –ë–∞–ª–∞–Ω—Å –æ–±–Ω—É–ª–µ–Ω ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ 250.00 RUB –æ–¥–æ–±—Ä–µ–Ω–∞."
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
2. **–ú–æ–¥–µ—Ä–∞—Ü–∏—è:** –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ –ø–µ—Ä–µ–¥ –æ–¥–æ–±—Ä–µ–Ω–∏–µ–º
3. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–µ—Ñ–µ—Ä–µ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–∫—É–ø–∫–∞—Ö
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ

## –£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç 19.01.2025 12:45

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥.

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ (—Å–∫—Ä–∏–Ω—à–æ—Ç –æ—à–∏–±–∫–∏) –≤–º–µ—Å—Ç–µ —Å —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
- –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–º–µ—Å—Ç–µ —Å –ø—Ä–∏—á–∏–Ω–æ–π –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏
- –û–±–Ω–æ–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å" –≤ –∑–∞—è–≤–∫–µ –Ω–∞ –≤—ã–≤–æ–¥
2. –í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–º –ò–õ–ò –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—à–∏–±–∫–∏)
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏—á–∏–Ω–æ–π –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–∏ —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ)

**–ö–æ–¥:**
```python
# src/shop_bot/bot/handlers.py:1913-2029
@user_router.message(DeclineWithdrawStates.waiting_for_decline_reason)
async def decline_withdraw_reason_handler(message: types.Message, state: FSMContext):
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–∏—á–∏–Ω—ã (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –≤ –ø–æ–¥–ø–∏—Å–∏ –∫ —Ñ–æ—Ç–æ)
    reason = message.text or message.caption or ""
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å —Ç–µ–∫—Å—Ç–æ–º
    if message.photo:
        photo = message.photo[-1]
        await message.bot.send_photo(
            user_id,
            photo.file_id,
            caption=user_message,
            parse_mode="HTML"
        )
    else:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
        await message.bot.send_message(
            user_id,
            user_message,
            parse_mode="HTML"
        )
```

**–§–∞–π–ª—ã:** `src/shop_bot/bot/handlers.py`

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `settings`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ä–µ—Ñ–µ—Ä–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞:** 19.01.2025 12:00  
**–í–µ—Ä—Å–∏—è:** 1.4.0

