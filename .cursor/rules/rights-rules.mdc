---
alwaysApply: true
---
- Не предполагай, руководствуйся только фактами, если нужно проведи исследования и тесты, чтобы подтвердить гепотизы.
- Ничего не ломай при правках кода или внедрении нового функционала, всегда используй безопасные режимы
- Не усложняй код, используй лучшие практики (best practice) в разработке, тестировании и внедрении
- Никогда не изменяй логины, пароли и токены у существующих сервисов без явного разрешения.
- Никогда не меняй сетевые порты существующих сервисов без согласования даже если они заблокированы.   Если сервис работает на порту 1488 — ты не можешь изменить его на 1489 самостоятельно.
- **Управление настройками окружения:**
  - **`ENVIRONMENT` в `.env`** — используется ТОЛЬКО для тестов:
    - Определяет, запускать ли продакшн-специфичные тесты
    - Значения: `production` (включить продакшн-тесты) или `development`/`test` (отключить)
    - НЕ используется в основном коде приложения
    - См. подробности в `testing-rules.mdc`
  - **`server_environment` в БД (настройка "Тип сервера" в панели)** — используется в основном коде:
    - Управляется через веб-панель: `/settings` → раздел "Глобальные параметры" → "Тип сервера"
    - Хранится в таблице `bot_settings` в БД
    - Используется через функцию `get_server_environment()` из `database.py`
    - Влияет на выбор доменов для сервисов (production использует настроенные домены, development — localhost)
    - Для изменения используй веб-панель, НЕ редактируй `.env`
  - **Важно:** Эти две настройки независимы и служат разным целям. Не путай их!
- Для тестирования веб-интерфейсов используй **Chrome DevTools** через MCP. 
- Для тестирования API и проверки HTTP-запросов используй **fetch-mcp** через MCP:
  - Проверка статуса сервисов:
    - localhost:50000 — веб-панель (bot)
    - localhost:50001 — пользовательская документация (docs-proxy)
    - localhost:50002 — админская документация (codex-docs)
    - localhost:50003 — личный кабинет (user-cabinet)
    - localhost:50004 — Allure Service
    - localhost:50005 — Allure Homepage
  - Тестирование эндпоинтов веб-панели
  - Отладка HTTP-запросов и ответов
  - ⚠️ **Безопасность**: fetch-mcp может получать доступ к локальным IP-адресам, используй осторожно
- **Приоритет источников данных для авторизации:**
  - **Для логинов и паролей всех сервисов авторизации** (веб-панель, docs-proxy, allure-homepage):
    1. **Сначала проверяй БД** — используй `get_setting("panel_login")` и `get_setting("panel_password")` из таблицы `bot_settings`
    2. **Затем проверяй `.env`** — используй переменные окружения `PANEL_LOGIN` и `PANEL_PASSWORD` только как fallback, если данные отсутствуют в БД
  - **Важно:** БД является основным источником истины. Переменные окружения используются только для:
    - Первоначальной настройки (если БД пуста)
    - Тестирования (для изоляции тестов от продакшн БД)
    - Аварийного доступа (если БД недоступна)
  - **При изменении логина/пароля:** всегда обновляй через веб-панель (`/settings`), что автоматически сохранит изменения в БД. НЕ редактируй `.env` для изменения учетных данных в продакшне.
- После завершения задачи проверь нужно ли обновлять документацию в Diátaxis, и если нужно обнови ее
- После внедрения или обновления существующего функционала проверь есть ли автотест или автотесты покрывающие данную функциональность:
* Если есть, то проанализируй нужно ли ее обновлять. Если нужно, обнови
* Если нет и это новый функционал, то предложи создать такой тест
