<!-- 3928fc1a-2561-47da-af95-7783b6c68b01 b439b899-0975-45e5-964d-d27a8a2be857 -->
# План исправления зависаний кнопок оплаты

1. Анализ текущей FSM

- Проверить обработчики `pay_*` и `back_to_plans` в `src/shop_bot/bot/handlers.py`.
- Зафиксировать где вызывается `state.clear()` до отправки ссылки на оплату.

2. Коррекция состояний оплаты

- Добавить состояние ожидания оплаты (`waiting_for_payment_link`) в `PaymentProcess` и аналог для `TopupProcess`.
- В обработчиках `pay_yookassa`, `pay_cryptobot`, `pay_heleket`, `pay_tonconnect` и топап-методах вместо `state.clear()` переводить FSM в новое состояние, сохраняя контекст.

3. Возврат к тарифам без зависаний

- Расширить `back_to_plans_handler`, чтобы он срабатывал в новом состоянии и вызывал `callback.answer()`.
- Добавить безопасный ответ для callbacks с пустым состоянием (алерт об устаревшей сессии).
- Убедиться, что клавиатуры после возврата корректно восстанавливаются.

4. Проверка и документация

- Протестировать сценарий покупки и пополнения: выбор тарифа → оплата → возврат назад.
- Обновить `CHANGELOG.md` и версию в `pyproject.toml`.

### To-dos

- [ ] Проверить обработчики оплаты и точки state.clear
- [ ] Добавить новые состояния и сохранить контекст оплаты
- [ ] Расширить обработчик back_to_plans и fallback
- [ ] Проверить сценарии и обновить changelog/версию