<!-- a1d558fc-f3bb-4657-9d27-4ef53a6442b8 63766234-ce1b-4652-9b7b-2e39eed90138 -->
# Миграция тестов на использование тестовой БД

## Этап 1: Реализация умного копирования БД в conftest.py

**Файл:** `tests/conftest.py`

**Задачи:**

1. Добавить импорты: `shutil`, `logging`, `time`, `datetime`, `timedelta`
2. Определить константы:

   - `TEST_DB_PATH = project_root / "temp_db.db"` (постоянный путь)
   - `PRODUCTION_DB_PATH = project_root / "users.db"`
   - `CACHE_TIMEOUT_MINUTES = 5`

3. Реализовать функции:

   - `should_recreate_test_db()` - проверяет возраст файла temp_db.db (> 5 минут = пересоздать)
   - `copy_production_db_to_test_db(force=False)` - копирует реальную БД с проверкой целостности

4. Создать session-scope фикстуру `test_db_session()`:

   - При полном запуске всех тестов: принудительно копирует БД (force=True)
   - Логирует все действия с эмодзи для читаемости

5. Обновить фикстуру `temp_db()`:

   - Зависит от `test_db_session`
   - При запуске одного теста: проверяет время создания БД
   - Если БД устарела или не существует - пересоздает
   - Использует `TEST_DB_PATH` вместо `tmp_path / "test_users.db"`
   - Убрать создание структуры таблиц (БД уже скопирована)
   - Убрать вызов `copy_templates_from_production_db()` (шаблоны уже в скопированной БД)

**Критерии успеха:**

- При полном запуске тестов БД копируется один раз
- При запуске одного теста проверяется время создания
- Логирование всех действий работает
- Проверка целостности БД после копирования

## Этап 2: Удаление избыточных установок database.DB_FILE

**Файлы для исправления:**

- `tests/integration/test_user_cabinet/test_cabinet_flow.py` (6 мест)
- `tests/integration/test_auto_renewal/test_notification_buttons_flow.py` (6 мест)
- `tests/integration/test_payments/test_balance_flow.py` (2 места)
- `tests/integration/test_payments/test_cryptobot_flow.py` (2 места)
- `tests/integration/test_referral/test_referral_flow.py` (4 места)
- `tests/integration/test_vpn_purchase/test_full_purchase_flow.py` (6 мест)
- `tests/integration/test_vpn_purchase/test_key_extension_flow.py` (3 места)
- `tests/integration/test_payments/test_yookassa_flow.py` (2 места)
- `tests/integration/test_vpn_purchase/test_promo_code_application.py` (4 места)
- `tests/unit/test_user_cabinet/test_cabinet.py` (6 мест)
- `tests/unit/test_utils/test_message_templates.py` (3 места)
- `tests/unit/test_utils/test_template_validation.py` (4 места)

**Задачи:**

1. Найти все места с паттерном:
   ```python
   original_db_file = database.DB_FILE
   database.DB_FILE = temp_db
   try:
       # тест
   finally:
       database.DB_FILE = original_db_file
   ```

2. Удалить эти блоки - фикстура `temp_db` уже делает monkeypatch автоматически
3. Оставить только параметр `temp_db` в сигнатуре функции теста

**Критерии успеха:**

- Все избыточные установки `database.DB_FILE` удалены
- Тесты продолжают работать корректно
- Код стал проще и чище

## Этап 3: Исправление тестов с собственной БД

**Файлы для исправления:**

- `tests/unit/test_database/test_auto_renewal.py` - создает свою БД в `tmp_path`
- `tests/unit/test_database/test_locks.py` - создает свою БД в `tmp_path`
- `tests/unit/test_database/test_notifications.py` - создает свою БД в `tmp_path`
- `tests/unit/test_database/test_key_numbering.py` - использует `db_module.DB_FILE` напрямую
- `tests/integration/test_timezone_integration.py` - создает свою БД и использует `patch`

**Задачи:**

1. Заменить создание собственной БД на использование фикстуры `temp_db`
2. Убрать ручные установки `database.DB_FILE` или `db_module.DB_FILE`
3. Использовать `database.DB_FILE` (уже заменен через monkeypatch) вместо прямых путей

**Критерии успеха:**

- Все тесты используют фикстуру `temp_db`
- Нет создания собственных БД в тестах
- Все тесты работают с единой тестовой БД

## Этап 4: Проверка и исправление прямых обращений к users.db

**Задачи:**

1. Найти все места с паттернами:

   - `sqlite3.connect('users.db')`
   - `sqlite3.connect("users.db")`
   - `Path('users.db')`
   - `'users.db'` в строках

2. Заменить на использование `database.DB_FILE` (уже заменен через monkeypatch)
3. Проверить файл `tests/unit/test_database/test_referral_operations.py`:

   - Функция `set_setting()` использует `database.DB_FILE` - это правильно
   - Убедиться, что нет прямых обращений к `users.db`

**Критерии успеха:**

- Нет прямых обращений к `users.db` в тестах
- Все подключения используют `database.DB_FILE`
- Тесты работают с тестовой БД

## Этап 5: Тестирование и валидация

**Задачи:**

1. Запустить все тесты и убедиться, что они проходят
2. Проверить логирование копирования БД
3. Проверить, что при запуске одного теста БД пересоздается если устарела
4. Проверить, что при полном запуске БД копируется один раз
5. Убедиться, что реальная БД `users.db` не изменяется тестами

**Критерии успеха:**

- Все тесты проходят
- Логирование работает корректно
- БД копируется по правилам (полный запуск = один раз, один тест = проверка времени)
- Реальная БД не изменяется

### To-dos

- [ ] Реализовать умное копирование БД в conftest.py: добавить функции should_recreate_test_db() и copy_production_db_to_test_db(), создать session-scope фикстуру test_db_session(), обновить temp_db() для использования TEST_DB_PATH
- [ ] Удалить избыточные установки database.DB_FILE в тестах (35+ мест в integration и unit тестах)
- [ ] Исправить тесты с собственной БД: test_auto_renewal.py, test_locks.py, test_notifications.py, test_key_numbering.py, test_timezone_integration.py
- [ ] Проверить и исправить прямые обращения к users.db, заменить на database.DB_FILE
- [ ] Протестировать: запустить все тесты, проверить логирование, убедиться что реальная БД не изменяется