<!-- ccae613c-c79e-4c2f-aad2-0f553e400c8a 2e836ed5-f1fd-433e-bbd7-0e87628cb2d4 -->
# Диагностика и решение TelegramConflictError

## Проблема

Ошибка `TelegramConflictError: Conflict: terminated by other getUpdates request` возникает, когда несколько экземпляров бота пытаются использовать метод `getUpdates` одновременно с одним и тем же токеном.

## Анализ проблемы

### Что обнаружено:

1. **Текущая реализация**:

- Бот использует polling через `dp.start_polling(bot, polling_timeout=10)`
- Автозапуск бота при старте приложения (`__main__.py`)
- Возможность запуска бота через веб-панель (`/start-shop-bot`)
- Проверка `if self.shop_is_running` защищает только от повторного запуска в том же процессе

2. **Проблема защиты**:

- Проверка `shop_is_running` работает только в рамках одного процесса Python
- Не защищает от запуска бота из другого процесса/контейнера/сервера
- При перезапуске контейнера старый процесс polling может все еще работать

3. **Возможные причины конфликта**:

- Бот запущен на другом сервере/машине с тем же токеном
- Бот был запущен ранее и не был корректно остановлен
- Бот запущен локально (вне Docker) одновременно с Docker контейнером
- Контейнер был перезапущен, но старый процесс polling все еще работает

## План решения

### Этап 1: Диагностика

1. **Проверить наличие других экземпляров бота**:

- Проверить логи контейнера на наличие сообщений о запуске/остановке бота
- Проверить, нет ли других процессов Python, запускающих бота
- Проверить, нет ли других контейнеров с тем же токеном

2. **Проверить состояние webhook**:

- Использовать Telegram Bot API для проверки, установлен ли webhook
- Если webhook установлен, удалить его перед использованием polling

3. **Проверить логи на наличие повторных запусков**:

- Найти в логах все сообщения о запуске бота
- Проверить, не было ли попыток запуска бота через веб-панель одновременно с автозапуском

### Этап 2: Улучшение защиты от конфликтов

1. **Добавить проверку webhook перед запуском polling**:

- Перед запуском polling проверить, не установлен ли webhook
- Если webhook установлен, удалить его или выдать предупреждение

2. **Улучшить обработку ошибки TelegramConflictError**:

- Добавить специальную обработку этой ошибки в `_start_polling`
- При обнаружении конфликта попытаться остановить старый экземпляр или выдать понятное сообщение

3. **Добавить проверку состояния бота через Telegram API**:

- Перед запуском polling проверить состояние бота через `get_webhook_info`
- Если бот уже получает обновления, не запускать новый экземпляр

### Этап 3: Документация

1. **Создать документацию по диагностике проблемы**:

- Описать причины возникновения конфликта
- Предоставить инструкции по диагностике
- Предоставить инструкции по решению проблемы

## Файлы для изменения

- `src/shop_bot/bot_controller.py` - добавить проверку webhook и улучшить обработку ошибок
- `docs/guides/troubleshooting/telegram-conflict-error.md` - создать документацию по диагностике и решению проблемы

## Приоритет

Высокий - ошибка блокирует работу бота и требует немедленного решения.

### To-dos

- [ ] Провести диагностику: проверить логи, процессы, состояние webhook и наличие других экземпляров бота
- [ ] Добавить проверку webhook перед запуском polling в bot_controller.py
- [ ] Улучшить обработку TelegramConflictError в методе _start_polling
- [ ] Добавить проверку состояния бота через get_webhook_info перед запуском polling
- [ ] Создать документацию по диагностике и решению проблемы TelegramConflictError