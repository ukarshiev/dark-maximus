<!-- 9259fab1-627d-491c-b7ff-3db1204598c4 f4dca0a3-1946-45df-b058-527b167261cd -->
# План исправления падающих тестов базы данных

## Анализ проблем

### 1. test_key_numbering (TestKeyOperations)

**Проблема:** Функция `create_key_with_stats_atomic` не обновляет `keys_count` в таблице `users`, хотя `get_next_key_number` использует этот счетчик для нумерации ключей.

**Решение:** Добавить обновление `keys_count` в функцию `create_key_with_stats_atomic` при создании ключа.

**Файл:** `src/shop_bot/data_manager/database.py` (функция `create_key_with_stats_atomic`, строка ~6424)

### 2. test_token_deletion_on_key_deletion (TestCabinetLinks)

**Проблема:** Тест проверяет, что токен НЕ удаляется при удалении ключа через `delete_key_by_email`. Функция корректно не удаляет токен, но возможно проблема в тесте или в логике проверки.

**Решение:** Проверить логику теста и убедиться, что функция `delete_key_by_email` действительно не удаляет токены (уже реализовано правильно).

**Файл:** `tests/unit/test_database/test_cabinet_links.py` (тест `test_token_deletion_on_key_deletion`, строка ~216)

### 3. test_display_mode_hidden_old_hidden_from_old_users (TestPlanDisplayMode)

**Проблема:** Функция `get_user_used_plans_batch` извлекает `plan_id` из `metadata` транзакций со статусом 'paid'. Тест создает транзакцию с `plan_id` в metadata, но возможно проблема в формате данных или логике извлечения.

**Решение:** Проверить формат `metadata` в тесте и убедиться, что `plan_id` корректно извлекается функцией `get_user_used_plans_batch`.

**Файл:** `tests/unit/test_database/test_plan_display_mode.py` (тест `test_display_mode_hidden_old_hidden_from_old_users`, строка ~271)

### 4. test_trial_eligibility_check и test_trial_reuse_logic (test_trial_operations)

**Проблема:** Тесты проверяют логику триала, но возможно проблема в том, как функции работают с флагами `trial_used`, `trial_reuses_count`.

**Решение:** Проверить логику функций `get_trial_info`, `set_trial_used`, `reset_trial_used`, `increment_trial_reuses` и убедиться, что они корректно работают с флагами триала.

**Файл:** `tests/unit/test_database/test_trial_operations.py` (тесты `test_trial_eligibility_check` и `test_trial_reuse_logic`, строки ~48 и ~189)

## Шаги исправления

1. **Исправить обновление keys_count в create_key_with_stats_atomic:**

- Добавить вызов `get_next_key_number(user_id)` перед созданием ключа или обновить `keys_count` после создания ключа
- Убедиться, что счетчик инкрементируется атомарно в той же транзакции

2. **Проверить и исправить test_token_deletion_on_key_deletion:**

- Убедиться, что тест корректно проверяет сохранение токена после удаления ключа
- Проверить, что функция `delete_key_by_email` действительно не удаляет токены

3. **Проверить и исправить test_display_mode_hidden_old_hidden_from_old_users:**

- Убедиться, что формат `metadata` в тесте соответствует ожидаемому формату (JSON с ключом `plan_id`)
- Проверить, что функция `get_user_used_plans_batch` корректно извлекает `plan_id` из `metadata`

4. **Проверить и исправить тесты триала:**

- Убедиться, что функции триала корректно работают с флагами
- Проверить логику определения возможности получения триала

5. **Запустить тесты и проверить результаты в Allure:**

- Запустить все 5 тестов через `docker compose exec autotest pytest`
- Проверить отчеты в Allure для детального анализа ошибок
- Исправить найденные проблемы на основе фактических ошибок из отчетов

## Приоритет исправлений

1. **Высокий:** test_key_numbering (критично для нумерации ключей)
2. **Высокий:** test_display_mode_hidden_old_hidden_from_old_users (критично для фильтрации планов)
3. **Средний:** test_token_deletion_on_key_deletion (важно для личного кабинета)
4. **Средний:** test_trial_eligibility_check и test_trial_reuse_logic (важно для логики триала)

### To-dos

- [ ] Добавить обновление keys_count в функцию create_key_with_stats_atomic при создании ключа
- [ ] Проверить и исправить тест test_token_deletion_on_key_deletion - убедиться, что токен не удаляется при удалении ключа
- [ ] Проверить и исправить тест test_display_mode_hidden_old_hidden_from_old_users - убедиться, что plan_id корректно извлекается из metadata транзакций
- [ ] Проверить и исправить тесты test_trial_eligibility_check и test_trial_reuse_logic - убедиться, что функции триала корректно работают с флагами
- [ ] Запустить все 5 тестов и проверить отчеты в Allure для детального анализа ошибок