<!-- 659709ad-76f0-48f0-bce3-011414b75eff 0bb58ce4-0cf5-4396-ad3b-ef4edf344c61 -->
# Отключение WAL режима SQLite

## Цель

Отключить WAL режим SQLite для решения проблемы потери данных при рестарте Docker контейнера. WAL файлы не монтируются с хоста и теряются при рестарте, что приводит к восстановлению старых данных.

## Обоснование

- WAL файлы создаются только в контейнере и не монтируются с хоста
- При рестарте контейнера WAL файлы теряются
- Изменения остаются в WAL и не применяются к основной базе
- Для одного процесса и невысокой нагрузки DELETE режим достаточен
- DELETE режим гарантирует немедленную запись в основную базу

## Изменения в коде

### 1. `src/shop_bot/data_manager/database.py`

**Всего мест: 16**

#### Основная инициализация (строка 341)

- Заменить: `cursor.execute("PRAGMA journal_mode=WAL")`
- На: `cursor.execute("PRAGMA journal_mode=DELETE")`
- Обновить комментарий строка 338: "Установка режима журналирования и оптимизационных PRAGMA"
- Обновить лог строка 345: "Database PRAGMA settings configured (journal mode: DELETE)"

#### Миграция (строка 1194)

- Заменить: `cursor.execute("PRAGMA journal_mode=WAL")`
- На: `cursor.execute("PRAGMA journal_mode=DELETE")`

#### Функции с WAL (строки 3795, 4167, 4298, 4488, 5171, 5415, 5486, 5545, 6322, 6361, 6520, 6667, 7412, 8457)

- Заменить все: `cursor.execute("PRAGMA journal_mode=WAL")`
- На: `cursor.execute("PRAGMA journal_mode=DELETE")`
- Удалить комментарии про WAL режим (если есть)

#### Удалить checkpoint (строка 2806)

- Удалить строки:
  ```python
  cursor.execute("PRAGMA wal_checkpoint(FULL)")
  conn.commit()
  ```

- Оставить только основной `conn.commit()` (строка 2802)

### 2. `src/shop_bot/data_manager/scheduler.py`

**Всего мест: 2**

#### Строки 347 и 379

- Заменить: `cursor.execute("PRAGMA journal_mode=WAL")`
- На: `cursor.execute("PRAGMA journal_mode=DELETE")`

### 3. `src/shop_bot/data_manager/async_database.py`

**Всего мест: 1**

#### Строка 52

- Заменить: `await conn.execute("PRAGMA journal_mode=WAL")`
- На: `await conn.execute("PRAGMA journal_mode=DELETE")`

### 4. `src/shop_bot/webhook_server/app.py`

**Удалить checkpoint (строка 1187)**

- Удалить строки:
  ```python
  cursor.execute("PRAGMA wal_checkpoint(FULL)")
  conn.commit()
  ```


### 5. `src/shop_bot/data_manager/backup.py`

**Оставить checkpoint в try-except (строка 100)**

- Оставить как есть - checkpoint в try-except обрабатывает ошибку, если режим не WAL
- Можно оставить комментарий: "На случай WAL — сделаем чекпойнт; игнорируем ошибку, если режим не WAL"

## Обновление документации

### 6. `docs/reference/database.md`

**Строка 32-33:**

- Заменить: "**Режим журналирования**: WAL (Write-Ahead Logging)"
- На: "**Режим журналирования**: DELETE (стандартный режим)"
- Удалить или обновить упоминания WAL файлов

**Строки 801-844 (раздел про WAL файлы):**

- Обновить или удалить раздел, указав что WAL отключен

## Итого изменений

- **Замен `journal_mode=WAL`**: 22 места
  - database.py: 16 мест
  - scheduler.py: 2 места
  - async_database.py: 1 место
- **Удаление `wal_checkpoint`**: 2 места
  - database.py: 1 место (строка 2806)
  - app.py: 1 место (строка 1187)
- **Обновление комментариев**: ~5 мест
- **Обновление документации**: 1 файл

## Тестирование

1. Создать новый тариф через админ-панель
2. Удалить старый тариф
3. Проверить, что файл `users.db` на хосте обновился (по времени модификации)
4. Перезапустить контейнер: `docker restart dark-maximus-bot`
5. Проверить, что изменения сохранились (новый тариф есть, старый удалён)
6. Проверить, что нет файлов `users.db-wal` и `users.db-shm` в контейнере
7. Проверить работу всех функций: создание/удаление/обновление тарифов, хостов, промокодов и т.д.

## Важные замечания по безопасности

### Критичные моменты

1. **`update_setting()` (строка 2806)** - есть проверка после checkpoint:

   - Удалить checkpoint (строки 2804-2807)
   - **ОСТАВИТЬ проверку** (строки 2809-2813) - она важна для валидации
   - Проверка должна остаться после `conn.commit()` (строка 2802)

2. **`backup.py` (строка 100)** - checkpoint в try-except:

   - **ОСТАВИТЬ как есть** - он обрабатывает ошибку, если режим не WAL
   - Это безопасно и не сломает бекапы

3. **Порядок изменений:**

   - Сначала заменить все `journal_mode=WAL` на `journal_mode=DELETE`
   - Потом удалить `wal_checkpoint` (кроме backup.py)
   - Проверить, что нет ошибок компиляции
   - Протестировать основные функции

4. **Проверка после каждого изменения:**

   - Убедиться, что синтаксис корректен
   - Проверить, что логика не нарушена
   - Не удалять важные проверки и валидации

### После отключения WAL

- Все изменения будут сразу записываться в основную базу
- WAL файлы автоматически удалятся при следующем подключении к БД
- Если есть старые WAL файлы - они будут проигнорированы
- Производительность может немного снизиться при очень высокой нагрузке, но для текущего случая это не критично
- Блокировки при записи будут немного дольше, но для одного процесса это не проблема