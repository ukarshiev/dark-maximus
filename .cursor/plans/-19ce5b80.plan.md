<!-- 19ce5b80-a7df-4ece-b3f4-eff1efded84d 95c3d67c-caa9-472f-a8e4-57fe5b9f8afa -->
# Исправление недоступности сервиса bot для тестов в Docker сети

## Проблема

Тест `test_session_persistence` пропускается на боевом сервере с сообщением:

```
Skipped: Сервис webhook_server недоступен: http://bot:50000/login
```

Тест `test_login_failure_no_errors` пропускается из-за rate limit (это нормальное поведение, не требует исправления).

## Причина (подтверждено диагностикой на боевом сервере)

**Факты:**

1. Тесты запускаются через `docker compose exec autotest pytest` (внутри Docker контейнера `autotest`)
2. Все сервисы доступны через Docker имена: `bot:50000`, `docs-proxy:50001`, `allure-homepage:50005` (Status: 200)
3. Функция `_is_docker_environment()` возвращает `False` (неправильно)
4. Функция `_get_service_host("webhook_server")` возвращает `localhost` вместо `bot`
5. Файл `/.dockerenv` существует в контейнере `autotest` (стандартный способ определения Docker)

**Корневая причина:**

Функция `_is_docker_environment()` в `tests/integration/test_auth_all_services/conftest.py` проверяет `/proc/1/cgroup` на наличие слова "docker", но в современных версиях Docker (cgroup v2) это не работает — файл содержит `0::/` без слова "docker". Функция не проверяет файл `/.dockerenv`, который является стандартным способом определения Docker контейнера.

**Последствия:**

1. Из-за `is_docker = False` функция `_get_service_host()` возвращает `localhost` вместо имен Docker сервисов
2. Когда тесты пытаются подключиться к `http://localhost:50000/login` из контейнера `autotest`, они подключаются к самому контейнеру `autotest`, а не к контейнеру `bot`
3. Контейнер `autotest` не слушает на порту 50000, поэтому подключение не удается
4. Функция `check_service_available()` возвращает `False`, и тесты пропускаются

## Решение

### Исправить функцию `_is_docker_environment()`

**Файл:** `tests/integration/test_auth_all_services/conftest.py`

Добавить проверку файла `/.dockerenv` как основной способ определения Docker окружения. Этот файл создается Docker автоматически во всех контейнерах и является стандартным способом определения Docker окружения.

## Шаги реализации

1. **Исправить функцию `_is_docker_environment()` в `conftest.py`:**

   - Добавить проверку файла `/.dockerenv` как первый и основной способ определения Docker
   - Оставить проверку `/proc/1/cgroup` как fallback для старых версий Docker
   - Оставить проверку `HOSTNAME` как дополнительный fallback

2. **Протестировать исправление на боевом сервере:**

   - Запустить тесты: `docker compose exec autotest pytest tests/integration/test_auth_all_services/test_login_integration.py::TestAuthAllServices::test_session_persistence -v`
   - Проверить, что `_is_docker_environment()` возвращает `True`
   - Проверить, что `_get_service_host("webhook_server")` возвращает `bot` вместо `localhost`
   - Проверить, что тест выполняется, а не пропускается

## Ожидаемый результат

1. Функция `_is_docker_environment()` корректно определяет Docker окружение через файл `/.dockerenv`
2. Функция `_get_service_host()` возвращает правильные имена Docker сервисов (`bot`, `docs-proxy`, `allure-homepage`) вместо `localhost`
3. Тесты подключаются к сервисам через Docker сеть по правильным адресам
4. Тест `test_session_persistence` выполняется на боевом сервере, а не пропускается

### To-dos

- [ ] Добавить expose: - '50000' для сервиса bot в docker-compose.yml
- [ ] Проверить и добавить expose для docs-proxy (50001) и allure-homepage (50005) если отсутствует
- [ ] Протестировать на боевом сервере: перезапустить контейнеры и запустить тесты