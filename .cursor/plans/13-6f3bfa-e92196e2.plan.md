<!-- e92196e2-d2b4-49ae-bcd9-69537ee31696 8edd2df9-9130-4dc5-9c45-4c0f08b0c066 -->
# План устранения конфликтующих уведомлений

1. Привести ключи к актуальному тарифу

- Проверить в `vpn_keys` наличие ключей с `plan_name`, отсутствующим в `plans` для соответствующего `host_name`.
- Для ключа 128 скорректировать `plan_name` на «№3» либо добавить соответствующий тариф в `plans`, чтобы `is_plan_available` возвращал `True`.
- Убедиться, что операция не нарушает историю и не ломает цены/параметры.

2. Усилить проверку в `/create-notification`

- В обработчике `create_notification_route` повторно вызывать `_get_plan_info_for_key` (или аналогичную функцию) и, если тариф скрыт, выдавать предупреждение и блокировать отправку.
- Логировать причину отказа, чтобы администратор видел, почему уведомление не ушло.

3. Синхронизировать логирование уведомлений

- Проверить путь к БД в `log_notification` и `_marker_logged`, чтобы записи гарантированно попадали в ту же базу.
- После фикса убедиться, что метка `subscription_plan_unavailable` фиксируется в таблице `notifications`, исключая повторные отправки.

### To-dos

- [ ] Актуализировать названия тарифов ключей и/или планы, чтобы _get_plan_info_for_key находил соответствия
- [ ] Добавить в /create-notification проверку доступности тарифа и запрет на отправку конфликтных уведомлений
- [ ] Удостовериться, что log_notification и _marker_logged используют один и тот же файл БД