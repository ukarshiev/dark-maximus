<!-- 993e9f0c-1aed-4fc1-b76a-24c86e694b28 aeff6d12-245f-4549-a402-5e9f77531bfe -->
# Завершение работы по дефектам Allure

## Текущий статус

- Issues созданы: 29 Issues в GitHub (#21-#49)
- Частично исправлено: схема БД для users и transactions (tests/conftest.py)
- Осталось исправить:
- Критичные дефекты покупки VPN-ключа (2 теста)
- Критичные дефекты получения ключа (3 теста)
- Критичный дефект баланса (1 тест)
- Критичные дефекты промокодов (10 тестов) - проблема в схеме БД
- Test defects (14 тестов)

## Этап 1: Исправление схемы БД для промокодов

**Проблема:** В тестовой БД отсутствует колонка `vpn_plan_id` в таблице `promo_codes`

**Файл:** `tests/conftest.py`

**Действия:**

1. Проверить реальную схему таблицы `promo_codes` в `src/shop_bot/data_manager/database.py`
2. Обновить схему в `tests/conftest.py`, добавив недостающие колонки
3. Проверить, какие ещё колонки могут отсутствовать

## Этап 2: Исправление схемы БД для ключей

**Проблема:** Тесты создания ключей падают из-за отсутствия таблиц или колонок

**Файлы:**

- `tests/conftest.py` - схема БД
- `tests/unit/test_database/test_cabinet_links.py` - тесты токенов
- `tests/unit/test_database/test_key_numbering.py` - тесты нумерации ключей

**Действия:**

1. Проверить, какие таблицы/колонки используются в функциях создания ключей
2. Обновить схему в `tests/conftest.py`
3. Убедиться, что таблица `users` доступна в тестах

## Этап 3: Исправление функции get_user_balance

**Проблема:** `test_get_user_balance` падает - баланс не обновляется

**Файл:** `src/shop_bot/data_manager/database.py` (функция `get_user_balance`)

**Действия:**

1. Проверить функцию `get_user_balance` - правильно ли она читает баланс
2. Проверить, используется ли правильный путь к БД в тестах
3. Исправить функцию или тест

## Этап 4: Исправление Test defects

**Проблемы:**

- `test_get_next_key_number` - нет таблицы users
- `test_register_user_twice` - TypeError при обращении к None
- `test_deeplink_parameter_length_limit` - неправильные параметры функции
- Остальные - проблемы в тестах промокодов

**Действия:**

1. Исправить тесты, которые обращаются к несуществующим таблицам
2. Исправить тесты с неправильными параметрами функций
3. Удалить или исправить устаревшие тесты

## Этап 5: Проверка исправлений

**Действия:**

1. Запустить все тесты: `python -m pytest tests/ --alluredir=allure-results -v`
2. Сгенерировать новый Allure отчёт: `allure generate allure-results -o allure-report --clean --categories allure-categories.json`
3. Экспортировать данные: `python tests/ad-hoc/export_allure_defects.py`
4. Создать новый отчёт: `python tests/ad-hoc/analyze_allure_defects.py`
5. Сравнить количество дефектов до и после исправлений

## Этап 6: Обновление документации

**Файл:** `docs/guides/testing/allure-defects-management.md`

**Действия:**

1. Добавить информацию о исправленных дефектах
2. Обновить статистику
3. Добавить примеры исправлений

## Критерии завершения

- Все критичные дефекты исправлены (22 дефекта)
- Тесты проходят успешно
- Новый Allure отчёт показывает уменьшение количества дефектов
- Документация обновлена

### To-dos

- [ ] Исправить схему БД для промокодов в tests/conftest.py (добавить недостающие колонки)
- [ ] Исправить схему БД для ключей в tests/conftest.py (проверить все необходимые таблицы)
- [ ] Исправить функцию get_user_balance или тест test_get_user_balance
- [ ] Исправить Test defects: test_get_next_key_number, test_register_user_twice, test_deeplink_parameter_length_limit и остальные
- [ ] Запустить все тесты и проверить результаты
- [ ] Сгенерировать новый Allure отчёт с категориями
- [ ] Обновить отчёт о дефектах (экспорт и анализ)
- [ ] Обновить документацию docs/guides/testing/allure-defects-management.md