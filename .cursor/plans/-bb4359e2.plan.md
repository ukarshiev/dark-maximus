<!-- bb4359e2-c9b6-48f3-b4eb-09ffacc9e1ea 8c4670bb-49e6-4b21-82e5-3e4a6371e952 -->
# –ó–∞–ø—Ä–µ—Ç –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Ç—Ä–∏–∞–ª –∫–ª—é—á–µ–π

## –¶–µ–ª—å

–ó–∞–ø—Ä–µ—Ç–∏—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Ç—Ä–∏–∞–ª –∫–ª—é—á–µ–π —á–µ—Ä–µ–∑ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∏ –∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Å—Ä–æ–∫–∞ –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —Ç—Ä–∏–∞–ª –∫–ª—é—á–µ–π.

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ó–∞–ø—Ä–µ—Ç –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è —Ç—Ä–∏–∞–ª –∫–ª—é—á–µ–π

**–§–∞–π–ª:** `src/shop_bot/data_manager/scheduler.py`

–í —Ñ—É–Ω–∫—Ü–∏–∏ `perform_auto_renewals` (—Å—Ç—Ä–æ–∫–∞ 891) –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_trial` –≤ –Ω–∞—á–∞–ª–µ —Ü–∏–∫–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª—é—á–µ–π:

```python
# –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 911 (key_id = key['key_id'])
if key.get('is_trial') == 1:
    logger.debug(f"Auto-renewal skipped for key {key_id}: trial key cannot be renewed")
    continue
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ç—Ä–∏–∞–ª–∞

**–§–∞–π–ª:** `src/shop_bot/data_manager/scheduler.py`

–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é `send_trial_expiry_notification` –ø–æ—Å–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ `send_autorenew_disabled_notice` (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 754):

- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `bot`, `user_id`, `key_id`, `time_left_hours`, `expiry_date`, `status='sent'`
- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: "–í–∞—à –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ {time_text}.\n\nüìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {expiry_str}\n\n–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ–ª—å–∑—è –ø—Ä–æ–¥–ª–∏—Ç—å. –ö—É–ø–∏—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è VPN!"
- –ö–Ω–æ–ø–∫–∏: "üõí –ö—É–ø–∏—Ç—å –Ω–æ–≤—ã–π VPN" (callback: `buy_new_vpn`), "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é" (callback: `back_to_main_menu`)
- –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: `trial_expiry`
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î —á–µ—Ä–µ–∑ `log_notification` —Å `marker_hours`

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∏–∞–ª –∫–ª—é—á–µ–π –≤ check_expiring_subscriptions

**–§–∞–π–ª:** `src/shop_bot/data_manager/scheduler.py`

–í —Ñ—É–Ω–∫—Ü–∏–∏ `check_expiring_subscriptions` (—Å—Ç—Ä–æ–∫–∞ 783) –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_trial` –≤ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞:

- –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 806 (`key_id = key['key_id']`) –¥–æ–±–∞–≤–∏—Ç—å:
  ```python
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–ª—é—á —Ç—Ä–∏–∞–ª –∫–ª—é—á–æ–º
  is_trial = key.get('is_trial') == 1
  if is_trial:
      # –î–ª—è —Ç—Ä–∏–∞–ª –∫–ª—é—á–µ–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      for hours_mark in sorted(NOTIFY_BEFORE_HOURS):
          mark_seconds = hours_mark * 3600
          if total_seconds_left <= mark_seconds:
              if not _marker_logged(user_id, key_id, hours_mark, 'trial_expiry'):
                  try:
                      await send_trial_expiry_notification(bot, user_id, key_id, hours_mark, expiry_date)
                      notified_users.setdefault(user_id, {}).setdefault(key_id, set()).add(hours_mark)
                      logger.info(f"Sent trial expiry notice for user {user_id}, key {key_id}, marker {hours_mark}h")
                  except Exception as e:
                      logger.error(f"Failed to send trial expiry notice: {e}")
              break
      continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç—Ä–∏–∞–ª –∫–ª—é—á–∞
  ```


### 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —Ç—Ä–∏–∞–ª –∫–ª—é—á–µ–π

**–§–∞–π–ª:** `src/shop_bot/data_manager/scheduler.py`

–í —Å–ª–æ–≤–∞—Ä—å `MANUAL_NOTIFICATION_TEMPLATES` (—Å—Ç—Ä–æ–∫–∞ 26) –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω:

```python
"trial_expiry": {
    "code": "trial_expiry",
    "name": "–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞",
    "description": "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –∫—É–ø–∏—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á.",
    "markers": [24, 1],
    "default_marker": 24,
    "supports_force": True,
    "conditions": {
        "require_plan_available": False,
        "require_balance_covers": False,
        "require_autorenew_enabled": False,
        "require_autorenew_disabled": False,
    },
},
```

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ cleanup_duplicate_notifications

**–§–∞–π–ª:** `src/shop_bot/data_manager/scheduler.py`

–í —Ñ—É–Ω–∫—Ü–∏–∏ `cleanup_duplicate_notifications` (—Å—Ç—Ä–æ–∫–∞ 366) –¥–æ–±–∞–≤–∏—Ç—å `'trial_expiry'` –≤ —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ (—Å—Ç—Ä–æ–∫–∞ 412):

```python
WHERE created_date < ? AND type IN ('subscription_plan_unavailable', 'subscription_expiry', 'subscription_autorenew_notice', 'subscription_autorenew_disabled', 'trial_expiry')
```

### 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ–±-–ø–∞–Ω–µ–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–§–∞–π–ª:** `src/shop_bot/webhook_server/app.py`

–ï—Å–ª–∏ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª–∏ –µ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä—É—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–∏–ø–∞ `trial_expiry` –≤ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 4607).

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç—Ä–∏–∞–ª –∫–ª—é—á–∏ –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç—Ä–∏–∞–ª –∫–ª—é—á–∏ –ø–æ–ª—É—á–∞—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–±—ã—á–Ω—ã–µ –∫–ª—é—á–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è (—Å–∏—Å—Ç–µ–º–∞ –º–∞—Ä–∫–µ—Ä–æ–≤)

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

- `src/shop_bot/data_manager/scheduler.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
- `src/shop_bot/webhook_server/app.py` - –≤–µ–±-–ø–∞–Ω–µ–ª—å (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### To-dos

- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É is_trial –≤ perform_auto_renewals –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ —Ç—Ä–∏–∞–ª –∫–ª—é—á–µ–π
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é send_trial_expiry_notification –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ç—Ä–∏–∞–ª–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç—Ä–∏–∞–ª –∫–ª—é—á–µ–π –≤ check_expiring_subscriptions —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω trial_expiry –≤ MANUAL_NOTIFICATION_TEMPLATES
- [ ] –û–±–Ω–æ–≤–∏—Ç—å cleanup_duplicate_notifications –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ç–∏–ø–∞ trial_expiry
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –≤–µ–±-–ø–∞–Ω–µ–ª—å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ç–∏–ø–∞ trial_expiry (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)