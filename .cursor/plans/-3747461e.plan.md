<!-- 3747461e-0862-4294-a163-0182c16b9aaf 603ea6cd-24f1-47d4-8b3c-de3468bc302e -->
# План: Разделение ответственности скриптов деплоя

## Цель

Реализовать разделение ответственности между скриптами установки:

- `install.sh` - только основные сервисы (bot, docs-proxy, codex-docs, user-cabinet)
- `install-autotest.sh` - добавляет сервисы автотестов (autotest, allure-service, allure-homepage) в существующий docker-compose.yml

## Задачи

### 1. Обновить install.sh

**Файл:** `install.sh`

**Изменения:**

1. Заменить сервис `docs` на `docs-proxy` в создаваемом docker-compose.yml

- Удалить сервис `docs` с портом 50001
- Добавить сервис `docs-proxy` с портом 50001 и зависимостью от `docs`
- Добавить сервис `docs` без публикации порта (только expose: 80)

2. Обновить проверки портов

- Изменить проверку порта 50001 с `docs` на `docs-proxy`
- Обновить ожидание готовности сервиса

3. Обновить nginx конфигурацию в install.sh

- Убедиться, что upstream `docs_backend` указывает на правильный порт (50001 для docs-proxy)

**Строки для изменения:**

- Строки 564-579: заменить сервис `docs` на `docs` + `docs-proxy`
- Строки 1084-1089: обновить проверку готовности docs-proxy
- Строки 1200-1204: обновить проверку доступности docs-proxy

### 2. Обновить install-autotest.sh

**Файл:** `install-autotest.sh`

**Изменения:**

1. Удалить проверку наличия сервисов (строки 98-110)

- Вместо проверки и выхода с ошибкой, добавить логику добавления сервисов

2. Добавить функцию безопасного добавления сервисов в docker-compose.yml

- Проверить, существуют ли уже сервисы autotest, allure-service, allure-homepage
- Если не существуют - добавить их перед секцией `networks:`
- Использовать sed для безопасной вставки или Python скрипт для работы с YAML

3. Обновить логику сборки и запуска

- Собирать только те сервисы, которые были добавлены
- Запускать все три сервиса: autotest, allure-service, allure-homepage

4. Обновить проверку портов

- Изменить проверку порта 50005 с allure-service на allure-homepage (так как allure-service на 50004, а allure-homepage на 50005)

**Структура добавляемых сервисов:**

- `autotest` - контейнер для запуска тестов
- `allure-service` - сервис Allure на порту 50004
- `allure-homepage` - веб-интерфейс Allure на порту 50005 с зависимостью от allure-service

### 3. Технические детали реализации

**Подход для добавления сервисов:**

Использовать sed для вставки сервисов перед секцией `networks:`:

1. Проверить наличие каждого сервиса через `grep`
2. Если сервис отсутствует - создать временный файл с определением сервиса
3. Вставить содержимое перед строкой `^networks:`
4. Проверить валидность YAML через `docker compose config`

**Альтернативный подход (если sed окажется ненадежным):**

Использовать Python скрипт для парсинга и модификации YAML:

- Проверить наличие PyYAML или использовать встроенный json/yaml парсер
- Безопасно добавить сервисы в структуру
- Сохранить обратно в файл

### 4. Обновить ssl-install.sh (опционально)

**Файл:** `ssl-install.sh`

**Изменения:**

1. Обновить проверку порта 50001 для docs-proxy вместо docs
2. Добавить получение SSL сертификата для `tests.${MAIN_DOMAIN}` (если используется отдельный домен для Allure)
3. Обновить nginx шаблон для поддержки allure-homepage на порту 50005

### 5. Тестирование

**Проверки:**

1. Запуск `install.sh` создает docker-compose.yml только с основными сервисами
2. Запуск `install-autotest.sh` добавляет сервисы автотестов без конфликтов
3. Повторный запуск `install-autotest.sh` не создает дубликаты
4. Все сервисы корректно запускаются и доступны на правильных портах
5. nginx конфигурация корректно проксирует запросы на все сервисы

## Дополнительные задачи

### 4. Создание директорий для сессий

**Проблема:** В docker-compose.yml используются:

- `sessions-docs` для docs-proxy
- `sessions-allure` для allure-homepage

Но в install.sh создается только `sessions`.

**Решение:**

- В install.sh добавить создание `sessions-docs`
- В install-autotest.sh добавить создание `sessions-allure`

### 5. Файлы и директории для Allure

**Проблема:** allure-service требует:

- `allure-categories.json` (файл)
- `allure-reports` (директория)

Но в install-autotest.sh создаются только `allure-results` и `allure-report`.

**Решение:**

- В install-autotest.sh добавить создание `allure-reports`
- Проверить наличие `allure-categories.json` или создать шаблон

### 6. Проверка наличия apps/allure-homepage

**Проблема:** Перед добавлением сервиса allure-homepage нужно убедиться, что директория существует.

**Решение:**

- В install-autotest.sh добавить проверку наличия `apps/allure-homepage/Dockerfile`

### 7. Обратная совместимость

**Проблема:** Если у пользователя уже есть docker-compose.yml со старым форматом (с docs вместо docs-proxy), нужно обработать миграцию.

**Решение:**

- В install.sh при обнаружении старого формата предложить миграцию или автоматически обновить
- В install-autotest.sh проверять, не конфликтует ли добавляемый сервис с существующими

### 8. Валидация YAML после модификации

**Проблема:** После добавления сервисов нужно проверить валидность docker-compose.yml.

**Решение:**

- В install-autotest.sh после добавления сервисов выполнить `docker compose config` для проверки синтаксиса

### 9. Зависимости между сервисами

**Проблема:** allure-homepage зависит от allure-service через depends_on.

**Решение:**

- При добавлении сервисов учитывать порядок: сначала allure-service, затем allure-homepage

### 10. Исправление проверки портов

**Проблема:** В install-autotest.sh проверяется порт 50005 для allure-service, но на самом деле:

- allure-service на порту 50004
- allure-homepage на порту 50005

**Решение:**

- Исправить проверку порта в install-autotest.sh (проверять 50005 для allure-homepage)

## Файлы для изменения

1. `install.sh` - обновление создания docker-compose.yml, добавление sessions-docs
2. `install-autotest.sh` - добавление логики вставки сервисов, создание директорий, проверки
3. `ssl-install.sh` - обновление проверок портов (опционально)

## Риски и митигация

### Риск 1: Некорректная вставка сервисов может сломать YAML синтаксис

**Механизмы митигации:**

1. **Резервное копирование перед модификацией:**

                        - Создавать backup файл с timestamp перед любыми изменениями
                        - Формат: `docker-compose.yml.backup.YYYYMMDD-HHMMSS`
                        - В install-autotest.sh перед модификацией

2. **Валидация через docker compose config:**

                        - После добавления сервисов выполнять `${DC[@]} config > /dev/null 2>&1`
                        - При ошибке - восстанавливать из резервной копии и выходить с ошибкой

3. **Использование Python для безопасной модификации YAML:**

                        - Если sed окажется ненадежным, использовать Python скрипт с PyYAML
                        - Безопасно парсить, модифицировать и сохранять YAML
                        - Обработка исключений с восстановлением из backup

4. **Проверка синтаксиса YAML перед записью:**

                        - Использовать `yq` если доступен, или Python-yaml для валидации

### Риск 2: Конфликты при повторном запуске install-autotest.sh

**Механизмы митигации:**

1. **Проверка наличия каждого сервиса перед добавлением:**

                        - Функция `service_exists()` проверяет наличие через `grep -q "^  ${service_name}:"`
                        - Проверка для каждого сервиса: autotest, allure-service, allure-homepage

2. **Идемпотентность операции:**

                        - Функция `add_service_if_not_exists()` добавляет сервис только если его нет
                        - Повторный запуск не создает дубликаты

3. **Проверка целостности после добавления:**

                        - После добавления проверять, что сервис действительно добавлен
                        - При ошибке - выходить с сообщением об ошибке

### Риск 3: Несоответствие портов между скриптами

**Механизмы митигации:**

1. **Определение констант портов в начале скриптов:**
   ```bash
   readonly PORT_BOT=50000
   readonly PORT_DOCS_PROXY=50001
   readonly PORT_CODEX_DOCS=50002
   readonly PORT_USER_CABINET=50003
   readonly PORT_ALLURE_SERVICE=50004
   readonly PORT_ALLURE_HOMEPAGE=50005
   ```

2. **Использование констант везде:**

                        - Заменить все хардкоды портов на константы
                        - В проверках, в docker-compose.yml шаблонах, в nginx конфигурациях

3. **Функция проверки порта с константой:**

                        - `check_port(port, service_name)` - универсальная функция проверки
                        - Использовать везде вместо прямых вызовов `nc`

4. **Валидация портов в docker-compose.yml:**

                        - Функция `validate_ports()` проверяет соответствие портов константам
                        - Выполнять после создания/модификации docker-compose.yml

### Риск 4: Отсутствие необходимых директорий и файлов

**Механизмы митигации:**

1. **Функция создания директорий с проверкой:**

                        - `create_directories(dir1, dir2, ...)` - создает директории если их нет
                        - Устанавливает правильные права доступа (755)
                        - В install.sh: logs, backups, sessions, sessions-docs, codex.docs/uploads, codex.docs/db
                        - В install-autotest.sh: allure-results, allure-report, allure-reports, sessions-allure

2. **Проверка наличия файлов перед добавлением сервисов:**

                        - Функция `check_required_files()` проверяет:
                                        - Dockerfile.tests
                                        - apps/allure-homepage/Dockerfile
                        - При отсутствии - выходить с ошибкой и списком отсутствующих файлов

3. **Создание шаблонов файлов, если их нет:**

                        - Проверять наличие `allure-categories.json`
                        - Если отсутствует - создавать шаблон с базовой структурой `{"categories": []}`

4. **Проверка прав доступа:**

                        - После создания директорий устанавливать правильные права
                        - chmod 755 для директорий, chmod 644 для файлов

### Риск 5: Конфликт со старым форматом docker-compose.yml

**Механизмы митигации:**

1. **Определение формата docker-compose.yml:**

                        - Функция `detect_compose_format()` определяет старый/новый формат
                        - Проверяет наличие `docs-proxy` и формат сервиса `docs`
                        - Возвращает "old" или "new"

2. **Автоматическая миграция или предупреждение:**

                        - При обнаружении старого формата создавать резервную копию
                        - Выполнять автоматическую миграцию через Python скрипт
                        - После миграции проверять валидность через `docker compose config`

3. **Функция миграции формата:**

                        - `migrate_compose_format()` использует Python для безопасной миграции
                        - Преобразует docs с портом в docs (expose) + docs-proxy (ports)
                        - Сохраняет все остальные настройки без изменений

4. **Проверка конфликтов в install-autotest.sh:**

                        - Функция `check_conflicts()` проверяет корректность формата перед добавлением
                        - При обнаружении конфликтов - выходить с ошибкой и рекомендацией

## Итоговая структура защиты

1. **Резервное копирование** - перед любыми изменениями docker-compose.yml
2. **Валидация** - через `docker compose config` после всех модификаций
3. **Идемпотентность** - проверка наличия сервисов перед добавлением
4. **Константы портов** - единые значения во всех скриптах
5. **Проверка директорий/файлов** - создание и валидация перед использованием
6. **Автоматическая миграция** - обработка старого формата с проверкой

## Тестирование скриптов установки

### Цель

Обеспечить автоматическую проверку корректности скриптов установки и конфигурационных файлов для предотвращения ошибок в production.

### Подход: Многоуровневое тестирование

#### Уровень 1: Статический анализ

**Инструменты:**

- **ShellCheck** - статический анализ bash скриптов
- **yamllint** - валидация YAML файлов (docker-compose.yml)
- **hadolint** - валидация Dockerfile (опционально)

**Реализация:**

1. Добавить ShellCheck в зависимости проекта или CI/CD
2. Создать скрипт `scripts/validate-scripts.sh` для запуска всех проверок
3. Интегрировать в CI/CD pipeline

#### Уровень 2: Валидационные тесты на Python

**Структура тестов:**

```
tests/
├── scripts/                    # Новый раздел для тестов скриптов
│   ├── __init__.py
│   ├── conftest.py             # Фикстуры для тестов скриптов
│   ├── test_install_validation.py    # Валидация install.sh
│   ├── test_autotest_validation.py   # Валидация install-autotest.sh
│   ├── test_ssl_validation.py         # Валидация ssl-install.sh
│   └── test_docker_compose.py         # Валидация docker-compose.yml
```

**Что тестировать:**

1. **test_docker_compose.py:**

                        - Синтаксис YAML (валидность структуры)
                        - Наличие обязательных сервисов (bot, docs, docs-proxy, codex-docs, user-cabinet)
                        - Корректность портов (соответствие константам)
                        - Наличие networks секции
                        - Корректность volumes маппингов
                        - Отсутствие дубликатов сервисов

2. **test_install_validation.py:**

                        - Проверка создания необходимых директорий
                        - Валидация создаваемого docker-compose.yml
                        - Проверка наличия всех обязательных сервисов
                        - Проверка корректности портов

3. **test_autotest_validation.py:**

                        - Проверка добавления сервисов автотестов
                        - Отсутствие дубликатов при повторном запуске
                        - Корректность структуры добавляемых сервисов
                        - Проверка зависимостей (depends_on)

4. **test_ssl_validation.py:**

                        - Валидация nginx конфигурации
                        - Проверка upstream серверов
                        - Корректность SSL настроек

#### Уровень 3: Интеграция в CI/CD

**GitHub Actions workflow:**

```yaml
# .github/workflows/test-scripts.yml
name: Test Installation Scripts

on:
  pull_request:
    paths:
   - 'install.sh'
   - 'install-autotest.sh'
   - 'ssl-install.sh'
   - 'docker-compose.yml'

jobs:
  validate-scripts:
    runs-on: ubuntu-latest
    steps:
   - uses: actions/checkout@v3
      
   - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck
      
   - name: Run ShellCheck
        run: |
          shellcheck install.sh
          shellcheck install-autotest.sh
          shellcheck ssl-install.sh
      
   - name: Validate docker-compose.yml
        run: docker compose config
      
   - name: Run script validation tests
        run: pytest tests/scripts/ -v
```

### Приоритеты реализации

**Фаза 1 (Критично):**

- Статический анализ через ShellCheck
- Валидация docker-compose.yml через `docker compose config`
- Базовые тесты структуры docker-compose.yml

**Фаза 2 (Важно):**

- Полный набор валидационных тестов на Python
- Интеграция в CI/CD
- Allure отчеты для тестов скриптов

**Фаза 3 (Опционально):**

- BATS тесты для bash функций (если понадобится более глубокое тестирование)
- Интеграционные тесты в Docker контейнере

### To-dos

- [ ] Обновить install.sh: заменить сервис docs на docs + docs-proxy в docker-compose.yml
- [ ] Обновить install.sh: изменить проверки портов с docs на docs-proxy
- [ ] Обновить install.sh: добавить создание директории sessions-docs
- [ ] Обновить install.sh: добавить обработку миграции со старого формата (docs → docs-proxy)
- [ ] Обновить install-autotest.sh: добавить функцию безопасного добавления сервисов в docker-compose.yml
- [ ] Обновить install-autotest.sh: удалить проверки наличия сервисов, заменить на логику добавления
- [ ] Обновить install-autotest.sh: исправить проверку порта 50005 для allure-homepage (не allure-service)
- [ ] Обновить install-autotest.sh: добавить создание директории sessions-allure
- [ ] Обновить install-autotest.sh: добавить создание allure-reports и проверку allure-categories.json
- [ ] Обновить install-autotest.sh: добавить проверку наличия apps/allure-homepage/Dockerfile
- [ ] Обновить install-autotest.sh: добавить валидацию YAML через docker compose config после добавления сервисов
- [ ] Обновить install-autotest.sh: убедиться, что сервисы добавляются в правильном порядке (allure-service перед allure-homepage)
- [ ] Обновить ssl-install.sh: изменить проверки портов для docs-proxy (опционально)
- [ ] Создать структуру тестов: директория tests/scripts/ с __init__.py и conftest.py
- [ ] Создать test_docker_compose.py: валидация синтаксиса, сервисов, портов docker-compose.yml
- [ ] Создать test_install_validation.py: валидация install.sh и создаваемых файлов
- [ ] Создать test_autotest_validation.py: валидация install-autotest.sh и добавления сервисов
- [ ] Создать test_ssl_validation.py: валидация ssl-install.sh и nginx конфигурации
- [ ] Создать scripts/validate-scripts.sh: скрипт для запуска ShellCheck и yamllint
- [ ] Создать .github/workflows/test-scripts.yml: CI/CD для тестирования скриптов установки