<!-- f3c1686f-112d-452a-a85a-b496986d0c14 cd121237-193a-47b6-8eb1-6371cff05e62 -->
# Исправление логаута при обновлении страницы dashboard

## Проблема

При авторизации на `http://localhost:50000/login`, переходе на внешний сайт (личный кабинет через кнопку "Кабинет") и возврате обратно на dashboard, при обновлении страницы (F5 или кнопка "Обновить") происходит логаут и перенаправление на `/login`.

## Обнаруженная причина (подтверждена исследованием)

**Реальная проблема подтверждена:**

1. **Сравнение кода:**

   - В `login_page()` (app.py:414-415): устанавливается `session['logged_in'] = True` и `session.permanent = True`, но **НЕ устанавливается `session.modified = True`**
   - В `verify_and_login()` (auth_utils.py:95-98): устанавливается `session['logged_in'] = True`, `session.permanent = True` **И `session.modified = True`**

2. **Подтверждение из файлов сессий:**

   - Проверка директории `/app/sessions` показала, что некоторые файлы сессий имеют размер 9 байт (почти пустые), а другие - 47 байт с данными `logged_in` и `_permanent`
   - Это подтверждает, что некоторые сессии сохраняются корректно, а некоторые - нет

3. **Подтверждение из документации:**

   - Согласно документации Flask-Session, при изменении данных в сессии необходимо устанавливать `session.modified = True`, чтобы Flask знал о необходимости сохранить изменения
   - Без `session.modified = True` изменения могут не сохраниться, что приводит к потере данных сессии при следующем запросе

4. **Механизм работы Flask-Session:**

   - Flask-Session использует "lazy saving" - сессия сохраняется только если `session.modified = True`
   - При redirect Flask создает новый Response объект, и сессия должна сохраниться автоматически, но только если она помечена как измененная
   - Если `session.modified` не установлен, Flask-Session может не сохранить сессию до следующего запроса, что приводит к потере сессии при обновлении страницы

## Решение

Добавить `session.modified = True` в функцию `login_page()` после установки сессии, чтобы гарантировать сохранение сессии Flask-Session.

## Изменения

### Файл: `src/shop_bot/webhook_server/app.py`

**Строки 413-416:** Добавить `session.modified = True` после установки сессии.

**Было:**

```python
if verify_admin_credentials(username, password):
    session['logged_in'] = True
    session.permanent = True  # Делаем сессию постоянной
    return redirect(url_for('dashboard_page'))
```

**Станет:**

```python
if verify_admin_credentials(username, password):
    session['logged_in'] = True
    session.permanent = True  # Делаем сессию постоянной
    session.modified = True  # Помечаем сессию как измененную для гарантированного сохранения
    return redirect(url_for('dashboard_page'))
```

## Связанная проблема

В файле `src/shop_bot/webhook_server/auth_utils.py` (строка 108) есть проблема с вызовом `save_session(current_app, session, None)` - передача `None` вместо Response вызывает ошибку. Эта проблема уже описана в плане `docs-proxy-c1f469a0.plan.md` и будет исправлена отдельно. Функция `verify_and_login` из `auth_utils.py` не используется в `login_page()` для webhook_server, поэтому эта проблема не влияет на текущий баг.

## Тестирование

После исправления проверить:

1. Авторизация на `http://localhost:50000/login` работает корректно
2. После авторизации сессия сохраняется и работает между запросами
3. Переход на внешний сайт (кнопка "Кабинет") не влияет на сессию
4. Возврат на dashboard и обновление страницы (F5 или кнопка "Обновить") не вызывает логаут
5. Сессия сохраняется после перезапуска контейнера (если сессия была установлена до перезапуска)
6. Логи не содержат ошибок, связанных с сессией

## Дополнительные проверки

- Убедиться, что `SESSION_COOKIE_SAMESITE='Lax'` не блокирует cookie при обновлении страницы (должно работать корректно)
- Проверить, что директория `/app/sessions` существует и имеет правильные права доступа
- Убедиться, что `FLASK_SECRET_KEY` установлен в переменных окружения для стабильности сессий

### To-dos

- [ ] Добавить session.modified = True в login_page() после установки сессии для гарантированного сохранения сессии Flask-Session
- [ ] Протестировать сохранение сессии: авторизация, переход на внешний сайт, возврат и обновление страницы без логаута