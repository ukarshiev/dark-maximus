<!-- a91e7f44-8eb9-4022-b619-d42c7cee2311 d2f94876-1e9b-44f9-8237-19ec8f7f300b -->
# Исправление Web App URL и обработки ошибок при выдаче ключей

## Проблема

1. **Web App URL с HTTP вместо HTTPS**: Telegram отклоняет Web App URL с протоколом HTTP, требуя только HTTPS
2. **Ошибка при редактировании сообщения**: При ошибке отправки сообщения код пытается отредактировать `processing_message`, который может быть уже удален или изменен
3. **Цепочка ошибок**: Первая ошибка (HTTP в Web App URL) приводит ко второй ошибке (попытка редактировать несуществующее сообщение)

## Решение

### 1. Исправление формирования setup_url в keyboards.py

**Файл:** `src/shop_bot/bot/keyboards.py`

**Изменение в строках 499-509:**

- Исправить логику нормализации домена для Web App URL
- Всегда использовать HTTPS для Web App (Telegram требует HTTPS)
- Убрать протокол если он указан (http:// или https://), затем всегда добавить https://
```python
# Кнопка настройки
# Получаем домен codex-docs из настроек
codex_docs_domain = get_setting("codex_docs_domain")
if codex_docs_domain:
    # Нормализация домена - всегда используем HTTPS для Web App (Telegram требует HTTPS)
    codex_docs_domain = codex_docs_domain.strip().rstrip('/')
    # Убираем протокол если есть
    if codex_docs_domain.startswith('http://'):
        codex_docs_domain = codex_docs_domain[7:]  # Убираем 'http://'
    elif codex_docs_domain.startswith('https://'):
        codex_docs_domain = codex_docs_domain[8:]  # Убираем 'https://'
    # Всегда добавляем HTTPS для Web App
    setup_url = f"https://{codex_docs_domain}/setup"
else:
    # Fallback на дефолт (для обратной совместимости)
    setup_url = "https://help.dark-maximus.com/setup"
```


### 2. Создание утилиты для нормализации Web App URL

**Файл:** `src/shop_bot/bot/keyboards.py`

**Добавить функцию после строки 41:**

- Создать универсальную функцию для нормализации URL для Web App
- Функция должна всегда возвращать HTTPS URL
- Использовать эту функцию для всех Web App URL
```python
def normalize_web_app_url(url: str) -> str:
    """
    Нормализует URL для использования в Web App кнопках Telegram.
    Telegram требует только HTTPS для Web App URL.
    
    Args:
        url: Исходный URL (может быть с http://, https:// или без протокола)
        
    Returns:
        URL с протоколом https://
    """
    if not url:
        return ""
    
    url = url.strip().rstrip('/')
    
    # Убираем протокол если есть
    if url.startswith('http://'):
        url = url[7:]  # Убираем 'http://'
    elif url.startswith('https://'):
        url = url[8:]  # Убираем 'https://'
    
    # Всегда добавляем HTTPS для Web App
    return f"https://{url}"
```


### 3. Использование утилиты для setup_url

**Файл:** `src/shop_bot/bot/keyboards.py`

**Изменение в строках 499-509:**

- Использовать функцию `normalize_web_app_url` для формирования setup_url
```python
# Кнопка настройки
# Получаем домен codex-docs из настроек
codex_docs_domain = get_setting("codex_docs_domain")
if codex_docs_domain:
    setup_url = normalize_web_app_url(f"{codex_docs_domain}/setup")
else:
    # Fallback на дефолт (для обратной совместимости)
    setup_url = "https://help.dark-maximus.com/setup"
```


### 4. Исправление формирования terms_url и privacy_url в handlers.py

**Файл:** `src/shop_bot/bot/handlers.py`

**Изменение в строках 526-530 и 714-718:**

- Использовать функцию `normalize_web_app_url` для формирования terms_url и privacy_url
- Импортировать функцию из keyboards.py
```python
from shop_bot.bot.keyboards import normalize_web_app_url

# В функции где формируются terms_url и privacy_url:
terms_url = None
privacy_url = None
if domain and not domain.startswith("http://localhost") and not domain.startswith("https://localhost"):
    terms_url = normalize_web_app_url(f"{domain.rstrip('/')}/terms")
    privacy_url = normalize_web_app_url(f"{domain.rstrip('/')}/privacy")
```


### 5. Исправление формирования terms_url и privacy_url в support_handlers.py

**Файл:** `src/shop_bot/bot/support_handlers.py`

**Изменение в строках 35-39:**

- Использовать функцию `normalize_web_app_url` для формирования terms_url и privacy_url
- Импортировать функцию из keyboards.py
```python
from shop_bot.bot.keyboards import normalize_web_app_url

# В функции show_terms_agreement_screen:
terms_url = None
privacy_url = None
if domain and not domain.startswith("http://localhost") and not domain.startswith("https://localhost"):
    terms_url = normalize_web_app_url(f"{domain.rstrip('/')}/terms")
    privacy_url = normalize_web_app_url(f"{domain.rstrip('/')}/privacy")
```


### 6. Улучшение обработки ошибок в process_successful_payment

**Файл:** `src/shop_bot/bot/handlers.py`

**Изменение в строках 7729-7741:**

- Добавить безопасную обработку ошибок при редактировании processing_message
- Если не удалось отредактировать сообщение, отправлять новое сообщение
- Обрабатывать случаи, когда processing_message уже удален или изменен
```python
except Exception as e:
    logger.error(f"Error processing payment for user {user_id} on host {host_name}: {e}", exc_info=True)
    
    # Безопасная попытка отредактировать сообщение
    try:
        await processing_message.edit_text("❌ Ошибка при выдаче ключа.")
    except Exception as edit_error:
        # Если не удалось отредактировать, отправляем новое сообщение
        logger.warning(f"Could not edit processing message: {edit_error}")
        try:
            await bot.send_message(user_id, "❌ Ошибка при выдаче ключа.")
        except Exception as send_error:
            logger.error(f"Could not send error message to user {user_id}: {send_error}")
    
    # Возвращаем статус транзакции на pending при ошибке
    try:
        from shop_bot.data_manager.database import update_transaction_status
        payment_id = metadata.get('payment_id')
        if payment_id:
            update_transaction_status(payment_id, 'pending')
            logger.info(f"Transaction {payment_id} status reverted to pending due to error")
    except Exception as revert_error:
        logger.error(f"Failed to revert transaction status: {revert_error}")
```


## Результат

1. Все Web App URL будут использовать HTTPS, что соответствует требованиям Telegram API
2. Ошибки при выдаче ключей будут обрабатываться безопасно без попыток редактирования несуществующих сообщений
3. Пользователи будут получать корректные уведомления об ошибках даже при сбоях в обработке сообщений
4. Транзакции будут корректно возвращаться в статус pending при ошибках

## Тестирование

После исправления необходимо проверить:

1. Формирование setup_url с различными вариантами codex_docs_domain (http://, https://, без протокола)
2. Формирование terms_url и privacy_url с различными вариантами domain
3. Обработку ошибок при выдаче ключей (симуляция ошибки отправки сообщения)
4. Корректность работы Web App кнопок в Telegram

## Использование Context7 для проверки документации

**Перед началом реализации:**

- Использовать Context7 MCP для получения актуальной документации по aiogram 3.21.0
- Проверить требования Telegram Bot API к Web App URL (требования HTTPS)
- Убедиться в корректности понимания формата WebAppInfo и InlineKeyboardButton
- Проверить документацию по обработке ошибок TelegramBadRequest в aiogram

**Источник:** Context7 MCP - `/websites/aiogram_dev-en-v3.21.0`

**Найденная информация из Context7:**

- WebAppInfo требует HTTPS URL (подтверждено документацией)
- InlineKeyboardButton поддерживает web_app параметр типа WebAppInfo
- Telegram API требует HTTPS для всех Web App URL