<!-- ed77a68a-3e15-42c7-97a1-0c76277c4815 277ac864-b692-465a-984a-b05b74f02ef3 -->
# Анализ и исправление жёстко прописанных доменов и типа сервера

## Обзор проблемы

Проведён полный анализ кодовой базы на предмет:

1. Жёстко прописанных доменов вместо переменных из панели
2. Необходимости указания типа сервера в коде решения
3. Необходимости указания типа сервера в коде тестов

## Найденные проблемы

### 1. Жёстко прописанные домены

#### Критичные (требуют исправления):

**1.1. `src/shop_bot/bot/keyboards.py` (строки 626, 629, 632)**

- Проблема: Жёстко прописанный домен `https://help.dark-maximus.com/setup` используется в качестве fallback для кнопки "Настройка"
- Решение: Использовать настройку `codex_docs_domain` из БД с проверкой типа сервера

**1.2. `src/shop_bot/modules/xui_api.py` (строка 80)**

- Проблема: Жёстко прописанный `dark-maximus.com` в User-Agent как fallback
- Решение: Использовать `get_global_domain()` с нормализацией домена

**1.3. `src/shop_bot/data_manager/database.py` (строка 811)**

- Проблема: Жёстко прописанный `https://panel.dark-maximus.com` в миграции как дефолтное значение
- Решение: Использовать `get_global_domain()` или проверку типа сервера

#### Некритичные (placeholder в HTML):

**1.4. `src/shop_bot/webhook_server/templates/settings.html`**

- Проблема: Placeholder значения содержат `dark-maximus.com`
- Решение: Оставить как есть (placeholder не влияет на функциональность)

### 2. Использование типа сервера в коде решения

#### Уже реализовано:

- Функции `get_server_environment()`, `is_production_server()`, `is_development_server()` существуют в `database.py`
- Используются в `keyboards.py`, `handlers.py`, `app.py` для условной логики

#### Требует проверки:

**2.1. `src/shop_bot/bot/handlers.py` (строка 6422)**

- Проблема: Жёстко прописанный fallback `https://localhost:8443` в `_get_ton_connect_instance`
- Решение: Использовать `get_global_domain()` который уже учитывает тип сервера

**2.2. `src/shop_bot/data_manager/database.py` (строки 9149, 9169)**

- Проблема: Жёстко прописанный fallback `https://localhost:8443` в `get_ton_manifest()`
- Решение: Использовать `get_global_domain()` который уже учитывает тип сервера

**2.3. `src/shop_bot/webhook_server/app.py` (строки 465, 476, 481, 498, 504, 515, 553)**

- Проблема: Жёстко прописанные localhost адреса используются, но с проверкой `is_development_server()`
- Статус: ✅ Уже корректно реализовано с проверкой типа сервера

### 3. Использование типа сервера в тестах

#### Текущая ситуация:

- Тесты используют переменную окружения `ENVIRONMENT` (из `.env`)
- В коде решения используется `server_environment` (из БД)
- Это может привести к рассинхронизации

#### Требует проверки:

**3.1. `tests/conftest.py`**

- Проблема: Используется переменная окружения `ENVIRONMENT` для определения окружения
- Решение: Проверить, нужно ли синхронизировать с `server_environment` из БД для тестов

**3.2. Интеграционные тесты**

- Проблема: Некоторые тесты проверяют окружение через `ENVIRONMENT`, но могут требовать `server_environment` из БД
- Решение: Убедиться, что тесты корректно определяют окружение

## Общие требования к реализации

**При выполнении всех задач необходимо:**

1. **Использовать Context7 MCP** для получения актуальной документации:

- Перед изменением кода использовать Context7 для получения документации по используемым библиотекам и фреймворкам
- Проверять актуальные best practices для Python, aiogram, Flask и других используемых технологий
- Использовать Context7 для проверки правильности реализации паттернов

2. **Следовать лучшим практикам разработки:**

- Следовать принципам DRY (Don't Repeat Yourself) - устранять дублирование кода
- Применять принципы SOLID при рефакторинге
- Использовать существующие функции и модули вместо создания новых
- Обеспечивать обратную совместимость при изменении существующего кода
- Добавлять комментарии и документацию для сложных участков кода
- Проверять код на соответствие существующим стандартам проекта
- Использовать type hints для улучшения читаемости и поддержки кода
- Обрабатывать ошибки и edge cases корректно

3. **Тестирование:**

- Перед изменением кода убедиться, что существующие тесты проходят
- После изменений запустить все релевантные тесты
- При необходимости добавить новые тесты для покрытия изменённого функционала

## План исправлений

### Этап 1: Исправление жёстко прописанных доменов

**Задача 1.1: Исправить fallback URL для кнопки "Настройка"**

- Файл: `src/shop_bot/bot/keyboards.py`
- Действие: Заменить жёстко прописанный `https://help.dark-maximus.com/setup` на использование настройки из БД или глобального домена
- Проверка: Убедиться, что в development используется корректный fallback

**Задача 1.2: Исправить User-Agent в xui_api.py**

- Файл: `src/shop_bot/modules/xui_api.py`
- Действие: Заменить жёстко прописанный `dark-maximus.com` на `get_global_domain()` с нормализацией
- Проверка: Убедиться, что домен корректно извлекается из глобального домена

**Задача 1.3: Исправить дефолтное значение в миграции**

- Файл: `src/shop_bot/data_manager/database.py`
- Действие: Проверить, можно ли использовать `get_global_domain()` вместо жёстко прописанного домена
- Проверка: Убедиться, что миграция не ломается при отсутствии домена

### Этап 2: Улучшение использования типа сервера

**Задача 2.1: Убрать дублирование fallback в handlers.py**

- Файл: `src/shop_bot/bot/handlers.py`
- Действие: Использовать `get_global_domain()` вместо дублирования логики fallback

**Задача 2.2: Убрать дублирование fallback в database.py**

- Файл: `src/shop_bot/data_manager/database.py`
- Действие: Использовать `get_global_domain()` в `get_ton_manifest()` вместо дублирования логики

### Этап 3: Проверка тестов

**Задача 3.1: Аудит использования окружения в тестах**

- Файлы: Все тестовые файлы
- Действие: Проверить, где используется `ENVIRONMENT` и где требуется `server_environment`
- Проверка: Убедиться, что тесты корректно определяют окружение

**Задача 3.2: Добавить документацию**

- Действие: Документировать различие между `ENVIRONMENT` (для тестов) и `server_environment` (для кода)
- Проверка: Убедиться, что документация понятна

## Файлы для изменения

### Код решения:

1. `src/shop_bot/bot/keyboards.py` - исправление fallback URL
2. `src/shop_bot/modules/xui_api.py` - исправление User-Agent
3. `src/shop_bot/data_manager/database.py` - исправление дефолтного значения и дублирования fallback
4. `src/shop_bot/bot/handlers.py` - убрать дублирование fallback

### Тесты:

1. `tests/conftest.py` - проверка использования окружения
2. Интеграционные тесты - проверка корректности определения окружения

## Приоритеты

**Критичные:**

- Задача 1.1 (keyboards.py) - fallback URL используется в production
- Задача 1.2 (xui_api.py) - User-Agent содержит жёстко прописанный домен

**Важные:**

- Задача 1.3 (database.py миграция) - дефолтное значение при создании настроек
- Задача 2.1, 2.2 - устранение дублирования кода

**Рекомендуемые:**

- Задача 3.1, 3.2 - улучшение тестов и документации

## Риски

1. Изменение миграции может повлиять на существующие установки - требуется проверка
2. Изменение fallback URL может сломать функциональность в development - требуется тестирование
3. Изменение User-Agent может повлиять на внешние API - требуется проверка

## Тестирование

После исправлений необходимо:

1. Запустить все unit-тесты
2. Запустить интеграционные тесты
3. Проверить работу в development окружении
4. Проверить работу в production окружении (если возможно)
5. Проверить работу кнопки "Настройка" в боте
6. Проверить User-Agent в запросах к 3X-UI API