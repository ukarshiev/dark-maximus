<!-- b1519a06-855f-4fa2-ba6e-3ac19a09d0ca de96afd4-6b65-44e1-a8ab-4a0bf52e45bf -->
# План создания теста для личного кабинета с режимом предоставления "cabinet"

## Цель

Создать интеграционный тест, который проверяет полный цикл работы личного кабинета при режиме предоставления "Личный кабинет" (cabinet).

## Задачи

### 1. Создание теста `test_cabinet_provision_mode_flow`

**Файл:** `tests/integration/test_user_cabinet/test_cabinet_flow.py`

**Шаги теста:**

1. Подготовка окружения:

- Использование временной БД через фикстуру `temp_db`
- Патчинг `DB_FILE` для изоляции теста

2. Создание тестовых данных:

- Создание пользователя через `register_user_if_not_exists`
- Создание хоста через `create_host`
- Создание тарифного плана с `key_provision_mode='cabinet'` через `create_plan`

3. Симуляция покупки:

- Создание ключа через `add_new_key` с параметрами тарифа
- Проверка, что `key_id` создан успешно
- Создание постоянного токена через `get_or_create_permanent_token`
- Получение данных ключа из БД

4. Проверка ссылки на личный кабинет:

- Получение домена личного кабинета через `get_user_cabinet_domain`
- Формирование URL: `{cabinet_domain}/auth/{token}`
- Проверка, что URL валиден

5. Тестирование веб-интерфейса:

- Загрузка Flask приложения через `_load_user_cabinet_app`
- Переход по ссылке `/auth/{token}` (должен редиректить на `/`)
- Проверка статуса ответа (200)

6. Проверка HTML структуры:

- Проверка наличия всех трех вкладок в HTML:
- `step-tab-setup` (Инструкции)
- `step-tab-subscription` (Подключение)
- `step-tab-ip-check` (Проверка IP)
- Проверка, что вкладка "Инструкции" активна по умолчанию (`is-active`)
- Проверка наличия iframe для инструкций (`setup-iframe`)

7. Проверка работы вкладки "Подписка":

- Проверка наличия секции `step-panel-subscription`
- Проверка наличия iframe для подписки (если `subscription_link` есть)

8. Проверка работы вкладки "Проверка IP":

- Проверка наличия секции `step-panel-ip-check`
- Проверка наличия кнопки "Обновить IP" (`ip-refresh`)
- Тестирование API `/api/ip-info`:
- GET запрос к `/api/ip-info`
- Проверка статуса ответа (200)
- Проверка структуры JSON ответа (`status`, `data`)
- Проверка наличия полей в `data`: `ip`, `country`, `city`, `provider`

### 2. Использование Allure для детального описания

**Добавить декораторы:**

- `@allure.epic("Личный кабинет")`
- `@allure.feature("Режим предоставления: Личный кабинет")`
- `@allure.story("Полный цикл покупки и работы кабинета")`
- `@allure.description()` с подробным описанием теста
- `@allure.severity(allure.severity_level.CRITICAL)`

**Добавить шаги Allure:**

- `@allure.step("Создание тарифного плана с режимом 'cabinet'")`
- `@allure.step("Симуляция покупки тарифа")`
- `@allure.step("Проверка ссылки на личный кабинет")`
- `@allure.step("Проверка вкладки 'Инструкции'")`
- `@allure.step("Проверка вкладки 'Подписка'")`
- `@allure.step("Проверка вкладки 'Проверка IP'")`
- `@allure.step("Тестирование API /api/ip-info")`

### 3. Создание документации

**Файл:** `docs/guides/testing/test-cabinet-provision-mode-cabinet.md`

**Содержание:**

- Описание теста
- Цель и область покрытия
- Структура теста
- Проверяемые сценарии
- Примеры использования
- Связь с другими тестами

**Доступ:** http://localhost:3001/ (через веб-интерфейс документации)

### 4. Best Practices

- Использовать фикстуру `temp_db` для изоляции теста
- Использовать моки для внешних API (если нужно)
- Добавить подробные assert сообщения
- Использовать параметризацию pytest для разных сценариев (если нужно)
- Следовать структуре существующих тестов в файле

### 5. Использование Context7

- Проверить актуальную структуру таблицы `plans` и поля `key_provision_mode`
- Проверить актуальную структуру HTML шаблона `index.html`
- Проверить актуальную структуру API `/api/ip-info`

## Файлы для изменения

1. `tests/integration/test_user_cabinet/test_cabinet_flow.py` - добавить новый тест
2. `docs/guides/testing/test-cabinet-provision-mode-cabinet.md` - создать документацию

## Зависимости

- Существующие функции: `create_plan`, `add_new_key`, `get_or_create_permanent_token`, `get_user_cabinet_domain`
- Фикстуры: `temp_db`
- Flask приложение: `apps/user-cabinet/app.py`