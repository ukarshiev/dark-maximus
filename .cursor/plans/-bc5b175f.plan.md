<!-- bc5b175f-6e8c-4362-a75f-979344f3842f 83545e20-72c5-4306-9b64-10991bc81406 -->
# –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å –±–∞–ª–∞–Ω—Å–∞

## –ó–∞–¥–∞—á–∏

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `src/shop_bot/data_manager/database.py`

- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `auto_renewal_enabled INTEGER DEFAULT 1` –≤ —Ç–∞–±–ª–∏—Ü—É `users` —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é
- –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `get_auto_renewal_enabled(user_id: int) -> bool` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
- –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `set_auto_renewal_enabled(user_id: int, enabled: bool)` –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
- –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `get_user()` –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—è `auto_renewal_enabled` –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### 2. –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è

**–§–∞–π–ª:** `src/shop_bot/data_manager/scheduler.py`

- –í —Ñ—É–Ω–∫—Ü–∏–∏ `perform_auto_renewals()` –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º
- –í —Ñ—É–Ω–∫—Ü–∏–∏ `check_expiring_subscriptions()` –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `send_autorenew_disabled_notice()` –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∫–æ–≥–¥–∞ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ, –Ω–æ –±–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω
- –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: "‚ö†Ô∏è –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Å –±–∞–ª–∞–Ω—Å–∞ –æ—Ç–∫–ª—é—á–µ–Ω–æ. –í–∞—à –±–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è, –Ω–æ —Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –í–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ, —á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞—Ç—å—Å—è –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞."

### 3. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–æ—Ç–∞

**–§–∞–π–ª:** `src/shop_bot/bot/keyboards.py`

- –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `create_profile_menu_keyboard()` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ "–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Å –±–∞–ª–∞–Ω—Å–∞ (–≤–∫–ªüü¢/–æ—Ç–∫–ªüî¥)"
- –ö–Ω–æ–ø–∫–∞ –¥–æ–ª–∂–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (–≤–∫–ª/–æ—Ç–∫–ª)

**–§–∞–π–ª:** `src/shop_bot/bot/handlers.py`

- –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ callback `toggle_auto_renewal` –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è
- –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è

### 4. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

**–§–∞–π–ª:** `src/shop_bot/webhook_server/templates/base.html`

- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ "–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ" –≤ —Ä–∞–∑–¥–µ–ª "–§–∏–Ω–∞–Ω—Å—ã" –≤–∫–ª–∞–¥–∫–∏ "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
- –†–∞—Å–ø–æ–ª–æ–∂–∏—Ç—å –ø–æ—Å–ª–µ –ø–æ–ª—è "–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ"

**–§–∞–π–ª:** `src/shop_bot/webhook_server/static/js/script.js`

- –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `loadUserDetails()` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç `detailAutoRenewal` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (–í–∫–ª—é—á–µ–Ω–æ/–û—Ç–∫–ª—é—á–µ–Ω–æ)

**–§–∞–π–ª:** `src/shop_bot/webhook_server/app.py`

- –û–±–Ω–æ–≤–∏—Ç—å endpoint `/api/user-details/<int:user_id>` –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—è `auto_renewal_enabled` –≤ –æ—Ç–≤–µ—Ç

### 5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

- –î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (DEFAULT 1)
- –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: –µ—Å–ª–∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –∏ –±–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –æ–±—ã—á–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

```python
cursor.execute("ALTER TABLE users ADD COLUMN auto_renewal_enabled INTEGER DEFAULT 1")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ perform_auto_renewals

```python
from shop_bot.data_manager.database import get_auto_renewal_enabled
if not get_auto_renewal_enabled(user_id):
    continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–∏

–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ `check_expiring_subscriptions`, –∫–æ–≥–¥–∞:

- –ë–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è
- –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ
- –ö–ª—é—á —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç (–∑–∞ 24 —á–∞—Å–∞ –∏–ª–∏ 1 —á–∞—Å)