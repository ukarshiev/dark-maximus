<!-- 4f81a6c3-e36d-46df-a799-0ecdfb99b765 b24d0d36-504b-4503-b0cd-07a94d8e1bf5 -->
# План устранения дефектов тестов Dark Maximus - ОБНОВЛЕНО

**Дата создания:** 16.11.2025 05:29
**Дата проверки фактического состояния:** 16.11.2025 (текущее время UTC+3)
**Версия:** 2.0

## Резюме проверки фактического состояния

После проверки всех тестов из оригинального плана обнаружено, что **большинство тестов из этапов 1.1-1.6, 2.1-2.4, 4.1 УЖЕ ПРОХОДЯТ успешно**.

Оригинальный план был основан на устаревших данных Allure отчетов. Реальные проблемы отличаются от описанных.

## Этапы, которые уже исправлены (не требуют действий)

### ✅ Этап 1.1 (Регистрация пользователя) - 4 теста PASSED

- `test_user_registration_flow` - PASSED
- `test_register_user_with_referrer` - PASSED  
- `test_register_user_if_not_exists` - PASSED
- `test_register_user_twice` - PASSED

**Вывод:** Все тесты используют правильный паттерн `register_user_if_not_exists() → get_user()`

### ✅ Этап 1.2 (Покупка VPN-ключа) - 2 теста PASSED

- `test_token_creation_on_key_creation` - PASSED
- `test_validate_token_with_deleted_key` - PASSED

**Вывод:** Функция `add_new_key()` возвращает `key_id` корректно

### ✅ Этап 1.3 (Обработка платежей) - 3 теста PASSED

- `test_log_transaction` - PASSED
- `test_update_transaction_status` - PASSED
- `test_update_transaction_on_payment` - PASSED

**Вывод:** Все функции транзакций работают корректно

### ✅ Этап 1.4 (Получение ключа) - 1 тест PASSED

- `test_get_next_key_number` - PASSED

**Вывод:** Таблица `users` создается в фикстуре `temp_db` корректно

### ✅ Этап 1.5 (Пополнение баланса) - 1 тест PASSED

- `test_get_user_balance` - PASSED

**Вывод:** Баланс обновляется корректно

### ✅ Этап 1.6 (Промокоды) - 11 тестов PASSED

- `test_calculate_discount_amount` - PASSED
- `test_calculate_discount_percent` - PASSED
- `test_promo_code_limit_reached` - PASSED
- `test_create_promo_code` - PASSED
- `test_get_promo_code_by_id` - PASSED
- `test_get_promo_code_by_code` - PASSED
- `test_update_promo_code` - PASSED
- `test_delete_promo_code` - PASSED
- `test_can_user_use_promo_code` - PASSED
- `test_record_promo_code_usage` - PASSED
- `test_key_creation_with_integrity_error` - PASSED

**Вывод:** Колонка `vpn_plan_id` присутствует в схеме `promo_codes` в `conftest.py`

### ✅ Этап 2.1 (Доп. операции с пользователями) - 2 теста PASSED

- `test_terms_agreement_flow` - PASSED
- `test_update_user_stats` - PASSED

### ✅ Этап 2.2 (Токены кабинета) - 2 теста PASSED

- `test_token_deletion_on_key_deletion` - PASSED
- `test_token_deletion_on_user_keys_deletion` - PASSED

### ✅ Этап 2.3 (WAL режим) - 1 тест PASSED

- `test_wal_mode_in_run_migration` - PASSED

### ✅ Этап 2.4 (Безопасность) - 1 тест PASSED

- `test_sanitize_string_dangerous_chars` - PASSED

### ✅ Этап 4.1 (Валидация параметров) - 1 тест PASSED

- `test_deeplink_parameter_length_limit` - PASSED

---

## Реальные проблемы, обнаруженные при проверке

### Проблема 1: Тесты платежных обработчиков (2 дефекта)

**Тесты:**

- `test_create_yookassa_payment` (unit.test_bot) - FAILED
- `test_create_ton_invoice` (unit.test_bot) - FAILED

**Ошибка:** `TypeError: object MagicMock can't be used in 'await' expression`

**Причина:** Тесты используют `MagicMock` для мокирования асинхронных объектов, но моки не настроены как `AsyncMock`

**Файлы:**

- `tests/unit/test_bot/test_payment_handlers.py`

**Решение:**

1. Заменить `MagicMock` на `AsyncMock` для асинхронных методов
2. Настроить моки для `callback.message.answer()` и других async методов

### Проблема 2: Нумерация ключей (2 дефекта)

**Тесты:**

- `test_sequential_key_numbers` (unit.test_database) - FAILED
- `test_user_not_found_handling` (unit.test_database) - FAILED

**Ошибки:**

- `test_sequential_key_numbers`: ожидается [1, 2, 3, 4, 5], получены [32, 33, 34, 35, 36]
- `test_user_not_found_handling`: ожидается 1, получен 7

**Причина:** Функция `get_next_key_number` использует глобальную нумерацию или счетчик не сбрасывается между тестами

**Файлы:**

- `tests/unit/test_database/test_key_numbering.py`
- `src/shop_bot/data_manager/database.py` - функция `get_next_key_number`

**Решение:**

1. Проверить логику `get_next_key_number` - возможно, она учитывает все ключи в БД, а не только ключи пользователя
2. Исправить тесты для использования изолированной БД или исправить логику функции

### Проблема 3: Интеграционные тесты (множество дефектов)

**Категории проблем:**

#### 3.1 Webhook тесты (6 дефектов)

- `test_webhook_yookassa_verification` - FAILED (404 вместо ожидаемых 200/400/401/500)
- `test_webhook_cryptobot_verification` - FAILED (404)
- `test_webhook_heleket_verification` - FAILED (404)
- `test_webhook_retry_mechanism` - FAILED (404)
- `test_webhook_idempotency` - FAILED (404)
- `test_webhook_error_handling` - FAILED (404)

**Причина:** Тесты обращаются к несуществующим эндпоинтам webhook

#### 3.2 Баланс платежей (1 дефект)

- `test_balance_payment_full_flow` - FAILED (баланс не уменьшается: 200.0 == 200.0)

**Причина:** Баланс не обновляется после оплаты

#### 3.3 Промокоды интеграционные (1 дефект)

- `test_promo_code_application_validation` - FAILED (промокод не найден или неактивен)

**Причина:** Промокод не создается или не находится в интеграционных тестах

#### 3.4 Webhook server тесты (множество дефектов)

- Проблемы с rate limiting (429 вместо 200)
- Проблемы с аутентификацией (302 вместо 200)
- Проблемы с маршрутами (404 вместо 200)

**Причина:** Тесты не настроены корректно для изоляции или требуют правильной настройки сессий

#### 3.5 User cabinet тесты (7 дефектов)

- Все тесты падают с `FileNotFoundError: /app/apps/user-cabinet/app.py`

**Причина:** Тесты пытаются импортировать несуществующий модуль `apps/user-cabinet/app.py`

---

## Обновленная классификация дефектов

### Критичные (требуют исправления)

1. **Тесты платежных обработчиков** (2 дефекта) - проблема с моками
2. **Нумерация ключей** (2 дефекта) - логика нумерации работает некорректно в тестах
3. **Баланс платежей** (1 дефект) - баланс не обновляется после оплаты

### Высокие (требуют исправления)

1. **Webhook эндпоинты** (6 дефектов) - тесты обращаются к несуществующим эндпоинтам
2. **Интеграционные промокоды** (1 дефект) - промокод не создается в интеграционных тестах
3. **Webhook server тесты** (множество дефектов) - проблемы с настройкой тестов

### Средние (не критичны, но требуют внимания)

1. **User cabinet тесты** (7 дефектов) - тесты используют неправильный путь к модулю
2. **Auto renewal тесты** (3 дефекта) - требуется проверка

---

## Рекомендуемый порядок исправления

### Неделя 1: Критичные проблемы

- День 1-2: Исправить тесты платежных обработчиков (моки)
- День 3: Исправить нумерацию ключей
- День 4: Исправить обновление баланса после оплаты

### Неделя 2: Высокие проблемы

- День 1-2: Настроить webhook эндпоинты для тестов
- День 3: Исправить интеграционные тесты промокодов
- День 4-5: Настроить webhook server тесты

### Неделя 3: Средние проблемы

- День 1-2: Исправить user cabinet тесты (путь к модулю)
- День 3-4: Проверить и исправить остальные интеграционные тесты
- День 5: Регрессионное тестирование

---

## Метрики успеха

### Текущее состояние:

- ✅ Все этапы 1.1-1.6 уже исправлены (22 теста PASSED)
- ✅ Этапы 2.1-2.4 уже исправлены (6 тестов PASSED)
- ✅ Этап 4.1 уже исправлен (1 тест PASSED)
- ❌ Реальные проблемы обнаружены в других местах (не описаны в оригинальном плане)

### Целевое состояние:

- ✅ Все unit-тесты: 100% PASSED
- ✅ Все integration-тесты: > 95% PASSED
- ✅ Все e2e-тесты: > 90% PASSED

### To-dos

- [ ] Проверить фактическое состояние всех этапов плана 1.1-1.6, 2.1-2.4, 4.1
- [ ] Идентифицировать реальные проблемы из падающих тестов
- [ ] Исправить тесты платежных обработчиков - заменить MagicMock на AsyncMock для async методов
- [ ] Исправить логику нумерации ключей в тестах - проверить get_next_key_number и изоляцию БД
- [ ] Исправить обновление баланса после оплаты в test_balance_payment_full_flow
- [ ] Настроить webhook эндпоинты для интеграционных тестов
- [ ] Исправить интеграционный тест промокодов - проверить создание промокода в тесте
- [ ] Настроить webhook server тесты - решить проблемы с rate limiting и аутентификацией
- [ ] Исправить user cabinet тесты - проверить путь к модулю apps/user-cabinet/app.py