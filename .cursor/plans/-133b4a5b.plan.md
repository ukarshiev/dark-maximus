<!-- 133b4a5b-46cc-4ba2-91ad-0ff4804093f9 fe562a21-9651-4e8d-ad56-12e254cd8b0f -->
# План исправления падающих тестов аутентификации

## Анализ проблемы

### Падающие тесты:

1. `test_no_attribute_error_on_login` - проверка отсутствия ошибок AttributeError при авторизации
2. `test_unique_cookie_names` - проверка уникальности имен cookie между сервисами
3. `test_no_session_conflict_between_services` - проверка отсутствия конфликта сессий
4. `test_login_success_no_errors` - проверка успешной авторизации без ошибок
5. `test_session_persistence` - проверка сохранения сессии между запросами

### Возможные причины проблем:

1. **Несоответствие ENVIRONMENT и server_environment**:

- Тесты используют `ENVIRONMENT` из `.env` файла
- Код использует `server_environment` из БД
- Может быть расхождение между этими значениями

2. **Проблемы с именами cookie**:

- Тесты ожидают конкретные имена: `panel_session`, `docs_session`, `allure_session`
- Могут быть несоответствия в конфигурации сервисов

3. **Проблемы с сохранением сессии**:

- Flask-Session может не сохранять сессию корректно
- Возможна проблема с `session_interface.save_session`

4. **Проблемы с доступностью сервисов**:

- Тесты пропускаются, если `check_service_available` возвращает False
- Может быть проблема с определением хоста на production

## План исправления

### Этап 1: Анализ конкретных ошибок из Allure

- Получить детальную информацию об ошибках из Allure отчета
- Определить точные причины падения каждого теста
- Проверить логи тестов для понимания проблем

### Этап 2: Исправление проблем с конфигурацией

- Убедиться, что `server_environment` из БД соответствует `ENVIRONMENT` из `.env`
- Проверить корректность определения хостов для сервисов в `conftest.py`
- Убедиться, что настройки cookie имен соответствуют ожиданиям тестов

### Этап 3: Исправление проблем с сессиями

- Проверить корректность инициализации Flask-Session в `auth_utils.py`
- Убедиться, что `session_interface` настроен правильно
- Проверить отсутствие ошибок AttributeError при сохранении сессии

### Этап 4: Исправление тестов (если проблема в тестах)

- Обновить тесты для учета настройки `server_environment`
- Исправить проверки cookie имен, если они не соответствуют реальности
- Улучшить обработку ошибок в тестах

### Этап 5: Проверка на разных типах серверов

- Убедиться, что тесты проходят на production сервере
- Убедиться, что тесты проходят на development сервере
- Проверить работу с разными значениями `server_environment`

### Этап 6: Повторный запуск тестов и проверка

- Запустить тесты после исправлений
- Проверить результаты в Allure отчете
- Убедиться, что все тесты проходят

## Файлы для изменения

1. `tests/integration/test_auth_all_services/conftest.py` - конфигурация тестов
2. `src/shop_bot/webhook_server/auth_utils.py` - инициализация аутентификации
3. `tests/integration/test_auth_all_services/test_*.py` - тесты (если нужно)
4. Возможно другие файлы с инициализацией Flask-Session для других сервисов

## Критерии успеха

- Все 5 тестов проходят успешно
- Тесты работают на production и development серверах
- Тесты учитывают настройку `server_environment` из БД
- Нет ошибок AttributeError при авторизации
- Cookie имена уникальны для каждого сервиса
- Сессии изолированы и не конфликтуют