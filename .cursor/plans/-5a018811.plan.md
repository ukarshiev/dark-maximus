<!-- 5a018811-7f26-44b8-a492-36812b3e1e8d 6f16d175-f3c0-4aa6-a6e9-fc4d8fc99f29 -->
# –£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–±–Ω—ã—Ö –∫–ª—é—á–µ–π —Å –ø–æ–¥–ø–∏—Å–∫–æ–π

## –¶–µ–ª—å

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –í–∞—Ä–∏–∞–Ω—Ç 2 –∏–∑ –ø–ª–∞–Ω–∞ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: —É–ª—É—á—à–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–±–Ω—ã—Ö –∫–ª—é—á–µ–π:

1. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–∏–ø –∫–ª—é—á–∞ –≤ –Ω–æ–º–µ—Ä–µ: "–ö–ª—é—á ‚Ññ6 (–ü—Ä–æ–±–Ω—ã–π)"
2. –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–®–∞–≥ 2: üîë –ü–æ–¥–ø–∏—Å–∫–∞" –¥–ª—è –ø—Ä–æ–±–Ω—ã—Ö –∫–ª—é—á–µ–π (–∫–∞–∫ —É –ø–ª–∞—Ç–Ω—ã—Ö)
3. –í–º–µ—Å—Ç–æ –∫–ª—é—á–∞ –≤—ã–¥–∞–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –ø—Ä–æ–±–Ω—ã—Ö –∫–ª—é—á–µ–π

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

- –ü—Ä–æ–±–Ω—ã–µ –∫–ª—é—á–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å `provision_mode='key'` (—Ç–æ–ª—å–∫–æ –∫–ª—é—á)
- `subscription` —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–±–Ω—ã—Ö –∫–ª—é—á–µ–π (—Å—Ç—Ä–æ–∫–∞ 3152), –Ω–æ –ù–ï –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ `sub_id` –≤ `create_or_update_key_on_host()`
- `subscription_link` –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–±–Ω—ã—Ö –∫–ª—é—á–µ–π, —Ç.–∫. `sub_id` –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è (–≤ `create_or_update_key_on_host()` subscription_link —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω `sub_id`)
- –ù–æ–º–µ—Ä –∫–ª—é—á–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ –∫–∞–∫ "–ö–ª—é—á ‚ÑñN" –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ç–∏–ø–∞
- –ö–Ω–æ–ø–∫–∞ "–®–∞–≥ 2: üîë –ü–æ–¥–ø–∏—Å–∫–∞" –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–±–Ω—ã—Ö –∫–ª—é—á–µ–π (—Ç.–∫. `subscription_link` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)

## –§–∞–∫—Ç—ã –∏–∑ –∫–æ–¥–∞

1. **–°–æ–∑–¥–∞–Ω–∏–µ subscription –¥–ª—è –ø—Ä–æ–±–Ω—ã—Ö –∫–ª—é—á–µ–π:**

- –°—Ç—Ä–æ–∫–∞ 3152: `subscription = f"{user_id}-{username}".lower().replace('@', '')`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î —á–µ—Ä–µ–∑ `add_new_key()` (—Å—Ç—Ä–æ–∫–∞ 3167)

2. **–°–æ–∑–¥–∞–Ω–∏–µ subscription –¥–ª—è –ø–ª–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π:**

- –°—Ç—Ä–æ–∫–∏ 4728, 5214: –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è `subscription`
- –°—Ç—Ä–æ–∫–∏ 4736, 5222: –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ `sub_id=subscription` –≤ `create_or_update_key_on_host()`

3. **–°–æ–∑–¥–∞–Ω–∏–µ subscription_link:**

- –í `create_or_update_key_on_host()` (—Å—Ç—Ä–æ–∫–∏ 642-650 xui_api.py): —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω `sub_id`
- –§–æ—Ä–º–∞—Ç: `f"{sub_uri}{sub_id}"`

4. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:**

- –í `create_key_info_keyboard()` (—Å—Ç—Ä–æ–∫–∏ 429-455 keyboards.py): –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `subscription_link` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç

5. **–§—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:**

- `get_key_info_text()` (config.py): –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `provision_mode`, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `is_trial`
- `get_purchase_success_text()` (config.py): –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `provision_mode`, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `is_trial`
- `show_key_handler()` (handlers.py): –ø–æ–ª—É—á–∞–µ—Ç `is_trial` –∏–∑ `key_data`, –Ω–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

## –ó–∞–¥–∞—á–∏

### –ó–∞–¥–∞—á–∞ 1: –ü–µ—Ä–µ–¥–∞—Ç—å sub_id –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–±–Ω–æ–≥–æ –∫–ª—é—á–∞

**–§–∞–π–ª:** `src/shop_bot/bot/handlers.py`

**–ú–µ—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**

1. –§—É–Ω–∫—Ü–∏—è `process_trial_key_creation_callback()` (—Å—Ç—Ä–æ–∫–∏ 3129-3136)

- –î–æ–±–∞–≤–∏—Ç—å `sub_id=subscription` –≤ –≤—ã–∑–æ–≤ `create_or_update_key_on_host()`
- –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç —Å–æ–∑–¥–∞–Ω–∏–µ `subscription_link` –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ

2. –§—É–Ω–∫—Ü–∏—è `process_trial_key_creation()` (—Å—Ç—Ä–æ–∫–∏ 3250-3257)

- –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–õ–æ–≥–∏–∫–∞:**

- `subscription` —É–∂–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 3152 (–∏ 3280)
- –ù—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –µ–≥–æ –∫–∞–∫ `sub_id` –≤ `create_or_update_key_on_host()`
- –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç `subscription_link` –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ (—Å—Ç—Ä–æ–∫–∏ 642-650 xui_api.py)

### –ó–∞–¥–∞—á–∞ 2: –ò–∑–º–µ–Ω–∏—Ç—å provision_mode –¥–ª—è –ø—Ä–æ–±–Ω—ã—Ö –∫–ª—é—á–µ–π –Ω–∞ 'subscription'

**–§–∞–π–ª:** `src/shop_bot/bot/handlers.py`

**–ú–µ—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**

1. –§—É–Ω–∫—Ü–∏—è `process_trial_key_creation_callback()` (—Å—Ç—Ä–æ–∫–∏ 3210-3219)

- –ò–∑–º–µ–Ω–∏—Ç—å `provision_mode='key'` –Ω–∞ `provision_mode='subscription'`
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `subscription_link` –ø–æ–ª—É—á–µ–Ω –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ `get_client_subscription_link()`

2. –§—É–Ω–∫—Ü–∏—è `process_trial_key_creation()` (—Å—Ç—Ä–æ–∫–∏ 3339-3348)

- –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–õ–æ–≥–∏–∫–∞:**

- –ï—Å–ª–∏ `subscription_link` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ, –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ `xui_api.get_client_subscription_link(host_name, email)`
- –ü–µ—Ä–µ–¥–∞—Ç—å `provision_mode='subscription'` –≤ `get_purchase_success_text()`
- –ü–µ—Ä–µ–¥–∞—Ç—å `subscription_link` –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É

### –ó–∞–¥–∞—á–∞ 2: –£–ª—É—á—à–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–ª—é—á–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–∏–ø–∞

**–§–∞–π–ª:** `src/shop_bot/config.py`

**–§—É–Ω–∫—Ü–∏—è:** `get_key_info_text()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `is_trial: bool = False` –≤ —Å–∏–≥–Ω–∞—Ç—É—Ä—É —Ñ—É–Ω–∫—Ü–∏–∏
- –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞:
- –ï—Å–ª–∏ `is_trial=True`: `f"<b>üîë –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª—é—á–µ #{key_number} (–ü—Ä–æ–±–Ω—ã–π)</b>"`
- –ò–Ω–∞—á–µ: `f"<b>üîë –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª—é—á–µ #{key_number}</b>"`

**–§–∞–π–ª:** `src/shop_bot/bot/handlers.py`

**–§—É–Ω–∫—Ü–∏—è:** `show_key_handler()` (—Å—Ç—Ä–æ–∫–∞ ~3363)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –ü–æ–ª—É—á–∏—Ç—å `is_trial` –∏–∑ `key_data`
- –ü–µ—Ä–µ–¥–∞—Ç—å `is_trial=key_data.get('is_trial') == 1` –≤ `get_key_info_text()`

**–§–∞–π–ª:** `src/shop_bot/config.py`

**–§—É–Ω–∫—Ü–∏—è:** `get_purchase_success_text()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `is_trial: bool = False`
- –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞:
- –ï—Å–ª–∏ `is_trial=True`: `f"üéâ <b>–í–∞—à –∫–ª—é—á #{key_number} (–ü—Ä–æ–±–Ω—ã–π) {action_text}!</b>"`
- –ò–Ω–∞—á–µ: `f"üéâ <b>–í–∞—à –∫–ª—é—á #{key_number} {action_text}!</b>"`

**–§–∞–π–ª:** `src/shop_bot/bot/handlers.py`

**–ú–µ—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**

- –§—É–Ω–∫—Ü–∏—è `process_trial_key_creation_callback()` - –ø–µ—Ä–µ–¥–∞—Ç—å `is_trial=True` –≤ `get_purchase_success_text()`
- –§—É–Ω–∫—Ü–∏—è `process_trial_key_creation()` - –ø–µ—Ä–µ–¥–∞—Ç—å `is_trial=True` –≤ `get_purchase_success_text()`

### –ó–∞–¥–∞—á–∞ 3: –£–ª—É—á—à–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ –∫–ª—é—á–µ–π

**–§–∞–π–ª:** `src/shop_bot/bot/keyboards.py`

**–§—É–Ω–∫—Ü–∏—è:** `create_keys_management_keyboard()` (—Å—Ç—Ä–æ–∫–∞ 397)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏:
- –ï—Å–ª–∏ `key.get('is_trial') == 1`: `f"{status_icon} –ö–ª—é—á #{i+1} (–ü—Ä–æ–±–Ω—ã–π) ({host_name}) (–¥–æ {expiry_date.strftime('%d.%m.%Y')})"`
- –ò–Ω–∞—á–µ: `f"{status_icon} –ö–ª—é—á #{i+1} ({host_name}) (–¥–æ {expiry_date.strftime('%d.%m.%Y')})"`

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. **–ó–∞–¥–∞—á–∞ 1** - –ò–∑–º–µ–Ω–∏—Ç—å provision_mode –∏ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ subscription_link
2. **–ó–∞–¥–∞—á–∞ 2** - –£–ª—É—á—à–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–ª—é—á–∞ –≤ —Ç–µ–∫—Å—Ç–µ
3. **–ó–∞–¥–∞—á–∞ 3** - –£–ª—É—á—à–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ –∫–ª—é—á–µ–π

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

1. –ü—Ä–æ–±–Ω—ã–µ –∫–ª—é—á–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ "–ö–ª—é—á ‚Ññ6 (–ü—Ä–æ–±–Ω—ã–π)" –≤–º–µ—Å—Ç–æ "–ö–ª—é—á ‚Ññ6"
2. –í–º–µ—Å—Ç–æ –∫–ª—é—á–∞ (connection_string) –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ (subscription_link)
3. –ö–Ω–æ–ø–∫–∞ "–®–∞–≥ 2: üîë –ü–æ–¥–ø–∏—Å–∫–∞" –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–±–Ω—ã—Ö –∫–ª—é—á–µ–π
4. –í —Å–ø–∏—Å–∫–µ –∫–ª—é—á–µ–π –ø—Ä–æ–±–Ω—ã–µ –∫–ª—é—á–∏ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ "(–ü—Ä–æ–±–Ω—ã–π)"