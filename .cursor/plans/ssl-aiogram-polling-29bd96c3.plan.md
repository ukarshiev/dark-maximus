<!-- 29bd96c3-eb97-4752-b07d-a6e2ec76ab99 056b5cb4-b821-4e7c-ac55-429053ad4883 -->
# Исследование и исправление SSL ошибок в aiogram polling

## Проблема

В логах бота появляются ошибки:

```
TelegramNetworkError: HTTP Client says - ClientOSError: [Errno 1] [SSL] record layer failure (_ssl.c:2590)
```

Ошибка происходит в `_listen_updates` при попытке получить обновления от Telegram API через polling.

## Факты из документации aiogram 3.21.0

### Встроенная обработка ошибок

- Метод `_listen_updates` уже имеет встроенную retry логику с экспоненциальным backoff
- Ошибки сети обрабатываются автоматически и НЕ останавливают polling
- Используется `BackoffConfig` для управления задержками между попытками
- Ошибки логируются, но polling продолжает работать

### Текущая конфигурация (факты)

- В `bot_controller.py` используется только `ClientTimeout` через `session_kwargs`
- SSL контекст не настроен явно - используется дефолтный от aiohttp
- `certifi` не указан в зависимостях `pyproject.toml`
- Ошибки логируются, но polling продолжает работать благодаря встроенной логике

## Диагностика проблемы

### Что нужно проверить

1. Является ли ошибка критичной (останавливает ли она бота) или это временные сбои
2. Настроен ли SSL контекст правильно (использует ли certifi)
3. Есть ли проблемы с системным временем или сертификатами

## Консервативный план действий

### 1. Диагностика (без изменений кода)

- Проверить логи: останавливается ли бот при ошибках или продолжает работать
- Проверить наличие `certifi` в окружении (может быть зависимостью aiohttp)
- Проверить системное время на сервере

### 2. Минимальные изменения (только если необходимо)

- Добавить явную настройку SSL контекста через `AiohttpSession` с `certifi` (если certifi отсутствует)
- Улучшить логирование SSL ошибок для мониторинга (без изменения логики retry)

### 3. НЕ делать

- НЕ добавлять свою retry логику (она уже есть в aiogram)
- НЕ менять обработку ошибок в `_start_polling` (aiogram сам обрабатывает)
- НЕ менять логику polling без крайней необходимости

## Файлы для изменения (минимально)

1. `src/shop_bot/bot_controller.py` - добавить явную настройку SSL контекста (только если нужно)
2. `pyproject.toml` - добавить `certifi` в зависимости (если отсутствует)

## Ожидаемый результат

- Улучшенная настройка SSL для предотвращения ошибок
- Более информативное логирование для мониторинга
- Сохранение стабильности работы бота (не ломаем существующую логику)

### To-dos

- [ ] Проанализировать текущую конфигурацию Bot и сессии в bot_controller.py
- [ ] Добавить явную настройку SSL контекста через AiohttpSession с TCPConnector и certifi
- [ ] Добавить retry логику для временных SSL ошибок в _start_polling с экспоненциальной задержкой
- [ ] Улучшить обработку TelegramNetworkError для специфичных SSL ошибок в error_handler.py
- [ ] Протестировать изменения и проверить логи на наличие SSL ошибок