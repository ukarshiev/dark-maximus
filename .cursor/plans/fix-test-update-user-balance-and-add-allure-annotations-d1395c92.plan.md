<!-- d1395c92-0214-4931-a337-4ceb5660dcda 01ed5bff-97e1-4713-ac28-4df21203d1c6 -->
# Исправление теста test_update_user_balance

## Проблема

Тест падает с ошибкой `sqlite3.OperationalError: no such column: telegram_id` потому что:

- Эндпоинт `/api/update-user` использует локальный `DB_FILE` из модуля `app.py` (строка 4425)
- В `conftest.py` патчится только `database.DB_FILE`, но не `app.DB_FILE`
- Эндпоинт обращается к неправильной БД (production вместо temp_db)

## Решение

### 1. Исправить тест (tests/unit/test_webhook_server/test_users.py)

- Добавить патчинг `app.DB_FILE` через `monkeypatch` или `patch`
- Убедиться, что эндпоинт использует временную БД из `temp_db`

### 2. Добавить Allure аннотации

Согласно правилам из `testing-rules.mdc`:

- `@allure.epic("Веб-панель")` - уже есть на уровне класса
- `@allure.feature("Управление пользователями")` - уже есть на уровне класса
- `@allure.title("Обновление баланса пользователя через веб-панель")`
- `@allure.description` - структурированное описание с разделами:
- Что проверяется
- Тестовые данные
- Предусловия
- Шаги теста
- Ожидаемый результат
- `@allure.severity(allure.severity_level.NORMAL)`
- `@allure.tag("balance", "user_management", "web_panel", "unit", "users", "api")`
- `allure.step()` для структурирования шагов
- `allure.attach()` для прикрепления важных данных

### 3. Проверить результат

- Запустить тест и убедиться, что он проходит
- Проверить отчет в Allure на корректность аннотаций

## Файлы для изменения

- `tests/unit/test_webhook_server/test_users.py` - исправить тест и добавить аннотации

### To-dos

- [ ] Исправить патчинг DB_FILE в тесте - добавить патчинг app.DB_FILE для использования временной БД
- [ ] Добавить полный набор Allure аннотаций к тесту согласно правилам проекта
- [ ] Запустить тест и проверить, что он проходит
- [ ] Проверить отчет в Allure на корректность отображения аннотаций и данных