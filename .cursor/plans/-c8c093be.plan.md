<!-- c8c093be-fe49-4dac-acfe-6c23f2502ecb 3fbb397a-2669-4520-a4a9-8f46ae497965 -->
# Анализ проблемы с тестом testmultiplevalidlinksnot_broken

## Проблема

Тест `test_multiple_valid_links_not_broken` падает, потому что в нём используется один `test_client` для множества токенов в цикле. Flask test_client сохраняет сессию между запросами в рамках одного контекста.

### Текущая реализация (строка 528-540 в test_cabinet_flow.py):

```python
with app.test_client() as client:
    for i, token in enumerate(tokens):
        response = client.get(f'/auth/{token}', follow_redirects=False)
        # проверки...
```

### Проблема:

1. **Сохранение сессии**: После первого запроса `/auth/{token1}` декоратор `@require_token` сохраняет токен в session (строка 225 в app.py):
   ```python
   session['token'] = token
   ```

2. **Конфликт токенов**: При втором запросе `/auth/{token2}` декоратор получает токен так (строка 192):
   ```python
   token = kwargs.get('token') or request.args.get('token') or session.get('token')
   ```


Хотя для маршрута `/auth/<token>` Flask должен передавать токен в `kwargs`, в некоторых случаях может использоваться токен из session от предыдущего запроса, что приводит к валидации неправильного токена.

3. **Ошибка 403**: Если используется старый токен из session, он может относиться к другому key_id, что вызывает ошибку валидации и возврат 403.

## Решение

Создавать новый `test_client` для каждого токена, чтобы изолировать сессии между запросами.

### Изменения в test_cabinet_flow.py:

**Было:**

```python
with app.test_client() as client:
    for i, token in enumerate(tokens):
        response = client.get(f'/auth/{token}', follow_redirects=False)
```

**Должно быть:**

```python
for i, token in enumerate(tokens):
    with app.test_client() as client:
        response = client.get(f'/auth/{token}', follow_redirects=False)
```

Это гарантирует, что каждый запрос использует свежую сессию Flask, и токены не конфликтуют между собой.

## Файлы для изменения

- `tests/integration/test_user_cabinet/test_cabinet_flow.py` - строка 528-540

### To-dos

- [ ] Изменить тест test_multiple_valid_links_not_broken: вынести создание test_client внутрь цикла для изоляции сессий между запросами
- [ ] Запустить тест и убедиться, что он проходит без ошибок 403 для всех токенов