<!-- 4884fa66-08bf-487a-ad50-5b20726068ef 3dcea757-8bfc-4a0e-8369-2399825c4d1d -->
# План: Исправление токена и отображения подписки

**Дата создания/обновления:** 12.11.2025 14:30
**Версия:** 1.0

## Проблемы (на основе фактов)

1. **Токен не добавляется в ссылку**: По скриншоту видно `http://localhost:3003/` вместо `http://localhost:3003/auth/{token}`
2. **Двойное создание токена**: Токен создается в `handlers.py:6746`, но не используется - создается заново в `get_purchase_success_text()`
3. **Отсутствие подписки**: Пользователь хочет видеть `subscription_link`, но режим `cabinet` не показывает подписку
4. **Логирование добавлено**: Но нужно проверить логи после покупки для диагностики

## Факты из кода

### Текущая реализация

1. **Создание токена в handlers.py** (`src/shop_bot/bot/handlers.py:6742-6749`):

- Токен создается локально: `cabinet_token = get_or_create_permanent_token(user_id, key_id)`
- Переменная `cabinet_token` не используется дальше в функции
- Токен создается заново в `get_purchase_success_text()`

2. **Создание токена в config.py** (`src/shop_bot/config.py:315-326`):

- Проверка: `if user_id and key_id:`
- Вызов: `cabinet_token = get_or_create_permanent_token(user_id, key_id)`
- Логирование добавлено для диагностики

3. **Формирование ссылки** (`src/shop_bot/config.py:332-337`):

- Если `cabinet_token` есть: `cabinet_url = f"{cabinet_domain}/auth/{cabinet_token}"`
- Если `cabinet_token` нет: `cabinet_url = f"{cabinet_domain}/"` (ПРОБЛЕМА)

4. **Режимы предоставления**:

- `cabinet` - только личный кабинет (без подписки)
- `cabinet_subscription` - личный кабинет + подписка (нужен для показа subscription_link)

5. **Домен настроен**: `http://localhost:3003` (правильно для тестирования)

## Решение

### 1. Диагностика проблемы с токеном

**Файл**: `src/shop_bot/config.py`

**Проблема**: Токен может быть `None` если:

- `user_id` или `key_id` не переданы (проверка на строках 317, 150)
- Ошибка при создании токена (обрабатывается в except)
- `key_id` еще не создан в момент вызова функции

**Действия**:

- Проверить логи после покупки для выявления причины
- Убедиться, что `user_id` и `key_id` передаются корректно
- Проверить, что токен создается до вызова `get_purchase_success_text()`

### 2. Исправление логики создания токена

**Файл**: `src/shop_bot/bot/handlers.py`

**Проблема**: Токен создается дважды - в `handlers.py:6746` и в `get_purchase_success_text()`

**Решение**:

- Убрать дублирующее создание токена в `handlers.py:6746` (оно не используется)
- Оставить создание токена только в `get_purchase_success_text()` и `get_key_info_text()`
- ИЛИ: Передавать созданный токен в функцию (но это усложнит код)

**Рекомендация**: Оставить создание токена в функциях формирования текста, так как это централизованное место и логика уже там

### 3. Исправление отображения подписки

**Файл**: `src/shop_bot/config.py`

**Проблема**: Режим `cabinet` не показывает `subscription_link`

**Решение**:

- Для показа подписки использовать режим `cabinet_subscription`
- Проверить, что `subscription_link` передается в функцию
- Убедиться, что условие `elif provision_mode == 'cabinet_subscription' and subscription_link:` работает корректно

### 4. Проверка шаблонов БД

**Файл**: `src/shop_bot/data_manager/database.py`

**Факт**: Шаблоны БД используют `{subscription_link}` и `{cabinet_url}` (строки 2321-2326)

**Статус**: Шаблоны корректны, но не используются (функция `get_message_text()` не вызывается в handlers.py)

**Действие**: Оставить как есть - шаблоны готовы для будущего использования

## План действий

1. **Проверить логи после покупки** - найти причину отсутствия токена
2. **Убрать дублирующее создание токена** в `handlers.py:6746` (если не используется)
3. **Проверить передачу параметров** - убедиться, что `user_id` и `key_id` передаются корректно
4. **Проверить режим предоставления** - убедиться, что используется правильный режим для показа подписки
5. **Добавить проверку токена** - если токен не создан, логировать причину
6. **Протестировать на localhost** - убедиться, что ссылка содержит токен

## Файлы для изменения

- `src/shop_bot/config.py` - логика создания токена и формирования ссылки
- `src/shop_bot/bot/handlers.py` - убрать дублирующее создание токена (если не используется)
- Логи для диагностики - проверить после покупки

## Ожидаемый результат

1. Ссылка содержит токен: `http://localhost:3003/auth/{token}`
2. Подписка отображается при режиме `cabinet_subscription`
3. Логи показывают причину, если токен не создается
4. Код не содержит дублирования логики создания токена

### To-dos

- [ ] Создать структуру проекта apps/user-cabinet/
- [ ] Создать миграцию БД: таблица user_tokens
- [ ] Настроить Flask-приложение с базовыми роутами
- [ ] Создать Dockerfile для нового сервиса
- [ ] Добавить сервис в docker-compose.yml
- [ ] Реализовать генерацию токенов при создании ключа
- [ ] Создать middleware для проверки токенов с rate limiting
- [ ] Реализовать роут авторизации с проверкой активности подписки
- [ ] Добавить логирование доступа к кабинету
- [ ] Обновить CHANGELOG.md
- [ ] Проверить логи после покупки для выявления причины отсутствия токена
- [ ] Убрать дублирующее создание токена в handlers.py:6746 (если не используется)
- [ ] Проверить передачу user_id и key_id в get_purchase_success_text() и get_key_info_text()
- [ ] Проверить режим предоставления - убедиться, что используется правильный режим для показа подписки
- [ ] Добавить проверку токена - если токен не создан, логировать причину с подробностями
- [ ] Протестировать на localhost - убедиться, что ссылка содержит токен и подписка отображается