<!-- f8cd13bb-95c1-4066-8a7c-a508c38d8ec0 c397d8f5-2d9d-425f-a203-342f3d8c30aa -->
# Исправление CSP и отображения IP клиента в личном кабинете

## Проблемы

1. **CSP блокирует запросы**: В nginx конфигурации для user-cabinet отсутствуют домены `https://api.2ip.io` и `https://ipwho.is` в директиве `connect-src`, что блокирует прямые запросы из JavaScript браузера.

2. **Отображается IP сервера вместо IP клиента**: Серверные эндпоинты `/api/ip-info-ipwho` и `/api/ip-info-2ip` делают запросы с сервера, поэтому API возвращают IP сервера, а не IP клиента.

## Решение

### 1. Исправление CSP в nginx конфигурации

**Файл**: `deploy/nginx/dark-maximus.conf.tpl`

- Добавить `https://api.2ip.io` и `https://ipwho.is` в директиву `connect-src` для user-cabinet (строка 290)
- Также обновить CSP для health endpoint (строка 297)

**Текущая строка 290:**

```
connect-src 'self' https://api.2ip.ru https://${HELP_DOMAIN} https://*.${MAIN_DOMAIN};
```

**Исправленная строка:**

```
connect-src 'self' https://api.2ip.ru https://api.2ip.io https://ipwho.is https://${HELP_DOMAIN} https://*.${MAIN_DOMAIN};
```

### 2. Исправление серверных эндпоинтов для возврата IP клиента

**Файл**: `apps/user-cabinet/app.py`

**Проблема**: Эндпоинты `ip_info_ipwho()` и `ip_info_2ip()` делают запросы с сервера, поэтому API возвращают IP сервера.

**Решение**: Передавать IP клиента в заголовках запроса к API, если они поддерживают это, или использовать альтернативный подход.

**Для ipwho.is**: API поддерживает передачу IP клиента через заголовок `X-Forwarded-For` или параметр запроса. Нужно получить IP клиента из Flask `request` и передать его в запрос.

**Для api.2ip.io**: Проверить документацию API на поддержку передачи IP клиента. Если не поддерживается, использовать альтернативный подход.

**Изменения в `ip_info_ipwho()` (строки 310-346)**:

- Получить IP клиента из `request.environ.get('HTTP_X_FORWARDED_FOR', request.remote_addr)`
- Передать IP клиента в запрос к `ipwho.is` через параметр или заголовок (если поддерживается)

**Изменения в `ip_info_2ip()` (строки 349-382)**:

- Получить IP клиента из `request.environ.get('HTTP_X_FORWARDED_FOR', request.remote_addr)`
- Передать IP клиента в запрос к `api.2ip.io` через параметр или заголовок (если поддерживается)

**Альтернативный подход**: Если API не поддерживают передачу IP клиента, можно использовать другой сервис или модифицировать логику, чтобы возвращать IP клиента напрямую из заголовков Flask, а геолокацию получать через API по этому IP.

### 3. Синхронизация CSP в app.py

**Файл**: `apps/user-cabinet/app.py`

Убедиться, что CSP заголовки в `set_csp_headers()` (строка 120) также содержат `https://api.2ip.io` и `https://ipwho.is` для согласованности (хотя nginx перезаписывает эти заголовки).

## Порядок выполнения

1. Исправить CSP в nginx конфигурации (`deploy/nginx/dark-maximus.conf.tpl`)
2. Исправить серверные эндпоинты в `app.py` для возврата IP клиента
3. Проверить, что CSP в `app.py` также обновлен (для согласованности)
4. Перезагрузить nginx конфигурацию после изменений

## Тестирование

После исправлений проверить:

1. Отсутствие ошибок CSP в консоли браузера
2. Корректное отображение IP клиента (не IP сервера) в личном кабинете
3. Работу fallback через серверные эндпоинты, если прямые запросы не работают

### To-dos

- [ ] Добавить https://api.2ip.io и https://ipwho.is в connect-src директиву CSP в nginx конфигурации для user-cabinet (deploy/nginx/dark-maximus.conf.tpl, строки 290 и 297)
- [ ] Исправить серверные эндпоинты ip_info_ipwho() и ip_info_2ip() в app.py для возврата IP клиента вместо IP сервера (передавать IP клиента в запросы к API)
- [ ] Обновить CSP заголовки в set_csp_headers() в app.py для согласованности (добавить https://api.2ip.io и https://ipwho.is)