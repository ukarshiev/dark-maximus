<!-- 214266f9-2a7a-4f58-aed7-c4da9a124bd5 2b5253c4-5621-4771-8f30-521517a6107b -->
# Исправление обработки YooKassa

## Цели

- Исключить выдачу подписки, пока платеж не перешёл в `payment.succeeded` или не был явно захвачен.
- Обеспечить корректную фиксацию статусов платежей в нашей БД и на продовом сервере `root@31.56.27.129`.

## Детальный план

1. **Анализ текущей схемы платежа**

- Просмотреть `create_yookassa_payment_handler` в `src/shop_bot/bot/handlers.py`: какие поля уходим в YooKassa, какие метаданные сохраняются, кто вызывает `create_pending_transaction`.
- Проверить `_reconfigure_yookassa()` и `bot_controller.py`, чтобы зафиксировать используемый режим (test/prod) и убедиться, что SDK настроен корректно.
- Разобрать `process_successful_yookassa_payment`: определить, какие статусы и побочные эффекты (выдача ключей, обновление промокодов, статистики) она выполняет.

2. **Диагностика обработки вебхуков на продовом сервере**

- В `src/shop_bot/webhook_server/app.py` пройти ветки `payment.waiting_for_capture` и `payment.succeeded`; выписать условия, при которых вызывается `process_successful_yookassa_payment`.
- Убедиться, что при `waiting_for_capture` и `paid=false` всё равно происходит выдача подписки; зафиксировать конкретный фрагмент кода.
- Через SSH `root@31.56.27.129` (только чтение логов/БД) изучить логи (`logs/application.log.*`) и запись в таблице `transactions` (`get_transaction_by_payment_id` или sqlite3), чтобы подтвердить реальное поведение.

3. **Проектирование исправления**

- Согласовать стратегию: автоматический `capture` через SDK (`Payment.capture(payment_id)`) или ожидание вебхука `payment.succeeded` без выдачи подписки.
- Определить, какие данные нужно сохранить в БД для промежуточного состояния (например, причина ожидания capture).
- Прописать план логирования, чтобы видеть путь `pending → capture → succeeded`.

4. **Коррекция кода**

- В ветке `payment.waiting_for_capture` оставить вызов `process_successful_yookassa_payment` только при `paid=true`; иначе инициировать capture или просто логировать ожидание.
- Добавить вызов `Payment.capture(payment_id)` (если выбираем автоматический захват), обрабатывать исключения `yookassa.exceptions.ApiError`, не выдавая подписку при ошибках.
- В `payment.succeeded` убедиться, что `metadata` дополняется `yookassa_payment_id`, `rrn`, `authorization_code`, `payment_type` перед передачей в обработчик.
- При финальной обработке обновлять транзакцию через `update_yookassa_transaction`, а подписку выдавать ровно один раз.

5. **Валидация на проде**

- На `root@31.56.27.129` после деплоя выполнить тестовый платёж 1 RUB: проследить в логах и БД, что подписка появляется только после `payment.succeeded`.
- Проверить, что статус в YooKassa меняется на «Успешно», а в БД — `pending → paid` без промежуточной выдачи.
- Прогнать сценарий ручного повтора (`/transactions/retry/<payment_id>`), убедиться, что повторный запуск не дублирует подписку.

6. **Документация и сопутствующие задачи**

- Обновить `CHANGELOG.md` (новая версия, дата UTC+3) и `pyproject.toml` после фикса.
- Проверить необходимость обновления документации в `docs/` (описание платёжного флоу, страницы админки).