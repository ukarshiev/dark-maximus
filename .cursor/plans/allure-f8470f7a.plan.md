<!-- f8470f7a-a1a4-4857-8fef-122fa8193c52 ad93c22c-30a8-401a-981e-e3418a7567d6 -->
# Расширение описаний тестов Allure

## Цель

Расширить шаблон описаний тестов Allure и обновить все тесты с Allure декораторами для соответствия расширенному шаблону с детальными шагами, конкретными действиями и использованием allure.step().

## Обнаруженные файлы с Allure декораторами

### Интеграционные тесты (9 файлов, ~41 тест):

1. **tests/integration/test_vpn_purchase/test_full_purchase_flow.py** (6 тестов)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_full_purchase_flow_new_user
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_full_purchase_flow_with_promo
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_full_purchase_flow_with_referral
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_key_creation_after_payment
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_key_extension_after_payment
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_failed_payment_handling

2. **tests/integration/test_payments/test_ton_connect_flow.py** (4 теста)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_ton_connect_full_flow
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_ton_transaction_verification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_ton_wallet_connection
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_ton_connect_error_handling

3. **tests/integration/test_payments/test_webhook_handling.py** (6 тестов)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_yookassa_webhook_signature_verification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_cryptobot_webhook_signature_verification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_heleket_webhook_signature_verification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_webhook_retry_mechanism
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_webhook_idempotency
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_webhook_error_handling

4. **tests/integration/test_web_panel/test_admin_workflow.py** (6 тестов)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_admin_full_workflow
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_admin_dashboard_access
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_admin_users_section
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_admin_keys_section
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_admin_settings_section
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_admin_logout

5. **tests/integration/test_payments/test_balance_flow.py** (3 теста)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_balance_payment_full_flow ✅ (уже детальное описание)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_balance_topup
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_insufficient_balance_handling

6. **tests/integration/test_payments/test_cryptobot_flow.py** (4 теста)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_cryptobot_full_flow ✅ (уже детальное описание)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_cryptobot_webhook_handling
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_cryptobot_webhook_signature_verification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_cryptobot_payment_idempotency

7. **tests/integration/test_payments/test_stars_flow.py** (4 теста)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_stars_full_flow
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_stars_pre_checkout_validation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_stars_successful_payment
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_stars_payment_verification

8. **tests/integration/test_payments/test_heleket_flow.py** (4 теста)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_heleket_full_flow
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_heleket_webhook_handling
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_heleket_invoice_verification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_heleket_payment_idempotency

9. **tests/integration/test_payments/test_yookassa_flow.py** (4 теста)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_yookassa_full_flow ✅ (уже детальное описание)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_yookassa_webhook_handling
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_yookassa_payment_verification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_yookassa_payment_idempotency

## Этапы выполнения

### Этап 1: Расширение шаблона описаний

**Файл:** `docs/guides/testing/allure-test-description-template.md`

**Изменения:**

- Добавить раздел "Тестовые данные" с описанием входных данных
- Расширить раздел "Шаги теста" с указанием:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Конкретных методов/функций, которые вызываются
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Параметров вызовов
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Ожидаемых значений на каждом шаге
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Проверяемых атрибутов/полей
- Добавить раздел "Проверяемые граничные случаи" (если применимо)
- Добавить раздел "Используемые моки и фикстуры" с детальным описанием
- Добавить рекомендации по использованию allure.step() для каждого шага
- Добавить примеры для разных типов тестов (платежи, VPN, веб-панель)

### Этап 2: Обновление тестов покупки VPN

**Файл:** `tests/integration/test_vpn_purchase/test_full_purchase_flow.py`

**Тесты для обновления (6 тестов):**

1. test_full_purchase_flow_new_user
2. test_full_purchase_flow_with_promo
3. test_full_purchase_flow_with_referral
4. test_key_creation_after_payment
5. test_key_extension_after_payment
6. test_failed_payment_handling

**Что добавить:**

- Детальное описание каждого шага (создание пользователя, создание плана, обработка платежа, создание ключа)
- Конкретные методы и их параметры
- Проверки на каждом этапе
- allure.step() для каждого значимого действия

### Этап 3: Обновление тестов платежных систем

**Файлы:**

- `tests/integration/test_payments/test_ton_connect_flow.py` (4 теста)
- `tests/integration/test_payments/test_stars_flow.py` (4 теста)
- `tests/integration/test_payments/test_heleket_flow.py` (4 теста)
- `tests/integration/test_payments/test_cryptobot_flow.py` (3 теста - 1 уже готов)
- `tests/integration/test_payments/test_yookassa_flow.py` (3 теста - 1 уже готов)
- `tests/integration/test_payments/test_balance_flow.py` (2 теста - 1 уже готов)
- `tests/integration/test_payments/test_webhook_handling.py` (6 тестов)

**Что добавить:**

- Детальное описание flow каждого платежного метода
- Конкретные эндпоинты и параметры webhook
- Описание проверки подписей и валидации
- Шаги обработки платежа с allure.step()

### Этап 4: Обновление тестов веб-панели

**Файл:** `tests/integration/test_web_panel/test_admin_workflow.py`

**Тесты для обновления (6 тестов):**

1. test_admin_full_workflow ✅ (уже детальное описание)
2. test_admin_dashboard_access
3. test_admin_users_section
4. test_admin_keys_section
5. test_admin_settings_section
6. test_admin_logout

**Что добавить:**

- Детальное описание каждого эндпоинта
- Проверки ответов и статусов
- Описание используемых моков для БД
- allure.step() для каждого запроса

## Структура расширенного описания

```python
@allure.description("""
**Что проверяется:**
- Конкретная функциональность или сценарий
- Бизнес-логика, которая тестируется

**Тестовые данные:**
- Входные параметры (user_id, payment_id, plan_id и т.д.)
- Значения фикстур (temp_db, test_setup)
- Моки и их возвращаемые значения

**Шаги теста:**
1. **Название шага**
   - Метод/функция: database.register_user_if_not_exists()
   - Параметры: user_id=123456789, username="test_user"
   - Ожидаемый результат: пользователь создан в БД
   - Проверка: database.get_user(123456789) возвращает объект пользователя
   
2. **Следующий шаг**
   - Метод/функция: bot.handlers.process_successful_payment()
   - Параметры: bot=mock_bot, metadata={...}
   - Ожидаемый результат: ключ создан на хосте
   - Проверка: database.get_user_keys(user_id) возвращает список с ключом

**Предусловия:**
- Что должно быть готово перед запуском теста
- Какие данные должны существовать в БД
- Какие моки/фикстуры используются и что они возвращают
- Настройки окружения (временная БД, отключенные проверки)

**Используемые моки и фикстуры:**
- temp_db: временная SQLite БД с полной структурой таблиц
- mock_bot: мок aiogram.Bot с методами send_message, edit_message_text
- mock_xui_api: мок py3xui.Api с методами create_or_update_key_on_host
- test_setup: фикстура создает пользователя, хост и план

**Проверяемые граничные случаи:** (если применимо)
- Обработка ошибок при недостаточном балансе
- Валидация некорректных данных
- Повторная обработка того же платежа (идемпотентность)

**Ожидаемый результат:**
- Что должно произойти в итоге
- Какие данные должны быть созданы/изменены в БД
- Какие статусы должны быть возвращены
- Какие ключи должны быть созданы
""")
```

## Приоритет обновления

1. **Высокий приоритет** (критичные тесты):

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_full_purchase_flow_new_user
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_yookassa_full_flow (уже готов)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_cryptobot_full_flow (уже готов)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_balance_payment_full_flow (уже готов)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - test_admin_full_workflow (уже готов)

2. **Средний приоритет** (важные тесты):

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Все тесты webhook handling
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Тесты создания и продления ключей
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Тесты с промокодами и рефералами

3. **Низкий приоритет** (дополнительные тесты):

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Тесты обработки ошибок
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Тесты валидации
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Тесты идемпотентности

## Критерии качества

После обновления каждый тест должен:

- ✅ Иметь детальное описание с разделами из расширенного шаблона
- ✅ Содержать конкретные методы и параметры в шагах
- ✅ Использовать allure.step() для каждого значимого действия
- ✅ Описывать все проверки и ожидаемые результаты
- ✅ Указывать используемые моки и фикстуры
- ✅ Быть понятным без чтения кода теста

### To-dos

- [ ] Расширить шаблон allure-test-description-template.md: добавить разделы Тестовые данные, Используемые моки, Проверяемые граничные случаи, детализировать Шаги теста
- [ ] Обновить 6 тестов в test_full_purchase_flow.py: добавить детальные описания с конкретными шагами и allure.step()
- [ ] Обновить 4 теста в test_ton_connect_flow.py: добавить детальные описания flow TON Connect
- [ ] Обновить 4 теста в test_stars_flow.py: добавить детальные описания flow Telegram Stars
- [ ] Обновить 4 теста в test_heleket_flow.py: добавить детальные описания flow Heleket
- [ ] Обновить 6 тестов в test_webhook_handling.py: добавить детальные описания проверки подписей и обработки webhook
- [ ] Обновить 3 оставшихся теста в test_cryptobot_flow.py (1 уже готов)
- [ ] Обновить 3 оставшихся теста в test_yookassa_flow.py (1 уже готов)
- [ ] Обновить 2 оставшихся теста в test_balance_flow.py (1 уже готов)
- [ ] Обновить 5 оставшихся тестов в test_admin_workflow.py (1 уже готов)