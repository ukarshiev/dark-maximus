<!-- fb3ada3d-d94c-467f-9b4a-2909640ef0a8 1082f7bb-4e71-466b-bcea-bb36d00ba701 -->
# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ (PRODUCTION-SAFE)

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ù–¶–ò–ü–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:

1. **Backward Compatibility** ‚Äî —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
2. **Feature Flags** ‚Äî –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
3. **Rollback Ready** ‚Äî –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö
4. **Zero Downtime** ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
5. **Testing First** ‚Äî —Ç–µ—Å—Ç—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º

---

## –†–µ–∑—é–º–µ –∑–∞–¥–∞—á–∏:

### –ü—Ä–æ–±–ª–µ–º–∞

–°–∏—Å—Ç–µ–º–∞ —Å–º–µ—à–∏–≤–∞–µ—Ç UTC –∏ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ `expiry_date`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:

- –ü—Ä–æ–ø—É—Å–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞ 24—á/1—á –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- –ó–∞–¥–µ—Ä–∂–∫–∞–º –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è –Ω–∞ ~3 —á–∞—Å–∞

### –†–µ—à–µ–Ω–∏–µ

1. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ** ‚Äî –≤—Å–µ –¥–∞—Ç—ã –≤ –ë–î —Ç–æ–ª—å–∫–æ –≤ UTC
2. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ** ‚Äî –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—Ä–µ–º—è –≤ —Å–≤–æ—ë–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
3. **–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É** ‚Äî –≤—ã–±–æ—Ä —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

### –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏ –∏–∑ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:

- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `zoneinfo` (–≤—Å—Ç—Ä–æ–µ–Ω –≤ Python 3.9+) –≤–º–µ—Å—Ç–æ `pytz`
- ‚úÖ SQLite `ALTER TABLE ADD COLUMN` –±–µ–∑–æ–ø–∞—Å–Ω–∞ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- ‚úÖ –•—Ä–∞–Ω–∏—Ç—å UTC, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏
- ‚úÖ Feature flag –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è

---

## –≠–¢–ê–ü 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –∑–∞—â–∏—Ç–∞ (–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô)

### 0.1. –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î

**–°–∫—Ä–∏–ø—Ç:** `tests/backup_before_timezone_migration.py`

```python
import shutil
from datetime import datetime
shutil.copy('users.db', f'users_backup_{datetime.now().strftime("%Y%m%d_%H%M%S")}.db')
```

### 0.2. –î–æ–±–∞–≤–∏—Ç—å feature flag

**–§–∞–π–ª:** `src/shop_bot/data_manager/database.py`

```python
def is_timezone_feature_enabled() -> bool:
    """Feature flag –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è timezone —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏."""
    try:
        setting = get_setting('feature_timezone_enabled')
        return setting == '1' if setting else False
    except:
        return False
```

**–í bot_settings –¥–æ–±–∞–≤–∏—Ç—å:**

```sql
INSERT INTO bot_settings (key, value) VALUES ('feature_timezone_enabled', '0');
```

### 0.3. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É

–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î –≤ —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

---

## –≠–¢–ê–ü 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤ (–ü–†–ò–û–†–ò–¢–ï–¢: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô)

### 1.1. –°–æ–∑–¥–∞—Ç—å helper-–º–æ–¥—É–ª—å —Å backward compatibility

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `src/shop_bot/utils/datetime_utils.py`

```python
from datetime import datetime, timezone, timedelta
from zoneinfo import ZoneInfo
from typing import Optional

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è Moscow timezone (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
MOSCOW_TZ = ZoneInfo("Europe/Moscow")
DEFAULT_TIMEZONE = "Europe/Moscow"

def ensure_utc_datetime(dt: datetime) -> datetime:
    """
    –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ datetime –≤ UTC –±–µ–∑ tzinfo.
    –ë–ï–ó–û–ü–ê–°–ù–û –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö.
    """
    if dt is None:
        return None
    
    # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å tzinfo, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ UTC
    if dt.tzinfo is not None:
        return dt.astimezone(timezone.utc).replace(tzinfo=None)
    
    # –ï—Å–ª–∏ tzinfo –Ω–µ—Ç, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º UTC (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    return dt

def timestamp_to_utc_datetime(timestamp_ms: int) -> datetime:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç timestamp –≤ UTC datetime –±–µ–∑ tzinfo."""
    return datetime.fromtimestamp(timestamp_ms / 1000, tz=timezone.utc).replace(tzinfo=None)

def format_datetime_moscow(dt: datetime) -> str:
    """
    LEGACY —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç datetime –≤ Moscow time.
    """
    if dt is None:
        return ""
    
    if dt.tzinfo is None:
        dt = dt.replace(tzinfo=timezone.utc)
    
    dt_moscow = dt.astimezone(MOSCOW_TZ)
    return dt_moscow.strftime('%d.%m.%Y –≤ %H:%M')

def format_datetime_for_user(dt: datetime, user_id: int) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç datetime —Å —É—á—ë—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç feature flag –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è.
    """
    from shop_bot.data_manager.database import is_timezone_feature_enabled, get_user_timezone
    
    if dt is None:
        return ""
    
    # –ï—Å–ª–∏ feature flag –≤—ã–∫–ª—é—á–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º Moscow time
    if not is_timezone_feature_enabled():
        return format_datetime_moscow(dt)
    
    # –ü–æ–ª—É—á–∞–µ–º timezone –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        tz_name = get_user_timezone(user_id) or DEFAULT_TIMEZONE
        user_tz = ZoneInfo(tz_name)
    except:
        # Fallback –Ω–∞ Moscow –ø—Ä–∏ –æ—à–∏–±–∫–µ
        user_tz = MOSCOW_TZ
    
    if dt.tzinfo is None:
        dt = dt.replace(tzinfo=timezone.utc)
    
    dt_local = dt.astimezone(user_tz)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UTC offset –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
    offset = dt_local.strftime('%z')
    offset_formatted = f"UTC{offset[:3]}:{offset[3:]}"
    
    return f"{dt_local.strftime('%d.%m.%Y –≤ %H:%M')} ({offset_formatted})"
```

### 1.2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å expiry_date (—Å –∑–∞—â–∏—Ç–æ–π)

**–§–∞–π–ª:** `src/shop_bot/data_manager/database.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `update_key_info()`:**

```python
def update_key_info(key_id: int, new_xui_uuid: str, new_expiry_ms: int, subscription_link: str = None):
    try:
        from shop_bot.utils.datetime_utils import timestamp_to_utc_datetime
        
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()
            
            # –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º UTC
            expiry_date = timestamp_to_utc_datetime(new_expiry_ms)
            
            # –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
```

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:**

- `update_key_status_from_server()` (—Å—Ç—Ä–æ–∫–∞ ~5439)
- `add_new_key()` (—Å—Ç—Ä–æ–∫–∞ ~5143)

### 1.3. –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `tests/migrate_expiry_dates_to_utc.py`

```python
#!/usr/bin/env python3
"""
–ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö expiry_date –≤ UTC.
–ë–ï–ó–û–ü–ê–°–ù–û: –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ, —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ.
"""
import sqlite3
from datetime import datetime, timezone, timedelta

DB_FILE = "users.db"

def analyze_and_fix_expiry_dates(dry_run=True):
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç expiry_date.
    dry_run=True: —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    dry_run=False: –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
    """
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏
    cursor.execute("SELECT key_id, expiry_date, created_date FROM vpn_keys")
    keys = cursor.fetchall()
    
    issues_found = 0
    fixed = 0
    
    for key_id, expiry_str, created_str in keys:
        try:
            expiry = datetime.fromisoformat(expiry_str)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ timezone info
            if expiry.tzinfo is not None:
                # –ï—Å–ª–∏ –µ—Å—Ç—å timezone, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ UTC
                expiry_utc = expiry.astimezone(timezone.utc).replace(tzinfo=None)
                
                if not dry_run:
                    cursor.execute(
                        "UPDATE vpn_keys SET expiry_date = ? WHERE key_id = ?",
                        (expiry_utc, key_id)
                    )
                    fixed += 1
                
                issues_found += 1
                print(f"Key {key_id}: {expiry_str} -> {expiry_utc}")
        
        except Exception as e:
            print(f"Error processing key {key_id}: {e}")
    
    if not dry_run:
        conn.commit()
    
    conn.close()
    
    print(f"\nAnalysis complete:")
    print(f"Issues found: {issues_found}")
    print(f"Fixed: {fixed}")
    print(f"Mode: {'DRY RUN' if dry_run else 'APPLIED'}")

if __name__ == "__main__":
    # –°–Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑
    print("=== DRY RUN ===")
    analyze_and_fix_expiry_dates(dry_run=True)
    
    # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
    # print("\n=== APPLYING FIXES ===")
    # analyze_and_fix_expiry_dates(dry_run=False)
```

---

## –≠–¢–ê–ü 2: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–ü–†–ò–û–†–ò–¢–ï–¢: –í–´–°–û–ö–ò–ô, –ë–ï–ó–û–ü–ê–°–ù–û)

### 2.1. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É timezone –≤ users (–ë–ï–ó–û–ü–ê–°–ù–û)

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `tests/add_timezone_column.py`

```python
import sqlite3

DB_FILE = "users.db"

def add_timezone_column():
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É timezone –≤ users.
    –ë–ï–ó–û–ü–ê–°–ù–û: ALTER TABLE ADD COLUMN –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –≤ SQLite.
    """
    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–æ–ª–æ–Ω–∫–∞
        cursor.execute("PRAGMA table_info(users)")
        columns = [row[1] for row in cursor.fetchall()]
        
        if 'timezone' not in columns:
            cursor.execute(
                "ALTER TABLE users ADD COLUMN timezone TEXT DEFAULT 'Europe/Moscow'"
            )
            conn.commit()
            print("‚úÖ Column 'timezone' added successfully")
        else:
            print("‚ÑπÔ∏è Column 'timezone' already exists")
        
        conn.close()
        return True
    
    except Exception as e:
        print(f"‚ùå Error: {e}")
        return False

if __name__ == "__main__":
    add_timezone_column()
```

### 2.2. –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ bot_settings

```sql
-- Feature flag (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω)
INSERT OR IGNORE INTO bot_settings (key, value) VALUES ('feature_timezone_enabled', '0');

-- Admin timezone
INSERT OR IGNORE INTO bot_settings (key, value) VALUES ('admin_timezone', 'Europe/Moscow');
```

### 2.3. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ database.py (—Å feature flag)

```python
def get_user_timezone(user_id: int) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    try:
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT timezone FROM users WHERE telegram_id = ?", (user_id,))
            row = cursor.fetchone()
            return row[0] if row and row[0] else 'Europe/Moscow'
    except:
        return 'Europe/Moscow'

def set_user_timezone(user_id: int, timezone: str) -> bool:
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è timezone
        from zoneinfo import ZoneInfo
        ZoneInfo(timezone)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
        
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()
            cursor.execute(
                "UPDATE users SET timezone = ? WHERE telegram_id = ?",
                (timezone, user_id)
            )
            conn.commit()
            return True
    except:
        return False
```

---

## –≠–¢–ê–ü 3: Telegram-–±–æ—Ç ‚Äî –≤—ã–±–æ—Ä —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ (–ü–†–ò–û–†–ò–¢–ï–¢: –í–´–°–û–ö–ò–ô)

### 3.1. –û–±–Ω–æ–≤–∏—Ç—å "–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å" (–ë–ï–ó EMAIL)

**–§–∞–π–ª:** `src/shop_bot/bot/handlers.py`

```python
# –¢–µ–∫—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è (–û–ë–ù–û–í–õ–Å–ù–ù–´–ô):
profile_text = f"""
üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å

üîÑ –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Å –±–∞–ª–∞–Ω—Å–∞: {'–í–∫–ª—é—á–µ–Ω–æ' if auto_renewal else '–í—ã–∫–ª—é—á–µ–Ω–æ'}
üåç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: {timezone_display}
üí∞ –ë–∞–ª–∞–Ω—Å: {balance:.2f} RUB
"""

# –ì–¥–µ timezone_display:
from shop_bot.utils.datetime_utils import get_timezone_display
timezone_display = get_timezone_display(user_id)  # "UTC+3 (–ú–æ—Å–∫–≤–∞, –°—Ç–∞–º–±—É–ª)"
```

### 3.2. –°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `src/shop_bot/data/timezones.py`

```python
TIMEZONES = [
    {"offset": "-11", "cities": "–°–∞–º–æ–∞", "iana": "Pacific/Samoa"},
    {"offset": "-10", "cities": "–ì–æ–Ω–æ–ª—É–ª—É", "iana": "Pacific/Honolulu"},
    {"offset": "-9", "cities": "–ê–Ω–∫–æ—Ä–∏–¥–∂", "iana": "America/Anchorage"},
    {"offset": "-8", "cities": "–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å, –í–∞–Ω–∫—É–≤–µ—Ä", "iana": "America/Los_Angeles"},
    {"offset": "-7", "cities": "–î–µ–Ω–≤–µ—Ä, –§–µ–Ω–∏–∫—Å", "iana": "America/Denver"},
    {"offset": "-6", "cities": "–ß–∏–∫–∞–≥–æ, –ú–µ—Ö–∏–∫–æ", "iana": "America/Chicago"},
    {"offset": "-5", "cities": "–ù—å—é-–ô–æ—Ä–∫, –¢–æ—Ä–æ–Ω—Ç–æ", "iana": "America/New_York"},
    {"offset": "-4", "cities": "–ö–∞—Ä–∞–∫–∞—Å, –°–∞–Ω—Ç—å—è–≥–æ", "iana": "America/Caracas"},
    {"offset": "-3", "cities": "–ë—É—ç–Ω–æ—Å-–ê–π—Ä–µ—Å, –°–∞–Ω-–ü–∞—É–ª—É", "iana": "America/Argentina/Buenos_Aires"},
    {"offset": "-2", "cities": "–°—Ä–µ–¥–Ω—è—è –ê—Ç–ª–∞–Ω—Ç–∏–∫–∞", "iana": "Atlantic/South_Georgia"},
    {"offset": "-1", "cities": "–ê–∑–æ—Ä—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞", "iana": "Atlantic/Azores"},
    {"offset": "+0", "cities": "–õ–æ–Ω–¥–æ–Ω, –î—É–±–ª–∏–Ω", "iana": "Europe/London"},
    {"offset": "+1", "cities": "–ë–µ—Ä–ª–∏–Ω, –ü–∞—Ä–∏–∂", "iana": "Europe/Berlin"},
    {"offset": "+2", "cities": "–ö–∏–µ–≤, –ê—Ñ–∏–Ω—ã, –¢–∞–ª–ª–∏–Ω", "iana": "Europe/Kiev"},
    {"offset": "+3", "cities": "–ú–æ—Å–∫–≤–∞, –°—Ç–∞–º–±—É–ª", "iana": "Europe/Moscow"},
    {"offset": "+4", "cities": "–î—É–±–∞–π, –ë–∞–∫—É", "iana": "Asia/Dubai"},
    {"offset": "+5", "cities": "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –ö–∞—Ä–∞—á–∏", "iana": "Asia/Yekaterinburg"},
    {"offset": "+6", "cities": "–ê–ª–º–∞—Ç—ã, –û–º—Å–∫, –ë–∏—à–∫–µ–∫", "iana": "Asia/Almaty"},
    {"offset": "+7", "cities": "–ë–∞–Ω–≥–∫–æ–∫, –î–∂–∞–∫–∞—Ä—Ç–∞, –ù–æ–≤–æ—Å–∏–±.", "iana": "Asia/Novosibirsk"},
    {"offset": "+8", "cities": "–ü–µ–∫–∏–Ω, –°–∏–Ω–≥–∞–ø—É—Ä, –ò—Ä–∫—É—Ç—Å–∫", "iana": "Asia/Shanghai"},
    {"offset": "+9", "cities": "–¢–æ–∫–∏–æ, –°–µ—É–ª, –Ø–∫—É—Ç—Å–∫", "iana": "Asia/Tokyo"},
    {"offset": "+10", "cities": "–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫, –°–∏–¥–Ω–µ–π", "iana": "Australia/Sydney"},
    {"offset": "+11", "cities": "–ú–∞–≥–∞–¥–∞–Ω, –°–æ–ª–æ–º–æ–Ω–æ–≤—ã –æ-–≤–∞", "iana": "Pacific/Guadalcanal"},
    {"offset": "+12", "cities": "–û–∫–ª–µ–Ω–¥, –§–∏–¥–∂–∏", "iana": "Pacific/Auckland"},
]

TIMEZONES_PER_PAGE = 10

def get_timezone_page(page: int = 0):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã."""
    start = page * TIMEZONES_PER_PAGE
    end = start + TIMEZONES_PER_PAGE
    return TIMEZONES[start:end]

def get_total_pages():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü."""
    return (len(TIMEZONES) + TIMEZONES_PER_PAGE - 1) // TIMEZONES_PER_PAGE
```

### 3.3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é (10 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É)

**–§–∞–π–ª:** `src/shop_bot/bot/keyboards.py`

```python
def create_timezone_selection_keyboard(page: int = 0):
    """–°–æ–∑–¥–∞—ë—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    from shop_bot.data.timezones import get_timezone_page, get_total_pages, TIMEZONES_PER_PAGE
    
    builder = InlineKeyboardBuilder()
    
    timezones = get_timezone_page(page)
    total_pages = get_total_pages()
    
    # –ö–Ω–æ–ø–∫–∏ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤
    for tz in timezones:
        button_text = f"UTC{tz['offset']}  | {tz['cities']}"
        callback_data = f"tz_select_{tz['iana']}"
        builder.button(text=button_text, callback_data=callback_data)
    
    builder.adjust(1)  # –ü–æ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–µ –≤ —Ä—è–¥
    
    # –ù–∞–≤–∏–≥–∞—Ü–∏—è
    nav_buttons = []
    
    if page > 0:
        nav_buttons.append(("‚óÄ –ü—Ä–µ–¥.", f"tz_page_{page-1}"))
    
    nav_buttons.append((f"–°—Ç—Ä.{page+1}/{total_pages}", "tz_page_current"))
    
    if page < total_pages - 1:
        nav_buttons.append(("–°–ª–µ–¥ ‚ñ∂", f"tz_page_{page+1}"))
    
    for text, data in nav_buttons:
        builder.button(text=text, callback_data=data)
    
    builder.adjust(len(nav_buttons))
    
    # –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
    builder.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="profile")
    
    return builder.as_markup()
```

### 3.4. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞

**–§–∞–π–ª:** `src/shop_bot/bot/handlers.py`

```python
@router.callback_query(F.data.startswith("tz_select_"))
async def timezone_select_handler(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞."""
    from zoneinfo import ZoneInfo
    from datetime import datetime, timezone
    
    tz_name = callback.data.replace("tz_select_", "")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
        user_tz = ZoneInfo(tz_name)
        now_utc = datetime.now(timezone.utc)
        now_local = now_utc.astimezone(user_tz)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º offset
        offset = now_local.strftime('%z')
        offset_formatted = f"UTC{offset[:3]}:{offset[3:]}"
        
        # –ù–∞—Ö–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤
        from shop_bot.data.timezones import TIMEZONES
        tz_info = next((tz for tz in TIMEZONES if tz['iana'] == tz_name), None)
        cities = tz_info['cities'] if tz_info else tz_name
        
        text = f"""
–í—ã –≤—ã–±—Ä–∞–ª–∏: {offset_formatted} | {cities}

–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Ç–∞–º: {now_local.strftime('%H:%M')} ({offset_formatted})

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å?
"""
        
        builder = InlineKeyboardBuilder()
        builder.button(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"tz_confirm_{tz_name}")
        builder.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="timezone_change")
        builder.adjust(2)
        
        await callback.message.edit_text(text, reply_markup=builder.as_markup())
        
    except Exception as e:
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞", show_alert=True)

@router.callback_query(F.data.startswith("tz_confirm_"))
async def timezone_confirm_handler(callback: CallbackQuery):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞."""
    from shop_bot.data_manager.database import set_user_timezone
    
    tz_name = callback.data.replace("tz_confirm_", "")
    user_id = callback.from_user.id
    
    if set_user_timezone(user_id, tz_name):
        await callback.answer("‚úÖ –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω", show_alert=True)
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å
        await show_profile(callback.message, user_id)
    else:
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", show_alert=True)
```

---

## –≠–¢–ê–ü 4: –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ü–†–ò–û–†–ò–¢–ï–¢: –°–†–ï–î–ù–ò–ô)

### 4.1. –î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏

**–§–∞–π–ª:** `src/shop_bot/webhook_server/templates/settings.html`

```html
<div class="form-group">
  <label for="admin_timezone">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–∞–Ω–µ–ª–∏</label>
  <select name="admin_timezone" id="admin_timezone" class="form-control">
    <option value="Europe/London">UTC+0 (–õ–æ–Ω–¥–æ–Ω)</option>
    <option value="Europe/Berlin">UTC+1 (–ë–µ—Ä–ª–∏–Ω)</option>
    <option value="Europe/Kiev">UTC+2 (–ö–∏–µ–≤)</option>
    <option value="Europe/Moscow" selected>UTC+3 (–ú–æ—Å–∫–≤–∞)</option>
    <option value="Asia/Dubai">UTC+4 (–î—É–±–∞–π)</option>
    <option value="Asia/Yekaterinburg">UTC+5 (–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥)</option>
    <option value="Asia/Almaty">UTC+6 (–ê–ª–º–∞—Ç—ã)</option>
    <option value="Asia/Novosibirsk">UTC+7 (–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫)</option>
    <option value="Asia/Shanghai">UTC+8 (–ü–µ–∫–∏–Ω)</option>
    <option value="Asia/Tokyo">UTC+9 (–¢–æ–∫–∏–æ)</option>
    <option value="Australia/Sydney">UTC+10 (–°–∏–¥–Ω–µ–π)</option>
  </select>
  <small class="form-text text-muted">
    –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
  </small>
</div>
```

---

## –≠–¢–ê–ü 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç (–ü–†–ò–û–†–ò–¢–ï–¢: –í–´–°–û–ö–ò–ô)

### 5.1. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –∑–∞–º–µ–Ω–∞ (—Å feature flag)

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**

1. –°–Ω–∞—á–∞–ª–∞ –∑–∞–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ –Ω–æ–≤—ã—Ö –º–µ—Å—Ç–∞—Ö
2. –ü–æ—Ç–æ–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å feature flag –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è

**–ü—Ä–∏–º–µ—Ä:**

```python
# –°–¢–ê–†–´–ô –ö–û–î (—Ä–∞–±–æ—Ç–∞–µ—Ç):
expiry_str = expiry_date.strftime('%d.%m.%Y –≤ %H:%M')

# –ù–û–í–´–ô –ö–û–î (—Å feature flag):
from shop_bot.utils.datetime_utils import format_datetime_for_user
expiry_str = format_datetime_for_user(expiry_date, user_id)
# –ï—Å–ª–∏ feature flag –≤—ã–∫–ª—é—á–µ–Ω, –≤–µ—Ä–Ω—ë—Ç Moscow time (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
```

---

## –≠–¢–ê–ü 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ü–†–ò–û–†–ò–¢–ï–¢: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô)

### 6.1. Unit —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_timezone_utils.py`

```python
import unittest
from datetime import datetime, timezone
from shop_bot.utils.datetime_utils import (
    ensure_utc_datetime,
    timestamp_to_utc_datetime,
    format_datetime_moscow
)

class TestTimezoneUtils(unittest.TestCase):
    def test_ensure_utc_datetime(self):
        # –¢–µ—Å—Ç —Å UTC datetime
        dt_utc = datetime(2025, 11, 7, 12, 0, 0, tzinfo=timezone.utc)
        result = ensure_utc_datetime(dt_utc)
        self.assertIsNone(result.tzinfo)
        self.assertEqual(result.hour, 12)
        
        # –¢–µ—Å—Ç —Å naive datetime (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º UTC)
        dt_naive = datetime(2025, 11, 7, 12, 0, 0)
        result = ensure_utc_datetime(dt_naive)
        self.assertEqual(result, dt_naive)
    
    def test_timestamp_to_utc_datetime(self):
        # 2025-11-07 12:00:00 UTC
        timestamp_ms = 1730980800000
        result = timestamp_to_utc_datetime(timestamp_ms)
        self.assertIsNone(result.tzinfo)
        self.assertEqual(result.year, 2025)
```

### 6.2. Integration —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_timezone_integration.py`

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

- –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ UTC –≤ –ë–î
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- –°–º–µ–Ω–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

### 6.3. –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ß–µ–∫–ª–∏—Å—Ç:**

- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á —Å –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ 1 —á–∞—Å
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –ë–î –≤—Ä–µ–º—è –≤ UTC
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 1 —á–∞—Å (–¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ –≤–æ–≤—Ä–µ–º—è)
- [ ] –°–º–µ–Ω–∏—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –Ω–∞ UTC+10
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ

---

## –≠–¢–ê–ü 7: –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ (PRODUCTION-SAFE)

### 7.1. Pre-deployment —á–µ–∫–ª–∏—Å—Ç

- [ ] –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ë–î —Å–æ–∑–¥–∞–Ω–∞
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] Feature flag = 0 (–≤—ã–∫–ª—é—á–µ–Ω)
- [ ] Rollback –ø–ª–∞–Ω –≥–æ—Ç–æ–≤

### 7.2. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ (–ø–æ—ç—Ç–∞–ø–Ω–æ–µ)

1. **–î–µ–Ω—å 1:** –î–µ–ø–ª–æ–π –∫–æ–¥–∞ —Å feature flag = 0

   - –ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ legacy —Ä–µ–∂–∏–º–µ
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫

2. **–î–µ–Ω—å 2:** –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É timezone

   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

3. **–î–µ–Ω—å 3:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å expiry_date

   - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å

4. **–î–µ–Ω—å 4:** –í–∫–ª—é—á–∏—Ç—å feature flag –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

   - `feature_timezone_enabled = 1` —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

5. **–î–µ–Ω—å 5+:** –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö

   - –í–∫–ª—é—á–∏—Ç—å –¥–ª—è 10% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   - –í–∫–ª—é—á–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö

### 7.3. Rollback –ø–ª–∞–Ω

**–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:**

```sql
-- 1. –í—ã–∫–ª—é—á–∏—Ç—å feature flag
UPDATE bot_settings SET value = '0' WHERE key = 'feature_timezone_enabled';

-- 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î –∏–∑ –±—ç–∫–∞–ø–∞ (–µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ)
-- cp users_backup_YYYYMMDD_HHMMSS.db users.db

-- 3. –û—Ç–∫–∞—Ç–∏—Ç—å –∫–æ–¥ (git)
-- git revert <commit_hash>
```

---

## –≠–¢–ê–ü 8: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### 8.1. –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–¥–æ–ª–∂–Ω–æ = 0)
- –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ—á–Ω—ã–º)
- –û—à–∏–±–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ë–î

### 8.2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏:

- –ü—Ä–∏ —Å–º–µ–Ω–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- –ü—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ (–µ—Å–ª–∏ –æ—à–∏–±–∫–∞)
- –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Å —É–∫–∞–∑–∞–Ω–∏–µ–º timezone)

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```toml
# pyproject.toml
dependencies = [
    # zoneinfo –≤—Å—Ç—Ä–æ–µ–Ω –≤ Python 3.9+
    # –î–ª—è Python 3.8 –¥–æ–±–∞–≤–∏—Ç—å:
    # "backports.zoneinfo>=0.2.1; python_version<'3.9'",
]
```

---

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–ë–ï–ó–û–ü–ê–°–ù–´–ô):

1. ‚úÖ **–≠—Ç–∞–ø 0** ‚Äî –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–±—ç–∫–∞–ø—ã, feature flags)
2. ‚úÖ **–≠—Ç–∞–ø 6.1** ‚Äî –°–æ–∑–¥–∞—Ç—å unit —Ç–µ—Å—Ç—ã
3. ‚úÖ **–≠—Ç–∞–ø 1** ‚Äî –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ (—Å backward compatibility)
4. ‚úÖ **–≠—Ç–∞–ø 2** ‚Äî –î–æ–±–∞–≤–∏—Ç—å –ë–î —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
5. ‚úÖ **–≠—Ç–∞–ø 6.2** ‚Äî Integration —Ç–µ—Å—Ç—ã
6. ‚úÖ **–≠—Ç–∞–ø 7.1-7.2** ‚Äî –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ (–ø–æ—ç—Ç–∞–ø–Ω–æ–µ)
7. ‚úÖ **–≠—Ç–∞–ø 3** ‚Äî Telegram-–±–æ—Ç (–ø–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è feature flag)
8. ‚úÖ **–≠—Ç–∞–ø 5** ‚Äî –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ)
9. ‚úÖ **–≠—Ç–∞–ø 4** ‚Äî –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
10. ‚úÖ **–≠—Ç–∞–ø 6.3** ‚Äî –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
11. ‚úÖ **–≠—Ç–∞–ø 8** ‚Äî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

## –ß—Ç–æ –º–æ–≥–ª–∏ –∑–∞–±—ã—Ç—å (–æ–±–Ω–æ–≤–ª–µ–Ω–æ):

### ‚ùì –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è:

1. **Python –≤–µ—Ä—Å–∏—è:** –ö–∞–∫–∞—è –≤–µ—Ä—Å–∏—è Python –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è? (–¥–ª—è –≤—ã–±–æ—Ä–∞ zoneinfo/backports.zoneinfo)

2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–µ:** –ï—Å–ª–∏ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `admin_timezone`?

3. **API/webhook:** –ï—Å–ª–∏ –µ—Å—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –≤ –∫–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –æ—Ç–¥–∞–≤–∞—Ç—å –¥–∞—Ç—ã? (–†–µ–∫–æ–º–µ–Ω–¥—É—é: UTC + ISO 8601)

4. **–õ–æ–≥–∏:** –í –∫–∞–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ø–∏—Å–∞—Ç—å –ª–æ–≥–∏? (–†–µ–∫–æ–º–µ–Ω–¥—É—é: UTC —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏)

5. **–°—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ë–î:** –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `created_date` –≤ —Ç–∞–±–ª–∏—Ü–µ `notifications`?

6. **–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ timezone:** –û–ø—Ä–µ–¥–µ–ª—è—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ IP –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏? (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)

### To-dos

- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å expiry_date –≤ UTC –≤–æ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö database.py –∏ handlers.py
- [ ] –°–æ–∑–¥–∞—Ç—å timezone_helper.py —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ ensure_utc_datetime –∏ format_datetime_for_user
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö expiry_date –≤ UTC
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É timezone –≤ users –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫—É admin_timezone –≤ bot_settings
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å get/set —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏ –≤ database.py
- [ ] –°–æ–∑–¥–∞—Ç—å timezones.py —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—Å–µ—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±-–ø–∞–Ω–µ–ª–∏
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ –ø—Ä—è–º—ã–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç –Ω–∞ format_datetime_for_user
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é