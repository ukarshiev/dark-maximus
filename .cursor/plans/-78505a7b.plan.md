<!-- 78505a7b-161a-4b77-9ad8-00febe34fc57 e5c797ed-4428-4431-8766-a699317b232f -->
# Исправление теста testautorenewalskippedwhendisabled

## Проблемы

1. **Ошибка выполнения теста**: `sqlite3.IntegrityError: NOT NULL constraint failed: vpn_keys.xui_client_uuid`

   - В INSERT запросе отсутствуют обязательные поля `xui_client_uuid` и `key_email`
   - Строки 228-231 в `tests/unit/test_database/test_auto_renewal.py`

2. **Отсутствие Allure аннотаций**: тест не соответствует правилам проекта из `testing-rules.mdc`

   - Нет `@allure.title`
   - Нет `@allure.description` с структурированным описанием
   - Нет `@allure.severity`
   - Нет `@allure.tag`

## Решение

### 1. Исправление INSERT запроса

**Файл**: `tests/unit/test_database/test_auto_renewal.py` (строки 228-231)

**Текущий код**:

```python
cursor.execute("""
    INSERT INTO vpn_keys (user_id, host_name, plan_name, price, expiry_date, status)
    VALUES (?, ?, ?, ?, ?, ?)
""", (123456789, "Тестовый сервер", "Тестовый тариф", 50.0, expiry_date, "active"))
```

**Исправленный код** (по аналогии с `test_key_auto_renewal.py`):

```python
cursor.execute("""
    INSERT INTO vpn_keys (user_id, host_name, xui_client_uuid, key_email, plan_name, price, expiry_date, status)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
""", (123456789, "Тестовый сервер", "test-uuid-123", "test@example.com", "Тестовый тариф", 50.0, expiry_date, "active"))
```

### 2. Добавление Allure аннотаций

**Файл**: `tests/unit/test_database/test_auto_renewal.py` (перед методом `test_autorenewal_skipped_when_disabled`, строка 212)

**Добавить аннотации**:

- `@allure.title("Автопродление пропускается, когда отключено у пользователя")`
- `@allure.description` с разделами:
  - Краткое описание
  - "Что проверяется"
  - "Тестовые данные"
  - "Ожидаемый результат"
- `@allure.severity(allure.severity_level.NORMAL)` (или CRITICAL, если это критичный функционал)
- `@allure.tag("auto_renewal", "user_settings", "unit", "database")`

**Опционально**: добавить `allure.step()` для структурирования теста по паттерну Arrange-Act-Assert

### 3. Проверка других тестов в файле

Проверить тесты в классах `TestAutoRenewalDatabase`, `TestAutoRenewalNotifications`, `TestAutoRenewalIntegration` на наличие Allure аннотаций и добавить их при необходимости.

## Файлы для изменения

- `tests/unit/test_database/test_auto_renewal.py`

## Тестирование

После исправления запустить тест:

```bash
docker compose exec monitoring pytest tests/unit/test_database/test_auto_renewal.py::TestAutoRenewalIntegration::test_autorenewal_skipped_when_disabled -v
```

## Источники

- Структура таблицы: `tests/conftest.py` (строки 478-503)
- Примеры правильных INSERT: `tests/unit/test_database/test_key_auto_renewal.py` (строки 33-35)
- Примеры Allure аннотаций: `tests/unit/test_bot/test_toggle_key_auto_renewal_handler.py` (строки 32-50)
- Правила тестирования: `testing-rules.mdc` (раздел "Обязательные Allure аннотации")

### To-dos

- [ ] Исправить INSERT запрос в test_autorenewal_skipped_when_disabled: добавить обязательные поля xui_client_uuid и key_email
- [ ] Добавить Allure аннотации к тесту test_autorenewal_skipped_when_disabled (@allure.title, @allure.description, @allure.severity, @allure.tag)
- [ ] Опционально: добавить allure.step() для структурирования теста по паттерну Arrange-Act-Assert
- [ ] Проверить другие тесты в файле test_auto_renewal.py на наличие Allure аннотаций и добавить при необходимости
- [ ] Запустить исправленный тест для проверки корректности исправлений