<!-- 89b5a609-e95f-4510-9c4d-baf65eab2e16 749fb81a-d267-4e0a-9f38-c3a889624880 -->
# Обновленный план исправления Allure аннотаций в тестах

## Текущий статус

### Выполнено:

- ✅ Интеграционные тесты покупки VPN (test_full_purchase_flow.py, test_key_creation_flow.py, test_key_extension_flow.py, test_promo_code_application.py) - все методы имеют @allure.story и @allure.label
- ✅ Интеграционные тесты платежей (test_yookassa_flow.py, test_cryptobot_flow.py, test_heleket_flow.py, test_stars_flow.py, test_ton_connect_flow.py, test_balance_flow.py) - исправлены
- ✅ E2E тесты пользовательских сценариев (test_user_trial_flow.py) - все методы имеют @allure.story
- ✅ Unit-тесты базы данных - большинство файлов имеют @allure.label

### Требует исправления:

## 1. Интеграционные тесты автопродления (tests/integration/test_auto_renewal/)

### 1.1. test_auto_renewal_process.py

**Проблемы:**

- Отсутствует @allure.label("package", "tests.integration.test_auto_renewal") для класса TestAutoRenewalProcess
- 4 метода без @allure.story:
- test_auto_renewal_process_insufficient_balance (строка 221)
- test_auto_renewal_process_disabled (строка 273)
- test_auto_renewal_process_plan_unavailable (строка 325)
- test_auto_renewal_process_notification (строка 379)
- У метода test_auto_renewal_process_success @allure.story находится после @allure.tag (строка 77) - нужно переместить перед @allure.title

**Действия:**

1. Добавить @allure.label("package", "tests.integration.test_auto_renewal") для класса
2. Переместить @allure.story для test_auto_renewal_process_success перед @allure.title
3. Добавить @allure.story для всех 4 методов без него
4. Убедиться, что все методы имеют полный набор аннотаций

### 1.2. test_toggle_auto_renewal_show_key_flow.py

**Проблемы:**

- Отсутствует @allure.label("package", "tests.integration.test_auto_renewal") для класса TestToggleAutoRenewalShowKeyFlow
- Метод test_toggle_auto_renewal_show_key_flow (строка 32) не имеет @allure.story

**Действия:**

1. Добавить @allure.label("package", "tests.integration.test_auto_renewal") для класса
2. Добавить @allure.story перед @allure.title для метода

### 1.3. test_notification_buttons_flow.py

**Проблемы:**

- Отсутствует @allure.label("package", "tests.integration.test_auto_renewal") для класса
- Нужно проверить все методы на наличие @allure.story

**Действия:**

1. Проверить структуру файла и количество методов
2. Добавить @allure.label("package", "tests.integration.test_auto_renewal") для класса
3. Добавить @allure.story для всех методов

### 1.4. test_key_auto_renewal_integration.py

**Проблемы:**

- Отсутствует @allure.label("package", "tests.integration.test_auto_renewal") для класса TestKeyAutoRenewalIntegration
- Метод test_auto_renewal_with_disabled_key_auto_renewal (строка 23) не имеет @allure.story

**Действия:**

1. Добавить @allure.label("package", "tests.integration.test_auto_renewal") для класса
2. Добавить @allure.story перед @allure.title для метода

## 2. Интеграционные тесты пробного периода (tests/integration/test_trial/)

### 2.1. test_trial_flow.py

**Проблемы:**

- Отсутствует @allure.label("package", "tests.integration.test_trial") для класса TestTrialFlow
- Метод test_trial_creation_flow (строка 29) не имеет аннотаций вообще
- Методы test_trial_reuse_flow, test_trial_revocation_flow, test_trial_status_check уже имеют аннотации (OK)

**Действия:**

1. Добавить @allure.label("package", "tests.integration.test_trial") для класса
2. Добавить полный набор аннотаций для test_trial_creation_flow:

- @allure.story
- @allure.title
- @allure.description (со структурированными разделами)
- @allure.severity
- @allure.tag

## 3. Интеграционные тесты личного кабинета (tests/integration/test_user_cabinet/)

### 3.1. test_cabinet_flow.py

**Проблемы:**

- 6 методов без @allure.story:
- test_cabinet_with_subscription_link (строка 178)
- test_cabinet_without_subscription_link (строка 240)
- test_cabinet_key_data_display (строка 282)
- test_cabinet_error_handling (строка 335)
- test_valid_cabinet_link_accessible (строка 409) - есть другие аннотации, но нет @allure.story
- test_multiple_valid_links_not_broken (строка 520) - есть другие аннотации, но нет @allure.story

**Действия:**

1. Добавить @allure.story для всех 6 методов
2. Убедиться, что @allure.story находится перед @allure.title

## 4. E2E тесты (tests/e2e/)

### 4.1. test_key_auto_renewal_e2e.py

**Проблемы:**

- Отсутствует @allure.label("package", "tests.e2e") для класса TestKeyAutoRenewalE2E
- Метод test_key_auto_renewal_full_flow уже имеет @allure.story (OK)

**Действия:**

1. Добавить @allure.label("package", "tests.e2e") для класса

## 5. Unit-тесты базы данных (tests/unit/test_database/)

**Статус:** Большинство файлов уже имеют @allure.label

**Требует проверки:**

- test_trial_operations.py - проверить наличие @allure.label и аннотаций для методов
- test_key_numbering.py - проверить наличие @allure.label и аннотаций для методов

**Действия:**

1. Проверить test_trial_operations.py на наличие @allure.label и полного набора аннотаций для всех методов
2. Проверить test_key_numbering.py на наличие @allure.label и полного набора аннотаций для всех методов
3. При необходимости добавить недостающие аннотации

## Правила исправления

### Порядок аннотаций для методов:

1. @allure.story (если требуется для интеграционных/E2E тестов)
2. @allure.title
3. @allure.description
4. @allure.severity
5. @allure.tag

### Структура @allure.description для интеграционных/E2E тестов:

- Краткое описание (1-2 предложения)
- **"Что проверяется"** - список проверяемых аспектов
- **"Тестовые данные"** - входные параметры
- **"Предусловия"** - условия перед тестом
- **"Шаги теста"** - пошаговое описание
- **"Ожидаемый результат"** - ожидаемое поведение

## Приоритет исправлений

1. **Высокий приоритет**: Интеграционные тесты автопродления (4 файла)
2. **Высокий приоритет**: Интеграционные тесты пробного периода (1 метод)
3. **Высокий приоритет**: Интеграционные тесты личного кабинета (6 методов)
4. **Средний приоритет**: E2E тесты автопродления (1 файл)
5. **Низкий приоритет**: Unit-тесты базы данных (2 файла для проверки)

### To-dos

- [ ] Исправить test_auto_renewal_process.py: добавить @allure.label для класса, переместить @allure.story для test_auto_renewal_process_success, добавить @allure.story для 4 методов
- [ ] Исправить test_toggle_auto_renewal_show_key_flow.py: добавить @allure.label для класса и @allure.story для метода
- [ ] Исправить test_notification_buttons_flow.py: добавить @allure.label для класса и @allure.story для всех методов
- [ ] Исправить test_key_auto_renewal_integration.py: добавить @allure.label для класса и @allure.story для метода
- [ ] Исправить test_trial_flow.py: добавить @allure.label для класса и полный набор аннотаций для test_trial_creation_flow
- [ ] Исправить test_cabinet_flow.py: добавить @allure.story для 6 методов (test_cabinet_with_subscription_link, test_cabinet_without_subscription_link, test_cabinet_key_data_display, test_cabinet_error_handling, test_valid_cabinet_link_accessible, test_multiple_valid_links_not_broken)
- [ ] Исправить test_key_auto_renewal_e2e.py: добавить @allure.label для класса
- [ ] Проверить test_trial_operations.py на наличие @allure.label и полного набора аннотаций для всех методов
- [ ] Проверить test_key_numbering.py на наличие @allure.label и полного набора аннотаций для всех методов