<!-- 97f818fc-dc84-4996-ab46-4ba2434e21c7 b185beb9-4521-46fe-9b75-145f4ccae851 -->
# Исправление сохранения параметров .env при обновлении

## Проблемы (подтвержденные фактами из кода)

1. **Скрипт `install.sh` полностью перезаписывает `.env` файл** (строки 316-337), теряя все пользовательские параметры:

   - `GITHUB_TOKEN` - пользовательский параметр
   - `PANEL_LOGIN` - пользовательский параметр (устаревший, но может быть в .env)
   - `PANEL_PASSWORD` - пользовательский параметр (устаревший, но может быть в .env)
   - `ENVIRONMENT` - используется в тестах (строка 14 в config/env.example)
   - Существующий `FLASK_SECRET_KEY` - всегда генерируется новый (строка 286), что приводит к потере сессий
   - Другие пользовательские параметры

2. **Дубли доменов в `.env` файле** — скрипт добавляет домены без проверки на существование

3. **Шаблон `config/env.example` не содержит всех необходимых параметров**

## Факты из кода (проверено через grep и codebase_search)

**Используемые переменные окружения (через `os.getenv()`):**

- `FLASK_SECRET_KEY` - критично, используется в `src/shop_bot/webhook_server/auth_utils.py:29`
- `FLASK_ENV` - опционально, используется в `src/shop_bot/webhook_server/auth_utils.py:58`
- `SESSION_COOKIE_SECURE` - опционально, используется в `src/shop_bot/webhook_server/auth_utils.py:58`
- `FLASK_DEBUG` - опционально, используется в `src/shop_bot/__main__.py:135`
- `DOCKER_COMPOSE_FILE` - опционально, используется в `src/shop_bot/webhook_server/app.py:6449`
- `ENVIRONMENT` - используется для тестов (из .env, но не через python-dotenv)

**Важно:** Приложение НЕ использует python-dotenv для загрузки .env файла. Переменные окружения должны быть установлены в системе или через docker-compose.yml (строки 25, 66, 712, 759 в docker-compose.yml).

## Решение

### 1. Исправление скрипта `install.sh`

**Файл:** `install.sh`

**Изменения:**

- Заменить полную перезапись `.env` (строки 316-337) на умное слияние:
  - Читать существующие значения из `.env` файла перед обновлением
  - Сохранять все пользовательские параметры, которых нет в шаблоне
  - Обновлять только необходимые параметры (домены, `FLASK_SECRET_KEY` только если его нет)
  - Использовать функцию для безопасного обновления переменных в `.env`

**Логика:**

```bash
# Если .env существует - читаем существующие значения
if [ -f ".env" ]; then
    # Сохраняем существующие значения
    EXISTING_FLASK_SECRET_KEY=$(grep "^FLASK_SECRET_KEY=" .env | cut -d'=' -f2- | tr -d '"' | tr -d "'" || echo "")
    EXISTING_GITHUB_TOKEN=$(grep "^GITHUB_TOKEN=" .env | cut -d'=' -f2- | tr -d '"' | tr -d "'" || echo "")
    EXISTING_PANEL_LOGIN=$(grep "^PANEL_LOGIN=" .env | cut -d'=' -f2- | tr -d '"' | tr -d "'" || echo "")
    EXISTING_PANEL_PASSWORD=$(grep "^PANEL_PASSWORD=" .env | cut -d'=' -f2- | tr -d '"' | tr -d "'" || echo "")
    EXISTING_ENVIRONMENT=$(grep "^ENVIRONMENT=" .env | cut -d'=' -f2- | tr -d '"' | tr -d "'" || echo "")
    # ... и другие параметры
    
    # Используем существующий FLASK_SECRET_KEY если он есть
    if [ -n "$EXISTING_FLASK_SECRET_KEY" ]; then
        FLASK_SECRET_KEY="$EXISTING_FLASK_SECRET_KEY"
    fi
fi

# Обновляем .env с сохранением существующих значений
# Используем функцию для безопасного обновления переменных
```

**Функция для безопасного обновления `.env`:**

- Создать функцию `update_env_variable()` для обновления конкретной переменной в `.env`
- Создать функцию `preserve_env_file()` для сохранения всех пользовательских параметров
- Использовать временный файл для безопасного обновления

### 2. Исправление дублей доменов

**Проблема:** Скрипт добавляет домены без проверки на существование

**Решение:**

- Перед добавлением доменов проверять, есть ли они уже в `.env`
- Использовать функцию для обновления доменов без дублей
- Удалять старые дубли доменов при обновлении

### 3. Обновление шаблона `config/env.example`

**Файл:** `config/env.example`

**Важно:** Все параметры (токены ботов, платежные системы, домены, учетные данные) хранятся в БД в таблице `bot_settings` и настраиваются через веб-панель. Переменные окружения в `.env` используются только для:

- Переменных окружения системы (FLASK_SECRET_KEY, ENVIRONMENT и т.д.)
- Fallback значений для тестов и аварийного доступа
- Параметров, которые не могут быть в БД (секретные ключи, токены CI/CD)

**Структура:**

```bash
# Пример файла переменных окружения для Dark Maximus
# Скопируйте этот файл в .env и заполните реальными значениями

# ============================================
# КРИТИЧНО: Flask секретный ключ (обязательно!)
# ============================================
# Используется для шифрования сессий Flask во всех сервисах с авторизацией:
# - Веб-панель (bot) - порт 50000
# - Документация (docs-proxy) - порт 50001
# - Allure Homepage (allure-homepage) - порт 50005
# 
# КРИТИЧНО: Не меняйте этот ключ после первого запуска, иначе все сессии будут потеряны!
FLASK_SECRET_KEY=your-super-secret-key-here-change-this

# ============================================
# Настройки безопасности Flask сессий (опционально)
# ============================================
# FLASK_ENV=production - для включения SESSION_COOKIE_SECURE (HTTPS)
# SESSION_COOKIE_SECURE=true - для HTTPS (автоматически включается при FLASK_ENV=production)
# FLASK_DEBUG=false - отключить режим отладки Flask

# ============================================
# Настройки тестирования целостности БД
# ============================================
# ENVIRONMENT=production - включить тесты для продакшн (development/test - отключить)
ENVIRONMENT=development

# ============================================
# Учетные данные для сервисов с авторизацией (FALLBACK)
# ============================================
# ВАЖНО: Основной источник учетных данных - БД (таблица bot_settings):
# - panel_login - логин для веб-панели, docs-proxy, allure-homepage
# - panel_password - пароль для веб-панели, docs-proxy, allure-homepage
#
# Переменные в .env используются ТОЛЬКО как fallback для:
# - Тестов (если нет в БД)
# - Аварийного доступа (если БД недоступна)
# - Первоначальной настройки (если БД пуста)
#
# Сервисы с авторизацией:
# 1. Веб-панель (bot) - порт 50000, домен panel.*
#    Использует: panel_login, panel_password из БД
# 2. Документация (docs-proxy) - порт 50001, домен docs.*
#    Использует: panel_login, panel_password из БД
# 3. Allure Homepage (allure-homepage) - порт 50005, домен allure.*
#    Использует: panel_login, panel_password из БД
# 4. Codex Docs (codex-docs) - порт 50002, домен help.*
#    Использует: auth.password из codex.docs/docs-config.yaml (НЕ из БД)
#
# Для изменения логина/пароля используйте веб-панель (/settings), НЕ редактируйте .env!
PANEL_LOGIN=admin
PANEL_PASSWORD=admin

# ============================================
# Codex Docs пароль (FALLBACK)
# ============================================
# ВАЖНО: Основной источник - codex.docs/docs-config.yaml (auth.password)
# Переменная в .env используется ТОЛЬКО как fallback для аварийного доступа
# Для изменения пароля редактируйте codex.docs/docs-config.yaml
CODEX_DOCS_PASSWORD=secretpassword

# ============================================
# GitHub Token (опционально, для автоматизации)
# ============================================
# Используется для создания GitHub Issues через API (tests/ad-hoc/create_github_issues.py)
# GITHUB_TOKEN=ghp_...

# ============================================
# TLS настройки для X-UI (опционально)
# ============================================
# XUI_TLS_VERIFY=true - включить проверку TLS сертификата (рекомендуется)
# XUI_TLS_CA_BUNDLE=/path/to/ca-bundle.crt - путь к кастомному CA bundle

# ============================================
# Домены (автоматически генерируются install.sh)
# ============================================
# ВАЖНО: Домены также хранятся в БД (bot_settings):
# - domain, global_domain - основной домен
# - docs_domain - домен документации
# - codex_docs_domain - домен админ-документации
# - user_cabinet_domain - домен личного кабинета
# - allure_domain - домен Allure
#
# Переменные в .env используются только для:
# - Генерации nginx конфигурации при установке
# - Fallback значений, если не установлены в БД
DOMAIN=example.com
MAIN_DOMAIN=example.com
DOCS_DOMAIN=docs.example.com
HELP_DOMAIN=help.example.com
APP_DOMAIN=app.example.com
ALLURE_DOMAIN=allure.example.com

# ============================================
# ПРИМЕЧАНИЕ
# ============================================
# Все остальные настройки (токены ботов, платежные системы, домены и т.д.)
# хранятся в БД в таблице bot_settings и настраиваются через веб-панель.
# Переменные окружения для этих настроек НЕ используются в коде.
```

### 4. Создание утилиты для очистки дублей

**Опционально:** Создать скрипт `scripts/clean-env-duplicates.sh` для очистки дублей в существующем `.env` файле

## Файлы для изменения

1. `install.sh` — исправление логики обновления `.env`
2. `config/env.example` — добавление всех необходимых параметров

## Тестирование

1. Проверить, что существующие параметры сохраняются при обновлении
2. Проверить, что новые параметры добавляются корректно
3. Проверить, что дубли доменов не создаются
4. Проверить, что `FLASK_SECRET_KEY` не перезаписывается, если уже существует