<!-- 703a34a7-ba4b-4f13-a760-e06ed92a37a1 a4edeae9-a325-466b-a7b0-45d8f0a0c03a -->
# План исправления падающих тестов

## Проблемы

### 1. test_get_global_domain_fallback_to_localhost_in_development

**Проблема:** Тест падает, потому что после установки `server_environment` в "development" и очистки доменов, функция `get_global_domain()` не возвращает ожидаемое значение "https://localhost:8443".

**Причина:** Возможно, проблема в том, что:

- Функция `get_global_domain()` использует `is_development_server()`, которая читает из БД через `get_setting()`
- После очистки доменов через прямой SQL запрос, функция `get_setting()` может не видеть изменения из-за кеширования соединений SQLite
- Или настройки доменов не полностью очищены (возможно, есть пустые строки вместо NULL)

**Решение:**

1. Убедиться, что после `update_setting()` изменения сразу видны через `get_setting()`
2. Проверить, что очистка доменов удаляет и пустые строки: `DELETE FROM bot_settings WHERE key IN ('global_domain', 'domain') OR (key IN ('global_domain', 'domain') AND (value IS NULL OR value = ''))`
3. Добавить явную проверку, что после очистки `get_setting("global_domain")` и `get_setting("domain")` возвращают `None`
4. Возможно, нужно добавить небольшую задержку или явное закрытие соединений после очистки

### 2. test_login_failure_no_errors и test_session_persistence

**Проблема:** Интеграционные тесты падают, возможно из-за:

- Сервисы не запущены или недоступны
- Тесты не учитывают настройку "Тип сервера" из панели (server_environment)
- Проблемы с сессиями или cookies

**Причина:**

- Функция `_is_production_environment()` в `conftest.py` проверяет `ENVIRONMENT` из `.env` и `server_environment` из БД, но может быть несоответствие
- Тесты могут запускаться на сервере с настройкой "production", но тесты ожидают "development"
- Сервисы могут быть недоступны из-за неправильного определения хоста

**Решение:**

1. Убедиться, что тесты корректно определяют окружение (development/production)
2. Проверить, что функция `_get_service_host()` правильно определяет хост для сервисов в зависимости от окружения
3. Добавить более детальную диагностику в тесты для понимания, почему они падают
4. Убедиться, что тесты работают как на production, так и на development серверах

## Шаги исправления

### Шаг 1: Исправление test_get_global_domain_fallback_to_localhost_in_development

**Файл:** `tests/unit/test_database/test_domain_settings.py`

1. Улучшить очистку доменов - удалять не только записи, но и проверять пустые строки
2. Добавить явную проверку после очистки, что настройки действительно отсутствуют
3. Возможно, добавить небольшую задержку после очистки для гарантии, что изменения применены
4. Проверить, что `get_global_domain()` правильно читает из БД после очистки

### Шаг 2: Исправление интеграционных тестов авторизации

**Файл:** `tests/integration/test_auth_all_services/test_login_integration.py`

1. Улучшить диагностику в тестах - добавить больше информации о том, почему тест падает
2. Проверить, что тесты корректно определяют окружение (development/production)
3. Убедиться, что тесты пропускаются, если сервисы недоступны (уже есть проверка `check_service_available`)
4. Добавить проверку настройки "Тип сервера" из БД перед выполнением тестов

### Шаг 3: Проверка функции get_global_domain

**Файл:** `src/shop_bot/data_manager/database.py`

1. Убедиться, что функция `get_global_domain()` правильно обрабатывает случай, когда оба домена отсутствуют
2. Проверить, что `is_development_server()` корректно читает из БД
3. Возможно, добавить логирование для отладки

### Шаг 4: Проверка функции _is_production_environment

**Файл:** `tests/integration/test_auth_all_services/conftest.py`

1. Убедиться, что функция правильно определяет окружение
2. Проверить, что она учитывает настройку "Тип сервера" из БД
3. Добавить логирование для диагностики

## Тестирование

После исправления:

1. Запустить все три падающих теста
2. Проверить отчет в Allure
3. Убедиться, что тесты проходят на разных типах сервера (production и development)
4. Проверить, что тесты не ломают другие тесты

## Файлы для изменения

1. `tests/unit/test_database/test_domain_settings.py` - исправление теста fallback to localhost
2. `tests/integration/test_auth_all_services/test_login_integration.py` - улучшение диагностики
3. `tests/integration/test_auth_all_services/conftest.py` - улучшение определения окружения
4. `src/shop_bot/data_manager/database.py` - возможно, улучшение функции get_global_domain (если нужно)

### To-dos

- [ ] Исправить test_get_global_domain_fallback_to_localhost_in_development - улучшить очистку доменов и проверку
- [ ] Исправить test_login_failure_no_errors и test_session_persistence - улучшить диагностику и определение окружения
- [ ] Проверить и при необходимости исправить функцию get_global_domain для корректной работы с настройками
- [ ] Проверить и при необходимости исправить функцию _is_production_environment для корректного определения окружения
- [ ] Запустить все три падающих теста и проверить отчет в Allure