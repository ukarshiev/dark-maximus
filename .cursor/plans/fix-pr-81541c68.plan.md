<!-- 81541c68-1e2d-4cc0-9b54-fb5c92f356e1 52604adc-5009-4e8d-ba19-4f6e53b63cbb -->
# План исправления проблемы с промокодом в deeplink

## Проблема

При переходе по реферальной ссылке `https://t.me/darkmaxi_vpn_bot?start=eyJnIjoibW9pIiwicCI6IlNLSURLQTEwMFJVQiJ9`:

- ✅ Пользователь успешно добавляется в группу `moi`
- ❌ Промокод `SKIDKA100RUB` не применяется, баланс не пополняется на 100 руб

## Причина

В таблице `promo_code_usage` установлено **неправильное ограничение уникальности**:

```sql
UNIQUE (promo_id, bot)
```

Это означает, что **каждый промокод может быть использован только один раз для каждого бота**, независимо от пользователя.

В базе данных уже существует запись:

```
(34, 23, 999999999, 'shop', ...)  -- тестовый пользователь уже использовал промокод
```

Когда новый пользователь пытается использовать промокод, возникает ошибка:

```
UNIQUE constraint failed: promo_code_usage.promo_id, promo_code_usage.bot
```

## Решение

**Изменить ограничение уникальности** на:

```sql
UNIQUE (promo_id, user_id, bot)
```

Это позволит каждому пользователю использовать промокод один раз.

## Файлы для изменения

1. **src/shop_bot/data_manager/database.py** (строка 438)

   - Изменить `UNIQUE (promo_id, bot)` на `UNIQUE (promo_id, user_id, bot)`

2. **Миграция базы данных**

   - Создать миграцию для пересоздания таблицы с новым ограничением
   - Сохранить существующие данные

## Шаги выполнения

1. Создать функцию миграции `migrate_promo_code_usage_unique_constraint()`
2. Добавить вызов миграции в `initialize_db()`
3. Протестировать на реальной базе данных
4. Удалить тестовую запись `usage_id=34` (пользователь 999999999)
5. Протестировать deeplink ссылку с новым пользователем

## Проверка

После исправления:

- Новый пользователь переходит по ссылке
- Добавляется в группу `moi`
- Промокод `SKIDKA100RUB` применяется
- Баланс пополняется на 100 руб
- В логах: `Applied bonus 100.0 RUB to user {user_id} from promo 'SKIDKA100RUB'`

### To-dos

- [ ] Создать функцию миграции для изменения ограничения UNIQUE в таблице promo_code_usage
- [ ] Обновить CREATE TABLE для promo_code_usage с новым ограничением UNIQUE (promo_id, user_id, bot)
- [ ] Добавить вызов миграции в initialize_db()
- [ ] Протестировать миграцию на реальной базе данных
- [ ] Удалить тестовую запись usage_id=34 для пользователя 999999999
- [ ] Протестировать deeplink ссылку с новым пользователем через Chrome DevTools