<!-- 0ea9996d-36a0-4605-8478-b0293b418c63 31299039-ad71-4086-b81a-068466354e83 -->
# 13-11-25_safe-cabinet-update.plan.md

Дата: 13.11.2025 05:01:42 (UTC+3)
Version: 1.1

## План работ

1. Сбор фактов и безопасный контекст

- Выполнить запрос через context7 MCP, чтобы получить актуальные сведения о параметре `codex_docs_domain`, связанных настройках и требованиях Telegram к ссылкам личного кабинета.
- Зафиксировать текущее поведение страницы `apps/user-cabinet/templates/index.html` и формулировок в `src/shop_bot/config.py`, сравнить с фактическим выводом в веб-интерфейсе.
- Сформировать стратегию безопасной разработки (идемпотентные изменения, ревью конфигураций, тестирование в браузере), чтобы исключить регрессии при развёртывании.

2. Анализ проблем с проверкой IP

- В Chrome DevTools воспроизвести ошибки блока `#ip-info`, подтвердив фактические сообщения: `ERR_CONNECTION_CLOSED` для `https://api.2ip.ru/geo.json` и `TypeError: Failed to fetch` в `main.js:98`.
- Проанализировать причины (CSP, CORS, недоступность источников) и определить безопасный механизм проверки IP (замена API или прокси), не нарушая остальной функционал.

3. Обновление интерфейса личного кабинета

- Сделать ссылку `cabinet_url` кликабельной даже при HTTP-домене и безопасно удалить фразу про настройку HTTPS в `src/shop_bot/config.py`, сохранив остальные сценарии формирования сообщений.
- В `apps/user-cabinet/app.py` передать в шаблон фактический URL базы знаний из настройки «Домен codex-docs…» и в `apps/user-cabinet/templates/index.html` синхронизировать `iframe`/fallback на `/setup`, учитывая текущую CSP-политику.
- Переименовать заголовок `h1` в «Личный кабинет», убедившись, что тема и стили остаются неизменными.

4. Проверки и документация

- Перепроверить в браузере работу ссылок и обновлённого механизма проверки IP, удостоверившись в отсутствии новых ошибок CSP, CORS и сетевых блокировок.
- Обновить `CHANGELOG.md` (новая запись сверху) и версию в `pyproject.toml`, зафиксировав изменения личного кабинета согласно правилам репозитория.

### To-dos

- [ ] Запросить сведения через context7 MCP о codex_docs_domain и требованиях Telegram к ссылкам
- [ ] Воспроизвести сбой checkIP на странице кабинета и зафиксировать фактические ошибки в DevTools
- [ ] Обновить конфигурацию ссылок и UI личного кабинета, включая шаблон, бэкенд и тексты бота
- [ ] Протестировать обновления и синхронизировать документацию (CHANGELOG, pyproject)