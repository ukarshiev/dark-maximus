<!-- 1fa07b54-230e-4edb-a16b-88ab6e4cd087 4b31dc1b-5d9c-4458-afa6-6883e919174d -->
# Исправление тестов автопродления ключей

## Проблемы

Обнаружены следующие ошибки в тестах:

1. **test_auto_renewal_with_disabled_key_auto_renewal**:

- Используется несуществующая функция `create_key_for_user` вместо `add_new_key`
- Отсутствует импорт `add_new_key`
- Отсутствует импорт `get_key_auto_renewal_enabled`
- `register_user_if_not_exists` вызывается без обязательного аргумента `referrer_id`

2. **test_auto_renewal_with_enabled_global_disabled_key**:

- `register_user_if_not_exists` вызывается без обязательного аргумента `referrer_id`

3. **test_auto_renewal_with_both_enabled**:

- `register_user_if_not_exists` вызывается без обязательного аргумента `referrer_id`
- Отсутствует импорт `get_key_auto_renewal_enabled`

## Решение

### Файл: `tests/integration/test_auto_renewal/test_key_auto_renewal_integration.py`

#### Исправление 1: test_auto_renewal_with_disabled_key_auto_renewal (строки 70-131)

- Заменить `create_key_for_user` на `add_new_key` в импортах (строка 72)
- Добавить `add_new_key` в список импортов (строка 70-77)
- Добавить `get_key_auto_renewal_enabled` в список импортов (строка 70-77)
- Изменить вызов `register_user_if_not_exists(user_id, username)` на `register_user_if_not_exists(user_id, username, referrer_id=None)` (строка 83)

#### Исправление 2: test_auto_renewal_with_enabled_global_disabled_key (строки 177-229)

- Изменить вызов `register_user_if_not_exists(user_id, username)` на `register_user_if_not_exists(user_id, username, referrer_id=None)` (строка 192)

#### Исправление 3: test_auto_renewal_with_both_enabled (строки 275-327)

- Добавить `get_key_auto_renewal_enabled` в список импортов (строка 278-285)
- Изменить вызов `register_user_if_not_exists(user_id, username)` на `register_user_if_not_exists(user_id, username, referrer_id=None)` (строка 290)

## Проверка

После исправления:

1. Запустить все три теста через `docker compose exec autotest pytest tests/integration/test_auto_renewal/test_key_auto_renewal_integration.py -v`
2. Проверить отчет Allure для подтверждения успешного прохождения тестов
3. Убедиться, что логика автопродления работает корректно (проверка индивидуальных настроек ключей)

### To-dos

- [ ] Исправить test_auto_renewal_with_disabled_key_auto_renewal: заменить create_key_for_user на add_new_key, добавить недостающие импорты, исправить вызов register_user_if_not_exists
- [ ] Исправить test_auto_renewal_with_enabled_global_disabled_key: исправить вызов register_user_if_not_exists
- [ ] Исправить test_auto_renewal_with_both_enabled: добавить импорт get_key_auto_renewal_enabled, исправить вызов register_user_if_not_exists
- [ ] Запустить все три теста и проверить результаты
- [ ] Проверить отчет Allure для подтверждения успешного прохождения тестов