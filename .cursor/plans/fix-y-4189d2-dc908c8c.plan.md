<!-- dc908c8c-e108-4380-959a-a99e57e620ad f80994e3-fdfe-40c5-9274-6ddae9c39779 -->
# Исправление days/hours для всех методов оплаты

## Проблема

После первого исправления остались **3 метода оплаты** без поддержки days/hours:

- CryptoBot
- Heleket  
- Покупка из баланса

## Обнаруженные места

### 1. CryptoBot (handlers.py + app.py)

**handlers.py:4823** - создание платежа:

```python
months = plan['months']  # ← нет days/hours

payload_data = f"{user_id}:{months}:..."  # ← payload содержит только months
```

**app.py:2754-2763** - webhook парсит payload:

```python
metadata = {
    "months": parts[1],  # ← парсится только months
    # "days": отсутствует
    # "hours": отсутствует
}
```

### 2. Heleket (handlers.py:4898, 6180 + app.py:2808)

**handlers.py:4898** - создание платежа:

```python
months = plan['months']  # ← нет days/hours
```

**handlers.py:6180** - metadata для запроса:

```python
metadata = {
    "months": months,  # ← только months
    # "days": отсутствует
    # "hours": отсутствует
}
```

### 3. Balance (handlers.py:5424, 5448)

**handlers.py:5424** - получение данных:

```python
months = int(data.get('months') or 0) or int((get_plan_by_id(plan_id) or {}).get('months') or 0)
# days и hours не извлекаются
```

**handlers.py:5448** - metadata:

```python
metadata = {
    "months": months,  # ← только months
    # "days": отсутствует
    # "hours": отсутствует
}
```

## План исправления

### Шаг 1: CryptoBot

#### 1.1. handlers.py - создание платежа (строка 4823)

```python
months = plan['months']
days = int(plan.get('days') or 0)
hours = int(plan.get('hours') or 0)

# Payload теперь должен содержать days и hours
payload_data = f"{user_id}:{months}:{days}:{hours}:{float(price_rub)}:..."
```

#### 1.2. app.py - webhook парсинг (строка 2749-2764)

```python
parts = payload_string.split(':')
if len(parts) < 11:  # ← увеличить до 11 (добавили days и hours)
    logger.error(...)
    return 'Error', 400

metadata = {
    "user_id": parts[0],
    "months": parts[1],
    "days": parts[2],      # ← добавить
    "hours": parts[3],     # ← добавить
    "price": parts[4],     # ← индексы сдвинутся
    "action": parts[5],
    "key_id": parts[6],
    "host_name": parts[7],
    "plan_id": parts[8],
    "customer_email": parts[9] if parts[9] != 'None' else None,
    "payment_method": parts[10]
}
```

### Шаг 2: Heleket

#### 2.1. handlers.py - создание платежа (строка 4898)

```python
months = plan['months']
days = int(plan.get('days') or 0)
hours = int(plan.get('hours') or 0)
```

#### 2.2. handlers.py - _create_heleket_payment_request (строка 6165)

Добавить параметры days и hours в сигнатуру:

```python
async def _create_heleket_payment_request(
    user_id: int, 
    price: float, 
    months: int, 
    days: int,     # ← добавить
    hours: int,    # ← добавить
    host_name: str, 
    state_data: dict
) -> str | None:
```

#### 2.3. handlers.py - metadata (строка 6180)

```python
metadata = {
    "user_id": user_id, 
    "months": months, 
    "days": days,      # ← добавить
    "hours": hours,    # ← добавить
    "price": float(price),
    ...
}
```

#### 2.4. handlers.py - вызов функции (строка 4902)

```python
pay_url = await _create_heleket_payment_request(
    user_id=callback.from_user.id,
    price=final_price_float,
    months=plan['months'],
    days=days,      # ← добавить
    hours=hours,    # ← добавить
    host_name=data.get('host_name'),
    state_data=data
)
```

### Шаг 3: Balance (покупка из баланса)

#### 3.1. handlers.py - извлечение данных (строка 5424)

```python
plan = get_plan_by_id(plan_id)
months = int(data.get('months') or 0) or int((plan or {}).get('months') or 0)
days = int((plan or {}).get('days') or 0)
hours = int((plan or {}).get('hours') or 0)
```

#### 3.2. handlers.py - metadata (строка 5448)

```python
metadata = {
    "user_id": user_id,
    "months": months,
    "days": days,      # ← добавить
    "hours": hours,    # ← добавить
    "price": price,
    ...
}
```

### Шаг 4: Проверка всех бесплатных тарифов

Найти все места с `if price_rub == 0` и убедиться, что они используют days/hours из плана:

- YooKassa (handlers.py:4534) - уже исправлено ранее
- TON Connect (handlers.py:4957) - уже исправлено ранее
- Stars (handlers.py:5218) - уже исправлено ранее

### Шаг 5: Обновить документацию и CHANGELOG

#### 5.1. docs/troubleshooting/yookassa-stuck-payments.md

Добавить информацию об исправлении CryptoBot, Heleket и Balance.

#### 5.2. CHANGELOG.md

Добавить запись о дополнительных исправлениях.

#### 5.3. pyproject.toml

Обновить версию: 3.23.0 → 3.23.1

## Важные детали

### Обратная совместимость CryptoBot webhook

Старые платежи CryptoBot могут иметь payload в старом формате (9 частей). Нужно добавить проверку:

```python
parts = payload_string.split(':')
if len(parts) == 9:
    # Старый формат без days/hours - добавляем значения по умолчанию
    metadata = {
        "user_id": parts[0],
        "months": parts[1],
        "days": 0,         # ← fallback
        "hours": 0,        # ← fallback
        "price": parts[2],
        ...
    }
elif len(parts) == 11:
    # Новый формат с days/hours
    metadata = {
        "user_id": parts[0],
        "months": parts[1],
        "days": parts[2],
        "hours": parts[3],
        "price": parts[4],
        ...
    }
else:
    logger.error("Invalid payload format")
    return 'Error', 400
```

### Обратная совместимость Heleket webhook

Heleket передает metadata в JSON, поэтому старые платежи автоматически получат fallback через универсальную обработку в `process_successful_payment`.

## Тестирование

После исправлений нужно проверить:

1. Создание платежа с планом содержащим только дни/часы (months=0)
2. Webhook обработку для каждого метода
3. Логи с расчетом days_to_add

## Файлы для изменения

- `src/shop_bot/bot/handlers.py` (4 места)
- `src/shop_bot/webhook_server/app.py` (1 место)
- `docs/troubleshooting/yookassa-stuck-payments.md`
- `CHANGELOG.md`
- `pyproject.toml`

### To-dos

- [ ] Добавить days и hours в создание CryptoBot платежа и payload
- [ ] Исправить CryptoBot webhook для парсинга days/hours с обратной совместимостью
- [ ] Добавить days и hours в создание Heleket платежа и metadata
- [ ] Обновить сигнатуру _create_heleket_payment_request с days/hours
- [ ] Добавить days и hours в покупку из баланса
- [ ] Проверить все бесплатные тарифы на корректность использования days/hours
- [ ] Обновить документацию и CHANGELOG с версией 3.23.1