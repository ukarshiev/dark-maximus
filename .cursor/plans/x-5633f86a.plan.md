<!-- 5633f86a-b12a-4e89-9e1f-05f4a9f68ba9 9110bbb9-f364-48c6-a896-48a4c3ba859e -->
# План разбора ошибки HTTP 404 в panelupdateclientquota

### Цель

Разобрать, что именно означает ошибка `Failed to get inbound data: HTTP 404` в модуле `src/shop_bot/modules/xui_api.py`, при каких условиях она возникает, и какие фактические проверки нужно выполнить на боевом сервере, чтобы подтвердить и устранить проблему без предположений.

### Шаги плана

1. **Анализ кода функции `_panel_update_client_quota`**

- Просмотреть реализацию функции в [`src/shop_bot/modules/xui_api.py`](src/shop_bot/modules/xui_api.py), чтобы точно зафиксировать, при каком условии логируется сообщение `Failed to get inbound data: HTTP {status_code}`.
- Зафиксировать, какие параметры (в частности `host_url` и `inbound_id`) используются для запроса `GET {base}/panel/inbound/get/{inbound_id}` и откуда они берутся.

2. **Отслеживание источников данных (`host_url`, `inbound_id`, `client_uuid`, `email`)**

- Проследить, как вызывается `_panel_update_client_quota` из функций `update_client_quota_on_host` и `create_or_update_key_on_host` в том же файле.
- Через `get_host` из [`src/shop_bot/data_manager/database.py`](src/shop_bot/data_manager/database.py) зафиксировать, что `inbound_id` берётся из поля `host_inbound_id` таблицы `xui_hosts` и зависит от конфигурации хоста в базе.

3. **Фиксация точного смысла ошибки на уровне HTTP и панели 3X-UI**

- На основе логики функции и стандартного значения HTTP 404 зафиксировать, что ошибка появляется только в одном случае: когда панель 3X-UI по запросу `GET {base}/panel/inbound/get/{inbound_id}` отвечает кодом 404, т.е. не находит inbound с таким ID.
- Отметить, что логика входа (`POST {base}/login`) к этому моменту уже успешно прошла (иначе логировалась бы другая ошибка), значит `host_url` и учётные данные валидны.

4. **Пошаговые проверки на боевом сервере (выполняет администратор)**

- На боевом сервере, внутри контейнера с ботом, с помощью HTTP-запроса вручную вызвать `GET {host_url_trimmed}/panel/inbound/get/{host_inbound_id}` с теми же значениями, которые хранятся в таблице `xui_hosts`, и зафиксировать фактический ответ (особенно код состояния).
- В веб-интерфейсе панели 3X-UI или через её API получить список inbound'ов и проверить, существует ли inbound с ID, который записан в `xui_hosts.host_inbound_id` для проблемного хоста.
- Сопоставить результаты: если inbound с таким ID отсутствует, зафиксировать это как фактическую причину 404; если присутствует, проверить, не отличается ли путь/версия панели (например, изменён префикс, другие эндпоинты), снова через фактические HTTP-запросы.

5. **Корректировка конфигурации (по итогам проверки)**

- Если будет подтверждено, что `host_inbound_id` в БД не соответствует реальному inbound в панели (inbound удалён/изменён), скорректировать конфигурацию через штатные механизмы (панель/миграции), чтобы значение в `xui_hosts` указывало на существующий inbound.
- При необходимости, если панель была переустановлена или изменены inbound'ы, синхронизировать все соответствующие записи в `xui_hosts` с актуальными ID из панели.

6. **Усиление логирования для будущих расследований (при вашем согласии на правки кода)**

- В `_panel_update_client_quota` дополнительно логировать `host_url`, `inbound_id` и, по возможности, `host_name`, чтобы при следующем срабатывании ошибки сразу видеть, какая именно пара хост/inbound даёт 404.
- Добавить при вызовах `update_client_quota_on_host` и `create_or_update_key_on_host` более детальные информационные логи (host_name, email, host_inbound_id), чтобы по одной группе логов можно было без дополнительных действий восстановить полную цепочку данных.

### To-dos

- [ ] Подробно зафиксировать логику `_panel_update_client_quota` и источники `host_url` и `inbound_id` по коду `src/shop_bot/modules/xui_api.py` и `src/shop_bot/data_manager/database.py`.
- [ ] Сформулировать точный смысл ошибки `HTTP 404` в контексте запроса `GET {base}/panel/inbound/get/{inbound_id}` и того, что логин к панели уже прошёл успешно.
- [ ] Подготовить конкретные шаги для проверки на боевом сервере: как получить `host_inbound_id` из `xui_hosts`, как руками вызвать `/panel/inbound/get/{id}` и как сверить это с фактическим списком inbound'ов панели.
- [ ] Сформулировать рекомендации по безопасной корректировке `host_inbound_id` и синхронизации `xui_hosts` с панелью после подтверждения причины.
- [ ] Подготовить предложение по улучшению логирования вокруг `_panel_update_client_quota` (логировать host/inbound/email) без изменения бизнес-логики, чтобы в будущем ускорить диагностику.