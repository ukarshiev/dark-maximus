<!-- c42302c0-d082-4fc0-9393-8e1c4bba5859 8ac9e765-5acd-4e02-b1d7-5de95c128828 -->
# План устранения ошибок отсутствующих колонок в scheduler (безопасный подход)

## Проблема

В логах scheduler появляются ошибки:

- `"no such column: key_id"` при работе с таблицей `notifications`
- `"no such column: status"` при работе с таблицей `vpn_keys`

## Принципы безопасности (Best Practices)

- Все изменения выполняются через проверки существования колонок (PRAGMA table_info)
- Graceful degradation: если колонка отсутствует, код работает безопасно без ошибок
- Использование транзакций для атомарности изменений
- Детальное логирование для диагностики
- Обратная совместимость со старыми базами данных
- Никаких изменений без проверок - все операции защищены try-except

## Решение

### Этап 1: Исправление структуры таблицы notifications в initialize_db()

**Файл**: `src/shop_bot/data_manager/database.py` (строка ~472)

**Действие**: Добавить колонки `key_id INTEGER` и `marker_hours INTEGER` в CREATE TABLE для `notifications`

**Безопасность**: Это гарантирует правильную структуру для новых баз данных. Старые базы будут обработаны через существующую миграцию.

### Этап 2: Создание хелпера для проверки существования колонок

**Файл**: `src/shop_bot/data_manager/database.py`

**Действие**: Добавить функцию `_column_exists(cursor, table_name, column_name)` для безопасной проверки существования колонки

**Безопасность**: Функция обернута в try-except, возвращает False при любой ошибке, что безопасно для использования.

### Этап 3: Добавление безопасной проверки колонки status в update_keys_status_by_expiry()

**Файл**: `src/shop_bot/data_manager/database.py` (строка ~7663)

**Действие**:

- В начале функции проверить существование колонки `status` через `_column_exists()`
- Если колонка отсутствует: логировать WARNING и вернуть 0 без ошибки
- Продолжить работу приложения без прерывания

**Безопасность**: Graceful degradation - функция просто пропускает обновление статуса, не ломая работу scheduler.

### Этап 4: Добавление безопасных проверок колонки key_id в _marker_logged()

**Файл**: `src/shop_bot/data_manager/scheduler.py` (строка ~225)

**Действие**:

- Добавить проверку существования колонки `key_id` перед выполнением SELECT
- Если колонка отсутствует, вернуть `False` (уведомление не было отправлено)
- Обернуть проверку в try-except

**Безопасность**: Безопасное поведение по умолчанию - если колонка отсутствует, считаем что уведомление не было отправлено.

### Этап 5: Добавление безопасных проверок в cleanup_duplicate_notifications()

**Файл**: `src/shop_bot/data_manager/scheduler.py` (строка ~245)

**Действие**:

- Проверить существование колонок `key_id` и `marker_hours` перед выполнением DELETE с GROUP BY
- Если колонки отсутствуют, пропустить очистку дубликатов с WARNING
- Продолжить выполнение остальной части функции (очистка старых уведомлений)

**Безопасность**: Частичная функциональность - очистка старых уведомлений работает даже без key_id.

### Этап 6: Улучшение обработки ошибок миграции

**Файл**: `src/shop_bot/data_manager/database.py` (строка ~1856)

**Действие**: Изменить уровень логирования с `logger.debug` на `logger.warning` при ошибках добавления колонок

**Безопасность**: Улучшенная диагностика без изменения логики работы.

## Гарантии безопасности

1. Обратная совместимость: Все изменения работают со старыми базами данных
2. Graceful degradation: При отсутствии колонок код работает безопасно без ошибок
3. Защита от ошибок: Все операции обернуты в try-except
4. Детальное логирование: Все пропуски операций логируются для диагностики
5. Атомарность: Использование транзакций SQLite для целостности данных
6. Нет breaking changes: Существующий функционал не нарушается

## Ожидаемый результат

- Полное отсутствие ошибок "no such column" в логах scheduler
- Корректная работа со старыми и новыми базами данных
- Улучшенная диагностика проблем с миграцией через WARNING логи
- Безопасная деградация функционала при отсутствии колонок

### To-dos

- [ ] Добавить колонки key_id и marker_hours в CREATE TABLE для notifications в initialize_db()
- [ ] Добавить проверку существования колонки status в update_keys_status_by_expiry() перед использованием
- [ ] Добавить проверку существования колонки key_id в _marker_logged() перед использованием
- [ ] Добавить проверку существования колонки key_id в cleanup_duplicate_notifications() перед использованием
- [ ] Улучшить обработку ошибок миграции - логировать как WARNING вместо DEBUG