<!-- 70a1391d-a011-4812-a571-e4702ca8d8a5 5f6feaff-dfea-4e3f-9b4d-fff8eaa70d18 -->
# Исправление ссылки TON Explorer и часового пояса

## Проблема 1: Неправильная ссылка на TON Explorer

**Текущая ситуация:**

- Функция `get_ton_transaction_url()` использует `tonscan.org` вместо `tonviewer.com`
- В качестве хеша транзакции используется BOC (base64), а не hex-хеш транзакции
- Правильный формат: `https://tonviewer.com/transaction/{hex_hash}` где hex_hash - 64 символа hex

**ВАЖНО: Использовать Context7 для получения фактической информации**

Перед внесением изменений необходимо:

1. Использовать Context7 для получения документации по TON Connect SDK и TON Blockchain
2. Проверить фактический формат хеша транзакции в документации TON Connect
3. Проверить фактический формат URL для tonviewer.com в документации TON
4. Проверить где именно хранится hex-хеш транзакции в коде (в метаданных, в результате TON Connect, в БД)
5. НЕ предполагать и НЕ догадываться - руководствоваться только фактами из документации и кода

**Исправления (после получения фактической информации из Context7):**

1. Изменить URL в функции `get_ton_transaction_url()` с `tonscan.org` на `tonviewer.com` (если это подтверждено документацией)
2. Найти где хранится hex-хеш транзакции (проверить фактически в коде: метаданные транзакции в БД, результат TON Connect, другие источники)
3. Использовать hex-хеш вместо BOC для формирования ссылки (если это подтверждено документацией)
4. Обновить все места где используется ссылка на TON Explorer:

- `src/shop_bot/bot/handlers.py` - функция `get_ton_transaction_url()` и место где она вызывается
- `src/shop_bot/webhook_server/templates/transactions.html` - ссылка в таблице транзакций
- `src/shop_bot/webhook_server/templates/check_payment.html` - ссылка на странице проверки платежа
- `src/shop_bot/webhook_server/static/js/script.js` - если есть ссылки в JS

**Файлы для изменения:**

- `src/shop_bot/bot/handlers.py` (строка 6841-6843)
- `src/shop_bot/webhook_server/templates/transactions.html` (строка 149)
- `src/shop_bot/webhook_server/templates/check_payment.html` (строка 44)
- `src/shop_bot/webhook_server/static/js/script.js` (строка 1664, если есть)

## Проблема 2: Часовой пояс не применяется на боевом сервере

**Текущая ситуация:**

- На тестовом сервере часовой пояс работает корректно
- На боевом сервере пользователь выставил "Самоа (UTC-11)", но ключи все равно отображаются в UTC+3
- Даты отображаются как: "Приобретён: 25.11.2025 в 03:12 (UTC+3)" вместо времени в часовом поясе Самоа

**Возможные причины:**

1. Feature flag `feature_timezone_enabled` выключен на боевом сервере
2. `user_timezone` не установлен правильно в БД для пользователя
3. Функция `_get_user_timezone_context()` возвращает неправильные значения

**ВАЖНО: Выяснить точные причины на боевом сервере**

Перед внесением изменений необходимо подключиться к боевому серверу и проверить фактическое состояние:

1. Подключиться к боевому серверу: `ssh root@31.56.27.129`
2. Проверить фактическое значение `feature_timezone_enabled` в БД (таблица `bot_settings`)
3. Проверить фактическое значение `timezone` для пользователя в БД (таблица `users`)
4. Проверить логи приложения для понимания как вызывается `format_datetime_for_user()`
5. Проверить фактически какие параметры передаются в функцию `format_datetime_for_user()`
6. НЕ предполагать и НЕ догадываться - руководствоваться только фактами из БД и логов

**Исправления (после выяснения точных причин на боевом сервере):**

1. Исправить проблему на основе фактических данных из БД и логов
2. Убедиться что функция `format_datetime_for_user()` получает правильные параметры `user_timezone` и `feature_enabled`
3. Добавить логирование для отладки (если нужно)

**Файлы для проверки/изменения:**

- `src/shop_bot/bot/handlers.py` - функция `_get_user_timezone_context()` (строка 82-88)
- `src/shop_bot/config.py` - функция `get_key_info_text()` (строка 280-281)
- `src/shop_bot/config.py` - функция `get_purchase_success_text()` (строка 491)
- `src/shop_bot/utils/datetime_utils.py` - функция `format_datetime_for_user()` (строка 217-268)
- `src/shop_bot/data_manager/database.py` - функции `is_timezone_feature_enabled()` и `get_user_timezone()`

**Проверка:**

- Убедиться что `feature_timezone_enabled = '1'` в БД
- Убедиться что `timezone = 'Pacific/Apia'` (или правильное значение для Самоа) в БД для пользователя
- Проверить что функция `format_datetime_for_user()` вызывается с правильными параметрами

## Фактическая информация из Context7

**Формат URL для tonviewer.com:**

- `https://tonviewer.com/transaction/{hash as base64url}` или
- `https://tonviewer.com/transaction/${txHash.toString("hex")}`

**Формат хеша транзакции:**

- TON Connect возвращает BOC (base64) в результате `sendTransaction()`
- Для ссылки на tonviewer.com нужен hex-хеш транзакции (64 символа)
- Хеш транзакции можно получить из BOC или из метаданных транзакции в БД

**Важно:**

- НЕ использовать BOC напрямую в URL
- Нужно конвертировать BOC в hex-хеш или получить hex-хеш из другого источника
- Проверить фактически в коде где хранится hex-хеш транзакции

## Порядок выполнения

1. **Исправить ссылку на TON Explorer (проблема 1):**

- Использовать Context7 для получения фактической информации о формате URL и хеша
- Проверить в коде где хранится hex-хеш транзакции (БД, метаданные, результат TON Connect)
- Изменить URL с `tonscan.org` на `tonviewer.com`
- Исправить формат хеша (использовать hex вместо BOC)
- Обновить все места где используется ссылка на TON Explorer

2. **Проверить и исправить часовой пояс (проблема 2):**

- Проверить фактически в БД значение `feature_timezone_enabled` (таблица `bot_settings`)
- Проверить фактически в БД значение `timezone` для пользователя (таблица `users`)
- Проверить фактически в коде как вызывается `format_datetime_for_user()`
- Исправить проблему на основе фактических данных из БД и кода
- Добавить логирование для отладки (если нужно)

3. **Обновить документацию:**

- Обновить CHANGELOG.md с описанием исправлений
- Обновить версию в pyproject.toml

4. **Развертывание на боевой сервер:**

- Подключиться к серверу: `ssh root@31.56.27.129`
- Выполнить развертывание изменений (git pull или другой метод развертывания)
- Перезапустить сервисы если необходимо

5. **Тестирование на боевом сервере:**

- Протестировать ссылку на TON Explorer:
- Создать тестовую транзакцию через TON Connect
- Проверить что ссылка ведет на `tonviewer.com` с правильным hex-хешем
- Убедиться что ссылка открывается корректно
- Протестировать часовой пояс:
- Проверить что пользователь с часовым поясом "Самоа (UTC-11)" видит даты в правильном формате
- Проверить что даты отображаются как "Приобретён: 25.11.2025 в XX:XX (UTC-11)" вместо UTC+3
- Убедиться что все ключи отображаются в правильном часовом поясе
- Убедиться что все изменения работают корректно