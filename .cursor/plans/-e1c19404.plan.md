<!-- e1c19404-cc9f-4090-905e-9d2db8032d82 5e4e9581-1928-4cb9-87ad-dd99ebf09160 -->
# Исправление тестов доменов

## Проблемы

1. **test_get_global_domain_fallback_to_localhost** - тест падает, возможно из-за неправильной работы с настройками в тестовой БД
2. **test_domain_settings_fallback_chain** - тест ожидает fallback на localhost, но не устанавливает `server_environment` в "development"
3. **test_no_hardcoded_domains_in_python_code** - находит жестко прописанные домены в `keyboards.py`, `xui_api.py`, `database.py`
4. **test_no_hardcoded_subdomains_in_python_code** - находит жестко прописанные поддомены в тех же файлах

## Решение

### 1. Исправление теста test_domain_settings_fallback_chain

**Файл:** `tests/integration/test_domain_integration.py`

Проблема: тест ожидает fallback на localhost, но не устанавливает `server_environment` в "development", поэтому по умолчанию будет "production" и вернется None.

**Исправление:** Добавить установку `server_environment` в "development" перед проверкой fallback для `global_domain`.

### 2. Удаление жестко прописанных доменов из кода

#### 2.1. Исправление keyboards.py

**Файл:** `src/shop_bot/bot/keyboards.py` (строки 626, 629, 632)

Проблема: жестко прописанный домен `help.dark-maximus.com` используется как fallback.

**Исправление:**

- Заменить жестко прописанный домен на получение из настройки `codex_docs_domain` с fallback на `get_global_domain()` или None
- Если все fallback не сработали, использовать None вместо жестко прописанного домена (или логировать предупреждение)

#### 2.2. Исправление xui_api.py

**Файл:** `src/shop_bot/modules/xui_api.py` (строка 80)

Проблема: жестко прописанный домен `dark-maximus.com` используется как fallback для User-Agent.

**Исправление:**

- Заменить на получение из `get_global_domain()` с нормализацией
- Если `get_global_domain()` возвращает None, использовать пустую строку или логировать предупреждение

#### 2.3. Исправление database.py

**Файл:** `src/shop_bot/data_manager/database.py` (строка 811)

Проблема: жестко прописанный домен `panel.dark-maximus.com` используется как fallback для TON manifest.

**Исправление:**

- Заменить на использование `get_global_domain()` или None
- Если домен не настроен, использовать None или логировать предупреждение

### 3. Проверка работы тестов

После исправлений:

- Запустить все 4 теста локально
- Проверить отчет в Allure
- Убедиться, что тесты проходят на production и development серверах

## Файлы для изменения

1. `tests/integration/test_domain_integration.py` - исправление теста fallback chain
2. `src/shop_bot/bot/keyboards.py` - удаление жестко прописанных доменов
3. `src/shop_bot/modules/xui_api.py` - удаление жестко прописанных доменов
4. `src/shop_bot/data_manager/database.py` - удаление жестко прописанных доменов