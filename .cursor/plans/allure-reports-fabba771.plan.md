<!-- fabba771-c491-405e-ac7d-938d53364093 1152ec43-0321-4602-8ec5-506182a66dcd -->
# План исправления проблем Allure Reports

## Факты, собранные в результате исследования

### Установленные факты:

1. **Версия образа**: `frankescobar/allure-docker-service:latest` (ID: 4154286c0209, создан 2025-10-29)
2. **Конфигурация docker-compose.yml**: Исправлена (слитые строки разделены)
3. **Структура JSON в allure-results/**: Корректна, названия тестов без пробелов

- Пример: `"name": "test_promo_code_application_validation"`
- Пример: `"fullName": "integration.test_vpn_purchase.test_promo_code_application.TestPromoCodeApplication#test_promo_code_application_validation"`

4. **Логи allure-service**: Статус 200, отчёты генерируются успешно
5. **Проблема в allure-categories.json**: Дубликат категории "Test defects" (строки 8-12 и 13-17)

### Обнаруженные проблемы:

1. **JavaScript ошибки в консоли браузера**:

- `Cannot read properties of undefined (reading 'total')`
- `Cannot read properties of undefined (reading 'slice')`
- `t.reverse is not a function`
- `Element not found` для #categories:412

2. **Пробелы в названиях тестов в UI**:

- Отображается: "unit.te t_webhook_ erver" вместо "unit.test_webhook_server"
- Отображается: "Te t defect" вместо "Test defect"
- В JSON данные корректны, проблема в отображении фронтендом

3. **Дубликат категории в allure-categories.json**

## План исправления (на основе best practices и context7)

### Этап 1: Исправление конфигурации категорий

- **Действие**: Устранить дубликат категории "Test defects" в allure-categories.json
- **Обоснование**: Дубликаты могут вызывать проблемы при обработке данных фронтендом
- **Best practice**: Каждая категория должна быть уникальной

### Этап 2: Проверка и валидация структуры данных

- **Действие**: Проверить, что все JSON файлы в allure-results/ валидны
- **Метод**: Использовать `jq` или Python для валидации JSON
- **Обоснование**: Некорректные JSON могут вызывать JavaScript ошибки при парсинге

### Этап 3: Проверка версии Allure в образе

- **Действие**: Определить версию Allure Report, используемую в образе
- **Метод**: Проверить package.json или другие файлы версий внутри контейнера
- **Обоснование**: Возможна несовместимость версий Allure-pytest и Allure Report

### Этап 4: Диагностика JavaScript ошибок

- **Действие**: Исследовать источник JavaScript ошибок
- **Метод**: 
- Проверить сгенерированный HTML/JS в `/app/allure-docker-api/static/projects/default/reports/latest/`
- Проверить, какие данные ожидает фронтенд и какие получает
- **Обоснование**: Ошибки указывают на проблемы с данными или версией фронтенда

### Этап 5: Обновление конфигурации pytest (best practices)

- **Действие**: Проверить использование `@allure.title` и других декораторов
- **Метод**: Убедиться, что все тесты используют правильные декораторы согласно context7
- **Best practice**: Использовать `@allure.title` для читаемых названий тестов

### Этап 6: Тестирование исправлений

- **Действие**: Пересоздать отчёты и проверить исправления
- **Метод**: 
- Очистить allure-results/ (кроме executor.json)
- Перезапустить тесты
- Проверить веб-интерфейс
- **Обоснование**: Необходимо убедиться, что исправления работают

### Этап 7: Мониторинг и документация

- **Действие**: Документировать решение и добавить проверки
- **Метод**: Обновить документацию проекта
- **Best practice**: Документировать решения для будущих разработчиков

## Приоритизация задач

**Критичные (блокируют работу)**:

1. Исправление дубликата в allure-categories.json
2. Диагностика JavaScript ошибок

**Важные (влияют на UX)**:

3. Проблемы с отображением названий тестов
4. Валидация структуры данных

**Рекомендуемые (улучшения)**:

5. Обновление конфигурации pytest
6. Документирование решений

## Риски и ограничения

1. **Проблемы с отображением названий** могут быть связаны с версией Allure Report в образе
2. **JavaScript ошибки** могут требовать обновления образа Docker
3. **Необходимость пересоздания отчётов** для проверки исправлений

## Метрики успеха

- Отсутствие JavaScript ошибок в консоли браузера
- Корректное отображение названий тестов без пробелов
- Отсутствие дубликатов категорий
- Успешная генерация отчётов без ошибок в логах

### To-dos

- [ ] Исправить дубликат категории "Test defects" в allure-categories.json
- [ ] Проверить валидность всех JSON файлов в allure-results/ используя валидацию
- [ ] Определить версию Allure Report в Docker образе и проверить совместимость с allure-pytest
- [ ] Исследовать источник JavaScript ошибок (total, slice, reverse) через анализ сгенерированного HTML/JS
- [ ] Исправить проблемы с отображением названий тестов (пробелы в UI)
- [ ] Проверить использование @allure.title и других декораторов согласно best practices
- [ ] Пересоздать отчёты с исправлениями и проверить результат
- [ ] Документировать решение и добавить в документацию проекта