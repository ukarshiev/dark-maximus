<!-- a1d13863-d251-4e70-ac79-58a43b4da930 03660da7-76a7-455b-bb7a-3b7e8fcdbcc4 -->
# Исправление структуры Allure для корректного отображения всех тестов

## Проблемы

1. **Неправильная структура директорий:**

   - `tests/allure-results/` - НЕ должно быть здесь (результаты должны быть только в корне)
   - `tests/{env:ALLURE_RESULTS_DIR:` - ошибка синтаксиса, создана неправильная директория
   - Результаты сохраняются в разные места, не все тесты попадают в Allure

2. **Конфигурация pytest:**

   - `pytest.ini` содержит абсолютный путь `/app/allure-results`
   - `conftest.py` переопределяет путь через `pytest_configure`
   - Но результаты все равно не сохраняются для всех тестов

3. **По документации Allure (Context7):**

   - `--alluredir <DIRECTORY>` - путь к директории для результатов
   - Директория создается автоматически, если её нет
   - По best practices: `allure-results/` должна быть в **корне проекта**, не в `tests/`

## Правильная структура (по Allure best practices)

```
project/
├── allure-results/              # ТОЛЬКО В КОРНЕ! JSON результаты тестов
│   ├── *.json                  # Результаты каждого теста (*-result.json, *-container.json)
│   ├── executor.json           # Метаданные выполнения
│   └── history/                # История для трендов
│
├── allure-report/              # Сгенерированные HTML отчеты (опционально)
│
├── allure-reports/             # Для allure-docker-service (сгенерированные отчеты)
│
├── tests/
│   ├── pytest.ini              # Конфигурация pytest
│   ├── conftest.py             # Фикстуры
│   └── ...                      # НЕТ allure-results здесь!
│
└── allure-categories.json       # Правила категоризации
```

## Решение

### 1. Перемещение результатов из неправильных директорий

**ВАЖНО:** Сначала переместить все файлы, чтобы не потерять результаты тестов.

**Шаги:**

1. **Переместить файлы из `tests/allure-results/` в корневую `allure-results/`:**

   - В `tests/allure-results/` найдено 10 файлов (JSON результаты)
   - Переместить все файлы: `Move-Item -Path "tests\allure-results\*" -Destination "allure-results\" -Force`
   - Сохранить структуру поддиректорий (если есть `history/`, переместить её тоже)

2. **Переместить файлы из `tests/{env:ALLURE_RESULTS_DIR:` в корневую `allure-results/`:**

   - В `tests/{env:ALLURE_RESULTS_DIR:` найдено 7 файлов (6 JSON, 1 TXT)
   - Переместить все файлы: `Move-Item -Path "tests\{env:ALLURE_RESULTS_DIR:\*" -Destination "allure-results\" -Force -Recurse`
   - Сохранить структуру поддиректорий (если есть)

3. **Удалить пустые директории только после перемещения:**

   - Удалить `tests/allure-results/` только если она пустая
   - Удалить `tests/{env:ALLURE_RESULTS_DIR:` только если она пустая

### 2. Исправление конфигурации pytest.ini

**Файл:** `tests/pytest.ini`

Изменить путь на относительный от корня проекта:

- Текущее: `--alluredir=/app/allure-results` (абсолютный путь)
- Правильное: использовать относительный путь или оставить абсолютный, но убедиться, что он работает

**По документации Allure:**

- Путь может быть относительным или абсолютным
- Относительный путь вычисляется от `rootdir` pytest
- `rootdir` определяется автоматически (обычно директория с `pytest.ini` или `setup.py`)

**Решение:** Использовать относительный путь `../allure-results` от `tests/` к корню, или оставить абсолютный `/app/allure-results`, но убрать переопределение в `conftest.py`, если оно мешает.

### 3. Исправление conftest.py

**Файл:** `tests/conftest.py`

Проблема: `pytest_configure` устанавливает путь, но это может конфликтовать с настройками из `pytest.ini`.

**Решение:**

- Убрать переопределение пути в `pytest_configure`, если путь в `pytest.ini` правильный
- ИЛИ оставить `pytest_configure`, но убедиться, что путь устанавливается ДО того, как allure-pytest начинает сохранять результаты

### 4. Обновление скриптов очистки

**Файл:** `tests/ad-hoc/clear_allure_results.ps1`

Убедиться, что скрипт очищает правильную директорию (корневую `allure-results/`, а не `tests/allure-results/`).

### 5. Обновление скриптов проверки

**Файл:** `tests/ad-hoc/check_allure_results.ps1`

Убедиться, что скрипт проверяет правильную директорию (корневую `allure-results/`).

### 6. Проверка volume-маппингов

**Файл:** `docker-compose.yml`

Убедиться, что volume-маппинги правильные:

- `./allure-results:/app/allure-results` в `autotest`
- `./allure-results:/app/allure-docker-api/static/projects/default/results` в `allure-service`

### 7. Тестирование

После исправлений:

1. Удалить все старые результаты
2. Запустить полный набор тестов (484 теста)
3. Проверить количество файлов результатов в `allure-results/`
4. Проверить отчет в Allure - должно быть 484 теста

## Шаги реализации

1. Удалить неправильные директории `tests/allure-results/` и `tests/{env:ALLURE_RESULTS_DIR:`
2. Исправить `pytest.ini` - использовать правильный путь (относительный от корня проекта)
3. Упростить `conftest.py` - убрать переопределение пути, если не нужно
4. Обновить скрипты очистки и проверки для работы с корневой директорией
5. Проверить и обновить документацию
6. Протестировать: запустить все тесты и проверить, что все 484 теста отображаются в Allure