<!-- 839e465f-6d0f-490a-9b37-90500e74202d 5a18f179-ce7f-41f2-bab3-594a6d7b19fe -->
# Исправление тестов веб-панели

## Проблемы

1. **test_dashboard_page**: `TypeError: Object of type Undefined is not JSON serializable` - `chart_data.dates` возвращает Undefined
2. **test_performance_page**: `object MagicMock can't be used in 'await' expression` - нужен AsyncMock для `get_performance_monitor()`
3. **test_sync_key_with_xui**: эндпоинт `/api/sync-key/{key_id}` не существует (404)
4. **test_enable_disable_key**: эндпоинт `/api/update-key/{key_id}` не существует (404) - правильный: `/api/toggle-key-enabled`
5. **test_delete_key**: эндпоинт `/api/delete-key/{key_id}` не существует (404)
6. **test_get_user_details, test_update_user, test_reset_user_trial, test_delete_user_keys**: возможно, похожие проблемы

## Решения

### 1. test_dashboard_page (test_dashboard.py)

- Исправить мок `get_daily_stats_for_charts` - должен возвращать структуру с `dates`, `earnings`, `keys`, `users`
- Убрать дублирование создания `app` (строки 48 и 50)
- Добавить подробные Allure аннотации с `allure.step()` и `allure.attach()`

### 2. test_performance_page (test_dashboard.py)

- Исправить мок `get_performance_monitor()` - использовать AsyncMock вместо MagicMock
- Убрать дублирование создания `app` (строки 88 и 90)
- Добавить подробные Allure аннотации

### 3. test_sync_key_with_xui (test_keys.py)

- Исправить эндпоинт: использовать `/refresh-user-keys` с POST и JSON body `{'user_id': user_id}` или создать отдельный эндпоинт для синхронизации одного ключа
- Добавить подробные Allure аннотации

### 4. test_enable_disable_key (test_keys.py)

- Исправить эндпоинт: `/api/toggle-key-enabled` с POST и JSON body `{'key_id': key_id, 'enabled': True/False}`
- Добавить подробные Allure аннотации

### 5. test_delete_key (test_keys.py)

- Найти правильный эндпоинт для удаления ключа или использовать существующий
- Добавить подробные Allure аннотации

### 6. test_get_user_details, test_update_user, test_reset_user_trial, test_delete_user_keys (test_users.py)

- Проверить правильность эндпоинтов
- Добавить подробные Allure аннотации

## Файлы для изменения

- `tests/unit/test_webhook_server/test_dashboard.py`
- `tests/unit/test_webhook_server/test_keys.py`
- `tests/unit/test_webhook_server/test_users.py`
- `tests/unit/test_webhook_server/test_auth.py` (добавить подробные аннотации)

## Использование Ref MCP

Использовать Ref MCP для поиска информации о:

- Flask test_client и сессиях
- Allure аннотациях (step, attach, description)
- Правильных эндпоинтах API

## После исправления

1. Запустить все указанные тесты
2. Проверить отчет в Allure
3. Убедиться, что все тесты проходят

### To-dos

- [ ] Исправить test_dashboard_page: мок get_daily_stats_for_charts, убрать дублирование app, добавить Allure аннотации
- [ ] Исправить test_performance_page: AsyncMock для get_performance_monitor, убрать дублирование app, добавить Allure аннотации
- [ ] Исправить test_sync_key_with_xui: использовать правильный эндпоинт, добавить Allure аннотации
- [ ] Исправить test_enable_disable_key: использовать /api/toggle-key-enabled, добавить Allure аннотации
- [ ] Исправить test_delete_key: найти правильный эндпоинт, добавить Allure аннотации
- [ ] Исправить тесты пользователей: проверить эндпоинты, добавить Allure аннотации
- [ ] Добавить подробные Allure аннотации в test_login_required_decorator
- [ ] Запустить все исправленные тесты и проверить отчет в Allure