<!-- 066e87c1-18d6-4c56-87f6-cf32746316e6 3b2d9f23-0c8a-49e1-9b08-f469e7f4e39f -->
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ CSP –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ù–∞—Å—Ç—Ä–æ–π–∫–∞" –∏ "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"

## –ü—Ä–æ–±–ª–µ–º—ã

### 1. –ö–Ω–æ–ø–∫–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∞" –Ω–∞ localhost

–ö–Ω–æ–ø–∫–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∞" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É "Not Found" –Ω–∞ localhost. –°—Ç—Ä–∞–Ω–∏—Ü–∞ `http://localhost:50002/setup` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ä–∞–Ω—å—à–µ —Ä–∞–±–æ—Ç–∞–ª–∞. –ü—Ä–æ–±–ª–µ–º–∞:

- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `web_app=WebAppInfo(url=setup_url)` —Å `https://`
- Telegram Web App –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å `https://localhost:50002/setup` –±–µ–∑ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
- –î–ª—è localhost –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—É—é –∫–Ω–æ–ø–∫—É `url` –≤–º–µ—Å—Ç–æ `web_app`

### 2. –ö–Ω–æ–ø–∫–∞ "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ñ—Ä–µ–π–º—ã

–ù–∞ –±–æ–µ–≤–æ–π —Å—Å—ã–ª–∫–µ `https://app.dark-maximus.com/auth/...` –∏ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π `http://localhost:50003/auth/...` –≤—Å–µ —Ñ—Ä–µ–π–º—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π ERR_BLOCKED_BY_CSP. –ü—Ä–æ–±–ª–µ–º–∞:

- CSP –∑–∞–≥–æ–ª–æ–≤–æ–∫ `frame-ancestors 'self'` —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≥–æ –∂–µ –¥–æ–º–µ–Ω–∞
- Telegram Web App –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ iframe –Ω–∞ –¥–æ–º–µ–Ω–µ `t.me` –∏–ª–∏ `web.telegram.org`
- CSP –∑–∞–≥–æ–ª–æ–≤–æ–∫ `frame-src` –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç localhost –¥–ª—è development –∏ –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤—Å–µ –ø–æ–¥–¥–æ–º–µ–Ω—ã –¥–ª—è production
- –í `index.html` –µ—Å—Ç—å –¥–≤–∞ iframe: `setup-iframe` (codex-docs) –∏ `subscription-iframe` (–≤–Ω–µ—à–Ω–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä)

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞—Å—Ç—Ä–æ–π–∫–∞"

- –û–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ç–∏–ø –∫–Ω–æ–ø–∫–∏ –ø–æ –Ω–∞–ª–∏—á–∏—é localhost –≤ `setup_url`
- –ï—Å–ª–∏ localhost ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—É—é –∫–Ω–æ–ø–∫—É `url` –≤–º–µ—Å—Ç–æ `web_app`
- –ï—Å–ª–∏ –Ω–µ localhost ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `web_app` —Å `https://`

### 2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"

- –ò–∑–º–µ–Ω–∏—Ç—å –∫–Ω–æ–ø–∫—É "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" –Ω–∞ –æ–±—ã—á–Ω—É—é —Å—Å—ã–ª–∫—É `url` –≤–º–µ—Å—Ç–æ `web_app`

### 3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å CSP –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è user-cabinet

- –ò–∑–º–µ–Ω–∏—Ç—å `frame-ancestors 'self'` –Ω–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ Telegram –¥–æ–º–µ–Ω–æ–≤
- –î–æ–±–∞–≤–∏—Ç—å `https://t.me` –∏ `https://web.telegram.org` –≤ `frame-ancestors`
- –î–ª—è development: —Ä–∞–∑—Ä–µ—à–∏—Ç—å –ª—é–±—ã–µ –¥–æ–º–µ–Ω—ã –≤ `frame-src` (–¥–ª—è localhost –∏ –≤–Ω–µ—à–Ω–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤)
- –î–ª—è production: —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –ø–æ–¥–¥–æ–º–µ–Ω—ã –≥–ª–∞–≤–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–î –≤ `frame-src`

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. `src/shop_bot/bot/keyboards.py`:

   - –°—Ç—Ä–æ–∫–∏ 580-613: –ò–∑–º–µ–Ω–∏—Ç—å –∫–Ω–æ–ø–∫—É "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `url` –≤–º–µ—Å—Ç–æ `web_app`
   - –°—Ç—Ä–æ–∫–∏ 643-648: –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ "–ù–∞—Å—Ç—Ä–æ–π–∫–∞" - –ø—Ä–æ–≤–µ—Ä—è—Ç—å localhost –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `url` –¥–ª—è localhost

2. `apps/user-cabinet/app.py`:

   - –°—Ç—Ä–æ–∫–∏ 63-103: –ò–∑–º–µ–Ω–∏—Ç—å CSP –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å —É—á–µ—Ç–æ–º development/production —Ä–µ–∂–∏–º–∞
   - –°—Ç—Ä–æ–∫–∏ 216-248: –ò–∑–º–µ–Ω–∏—Ç—å CSP –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ health endpoint

## –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–ü–µ—Ä–µ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Context7 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

- CSP (Content Security Policy) —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ `frame-src` –∏ `frame-ancestors`
- Telegram Bot API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ä–∞–∑–ª–∏—á–∏–π –º–µ–∂–¥—É `url` –∏ `web_app` –∫–Ω–æ–ø–∫–∞–º–∏
- aiogram 3.21.0 –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `InlineKeyboardButton`

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `keyboards.py`:

#### 1. –ö–Ω–æ–ø–∫–∞ "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" (—Å—Ç—Ä–æ–∫–∏ 598-602):

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**

```python
if not _is_local_address(cabinet_url) and _is_https_url(cabinet_url):
    builder.button(
        text="üóÇÔ∏è –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç",
        web_app=WebAppInfo(url=cabinet_url)
    )
```

**–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π –∫–æ–¥:**

```python
if not _is_local_address(cabinet_url) and _is_https_url(cabinet_url):
    builder.button(
        text="üóÇÔ∏è –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç",
        url=cabinet_url  # –û–±—ã—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –≤–º–µ—Å—Ç–æ web_app
    )
```

#### 2. –ö–Ω–æ–ø–∫–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∞" (—Å—Ç—Ä–æ–∫–∏ 643-648):

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**

```python
if setup_url:
    builder.button(
        text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞",
        web_app=WebAppInfo(url=setup_url)
    )
```

**–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π –∫–æ–¥:**

```python
if setup_url:
    # –î–ª—è localhost –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é –∫–Ω–æ–ø–∫—É url, –¥–ª—è production - web_app
    if _is_local_address(setup_url):
        builder.button(
            text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞",
            url=setup_url  # –û–±—ã—á–Ω–∞—è —Å—Å—ã–ª–∫–∞, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å http://localhost
        )
    else:
        builder.button(
            text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞",
            web_app=WebAppInfo(url=setup_url)  # Web App, —Ç—Ä–µ–±—É–µ—Ç https://
        )
```

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `apps/user-cabinet/app.py`:

#### 1. CSP –∑–∞–≥–æ–ª–æ–≤–∫–∏ (—Å—Ç—Ä–æ–∫–∏ 63-103):

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**

```python
csp_policy = (
    "default-src 'self'; "
    "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://api.2ip.ru; "
    "style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; "
    "img-src 'self' data: https:; "
    "font-src 'self' data:; "
    f"connect-src 'self' https://api.2ip.ru https://{help_domain} https://*.{main_domain}; "
    f"frame-src 'self' https://{help_domain} https://*.{main_domain}; "
    "frame-ancestors 'self';"
)
```

**–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π –∫–æ–¥:**

```python
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Å–µ—Ä–≤–µ—Ä–∞
from shop_bot.data_manager.database import is_development_server
is_dev = is_development_server()

# –§–æ—Ä–º–∏—Ä—É–µ–º frame-src –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
if is_dev:
    # –î–ª—è development —Ä–∞–∑—Ä–µ—à–∞–µ–º –ª—é–±—ã–µ –¥–æ–º–µ–Ω—ã (localhost –∏ –≤–Ω–µ—à–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã)
    frame_src = "'self' http://localhost:* https:"
else:
    # –î–ª—è production —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ –ø–æ–¥–¥–æ–º–µ–Ω—ã –≥–ª–∞–≤–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–î
    # main_domain —É–∂–µ –∏–∑–≤–ª–µ—á–µ–Ω –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–î –≤—ã—à–µ
    frame_src = f"'self' https://{help_domain} https://*.{main_domain} https:"

csp_policy = (
    "default-src 'self'; "
    "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://api.2ip.ru; "
    "style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; "
    "img-src 'self' data: https:; "
    "font-src 'self' data:; "
    f"connect-src 'self' https://api.2ip.ru https://{help_domain} https://*.{main_domain}; "
    f"frame-src {frame_src}; "
    "frame-ancestors 'self' https://t.me https://web.telegram.org;"
)
```

#### 2. CSP –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ health endpoint (—Å—Ç—Ä–æ–∫–∏ 216-248):

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è health endpoint - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—É –∂–µ –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è `frame-src`.

**–í–∞–∂–Ω–æ:**

- `main_domain` –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–î (`global_domain`), –ø–æ—ç—Ç–æ–º—É –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ª—é–±—ã–º –¥–æ–º–µ–Ω–æ–º
- –î–ª—è development —Ä–∞–∑—Ä–µ—à–∞–µ–º `http://localhost:*` –∏ `https:` (–ª—é–±—ã–µ HTTPS –¥–æ–º–µ–Ω—ã)
- –î–ª—è production —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–¥–¥–æ–º–µ–Ω—ã –≥–ª–∞–≤–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ —á–µ—Ä–µ–∑ `https://*.{main_domain}` –∏ `https:` –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

- –ö–Ω–æ–ø–∫–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∞" —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ localhost —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—É—é —Å—Å—ã–ª–∫—É `http://localhost:50002/setup`
- –ö–Ω–æ–ø–∫–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∞" –Ω–∞ production —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Web App —Å HTTPS
- –ö–Ω–æ–ø–∫–∞ "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ (–Ω–µ Web App)
- –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω –≤ Telegram Web App (frame-ancestors —Ä–∞–∑—Ä–µ—à–∞–µ—Ç Telegram –¥–æ–º–µ–Ω—ã)
- Iframe —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ (setup-iframe) —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ localhost –∏ production
- Iframe —Å –ø–æ–¥–ø–∏—Å–∫–æ–π (subscription-iframe) —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≤–Ω–µ—à–Ω–∏–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –Ω–∞ –ª—é–±–æ–º –¥–æ–º–µ–Ω–µ
- CSP –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É—é—Ç—Å—è –∫ —Ä–µ–∂–∏–º—É —Å–µ—Ä–≤–µ—Ä–∞ (development/production) –∏ –¥–æ–º–µ–Ω–∞–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–î