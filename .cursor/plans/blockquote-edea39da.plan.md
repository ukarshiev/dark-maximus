<!-- edea39da-e323-480d-9f67-58b230b6973f 971dea6a-09aa-4da3-be2b-41f4835dc683 -->
# Добавление валидации HTML-тегов в шаблонах сообщений

## Проблема

В шаблоне `purchase_success_cabinet_subscription` была ошибка с дублирующимся тегом `<blockquote>`, что вызвало ошибку Telegram API. Чтобы предотвратить подобные проблемы в будущем, нужно добавить валидацию HTML-тегов.

## Решение

Добавить валидацию парности HTML-тегов для шаблонов сообщений в двух местах:

1. Перед сохранением шаблона в админ-панели (защита от сохранения некорректных шаблонов)
2. Перед отправкой сообщения в Telegram API (защита от падения бота)

## Шаги

1. Создать функцию валидации HTML-тегов

- Файл: `src/shop_bot/security/validators.py` (добавить в класс InputValidator как статический метод)
- Название: `validate_html_tags(text: str) -> Tuple[bool, List[str]]`
- Функция должна проверять парность открывающих и закрывающих тегов HTML
- Поддерживать теги Telegram HTML: `<b>`, `</b>`, `<i>`, `</i>`, `<u>`, `</u>`, `<s>`, `</s>`, `<a>`, `</a>`, `<code>`, `</code>`, `<pre>`, `</pre>`, `<blockquote>`, `</blockquote>`
- Использовать стек для проверки парности тегов
- Игнорировать самозакрывающиеся теги и содержимое тегов `<code>`, `<pre>`
- Возвращать `(is_valid: bool, errors: List[str])` - список найденных ошибок

2. Добавить валидацию при создании шаблона в админ-панели

- Файл: `src/shop_bot/webhook_server/app.py`, функция `api_create_message_template()` (строка 6069)
- После получения `template_text` и перед вызовом `create_message_template()` добавить валидацию
- Если валидация не пройдена - вернуть JSON с ошибкой и списком проблем
- Сообщение: "Ошибка валидации HTML-тегов: {список ошибок}"

3. Добавить валидацию при обновлении шаблона в админ-панели

- Файл: `src/shop_bot/webhook_server/app.py`, функция `api_update_message_template()` (строка 6103)
- После получения `template_text` и перед вызовом `update_message_template()` добавить валидацию (если `template_text` передан)
- Если валидация не пройдена - вернуть JSON с ошибкой и списком проблем

4. Добавить валидацию перед отправкой сообщения в Telegram

- Файл: `src/shop_bot/config.py`, функция `get_message_text()` (строка 538)
- После подстановки переменных (строка 568) и перед возвратом текста добавить валидацию
- Если валидация не пройдена - логировать предупреждение с деталями ошибок и вернуть `fallback_text`
- Это предотвратит падение бота при некорректных шаблонах

5. Обновить документацию и CHANGELOG

- Обновить CHANGELOG.md с информацией о добавлении валидации
- Обновить версию в pyproject.toml

### To-dos

- [ ] Проверить текущий шаблон purchase_success_cabinet_subscription в БД через SQL запрос
- [ ] Исправить шаблон в БД, убрав дублирующийся тег <blockquote> - заменить '<blockquote><blockquote>' на '<blockquote>'
- [ ] Обновить CHANGELOG.md с информацией об исправлении и обновить версию в pyproject.toml