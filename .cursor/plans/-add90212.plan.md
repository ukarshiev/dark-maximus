<!-- add90212-0a2d-4f65-b411-de1cd8e1ac05 9e5205ab-3a92-490d-887c-a522bd341e9f -->
# План: Добавление булевого атрибута SSL проверки для панелей 3x-ui

## Цель

Добавить возможность включать/отключать проверку SSL сертификатов для каждой панели 3x-ui через форму создания и редактирования хоста.

## Архитектура изменений

### 1. База данных

- Добавить колонку `ssl_verify_enabled INTEGER DEFAULT 1` в таблицу `xui_hosts`
- Значение по умолчанию: `1` (проверка SSL включена)
- Миграция должна добавить колонку и установить значение по умолчанию для существующих записей

### 2. Backend (database.py)

- Обновить функцию `create_host()` для поддержки параметра `ssl_verify_enabled`
- Обновить функцию `update_host()` для поддержки параметра `ssl_verify_enabled`
- Обновить функцию `get_host()` для возврата значения `ssl_verify_enabled`
- Добавить миграцию для добавления колонки

### 3. Backend (xui_api.py)

- Обновить функцию `login_to_host()` для приема параметра `ssl_verify_enabled`
- Заменить `use_tls_verify=False` на `use_tls_verify=ssl_verify_enabled`
- Обновить все функции, использующие `verify=False`, чтобы они принимали параметр из хоста
- Функции для обновления: `get_sub_uri_from_panel()`, `_panel_update_client_quota()`, `_panel_update_client_enabled_status()`, и другие

### 4. Backend (app.py)

- Обновить route `/add-host` для получения `ssl_verify_enabled` из формы
- Обновить route `/edit-host` для получения `ssl_verify_enabled` из формы
- Обновить route `/check-host` для использования `ssl_verify_enabled` из хоста

### 5. Frontend (settings.html)

- Добавить checkbox в форму создания хоста (строка 40-96)
- Добавить checkbox в модальное окно редактирования хоста (функция `openHostModal`)
- Обновить функцию `openHostModalData()` для передачи значения `ssl_verify_enabled`
- Добавить data-атрибут в кнопку редактирования хоста для передачи значения

## Детальный план реализации

### Шаг 1: Миграция базы данных

**Файл:** `src/shop_bot/data_manager/database.py`

- Найти функцию `run_migration()` (около строки 1117)
- Добавить миграцию для колонки `ssl_verify_enabled`:
  ```python
  # Проверка существования колонки ssl_verify_enabled
  cursor.execute("PRAGMA table_info(xui_hosts)")
  hosts_columns = [row[1] for row in cursor.fetchall()]
  if 'ssl_verify_enabled' not in hosts_columns:
      cursor.execute("ALTER TABLE xui_hosts ADD COLUMN ssl_verify_enabled INTEGER DEFAULT 1")
      # Устанавливаем значение по умолчанию для существующих записей
      cursor.execute("UPDATE xui_hosts SET ssl_verify_enabled = 1 WHERE ssl_verify_enabled IS NULL")
  ```


### Шаг 2: Обновление функций работы с хостами

**Файл:** `src/shop_bot/data_manager/database.py`

1. **Функция `create_host()` (строка 2321):**

   - Добавить параметр `ssl_verify_enabled: bool = True`
   - Обновить INSERT запрос для включения `ssl_verify_enabled`
   - Значение по умолчанию: `1` (True)

2. **Функция `update_host()` (строка 2374):**

   - Добавить параметр `ssl_verify_enabled: bool | None = None`
   - Обновить UPDATE запрос для включения `ssl_verify_enabled` (если передан)

3. **Функция `get_host()` (строка 2428):**

   - Убедиться, что возвращает `ssl_verify_enabled` в словаре
   - Преобразовать INTEGER в bool при возврате

### Шаг 3: Обновление xui_api.py

**Файл:** `src/shop_bot/modules/xui_api.py`

1. **Функция `login_to_host()` (строка 141):**

   - Добавить параметр `ssl_verify_enabled: bool = True`
   - Заменить `use_tls_verify=False` на `use_tls_verify=ssl_verify_enabled`
   - Обновить комментарий (строка 175)

2. **Функция `get_sub_uri_from_panel()` (строка 29):**

   - Добавить параметр `ssl_verify_enabled: bool = True`
   - Заменить `verify=False` на `verify=ssl_verify_enabled` (строки 42, 48)

3. **Функция `_panel_update_client_quota()` (строка 1067):**

   - Добавить параметр `ssl_verify_enabled: bool = True`
   - Заменить `verify=False` на `verify=ssl_verify_enabled` (строки 1074, 1080, 1143)

4. **Функция `_panel_update_client_enabled_status()` (строка 1175):**

   - Добавить параметр `ssl_verify_enabled: bool = True`
   - Заменить `verify=False` на `verify=ssl_verify_enabled` (строки 1182, 1188, 1246)

5. **Найти все места, где вызываются эти функции:**

   - Обновить вызовы для передачи `ssl_verify_enabled` из данных хоста
   - Проверить `scheduler.py` и другие места использования

### Шаг 4: Обновление API endpoints

**Файл:** `src/shop_bot/webhook_server/app.py`

1. **Route `/add-host` (строка 2593):**

   - Добавить получение `ssl_verify_enabled` из формы: `request.form.get('ssl_verify_enabled') == 'on'`
   - Передать значение в `create_host()`

2. **Route `/edit-host` (строка 2645):**

   - Добавить получение `ssl_verify_enabled` из формы
   - Передать значение в `update_host()`

3. **Route `/check-host` (строка 2625):**

   - Получить `ssl_verify_enabled` из хоста
   - Передать в `login_to_host()`

### Шаг 5: Обновление frontend

**Файл:** `src/shop_bot/webhook_server/templates/settings.html`

1. **Форма создания хоста (строка 40-96):**

   - Добавить checkbox после поля `host_code`:
   ```html
   <div class="form-group">
       <label>
           <input type="checkbox" name="ssl_verify_enabled" id="ssl_verify_enabled" checked>
           Проверять SSL сертификат
       </label>
       <small class="text-muted">Отключите для панелей с самоподписанными сертификатами</small>
   </div>
   ```


2. **Модальное окно редактирования (функция `openHostModal`, строка 1974):**

   - Добавить параметр `sslVerify=''` в сигнатуру функции
   - Добавить checkbox в форму:
   ```html
   <div class="form-group">
       <label>
           <input type="checkbox" name="ssl_verify_enabled" ${sslVerify === '1' || sslVerify === '' ? 'checked' : ''}>
           Проверять SSL сертификат
       </label>
   </div>
   ```


3. **Функция `openHostModalData()` (строка 2006):**

   - Добавить получение `data-ssl-verify-enabled` атрибута
   - Передать значение в `openHostModal()`

4. **Кнопка редактирования хоста (строка 118):**

   - Добавить data-атрибут: `data-ssl-verify-enabled="{{ host.ssl_verify_enabled or 1 }}"`

### Шаг 6: Обновление всех мест использования

**Файлы:** `src/shop_bot/data_manager/scheduler.py`, другие файлы

- Найти все места, где вызываются функции из `xui_api.py`
- Обновить вызовы для передачи `ssl_verify_enabled` из данных хоста
- Проверить функцию `sync_with_xui_panels()` в `scheduler.py`

## Ожидаемый результат

После реализации:

- ✅ В форме создания/редактирования хоста появится checkbox "Проверять SSL сертификат"
- ✅ По умолчанию проверка SSL включена (для безопасности)
- ✅ Можно отключить проверку SSL для конкретных панелей с самоподписанными сертификатами
- ✅ Значение сохраняется в базе данных и используется при всех подключениях к панели
- ✅ Существующие панели получат значение по умолчанию (проверка включена)

## Риски и митигация

**Риски:**

- Если существующие панели используют самоподписанные сертификаты, они перестанут работать после миграции
- Нужно будет вручную отключить проверку SSL для таких панелей

**Митигация:**

- Значение по умолчанию можно изменить на `0` (отключено) перед миграцией, если большинство панелей используют самоподписанные сертификаты
- Можно добавить логирование ошибок SSL для помощи в диагностике
- Легкий откат через изменение значения в базе данных

### To-dos

- [ ] Добавить миграцию для колонки ssl_verify_enabled в таблицу xui_hosts
- [ ] Обновить функции create_host, update_host, get_host для поддержки ssl_verify_enabled
- [ ] Обновить функции в xui_api.py для использования ssl_verify_enabled вместо verify=False
- [ ] Обновить API endpoints /add-host, /edit-host, /check-host для работы с ssl_verify_enabled
- [ ] Добавить checkbox ssl_verify_enabled в форму создания и редактирования хоста
- [ ] Обновить scheduler.py и другие места использования для передачи ssl_verify_enabled
- [ ] Протестировать создание/редактирование хоста с включенной и отключенной проверкой SSL