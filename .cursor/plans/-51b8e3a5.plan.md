<!-- 51b8e3a5-2a29-4ba0-93d3-262471c454ff be471c33-2004-4175-9dc4-53d2d7a8cb7d -->
# Исправление использования справочника текстов в сообщениях о покупке

## Проблема

Функция `get_purchase_success_text` в `src/shop_bot/config.py` формирует текст сообщений напрямую из кода, игнорируя справочник текстов (`message_templates`). В БД есть шаблоны для всех режимов (`purchase_success_key`, `purchase_success_subscription`, `purchase_success_both`, `purchase_success_cabinet`, `purchase_success_cabinet_subscription`), но они не используются.

## Решение

Модифицировать `get_purchase_success_text` для использования функции `get_message_text`, которая получает шаблоны из БД с fallback на код.

## Изменения

### 1. Модификация `get_purchase_success_text` в `src/shop_bot/config.py`

- Определить `template_key` на основе `provision_mode`:
- `'key'` → `'purchase_success_key'`
- `'subscription'` → `'purchase_success_subscription'`
- `'both'` → `'purchase_success_both'`
- `'cabinet'` → `'purchase_success_cabinet'`
- `'cabinet_subscription'` → `'purchase_success_cabinet_subscription'`

- Сформировать словарь переменных для подстановки:
- `key_number`, `trial_suffix`, `action_text`, `expiry_formatted`
- `connection_string` (если есть)
- `subscription_link` (если есть)
- `cabinet_url` (если есть)
- `cabinet_text` (если есть)
- `fallback_text` (пустая строка по умолчанию)

- Вызвать `get_message_text` с правильными параметрами перед формированием текста из кода.

- Если шаблон из БД найден и активен — использовать его, иначе — текущая логика (fallback).

### 2. Обработка переменных в шаблонах

- Убедиться, что все переменные корректно подставляются в шаблон.
- Обработать случаи, когда некоторые переменные могут отсутствовать (например, `cabinet_text` для режима `cabinet`).

### 3. Сохранение обратной совместимости

- Сохранить текущую логику формирования текста как fallback.
- Убедиться, что если шаблон не найден или неактивен, используется код по умолчанию.

## Файлы для изменения

- `src/shop_bot/config.py` — функция `get_purchase_success_text` (строки 338-501)

## Тестирование

После изменений проверить:

1. Покупку тарифа с режимом "Ключ" — должно использоваться сообщение из справочника (если активно).
2. Покупку тарифа с режимом "Подписка" — должно использоваться сообщение из справочника (если активно).
3. Покупку тарифа с режимом "Ключ + Подписка" — должно использоваться сообщение из справочника (если активно).
4. Покупку тарифа с режимом "Личный кабинет" — должно использоваться сообщение из справочника (если активно).
5. Покупку тарифа с режимом "Личный кабинет + Подписка" — должно использоваться сообщение из справочника (если активно).
6. Если шаблон неактивен или отсутствует — должен использоваться код по умолчанию.