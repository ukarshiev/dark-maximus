<!-- 7e1f6bb7-3d6c-443f-bc31-e16121e6e77f 44946b33-c6aa-4b3c-98fa-86e48f539f55 -->
# План исправления 502 Bad Gateway для tests.dark-maximus.com/allure-docker-service

## Диагностика проблемы

### 1. Проверка состояния контейнеров

- Проверить статус контейнеров `dark-maximus-allure` и `dark-maximus-allure-homepage`
- Проверить логи контейнеров на наличие ошибок
- Проверить доступность портов 50004 (allure-service) и 50005 (allure-homepage)

### 2. Проверка конфигурации nginx

- Проверить текущую конфигурацию nginx для `tests.dark-maximus.com`
- Проверить upstream `allure_backend` (должен указывать на 127.0.0.1:50005)
- Проверить логи nginx на наличие ошибок проксирования

### 3. Анализ архитектуры

- Текущая схема: `tests.dark-maximus.com` → nginx → `allure-homepage:50005` → `allure-service:5050`
- Проверить, правильно ли настроен проксинг в `allure-homepage`
- Проверить переменные окружения `ALLURE_SERVICE_URL` в `allure-homepage`

## Возможные решения

### Вариант 1: Исправление проксирования через allure-homepage (рекомендуется)

Если нужно сохранить авторизацию через `allure-homepage`:

- Убедиться, что `allure-homepage` запущен и доступен на порту 50005
- Проверить, что `allure-service` доступен из `allure-homepage` по внутреннему адресу
- Добавить отдельный `location /allure-docker-service/` в nginx для прямого проксирования на `allure-service` (порт 50004), если нужен прямой доступ

### Вариант 2: Прямое проксирование на allure-service

Если прямой доступ к `allure-service` предпочтительнее:

- Добавить отдельный upstream для `allure-service` (порт 50004)
- Настроить `location /allure-docker-service/` для проксирования напрямую на `allure-service`
- Убедиться, что `URL_PREFIX=/allure-docker-service` правильно настроен в `allure-service`

### Вариант 3: Комбинированный подход

- Корневой путь `/` → `allure-homepage` (с авторизацией)
- Путь `/allure-docker-service/` → прямой доступ к `allure-service` (без авторизации или с отдельной настройкой)

## Шаги реализации

1. **Диагностика на сервере** (через SSH):

- Проверить статус контейнеров: `docker ps | grep allure`
- Проверить логи: `docker logs dark-maximus-allure-homepage` и `docker logs dark-maximus-allure`
- Проверить доступность портов: `curl http://127.0.0.1:50005/health` и `curl http://127.0.0.1:50004/allure-docker-service/`
- Проверить логи nginx: `tail -f /var/log/nginx/error.log`

2. **Исправление конфигурации nginx**:

- Обновить `deploy/nginx/dark-maximus.conf.tpl` для добавления отдельного `location /allure-docker-service/`
- Добавить upstream для `allure-service` (порт 50004) если нужен прямой доступ
- Обновить `nginx/nginx-ssl.conf` для локальной разработки

3. **Проверка docker-compose.yml**:

- Убедиться, что `allure-service` публикует порт 50004
- Убедиться, что `allure-homepage` публикует порт 50005
- Проверить переменные окружения `ALLURE_SERVICE_URL` и `URL_PREFIX`

4. **Тестирование**:

- Проверить доступность `https://tests.dark-maximus.com/allure-docker-service/`
- Проверить работу авторизации через `allure-homepage`
- Проверить логи на наличие ошибок

## Файлы для изменения

- `deploy/nginx/dark-maximus.conf.tpl` - конфигурация nginx для продакшна
- `nginx/nginx-ssl.conf` - конфигурация nginx для локальной разработки (если нужно)
- `docker-compose.yml` - проверка конфигурации сервисов (если нужно)

## Примечания

- Текущая конфигурация предполагает использование `allure-homepage` как прокси с авторизацией
- Если нужен прямой доступ к `allure-service`, потребуется отдельная настройка `location /allure-docker-service/`
- Важно сохранить совместимость с существующей архитектурой и не сломать другие сервисы

### To-dos

- [ ] Проверить статус контейнеров allure-service и allure-homepage на боевом сервере через SSH
- [ ] Проверить текущую конфигурацию nginx для tests.dark-maximus.com и логи nginx
- [ ] Добавить отдельный upstream для allure-service (порт 50004) в конфигурацию nginx
- [ ] Добавить location /allure-docker-service/ для прямого проксирования на allure-service в deploy/nginx/dark-maximus.conf.tpl
- [ ] Обновить nginx/nginx-ssl.conf для локальной разработки (если нужно)
- [ ] Протестировать доступность https://tests.dark-maximus.com/allure-docker-service/ после исправлений