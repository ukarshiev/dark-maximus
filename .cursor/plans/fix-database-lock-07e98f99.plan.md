<!-- 07e98f99-03a8-44e4-acbe-739487ddf21a f627937c-1ae9-4d0d-a6c1-ca49fe0f6197 -->
# Исправление блокировки базы данных при миграции

## Проблема

Функция `migrate_backup_settings()` открывает новое соединение с БД, пока `run_migration()` держит своё соединение открытым внутри транзакции. Это приводит к ошибке "database is locked".

## Решение

Передавать существующее соединение в `migrate_backup_settings()` вместо создания нового, следуя best practice "одно соединение для всех миграций".

## Этапы реализации

### Этап 1: Подготовка — Анализ зависимостей

**Цель:** Убедиться, что `migrate_backup_settings()` вызывается только из одного места

**Действия:**

- Проверить все места вызова `migrate_backup_settings()` в кодовой базе
- Убедиться, что функция вызывается только из `run_migration()`
- Проверить, нет ли других функций с похожей проблемой

**Файлы:** `src/shop_bot/data_manager/database.py`

### Этап 2: Рефакторинг функции `migrate_backup_settings()`

**Цель:** Изменить сигнатуру функции, чтобы принимать соединение как параметр

**Действия:**

1. Изменить сигнатуру функции:
   ```python
   def migrate_backup_settings(conn: sqlite3.Connection):
   ```

2. Удалить создание нового соединения:
   ```python
   # БЫЛО:
   with sqlite3.connect(DB_FILE) as conn:
       cursor = conn.cursor()
       cursor.execute("PRAGMA busy_timeout=30000")
       # ...
   
   # СТАНЕТ:
   cursor = conn.cursor()
   # PRAGMA busy_timeout уже установлен в run_migration()
   # ...
   ```

3. Удалить `conn.commit()` в конце функции (коммит будет в `run_migration()`)

4. Оставить только логику миграции без управления соединением

**Файлы:** `src/shop_bot/data_manager/database.py` (строки 2309-2357)

### Этап 3: Обновление вызова в `run_migration()`

**Цель:** Передать существующее соединение в `migrate_backup_settings()`

**Действия:**

1. Найти вызов `migrate_backup_settings()` в `run_migration()` (строка 1801)
2. Изменить вызов:
   ```python
   # БЫЛО:
   migrate_backup_settings()
   
   # СТАНЕТ:
   migrate_backup_settings(conn)
   ```

3. Убедиться, что вызов происходит **до** финального `conn.commit()` в `run_migration()`

**Файлы:** `src/shop_bot/data_manager/database.py` (строка 1801)

### Этап 4: Проверка и тестирование

**Цель:** Убедиться, что изменения не сломали функциональность

**Действия:**

1. Проверить синтаксис Python в изменённом файле
2. Проверить, что все миграции выполняются в одной транзакции
3. Запустить инициализацию БД на чистой базе
4. Проверить логи на отсутствие ошибок "database is locked"
5. Убедиться, что таблица `backup_settings` создаётся и заполняется

**Команды для проверки:**

```powershell
# Проверка синтаксиса
python -m py_compile src/shop_bot/data_manager/database.py

# Тестовый запуск (если есть тестовая БД)
# Проверить логи на наличие "Backup settings migration completed successfully"
```

### Этап 5: Обновление документации и CHANGELOG

**Цель:** Зафиксировать изменения

**Действия:**

1. Обновить `CHANGELOG.md`:

   - Тип: `[Исправление]`
   - Область: `(База данных)`
   - Описание: "Исправлена блокировка БД при миграции настроек бэкапов — используется единое соединение для всех миграций"

2. Обновить версию в `pyproject.toml` (патч-версия)

3. Проверить, нужно ли обновить документацию в `docs/`

**Файлы:**

- `CHANGELOG.md`
- `pyproject.toml`

## Безопасность изменений

✅ **Обратная совместимость:** Функция вызывается только внутри, API не меняется

✅ **Атомарность:** Все миграции в одной транзакции — откат при ошибке

✅ **Производительность:** Меньше открытий соединений

✅ **Best practice:** Соответствует рекомендациям SQLite

## Риски и митигация

| Риск | Вероятность | Митигация |

|------|-------------|-----------|

| Функция вызывается из других мест | Низкая | Этап 1: проверка всех вызовов |

| Ошибка в транзакции откатит все миграции | Низкая | Это желаемое поведение для целостности |

| Забыть убрать `conn.commit()` внутри функции | Средняя | Этап 4: тестирование |

## Критерии успеха

- ✅ Нет ошибок "database is locked" при запуске
- ✅ Таблица `backup_settings` создаётся и заполняется
- ✅ Все миграции выполняются успешно
- ✅ Логи показывают "Backup settings migration completed successfully"

### To-dos

- [ ] Проверить все вызовы migrate_backup_settings() и убедиться, что функция вызывается только из run_migration()
- [ ] Изменить migrate_backup_settings() чтобы принимать conn как параметр, убрать создание нового соединения и conn.commit()
- [ ] Обновить вызов migrate_backup_settings(conn) в run_migration() передавая существующее соединение
- [ ] Проверить синтаксис, запустить тесты и убедиться, что блокировка БД исправлена
- [ ] Обновить CHANGELOG.md и pyproject.toml с описанием исправления