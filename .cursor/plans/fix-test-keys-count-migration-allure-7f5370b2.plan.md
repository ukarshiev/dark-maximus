<!-- 7f5370b2-483e-4bb4-be56-4608b4236115 6d34fe8d-6ad4-4a3b-b73a-179b8a4dc9bc -->
# Исправление теста test_keys_count_migration

## Проблема

Тест `test_keys_count_migration` проходит при одиночном запуске, но:

1. Отсутствуют полные Allure аннотации (только базовые @allure.epic и @allure.feature)
2. Нет структурирования через allure.step()
3. Нет прикрепления данных через allure.attach()
4. Тест не использует фикстуру temp_db, что может вызывать конфликты

## Решение

### 1. Добавить полные Allure аннотации

- `@allure.title` - краткое описание теста
- `@allure.description` - подробное структурированное описание с разделами:
- Что проверяется
- Тестовые данные
- Ожидаемый результат
- `@allure.severity` - уровень важности (NORMAL)
- `@allure.tag` - теги для фильтрации

### 2. Структурировать тест через allure.step()

Разбить тест на логические шаги:

- "Подготовка тестовых данных" - создание временной БД
- "Инициализация БД" - вызов initialize_db()
- "Проверка миграции" - проверка наличия поля keys_count

### 3. Добавить allure.attach() для важных данных

- Путь к временной БД
- Список колонок таблицы users
- Результат проверки наличия keys_count

### 4. Улучшить изоляцию теста

- Убедиться, что восстановление DB_FILE происходит корректно
- Добавить обработку ошибок в finally блоке

### 5. Запустить тест и проверить отчет в Allure

- Запустить тест с генерацией Allure результатов
- Проверить отчет в Allure Service
- Убедиться, что все аннотации отображаются корректно

## Файлы для изменения

- `tests/unit/test_database/test_key_numbering.py` - функция `test_keys_count_migration` (строки 36-77)

## Критерии успеха

1. Тест проходит успешно
2. В Allure отчете отображаются все аннотации
3. Тест структурирован через allure.step()
4. Важные данные прикреплены через allure.attach()
5. Отчет читаем и информативен

### To-dos

- [ ] Добавить полные Allure аннотации (@allure.title, @allure.description, @allure.severity, @allure.tag) к тесту test_keys_count_migration
- [ ] Структурировать тест через allure.step() для улучшения читаемости отчета
- [ ] Добавить allure.attach() для прикрепления важных данных (путь к БД, список колонок, результат проверки)
- [ ] Улучшить изоляцию теста - убедиться в корректном восстановлении DB_FILE
- [ ] Запустить тест с генерацией Allure результатов и проверить отчет в Allure Service