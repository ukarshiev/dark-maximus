<!-- 289ab161-84ce-4fd2-9608-b3a5eb21fa48 340c947b-3f40-47b5-a74d-a3d15a5a7d15 -->
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ host_code –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ö–æ—Å—Ç–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–µ–π –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞ "Host 'üá´üáÆ –§–∏–Ω–ª—è–Ω–¥–∏—è 1 Test' not found in the database" –ø–æ—Ç–æ–º—É —á—Ç–æ:

- –í metadata —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `host_name` —Å —ç–º–æ–¥–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "üá´üáÆ –§–∏–Ω–ª—è–Ω–¥–∏—è 1 Test")
- –í —Ç–∞–±–ª–∏—Ü–µ `xui_hosts` —Ö—Ä–∞–Ω–∏—Ç—Å—è `host_name` –±–µ–∑ —ç–º–æ–¥–∑–∏ –∏–ª–∏ –≤ –¥—Ä—É–≥–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
- –§—É–Ω–∫—Ü–∏—è `get_host()` –Ω–µ –≤—Å–µ–≥–¥–∞ –Ω–∞—Ö–æ–¥–∏—Ç —Ö–æ—Å—Ç –ø–æ –∏–º–µ–Ω–∏ —Å —ç–º–æ–¥–∑–∏

## –†–µ—à–µ–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π `host_code` (–±–µ–∑ —ç–º–æ–¥–∑–∏) –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ö–æ—Å—Ç–∞ –≤–º–µ—Å—Ç–æ `host_name`.

## –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ xui_hosts:

- `host_name` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞ (–º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —ç–º–æ–¥–∑–∏)
- `host_code` - —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–¥ (–±–µ–∑ —ç–º–æ–¥–∑–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä "estonia1test")

### –¢–∞–±–ª–∏—Ü–∞ plans:

- `host_name` - —Å–≤—è–∑—å —Å xui_hosts —á–µ—Ä–µ–∑ FOREIGN KEY
- `host_code` –ù–ï —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–ª–∞–Ω–∞—Ö

### Metadata –ø–ª–∞—Ç–µ–∂–∞:

- `host_name` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å —ç–º–æ–¥–∑–∏)
- `host_code` - —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–¥ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞, —Å—Ç—Ä–æ–∫–∞ 4829)

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `create_or_update_key_on_host` –≤ `src/shop_bot/modules/xui_api.py`

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
async def create_or_update_key_on_host(host_name: str, ...):
    host_data = get_host(host_name)  # –ü–æ–∏—Å–∫ –ø–æ host_name
```

**–ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

- –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `host_code: str | None = None`
- –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω `host_code`, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `get_host_by_code(host_code)`
- –ï—Å–ª–∏ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É —Å `get_host(host_name)`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–µ—Å–ª–∏ `host_code` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–º—É –∫–æ–¥—É –Ω–∞–¥ –∏–º–µ–Ω–µ–º

### 2. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π –≤ `src/shop_bot/bot/handlers.py`

**–í `process_successful_yookassa_payment` (—Å—Ç—Ä–æ–∫–∞ 6436):**

- –ü–æ–ª—É—á–∏—Ç—å `host_code` –∏–∑ metadata (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –ï—Å–ª–∏ –Ω–µ—Ç, –ø–æ–ª—É—á–∏—Ç—å `host_name` –∏–∑ –ø–ª–∞–Ω–∞, –∑–∞—Ç–µ–º `host_code` –∏–∑ —Ö–æ—Å—Ç–∞
- –ü–µ—Ä–µ–¥–∞—Ç—å `host_code` –≤ `create_or_update_key_on_host`

**–í `process_successful_payment` (—Å—Ç—Ä–æ–∫–∞ 6728):**

- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–æ–ª—É—á–∏—Ç—å `host_code` –∏–∑ metadata –∏–ª–∏ –ø–ª–∞–Ω–∞
- –ü–µ—Ä–µ–¥–∞—Ç—å `host_code` –≤ `create_or_update_key_on_host`

**–í –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö –≤—ã–∑–æ–≤–∞ `create_or_update_key_on_host`:**

- –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ metadata –∏–ª–∏ –ø–ª–∞–Ω—É, –ø–æ–ª—É—á–∞—Ç—å `host_code` –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å
- –ï—Å–ª–∏ –Ω–µ—Ç, –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `host_name` (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 1: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `create_or_update_key_on_host`

```python
async def create_or_update_key_on_host(
    host_name: str, 
    email: str, 
    days_to_add: float, 
    comment: str | None = None, 
    traffic_gb: float | None = None, 
    sub_id: str | None = None, 
    telegram_chat_id: int | None = None,
    host_code: str | None = None  # –ù–û–í–´–ô –ü–ê–†–ê–ú–ï–¢–†
) -> Dict | None:
    # –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ host_code (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω)
    if host_code:
        host_data = get_host_by_code(host_code)
        if host_data:
            logger.info(f"Host found by code '{host_code}'")
        else:
            logger.warning(f"Host not found by code '{host_code}', trying by name '{host_name}'")
            host_data = get_host(host_name)
    else:
        # –ï—Å–ª–∏ host_code –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É
        host_data = get_host(host_name)
    
    if not host_data:
        logger.error(f"Workflow failed: Host not found (name: '{host_name}', code: '{host_code}').")
        return None
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```

### –®–∞–≥ 2: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π

**–í `process_successful_yookassa_payment`:**

```python
host_name = metadata.get('host_name')
host_code = metadata.get('host_code')  # –ü–æ–ª—É—á–∞–µ–º –∏–∑ metadata
plan_id = _to_int(metadata.get('plan_id'))

# –ï—Å–ª–∏ host_code –Ω–µ—Ç –≤ metadata, –ø–æ–ª—É—á–∞–µ–º –∏–∑ —Ö–æ—Å—Ç–∞ –ø–æ host_name –∏–∑ –ø–ª–∞–Ω–∞
if not host_code and plan_id:
    try:
        from shop_bot.data_manager.database import get_plan_by_id, get_host
        plan = get_plan_by_id(plan_id)
        if plan and plan.get('host_name'):
            host_from_plan = get_host(plan['host_name'])
            if host_from_plan:
                host_code = host_from_plan.get('host_code')
                host_name = plan['host_name']  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –∏–∑ –ø–ª–∞–Ω–∞
    except Exception as e:
        logger.warning(f"Failed to get host_code from plan {plan_id}: {e}")
```

**–ü—Ä–∏ –≤—ã–∑–æ–≤–µ `create_or_update_key_on_host`:**

```python
result = await xui_api.create_or_update_key_on_host(
    host_name=host_name,
    email=email,
    days_to_add=days_to_add,
    comment=f"{user_id}",
    traffic_gb=traffic_gb if traffic_gb > 0 else None,
    sub_id=None,
    telegram_chat_id=user_id,
    host_code=host_code  # –ü–ï–†–ï–î–ê–ï–ú host_code
)
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: `host_code` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —ç–º–æ–¥–∑–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
2. **–¢–æ—á–Ω–æ—Å—Ç—å**: –ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –±–µ–∑ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
3. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ï—Å–ª–∏ `host_code` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
4. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ú–µ–Ω—å—à–µ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏):

1. **`src/shop_bot/modules/xui_api.py`** - –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `create_or_update_key_on_host`:

   - –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `host_code: str | None = None` –ø–æ—Å–ª–µ `host_name`
   - –ï—Å–ª–∏ `host_code` –ø–µ—Ä–µ–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `get_host_by_code(host_code)` –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ö–æ—Å—Ç–∞
   - –ï—Å–ª–∏ `host_code` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –∏–ª–∏ —Ö–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –∫–æ–¥—É, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É `get_host(host_name)`
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

2. **`src/shop_bot/bot/handlers.py`** - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π (4 –º–µ—Å—Ç–∞):

**a) –°—Ç—Ä–æ–∫–∞ ~6436** (`process_successful_yookassa_payment`):

   - –ü–æ–ª—É—á–∏—Ç—å `host_code` –∏–∑ `metadata.get('host_code')`
   - –ï—Å–ª–∏ –Ω–µ—Ç, –ø–æ–ª—É—á–∏—Ç—å `host_name` –∏–∑ –ø–ª–∞–Ω–∞ (`get_plan_by_id`), –∑–∞—Ç–µ–º `host_code` –∏–∑ —Ö–æ—Å—Ç–∞
   - –ü–µ—Ä–µ–¥–∞—Ç—å `host_code` –≤ `create_or_update_key_on_host` (—Å—Ç—Ä–æ–∫–∞ 6534 –¥–ª—è "new", 6616 –¥–ª—è "extend")

**b) –°—Ç—Ä–æ–∫–∞ ~6728** (`process_successful_payment`):

   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–æ–ª—É—á–∏—Ç—å `host_code` –∏–∑ metadata –∏–ª–∏ –ø–ª–∞–Ω–∞
   - –ü–µ—Ä–µ–¥–∞—Ç—å `host_code` –≤ `create_or_update_key_on_host` (—Å—Ç—Ä–æ–∫–∞ 6812)

**c) –°—Ç—Ä–æ–∫–∞ 6534** (YooKassa webhook - –Ω–æ–≤—ã–π –∫–ª—é—á):

   - `host_code` —É–∂–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 6491 –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è email
   - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ `create_or_update_key_on_host`

**d) –°—Ç—Ä–æ–∫–∞ 6616** (YooKassa webhook - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ):

   - –ü–æ–ª—É—á–∏—Ç—å `host_code` –∏–∑ metadata –∏–ª–∏ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ `get_key_by_id` -> `host_name` -> `get_host` -> `host_code`
   - –ü–µ—Ä–µ–¥–∞—Ç—å –≤ `create_or_update_key_on_host`

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–¥–ª—è –ø–æ–ª–Ω–æ–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏):

3. **`src/shop_bot/bot/handlers.py`** - –¥—Ä—É–≥–∏–µ –º–µ—Å—Ç–∞ –≤—ã–∑–æ–≤–∞ (4 –º–µ—Å—Ç–∞):

**a) –°—Ç—Ä–æ–∫–∞ 3121** (–¢—Ä–∏–∞–ª callback):

   - `host_code` —É–∂–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 3116 –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è email
   - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ `create_or_update_key_on_host`

**b) –°—Ç—Ä–æ–∫–∞ 3221** (–¢—Ä–∏–∞–ª message):

   - `host_code` —É–∂–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 3216 –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è email
   - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ `create_or_update_key_on_host`

**c) –°—Ç—Ä–æ–∫–∞ 4656** (–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω CryptoBot):

   - –î–ª—è `action == "new"`: `host_code` —É–∂–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 4624
   - –î–ª—è `action == "extend"`: –ø–æ–ª—É—á–∏—Ç—å `host_code` –∏–∑ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ `get_key_by_id` -> `host_name` -> `get_host` -> `host_code`
   - –ü–µ—Ä–µ–¥–∞—Ç—å –≤ `create_or_update_key_on_host`

**d) –°—Ç—Ä–æ–∫–∞ 5110** (–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω TON Connect):

   - –î–ª—è `action == "new"`: `host_code` —É–∂–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 5077
   - –î–ª—è `action == "extend"`: –ø–æ–ª—É—á–∏—Ç—å `host_code` –∏–∑ –∫–ª—é—á–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ CryptoBot
   - –ü–µ—Ä–µ–¥–∞—Ç—å –≤ `create_or_update_key_on_host`

**–ò—Ç–æ–≥–æ: 1 —Ñ–∞–π–ª —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ + 7 –º–µ—Å—Ç –≤—ã–∑–æ–≤–∞ –≤ handlers.py**

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í –º–µ—Å—Ç–∞—Ö, –≥–¥–µ `host_code` —É–∂–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è email, –µ–≥–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ `create_or_update_key_on_host`, —á—Ç–æ –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python:**

   - –ó–∞–ø—É—Å—Ç–∏—Ç—å `python -m py_compile` –¥–ª—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–æ–º:**

   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä –¥–ª—è `src/shop_bot/modules/xui_api.py` –∏ `src/shop_bot/bot/handlers.py`
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤:**

   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `get_host_by_code` –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ `xui_api.py`

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏:**

   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (–µ—Å–ª–∏ `host_code` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ 7 –º–µ—Å—Ç –≤—ã–∑–æ–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `host_code` –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (metadata, –ø–ª–∞–Ω, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª—é—á)

### –®–∞–≥ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–ú–æ–¥—É–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç –¥–ª—è `create_or_update_key_on_host` —Å –ø–µ—Ä–µ–¥–∞—á–µ–π `host_code`
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç –¥–ª—è `create_or_update_key_on_host` –±–µ–∑ `host_code` (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç –¥–ª—è —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ `host_code` –ø–µ—Ä–µ–¥–∞–Ω, –Ω–æ —Ö–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (fallback –Ω–∞ `host_name`)

2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ YooKassa webhook —Å `host_code` –≤ metadata
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ YooKassa webhook –±–µ–∑ `host_code` –≤ metadata (–ø–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ –ø–ª–∞–Ω–∞)
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ YooKassa webhook
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–∞–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø–ª–∞–Ω—ã (CryptoBot –∏ TON Connect)

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞:**

   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —Å —Ç–∞—Ä–∏—Ñ–æ–º, —É –∫–æ—Ç–æ—Ä–æ–≥–æ `host_name` —Å–æ–¥–µ—Ä–∂–∏—Ç —ç–º–æ–¥–∑–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ö–æ—Å—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ `host_code`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–ª—é—á —Å–æ–∑–¥–∞–µ—Ç—Å—è/–ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø–æ–∏—Å–∫–µ —Ö–æ—Å—Ç–∞ –ø–æ –∫–æ–¥—É

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:**

   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è "Host found by code '...'" –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–∏—Å–∫–µ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ fallback –Ω–∞ `host_name` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `host_code`

### –®–∞–≥ 3: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ø–ª–∞–Ω—É
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ —Å–ª–æ–º–∞–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ
4. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ—à–∏–±–∫–∞ "Host '...' not found in the database" –±–æ–ª—å—à–µ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –¥–ª—è —Ö–æ—Å—Ç–æ–≤ —Å —ç–º–æ–¥–∑–∏ –≤ –∏–º–µ–Ω–∏