<!-- 50b6bc42-cfcc-4cbb-b614-25f6a128eb01 81065de0-4794-46dd-8d0e-64759990c0d1 -->
# Исправление битых ссылок личного кабинета

## Найденные проблемы (факты из кода)

### 1. INNER JOIN в validate_permanent_token (database.py:6684)

**Факт**: Используется `INNER JOIN` с `vpn_keys`, поэтому если ключ удален из `vpn_keys`, токен не валидируется, хотя он существует в `user_tokens`.

```python
FROM user_tokens ut
JOIN vpn_keys k ON ut.key_id = k.key_id
WHERE ut.token = ?
```

**Последствие**: Пользователь получает ошибку "Токен недействителен" даже если токен есть в БД.

### 2. Токены не создаются при создании ключа (database.py:6109-6166)

**Факт**: В функции `add_new_key()` токен НЕ создается автоматически. Токен создается только при вызове:

- `get_key_info_text()` (config.py:222-223)
- `get_purchase_success_text()` (config.py:387-388)

**Последствие**: Если ключ создан, но функция формирования сообщения не вызвана или вызвана без `user_id`/`key_id`, токен не будет создан.

### 3. Токены не удаляются при удалении ключей

**Факт 3.1**: `delete_user_keys()` (database.py:7878) - удаляет только ключи, токены остаются:

```python
cursor.execute("DELETE FROM vpn_keys WHERE user_id = ?", (user_id,))
```

**Факт 3.2**: `delete_key_by_email()` (database.py:6243) - удаляет только ключ, токен остается:

```python
cursor.execute("DELETE FROM vpn_keys WHERE key_email = ?", (email,))
```

**Факт 3.3**: Удаление триальных ключей (database.py:6031) - удаляет только ключи, токены остаются:

```python
DELETE FROM vpn_keys WHERE user_id = ? AND is_trial = 1
```

**Последствие**: В БД остаются "висячие" токены, которые ссылаются на несуществующие ключи.

### 4. Использование слова "токен" в сообщениях (apps/user-cabinet/app.py)

**Факт**: В сообщениях об ошибках используется слово "токен":

- Строка 197: "Токен не предоставлен"
- Строка 211: "Токен недействителен"
- Строка 227: "Ошибка при проверке токена"
- Строка 288: "Токен недействителен"
- Строка 299: "Токен не предоставлен"

**Последствие**: Пользователь видит технический термин "токен" вместо понятного "ссылка".

### 5. Недостаточное логирование в validate_permanent_token

**Факт**: При невалидности токена логируется только общее сообщение (строка 6691), без указания конкретной причины:

- Токен не найден в `user_tokens`
- Ключ не найден (токен есть, но ключ удален)
- Другие ошибки БД

**Последствие**: Сложно диагностировать проблему по логам.

## Решение

### 1. Изменить validate_permanent_token (database.py)

- Заменить `INNER JOIN` на `LEFT JOIN` с `vpn_keys`
- Добавить проверку наличия ключа после JOIN
- Добавить детальное логирование:
- Токен не найден в `user_tokens`
- Ключ не найден (токен есть, но ключ удален)
- Другие ошибки БД
- Возвращать данные даже если ключ удален (для отображения сообщения об ошибке)

### 2. Заменить "токен" на "ссылка" (apps/user-cabinet/app.py)

- Заменить все упоминания "токен" на "ссылка" в сообщениях об ошибках:
- "Токен не предоставлен" → "Ссылка не предоставлена"
- "Токен недействителен" → "Ссылка недействительна"
- "Ошибка при проверке токена" → "Ошибка при проверке ссылки"
- Обновить логирование (можно оставить "token" в логах для отладки)

### 3. Добавить создание токена при создании ключа (database.py)

- В функции `add_new_key` после успешного создания ключа вызывать `get_or_create_permanent_token(user_id, new_key_id)`
- Обработать ошибки создания токена (логировать, но не прерывать создание ключа)

### 4. Добавить удаление токенов при удалении ключей (database.py)

- В функции `delete_user_keys`: добавить удаление токенов перед удалением ключей
- При удалении триальных ключей (строка 6031): добавить удаление токенов для удаляемых ключей
- В функции `delete_key_by_email`: добавить удаление токена по key_id перед удалением ключа

### 5. Улучшить обработку ошибок в user-cabinet (apps/user-cabinet/app.py)

- В функции `index()`: если токен валиден, но ключ не найден, показывать соответствующее сообщение
- Добавить проверку наличия ключа после валидации токена
- Улучшить сообщения об ошибках с указанием конкретной причины

## Файлы для изменения

1. `src/shop_bot/data_manager/database.py`:

- `validate_permanent_token()` - LEFT JOIN, детальное логирование
- `add_new_key()` - создание токена после создания ключа
- `delete_user_keys()` - удаление токенов
- Удаление триальных ключей (строка 6031) - удаление токенов
- `delete_key_by_email()` - удаление токена

2. `apps/user-cabinet/app.py`:

- Заменить "токен" на "ссылка" в сообщениях
- Улучшить обработку ошибок при отсутствии ключа

## Тестирование

- Проверить валидацию токена при удаленном ключе
- Проверить создание токена при создании нового ключа
- Проверить удаление токенов при удалении ключей
- Проверить сообщения об ошибках (должны использовать "ссылка")