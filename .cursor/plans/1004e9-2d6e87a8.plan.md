<!-- 2d6e87a8-8eea-4988-ac3b-28234417c3d1 6cdcfa33-dd92-4433-80dd-d25016836562 -->
# План исправления ошибок тестов

## Проблемы и решения

### 1. AttributeError: handlers.get_transaction_by_payment_id

**Проблема:** Тесты пытаются использовать `shop_bot.bot.handlers.get_transaction_by_payment_id`, но функция находится в `shop_bot.data_manager.database`.

**Исправление:**

- В `tests/unit/test_bot/test_payment_handlers.py` исправить патч с `shop_bot.bot.handlers.get_transaction_by_payment_id` на `shop_bot.data_manager.database.get_transaction_by_payment_id`

### 2. AttributeError: scheduler.get_plan_by_id

**Проблема:** Тесты пытаются использовать `shop_bot.data_manager.scheduler.get_plan_by_id`, но функция находится в `shop_bot.data_manager.database`.

**Исправление:**

- В `tests/integration/test_auto_renewal/test_auto_renewal_process.py` исправить патч с `shop_bot.data_manager.scheduler.get_plan_by_id` на `shop_bot.data_manager.database.get_plan_by_id`

### 3. AttributeError: xui_api.delete_client

**Проблема:** Тесты пытаются использовать `shop_bot.modules.xui_api.delete_client`, но функции называются `delete_client_by_uuid` или `delete_client_on_host`.

**Исправление:**

- В `tests/integration/test_trial/test_trial_flow.py` исправить патч и использование на правильную функцию (`delete_client_by_uuid` или `delete_client_on_host`)

### 4. NameError: get_user_balance

**Проблема:** В тестах `get_user_balance` не определена или не импортирована.

**Исправление:**

- В `tests/unit/test_database/test_user_operations.py` убедиться, что функция импортирована из `shop_bot.data_manager.database`
- Проверить, что функция корректно работает с временной БД

### 5. TypeError: log_transaction() missing arguments

**Проблема:** Функция `log_transaction` принимает 10 аргументов: `username, transaction_id, payment_id, user_id, status, amount_rub, amount_currency, currency_name, payment_method, metadata`, но тесты могут вызывать её с неправильными аргументами.

**Исправление:**

- В `tests/unit/test_database/test_transaction_operations.py` и других файлах проверить все вызовы `log_transaction` и убедиться, что все аргументы переданы в правильном порядке

### 6. TypeError: validate_promo_code() takes 2 positional arguments but 4 were given

**Проблема:** Функция `validate_promo_code` принимает только 2 аргумента `(code, bot)`, но тесты передают 4 `(code, user_id, bot, plan_id)`.

**Исправление:**

- В `tests/integration/test_vpn_purchase/test_promo_code_application.py` исправить все вызовы `validate_promo_code`, оставив только `code` и `bot`
- Если нужна проверка пользователя или плана, использовать дополнительные функции (например, `can_user_use_promo_code`)

### 7. ModuleNotFoundError: No module named 'app'

**Проблема:** Тесты пытаются импортировать `from app import app`, но такого модуля не существует.

**Исправление:**

- В `tests/integration/test_user_cabinet/test_cabinet_flow.py` и `tests/unit/test_user_cabinet/test_cabinet.py` исправить импорты на правильный путь к Flask приложению (например, `from shop_bot.webhook_server.app import create_webhook_app`)

### 8. TypeError: object MagicMock can't be used in 'await' expression

**Проблема:** В тестах используется `MagicMock` для асинхронных функций вместо `AsyncMock`.

**Исправление:**

- Найти все места, где `MagicMock` используется для асинхронных функций, и заменить на `AsyncMock`
- Особое внимание на тесты с `await` и асинхронными функциями

### 9. FileNotFoundError: /app/apps/user-cabinet/app.py

**Проблема:** Тесты пытаются найти файл `/app/apps/user-cabinet/app.py`, которого не существует.

**Исправление:**

- Проверить тесты, которые используют этот путь, и исправить на правильный путь к Flask приложению

## Файлы для изменения

1. `tests/unit/test_bot/test_payment_handlers.py` - исправить патч get_transaction_by_payment_id
2. `tests/integration/test_auto_renewal/test_auto_renewal_process.py` - исправить патч get_plan_by_id
3. `tests/integration/test_trial/test_trial_flow.py` - исправить патч delete_client
4. `tests/unit/test_database/test_user_operations.py` - проверить импорт get_user_balance
5. `tests/unit/test_database/test_transaction_operations.py` - проверить вызовы log_transaction
6. `tests/integration/test_vpn_purchase/test_promo_code_application.py` - исправить вызовы validate_promo_code
7. `tests/integration/test_user_cabinet/test_cabinet_flow.py` - исправить импорт Flask приложения
8. `tests/unit/test_user_cabinet/test_cabinet.py` - исправить импорт Flask приложения
9. Все файлы тестов - заменить MagicMock на AsyncMock для асинхронных функций

### To-dos

- [ ] Исправить патч get_transaction_by_payment_id в tests/unit/test_bot/test_payment_handlers.py - использовать shop_bot.data_manager.database вместо shop_bot.bot.handlers
- [ ] Исправить патч get_plan_by_id в tests/integration/test_auto_renewal/test_auto_renewal_process.py - использовать shop_bot.data_manager.database вместо shop_bot.data_manager.scheduler
- [ ] Исправить патч delete_client в tests/integration/test_trial/test_trial_flow.py - использовать правильное имя функции (delete_client_by_uuid или delete_client_on_host)
- [ ] Проверить и исправить импорт и использование get_user_balance в tests/unit/test_database/test_user_operations.py
- [ ] Проверить все вызовы log_transaction в тестах и убедиться, что все 10 аргументов переданы в правильном порядке
- [ ] Исправить все вызовы validate_promo_code в tests/integration/test_vpn_purchase/test_promo_code_application.py - оставить только code и bot
- [ ] Исправить импорты Flask приложения в tests/integration/test_user_cabinet/test_cabinet_flow.py и tests/unit/test_user_cabinet/test_cabinet.py - использовать правильный путь
- [ ] Найти и заменить все MagicMock на AsyncMock для асинхронных функций во всех тестовых файлах