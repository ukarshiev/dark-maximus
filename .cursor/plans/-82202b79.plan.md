<!-- 82202b79-7be4-4364-bd7d-43980324ec90 06a23617-40a7-4315-897a-e406e07a2091 -->
# Исправление тестов авторизации веб-панели

## Проблемы

1. **test_logout** и **test_session_persistence** пропускаются (SKIPPED) из-за того, что сессия не сохраняется между запросами в тестовом окружении
2. Отсутствуют подробные Allure аннотации согласно правилам тестирования
3. Не используются правильные техники Flask для работы с сессиями в тестах

## Анализ

### test_login_rate_limit

- Тест проходит, но нужно улучшить описание и добавить Allure аннотации
- Rate limiting отключается в TESTING режиме, поэтому в тесте отключается TESTING (`app.config['TESTING'] = False`)

### test_logout

- Пропускается из-за проверки `if response.status_code == 200:` после логина
- Сессия не сохраняется между запросами из-за файлового хранилища сессий в тестовом окружении
- Нужно использовать `with client:` для доступа к сессии после запроса или `client.session_transaction()` для установки сессии

### test_session_persistence

- Пропускается по той же причине - сессия не сохраняется между запросами
- Нужно использовать правильные техники Flask для работы с сессиями

## Решение

### 1. Исправление test_login_rate_limit

- Добавить подробные Allure аннотации (@allure.description, @allure.step, allure.attach)
- Улучшить структуру теста с использованием allure.step()
- Добавить прикрепление данных через allure.attach()

### 2. Исправление test_logout

- Использовать `with client:` для доступа к сессии после логина
- Использовать `client.session_transaction()` для проверки сессии
- Добавить подробные Allure аннотации
- Убрать условную логику с pytest.skip()

### 3. Исправление test_session_persistence

- Использовать `with client:` для доступа к сессии после логина
- Использовать `client.session_transaction()` для проверки сессии
- Добавить подробные Allure аннотации
- Убрать условную логику с pytest.skip()

## Файлы для изменения

- `tests/unit/test_webhook_server/test_auth.py` - исправление трех тестов

## Технические детали

### Работа с сессиями в Flask тестах

Согласно документации Flask:

- Для доступа к сессии после запроса: использовать `with client:`
- Для установки сессии перед запросом: использовать `client.session_transaction()`

### Allure аннотации

Согласно правилам тестирования:

- @allure.epic("Веб-панель")
- @allure.feature("Авторизация")
- @allure.title("...")
- @allure.description("""...""") - структурированное описание
- @allure.severity(allure.severity_level.NORMAL)
- @allure.tag("...")
- @allure.label("package", "src.shop_bot.webhook_server")
- allure.step() для структурирования шагов
- allure.attach() для прикрепления данных

## Шаги реализации

1. Исправить test_login_rate_limit:

- Добавить подробные Allure аннотации
- Использовать allure.step() для структурирования
- Добавить allure.attach() для прикрепления данных

2. Исправить test_logout:

- Использовать `with client:` для доступа к сессии
- Использовать `client.session_transaction()` для проверки
- Добавить подробные Allure аннотации
- Убрать условную логику

3. Исправить test_session_persistence:

- Использовать `with client:` для доступа к сессии
- Использовать `client.session_transaction()` для проверки
- Добавить подробные Allure аннотации
- Убрать условную логику

4. Запустить тесты и проверить результаты в Allure
5. При необходимости исправить ошибки на основе отчетов Allure

### To-dos

- [ ] Исправить test_login_rate_limit: добавить подробные Allure аннотации, использовать allure.step() и allure.attach()
- [ ] Исправить test_logout: использовать with client: и session_transaction(), добавить Allure аннотации, убрать pytest.skip()
- [ ] Исправить test_session_persistence: использовать with client: и session_transaction(), добавить Allure аннотации, убрать pytest.skip()
- [ ] Запустить все три теста и проверить результаты
- [ ] Проверить отчеты в Allure и при необходимости исправить ошибки