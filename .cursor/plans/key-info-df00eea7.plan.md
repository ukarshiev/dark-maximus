<!-- df00eea7-6115-435f-9795-8e601091b773 e78791bb-c5cb-460f-b546-b5d876d5e176 -->
# –ê–∫—Ç–∏–≤–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª—é—á–µ"

## –¶–µ–ª—å

–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —à–∞–±–ª–æ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ `key_info` –∏ —Å–¥–µ–ª–∞—Ç—å –∏—Ö –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –≤–æ –≤–∫–ª–∞–¥–∫–µ "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏" ‚Üí "–¢–µ–∫—Å—Ç—ã –±–æ—Ç–∞".

## –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

- –®–∞–±–ª–æ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ `key_info` —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ `database.py` (—Å—Ç—Ä–æ–∫–∏ 2522-2541)
- –°–æ–∑–¥–∞—é—Ç—Å—è —Å `is_active=0` (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏)
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–µ–≥–∏ `<br>` –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ `\n`
- –ù–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `auto_renewal_status` –≤ —Å–ø–∏—Å–∫–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- –§—É–Ω–∫—Ü–∏—è `get_key_info_text()` —É–∂–µ –≥–æ—Ç–æ–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω—ã –∏–∑ –ë–î

## –ó–∞–¥–∞—á–∏

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ –≤ database.py

**–§–∞–π–ª:** `src/shop_bot/data_manager/database.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `<br>` –Ω–∞ `\n` –≤ —Ç–µ–∫—Å—Ç–∞—Ö –≤—Å–µ—Ö 5 —à–∞–±–ª–æ–Ω–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ `key_info`
- –î–æ–±–∞–≤–∏—Ç—å `auto_renewal_status` –≤ —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö —à–∞–±–ª–æ–Ω–æ–≤
- –ò–∑–º–µ–Ω–∏—Ç—å `is_active=0` –Ω–∞ `is_active=1` –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —à–∞–±–ª–æ–Ω–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –ë–î

**–®–∞–±–ª–æ–Ω—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**

1. `key_info_key` (—Å—Ç—Ä–æ–∫–∞ 2523-2525)
2. `key_info_subscription` (—Å—Ç—Ä–æ–∫–∞ 2527-2529)
3. `key_info_both` (—Å—Ç—Ä–æ–∫–∞ 2531-2533)
4. `key_info_cabinet` (—Å—Ç—Ä–æ–∫–∞ 2535-2537)
5. `key_info_cabinet_subscription` (—Å—Ç—Ä–æ–∫–∞ 2539-2541)

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤:**

- `key_number` - –Ω–æ–º–µ—Ä –∫–ª—é—á–∞
- `trial_suffix` - —Å—É—Ñ—Ñ–∏–∫—Å "(–ü—Ä–æ–±–Ω—ã–π)" –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
- `created_formatted` - –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `expiry_formatted` - –¥–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `status_icon` - –∏–∫–æ–Ω–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (‚úÖ/‚ùå)
- `status_text` - —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
- `connection_string` - VLESS –∫–ª—é—á (–¥–ª—è —Ä–µ–∂–∏–º–æ–≤ key, both)
- `subscription_link` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É (–¥–ª—è —Ä–µ–∂–∏–º–æ–≤ subscription, both, cabinet_subscription)
- `cabinet_url` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç (–¥–ª—è —Ä–µ–∂–∏–º–æ–≤ cabinet, cabinet_subscription)
- `auto_renewal_status` - —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è ("–í–∫–ª—é—á–µ–Ω–æ üü¢" / "–û—Ç–∫–ª—é—á–µ–Ω–æ üî¥")
- `host_flag` - —Ñ–ª–∞–≥ —Å—Ç—Ä–∞–Ω—ã (–ø–µ—Ä–≤—ã–µ 2 —Å–∏–º–≤–æ–ª–∞ —Ö–æ—Å—Ç–∞) –∏–ª–∏ üåê
- `tariff_name` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –∏–ª–∏ "TRIAL"
- `price_formatted` - —Ü–µ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "X‚ÇΩ" –∏–ª–∏ "0‚ÇΩ"
- `tariff_info` - –≥–æ—Ç–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ "{status_icon} {host_flag} | {tariff_name} | {price_formatted}"

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ template_variables –≤ config.py

**–§–∞–π–ª:** `src/shop_bot/config.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –î–æ–±–∞–≤–∏—Ç—å `auto_renewal_status` –≤ —Å–ª–æ–≤–∞—Ä—å `template_variables` (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 424, –ø–µ—Ä–µ–¥ `**tariff_vars`)

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** —Ñ—É–Ω–∫—Ü–∏—è `get_key_info_text()`, —Å—Ç—Ä–æ–∫–∏ 415-426

### 3. –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —à–∞–±–ª–æ–Ω–æ–≤ –≤ –ë–î

**–í—ã–±—Ä–∞–Ω –≤–∞—Ä–∏–∞–Ω—Ç 2:** SQL-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

**–§–∞–π–ª:** `src/shop_bot/data_manager/database.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ —Ñ—É–Ω–∫—Ü–∏—é `run_migration()` –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —à–∞–±–ª–æ–Ω–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ `key_info`
- –ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã `message_templates`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ –ø–µ—Ä–µ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** —Ñ—É–Ω–∫—Ü–∏—è `run_migration()`, –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–π –¥—Ä—É–≥–∏—Ö —Ç–∞–±–ª–∏—Ü (–ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 2070, –≥–¥–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã `notifications`)

**–ö–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–∏:**

```python
# –ê–∫—Ç–∏–≤–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ key_info
logging.info("The migration of the table 'message_templates' (key_info activation)...")
try:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='message_templates'")
    if cursor.fetchone():
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ key_info
        cursor.execute("SELECT COUNT(*) FROM message_templates WHERE category = 'key_info'")
        key_info_count = cursor.fetchone()[0]
        if key_info_count > 0:
            cursor.execute("UPDATE message_templates SET is_active = 1 WHERE category = 'key_info'")
            updated_count = cursor.rowcount
            logging.info(f" -> Activated {updated_count} key_info templates")
        else:
            logging.info(" -> No key_info templates found to activate")
    else:
        logging.info(" -> Table 'message_templates' does not exist yet, skipping activation")
except sqlite3.Error as e:
    logging.warning(f" -> Failed to activate key_info templates: {e}")
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:

1. –®–∞–±–ª–æ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ `key_info` –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ ‚Üí –¢–µ–∫—Å—Ç—ã –±–æ—Ç–∞
2. –í—Å–µ 5 —à–∞–±–ª–æ–Ω–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ (`is_active = 1`)
3. –í —à–∞–±–ª–æ–Ω–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –≤–∫–ª—é—á–∞—è `auto_renewal_status`
4. –®–∞–±–ª–æ–Ω—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `\n` –≤–º–µ—Å—Ç–æ `<br>` –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
5. –§—É–Ω–∫—Ü–∏—è `get_key_info_text()` –¥–æ–ª–∂–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω—ã –∏–∑ –ë–î –≤–º–µ—Å—Ç–æ fallback

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. `src/shop_bot/data_manager/database.py` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
2. `src/shop_bot/config.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `auto_renewal_status` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í–µ–±-–ø–∞–Ω–µ–ª—å —É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é `key_info` (—Å–µ–ª–µ–∫—Ç –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ, —Å—Ç—Ä–æ–∫–∞ 4054)
- –§—É–Ω–∫—Ü–∏—è `get_key_info_text()` —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ –∏–∑ –ë–î
- –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ë–î —à–∞–±–ª–æ–Ω—ã –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏–ª–∏ SQL