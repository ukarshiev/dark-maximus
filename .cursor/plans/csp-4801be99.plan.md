<!-- 4801be99-a049-4612-8cc7-59796e71c389 8db1c89f-a99e-4e7e-b658-71857e889b72 -->
# Исправление кнопки Настройка и теста блокировки iframe

## Проблемы

1. **Кнопка "Настройка"**: Не открывается, потому что проверяет `is_production_server()` и `not _is_local_address()`, что блокирует использование localhost в development режиме. Должна всегда использовать `codex_docs_domain` из настроек + `/setup`.

2. **Тест блокировки iframe**: Нужно добавить проверку, что iframe с другим доменом не блокируется CSP.

## Решение

### 1. Исправление кнопки "Настройка"

**Файл:** `src/shop_bot/bot/keyboards.py`

**Изменения (строки 615-653):**

- Убрать проверку `is_production_server()` для `codex_docs_domain`
- Убрать проверку `not _is_local_address(codex_docs_domain)` для `codex_docs_domain`
- Всегда использовать `codex_docs_domain` из настроек, если он указан
- Формировать URL как `{codex_docs_domain}/setup` (сохраняя протокол из настроек)
- Fallback на `global_domain` только если `codex_docs_domain` не указан

**Логика:**

```python
# Кнопка настройки
codex_docs_domain = get_setting("codex_docs_domain")
setup_url = None

if codex_docs_domain:
    # Всегда используем codex_docs_domain из настроек (включая localhost для development)
    setup_url = f"{codex_docs_domain.rstrip('/')}/setup"
    # Для WebApp нормализуем URL (добавляет https:// если нужно)
    setup_url = normalize_web_app_url(setup_url)
else:
    # Fallback на global_domain только если codex_docs_domain не указан
    global_domain = get_global_domain()
    if global_domain:
        setup_url = normalize_web_app_url(f"{global_domain.rstrip('/')}/setup")
```

### 2. Добавление теста блокировки iframe

**Файл:** `tests/integration/test_user_cabinet/test_csp_headers.py`

**Изменения:**

- Добавить новый тест `test_csp_allows_iframe_from_configured_domains`
- Тест должен проверять, что домены из настроек (`codex_docs_domain` и поддомены `main_domain`) разрешены в `frame-src`
- Проверять, что конкретные домены (например, `help.dark-maximus.com` или `localhost:50002`) присутствуют в CSP или покрываются wildcard паттерном

**Логика теста:**

1. Получить CSP заголовок
2. Извлечь `frame-src` директиву
3. Проверить, что домены из настроек разрешены (либо явно указаны, либо покрываются `*.domain.com`)
4. Проверить отсутствие блокировки для конкретных доменов

## Файлы для изменения

1. `src/shop_bot/bot/keyboards.py` - исправление формирования URL кнопки "Настройка"
2. `tests/integration/test_user_cabinet/test_csp_headers.py` - добавление теста проверки блокировки iframe

## Тестирование

После изменений проверить:

1. Кнопка "Настройка" открывается с `http://localhost:50002/setup` в development режиме
2. Кнопка "Настройка" открывается с `https://help.dark-maximus.com/setup` в production режиме
3. Тест проверяет, что iframe не блокируется для доменов из настроек

### To-dos

- [ ] Изменить кнопку личного кабинета с WebApp на URL-кнопку в keyboards.py (строка 601)
- [ ] Исправить обработку help_domain в set_csp_headers() - убрать протокол перед добавлением в CSP (строки 73-83)
- [ ] Применить ту же обработку help_domain в функции health() (строки 224-235)
- [ ] Исправить формирование URL кнопки Настройка для использования codex_docs_domain из настроек без проверки production/localhost (строки 615-653)
- [ ] Добавить тест test_csp_allows_iframe_from_configured_domains для проверки блокировки iframe CSP