<!-- 57ea2df1-fe96-4ee6-8a68-a2d7ecd69cc6 c4e9e952-dc19-4778-8347-b36dfa6bfe01 -->
# План проверки исправлений ResourceWarning для SQLite соединений

## Проблема

После исправлений для устранения ResourceWarning о незакрытых соединениях SQLite необходимо проверить:

1. Корректность работы всех измененных функций
2. Отсутствие регрессий в функциональности
3. Полное устранение ResourceWarning

## Критическая информация из документации Python

**Важно**: `sqlite3.Connection` как контекстный менеджер (`with sqlite3.connect()`) НЕ закрывает соединение автоматически. Он только управляет транзакциями (commit/rollback). Соединение нужно закрывать вручную через `conn.close()`.

## Изменения, которые были сделаны

### 1. Создан контекстный менеджер `_get_db_connection()`

- **Файл**: `src/shop_bot/data_manager/database.py:182-194`
- **Назначение**: Гарантированное закрытие соединения в finally блоке
- **Статус**: ✅ Правильная реализация

### 2. Обновлены функции, используемые в тестах

- `get_user_balance()` - использует `_get_db_connection()` ✅
- `get_all_keys()` - использует `_get_db_connection()` ✅
- `register_user_if_not_exists()` - использует `_get_db_connection()` ✅
- `add_to_user_balance()` - использует `_get_db_connection()` ✅
- `set_auto_renewal_enabled()` - использует `_get_db_connection()` ✅
- `create_host()` - использует `_get_db_connection()` ✅
- `create_plan()` - использует `_get_db_connection()` ✅
- `add_new_key()` - использует `finally: conn.close()` ✅

## Потенциальные проблемы

### Проблема 1: BOM в начале файла

- **Файл**: `src/shop_bot/data_manager/database.py`
- **Проблема**: UTF-8 BOM (`\xef\xbb\xbf`) в начале файла вызывает SyntaxError при парсинге через ast.parse
- **Влияние**: Не критично для выполнения, но может вызывать проблемы в инструментах

### Проблема 2: Остальные функции используют `with sqlite3.connect()`

- **Статистика**: 150 использований `sqlite3.connect()` в файле
- **Проблема**: `with sqlite3.connect()` НЕ закрывает соединение автоматически
- **Функции, используемые в тестах автопродления**:
- `get_plans_for_host()` - использует `with sqlite3.connect()` ❌
- `get_key_by_id()` - нужно проверить
- `get_user()` - нужно проверить
- `log_notification()` - нужно проверить

### Проблема 3: Функции в scheduler.py

- `_marker_logged()` - использует `sqlite3.connect()` напрямую
- `cleanup_duplicate_notifications()` - использует `sqlite3.connect()` напрямую
- Эти функции могут вызываться из `perform_auto_renewals()`

## План проверки

### Шаг 1: Проверка синтаксиса и импортов

- [ ] Проверить, что все функции корректно импортируются
- [ ] Проверить синтаксис файла (игнорируя BOM)
- [ ] Убедиться, что `contextlib` импортирован

### Шаг 2: Проверка функций, используемых в тестах

- [ ] `get_plans_for_host()` - проверить использование соединения
- [ ] `get_key_by_id()` - проверить использование соединения
- [ ] `get_user()` - проверить использование соединения
- [ ] `log_notification()` - проверить использование соединения

### Шаг 3: Проверка функций в scheduler.py

- [ ] `_marker_logged()` - проверить закрытие соединения
- [ ] `cleanup_duplicate_notifications()` - проверить закрытие соединения

### Шаг 4: Запуск тестов

- [ ] Запустить все тесты автопродления
- [ ] Проверить количество ResourceWarning
- [ ] Убедиться, что функциональность не нарушена

### Шаг 5: Исправление найденных проблем

- [ ] Заменить `with sqlite3.connect()` на `_get_db_connection()` в критичных функциях
- [ ] Или использовать `contextlib.closing()` для явного закрытия
- [ ] Убедиться, что коммиты происходят ДО закрытия соединения

## Критерии успеха

1. ✅ Все тесты проходят успешно
2. ✅ ResourceWarning о незакрытых соединениях устранены
3. ✅ Функциональность не нарушена
4. ✅ Нет регрессий в работе БД

## Риски

- Изменение большого количества функций может привести к регрессиям
- Нужно убедиться, что коммиты происходят до закрытия соединения
- Некоторые функции могут требовать особой обработки (timeout, isolation_level)

### To-dos

- [ ] Проверить синтаксис database.py и корректность импортов
- [ ] Проверить функции get_plans_for_host, get_key_by_id, get_user, log_notification на правильное закрытие соединений
- [ ] Проверить функции _marker_logged и cleanup_duplicate_notifications в scheduler.py
- [ ] Запустить все тесты автопродления и проверить количество ResourceWarning
- [ ] Исправить найденные проблемы с незакрытыми соединениями