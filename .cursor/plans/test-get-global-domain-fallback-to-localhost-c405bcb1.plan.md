<!-- c405bcb1-2d77-454c-bcca-08ac7ca0def2 0aeb2c4d-a8be-4866-93b7-2e50b5abd9e1 -->
# Улучшение теста testgetglobaldomainfallbacktolocalhost

## Проблема

Тест периодически падает на боевом сервере из-за проблем с изоляцией БД, race conditions и недостаточной диагностики.

## Решение

### 1. Добавление диагностики

- Добавить проверку, что `database.DB_FILE` действительно указывает на `temp_db` через monkeypatch
- Логировать путь к БД, который используется функциями
- Добавить проверку всех настроек БД перед и после очистки
- Добавить проверку, что функции используют правильную БД (не реальную)

### 2. Улучшение изоляции

- Добавить явную проверку monkeypatch перед выполнением теста
- Использовать отдельное соединение с БД для каждого шага с явным закрытием
- Добавить retry-логику для операций с БД при блокировках
- Убедиться, что все соединения закрыты перед удалением записей

### 3. Повышение устойчивости

- Добавить retry для проверки удаления записей из БД
- Увеличить timeout для операций с БД
- Добавить явную синхронизацию между операциями (через проверки вместо sleep)
- Добавить проверку целостности данных перед финальной проверкой

## Файлы для изменения

- `tests/unit/test_database/test_domain_settings.py` - основной тест