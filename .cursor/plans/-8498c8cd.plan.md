<!-- 8498c8cd-eb33-47f1-b326-1e9507f05702 e734fc50-c143-4d43-8144-dc4fee11b38c -->
# Исправление маркировки триальных ключей при продлении с оплатой

## Проблема

При продлении триального ключа с оплатой реальными деньгами ключ остается помеченным как триал (`is_trial = 1`), хотя пользователь заплатил за него. Это некорректно, так как триал должен работать только 3 дня, а после оплаты ключ становится боевым.

## Решение

При продлении ключа с оплатой (price > 0) устанавливать `is_trial = 0` и обновлять статус ключа с `trial-active`/`trial-ended` на `pay-active`/`pay-ended` в зависимости от `remaining_seconds`.

## Изменения

### 1. Обновление основного метода продления в `process_successful_payment`

**Файл:** `src/shop_bot/bot/handlers.py`

**Строки:** 7408-7457

В блоке `elif action == "extend"` при обновлении ключа добавить:

- Проверку: если `price > 0`, устанавливать `is_trial = 0`
- Пересчет статуса ключа:
  - Если `remaining_seconds > 0` → `status = 'pay-active'`
  - Если `remaining_seconds <= 0` → `status = 'pay-ended'`

Обновить SQL-запросы UPDATE для включения полей `is_trial` и `status`:

```python
# В строках 7423-7432
if result.get('subscription_link'):
    cursor.execute(
        "UPDATE vpn_keys SET xui_client_uuid = ?, expiry_date = ?, remaining_seconds = ?, subscription_link = ?, is_trial = ?, status = ? WHERE key_id = ?",
        (result['client_uuid'], expiry_date, remaining_seconds, result.get('subscription_link'), is_trial_value, status_value, key_id)
    )
else:
    cursor.execute(
        "UPDATE vpn_keys SET xui_client_uuid = ?, expiry_date = ?, remaining_seconds = ?, is_trial = ?, status = ? WHERE key_id = ?",
        (result['client_uuid'], expiry_date, remaining_seconds, is_trial_value, status_value, key_id)
    )
```

Где `is_trial_value` и `status_value` вычисляются так:

- Получить текущий ключ из БД для проверки `is_trial`
- Если `price > 0` и текущий `is_trial == 1` → установить `is_trial_value = 0`
- Иначе оставить текущее значение `is_trial`
- Пересчитать `status` на основе `is_trial_value` и `remaining_seconds`

### 2. Обновление fallback-метода

**Файл:** `src/shop_bot/bot/handlers.py`

**Строки:** 7462-7472

В блоке `except Exception` (fallback) после вызова `update_key_info` добавить обновление `is_trial` и `status`, если `price > 0`:

```python
# После строки 7465 (update_key_info)
if price > 0:
    # Получаем текущий ключ
    key_data = get_key_by_id(key_id)
    if key_data and key_data.get('is_trial') == 1:
        # Обновляем is_trial и status
        from shop_bot.data_manager.database import update_key_trial_status
        update_key_trial_status(key_id, is_trial=0)
```

### 3. Создание вспомогательной функции для обновления статуса

**Файл:** `src/shop_bot/data_manager/database.py`

Добавить функцию `update_key_trial_status` для обновления `is_trial` и `status`:

```python
def update_key_trial_status(key_id: int, is_trial: int):
    """Обновляет is_trial и пересчитывает status ключа"""
    # Получить ключ, вычислить remaining_seconds, определить status
    # Обновить is_trial и status в БД
```

Альтернатива: расширить существующую функцию `update_key_info` параметром `is_trial` (опционально).

### 4. Обновление функции `update_key_info` (опционально)

**Файл:** `src/shop_bot/data_manager/database.py`

**Строки:** 7543-7570

Добавить опциональный параметр `is_trial: int | None = None` и обновлять его при продлении, если передан.

## Тестирование

1. Создать триальный ключ
2. Продлить его с оплатой (через баланс/YooKassa)
3. Проверить, что `is_trial = 0` и `status = 'pay-active'` (если не истек)
4. Проверить автопродление триального ключа с баланса

## Примечания

- Изменения затрагивают только продление с оплатой (price > 0)
- Бесплатное продление (если такое возможно) не должно менять `is_trial`
- Автопродление через `perform_auto_renewals` также будет обработано, так как оно вызывает `process_successful_payment` с `action='extend'` и `price > 0`

### To-dos

- [ ] Обновить основной метод продления в process_successful_payment: добавить логику установки is_trial=0 и пересчета status при price > 0
- [ ] Обновить fallback-метод в process_successful_payment: добавить обновление is_trial и status после update_key_info
- [ ] Создать вспомогательную функцию update_key_trial_status в database.py для обновления is_trial и status
- [ ] Протестировать продление триального ключа с оплатой через баланс
- [ ] Протестировать автопродление триального ключа