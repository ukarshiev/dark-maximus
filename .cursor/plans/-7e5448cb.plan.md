<!-- 7e5448cb-e983-4e45-9434-8570ac0595de f2e48add-4a3c-4ae8-9725-f389d191167e -->
# План исправления проваленных и пропущенных тестов

## Анализ проблем

### Статистика дефектов

- **Product defects**: 24 теста
- **Test defects**: 2 теста
- **Всего**: 26 тестов

### Категории проблем

#### 1. Проблемы с timezone (1 тест)

- **Тест**: `test_database_structure` в `tests/unit/test_database/test_timezone_operations.py`
- **Проблема**: Колонка `timezone` отсутствует в таблице `users`
- **Причина**: Колонка не добавляется в миграции `run_migration()` в `src/shop_bot/data_manager/database.py`
- **Файлы**: 
- `src/shop_bot/data_manager/database.py` (функция `run_migration`, строка ~1201)
- `tests/unit/test_database/test_timezone_operations.py` (тест `test_database_structure`, строка 192)

#### 2. Проблемы с Flask async views (2 теста - Test defects)

- **Тесты**: 
- `test_webhook_cryptobot_verification` в `tests/integration/test_payments/test_webhook_handling.py`
- `test_webhook_heleket_verification` в `tests/integration/test_payments/test_webhook_handling.py`
- **Проблема**: `RuntimeError: Install Flask with the 'async' extra in order to use async views.`
- **Причина**: Flask установлен без поддержки async views
- **Файлы**:
- `pyproject.toml` или `requirements.txt` (зависимости Flask)
- `tests/integration/test_payments/test_webhook_handling.py`

#### 3. Проблемы с авторизацией в webhook_server (15 тестов)

- **Тесты**: Множество тестов в `tests/unit/test_webhook_server/` падают с ошибками 302 (редирект) или 429 (Too Many Requests)
- **Проблема**: Тесты не проходят авторизацию или превышают лимит запросов
- **Причина**: Проблемы с сессиями, rate limiting или конфигурацией тестового окружения
- **Файлы**:
- `tests/unit/test_webhook_server/test_auth.py`
- `tests/unit/test_webhook_server/test_dashboard.py`
- `tests/unit/test_webhook_server/test_keys.py`
- `tests/unit/test_webhook_server/test_users.py`
- `tests/unit/test_webhook_server/test_wiki.py`
- `tests/unit/test_webhook_server/test_support.py`
- `tests/unit/test_webhook_server/test_transactions.py`
- `tests/conftest.py` (фикстуры для webhook_server)

#### 4. Проблемы с регистрацией пользователей (2 E2E теста)

- **Тесты**: 
- `test_new_user_registers_and_buys_vpn` в `tests/e2e/test_user_scenarios/test_new_user_purchase.py`
- `test_new_user_requests_trial_and_gets_key` в `tests/e2e/test_user_scenarios/test_user_trial_flow.py`
- **Проблема**: `AssertionError: Пользователь должен быть зарегистрирован\nassert None is not None`
- **Причина**: Функция регистрации пользователя возвращает None вместо объекта пользователя
- **Файлы**:
- `tests/e2e/test_user_scenarios/test_new_user_purchase.py`
- `tests/e2e/test_user_scenarios/test_user_trial_flow.py`
- `src/shop_bot/data_manager/database.py` (функция `register_user_if_not_exists`)

#### 5. Проблемы с триалом (2 интеграционных теста)

- **Тесты**: 
- `test_trial_reuse_flow` в `tests/integration/test_trial/test_trial_flow.py`
- `test_trial_revocation_flow` в `tests/integration/test_trial/test_trial_flow.py`
- **Проблема**: 
- `test_trial_reuse_flow`: `AssertionError: assert 2 == 1` (количество повторных использований триала)
- `test_trial_revocation_flow`: `AssertionError: assert False` (не вызывается `delete_client_by_uuid`)
- **Причина**: Логика повторного использования триала или отзыва триального ключа работает некорректно
- **Файлы**:
- `tests/integration/test_trial/test_trial_flow.py`
- `src/shop_bot/data_manager/database.py` (функции работы с триалом)

#### 6. Проблемы с обработкой webhook'ов (2 теста)

- **Тесты**: 
- `test_support_check_config` в `tests/unit/test_webhook_server/test_support.py` (500 Internal Server Error)
- `test_webhook_list` в `tests/unit/test_webhook_server/test_transactions.py` (500 Internal Server Error)
- **Проблема**: Серверные ошибки при обработке запросов
- **Причина**: Проблемы в обработчиках webhook'ов или конфигурации
- **Файлы**:
- `tests/unit/test_webhook_server/test_support.py`
- `tests/unit/test_webhook_server/test_transactions.py`
- `src/webhook_server/` (обработчики webhook'ов)

## План исправлений

### Этап 0: Проверка и исправление Allure декораторов согласно testing-rules.mdc

**КРИТИЧЕСКИ ВАЖНО:** Все тесты должны соответствовать правилам из testing-rules.mdc и иметь русскоязычные декораторы на всех вкладках Allure Report.

1. **Проверка обязательных декораторов для всех тестов:**

- `@allure.epic` - на русском языке, определяется по расположению теста (см. таблицу в testing-rules.mdc)
- `@allure.feature` - на русском языке, определяется по функциональности
- `@allure.title` - на русском языке, краткое описание теста
- `@allure.description` - на русском языке, подробное описание с разделами
- `@allure.severity` - уровень важности (CRITICAL, NORMAL, MINOR)
- `@allure.tag` - теги для фильтрации (обязательно тип теста: "unit", "integration", "e2e")
- `@allure.label("package", "...")` - рекомендуется для всех тестов

2. **Проверка обязательных декораторов для интеграционных и E2E тестов:**

- `@allure.story` - на русском языке, обязателен для интеграционных и E2E тестов
- Описывает конкретный пользовательский сценарий или поведение

3. **Проверка правильности выбора epic и feature:**

- Epic определяется по расположению теста (см. таблицу в testing-rules.mdc)
- Feature определяется по функциональности, которую тестирует класс или файл
- Все названия на русском языке

4. **Проверка структуры @allure.description:**

- Краткое описание (1-2 предложения)
- Раздел "Что проверяется" / "Проверяемые аспекты"
- Раздел "Тестовые данные" / "Входные данные"
- Раздел "Ожидаемый результат"
- Для интеграционных/E2E: разделы "Предусловия" и "Шаги теста"
- Для критичных тестов: раздел "Важность" / "Критичность"

5. **Проверка имен функций и классов:**

- Имена функций тестов (`test_*`) - на английском языке
- Имена классов тестов (`Test*`) - на английском языке
- Имена файлов тестов (`test_*.py`) - на английском языке
- Docstrings могут быть на русском языке

6. **Проверка использования allure.step() и allure.attach():**

- Для сложных тестов использовать `allure.step()` для структурирования
- Прикреплять важные данные через `allure.attach()`

7. **Исправление всех тестов, не соответствующих правилам:**

- Проваленные тесты (26 тестов из Product defects и Test defects)
- Все остальные тесты в проекте
- Особое внимание к тестам без декораторов или с неправильными декораторами

8. **Проверка результатов в Allure Report:**

- Убедиться, что все вкладки (Overview, Categories, Suite, Graph, Timeline, Behaviors, Packages) отображают русскоязычные названия
- Проверить группировку тестов по epic, feature, story, package

### Этап 1: Исправление миграции БД для timezone

1. Добавить проверку и добавление колонки `timezone` в функцию `run_migration()` в `src/shop_bot/data_manager/database.py`
2. Добавить колонку после проверки других колонок (после `auto_renewal_enabled`, строка ~1498)
3. Протестировать миграцию на тестовой БД
4. Запустить тест `test_database_structure` для проверки
5. **Убедиться, что тест имеет все обязательные Allure декораторы согласно testing-rules.mdc**

### Этап 2: Исправление Flask async views

1. Проверить текущую версию Flask в `pyproject.toml`
2. Обновить зависимость Flask до версии с поддержкой async (Flask 3.0+ с `[async]` extra)
3. Обновить установку: `pip install "flask[async]>=3.0.0"` или добавить в `pyproject.toml`
4. Запустить тесты `test_webhook_cryptobot_verification` и `test_webhook_heleket_verification`
5. **Убедиться, что тесты имеют все обязательные Allure декораторы, включая @allure.story (интеграционные тесты)**

### Этап 3: Исправление авторизации в webhook_server

1. Исследовать проблему с сессиями в тестах (проверить фикстуры в `tests/conftest.py`)
2. Проверить rate limiting в тестах (возможно, нужно сбросить счетчик между тестами)
3. Исправить фикстуры для корректной авторизации в тестах
4. Запустить все тесты в `tests/unit/test_webhook_server/` для проверки
5. **Убедиться, что все тесты имеют правильные Allure декораторы с epic="Веб-панель" и соответствующими feature**

### Этап 4: Исправление регистрации пользователей

1. Исследовать функцию `register_user_if_not_exists` в `src/shop_bot/data_manager/database.py`
2. Проверить, почему функция возвращает None вместо объекта пользователя
3. Исправить функцию или тесты (в зависимости от причины)
4. Запустить E2E тесты для проверки
5. **Убедиться, что E2E тесты имеют все обязательные декораторы, включая @allure.story на русском языке**

### Этап 5: Исправление проблем с триалом

1. Исследовать логику повторного использования триала в `test_trial_reuse_flow`
2. Исследовать логику отзыва триального ключа в `test_trial_revocation_flow`
3. Исправить функции работы с триалом в `src/shop_bot/data_manager/database.py`
4. Запустить интеграционные тесты для проверки
5. **Убедиться, что интеграционные тесты имеют @allure.story на русском языке**

### Этап 6: Исправление обработки webhook'ов

1. Исследовать проблему в `test_support_check_config` (500 ошибка)
2. Исследовать проблему в `test_webhook_list` (500 ошибка)
3. Исправить обработчики webhook'ов в `src/webhook_server/`
4. Запустить тесты для проверки
5. **Убедиться, что тесты имеют правильные Allure декораторы**

## Приоритет исправлений

1. **Высокий приоритет**: Этап 1 (timezone) - критично для работы функционала
2. **Высокий приоритет**: Этап 2 (Flask async) - блокирует 2 теста
3. **Средний приоритет**: Этап 3 (авторизация) - блокирует 15 тестов
4. **Средний приоритет**: Этап 4 (регистрация) - блокирует 2 E2E теста
5. **Средний приоритет**: Этап 5 (триал) - блокирует 2 интеграционных теста
6. **Низкий приоритет**: Этап 6 (webhook'и) - блокирует 2 теста

## Тестирование

После каждого этапа:

1. Запустить соответствующие тесты
2. Проверить результаты в Allure отчете
3. Убедиться, что тесты проходят
4. Обновить CHANGELOG.md и версию в pyproject.toml