<!-- 49885fa5-b206-4ec4-92eb-7756cec6c35d b423dfb2-782c-4fe7-be99-e41a95974915 -->
# Исправление пропуска тестов валидации шаблонов

## Проблема

Три теста пропускаются с сообщением "В БД нет активных шаблонов для проверки":

- `test_all_active_templates_are_valid`
- `test_no_br_tags_in_templates`
- `test_no_invalid_variables_in_templates`

## Анализ проблемы

**Важно:** Активные шаблоны в БД есть, проблема в логике тестов.

1. **Функции `get_all_message_templates()` и `get_message_template_statistics()` используют `DB_FILE`**, который патчится через `monkeypatch` в фикстуре `temp_db`
2. **Проблема:** Функции могут использовать неправильный `DB_FILE` или кэш не очищается правильно
3. **В тесте `test_all_active_templates_are_valid`:**

- Тест создает шаблоны через прямое подключение `sqlite3.connect(str(temp_db))` (строка 169)
- Затем вызывает `get_message_template_statistics()`, которая использует `DB_FILE`
- Если `DB_FILE` не патчен правильно, функция читает из неправильной БД

4. **В тестах `test_no_br_tags_in_templates` и `test_no_invalid_variables_in_templates`:**

- Тесты сразу вызывают `get_all_message_templates()` без проверки наличия шаблонов
- Если `DB_FILE` не патчен правильно, функции читают из production БД, а не из тестовой

## Решение

### 1. Проверка использования DB_FILE в функциях

- Убедиться, что `get_all_message_templates()` и `get_message_template_statistics()` используют `DB_FILE` напрямую (а не кэшированное значение)
- Проверить, что патчинг `DB_FILE` работает корректно

### 2. Исправление теста `test_all_active_templates_are_valid`

- После создания тестовых шаблонов убедиться, что используется патченный `DB_FILE`
- Добавить проверку, что шаблоны действительно созданы в правильной БД
- Убедиться, что кэш очищается после создания шаблонов

### 3. Исправление тестов `test_no_br_tags_in_templates` и `test_no_invalid_variables_in_templates`

- Эти тесты не создают тестовые шаблоны, поэтому они пропускаются, если в БД нет активных шаблонов
- Добавить создание тестовых шаблонов в эти тесты (аналогично `test_all_active_templates_are_valid`)

### 4. Проверка работы патчинга DB_FILE

- Убедиться, что `monkeypatch.setattr(database, 'DB_FILE', TEST_DB_PATH)` работает корректно
- Проверить, что функции используют патченный `DB_FILE`, а не старый

## Файлы для изменения

1. `tests/unit/test_utils/test_template_validation.py` - исправление логики создания тестовых шаблонов и проверки использования правильного DB_FILE
2. Возможно `tests/conftest.py` - если проблема в фикстуре `temp_db`

## Шаги реализации

1. Добавить отладочную информацию в тест для проверки, какая БД используется
2. Исправить создание тестовых шаблонов, чтобы использовать патченный `DB_FILE` через функции модуля `database`
3. Добавить создание тестовых шаблонов в тесты `test_no_br_tags_in_templates` и `test_no_invalid_variables_in_templates`
4. Запустить тесты и проверить отчет Allure
5. Убедиться, что все три теста проходят успешно