<!-- 9bf025f6-0766-49cb-ad61-4ac4b415bcfa d1301fa1-aa9f-486d-ab06-edfd8b183bb3 -->
# План создания теста фильтрации планов по режиму отображения

## Цель

Создать comprehensive unit-тест для функции `filter_plans_by_display_mode()` с покрытием всех режимов отображения, групп пользователей и edge cases.

## Структура теста

### Файл: `tests/unit/test_database/test_plan_display_mode.py`

Тест будет включать следующие сценарии:

1. **Режим 'all'** — тариф показывается всем пользователям
2. **Режим 'hidden_all'** — тариф скрыт у всех пользователей (независимо от групп)
3. **Режим 'hidden_new'** — тариф скрыт у новых пользователей (не использовавших этот тариф)
4. **Режим 'hidden_old'** — тариф скрыт у старых пользователей (уже использовавших тариф)
5. **Фильтрация по группам** (`display_mode_groups`) — тариф показывается только пользователям из указанных групп
6. **Приоритет display_mode над display_mode_groups** — режим 'hidden_all' скрывает тариф независимо от групп
7. **Edge cases** — пустые списки, None значения, пользователи без группы

### Технические детали

#### Фикстуры

- Использование `temp_db` из `conftest.py` для изолированной БД
- Создание тестовых пользователей через прямые SQL-запросы
- Создание тестовых групп пользователей
- Создание тестовых планов с различными `display_mode` и `display_mode_groups`
- Мокирование или прямое использование `get_user_group_info()` и `get_user_used_plans_batch()` (они работают с БД)

#### Allure интеграция

- `@allure.epic("База данных")` или `@allure.epic("Тарифные планы")`
- `@allure.feature("Фильтрация планов")`
- `@allure.story("Режим отображения")` / `@allure.story("Группы пользователей")`
- `@allure.description("...")` для каждого теста с подробным описанием
- `@allure.step("...")` для ключевых действий в тестах
- Параметризация через `@pytest.mark.parametrize` с описанием параметров

#### Маркеры pytest

- `@pytest.mark.unit` — unit-тест
- `@pytest.mark.database` — тест работы с БД
- Структура класса `TestPlanDisplayMode` с методами для каждого сценария

## Документация

### Файл: `docs/guides/testing/test-plan-display-mode.md`

Статья должна включать:

1. **Описание функции** — что делает `filter_plans_by_display_mode()`
2. **Режимы отображения** — подробное описание каждого режима с примерами
3. **Группы пользователей** — как работает фильтрация по группам
4. **Приоритеты** — приоритет display_mode над display_mode_groups
5. **Структура тестов** — описание каждого тестового сценария
6. **Примеры использования** — реальные кейсы применения
7. **Диаграмма** (Mermaid) — визуализация логики фильтрации

## Реализация

### Ключевые моменты

- Все тесты изолированы (используют `temp_db`)
- Используются реальные функции БД, но с временной БД
- Подробные assert-сообщения для лучшей диагностики
- Покрытие всех путей выполнения функции
- Проверка edge cases (None, пустые списки, отсутствие данных)

### Зависимости функции

- `get_user_group_info(user_id)` — получает группу пользователя
- `get_user_used_plans_batch(user_id)` — получает использованные планы пользователя

Эти функции работают с БД напрямую, поэтому будут работать с `temp_db` без моков.

## Проверка

После создания:

1. Запустить тесты: `pytest tests/unit/test_database/test_plan_display_mode.py -v`
2. Проверить Allure отчет: открыть `allure-results` в Allure Service
3. Проверить покрытие всех режимов и edge cases
4. Убедиться, что документация корректна и читаема

### To-dos

- [ ] Создать файл tests/unit/test_database/test_plan_display_mode.py с базовой структурой класса TestPlanDisplayMode
- [ ] Реализовать тесты для режима 'all' (показывается всем пользователям)
- [ ] Реализовать тесты для режима 'hidden_all' (скрыт у всех)
- [ ] Реализовать тесты для режима 'hidden_new' (скрыт у новых пользователей)
- [ ] Реализовать тесты для режима 'hidden_old' (скрыт у старых пользователей)
- [ ] Реализовать тесты для фильтрации по группам пользователей (display_mode_groups)
- [ ] Реализовать тесты для проверки приоритета display_mode над display_mode_groups
- [ ] Реализовать тесты для edge cases (None, пустые списки, пользователи без группы)
- [ ] Добавить Allure аннотации (@allure.epic, @allure.feature, @allure.story, @allure.description, @allure.step) для всех тестов
- [ ] Создать документацию docs/guides/testing/test-plan-display-mode.md с описанием функции, режимов, примеров и диаграммой
- [ ] Запустить тесты и проверить их корректность, убедиться что все проходят
- [ ] Проверить Allure отчет на корректность отображения описаний, шагов и меток