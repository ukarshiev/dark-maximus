<!-- c464043e-2942-4998-bb6e-1a3ca62a4ffb 2fb16a21-72aa-4e1c-bf8c-25740214809f -->
# –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å Yookassa –ø–ª–∞—Ç–µ–∂–æ–º –∏ webhook

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–µ–ª –≤ Yookassa (Status: succeeded), –Ω–æ –ù–ï –æ–±—Ä–∞–±–æ—Ç–∞–ª—Å—è –≤ –±–æ—Ç–µ.**

### –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã:

- ‚úÖ **–ü–ª–∞—Ç–µ–∂ –≤ Yookassa API**: `status: "succeeded"`, `paid: True`, captured_at: 2025-11-07T17:23:53Z
- ‚úÖ **–î–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞**: RRN 531146692513, Auth Code 807980, –∫–∞—Ä—Ç–∞ MIR *8587, —Å—É–º–º–∞ 5.00 RUB
- ‚úÖ **–í –≤–µ–±-–ø–∞–Ω–µ–ª–∏**: –†–µ–∂–∏–º "–ë–æ–µ–≤–æ–π", shop_id=1174374, API URL=https://api.yookassa.ru/v3
- ‚ùå **–í –ë–î –±–æ—Ç–∞**: `yookassa_test_mode = 'true'` (–†–ê–°–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø!)
- ‚ùå **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –ë–î**: –ù–ï –ù–ê–ô–î–ï–ù–ê (–Ω–µ —Å–æ–∑–¥–∞–ª–∞—Å—å –∏–ª–∏ –≤–∏—Å–∏—Ç –≤ pending)
- ‚ùå **Webhook**: –ù–ï –ø—Ä–∏—à–µ–ª –∏–ª–∏ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª—Å—è (–Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ –ª–æ–≥–∞—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3000 —Å—Ç—Ä–æ–∫)

### üéØ –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:

**–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –†–ê–°–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ù–ê–°–¢–†–û–ï–ö**

1. –í–µ–±-–ø–∞–Ω–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç "–ë–æ–µ–≤–æ–π —Ä–µ–∂–∏–º" (–ø–æ–ª–∑—É–Ω–æ–∫ –≤—ã–∫–ª—é—á–µ–Ω)
2. –ù–û –≤ –ë–î —Ö—Ä–∞–Ω–∏—Ç—Å—è `yookassa_test_mode = 'true'`
3. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –±–æ—Ç —á–∏—Ç–∞–µ—Ç –ë–î –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –≤ SDK —Ñ–ª–∞–≥ `"test": true`
4. SDK Yookassa –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å **–±–æ–µ–≤—ã–º–∏** –∫–ª—é—á–∞–º–∏ (shop_id=1174374)
5. –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂ —Å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: –±–æ–µ–≤–æ–π –º–∞–≥–∞–∑–∏–Ω + —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–ª–∞–≥
6. Webhook –¥–ª—è —Ç–∞–∫–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –ª–∏–±–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –ª–∏–±–æ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–æ–π

**–≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç, –ø–æ—á–µ–º—É —Ä–∞–Ω—å—à–µ —Ä–∞–±–æ—Ç–∞–ª —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º** ‚Äî —Ç–∞–º –±—ã–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–∫.

---

## –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ test_mode

**–¶–µ–ª—å**: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –º–µ–∂–¥—É –≤–µ–±-–ø–∞–Ω–µ–ª—å—é –∏ –ë–î.

### 1.1 –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ test_mode –≤ –ë–î

```bash
docker exec dark-maximus-bot python -c "
from shop_bot.data_manager.database import update_setting
update_setting('yookassa_test_mode', 'false')
print('‚úÖ test_mode —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ false')
"
```

### 1.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```bash
docker exec dark-maximus-bot python -c "
from shop_bot.data_manager.database import get_setting
print('yookassa_test_mode:', repr(get_setting('yookassa_test_mode')))
print('yookassa_shop_id:', get_setting('yookassa_shop_id'))
print('yookassa_secret_key:', '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if get_setting('yookassa_secret_key') else '–ù–ï–¢')
"
```

### 1.3 –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

```bash
npx nx restart bot
```

–ñ–¥–µ–º 15-20 —Å–µ–∫—É–Ω–¥, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—Å–∫:

```bash
npx nx logs bot --tail=50 | grep -i "yookassa\|started"
```

---

## –®–∞–≥ 2: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ webhook endpoint

**–¶–µ–ª—å**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ endpoint –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã.

### 2.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞

```bash
curl -X POST https://panel.dark-maximus.com/yookassa-webhook \
  -H "Content-Type: application/json" \
  -d '{"event":"test","object":{}}'
```

–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: `OK` (—Å—Ç–∞—Ç—É—Å 200).

### 2.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–æ–≥–∞—Ö Flask

```bash
npx nx logs bot --tail=100
```

–î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å—å –æ POST –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ `/yookassa-webhook`.

### 2.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ webhook –≤ Yookassa –õ–ö

1. –í–æ–π—Ç–∏: https://yookassa.ru ‚Üí –≤—ã–±—Ä–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω 1174374
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:

   - **URL**: `https://panel.dark-maximus.com/yookassa-webhook`
   - **–°–æ–±—ã—Ç–∏—è**: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–æ `payment.succeeded`
   - **–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏**: –Ω–∞–π—Ç–∏ –ø–ª–∞—Ç–µ–∂ `30a03e8b-000f-5001-9000-1a3cbd78f7de` –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ webhook

–ï—Å–ª–∏ webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ URL –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ‚Üí –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.

---

## –®–∞–≥ 3: –†—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ 30a03e8b-000f-5001-9000-1a3cbd78f7de

**–¶–µ–ª—å**: –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø.

### 3.1 –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

–§–∞–π–ª: `tests/test_manual_yookassa_fix.py`

```python
import asyncio
import sys
sys.path.insert(0, '/app/project')

from shop_bot.data_manager.database import get_setting
from shop_bot.bot import handlers
import requests

# ID –ø–ª–∞—Ç–µ–∂–∞
payment_id = "30a03e8b-000f-5001-9000-1a3cbd78f7de"

# –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Yookassa API
shop_id = get_setting("yookassa_shop_id")
secret_key = get_setting("yookassa_secret_key")

response = requests.get(
    f"https://api.yookassa.ru/v3/payments/{payment_id}",
    auth=(shop_id, secret_key)
)

if response.status_code != 200:
    print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: {response.status_code}")
    print(response.text)
    sys.exit(1)

payment_data = response.json()
print("‚úÖ –ü–ª–∞—Ç–µ–∂ –ø–æ–ª—É—á–µ–Ω –∏–∑ Yookassa API")
print(f"–°—Ç–∞—Ç—É—Å: {payment_data['status']}")
print(f"–°—É–º–º–∞: {payment_data['amount']['value']} {payment_data['amount']['currency']}")

# –ò–∑–≤–ª–µ–∫–∞–µ–º metadata –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
metadata = payment_data.get("metadata", {})
auth_details = payment_data.get("authorization_details", {})

# –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è process_successful_yookassa_payment
metadata["yookassa_payment_id"] = payment_data["id"]
metadata["rrn"] = auth_details.get("rrn")
metadata["authorization_code"] = auth_details.get("auth_code")
metadata["payment_type"] = payment_data.get("payment_method", {}).get("type")

print(f"Metadata: {metadata}")

# –ü–æ–ª—É—á–∞–µ–º bot instance
from shop_bot.bot_controller import BotController
import logging
logging.basicConfig(level=logging.INFO)

async def process():
    # –ò–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –±–æ—Ç–∞ –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
    from aiogram import Bot
    bot_token = get_setting("telegram_bot_token")
    bot = Bot(token=bot_token)
    
    try:
        await handlers.process_successful_yookassa_payment(bot, metadata)
        print("‚úÖ –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ!")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}")
        import traceback
        traceback.print_exc()
    finally:
        await bot.session.close()

asyncio.run(process())
```

### 3.2 –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É

```bash
docker exec dark-maximus-bot python /app/tests/test_manual_yookassa_fix.py
```

### 3.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 6044240344 –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø:

```bash
docker exec dark-maximus-bot python -c "
from shop_bot.data_manager.database import get_user, get_user_keys
user = get_user(6044240344)
keys = get_user_keys(6044240344)
print(f'–ë–∞–ª–∞–Ω—Å: {user.get(\"balance\", 0)} RUB')
print(f'–ö–ª—é—á–µ–π: {len(keys)}')
"
```

---

## –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook —Å –Ω–æ–≤—ã–º —Ç–µ—Å—Ç–æ–≤—ã–º –ø–ª–∞—Ç–µ–∂–æ–º

**–¶–µ–ª—å**: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ webhook —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

### 4.1 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

–û—Ç–∫—Ä—ã—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

```powershell
npx --yes nx logs bot -f --tail=100 2>&1 |
  Select-String -Pattern 'yookassa|webhook|payment\.succeeded|process_successful' -Context 2,0 -Wait -NoEmphasis
```

### 4.2 –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞

1. –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ @maximus_vpn_bot
2. –í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ (–ª—é–±–æ–π –Ω–∞ 5 RUB)
3. –í—ã–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã "–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞"
4. –û–ø–ª–∞—Ç–∏—Ç—å

### 4.3 –ù–∞–±–ª—é–¥–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö

–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏:

```
[INFO] - YooKassa webhook: Received payment.succeeded
[INFO] - process_successful_yookassa_payment called
[INFO] - Transaction updated: payment_id=..., status=completed
```

### 4.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –ë–î

```bash
docker exec dark-maximus-bot python -c "
import sqlite3
conn = sqlite3.connect('/app/project/users.db')
cursor = conn.cursor()
cursor.execute('SELECT transaction_id, payment_id, user_id, status, amount_rub, created_date FROM transactions ORDER BY transaction_id DESC LIMIT 3')
for row in cursor.fetchall():
    print(f'ID={row[0]}, payment={row[1][:20]}..., user={row[2]}, status={row[3]}, amount={row[4]}, date={row[5]}')
conn.close()
"
```

---

## –®–∞–≥ 5: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è test_mode (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–¶–µ–ª—å**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –±—É–¥—É—â–µ–º.

### 5.1 –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –∫–æ–¥–∞

–§–∞–π–ª: `src/shop_bot/bot/handlers.py`, —Å—Ç—Ä–æ–∫–∞ 4643:

```python
yookassa_test_mode = get_setting("yookassa_test_mode") == "true"
# ...
"test": yookassa_test_mode,  # —Å—Ç—Ä–æ–∫–∞ 4661
```

–ü—Ä–æ–±–ª–µ–º–∞: —Ñ–ª–∞–≥ `test` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ API, –Ω–æ SDK —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏ –≤ bot_controller.py.

### 5.2 –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í handlers.py –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–∞ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É:

```python
yookassa_test_mode = get_setting("yookassa_test_mode") == "true"
current_shop_id = get_setting("yookassa_shop_id")

logger.info(f"Creating Yookassa payment: test_mode={yookassa_test_mode}, shop_id={current_shop_id}")

if yookassa_test_mode and current_shop_id and not current_shop_id.startswith("test_"):
    logger.warning(f"‚ö†Ô∏è INCONSISTENCY: test_mode=true but using production shop_id={current_shop_id}")
```

### 5.3 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

–î–æ–±–∞–≤–∏—Ç—å –≤ `docs/integrations/yookassa-webhook-setup.md` —Ä–∞–∑–¥–µ–ª "–í–∞–∂–Ω–æ –ø—Ä–æ test_mode":

```markdown
## ‚ö†Ô∏è –í–∞–∂–Ω–æ –ø—Ä–æ test_mode

test_mode –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–∏–ø—É –º–∞–≥–∞–∑–∏–Ω–∞:
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –±–æ–µ–≤–æ–π shop_id ‚Üí test_mode –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –í–´–ö–õ–Æ–ß–ï–ù (false)
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π shop_id ‚Üí test_mode –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –í–ö–õ–Æ–ß–ï–ù (true)

–†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–µ–º—É webhook!
```

---

## –®–∞–≥ 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CHANGELOG.md

### 6.1 –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏

–§–æ—Ä–º–∞—Ç: `X.Y.Z ‚Äì DD.MM.YYYY HH:mm` (–≤—Ä–µ–º—è UTC+3)

Bump –≤–µ—Ä—Å–∏–∏: –ü–∞—Ç—á (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ webhook)

```markdown
[PATCH] (–ü–ª–∞—Ç–µ–∂–∏) handlers.py, database.py ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π Yookassa –ø–ª–∞—Ç–µ–∂–µ–π
- –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ yookassa_test_mode –º–µ–∂–¥—É –≤–µ–±-–ø–∞–Ω–µ–ª—å—é –∏ –ë–î
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook –¥–ª—è –±–æ–µ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å test_mode
- –í—Ä—É—á–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ø–ª–∞—Ç–µ–∂ 30a03e8b-000f-5001-9000-1a3cbd78f7de
```

---

## –®–∞–≥ 7: –£–ª—É—á—à–µ–Ω–∏–µ UI - —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ä–µ–∂–∏–º–∞

**–¶–µ–ª—å**: –°–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ä–µ–∂–∏–º–∞ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª–∏.

### 7.1 –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ —à–∞–±–ª–æ–Ω–µ settings.html

–§–∞–π–ª: `src/shop_bot/webhook_server/templates/settings.html` (—Å—Ç—Ä–æ–∫–∞ ~844)

**–ë—ã–ª–æ:**

- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å ON ‚Üí "–†–µ–∂–∏–º: –¢–µ—Å—Ç–æ–≤—ã–π"
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å OFF ‚Üí "–†–µ–∂–∏–º: –ë–æ–µ–≤–æ–π"

**–°—Ç–∞–ª–æ:**

- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å ON (test_mode=false) ‚Üí "–†–µ–∂–∏–º: –ë–æ–µ–≤–æ–π –≤–∫–ª—é—á–µ–Ω"
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å OFF (test_mode=true) ‚Üí "–†–µ–∂–∏–º: –ë–æ–µ–≤–æ–π –æ—Ç–∫–ª—é—á–µ–Ω, –≤–∫–ª—é—á–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π"

–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 844-850:

```html
<span id="mode-label-text">
    {% if settings.yookassa_test_mode == 'true' %}
        –†–µ–∂–∏–º: –ë–æ–µ–≤–æ–π –æ—Ç–∫–ª—é—á–µ–Ω, –≤–∫–ª—é—á–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π
    {% else %}
        –†–µ–∂–∏–º: –ë–æ–µ–≤–æ–π –≤–∫–ª—é—á–µ–Ω
    {% endif %}
</span>
```

### 7.2 –û–±–Ω–æ–≤–∏—Ç—å JavaScript —Ñ—É–Ω–∫—Ü–∏—é toggleYooKassaMode()

–§–∞–π–ª: `src/shop_bot/webhook_server/static/js/script.js` (—Ñ—É–Ω–∫—Ü–∏—è toggleYooKassaMode)

–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:

```javascript
function toggleYooKassaMode() {
    const checkbox = document.getElementById('yookassa_test_mode');
    const label = document.getElementById('mode-label-text');
    
    if (checkbox.checked) {
        label.textContent = '–†–µ–∂–∏–º: –ë–æ–µ–≤–æ–π –æ—Ç–∫–ª—é—á–µ–Ω, –≤–∫–ª—é—á–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π';
    } else {
        label.textContent = '–†–µ–∂–∏–º: –ë–æ–µ–≤–æ–π –≤–∫–ª—é—á–µ–Ω';
    }
}
```

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã

1. **tests/test_manual_yookassa_fix.py** ‚Äî –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
2. **src/shop_bot/bot/handlers.py** (—Å—Ç—Ä–æ–∫–∞ ~4643) ‚Äî –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Yookassa –ø–ª–∞—Ç–µ–∂–∞
3. **src/shop_bot/bot_controller.py** (—Å—Ç—Ä–æ–∫–∞ ~119) ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Yookassa SDK
4. **src/shop_bot/webhook_server/templates/settings.html** (—Å—Ç—Ä–æ–∫–∞ ~844) ‚Äî —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ä–µ–∂–∏–º–∞
5. **src/shop_bot/webhook_server/static/js/script.js** ‚Äî —Ñ—É–Ω–∫—Ü–∏—è toggleYooKassaMode()
6. **docs/integrations/yookassa-webhook-setup.md** ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ webhook
7. **CHANGELOG.md** ‚Äî –∑–∞–ø–∏—Å—å –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã

---

## ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞:

1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `yookassa_test_mode` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ `false`)
2. ‚úÖ –¢–µ–∫—É—â–∏–π –ø–ª–∞—Ç–µ–∂ (30a03e8b...) –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤—Ä—É—á–Ω—É—é, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 6044240344 –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø
3. ‚úÖ Webhook endpoint –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç Yookassa
4. ‚úÖ –ù–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ webhook
5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ–¥–æ–±–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –≤ –±—É–¥—É—â–µ–º
6. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ test_mode
7. ‚úÖ –ó–∞–ø–∏—Å—å –≤ CHANGELOG.md –æ –ø—Ä–æ–±–ª–µ–º–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏

## ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ~30-40 –º–∏–Ω—É—Ç

### To-dos

- [ ] –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ webhook endpoint - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å, –ª–æ–≥–∏ Flask, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Yookassa –õ–ö
- [ ] –†—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ 30a03e8b-000f-5001-9000-1a3cbd78f7de - —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É test_mode - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä shop_id –≤ handlers.py
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ Yookassa –õ–ö - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å URL, —Å–æ–±—ã—Ç–∏—è, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π webhook
- [ ] –¢–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–ª–∞—Ç–µ–∂–æ–º - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —á–µ—Ä–µ–∑ webhook
- [ ] –û–±–Ω–æ–≤–∏—Ç—å CHANGELOG.md –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ Yookassa webhook