<!-- e62f2eaa-479a-4a31-8472-807fe34ca733 5a963dc3-a1dc-4de9-a50a-cf6b2a336036 -->
# Исправление проблемы с логаутом при обновлении страницы

## Проблема

При следующей последовательности действий происходит неожиданный логаут:

1. Пользователь заходит на `http://localhost:50000`
2. Нажимает кнопку "Кабинет" (открывается внешняя ссылка в новой вкладке)
3. Обновляет страницу `http://localhost:50000` → происходит логаут

## Анализ проблемы

### Найденные проблемы:

1. **Дублирование декоратора `login_required`**:

- Определен в `auth_utils.py` (импортируется)
- Определен локально в `app.py` (строка 389)
- Используется локальная версия, которая не логирует проверки

2. **Отсутствие `SESSION_REFRESH_EACH_REQUEST`**:

- Cookie сессии не обновляется при каждом запросе
- Может привести к потере сессии при определенных условиях

3. **Проблема с регенерацией session ID при логине**:

- Регенерация происходит, но может быть проблема с сохранением новой сессии
- Нет гарантии, что cookie установится правильно

4. **Настройки SameSite cookie**:

- `SESSION_COOKIE_SAMESITE = 'Lax'` может вызывать проблемы при переходе на внешние ссылки

5. **Отсутствие явного обновления сессии при каждом запросе**:

- Сессия не помечается как измененная при каждом запросе к защищенным страницам

## Решение

### 1. Удалить дублирование декоратора `login_required`

- Удалить локальное определение в `app.py` (строка 389-395)
- Использовать импортированный из `auth_utils.py`

### 2. Добавить `SESSION_REFRESH_EACH_REQUEST`

- В `auth_utils.py` добавить `app.config['SESSION_REFRESH_EACH_REQUEST'] = True`
- Это обеспечит обновление cookie при каждом запросе

### 3. Улучшить декоратор `login_required`

- Добавить явное обновление сессии при каждом запросе
- Убедиться, что `session.modified = True` устанавливается

### 4. Улучшить обработку логина

- Убедиться, что после регенерации session ID сессия правильно сохраняется
- Добавить дополнительное логирование для отладки

### 5. Проверить настройки cookie

- Убедиться, что `SESSION_COOKIE_MAX_AGE` правильно установлен
- Проверить, что cookie устанавливается с правильными параметрами

## Файлы для изменения

1. `src/shop_bot/webhook_server/auth_utils.py`:

- Добавить `SESSION_REFRESH_EACH_REQUEST = True`
- Улучшить декоратор `login_required` для явного обновления сессии

2. `src/shop_bot/webhook_server/app.py`:

- Удалить локальное определение `login_required` (строка 389-395)
- Использовать импортированный из `auth_utils`
- Улучшить обработку логина для гарантированного сохранения сессии

## Тестирование

После исправления проверить:

1. Логин работает корректно
2. Сессия сохраняется при обновлении страницы
3. Сессия сохраняется после перехода на внешнюю ссылку "Кабинет" и возврата
4. Cookie устанавливается правильно и не теряется
5. Логи показывают корректную работу сессий