<!-- d066ea13-e68e-49d4-bd41-11e57b4713f3 b055bd7c-f327-4e34-8f83-3c8f6a364b51 -->
# Исправление проблемы с Allure отчетами

## Диагностика проблемы

### Факты из исследования

1. **Количество тестов:**

   - pytest собирает **484 теста** (`pytest --collect-only`)
   - В `allure-results/` только **25 файлов `*-result.json`**
   - Это означает, что **459 тестов не сохранили результаты**

2. **Текущая структура:**

   - `allure-results/` в корне проекта (правильно)
   - `conftest.py` правильно устанавливает путь через `pytest_configure`
   - Volume mapping в `docker-compose.yml` корректен
   - Allure Service работает и генерирует отчеты

3. **Проблема:**

   - **Старые результаты не очищаются** перед новым запуском тестов
   - При каждом запуске pytest **перезаписывает только те тесты, которые были запущены**
   - Если запускается только часть тестов (например, 25), то в `allure-results/` остаются только эти 25 результатов
   - Allure Service генерирует отчет на основе текущего содержимого `allure-results/`, показывая только 25 тестов

4. **Корневая причина:**

   - **Отсутствие механизма очистки** `allure-results/` перед запуском тестов
   - Старые результаты накапливаются и смешиваются с новыми
   - При частичном запуске тестов старые результаты удаляются, а новые не добавляются

## Решение проблемы

### Изменения

1. **Ограничение истории отчетов (30 отчетов максимум)**

   - Изменить `KEEP_HISTORY_LATEST=100` на `KEEP_HISTORY_LATEST=30` в `docker-compose.yml`
   - Это предотвратит накопление избыточного количества отчетов (сейчас 93 отчета)

2. **Автоматическая очистка результатов**

   - Добавить очистку `allure-results/` в `tests/conftest.py` в хуке `pytest_configure`
   - Сохранять только `history/` для трендов

### Результат

- Каждый запуск тестов начинается с чистой `allure-results/`
- Все 484 теста сохраняют результаты
- Allure отчет отображает все 484 теста
- История трендов сохраняется (последние 30 отчетов)
- Работает из коробки, без ручного вмешательства

## План проверки и исправления

### Шаг 0: Ограничить историю отчетов

**Файл:** `docker-compose.yml`

Изменить:

```yaml
- KEEP_HISTORY_LATEST=100
```

На:

```yaml
- KEEP_HISTORY_LATEST=30
```

Перезапустить сервис:

```bash
docker compose restart allure-service
```

### Шаг 1: Добавить автоматическую очистку

**Файл:** `tests/conftest.py`

Добавить очистку в `pytest_configure`:

```python
def pytest_configure(config):
    """Настройка pytest перед запуском тестов"""
    allure_results_dir = project_root / "allure-results"
    allure_results_dir.mkdir(parents=True, exist_ok=True)
    
    # КРИТИЧЕСКИ ВАЖНО: Очистка старых результатов перед запуском
    # Сохраняем только history/ для трендов
    if allure_results_dir.exists():
        for item in allure_results_dir.iterdir():
            if item.name != "history" and item.name != ".gitkeep":
                if item.is_file():
                    item.unlink()
                elif item.is_dir() and item.name != "history":
                    shutil.rmtree(item)
    
    config.option.alluredir = str(allure_results_dir)
```

### Шаг 2: Запустить полный тест

```bash
docker compose exec autotest pytest -v
```

**Ожидаемый результат:**

- Все 484 теста должны запуститься
- В `allure-results/` должно быть 484 файла `*-result.json`

### Шаг 3: Проверить результаты в веб-интерфейсе

Открыть в браузере:

```
http://localhost:50005/allure-docker-service/projects/default/reports/latest/index.html
```

**Что проверить:**

1. Отображается ли "484 тестовых сценария" (а не 25)
2. Все ли разделы заполнены (Тест сюиты, Пакеты, Функциональность)
3. Работают ли графики и тренды
4. Отображается ли история (последние 30 отчетов)

### Шаг 4: Если проблема не решена - дополнительная диагностика

**Диагностика:**

1. **Проверить количество результатов:**
   ```powershell
   Get-ChildItem allure-results -Filter *-result.json | Measure-Object
   ```


Должно быть 484 файла.

2. **Проверить логи pytest:**
   ```bash
   docker compose logs autotest | Select-String "passed|failed"
   ```

3. **Проверить логи Allure Service:**
   ```bash
   docker compose logs allure-service | Select-String "BUILD_ORDER|results"
   ```

4. **Проверить содержимое контейнера:**
   ```bash
   docker compose exec autotest sh -c "ls -la /app/allure-results/*-result.json | wc -l"
   docker compose exec allure-service sh -c "ls -la /app/allure-docker-api/static/projects/default/results/*-result.json | wc -l"
   ```


**Возможные проблемы и решения:**

- **Результаты не сохраняются:** Проверить права доступа к `allure-results/`
- **Allure Service не видит результаты:** Проверить volume mapping в `docker-compose.yml`
- **Отчет генерируется, но пустой:** Проверить, что результаты в правильном формате JSON
- **Часть тестов не запускается:** Проверить маркеры pytest и `pytest.ini`

**Дополнительные действия:**

- Пересобрать контейнер autotest: `docker compose build --no-cache autotest`
- Очистить старые отчеты вручную: удалить содержимое `allure-reports/default/reports/` (кроме последних 5)
- Проверить конфигурацию pytest: `docker compose exec autotest cat /app/tests/pytest.ini`

### Шаг 5: Обновить документацию

**Файлы для обновления:**

1. **`docs/guides/testing/allure-reporting.md`**

   - Добавить раздел о механизме очистки результатов
   - Обновить информацию о `KEEP_HISTORY_LATEST=30`
   - Добавить инструкции по диагностике проблем
   - Проверить актуальность путей к директориям
   - Проверить корректность команд запуска тестов

2. **`.cursor/rules/testing-rules.mdc`**

   - Обновить раздел о структуре `allure-results/`
   - Добавить информацию о автоматической очистке
   - Обновить примеры команд запуска тестов
   - Проверить актуальность описания механизма работы

**Что проверить в документации:**

- Пути к директориям актуальны
- Команды запуска тестов корректны
- Описание механизма очистки понятно
- Инструкции по диагностике полные
- Нет устаревшей информации о структуре каталогов

## Критерии успеха

✅ **Проблема решена, если:**

1. После запуска `docker compose exec autotest pytest -v` в `allure-results/` создается 484 файла `*-result.json`
2. В веб-интерфейсе Allure отображается "484 тестовых сценария"
3. Все разделы отчета заполнены корректно (Тест сюиты, Пакеты, Функциональность)
4. История отчетов ограничена 30 последними отчетами
5. При повторном запуске тестов старые результаты очищаются автоматически
6. Документация обновлена и соответствует текущей структуре

## Почему это решение правильное

### Best Practices

1. **Официальная документация Allure:**

   - Рекомендует очищать `allure-results/` перед каждым запуском
   - Сохранять только `history/` для трендов
   - Это предотвращает смешивание старых и новых результатов

2. **Стандартный подход:**

   - Большинство CI/CD систем очищают результаты перед запуском
   - Это гарантирует, что отчет содержит только актуальные данные
   - Предотвращает накопление старых результатов

3. **Надежность:**

   - Автоматическая очистка в `pytest_configure` гарантирует выполнение
   - Не требует ручного вмешательства
   - Работает из коробки для всех запусков

### To-dos

- [ ] Добавить автоматическую очистку allure-results в conftest.py
- [ ] Обновить документацию с объяснением механизма очистки
- [ ] Запустить тесты и проверить, что все 484 результата отображаются