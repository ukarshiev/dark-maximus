<!-- 73885ac2-a6e2-4ab8-9cea-5aec148b3bfa d0c94539-6ee5-496d-beda-84d2d7cdfa3e -->
# План исправления падающих тестов

## 1. Тесты авторизации (allure-homepage и docs-proxy)

**Проблема:** Тесты `test_login_success` и `test_login_required_decorator` падают, вероятно из-за неправильного мокирования или работы сессий.

**Причина:**

- В тестах мокируется `verify_admin_credentials` через `patch('shop_bot.data_manager.database.verify_admin_credentials', return_value=True)`
- Функция `verify_and_login` из `auth_utils` импортирует `verify_admin_credentials` внутри функции, что может вызывать проблемы с мокированием
- Сессии могут не сохраняться правильно в тестовом окружении

**Решение:**

- Убедиться, что мок применяется до импорта `verify_and_login`
- Проверить настройку сессий в тестовом окружении
- Возможно нужно мокировать `verify_and_login` напрямую в модуле приложения

**Файлы:**

- `tests/unit/test_allure_homepage/test_auth.py`
- `tests/unit/test_docs_proxy/test_auth.py`
- `src/shop_bot/webhook_server/auth_utils.py`

## 2. Тест subscription_link fallback

**Проблема:** Тест `test_get_key_by_id_fallback_generation` падает из-за проблем с async вызовами.

**Причина:**

- Функция `get_key_by_id` использует `asyncio.get_event_loop()` и `loop.run_until_complete()` для вызова async функции
- В тестах используется `AsyncMock`, но `run_until_complete()` может не работать правильно с моками
- Может быть проблема с event loop в тестовом окружении

**Решение:**

- Изменить тест, чтобы правильно обрабатывать async вызовы
- Возможно использовать `pytest.mark.asyncio` или мокировать `asyncio.get_event_loop`
- Альтернативно: изменить подход к мокированию в самой функции `get_key_by_id`

**Файлы:**

- `tests/unit/test_database/test_subscription_link_fallback.py`
- `src/shop_bot/data_manager/database.py` (функция `get_key_by_id`)

## 3. Тесты hardcoded domains

**Проблема:** Тесты `test_no_hardcoded_domains_in_python_code` и `test_no_hardcoded_subdomains_in_python_code` падают, если в коде есть жестко прописанные домены.

**Решение:**

- Проверить код на наличие жестко прописанных доменов
- Убедиться, что все домены берутся из настроек через `get_server_environment()` и соответствующие функции получения доменов
- Если домены найдены в fallback значениях (комментарии), убедиться, что тесты правильно их пропускают

**Файлы:**

- `tests/unit/test_security/test_hardcoded_domains.py`
- Весь код в `src/` (нужно найти и исправить жестко прописанные домены)

## 4. Тесты docker-compose и скриптов

**Проблема:** Множество тестов валидации docker-compose.yml и скриптов установки падают.

**Возможные причины:**

- Изменения в структуре docker-compose.yml
- Изменения в скриптах установки
- Несоответствие портов или сервисов

**Решение:**

- Проверить структуру `docker-compose.yml`
- Проверить скрипты `install.sh` и `install-autotest.sh`
- Обновить тесты в соответствии с актуальной структурой

**Файлы:**

- `tests/scripts/test_docker_compose.py`
- `tests/scripts/test_autotest_validation.py`
- `tests/scripts/test_install_validation.py`
- `docker-compose.yml`
- `install.sh`
- `install-autotest.sh`

## 5. Учет настройки "Тип сервера"

**Важно:** Все исправления должны учитывать настройку "Тип сервера" (`server_environment`) и работать корректно как на production, так и на development.

**Функции для проверки:**

- `get_server_environment()` - возвращает "production" или "development"
- `is_production_server()` - проверяет production
- `is_development_server()` - проверяет development
- Функции получения доменов (используют `server_environment` для выбора доменов)

**Проверить:**

- Тесты должны работать независимо от типа сервера
- Если тесты специфичны для окружения, использовать фикстуру для проверки `ENVIRONMENT`

**Файлы:**

- `src/shop_bot/data_manager/database.py` (функции работы с `server_environment`)

## Порядок выполнения

1. Изучить отчет Allure для понимания конкретных ошибок
2. Исправить тесты авторизации (приоритет 1 - критично для безопасности)
3. Исправить тест subscription_link fallback (приоритет 2 - важная функциональность)
4. Проверить и исправить hardcoded domains (приоритет 3 - безопасность)
5. Исправить тесты валидации скриптов (приоритет 4 - инфраструктура)
6. Запустить все тесты и проверить отчет в Allure

### To-dos

- [ ] Изучить отчет Allure для понимания конкретных ошибок каждого теста
- [ ] Исправить тесты авторизации allure-homepage (test_login_success, test_login_required_decorator) - проверить мокирование verify_admin_credentials и работу сессий
- [ ] Исправить тесты авторизации docs-proxy (test_login_success, test_login_required_decorator) - проверить мокирование verify_admin_credentials и работу сессий
- [ ] Исправить тест subscription_link fallback (test_get_key_by_id_fallback_generation) - проверить работу с async вызовами и AsyncMock
- [ ] Проверить и исправить жестко прописанные домены в коде (test_no_hardcoded_domains_in_python_code, test_no_hardcoded_subdomains_in_python_code)
- [ ] Исправить тесты валидации docker-compose.yml (test_ports_correctness, test_networks_section_exists, test_required_services_exist, test_no_duplicate_services, test_docker_compose_syntax)
- [ ] Исправить тесты валидации install-autotest.sh (test_autotest_script_exists, test_add_services_function, test_idempotency_check, test_allure_homepage_port_check, test_services_structure)
- [ ] Исправить тесты валидации install.sh (test_port_consistency, test_docs_proxy_in_script)
- [ ] Убедиться, что все исправления учитывают настройку "Тип сервера" (server_environment)
- [ ] Запустить все тесты и проверить результаты в Allure отчете