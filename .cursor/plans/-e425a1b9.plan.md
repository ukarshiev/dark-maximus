<!-- e425a1b9-f84d-4d8f-ab9c-f14caab0001b 49a32c94-8105-4edb-947f-f5bbc4533d3c -->
# Исправление пропущенных тестов на продакшне

## Проблемы

1. **test_production_db_schema_matches_reference** - пропускается, если `ENVIRONMENT != "production"` в `.env`
2. **Тесты авторизации** - пропускаются, если сервисы недоступны из-за неправильного определения хостов

## Анализ причин

### Проблема 1: ENVIRONMENT не установлен в production

- Функция `is_production_environment()` в `tests/integration/test_database_schema_integrity.py` проверяет `os.getenv("ENVIRONMENT")`
- Если переменная не установлена или не равна "production", тест пропускается
- Нужно проверить `.env` файл на продакшне и убедиться, что `ENVIRONMENT=production` установлен

### Проблема 2: Неправильное определение хостов для сервисов

- Функция `_get_service_host()` в `tests/integration/test_auth_all_services/conftest.py` определяет хост на основе `_is_docker_environment()`
- На продакшне тесты запускаются в Docker контейнере `autotest`, но функция может неправильно определять окружение
- Если окружение определено как Docker, используются имена сервисов (docs-proxy, allure-homepage, bot)
- Если окружение определено как хост, используется localhost
- Проблема: на продакшне сервисы доступны через localhost:50000, localhost:50001, localhost:50005, но тесты могут пытаться подключиться к именам сервисов

## План исправления

### Шаг 1: Улучшение определения окружения для тестов авторизации

- Файл: `tests/integration/test_auth_all_services/conftest.py`
- Улучшить функцию `_is_docker_environment()` для более надежного определения
- Добавить проверку переменной окружения `ENVIRONMENT` для определения продакшн окружения
- Если `ENVIRONMENT=production`, использовать localhost вместо имен Docker сервисов (так как на продакшне сервисы доступны через localhost)

### Шаг 2: Улучшение диагностики пропуска тестов

- Добавить логирование в `check_service_available()` для диагностики недоступных сервисов
- Добавить информацию в Allure отчет о причине пропуска теста
- Улучшить сообщения об ошибках при недоступности сервисов

### Шаг 3: Проверка и исправление определения хостов

- Файл: `tests/integration/test_auth_all_services/conftest.py`
- Изменить логику `_get_service_host()`:
- Если `ENVIRONMENT=production`, всегда использовать localhost (независимо от Docker окружения)
- Если `ENVIRONMENT != production` и тесты в Docker, использовать имена сервисов
- Если `ENVIRONMENT != production` и тесты на хосте, использовать localhost

### Шаг 4: Проверка переменной ENVIRONMENT для теста схемы БД

- Файл: `tests/integration/test_database_schema_integrity.py`
- Улучшить функцию `is_production_environment()` для более надежной проверки
- Добавить логирование для диагностики
- Добавить информацию в Allure отчет о значении ENVIRONMENT

### Шаг 5: Тестирование исправлений

- Запустить тесты на продакшне
- Проверить отчет в Allure
- Убедиться, что тесты не пропускаются без причины

## Файлы для изменения

1. `tests/integration/test_auth_all_services/conftest.py` - исправление определения хостов
2. `tests/integration/test_database_schema_integrity.py` - улучшение проверки ENVIRONMENT
3. Возможно, нужно проверить `.env` файл на продакшне (но это вне кода)

## Ожидаемый результат

- Тесты не пропускаются без причины
- Правильное определение хостов для сервисов на продакшне
- Улучшенная диагностика проблем с доступностью сервисов
- Тест схемы БД запускается на продакшне при `ENVIRONMENT=production`

### To-dos

- [ ] Исправить определение хостов для сервисов в conftest.py: использовать localhost на продакшне независимо от Docker окружения
- [ ] Улучшить определение окружения: добавить проверку ENVIRONMENT=production для использования localhost
- [ ] Улучшить диагностику пропуска тестов: добавить логирование и информацию в Allure отчет
- [ ] Улучшить проверку ENVIRONMENT в тесте схемы БД: добавить логирование и диагностику
- [ ] Запустить тесты на продакшне и проверить отчет в Allure