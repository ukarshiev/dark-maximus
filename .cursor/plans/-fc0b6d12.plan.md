<!-- fc0b6d12-1576-477f-8404-890ed1f20b67 6586a742-c76d-4eac-8838-bfa08adf91ff -->
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è –∫–ª—é—á–µ–π

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:

1. "–í–∞—à –∫–ª—é—á #1 –≥–æ—Ç–æ–≤!" —Å –ø–æ–ª–Ω—ã–º –∫–ª—é—á–æ–º –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–∏)
2. "–ü—Ä–æ–∏–∑–æ—à–ª–æ —Å–ø–∏—Å–∞–Ω–∏–µ..." (–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò–∑–º–µ–Ω–∏—Ç—å `process_successful_payment` –≤ `src/shop_bot/bot/handlers.py`

- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `payment_method == 'Auto-Renewal'`
- –ï—Å–ª–∏ —ç—Ç–æ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–í–∞—à –∫–ª—é—á –≥–æ—Ç–æ–≤"
- –£–¥–∞–ª–∏—Ç—å `processing_message` –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–ø–∏—Å–∞–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç `send_balance_deduction_notice`)

### 2. –ò–∑–º–µ–Ω–∏—Ç—å `send_balance_deduction_notice` –≤ `src/shop_bot/data_manager/scheduler.py`

- –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–ª—é—á—É" —Å callback_data `f"show_key_{key_id}"`
- –û—Å—Ç–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `InlineKeyboardBuilder` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

- `src/shop_bot/bot/handlers.py` - —Ñ—É–Ω–∫—Ü–∏—è `process_successful_payment` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 6417)
- `src/shop_bot/data_manager/scheduler.py` - —Ñ—É–Ω–∫—Ü–∏—è `send_balance_deduction_notice` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 448)

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –í `process_successful_payment`:

**–í–ê–ñ–ù–û:** –ü—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ü–û–°–õ–ï –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:

- –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Å—Ç—Ä–æ–∫–∞ 6590)
- –ü–æ—Å–ª–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (—Å—Ç—Ä–æ–∫–∞ 6623)
- –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 6635)
- –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è processing_message (—Å—Ç—Ä–æ–∫–∞ 6637)
- –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–≤–æ—Ç—ã (—Å—Ç—Ä–æ–∫–∞ 6694)
- –ü–æ—Å–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ (—Å—Ç—Ä–æ–∫–∞ 6697)

**–ù–û –ü–ï–†–ï–î** –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏—è "–í–∞—à –∫–ª—é—á –≥–æ—Ç–æ–≤" (—Å—Ç—Ä–æ–∫–∞ 6669).

–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 6697 (–ø–æ—Å–ª–µ `await notify_admin_of_purchase`):

```python
# –ï—Å–ª–∏ —ç—Ç–æ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–í–∞—à –∫–ª—é—á –≥–æ—Ç–æ–≤"
# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–ø–∏—Å–∞–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç send_balance_deduction_notice –≤ perform_auto_renewals
if payment_method == 'Auto-Renewal':
    return
```

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è, –Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ "–í–∞—à –∫–ª—é—á –≥–æ—Ç–æ–≤" –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è.

### –í `send_balance_deduction_notice`:

–ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫—É 470 (`reply_markup=keyboards.create_back_to_menu_keyboard()`) –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏:

```python
from aiogram.utils.keyboard import InlineKeyboardBuilder

builder = InlineKeyboardBuilder()
builder.button(text="üîë –ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–ª—é—á—É", callback_data=f"show_key_{key_id}")
builder.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_main_menu")
builder.adjust(1)  # –ü–æ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–µ –≤ —Ä—è–¥

await bot.send_message(
    chat_id=user_id,
    text=message,
    reply_markup=builder.as_markup()
)
```

## –ú–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ `payment_method == 'Auto-Renewal'` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
2. –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π (–Ω–µ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ) –ª–æ–≥–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è
3. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –≤ keyboards.py
4. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π callback_data —Ñ–æ—Ä–º–∞—Ç `show_key_{key_id}`, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ handlers.py