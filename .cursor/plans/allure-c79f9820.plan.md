<!-- c79f9820-3564-410d-b15b-69a1baedca6b ed49308f-db7c-4451-9aa3-352ab871f712 -->
# Исправление редиректа Allure отчетов

## Проблемы

1. При обращении к `http://localhost:50005/allure-docker-service/projects/default/reports/latest/index.html` пользователь получает HTML-страницу "Redirecting..." с редиректом на `/projects/default` вместо конкретного отчета.
2. На главной странице нет информации о статусе создания отчета (создан/генерируется) и дате создания.

## Решения

1. Улучшить обработку редиректов в `apps/allure-homepage/app.py` для автоматического определения последнего отчета через API при получении редиректа на `/projects/default`.
2. Добавить отображение статуса создания отчета на главной странице с датой и временем создания.

## Изменения

### 1. Улучшение обработки редиректа на `/projects/default`

**Файл:** `apps/allure-homepage/app.py`

**Местоположение:** функция `proxy()` (строки 338-427)

**Изменения:**

- При получении редиректа на `/projects/default` (или `/allure-docker-service/projects/default`) автоматически получать последний отчет через функцию `get_latest_report_id()` и делать редирект на конкретный отчет
- Добавить специальную обработку для пути `projects/default/reports/latest/index.html` - если получен редирект на `/projects/default`, получать последний отчет через API и делать редирект на него

### 2. Улучшение обработки HTML-страницы "Redirecting..."

**Файл:** `apps/allure-homepage/app.py`

**Местоположение:** блок обработки HTML-контента (строки 464-494)

**Изменения:**

- Расширить обработку HTML-страницы "Redirecting..." для случая, когда целевой URL - `/projects/default`
- В этом случае извлекать ID последнего отчета через API и делать редирект на конкретный отчет

### 3. Улучшение функции `extract_redirect_url_from_html`

**Файл:** `apps/allure-homepage/app.py`

**Местоположение:** функция `extract_redirect_url_from_html()` (строки 121-149)

**Изменения:**

- Добавить обработку случая, когда извлеченный URL - `/projects/default` или `/allure-docker-service/projects/default`
- В этом случае возвращать специальное значение (например, `None` с флагом), чтобы вызывающий код мог получить последний отчет через API

### 4. Расширение функции получения информации об отчете

**Файл:** `apps/allure-homepage/app.py`

**Местоположение:** после функции `get_latest_report_id()` (после строки 119)

**Изменения:**

- Добавить новую функцию `get_latest_report_info(project='default')` которая возвращает:
  - `report_id`: ID последнего отчета или `None`
  - `created_at`: Дата и время создания отчета (если доступна)
  - `status`: Статус отчета ('created', 'generating', 'no_reports')
- Функция должна получать информацию через API `/projects/{project}` и извлекать дату создания из структуры ответа или использовать дату модификации файлов отчета

### 5. Добавление API эндпоинта для статуса отчета

**Файл:** `apps/allure-homepage/app.py`

**Местоположение:** перед роутом `@app.route('/allure-docker-service/')` (перед строкой 185)

**Изменения:**

- Добавить роут `@app.route('/allure-docker-service/api/report-status')` с декоратором `@login_required`
- Эндпоинт должен возвращать JSON с информацией о статусе последнего отчета:
  ```json
  {
    "status": "created" | "generating" | "no_reports",
    "report_id": "123" | null,
    "created_at": "2025-11-20T12:00:00" | null
  }
  ```


### 6. Обновление главной страницы для отображения статуса

**Файл:** `apps/allure-homepage/templates/index.html`

**Изменения:**

- Добавить CSS стили для блока статуса отчета (`.report-status` с состояниями `.generating`, `.created`, `.no-reports`)
- Добавить HTML блок статуса внутри карточки "Последний отчет" (после `<span class="card-link">`)
- Добавить JavaScript функцию `loadReportStatus()` для загрузки статуса через API
- Функция должна:
  - Загружать статус при загрузке страницы
  - Отображать "✅ Создан" с датой и временем, если отчет создан
  - Отображать "⏳ Генерация отчета..." и автоматически обновляться каждые 3 секунды, если идет генерация
  - Отображать "ℹ️ Отчеты отсутствуют", если отчетов нет

### 7. Добавление функции получения информации о всех отчетах с датами

**Файл:** `apps/allure-homepage/app.py`

**Местоположение:** после функции `get_latest_report_info()`

**Изменения:**

- Добавить функцию `get_reports_with_dates(project='default')` которая возвращает список отчетов с информацией:
  - `report_id`: ID отчета
  - `created_at`: Дата и время создания отчета
  - `execution_name`: Название выполнения (если доступно)
- Функция должна получать информацию через API `/projects/{project}` и извлекать даты создания из структуры ответа или использовать дату модификации файлов отчетов
- Если дата недоступна через API, можно использовать дату модификации файлов из файловой системы (через volume-маппинг `allure-reports`)

### 8. Обновление страницы проектов для отображения дат отчетов

**Файл:** `apps/allure-homepage/templates/projects.html`

**Изменения:**

- Добавить CSS стили для отображения даты отчета (`.report-date` или `.report-meta`)
- Обновить JavaScript функцию `loadProjects()` для загрузки дат отчетов
- При отображении каждого отчета в списке добавлять:
  - Дата и время последнего изменения (формат: `DD.MM.YYYY HH:MM`)
  - Если дата недоступна, показывать ID отчета
- Разместить дату под названием отчета или справа от него (в зависимости от дизайна)

## Алгоритм обработки

1. При запросе к `/projects/default/reports/latest/index.html`:

- Если получен редирект на `/projects/default` → получаем последний отчет через API → делаем редирект на `/projects/default/reports/{latest_id}/index.html`
- Если получена HTML-страница "Redirecting..." с URL `/projects/default` → получаем последний отчет через API → делаем редирект на конкретный отчет
- Если получен JSON вместо HTML → получаем последний отчет через API → делаем редирект на конкретный отчет (уже реализовано)

2. При получении редиректа на `/projects/default`:

- Определяем, был ли исходный запрос к `/projects/default/reports/latest/index.html`
- Если да → получаем последний отчет через API → делаем редирект на конкретный отчет
- Если нет → возвращаем редирект как есть (для обычных запросов к `/projects/default`)

## Тестирование

После изменений протестировать:

1. Запрос к `/projects/default/reports/latest/index.html` должен автоматически перенаправлять на последний доступный отчет
2. Запрос к `/projects/default` должен работать как обычно (отображать список проектов)
3. Запрос к конкретному отчету `/projects/default/reports/{id}/index.html` должен работать как обычно