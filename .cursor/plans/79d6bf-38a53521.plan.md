<!-- 38a53521-77bc-4f3e-ac82-abcceec9256b 6a4e9478-4ca0-457e-9bc7-fa3ddb11ac2f -->
# Исправление теста автопродления

## Проблема

Тест `test_auto_renewal_process_success` не проходит из-за неполного мока функции `get_all_keys`. В моке отсутствуют поля, которые присутствуют в реальном результате функции.

## Анализ проблемы

### Реальная функция `get_all_keys()`

Функция выполняет `SELECT * FROM vpn_keys` и возвращает **ВСЕ поля** таблицы, включая:

- `key_id`, `user_id`, `host_name`, `xui_client_uuid`, `key_email`, `expiry_date`, `created_date`, `protocol`, `is_trial`, `subscription`, `subscription_link`, `telegram_chat_id`, `comment`, и другие

### Текущий мок в тесте

Мок возвращает только часть полей:

- `key_id`, `user_id`, `host_name`, `plan_name`, `expiry_date`, `price`

### Использование полей в коде

1. **`perform_auto_renewals`** НЕ использует `key_email` напрямую из результата `get_all_keys()`:

- Использует только: `key['expiry_date']`, `key['user_id']`, `key['key_id']`, `key.get('host_name')`, `key.get('plan_name')`
- Вызывает `process_successful_payment(bot, metadata)` с `key_id` в metadata

2. **`process_successful_payment`** получает `key_email` через отдельный вызов:

- Вызывает `get_key_by_id(key_id)` (строка 7293)
- Использует `email = key_data['key_email']` (строка 7297)
- `get_key_by_id` НЕ мокируется в тесте, работает с реальной БД

### Вывод

**Это проблема теста** - мок неполный и не соответствует реальному формату данных. Хотя отсутствие полей не вызывает ошибку напрямую (так как `key_email` получается через `get_key_by_id`), мок должен соответствовать реальному формату для:

- Корректности теста
- Защиты от будущих изменений в коде
- Соответствия принципам тестирования

## Решение

1. **Добавить недостающие поля в мок `get_all_keys`**:

- `key_email` - email ключа (значение: `f"user{user_id}-key1@testcode.bot"` из строки 128)
- `xui_client_uuid` - UUID клиента (значение: `"test-uuid-auto"` из строки 127)
- Другие поля по необходимости для соответствия реальному формату

2. **Проверить корректность данных**:

- Убедиться, что `key_email` соответствует email, созданному в тесте
- Убедиться, что формат `expiry_date` корректен (ISO строка)

3. **Запустить тест и проверить отчет Allure**:

- Убедиться, что тест проходит
- Проверить отчет Allure на наличие ошибок или предупреждений

## Файлы для изменения

- `tests/integration/test_auto_renewal/test_auto_renewal_process.py` - добавление полей в мок (строка 176-184)

## Шаги реализации

1. Найти место в тесте, где мокируется `get_all_keys` (строка 176)
2. Добавить поле `key_email` в мок (значение из строки 128: `f"user{user_id}-key1@testcode.bot"`)
3. Добавить поле `xui_client_uuid` в мок (значение из строки 127: `"test-uuid-auto"`)
4. Запустить тест: `docker compose exec monitoring pytest tests/integration/test_auto_renewal/test_auto_renewal_process.py::TestAutoRenewalProcess::test_auto_renewal_process_success -v`
5. Проверить отчет Allure на наличие ошибок или предупреждений
6. Убедиться, что тест проходит успешно