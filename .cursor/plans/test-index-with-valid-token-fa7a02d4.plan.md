<!-- fa7a02d4-b2c5-4e7a-99c6-bc6c6ac04425 4c0cdbd1-8789-4bcd-b379-e17d3f931520 -->
# Анализ и исправление теста testindexwithvalidtoken

## Проблема

Тест `unit.test_user_cabinet.test_cabinet.TestUserCabinet#test_index_with_valid_token` падает с ошибкой:

```
AssertionError: Должны быть данные ключа
assert (b'Test Plan' in response.data or b'key_data' in response.data)
```

Тест проверяет, что в HTML ответе присутствует строка `b'Test Plan'` или `b'key_data'`, но эти данные отсутствуют в рендеринге.

## Исследование

### Факты из кода:

1. **Тест (строки 205-218):**

   - Патчит `database.DB_FILE` для использования временной БД
   - Выполняет GET запрос к `/?token={test_user["token"]}`
   - Ожидает статус 200
   - Проверяет наличие `b'Test Plan'` или `b'key_data'` в HTML ответе

2. **Фикстура test_user (строки 147-190):**

   - Создает пользователя через `register_user_if_not_exists(123456789, "test_user", None, "Test User")`
   - Создает хост в БД через `INSERT INTO xui_hosts`
   - Создает ключ через `create_key_with_stats_atomic` с параметрами:
     - `plan_name="Test Plan"`
     - `price=100.0`
     - `months_purchased=1`
     - `amount_spent=100.0`
   - Создает токен через `get_or_create_permanent_token(user_id, key_id)`

3. **Роут index() в apps/user-cabinet/app.py (строки 249-314):**

   - Валидирует токен через `validate_permanent_token(token)`
   - Получает данные ключа через `get_key_by_id(key_id)` (строка 283)
   - Передает в шаблон:
     - `key_data=key_data` (строка 289)
     - `subscription_link=token_data.get('subscription_link')` (строка 291)
     - `knowledge_base_url=knowledge_base_url` (строка 292)
     - `knowledge_base_setup_url=knowledge_base_setup_url` (строка 293)

4. **Шаблон apps/user-cabinet/templates/index.html:**

   - НЕ использует переменную `key_data` - она передается в шаблон, но нигде не выводится
   - Использует только:
     - `knowledge_base_setup_url` (строка 93)
     - `session.subscription_link` (строка 143)

5. **Функция get_key_by_id (database.py строки 6622-6677):**

   - Возвращает словарь с данными ключа, включая `plan_name` из колонки `plan_name` таблицы `vpn_keys`
   - Но `plan_name` может быть None, если не был передан при создании

### Корень проблемы:

**Переменная `key_data` передается в шаблон, но не используется в HTML.** Тест ожидает, что данные ключа (например, "Test Plan") будут присутствовать в HTML ответе, но шаблон не отображает эти данные.

## План исправления

### Вариант 1: Исправить тест (рекомендуется)

Изменить проверку в тесте, чтобы она соответствовала реальному поведению приложения:

- Проверять наличие `knowledge_base_setup_url` в HTML (например, `b'localhost:3002/setup'` или `b'http://localhost:3002/setup'`)
- Проверять корректную структуру HTML (например, наличие заголовков шагов)
- Убрать проверку на `b'Test Plan'` и `b'key_data'`, так как эти данные не отображаются

### Вариант 2: Исправить шаблон

Если требуется отображать данные ключа в UI:

- Добавить отображение `key_data.plan_name` или других полей в шаблон
- Обновить тест для проверки нового отображения

### Вариант 3: Комбинированный подход

- Обновить тест для проверки того, что действительно рендерится
- Добавить комментарий/логирование о том, что `key_data` доступна для будущего использования

## Рекомендация

**Выбрать Вариант 1** - исправить тест, так как:

1. Шаблон не был спроектирован для отображения данных ключа напрямую
2. Текущий функционал работает корректно - показывает инструкции, подписку и проверку IP
3. Данные ключа доступны через API или могут быть добавлены в UI позже при необходимости

## Детали реализации

### Файлы для изменения:

- `tests/unit/test_user_cabinet/test_cabinet.py` (строки 205-218)

### Проверки, которые нужно добавить в тест:

1. Проверка статуса 200 (уже есть)
2. Проверка наличия шагов навигации (например, `b'Настройка VPN'` или `b'Настройка'`)
3. Проверка наличия iframe с инструкциями (например, `b'knowledge_base_setup_url'` или URL базы знаний)
4. Опционально: проверка наличия `subscription_link` в HTML, если он передан

### Альтернативные проверки:

- Проверка структуры HTML (наличие заголовков, навигации)
- Проверка корректного рендеринга шаблона (нет ошибок шаблона)
- Проверка передачи `key_data` в контекст шаблона через проверку сессии или других косвенных признаков

### To-dos

- [ ] Проанализировать тест test_index_with_valid_token: понять логику проверок и ожидаемое поведение
- [ ] Изучить шаблон index.html: какие переменные используются и какие данные отображаются
- [ ] Исследовать роут index() в app.py: какие данные передаются в шаблон и как
- [ ] Определить корневую причину падения: несоответствие между ожиданиями теста и реальным рендерингом
- [ ] Исправить тест: заменить проверку на b'Test Plan'/b'key_data' на проверку реально отображаемых элементов
- [ ] Запустить тест и убедиться, что он проходит с новыми проверками