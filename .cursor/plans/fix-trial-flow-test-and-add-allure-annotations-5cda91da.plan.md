<!-- 5cda91da-9eb7-4fc6-a5aa-e7b5a349ce49 0a148df7-1c34-4ea9-b880-68296904e151 -->
# План исправления теста test_user_can_reuse_trial_after_reset

## Проблема

Тест падает с ошибками:

- `no such column: telegram_id` - БД не инициализирована правильно
- `no such table: xui_hosts` - таблицы не созданы
- `no such column: trial_used` - колонки отсутствуют

Причина: фикстура `temp_db` в тесте неправильно использует базовую фикстуру из `conftest.py`.

## Шаги исправления

### 1. Исправить фикстуру temp_db в тесте

- Удалить переопределение фикстуры `temp_db` в классе `TestUserTrialFlow`
- Использовать фикстуру `temp_db` напрямую из `conftest.py` (она уже правильно настроена)

### 2. Добавить Allure аннотации к тесту

Согласно правилам из `testing-rules.mdc`:

- `@allure.epic("E2E тесты")` - уже есть на уровне класса
- `@allure.feature("Пользовательские сценарии")` - уже есть на уровне класса
- `@allure.title("Пользователь может повторно использовать триал после сброса")`
- `@allure.description` - подробное описание с разделами:
- Краткое описание
- Что проверяется
- Тестовые данные
- Предусловия
- Шаги теста
- Ожидаемый результат
- `@allure.severity(allure.severity_level.CRITICAL)` - критичный тест
- `@allure.tag("trial", "reset", "reuse", "e2e", "critical")` - теги для фильтрации
- `@allure.story("Повторное использование триала после сброса")` - для детализации

### 3. Добавить allure.step() для структурирования

Разбить тест на логические шаги:

- "Подготовка тестовых данных"
- "Симуляция первого использования триала"
- "Сброс триала для повторного использования"
- "Проверка состояния после сброса"
- "Создание триального ключа после сброса"
- "Проверка результата"

### 4. Добавить allure.attach() для важных данных

Прикреплять:

- Состояние триала до и после сброса
- Результаты вызовов функций
- Данные созданного ключа

### 5. Запустить тест и проверить результат

- Запустить тест через Docker: `docker compose exec monitoring pytest tests/e2e/test_user_scenarios/test_user_trial_flow.py::TestUserTrialFlow::test_user_can_reuse_trial_after_reset -v`
- Проверить отчет в Allure: `http://localhost:5050/allure-docker-service/projects/default/reports/latest/index.html`
- Убедиться, что тест проходит и все аннотации отображаются корректно

## Файлы для изменения

- `tests/e2e/test_user_scenarios/test_user_trial_flow.py` - исправить фикстуру и добавить Allure аннотации

### To-dos

- [ ] Удалить переопределение фикстуры temp_db в классе TestUserTrialFlow, использовать фикстуру из conftest.py
- [ ] Добавить Allure аннотации к тесту test_user_can_reuse_trial_after_reset: title, description, severity, tags, story
- [ ] Добавить allure.step() для структурирования теста на логические шаги
- [ ] Добавить allure.attach() для прикрепления важных данных (состояние триала, результаты функций, данные ключа)
- [ ] Запустить тест и проверить результат в Allure отчете