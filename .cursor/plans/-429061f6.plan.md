<!-- 429061f6-03a8-4423-ac8f-b659f732215d a3264394-b294-42c7-8463-1d81a0cc7337 -->
# План исправления падающего теста testtrialkeyextensionconvertstopaid

## Проблема

Тест `test_trial_key_extension_converts_to_paid` падает с ошибкой:

```
AssertionError: План должен быть создан
assert None is not None
```

Проблема в том, что функция `create_plan` не возвращает `plan_id`, хотя тест ожидает его.

## Анализ

1. **Функция `create_plan`** (src/shop_bot/data_manager/database.py:3162-3208):

   - Выполняет INSERT в таблицу `plans`
   - Делает commit
   - Логирует сообщение
   - **НЕ возвращает plan_id**

2. **Использование в других тестах**:

   - `test_balance_payment_full_flow` - использует `get_plans_for_host` после `create_plan` ✅
   - `test_cabinet_provision_mode_flow` - использует `get_plans_for_host` после `create_plan` ✅
   - `test_trial_key_extension_converts_to_paid` - ожидает, что `create_plan` вернет `plan_id` ❌
   - `test_user_key_extension.py` (E2E) - также ожидает, что `create_plan` вернет `plan_id` ❌

3. **Использование в коде**:

   - `webhook_server/app.py:2595` - не использует возвращаемое значение

## Решение

**Вариант 1 (рекомендуемый)**: Исправить функцию `create_plan`, чтобы она возвращала `plan_id` через `cursor.lastrowid`. Это:

- Соответствует ожиданиям в некоторых тестах
- Более эффективно, чем дополнительный запрос
- Стандартная практика для INSERT операций

**Вариант 2**: Исправить тесты, чтобы они использовали `get_plans_for_host` для получения `plan_id` (как в других тестах).

## Выбранное решение

Используем **Вариант 1** - исправляем функцию `create_plan`, чтобы она возвращала `plan_id`.

## Шаги реализации

1. **Исправить функцию `create_plan`**:

   - Добавить `return cursor.lastrowid` после `conn.commit()`
   - Убедиться, что функция возвращает `plan_id` даже при ошибках (через try-except)

2. **Проверить использование в коде**:

   - `webhook_server/app.py` - проверить, что изменение не сломает код (не используется возвращаемое значение)

3. **Запустить тесты**:

   - `test_trial_key_extension_converts_to_paid` - должен пройти
   - `test_user_key_extension` (E2E) - должен пройти
   - `test_balance_payment_full_flow` - должен продолжать работать
   - `test_cabinet_provision_mode_flow` - должен продолжать работать

4. **Проверить отчет Allure**:

   - Убедиться, что все тесты проходят
   - Проверить, что нет регрессий

## Файлы для изменения

1. `src/shop_bot/data_manager/database.py` - функция `create_plan` (строка ~3202)