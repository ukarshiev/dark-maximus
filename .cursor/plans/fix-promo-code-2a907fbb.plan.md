<!-- 2a907fbb-e196-46b1-809f-5cd75c0360fe 032df16b-80e8-4923-a562-9b39bbaa5541 -->
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ deeplink —Å—Å—ã–ª–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `https://t.me/maximus_vpn_bot?start=eyJnIjoiZnJpZW5kcyIsInAiOiJGSVZFSCJ9`) –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ:

```
‚úÖ –í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≥—Ä—É–ø–ø—É(—ã): friends
‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥: FIVEH
üí∞ –ù–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å –∑–∞—á–∏—Å–ª–µ–Ω–æ 500.0 —Ä—É–±.
```

–•–æ—Ç—è –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –±–∞–ª–∞–Ω—Å –ù–ï –±—ã–ª –∑–∞—á–∏—Å–ª–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ (—ç—Ç–æ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ), –Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ.

## –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è:

```
‚úÖ –í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≥—Ä—É–ø–ø—É(—ã): friends
‚ùå –í—ã —Ä–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥: FIVEH
```

## –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã

–í —Ñ–∞–π–ª–µ [`src/shop_bot/bot/handlers.py`](src/shop_bot/bot/handlers.py):

1. **–°—Ç—Ä–æ–∫–∞ 699**: –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ –ø—Ä–æ–º–æ–∫–æ–¥ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `applied_promos`, –¥–∞–∂–µ –µ—Å–ª–∏ `existing_usage_id` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Ç.–µ. –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –±—ã–ª –ø—Ä–∏–º–µ–Ω–µ–Ω —Ä–∞–Ω–µ–µ)
2. **–°—Ç—Ä–æ–∫–∏ 815-822 –∏ 6744-6750**: –ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –≤ `deeplink_promos`, –Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—ã–ª –ª–∏ –æ–Ω –ø—Ä–∏–º–µ–Ω–µ–Ω –≤–ø–µ—Ä–≤—ã–µ –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ

## –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 1: –†–∞–∑–¥–µ–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã –Ω–∞ –Ω–æ–≤—ã–µ –∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ (—Å—Ç—Ä–æ–∫–∏ 698-716)

–í–º–µ—Å—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –≤ `applied_promos`, –Ω—É–∂–Ω–æ:

- –ï—Å–ª–∏ `existing_usage_id` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –≤ `applied_promos` (–ø–µ—Ä–≤–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ)
- –ï—Å–ª–∏ `existing_usage_id` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –≤ `already_applied_promos` (–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ)
```python
if success:
    # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –†–∞–∑–¥–µ–ª—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥—ã –Ω–∞ –Ω–æ–≤—ã–µ –∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ
    if not existing_usage_id:
        # –ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω –≤–ø–µ—Ä–≤—ã–µ
        applied_promos.append(promo_code)
    else:
        # –ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –±—ã–ª –ø—Ä–∏–º–µ–Ω–µ–Ω —Ä–∞–Ω–µ–µ
        already_applied_promos.append(promo_code)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –≤ state –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    await state.update_data(
        promo_code=promo_code,
        promo_usage_id=validation_result.get('existing_usage_id'),
        promo_data=promo_data
    )
    
    # –ó–∞—á–∏—Å–ª—è–µ–º discount_bonus –¢–û–õ–¨–ö–û –µ—Å–ª–∏ existing_usage_id –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    bonus_amount = promo_data.get('discount_bonus', 0.0)
    if not existing_usage_id and bonus_amount > 0:
        add_to_user_balance(user_id, bonus_amount)
        logger.info(f"Applied bonus {bonus_amount} RUB to user {user_id} from promo '{promo_code}' (first time)")
    elif existing_usage_id and bonus_amount > 0:
        logger.info(f"Bonus NOT applied for user {user_id} from promo '{promo_code}' (already applied, existing_usage_id={existing_usage_id})")
    
    logger.info(f"Successfully processed promo code '{promo_code}' for user {user_id}: first_time={not existing_usage_id}")
```


### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 2: –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 824)

–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç —Å "‚ÑπÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –ø—Ä–∏–º–µ–Ω—ë–Ω" –Ω–∞ "‚ùå –í—ã —Ä–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥":

```python
if deeplink_already_applied_promos:
    message_parts.append(f"‚ùå –í—ã —Ä–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥: {', '.join(deeplink_already_applied_promos)}")
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 3: –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ (—Å—Ç—Ä–æ–∫–∞ 6752)

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞:

```python
if deeplink_already_applied_promos:
    message_parts.append(f"‚ùå –í—ã —Ä–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥: {', '.join(deeplink_already_applied_promos)}")
```

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

- [`src/shop_bot/bot/handlers.py`](src/shop_bot/bot/handlers.py):
  - –°—Ç—Ä–æ–∫–∏ 698-716: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–∞ –Ω–æ–≤—ã–µ –∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ
  - –°—Ç—Ä–æ–∫–∞ 824: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  - –°—Ç—Ä–æ–∫–∞ 6752: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**–ü–µ—Ä–≤—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ:**

```
‚úÖ –í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≥—Ä—É–ø–ø—É(—ã): friends
‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥: FIVEH
üí∞ –ù–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å –∑–∞—á–∏—Å–ª–µ–Ω–æ 500.0 —Ä—É–±.
```

**–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Ç–æ–π –∂–µ —Å—Å—ã–ª–∫–µ:**

```
‚úÖ –í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≥—Ä—É–ø–ø—É(—ã): friends
‚ùå –í—ã —Ä–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥: FIVEH
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
2. –í—Ä—É—á–Ω—É—é –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å deeplink —Å—Å—ã–ª–∫—É —Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–º (–ø–µ—Ä–≤—ã–π –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è: —Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–æ–º –∏ –±–µ–∑ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞