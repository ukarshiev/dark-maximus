<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–µ–∫—Ç—ã - Allure Docker Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #252525;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent: #008771;
            --accent-hover: #00a085;
            --border: #404040;
            --shadow: rgba(0, 0, 0, 0.3);
            --success: #4caf50;
            --error: #f44336;
        }

        html, body {
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: auto;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            box-sizing: border-box;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
            min-width: 700px;
        }

        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        header .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 2rem;
            color: var(--text-primary);
            margin: 0;
        }

        .accent {
            color: var(--accent);
        }

        .back-link {
            color: var(--accent);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--accent-hover);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: var(--bg-card);
            border: 1px solid var(--error);
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
            color: var(--error);
            text-align: center;
        }

        .projects-list {
            display: block;
            gap: 1.5rem;
            margin-top: 2rem;
            width: 100%;
            padding: 0;
        }

        .project-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 1.5rem;
        }

        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
            border-color: var(--accent);
        }

        .project-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .project-title {
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .project-icon {
            font-size: 1.8rem;
        }

        .reports-count {
            background: var(--bg-secondary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .reports-list {
            margin-top: 1rem;
        }

        .reports-list-title {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .report-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

        .report-item:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
        }

        .report-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .report-id {
            font-weight: 600;
            color: var(--accent);
        }

        .report-link {
            color: var(--accent);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid var(--accent);
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .report-link:hover {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .latest-badge {
            background: var(--success);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .report-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .report-meta {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 1.5rem 0;
            margin-top: 3rem;
            text-align: center;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .project-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .report-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div>
                <h1>üìÅ <span class="accent">–ü—Ä–æ–µ–∫—Ç—ã</span></h1>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –∏—Ö –æ—Ç—á–µ—Ç–æ–≤</p>
            </div>
            <a href="/allure-docker-service/" class="back-link">
                ‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é
            </a>
        </div>
    </header>

    <div class="container">
        <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="projects" class="projects-list" style="display: none;"></div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Dark Maximus. Allure Docker Service</p>
        </div>
    </footer>

    <script>
        async function loadProjects() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const projectsEl = document.getElementById('projects');

            try {
                const response = await fetch('/allure-docker-service/projects', {
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                loadingEl.style.display = 'none';

                // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: {"data": {"projects": {"default": {...}, ...}}}
                if (!data || !data.data || !data.data.projects) {
                    projectsEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <h2>–ü—Ä–æ–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h2>
                            <p>–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –æ—Ç—á–µ—Ç–∞–º–∏.</p>
                        </div>
                    `;
                    projectsEl.style.display = 'block';
                    return;
                }

                const projectsObj = data.data.projects;
                const projectIds = Object.keys(projectsObj);

                if (projectIds.length === 0) {
                    projectsEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <h2>–ü—Ä–æ–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h2>
                            <p>–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –æ—Ç—á–µ—Ç–∞–º–∏.</p>
                        </div>
                    `;
                    projectsEl.style.display = 'block';
                    return;
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
                const projectPromises = projectIds.map(async (projectId) => {
                    try {
                        const projectResponse = await fetch(`/allure-docker-service/projects/${projectId}`, {
                            headers: { 'Accept': 'application/json' }
                        });
                        if (projectResponse.ok) {
                            const projectData = await projectResponse.json();
                            return { id: projectId, data: projectData };
                        }
                    } catch (e) {
                        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ ${projectId}:`, e);
                    }
                    return { id: projectId, data: null };
                });

                const projectsWithData = await Promise.all(projectPromises);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞—Ç–∞—Ö –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
                const projectsWithDates = await Promise.all(
                    projectsWithData.map(async ({ id, data: projectData }) => {
                        let reports = [];
                        if (projectData && projectData.data && projectData.data.project) {
                            const project = projectData.data.project;
                            reports = project.reports_id || project.reports || [];
                        }

                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞—Ç—ã –æ—Ç—á–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ API
                        let reportsWithDates = [];
                        if (reports.length > 0) {
                            try {
                                const datesResponse = await fetch(`/allure-docker-service/api/reports-with-dates?project=${id}`, {
                                    headers: { 'Accept': 'application/json' }
                                });
                                if (datesResponse.ok) {
                                    const datesData = await datesResponse.json();
                                    // –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å report_id -> created_at
                                    const datesMap = {};
                                    if (datesData.reports && Array.isArray(datesData.reports)) {
                                        datesData.reports.forEach(report => {
                                            if (report.report_id) {
                                                datesMap[report.report_id] = report.created_at;
                                            }
                                        });
                                    }
                                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç—á–µ—Ç–æ–≤ —Å –¥–∞—Ç–∞–º–∏
                                    reportsWithDates = reports.map(reportId => ({
                                        id: reportId,
                                        created_at: datesMap[reportId] || null
                                    }));
                                } else {
                                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—ã, —Å–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –±–µ–∑ –¥–∞—Ç
                                    reportsWithDates = reports.map(reportId => ({
                                        id: reportId,
                                        created_at: null
                                    }));
                                }
                            } catch (e) {
                                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ ${id}:`, e);
                                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, —Å–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –±–µ–∑ –¥–∞—Ç
                                reportsWithDates = reports.map(reportId => ({
                                    id: reportId,
                                    created_at: null
                                }));
                            }
                        }

                        return { id, data: projectData, reportsWithDates };
                    })
                );

                projectsEl.innerHTML = projectsWithDates.map(({ id, data: projectData, reportsWithDates }) => {
                    const reportsList = reportsWithDates.length > 0 
                        ? reportsWithDates.map((report, index) => {
                            const isLatest = index === 0;
                            const reportId = report.id;
                            const created_at = report.created_at;
                            
                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
                            let dateHtml = '';
                            if (created_at) {
                                try {
                                    const date = new Date(created_at);
                                    const formattedDate = date.toLocaleString('ru-RU', {
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                    dateHtml = `<div class="report-date">${formattedDate}</div>`;
                                } catch (e) {
                                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É
                                    dateHtml = `<div class="report-date">${created_at}</div>`;
                                }
                            }
                            
                            return `
                                <div class="report-item">
                                    <div class="report-info">
                                        <div class="report-meta">
                                            <div>
                                                <span class="report-id">–û—Ç—á–µ—Ç #${reportId}</span>
                                                ${isLatest ? '<span class="latest-badge">–ü–æ—Å–ª–µ–¥–Ω–∏–π</span>' : ''}
                                            </div>
                                            ${dateHtml}
                                        </div>
                                    </div>
                                    <a href="/allure-docker-service/projects/${id}/reports/${reportId}/index.html" 
                                       class="report-link">
                                        –û—Ç–∫—Ä—ã—Ç—å ‚Üí
                                    </a>
                                </div>
                            `;
                        }).join('')
                        : '<div class="empty-state" style="padding: 1rem;"><p>–û—Ç—á–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
                    
                    return `
                        <div class="project-card">
                            <div class="project-header">
                                <h2 class="project-title">
                                    <span class="project-icon">üì¶</span>
                                    ${id}
                                </h2>
                                <span class="reports-count">${reportsWithDates.length} ${reportsWithDates.length === 1 ? '–æ—Ç—á–µ—Ç' : reportsWithDates.length < 5 ? '–æ—Ç—á–µ—Ç–∞' : '–æ—Ç—á–µ—Ç–æ–≤'}</span>
                            </div>
                            ${reportsWithDates.length > 0 ? `
                                <div class="reports-list">
                                    <div class="reports-list-title">–ò—Å—Ç–æ—Ä–∏—è –æ—Ç—á–µ—Ç–æ–≤:</div>
                                    ${reportsList}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                projectsEl.style.display = 'block';
            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.textContent = `–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–µ–∫—Ç–æ–≤: ${error.message}`;
                errorEl.style.display = 'block';
                console.error('Error loading projects:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', loadProjects);
    </script>
</body>
</html>

