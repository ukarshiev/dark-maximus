{% extends "base.html" %} {% block title %}–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è{% endblock %} {% block content %}

<div class="transactions-container">
    <div class="transactions-header">
        <h1 style="text-align: center;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h1>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 10px; width: 100%;">
            <div>
                <button class="button button-primary" onclick="openCreateNotificationModal()">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
            </div>
            <div>
                <button class="button button-primary" onclick="refreshNotificationsPage()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <section class="transactions-section">
        <div class="transactions-table">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–¢–∏–ø</th>
                        <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–î–µ—Ç–∞–ª–∏</th>
                        <th class="actions-cell">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for n in notifications %}
                    <tr>
                        <td>{{ n.notification_id }}</td>
                        <td>
                            <div class="user-info">
                                <div class="cell-inline">
                                    <div class="cell-left">
                                        <strong>ID:</strong>
                                        <span>{{ hidden_mode and '***' or n.user_id }}</span>
                                    </div>
                                    <div class="cell-actions">
                                        <button class="modal-action-btn" onclick="openUserModal({{ n.user_id }}, '{{ n.username or 'N/A' }}', false, 0)" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É">üîç</button>
                                    </div>
                                </div>
                                <div><strong>Username:</strong> {{ hidden_mode and '***' or (n.username or 'N/A') }}</div>
                            </div>
                        </td>
                        <td>{{ n.type or '-' }}</td>
                        <td>{{ n.title or '-' }}</td>
                        <td>
                            {% if n.status == 'sent' %}
                                <span class="status-badge status-paid">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
                            {% elif n.status == 'resent' %}
                                <span class="status-badge status-paid">–ü–æ–≤—Ç–æ—Ä</span>
                            {% elif n.status == 'failed' %}
                                <span class="status-badge status-pending">–ù–µ —É–¥–∞–ª–æ—Å—å</span>
                            {% else %}
                                <span class="status-badge">{{ n.status or '-' }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if n.created_date %}
                                {{ n.created_date.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% set m = n.meta or {} %}
                            {% if m and (m.key_id or m.expiry_at or m.time_left_hours) %}
                                –ö–ª—é—á: {{ m.key_id or '' }}{% if m.expiry_at %}, –∏—Å—Ç–µ–∫–∞–µ—Ç: {{ m.expiry_at }}{% endif %}{% if m.time_left_hours %}, —á: {{ m.time_left_hours }}{% endif %}
                            {% endif %}
                        </td>
                        <td class="actions-cell">
                            <button class="button button-small" onclick="resendNotification({{ n.notification_id }})" title="–ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å">üîÑ</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <div class="pagination-panel">
        <div class="pagination-controls">
            {% if total_pages > 1 %}
            <div class="pagination">
                {% if current_page > 1 %}
                    <a href="{{ url_for('notifications_page', page=current_page-1, per_page=per_page) }}" class="pagination-link">¬´</a>
                {% endif %}
                {% for p in range(1, total_pages + 1) %}
                    {% if p == current_page %}
                        <span class="pagination-link active">{{ p }}</span>
                    {% else %}
                        <a href="{{ url_for('notifications_page', page=p, per_page=per_page) }}" class="pagination-link">{{ p }}</a>
                    {% endif %}
                {% endfor %}
                {% if current_page < total_pages %}
                    <a href="{{ url_for('notifications_page', page=current_page+1, per_page=per_page) }}" class="pagination-link">¬ª</a>
                {% endif %}
            </div>
            {% endif %}
            <div class="per-page-selector">
                <select id="perPageSelect" onchange="changePerPage(this.value)">
                    <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="createNotificationModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-header-content">
                <h3>–°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h3>
            </div>
            <span class="close" onclick="closeCreateNotificationModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="notifUserSearch">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                <input type="text" id="notifUserSearch" placeholder="ID –∏–ª–∏ username" oninput="debouncedSearchUsers(this.value)" />
                <input type="hidden" id="notifSelectedUserId" />
                <div id="notifSelectedUserLabel" style="margin-top: 6px; color: #adb5bd;"></div>
                <div id="notifUserSuggestions" class="suggestions" style="margin-top: 6px;"></div>
            </div>
            <div class="form-group">
                <label for="notifTypeSelect">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</label>
                <select id="notifTypeSelect">
                    <option value="72">–æ–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ 3 –¥–Ω—è</option>
                    <option value="48">–æ–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ 2 –¥–Ω—è</option>
                    <option value="24">–æ–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ 1 –¥–µ–Ω—å</option>
                    <option value="1">–æ–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ 1 —á–∞—Å</option>
                </select>
            </div>
        </div>
        <div class="modal-footer" style="justify-content: space-between;">
            <button class="button button-stop" onclick="closeCreateNotificationModal()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            <button class="button button-start" onclick="submitCreateNotification()">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
        </div>
    </div>
    
</div>

<script>
function changePerPage(value) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', value);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

function refreshNotificationsPage() {
    window.location.reload();
}
</script>

{% endblock %}

