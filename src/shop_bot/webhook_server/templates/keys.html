{% extends "base.html" %}
{% block title %}–ö–ª—é—á–∏{% endblock %}
{% block header_title %}–ö–ª—é—á–∏{% endblock %}
{% block content %}

<div class="keys-container">
	<div class="keys-header">
	</div>

	<section class="keys-section">
		<div class="table-container" style="padding-bottom: 80px;">
			<table class="keys-table">
				<thead>
					<tr>
						<th>ID</th>
						<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
						<th>–•–æ—Å—Ç</th>
						<th>–ü–ª–∞–Ω</th>
						<th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
						<th>–¢–∏–ø</th>
						<th>–¢—Ä–∏–∞–ª</th>
						<th>–ù–∞—á–∞–ª–æ</th>
						<th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
						<th>–û—Å—Ç–∞–ª–æ—Å—å</th>
						<th title="–û–±—â–µ–µ&#10;–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ&#10;–û—Å—Ç–∞—Ç–æ–∫">–¢—Ä–∞—Ñ–∏–∫</th>
						<th>–°—Ç–∞—Ç—É—Å</th>
						<th>–ö–ª—é—á</th>
						<th>3x-ui</th>
					</tr>
				</thead>
				<tbody>
					{% for key in keys %}
					<tr class="key-row">
						<td>{{ key.key_id }}</td>
						<td>
							<div class="user-info">
								<div data-field="key_user_id" data-original="{{ key.user_id }}">
									<div class="cell-inline">
										<div class="cell-left">
											<strong>ID:</strong>
											<span>{{ hidden_mode and '***' or key.user_id }}</span>
										</div>
										<div class="cell-actions">
											<button class="modal-action-btn" data-size="xs" onclick="openUserModal({{ key.user_id }}, '{{ key.username or 'N/A' }}', false, {{ key.user_keys_count or 0 }})" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
												<i class="fas fa-eye"></i>
											</button>
										</div>
									</div>
								</div>
								<div data-field="key_username" data-original="{{ key.username or 'N/A' }}"><strong>Username:</strong> {{ hidden_mode and '***' or (key.username or 'N/A') }}</div>
							</div>
						</td>
						<td>{{ key.host_name }}</td>
						<td>{{ key.plan_name or 'N/A' }}</td>
						<td>{{ key.price or 'N/A' }} RUB</td>
						<td>{{ key.protocol or 'vless' }}</td>
						<td>{{ key.is_trial or 0 }}</td>
						<td>
							{% if key.created_date %}
								{{ key.created_date.strftime('%Y-%m-%d') }}<br/>{{ key.created_date.strftime('%H:%M:%S') }}
							{% else %}
								N/A
							{% endif %}
						</td>
						<td>
							{% if key.expiry_date %}
								{% if key.expiry_date.strftime is defined %}
									{{ key.expiry_date.strftime('%Y-%m-%d') }}<br/>{{ key.expiry_date.strftime('%H:%M:%S') }}
								{% else %}
									{{ key.expiry_date }}
								{% endif %}
							{% else %}
								N/A
							{% endif %}
						</td>
						<td>
							{% if key.remaining_seconds is not none %}
								{% set days = (key.remaining_seconds // 86400) %}
								{% set hours = ((key.remaining_seconds % 86400) // 3600) %}
								{% set cls = '' %}
								{% if key.remaining_seconds == 0 %}
									{% set cls = 'rem-red' %}
								{% elif key.remaining_seconds <= (1*86400 + 24*3600) %}
									{% set cls = 'rem-orange' %}
								{% elif key.remaining_seconds <= (3*86400 + 24*3600) %}
									{% set cls = 'rem-yellow' %}
								{% else %}
									{% set cls = 'rem-green' %}
								{% endif %}
								<span class="{{ cls }}">{{ days }} –¥ {{ hours }} —á</span>
							{% else %}
								N/A
							{% endif %}
						</td>
						<td>
							{% set quota = key.quota_total_gb %}
							{% set down_mb = (key.traffic_down_bytes or 0) / (1024*1024) %}
							{% set down_str = (down_mb >= 1024) and ((down_mb/1024)|round(2) ~ ' GB') or (down_mb|round(2) ~ ' MB') %}
							{% set unlimited_case = (quota is none) and ((key.traffic_down_bytes or 0) == 0) and (key.quota_remaining_bytes is none) %}
							{% if unlimited_case %}
								‚àû
							{% else %}
								{% if key.quota_remaining_bytes is not none %}
									{% set rem_mb = key.quota_remaining_bytes / (1024*1024) %}
									{% set rem_str = (rem_mb >= 1024) and ((rem_mb/1024)|round(2) ~ ' GB') or (rem_mb|round(2) ~ ' MB') %}
								{% else %}
									{% set rem_str = '‚àû' %}
								{% endif %}
								{{ (quota is not none) and ((quota|round(2)) ~ ' GB') or '‚àû' }}<br/>{{ down_str }}<br/>{{ rem_str }}
							{% endif %}
						</td>
						<td>{{ key.status or 'N/A' }}</td>
						<td>
							{% if key.connection_string %}
								<div class="key-cell">
									<span class="key-text" title="{{ key.connection_string }}">{{ key.connection_string[:50] }}{% if key.connection_string|length > 50 %}...{% endif %}</span>
									<button class="copy-btn" data-size="xs" onclick="copyKey({{ key.connection_string|tojson }})" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è">
										<i class="fas fa-copy"></i>
									</button>
								</div>
							{% else %}
								-
							{% endif %}
						</td>
						<td>
							{% if key.key_email %}
								<div class="key-cell">
									<span class="key-text" title="{{ key.key_email }}">{{ key.key_email }}</span>
									<button class="copy-btn" data-size="xs" onclick="copyKey({{ key.key_email|tojson }})" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å email –∫–ª—é—á–∞">
										<i class="fas fa-copy"></i>
									</button>
								</div>
							{% else %}
								-
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>

		<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
		<div class="pagination-panel">
			<div class="pagination-controls">
				<!-- –õ–µ–≤–∞—è –æ–±–ª–∞—Å—Ç—å: –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
				<div class="pagination-left">
					<button class="button button-primary button-small-refresh" data-size="sm" onclick="refreshKeys()" id="refreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–µ–π">
						<i class="fas fa-sync-alt" id="refreshIcon"></i>
						<span id="refreshText">–û–±–Ω–æ–≤–∏—Ç—å</span>
					</button>
				</div>
				
				<!-- –ü—Ä–∞–≤–∞—è –æ–±–ª–∞—Å—Ç—å: –ø–∞–≥–∏–Ω–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
				<div class="pagination-right">
					<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
					{% if total_pages > 1 %}
					<div class="pagination">
						<!-- –°—Ç—Ä–µ–ª–∫–∞ –Ω–∞–∑–∞–¥ -->
						{% if current_page > 1 %}
							<a href="{{ url_for('keys_page', page=current_page-1, per_page=per_page) }}" class="pagination-link" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">¬´</a>
						{% endif %}
						
						<!-- –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü: –º–∞–∫—Å–∏–º—É–º 6 –Ω–æ–º–µ—Ä–æ–≤ -->
						{% if total_pages <= 6 %}
							<!-- –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü 6 –∏–ª–∏ –º–µ–Ω—å—à–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ -->
							{% for p in range(1, total_pages + 1) %}
								{% if p == current_page %}
									<span class="pagination-link active" title="–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">{{ p }}</span>
								{% else %}
									<a href="{{ url_for('keys_page', page=p, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ p }}">{{ p }}</a>
								{% endif %}
							{% endfor %}
						{% else %}
							<!-- –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –±–æ–ª—å—à–µ 6, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 4, –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é -->
							{% if current_page <= 4 %}
								<!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 1, 2, 3, 4, ..., –ø–æ—Å–ª–µ–¥–Ω—è—è -->
								{% for p in range(1, 5) %}
									{% if p == current_page %}
										<span class="pagination-link active" title="–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">{{ p }}</span>
									{% else %}
										<a href="{{ url_for('keys_page', page=p, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ p }}">{{ p }}</a>
									{% endif %}
								{% endfor %}
								<span class="pagination-link">...</span>
								<a href="{{ url_for('keys_page', page=total_pages, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ total_pages }}">{{ total_pages }}</a>
							{% elif current_page >= total_pages - 3 %}
								<!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 1, ..., –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 -->
								<a href="{{ url_for('keys_page', page=1, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1">1</a>
								<span class="pagination-link">...</span>
								{% for p in range(total_pages - 3, total_pages + 1) %}
									{% if p == current_page %}
										<span class="pagination-link active" title="–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">{{ p }}</span>
									{% else %}
										<a href="{{ url_for('keys_page', page=p, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ p }}">{{ p }}</a>
									{% endif %}
								{% endfor %}
							{% else %}
								<!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 1, ..., —Ç–µ–∫—É—â–∞—è-1, —Ç–µ–∫—É—â–∞—è, —Ç–µ–∫—É—â–∞—è+1, ..., –ø–æ—Å–ª–µ–¥–Ω—è—è -->
								<a href="{{ url_for('keys_page', page=1, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1">1</a>
								<span class="pagination-link">...</span>
								{% for p in range(current_page - 1, current_page + 2) %}
									{% if p == current_page %}
										<span class="pagination-link active" title="–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">{{ p }}</span>
									{% else %}
										<a href="{{ url_for('keys_page', page=p, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ p }}">{{ p }}</a>
									{% endif %}
								{% endfor %}
								<span class="pagination-link">...</span>
								<a href="{{ url_for('keys_page', page=total_pages, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ total_pages }}">{{ total_pages }}</a>
							{% endif %}
						{% endif %}
						
						<!-- –°—Ç—Ä–µ–ª–∫–∞ –≤–ø–µ—Ä–µ–¥ -->
						{% if current_page < total_pages %}
							<a href="{{ url_for('keys_page', page=current_page+1, per_page=per_page) }}" class="pagination-link" title="–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">¬ª</a>
						{% endif %}
					</div>
					{% endif %}
					
					<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π -->
					<div class="per-page-selector">
						<select id="perPageSelect" onchange="changePerPage(this.value)" title="–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ">
							<option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
							<option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
							<option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
							<option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
							<option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
						</select>
					</div>
				</div>
			</div>
		</div>
	</section>
</div>

<script>
function changePerPage(value) {
	const url = new URL(window.location);
	url.searchParams.set('per_page', value);
	url.searchParams.set('page', '1');
	window.location.href = url.toString();
}

function refreshKeys() {
	const refreshBtn = document.getElementById('refreshBtn');
	const refreshIcon = document.getElementById('refreshIcon');
	const refreshText = document.getElementById('refreshText');
	
	refreshBtn.disabled = true;
	refreshIcon.classList.add('spinning');
	refreshText.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
	
	fetch('/refresh-keys', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		}
	})
	.then(response => response.json())
	.then(data => {
		if (data.status === 'success') {
			refreshText.textContent = data.message;
			
			// –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
			if (data.errors && data.errors.length > 0) {
				showSyncErrorsModal(data.errors);
				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
				setTimeout(() => {
					refreshBtn.disabled = false;
					refreshIcon.classList.remove('spinning');
					refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
				}, 1000);
			} else {
				// –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–∫ –æ–±—ã—á–Ω–æ
				setTimeout(() => {
					window.location.reload();
				}, 1000);
			}
		} else {
			refreshText.textContent = '–û—à–∏–±–∫–∞: ' + data.message;
			setTimeout(() => {
				refreshBtn.disabled = false;
				refreshIcon.classList.remove('spinning');
				refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
			}, 2000);
		}
	})
	.catch(error => {
		console.error('Error:', error);
		refreshText.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
		setTimeout(() => {
			refreshBtn.disabled = false;
			refreshIcon.classList.remove('spinning');
			refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
		}, 2000);
	});
}

function showSyncErrorsModal(errors) {
	// –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
	const modalHtml = `
		<div id="syncErrorsModal" class="modal" style="display: block;" onclick="closeSyncErrorsModal()">
			<div class="modal-content" onclick="event.stopPropagation();">
				<div class="modal-header">
					<h2>‚ö†Ô∏è –û—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å 3x-ui</h2>
					<span class="close" onclick="closeSyncErrorsModal()">&times;</span>
				</div>
				<div class="modal-body">
					<p>–ù–∞–π–¥–µ–Ω–æ ${errors.length} –∫–ª—é—á–µ–π —Å –æ—à–∏–±–∫–∞–º–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:</p>
					<div class="errors-list" style="max-height: 400px; overflow-y: auto; margin-top: 15px; background-color: #151f31; border-radius: 8px; padding: 10px;">
						${errors.map(error => `
							<div class="error-item" style="border: 1px solid #e74c3c; border-radius: 8px; padding: 12px; margin-bottom: 12px; background-color: #151f31; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
								<div style="font-weight: bold; color: #ecf0f1; margin-bottom: 8px; font-size: 16px;">
									${error.email}
								</div>
								<div style="font-size: 14px; color: #bdc3c7; line-height: 1.4;">
									<strong style="color: #3498db;">–°–æ–∑–¥–∞–Ω–æ:</strong> ${error.created_date}<br>
									<strong style="color: #3498db;">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</strong> ${error.expiry_date}
									${error.error ? `<br><strong style="color: #e74c3c;">–û—à–∏–±–∫–∞:</strong> <span style="color: #f39c12;">${error.error}</span>` : ''}
								</div>
							</div>
						`).join('')}
					</div>
				</div>
				<div class="modal-footer">
					<button onclick="deleteErrorKeys()" class="button button-danger" data-size="md" id="deleteBtn" title="–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á–∏ —Å –æ—à–∏–±–∫–∞–º–∏ –∏–∑ 3x-ui">
						<i class="fas fa-trash"></i>
						–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á–∏ —Å –æ—à–∏–±–∫–∞–º–∏ –≤ 3x-ui
					</button>
				</div>
			</div>
		</div>
	`;
	
	// –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ DOM
	document.body.insertAdjacentHTML('beforeend', modalHtml);
	
	// –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
	window.currentSyncErrors = errors;
}

function deleteErrorKeys() {
	const deleteBtn = document.getElementById('deleteBtn');
	const deleteResult = document.getElementById('deleteResult');
	
	if (!window.currentSyncErrors || window.currentSyncErrors.length === 0) {
		showDeleteResult('–ù–µ—Ç –∫–ª—é—á–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
		return;
	}
	
	// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —É–¥–∞–ª–µ–Ω–∏—è
	deleteBtn.disabled = true;
	deleteBtn.innerHTML = 'üîÑ –£–¥–∞–ª—è–µ–º...';
	
	// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
	const keysToDelete = window.currentSyncErrors.map(error => ({
		email: error.email,
		host_name: error.host_name,
		xui_client_uuid: error.xui_client_uuid
	}));
	
	fetch('/delete-error-keys', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		},
		body: JSON.stringify({ keys: keysToDelete })
	})
	.then(response => response.json())
	.then(data => {
		if (data.status === 'success') {
			let resultMessage = `‚úÖ ${data.message}`;
			
			if (data.failed_deletions && data.failed_deletions.length > 0) {
				resultMessage += `<br><br>‚ùå –û—à–∏–±–∫–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:`;
				data.failed_deletions.forEach(failed => {
					resultMessage += `<br>‚Ä¢ ${failed.email}: ${failed.error}`;
				});
			}
			
			showDeleteResult(resultMessage, 'success');
			
			// –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ (—É–±–∏—Ä–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ)
			if (data.deleted_count > 0) {
				window.currentSyncErrors = window.currentSyncErrors.filter(error => 
					!data.failed_deletions?.some(failed => failed.email === error.email)
				);
				
				// –ï—Å–ª–∏ –≤—Å–µ –∫–ª—é—á–∏ —É–¥–∞–ª–µ–Ω—ã, —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
				if (window.currentSyncErrors.length === 0) {
					deleteBtn.style.display = 'none';
				}
			}
		} else {
			showDeleteResult(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`, 'error');
		}
	})
	.catch(error => {
		console.error('Error:', error);
		showDeleteResult('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–π', 'error');
	})
	.finally(() => {
		deleteBtn.disabled = false;
		deleteBtn.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–ª—é—á–∏ —Å –æ—à–∏–±–∫–∞–º–∏ –≤ 3x-ui';
	});
}

function showDeleteResult(message, type) {
	// –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è
	const resultModalHtml = `
		<div id="deleteResultModal" class="modal" style="display: block;" onclick="closeDeleteResultModal()">
			<div class="modal-content" onclick="event.stopPropagation();">
				<div class="modal-header">
					<h2>${type === 'success' ? '‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è' : '‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'}</h2>
					<span class="close" onclick="closeDeleteResultModal()">&times;</span>
				</div>
				<div class="modal-body">
					<div style="max-height: 400px; overflow-y: auto; padding: 15px; background-color: #151f31; border-radius: 8px; border: 1px solid ${type === 'success' ? '#2ecc71' : '#e74c3c'};">
						<div style="color: #ecf0f1; line-height: 1.6; white-space: pre-wrap;">${message}</div>
					</div>
				</div>
				<div class="modal-footer">
					<button onclick="closeDeleteResultModal()" class="button button-primary" data-size="md" title="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ">
						<i class="fas fa-times"></i>
						–ó–∞–∫—Ä—ã—Ç—å
					</button>
				</div>
			</div>
		</div>
	`;
	
	// –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ DOM
	document.body.insertAdjacentHTML('beforeend', resultModalHtml);
}

function closeDeleteResultModal() {
	const modal = document.getElementById('deleteResultModal');
	if (modal) {
		modal.remove();
	}
}

function closeSyncErrorsModal() {
	const modal = document.getElementById('syncErrorsModal');
	if (modal) {
		modal.remove();
		// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
		window.location.reload();
	}
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞
function copyKey(key) {
	navigator.clipboard.writeText(key).then(() => {
		const notification = document.createElement('div');
		notification.textContent = '–ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!';
		notification.style.cssText = `
			position: fixed;
			top: 20px;
			right: 20px;
			background: #28a745;
			color: white;
			padding: 10px 20px;
			border-radius: 5px;
			z-index: 1000;
			font-size: 14px;
		`;
		document.body.appendChild(notification);
		
		setTimeout(() => {
			document.body.removeChild(notification);
		}, 2000);
	}).catch(err => {
		console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
		alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á');
	});
}
</script>

{% endblock %}
