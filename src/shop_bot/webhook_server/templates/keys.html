{% extends "base.html" %}
{% block title %}–ö–ª—é—á–∏{% endblock %}
{% block header_title %}–ö–ª—é—á–∏{% endblock %}

{% block header_buttons %}
<button class="button button-secondary" data-size="sm" onclick="openHostRefreshModal()" id="hostRefreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å –∫–ª—é—á–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ö–æ—Å—Ç—É">
	<i class="fas fa-server"></i>
	<span>–û–±–Ω–æ–≤–∏—Ç—å –ø–æ —Ö–æ—Å—Ç—É</span>
</button>
<button class="button button-secondary" data-size="sm" onclick="refreshKeys()" id="headerRefreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–ª—é—á–∏ –∏–∑ 3x-ui –ø–∞–Ω–µ–ª–µ–π">
	<i class="fas fa-sync-alt" id="headerRefreshIcon"></i>
	<span id="headerRefreshText">–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–ª—é—á–∏</span>
</button>
{% endblock %}

{% block content %}

<div class="keys-container">
	<div class="keys-header">
	</div>

	<section class="keys-section">
		<div class="table-container" style="padding-bottom: 80px;">
			<table class="keys-table">
				<thead>
					<tr>
						<th>–ú–µ–Ω—é</th>
						<th>ID</th>
						<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
						<th>–•–æ—Å—Ç</th>
						<th>–ü–ª–∞–Ω</th>
						<th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
						<th>–¢–∏–ø</th>
						<th>–¢—Ä–∏–∞–ª</th>
						<th>–ù–∞—á–∞–ª–æ</th>
						<th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
						<th>–û—Å—Ç–∞–ª–æ—Å—å</th>
						<th title="–û–±—â–µ–µ&#10;–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ&#10;–û—Å—Ç–∞—Ç–æ–∫">–¢—Ä–∞—Ñ–∏–∫</th>
					<th>–°—Ç–∞—Ç—É—Å</th>
					<th>–í–∫–ª</th>
					<th title="–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É –∏–∑ 3x-ui">Subscription Link</th>
					<th>–ö–ª—é—á</th>
						<th>3x-ui</th>
					</tr>
				</thead>
				<tbody>
					{% for key in keys %}
					<tr class="key-row" ondblclick="openKeyDrawer({{ key.key_id }})" style="cursor: pointer;" title="–î–≤–∞–∂–¥—ã –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª–µ–π –∫–ª—é—á–∞">
						<td>
							<div class="kebab-wrapper">
								<button class="kebab-btn" onclick="toggleKebabMenu('kebab-key-{{ key.key_id }}')" title="–î–µ–π—Å—Ç–≤–∏—è —Å –∫–ª—é—á–æ–º">
									<i class="fas fa-ellipsis-v"></i>
								</button>
								<div class="kebab-menu" id="kebab-key-{{ key.key_id }}">
									<button class="kebab-item" onclick="closeKebabMenu('kebab-key-{{ key.key_id }}'); openKeyDrawer({{ key.key_id }})" title="–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –∫–ª—é—á–∞">
										<i class="fas fa-eye"></i>
										<span>–û—Ç–∫—Ä—ã—Ç—å</span>
									</button>
									<button class="kebab-item" onclick="closeKebabMenu('kebab-key-{{ key.key_id }}'); refreshUserKey({{ key.user_id }})" title="–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ 3x-ui">
										<i class="fas fa-sync-alt"></i>
										<span>–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ 3x-ui</span>
									</button>
									{% if key.enabled %}
									<button class="kebab-item" onclick="closeKebabMenu('kebab-key-{{ key.key_id }}'); toggleKeyEnabled({{ key.key_id }}, false)" title="–û—Ç–∫–ª—é—á–∏—Ç—å –∫–ª—é—á">
										<i class="fas fa-toggle-off"></i>
										<span>–û—Ç–∫–ª—é—á–∏—Ç—å</span>
									</button>
									{% else %}
									<button class="kebab-item" onclick="closeKebabMenu('kebab-key-{{ key.key_id }}'); toggleKeyEnabled({{ key.key_id }}, true)" title="–í–∫–ª—é—á–∏—Ç—å –∫–ª—é—á">
										<i class="fas fa-toggle-on"></i>
										<span>–í–∫–ª—é—á–∏—Ç—å</span>
									</button>
									{% endif %}
								</div>
							</div>
						</td>
						<td>{{ key.key_id }}</td>
						<td>
							<div class="user-info">
								<div data-field="key_user_id" data-original="{{ key.user_id }}">
									<div class="cell-inline">
										<div class="cell-left">
											<strong>ID:</strong>
											<span>{{ hidden_mode and '***' or key.user_id }}</span>
										</div>
										<div class="cell-actions">
											<button class="modal-action-btn" data-size="xs" onclick="openUserModal({{ key.user_id }}, '{{ key.username or 'N/A' }}', false, {{ key.user_keys_count or 0 }})" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
												<i class="fas fa-eye"></i>
											</button>
										</div>
									</div>
								</div>
								<div data-field="key_username" data-original="{{ key.username or 'N/A' }}"><strong>Username:</strong> {{ hidden_mode and '***' or (key.username or 'N/A') }}</div>
							</div>
						</td>
						<td>{{ key.host_name }}</td>
						<td>
							{% if key.is_trial == 1 %}
								–¢—Ä–∏–∞–ª
							{% else %}
								{{ key.plan_name or 'N/A' }}
							{% endif %}
						</td>
						<td>{{ key.price or 'N/A' }} RUB</td>
						<td>{{ key.protocol or 'vless' }}</td>
						<td>
							{% if key.is_trial == 1 %}
								<span class="status-badge status-active">–î–∞</span>
							{% else %}
								<span class="status-badge status-banned">–ù–µ—Ç</span>
							{% endif %}
						</td>
						<td>
							{% if key.created_date %}
								{{ key.created_date.strftime('%Y-%m-%d') }}<br/>{{ key.created_date.strftime('%H:%M:%S') }}
							{% else %}
								N/A
							{% endif %}
						</td>
						<td>
							{% if key.expiry_date %}
								{% if key.expiry_date.strftime is defined %}
									{{ key.expiry_date.strftime('%Y-%m-%d') }}<br/>{{ key.expiry_date.strftime('%H:%M:%S') }}
								{% else %}
									{{ key.expiry_date }}
								{% endif %}
							{% else %}
								N/A
							{% endif %}
						</td>
						<td>
							{% if key.remaining_seconds is not none %}
								{% set days = (key.remaining_seconds // 86400) %}
								{% set hours = ((key.remaining_seconds % 86400) // 3600) %}
								{% set cls = '' %}
								{% if key.remaining_seconds == 0 %}
									{% set cls = 'rem-red' %}
								{% elif key.remaining_seconds <= (1*86400 + 24*3600) %}
									{% set cls = 'rem-orange' %}
								{% elif key.remaining_seconds <= (3*86400 + 24*3600) %}
									{% set cls = 'rem-yellow' %}
								{% else %}
									{% set cls = 'rem-green' %}
								{% endif %}
								<span class="{{ cls }}">{{ days }} –¥ {{ hours }} —á</span>
							{% else %}
								N/A
							{% endif %}
						</td>
						<td>
							{% set quota = key.quota_total_gb %}
							{% set down_mb = (key.traffic_down_bytes or 0) / (1024*1024) %}
							{% set down_str = (down_mb >= 1024) and ((down_mb/1024)|round(2) ~ ' GB') or (down_mb|round(2) ~ ' MB') %}
							{% set unlimited_case = (quota is none) and ((key.traffic_down_bytes or 0) == 0) and (key.quota_remaining_bytes is none) %}
							{% if unlimited_case %}
								‚àû
							{% else %}
								{% if key.quota_remaining_bytes is not none %}
									{% set rem_mb = key.quota_remaining_bytes / (1024*1024) %}
									{% set rem_str = (rem_mb >= 1024) and ((rem_mb/1024)|round(2) ~ ' GB') or (rem_mb|round(2) ~ ' MB') %}
								{% else %}
									{% set rem_str = '‚àû' %}
								{% endif %}
								{{ (quota is not none) and ((quota|round(2)) ~ ' GB') or '‚àû' }}<br/>{{ down_str }}<br/>{{ rem_str }}
							{% endif %}
						</td>
						<td>{{ key.status or 'N/A' }}</td>
						<td>
							{% if key.enabled %}
								<span class="status-badge status-active" title="–ö–ª—é—á –≤–∫–ª—é—á–µ–Ω">–í–∫–ª</span>
							{% else %}
								<span class="status-badge status-banned" title="–ö–ª—é—á –æ—Ç–∫–ª—é—á–µ–Ω">–í—ã–∫–ª</span>
							{% endif %}
						</td>
						<td>
							{% if key.subscription_link %}
								<div class="key-cell">
									<span class="key-text" title="{{ key.subscription_link }}">{{ key.subscription_link[:50] }}{% if key.subscription_link|length > 50 %}...{% endif %}</span>
									<button class="copy-btn" data-size="xs" onclick="copyKey('{{ key.subscription_link|replace("'", "\\'") }}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å subscription link">
										<i class="fas fa-copy"></i>
									</button>
								</div>
							{% else %}
								-
							{% endif %}
						</td>
						<td>
							{% if key.connection_string %}
								<div class="key-cell">
									<span class="key-text" title="{{ key.connection_string }}">{{ key.connection_string[:50] }}{% if key.connection_string|length > 50 %}...{% endif %}</span>
									<button class="copy-btn" data-size="xs" onclick="copyKey('{{ key.connection_string|replace("'", "\\'") }}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è">
										<i class="fas fa-copy"></i>
									</button>
								</div>
							{% else %}
								-
							{% endif %}
						</td>
						<td>
							{% if key.key_email %}
								<div class="key-cell">
									<span class="key-text" title="{{ key.key_email }}">{{ key.key_email }}</span>
									<button class="copy-btn" data-size="xs" onclick="copyKey('{{ key.key_email|replace("'", "\\'") }}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å email –∫–ª—é—á–∞">
										<i class="fas fa-copy"></i>
									</button>
								</div>
							{% else %}
								-
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>

		<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
		<div class="pagination-panel">
			<div class="pagination-controls">
			<!-- –õ–µ–≤–∞—è –æ–±–ª–∞—Å—Ç—å: –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
			<div class="pagination-left">
			</div>
				
				<!-- –ü—Ä–∞–≤–∞—è –æ–±–ª–∞—Å—Ç—å: –ø–∞–≥–∏–Ω–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
				<div class="pagination-right">
					<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
					{% if total_pages > 1 %}
					<div class="pagination">
						<!-- –°—Ç—Ä–µ–ª–∫–∞ –Ω–∞–∑–∞–¥ -->
						{% if current_page > 1 %}
							<a href="{{ url_for('keys_page', page=current_page-1, per_page=per_page) }}" class="pagination-link" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">¬´</a>
						{% endif %}
						
						<!-- –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü: –º–∞–∫—Å–∏–º—É–º 6 –Ω–æ–º–µ—Ä–æ–≤ -->
						{% if total_pages <= 6 %}
							<!-- –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü 6 –∏–ª–∏ –º–µ–Ω—å—à–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ -->
							{% for p in range(1, total_pages + 1) %}
								{% if p == current_page %}
									<span class="pagination-link active" title="–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">{{ p }}</span>
								{% else %}
									<a href="{{ url_for('keys_page', page=p, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ p }}">{{ p }}</a>
								{% endif %}
							{% endfor %}
						{% else %}
							<!-- –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –±–æ–ª—å—à–µ 6, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 4, –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é -->
							{% if current_page <= 4 %}
								<!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 1, 2, 3, 4, ..., –ø–æ—Å–ª–µ–¥–Ω—è—è -->
								{% for p in range(1, 5) %}
									{% if p == current_page %}
										<span class="pagination-link active" title="–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">{{ p }}</span>
									{% else %}
										<a href="{{ url_for('keys_page', page=p, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ p }}">{{ p }}</a>
									{% endif %}
								{% endfor %}
								<span class="pagination-link">...</span>
								<a href="{{ url_for('keys_page', page=total_pages, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ total_pages }}">{{ total_pages }}</a>
							{% elif current_page >= total_pages - 3 %}
								<!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 1, ..., –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 -->
								<a href="{{ url_for('keys_page', page=1, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1">1</a>
								<span class="pagination-link">...</span>
								{% for p in range(total_pages - 3, total_pages + 1) %}
									{% if p == current_page %}
										<span class="pagination-link active" title="–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">{{ p }}</span>
									{% else %}
										<a href="{{ url_for('keys_page', page=p, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ p }}">{{ p }}</a>
									{% endif %}
								{% endfor %}
							{% else %}
								<!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 1, ..., —Ç–µ–∫—É—â–∞—è-1, —Ç–µ–∫—É—â–∞—è, —Ç–µ–∫—É—â–∞—è+1, ..., –ø–æ—Å–ª–µ–¥–Ω—è—è -->
								<a href="{{ url_for('keys_page', page=1, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1">1</a>
								<span class="pagination-link">...</span>
								{% for p in range(current_page - 1, current_page + 2) %}
									{% if p == current_page %}
										<span class="pagination-link active" title="–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">{{ p }}</span>
									{% else %}
										<a href="{{ url_for('keys_page', page=p, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ p }}">{{ p }}</a>
									{% endif %}
								{% endfor %}
								<span class="pagination-link">...</span>
								<a href="{{ url_for('keys_page', page=total_pages, per_page=per_page) }}" class="pagination-link" title="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ total_pages }}">{{ total_pages }}</a>
							{% endif %}
						{% endif %}
						
						<!-- –°—Ç—Ä–µ–ª–∫–∞ –≤–ø–µ—Ä–µ–¥ -->
						{% if current_page < total_pages %}
							<a href="{{ url_for('keys_page', page=current_page+1, per_page=per_page) }}" class="pagination-link" title="–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">¬ª</a>
						{% endif %}
					</div>
					{% endif %}
					
					<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π -->
					<div class="per-page-selector">
						<select id="perPageSelect" onchange="changePerPage(this.value)" title="–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ">
							<option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
							<option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
							<option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
							<option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
							<option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
						</select>
					</div>
				</div>
			</div>
		</div>
	</section>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ —Ö–æ—Å—Ç—É -->
<div id="hostRefreshModal" class="modal" style="display: none;">
	<div class="modal-content">
		<div class="modal-header">
			<h3>–û–±–Ω–æ–≤–∏—Ç—å –∫–ª—é—á–∏ –ø–æ —Ö–æ—Å—Ç—É</h3>
			<button class="modal-close" onclick="closeHostRefreshModal()" title="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div class="modal-body">
			<div class="form-group">
				<label for="hostSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Å—Ç:</label>
				<select id="hostSelect" title="–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Å—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–π">
					<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ö–æ—Å—Ç–æ–≤...</option>
				</select>
			</div>
			<div class="form-group">
				<div class="info-text">
					<i class="fas fa-info-circle"></i>
					<span>–ë—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –∫–ª—é—á–∏, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ö–æ—Å—Ç—É. –≠—Ç–æ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, —á–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–ª—é—á–µ–π —Å—Ä–∞–∑—É.</span>
				</div>
			</div>
		</div>
		<div class="modal-footer">
			<button class="button button-secondary" onclick="closeHostRefreshModal()" title="–û—Ç–º–µ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é">
				<i class="fas fa-times"></i>
				<span>–û—Ç–º–µ–Ω–∞</span>
			</button>
			<button class="button button-primary" onclick="executeHostRefresh()" id="executeHostRefreshBtn" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞">
				<i class="fas fa-sync-alt"></i>
				<span>–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</span>
			</button>
		</div>
	</div>
</div>

<!-- –°—Ç–∞—Ä–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Key Drawer –∏–∑ base.html -->

<script>
function changePerPage(value) {
	const url = new URL(window.location);
	url.searchParams.set('per_page', value);
	url.searchParams.set('page', '1');
	window.location.href = url.toString();
}

function refreshKeys() {
	// –ò—â–µ–º –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è - —Å–Ω–∞—á–∞–ª–∞ –≤ header, –ø–æ—Ç–æ–º –≤ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
	let refreshBtn = document.getElementById('headerRefreshBtn');
	let refreshIcon = document.getElementById('headerRefreshIcon');
	let refreshText = document.getElementById('headerRefreshText');
	
	// –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –≤ header –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—â–µ–º –≤ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
	if (!refreshBtn) {
		refreshBtn = document.getElementById('refreshBtn');
		refreshIcon = document.getElementById('refreshIcon');
		refreshText = document.getElementById('refreshText');
	}
	
	refreshBtn.disabled = true;
	refreshIcon.classList.add('spinning');
	refreshText.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
	
	fetch('/refresh-keys', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		}
	})
	.then(response => response.json())
	.then(data => {
		if (data.status === 'success') {
			refreshText.textContent = data.message;
			
			// –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
			if (data.errors && data.errors.length > 0) {
				showSyncErrorsModal(data.errors);
				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
				setTimeout(() => {
					refreshBtn.disabled = false;
					refreshIcon.classList.remove('spinning');
					refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
				}, 1000);
			} else {
				// –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª—å—à–µ, –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
				setTimeout(() => {
					refreshBtn.disabled = false;
					refreshIcon.classList.remove('spinning');
					refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
					// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ–ª —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
					setTimeout(() => {
						window.location.reload();
					}, 2000);
				}, 3000);
			}
		} else {
			refreshText.textContent = '–û—à–∏–±–∫–∞: ' + data.message;
			setTimeout(() => {
				refreshBtn.disabled = false;
				refreshIcon.classList.remove('spinning');
				refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
			}, 2000);
		}
	})
	.catch(error => {
		console.error('Error:', error);
		refreshText.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
		setTimeout(() => {
			refreshBtn.disabled = false;
			refreshIcon.classList.remove('spinning');
			refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
		}, 2000);
	});
}

function showSyncErrorsModal(errors) {
	// –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
	const modalHtml = `
		<div id="syncErrorsModal" class="modal" style="display: flex;" onclick="closeSyncErrorsModal()">
			<div class="modal-content" onclick="event.stopPropagation();">
				<div class="modal-header">
					<h2>‚ö†Ô∏è –û—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å 3x-ui</h2>
					<span class="close" onclick="closeSyncErrorsModal()">&times;</span>
				</div>
				<div class="modal-body">
					<p>–ù–∞–π–¥–µ–Ω–æ ${errors.length} –∫–ª—é—á–µ–π —Å –æ—à–∏–±–∫–∞–º–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:</p>
					<div class="errors-list" style="max-height: 400px; overflow-y: auto; margin-top: 15px; background-color: #151f31; border-radius: 8px; padding: 10px;">
						${errors.map(error => `
							<div class="error-item" style="border: 1px solid #e74c3c; border-radius: 8px; padding: 12px; margin-bottom: 12px; background-color: #151f31; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
								<div style="font-weight: bold; color: #ecf0f1; margin-bottom: 8px; font-size: 16px;">
									${error.email}
								</div>
								<div style="font-size: 14px; color: #bdc3c7; line-height: 1.4;">
									<strong style="color: #3498db;">–°–æ–∑–¥–∞–Ω–æ:</strong> ${error.created_date}<br>
									<strong style="color: #3498db;">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</strong> ${error.expiry_date}
									${error.error ? `<br><strong style="color: #e74c3c;">–û—à–∏–±–∫–∞:</strong> <span style="color: #f39c12;">${error.error}</span>` : ''}
								</div>
							</div>
						`).join('')}
					</div>
				</div>
				<div class="modal-footer">
					<button onclick="deleteErrorKeys()" class="button button-danger" data-size="md" id="deleteBtn" title="–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á–∏ —Å –æ—à–∏–±–∫–∞–º–∏ –∏–∑ 3x-ui">
						<i class="fas fa-trash"></i>
						–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á–∏ —Å –æ—à–∏–±–∫–∞–º–∏ –≤ 3x-ui
					</button>
				</div>
			</div>
		</div>
	`;
	
	// –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ DOM
	document.body.insertAdjacentHTML('beforeend', modalHtml);
	
	// –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
	window.currentSyncErrors = errors;
}

function deleteErrorKeys() {
	const deleteBtn = document.getElementById('deleteBtn');
	const deleteResult = document.getElementById('deleteResult');
	
	if (!window.currentSyncErrors || window.currentSyncErrors.length === 0) {
		showDeleteResult('–ù–µ—Ç –∫–ª—é—á–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
		return;
	}
	
	// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —É–¥–∞–ª–µ–Ω–∏—è
	deleteBtn.disabled = true;
	deleteBtn.innerHTML = 'üîÑ –£–¥–∞–ª—è–µ–º...';
	
	// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
	const keysToDelete = window.currentSyncErrors.map(error => ({
		email: error.email,
		host_name: error.host_name,
		xui_client_uuid: error.xui_client_uuid
	}));
	
	fetch('/delete-error-keys', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		},
		body: JSON.stringify({ keys: keysToDelete })
	})
	.then(response => response.json())
	.then(data => {
		if (data.status === 'success') {
			let resultMessage = `‚úÖ ${data.message}`;
			
			if (data.failed_deletions && data.failed_deletions.length > 0) {
				resultMessage += `<br><br>‚ùå –û—à–∏–±–∫–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:`;
				data.failed_deletions.forEach(failed => {
					resultMessage += `<br>‚Ä¢ ${failed.email}: ${failed.error}`;
				});
			}
			
			showDeleteResult(resultMessage, 'success');
			
			// –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ (—É–±–∏—Ä–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ)
			if (data.deleted_count > 0) {
				window.currentSyncErrors = window.currentSyncErrors.filter(error => 
					!data.failed_deletions?.some(failed => failed.email === error.email)
				);
				
				// –ï—Å–ª–∏ –≤—Å–µ –∫–ª—é—á–∏ —É–¥–∞–ª–µ–Ω—ã, —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
				if (window.currentSyncErrors.length === 0) {
					deleteBtn.style.display = 'none';
				}
			}
		} else {
			showDeleteResult(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`, 'error');
		}
	})
	.catch(error => {
		console.error('Error:', error);
		showDeleteResult('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–π', 'error');
	})
	.finally(() => {
		deleteBtn.disabled = false;
		deleteBtn.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–ª—é—á–∏ —Å –æ—à–∏–±–∫–∞–º–∏ –≤ 3x-ui';
	});
}

function showDeleteResult(message, type) {
	// –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è
	const resultModalHtml = `
		<div id="deleteResultModal" class="modal" style="display: flex;" onclick="closeDeleteResultModal()">
			<div class="modal-content" onclick="event.stopPropagation();">
				<div class="modal-header">
					<h2>${type === 'success' ? '‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è' : '‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'}</h2>
					<span class="close" onclick="closeDeleteResultModal()">&times;</span>
				</div>
				<div class="modal-body">
					<div style="max-height: 400px; overflow-y: auto; padding: 15px; background-color: #151f31; border-radius: 8px; border: 1px solid ${type === 'success' ? '#2ecc71' : '#e74c3c'};">
						<div style="color: #ecf0f1; line-height: 1.6; white-space: pre-wrap;">${message}</div>
					</div>
				</div>
				<div class="modal-footer">
					<button onclick="closeDeleteResultModal()" class="button button-primary" data-size="md" title="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ">
						<i class="fas fa-times"></i>
						–ó–∞–∫—Ä—ã—Ç—å
					</button>
				</div>
			</div>
		</div>
	`;
	
	// –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ DOM
	document.body.insertAdjacentHTML('beforeend', resultModalHtml);
}

function closeDeleteResultModal() {
	const modal = document.getElementById('deleteResultModal');
	if (modal) {
		modal.remove();
	}
}

function closeSyncErrorsModal() {
	const modal = document.getElementById('syncErrorsModal');
	if (modal) {
		modal.remove();
		// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
		window.location.reload();
	}
}

// –§—É–Ω–∫—Ü–∏–∏ copyKey, showCopyNotification, toggleKebabMenu, closeKebabMenu, openUserModal
// –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ script.js –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function refreshUserKey(userId) {
	// –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–µ–Ω—é
	document.querySelectorAll('.kebab-menu.active').forEach(menu => {
		menu.classList.remove('active');
	});
	
	// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
	const refreshBtn = document.getElementById('headerRefreshBtn');
	const refreshIcon = document.getElementById('headerRefreshIcon');
	const refreshText = document.getElementById('headerRefreshText');
	
	if (refreshBtn) {
		refreshBtn.disabled = true;
		if (refreshIcon) refreshIcon.classList.add('spinning');
		if (refreshText) refreshText.textContent = '–û–±–Ω–æ–≤–ª—è–µ–º...';
	}
	
	// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	fetch('/refresh-user-keys', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		},
		body: JSON.stringify({ user_id: userId })
	})
	.then(response => response.json())
	.then(data => {
		if (data.success) {
			alert(`–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${data.updated_count} –∫–ª—é—á–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
			location.reload();
		} else {
			alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
		}
	})
	.catch(error => {
		console.error('–û—à–∏–±–∫–∞:', error);
		alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–π');
	})
	.finally(() => {
		if (refreshBtn) {
			refreshBtn.disabled = false;
			if (refreshIcon) refreshIcon.classList.remove('spinning');
			if (refreshText) refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–ª—é—á–∏';
		}
	});
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ —Ö–æ—Å—Ç—É
function openHostRefreshModal() {
	const modal = document.getElementById('hostRefreshModal');
	if (!modal) {
		return;
	}
    modal.style.display = 'flex';
	loadHosts();

	const headerMenu = document.getElementById('keysDropdownMenu');
	if (headerMenu) {
		headerMenu.style.display = 'none';
	}
}

function closeHostRefreshModal() {
	const modal = document.getElementById('hostRefreshModal');
	modal.style.display = 'none';
}

function loadHosts() {
	const hostSelect = document.getElementById('hostSelect');
	hostSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ö–æ—Å—Ç–æ–≤...</option>';
	
	fetch('/api/hosts')
		.then(response => {
			if (!response.ok) {
				throw new Error(`HTTP ${response.status}`);
			}
			return response.json();
		})
		.then(data => {
			if (!data.success || !Array.isArray(data.hosts)) {
				throw new Error(data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
			}
			hostSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Å—Ç</option>';
			data.hosts.forEach(host => {
				const option = document.createElement('option');
				option.value = host.host_name;
				option.textContent = host.host_name;
				hostSelect.appendChild(option);
			});
		})
		.catch(error => {
			console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ö–æ—Å—Ç–æ–≤:', error);
			hostSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ö–æ—Å—Ç–æ–≤</option>';
		});
}

function executeHostRefresh() {
	const hostSelect = document.getElementById('hostSelect');
	const selectedHost = hostSelect.value;
	const executeBtn = document.getElementById('executeHostRefreshBtn');
	
	if (!selectedHost) {
		alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Å—Ç');
		return;
	}
	
	executeBtn.disabled = true;
	executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>–û–±–Ω–æ–≤–ª—è–µ–º...</span>';
	
	fetch('/api/refresh-keys-by-host', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		},
		body: JSON.stringify({ host_name: selectedHost })
	})
	.then(response => response.json())
	.then(data => {
		if (data.success) {
			alert(`–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${data.updated} –∏–∑ ${data.total} –∫–ª—é—á–µ–π –¥–ª—è —Ö–æ—Å—Ç–∞ ${selectedHost}`);
			location.reload();
		} else {
			alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
		}
	})
	.catch(error => {
		console.error('–û—à–∏–±–∫–∞:', error);
		alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–π');
	})
	.finally(() => {
		executeBtn.disabled = false;
		executeBtn.innerHTML = '<i class="fas fa-sync-alt"></i><span>–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</span>';
	});
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–ª—é—á–∞
function toggleKeyEnabled(keyId, enabled) {
	const action = enabled ? '–≤–∫–ª—é—á–µ–Ω–∏–µ' : '–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ';
	
	// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
	if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${enabled ? '–≤–∫–ª—é—á–∏—Ç—å' : '–æ—Ç–∫–ª—é—á–∏—Ç—å'} —ç—Ç–æ—Ç –∫–ª—é—á?`)) {
		return;
	}
	
	// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
	const button = event.target.closest('button');
	const originalContent = button.innerHTML;
	button.disabled = true;
	button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>';
	
	// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
	fetch('/api/toggle-key-enabled', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		},
		body: JSON.stringify({
			key_id: keyId,
			enabled: enabled
		})
	})
	.then(response => response.json())
	.then(data => {
		if (data.success) {
			// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
			showCopyNotification(data.message, 'success');
			// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
			setTimeout(() => {
				location.reload();
			}, 1500);
		} else {
			showCopyNotification('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
			button.disabled = false;
			button.innerHTML = originalContent;
		}
	})
	.catch(error => {
		console.error('–û—à–∏–±–∫–∞:', error);
		showCopyNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ ' + action + ' –∫–ª—é—á–∞', 'error');
		button.disabled = false;
		button.innerHTML = originalContent;
	});
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
	const hostModal = document.getElementById('hostRefreshModal');
	
	if (event.target === hostModal) {
		closeHostRefreshModal();
	}
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ drawer –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
document.addEventListener('DOMContentLoaded', function() {
	const keyDrawerOverlay = document.getElementById('keyDrawer');
	if (keyDrawerOverlay) {
		keyDrawerOverlay.addEventListener('click', function(e) {
			// –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ overlay, –∞ –Ω–µ –Ω–∞ drawer –∏–ª–∏ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º
			if (e.target === keyDrawerOverlay) {
				closeKeyDrawer();
			}
		});
	}
});

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ openKeyDrawer –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–π –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–æ–≥–∏–∫–∏
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ currentKeyDrawerId, currentKeyDrawerUserId, currentKeyDrawerEnabled –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ script.js
async function openKeyDrawer(keyId) {
	window.currentKeyDrawerId = keyId;
	
	try {
		const response = await fetch(`/api/key/${keyId}`);
		const data = await response.json();
		
		if (!data.key) {
			alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª—é—á–∞');
			return;
		}
		
		const key = data.key;
		window.currentKeyDrawerUserId = key.user_id;
		window.currentKeyDrawerEnabled = key.enabled;
		
		// –ó–∞–ø–æ–ª–Ω—è–µ–º Drawer –¥–∞–Ω–Ω—ã–º–∏ - –≤–µ—Ä—Ö–Ω—è—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ)
		document.getElementById('keyModalTelegramId').textContent = key.telegram_id || 'N/A';
		document.getElementById('keyModalFullName').textContent = key.fullname || 'N/A';
		document.getElementById('keyModalFio').textContent = key.fio || 'N/A';
		
		// –°—Ç–∞—Ç—É—Å
		document.getElementById('keyModalStatus').innerHTML = key.enabled 
			? '<span class="status-badge status-active">–ê–∫—Ç–∏–≤–µ–Ω</span>' 
			: '<span class="status-badge status-banned">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>';
		
		// –í–∫–ª–∞–¥–∫–∞: –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
		// –ì—Ä—É–ø–ø–∞: –¢–∞—Ä–∏—Ñ
		document.getElementById('keyDetailHost').textContent = key.host_name || 'N/A';
		
		if (key.is_trial === 1) {
			document.getElementById('keyDetailPlan').textContent = '–¢—Ä–∏–∞–ª';
		} else {
			document.getElementById('keyDetailPlan').textContent = key.plan_name || 'N/A';
		}
		
		document.getElementById('keyDetailPrice').textContent = key.price ? `${key.price} RUB` : 'N/A';
		
		// –°—Ç–∞—Ç—É—Å –≤–æ –≤–∫–ª–∞–¥–∫–µ
		document.getElementById('keyDetailStatusInTab').innerHTML = key.enabled 
			? '<span class="status-badge status-active">–ê–∫—Ç–∏–≤–µ–Ω</span>' 
			: '<span class="status-badge status-banned">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>';
		
		// –ì—Ä—É–ø–ø–∞: –ü–æ–¥–ø–∏—Å–∫–∞
		document.getElementById('keyDetailProtocol').textContent = key.protocol || 'vless';
		
		// –í–∫–ª—é—á–µ–Ω
		const enabledSpan = document.getElementById('keyDetailEnabled');
		if (key.enabled) {
			enabledSpan.innerHTML = '<span class="status-badge status-active">–í–∫–ª</span>';
		} else {
			enabledSpan.innerHTML = '<span class="status-badge status-banned">–í—ã–∫–ª</span>';
		}
		
		// –¢—Ä–∏–∞–ª
		const trialSpan = document.getElementById('keyDetailTrial');
		if (key.is_trial === 1) {
			trialSpan.innerHTML = '<span class="status-badge status-active">–î–∞</span>';
		} else {
			trialSpan.innerHTML = '<span class="status-badge status-banned">–ù–µ—Ç</span>';
		}
		
		// –î–∞—Ç—ã
		if (key.created_date) {
			const createdDate = new Date(key.created_date);
			document.getElementById('keyDetailCreatedDate').textContent = createdDate.toLocaleString('ru-RU');
		} else {
			document.getElementById('keyDetailCreatedDate').textContent = 'N/A';
		}
		
		if (key.expiry_date) {
			const expiryDate = new Date(key.expiry_date);
			document.getElementById('keyDetailExpiryDate').textContent = expiryDate.toLocaleString('ru-RU');
		} else {
			document.getElementById('keyDetailExpiryDate').textContent = 'N/A';
		}
		
		// –û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è
		if (key.remaining_seconds !== null && key.remaining_seconds !== undefined) {
			const days = Math.floor(key.remaining_seconds / 86400);
			const hours = Math.floor((key.remaining_seconds % 86400) / 3600);
			let cls = '';
			if (key.remaining_seconds === 0) {
				cls = 'rem-red';
			} else if (key.remaining_seconds <= (1 * 86400 + 24 * 3600)) {
				cls = 'rem-orange';
			} else if (key.remaining_seconds <= (3 * 86400 + 24 * 3600)) {
				cls = 'rem-yellow';
			} else {
				cls = 'rem-green';
			}
			document.getElementById('keyDetailRemaining').innerHTML = `<span class="${cls}">${days} –¥ ${hours} —á</span>`;
		} else {
			document.getElementById('keyDetailRemaining').textContent = 'N/A';
		}
		
		// –ì—Ä—É–ø–ø–∞: –¢—Ä–∞—Ñ–∏–∫ (—Ç–µ–ø–µ—Ä—å –≤ —Ç–æ–π –∂–µ –≤–∫–ª–∞–¥–∫–µ "–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
		const quotaTotalGb = key.quota_total_gb;
		const trafficDownBytes = key.traffic_down_bytes || 0;
		const quotaRemainingBytes = key.quota_remaining_bytes;
		
		// –ö–≤–æ—Ç–∞ –≤—Å–µ–≥–æ
		if (quotaTotalGb !== null && quotaTotalGb !== undefined) {
			document.getElementById('keyDetailQuotaTotal').textContent = `${quotaTotalGb.toFixed(2)} GB`;
		} else {
			document.getElementById('keyDetailQuotaTotal').textContent = '‚àû';
		}
		
		// –¢—Ä–∞—Ñ–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ
		const downMb = trafficDownBytes / (1024 * 1024);
		if (downMb >= 1024) {
			document.getElementById('keyDetailTrafficDown').textContent = `${(downMb / 1024).toFixed(2)} GB`;
		} else {
			document.getElementById('keyDetailTrafficDown').textContent = `${downMb.toFixed(2)} MB`;
		}
		
		// –ö–≤–æ—Ç–∞ –æ—Å—Ç–∞—Ç–æ–∫
		if (quotaRemainingBytes !== null && quotaRemainingBytes !== undefined) {
			const remMb = quotaRemainingBytes / (1024 * 1024);
			if (remMb >= 1024) {
				document.getElementById('keyDetailQuotaRemaining').textContent = `${(remMb / 1024).toFixed(2)} GB`;
			} else {
				document.getElementById('keyDetailQuotaRemaining').textContent = `${remMb.toFixed(2)} MB`;
			}
		} else {
			document.getElementById('keyDetailQuotaRemaining').textContent = '‚àû';
		}
		
		// –í–∫–ª–∞–¥–∫–∞: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
		document.getElementById('keyDetailSubscription').textContent = key.subscription || '‚Äî';
		document.getElementById('keyDetailSubscriptionLink').textContent = key.subscription_link || '‚Äî';
		document.getElementById('keyDetailEmail').textContent = key.key_email || 'N/A';
		document.getElementById('keyDetailUuid').textContent = key.xui_client_uuid || 'N/A';
		document.getElementById('keyDetailConnectionString').textContent = key.connection_string || 'N/A';
		document.getElementById('keyDetailTelegramChatId').textContent = key.telegram_chat_id || '‚Äî';
		document.getElementById('keyDetailComment').textContent = key.comment || '‚Äî';
		
		// –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ Drawer
		const drawerToggleText = document.getElementById('keyDrawerToggleText');
		if (key.enabled) {
			drawerToggleText.textContent = '–û—Ç–∫–ª—é—á–∏—Ç—å';
		} else {
			drawerToggleText.textContent = '–í–∫–ª—é—á–∏—Ç—å';
		}
		
		// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º Drawer —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
		const drawer = document.getElementById('keyDrawer');
		drawer.style.display = 'block';
		// –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
		setTimeout(() => {
			drawer.classList.add('active');
		}, 10);
		
	} catch (error) {
		console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª—é—á–∞:', error);
		alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª—é—á–∞');
	}
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è Drawer
function closeKeyDrawer() {
	const drawer = document.getElementById('keyDrawer');
	drawer.classList.remove('active');
	// –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Å–∫—Ä—ã—Ç–∏–µ–º
	setTimeout(() => {
		drawer.style.display = 'none';
	}, 300);
	
	window.currentKeyDrawerId = null;
	window.currentKeyDrawerUserId = null;
	window.currentKeyDrawerEnabled = false;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫ –≤ Drawer –∫–ª—é—á–∞
function switchKeyTab(tabName) {
	// –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
	document.querySelectorAll('#keyDrawer .tab-button').forEach(btn => btn.classList.remove('active'));
	document.querySelectorAll('#keyDrawer .tab-content').forEach(content => content.classList.remove('active'));
	
	// –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
	event.target.closest('.tab-button').classList.add('active');
	document.getElementById(`tab-${tabName}`).classList.add('active');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞ –∏–∑ Drawer
function keyDrawerRefresh() {
	if (window.currentKeyDrawerUserId) {
		refreshUserKey(window.currentKeyDrawerUserId);
		// –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ Drawer –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
		setTimeout(() => {
			if (window.currentKeyDrawerId) {
				openKeyDrawer(window.currentKeyDrawerId);
			}
		}, 2000);
	}
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–ª—é—á–∞ –∏–∑ Drawer
function keyDrawerToggle() {
	if (window.currentKeyDrawerId) {
		const newEnabled = !window.currentKeyDrawerEnabled;
		toggleKeyEnabled(window.currentKeyDrawerId, newEnabled);
		// –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ Drawer –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
		setTimeout(() => {
			if (window.currentKeyDrawerId) {
				openKeyDrawer(window.currentKeyDrawerId);
			}
		}, 1500);
	}
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—è –∏–∑ Drawer –∫–ª—é—á–∞
function copyKeyField(elementId) {
	const element = document.getElementById(elementId);
	if (element) {
		const text = element.textContent;
		if (text && text !== '‚Äî' && text !== 'N/A') {
			copyKey(text);
		} else {
			showCopyNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
		}
	}
}
</script>

{% endblock %}
