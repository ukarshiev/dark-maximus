{% extends "base.html" %}
{% block title %}–ö–ª—é—á–∏{% endblock %}
{% block content %}

<div class="keys-container">
	<div class="keys-header">
		<h1>–ö–ª—é—á–∏ VPN</h1>
	</div>

	<section class="keys-section">
		<div class="table-container">
			<table class="keys-table">
				<thead>
					<tr>
						<th>ID</th>
						<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
						<th>–•–æ—Å—Ç</th>
						<th>–ü–ª–∞–Ω</th>
						<th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
						<th>–¢–∏–ø</th>
						<th>–¢—Ä–∏–∞–ª</th>
						<th>–ù–∞—á–∞–ª–æ</th>
						<th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
						<th>–û—Å—Ç–∞–ª–æ—Å—å</th>
						<th>–û–±—â|–ò—Å–ø|–û—Å—Ç</th>
						<th>–°—Ç–∞—Ç—É—Å</th>
						<th>–ö–ª—é—á</th>
						<th>3x-ui</th>
					</tr>
				</thead>
				<tbody>
					{% for key in keys %}
					<tr class="key-row">
						<td>{{ key.key_id }}</td>
						<td>
							<div class="user-info">
								<div data-field="key_user_id" data-original="{{ key.user_id }}">
									<div class="cell-inline">
										<div class="cell-left">
											<strong>ID:</strong>
											<span>{{ hidden_mode and '***' or key.user_id }}</span>
										</div>
										<div class="cell-actions">
											<button class="modal-action-btn" onclick="openUserModal({{ key.user_id }}, '{{ key.username or 'N/A' }}', false, 1)" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É">üîç</button>
										</div>
									</div>
								</div>
								<div data-field="key_username" data-original="{{ key.username or 'N/A' }}"><strong>Username:</strong> {{ hidden_mode and '***' or (key.username or 'N/A') }}</div>
							</div>
						</td>
						<td>{{ key.host_name }}</td>
						<td>{{ key.plan_name or 'N/A' }}</td>
						<td>{{ key.price or 'N/A' }} RUB</td>
						<td>{{ key.protocol or 'vless' }}</td>
						<td>{{ key.is_trial or 0 }}</td>
						<td>
							{% if key.created_date %}
								{{ key.created_date.strftime('%Y-%m-%d') }}<br/>{{ key.created_date.strftime('%H:%M:%S') }}
							{% else %}
								N/A
							{% endif %}
						</td>
						<td>
							{% if key.expiry_date %}
								{% if key.expiry_date.strftime is defined %}
									{{ key.expiry_date.strftime('%Y-%m-%d') }}<br/>{{ key.expiry_date.strftime('%H:%M:%S') }}
								{% else %}
									{{ key.expiry_date }}
								{% endif %}
							{% else %}
								N/A
							{% endif %}
						</td>
						<td>
							{% if key.remaining_seconds is not none %}
								{% set days = (key.remaining_seconds // 86400) %}
								{% set hours = ((key.remaining_seconds % 86400) // 3600) %}
								{% set cls = '' %}
								{% if key.remaining_seconds == 0 %}
									{% set cls = 'rem-red' %}
								{% elif key.remaining_seconds <= (1*86400 + 24*3600) %}
									{% set cls = 'rem-orange' %}
								{% elif key.remaining_seconds <= (3*86400 + 24*3600) %}
									{% set cls = 'rem-yellow' %}
								{% else %}
									{% set cls = 'rem-green' %}
								{% endif %}
								<span class="{{ cls }}">{{ days }} –¥ {{ hours }} —á</span>
							{% else %}
								N/A
							{% endif %}
						</td>
						<td>
							{% set quota = key.quota_total_gb %}
							{% set down_mb = (key.traffic_down_bytes or 0) / (1024*1024) %}
							{% set down_str = (down_mb >= 1024) and ((down_mb/1024)|round(2) ~ ' GB') or (down_mb|round(2) ~ ' MB') %}
							{% set unlimited_case = (quota is none) and ((key.traffic_down_bytes or 0) == 0) and (key.quota_remaining_bytes is none) %}
							{% if unlimited_case %}
								‚àû
							{% else %}
								{% if key.quota_remaining_bytes is not none %}
									{% set rem_mb = key.quota_remaining_bytes / (1024*1024) %}
									{% set rem_str = (rem_mb >= 1024) and ((rem_mb/1024)|round(2) ~ ' GB') or (rem_mb|round(2) ~ ' MB') %}
								{% else %}
									{% set rem_str = '‚àû' %}
								{% endif %}
								{{ (quota is not none) and ((quota|round(2)) ~ ' GB') or '‚àû' }}<br/>{{ down_str }}<br/>{{ rem_str }}
							{% endif %}
						</td>
						<td>{{ key.status or 'N/A' }}</td>
						<td>
							{% if key.connection_string %}
								<div class="key-cell">
									<span class="key-text" title="{{ key.connection_string }}">{{ key.connection_string[:50] }}{% if key.connection_string|length > 50 %}...{% endif %}</span>
									<button class="copy-btn" onclick="copyKey('{{ key.connection_string }}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á">
										üìã
									</button>
								</div>
							{% else %}
								-
							{% endif %}
						</td>
						<td>
							{% if key.key_email %}
								<div class="key-cell">
									<span class="key-text" title="{{ key.key_email }}">{{ key.key_email }}</span>
									<button class="copy-btn" onclick="copyKey('{{ key.key_email }}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å email">üìã</button>
								</div>
							{% else %}
								-
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>

		<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
		<div class="pagination-panel">
			<div class="pagination-controls">
				<!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
				<button class="button button-primary button-small-refresh" onclick="refreshKeys()" id="refreshBtn">
					<span id="refreshIcon">üîÑ</span>
					<span id="refreshText">–û–±–Ω–æ–≤–∏—Ç—å</span>
				</button>
				
				<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
				{% if total_pages > 1 %}
				<div class="pagination">
					{% if current_page > 1 %}
						<a href="{{ url_for('keys_page', page=current_page-1, per_page=per_page) }}" class="pagination-link">¬´</a>
					{% endif %}
					
					{% for page_num in range(1, total_pages + 1) %}
						{% if page_num == current_page %}
							<span class="pagination-link active">{{ page_num }}</span>
						{% else %}
							<a href="{{ url_for('keys_page', page=page_num, per_page=per_page) }}" class="pagination-link">{{ page_num }}</a>
						{% endif %}
					{% endfor %}
					
					{% if current_page < total_pages %}
						<a href="{{ url_for('keys_page', page=current_page+1, per_page=per_page) }}" class="pagination-link">¬ª</a>
					{% endif %}
				</div>
				{% endif %}
				
				<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π -->
				<div class="per-page-selector">
					<select id="perPageSelect" onchange="changePerPage(this.value)">
						<option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
						<option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
						<option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
						<option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
						<option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
					</select>
				</div>
			</div>
		</div>
	</section>
</div>

<script>
function changePerPage(value) {
	const url = new URL(window.location);
	url.searchParams.set('per_page', value);
	url.searchParams.set('page', '1');
	window.location.href = url.toString();
}

function refreshKeys() {
	const refreshBtn = document.getElementById('refreshBtn');
	const refreshIcon = document.getElementById('refreshIcon');
	const refreshText = document.getElementById('refreshText');
	
	refreshBtn.disabled = true;
	refreshIcon.classList.add('spinning');
	refreshText.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
	
	fetch('/refresh-keys', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		}
	})
	.then(response => response.json())
	.then(data => {
		if (data.status === 'success') {
			refreshText.textContent = data.message;
			setTimeout(() => {
				window.location.reload();
			}, 1000);
		} else {
			refreshText.textContent = '–û—à–∏–±–∫–∞: ' + data.message;
			setTimeout(() => {
				refreshBtn.disabled = false;
				refreshIcon.classList.remove('spinning');
				refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
			}, 2000);
		}
	})
	.catch(error => {
		console.error('Error:', error);
		refreshText.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
		setTimeout(() => {
			refreshBtn.disabled = false;
			refreshIcon.classList.remove('spinning');
			refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
		}, 2000);
	});
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞
function copyKey(key) {
	navigator.clipboard.writeText(key).then(() => {
		const notification = document.createElement('div');
		notification.textContent = '–ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!';
		notification.style.cssText = `
			position: fixed;
			top: 20px;
			right: 20px;
			background: #28a745;
			color: white;
			padding: 10px 20px;
			border-radius: 5px;
			z-index: 1000;
			font-size: 14px;
		`;
		document.body.appendChild(notification);
		
		setTimeout(() => {
			document.body.removeChild(notification);
		}, 2000);
	}).catch(err => {
		console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
		alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á');
	});
}
</script>

{% endblock %}
