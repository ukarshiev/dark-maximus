{% extends "base.html" %}
{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {{ file_name }}{% endblock %}
{% block header_title %}üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Wiki{% endblock %}

{% block header_buttons %}
<a href="{{ url_for('wiki_editor_page') }}" class="button button-secondary" data-size="sm" title="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü">
    <i class="fas fa-arrow-left"></i>
    –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
</a>
{% endblock %}

{% block content %}

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Editor.js - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.10.0"></script>
<script src="https://cdn.jsdelivr.net/npm/codex.editor.header@2.1.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/list@1.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/code@2.8.2"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@1.5.1"></script>

<form method="post" enctype="multipart/form-data" id="wikiForm">
    <section class="settings-section">
        <h2 style="margin-bottom: 12px;">{{ file_name }}</h2>
        <p style="margin-bottom: 16px; color: var(--text-muted); font-family: monospace; font-size: 0.9em;">
            –ü—É—Ç—å: {{ file_path }}
        </p>
        
        <input type="hidden" name="file" value="{{ file_path }}">
        <input type="hidden" name="content" id="markdownContent">
        
        <!-- –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading-spinner" style="display:flex; align-items:center; justify-content:center; background:var(--bg-surface);border:1px solid var(--border-color);border-radius:8px;padding:40px;min-height:calc(100vh - 340px);">
            <div style="text-align:center;">
                <div style="width:40px;height:40px;border:4px solid var(--border-color);border-top:4px solid var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div>
                <p style="color:var(--text-muted);margin:0;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞...</p>
            </div>
        </div>
        
        <!-- Editor.js –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
        <div id="editorjs" style="display:none;background:var(--bg-surface);border:1px solid var(--border-color);border-radius:8px;padding:20px;min-height:calc(100vh - 340px);"></div>
        
        <!-- –†–µ–∑–µ—Ä–≤–Ω—ã–π –ø—Ä–æ—Å—Ç–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="fallback-editor" style="display:none;">
            <textarea 
                id="simple-editor"
                style="background:var(--bg-surface);color:#e9ecef;border:1px solid var(--border-color);min-height:calc(100vh - 340px);width:100%;box-sizing:border-box;font-family:'Courier New', Courier, monospace;font-size:14px;line-height:1.6;padding:16px;border-radius:8px;"
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown..."
                title="–ü—Ä–æ—Å—Ç–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä Markdown"
            >{{ content }}</textarea>
        </div>
        
        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º Markdown –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ -->
        <textarea id="originalMarkdown" style="display:none;">{{ content }}</textarea>
        
        <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <button type="button" class="button button-start" data-size="md" id="saveBtn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è">
                <i class="fas fa-save"></i>
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <a href="{{ url_for('wiki_editor_page') }}" class="button button-secondary" data-size="md" title="–û—Ç–º–µ–Ω–∏—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è">
                <i class="fas fa-times"></i>
                –û—Ç–º–µ–Ω–∞
            </a>
            <button type="button" class="button button-secondary" data-size="md" id="previewBtn" title="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ">
                <i class="fas fa-eye"></i>
                –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            </button>
        </div>
    </section>
</form>

<!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ Editor.js -->
<section class="settings-section">
    <h3 style="margin-bottom: 12px;">üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Editor.js</h3>
    <div style="line-height: 1.8; color: var(--text-muted);">
        <p style="margin-bottom: 12px;"><strong>–ù–∞–∂–º–∏—Ç–µ Tab –∏–ª–∏ —â—ë–ª–∫–Ω–∏—Ç–µ + —Å–ª–µ–≤–∞</strong> —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –±–ª–æ–∫–æ–≤:</p>
        <ul style="margin-left: 20px;">
            <li>üìù <strong>Paragraph</strong> - –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç</li>
            <li>üî§ <strong>Header</strong> - –∑–∞–≥–æ–ª–æ–≤–∫–∏ (H1, H2, H3)</li>
            <li>üìã <strong>List</strong> - —Å–ø–∏—Å–∫–∏ (–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ)</li>
            <li>üíª <strong>Code</strong> - –±–ª–æ–∫–∏ –∫–æ–¥–∞</li>
            <li>üìä <strong>Table</strong> - —Ç–∞–±–ª–∏—Ü—ã</li>
            <li>üí¨ <strong>Quote</strong> - —Ü–∏—Ç–∞—Ç—ã</li>
            <li>‚ö†Ô∏è <strong>Warning</strong> - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</li>
            <li>‚ûñ <strong>Delimiter</strong> - —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å</li>
        </ul>
        <p style="margin-top: 12px;"><strong>–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞:</strong> –≤—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–∞–Ω–µ–ª—å</p>
        <p><strong>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</strong> Ctrl+S (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å), Ctrl+E (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)</p>
    </div>
</section>

<script>
let editor;

// –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä Markdown -> Editor.js blocks
function parseMarkdownToBlocks(markdown) {
    const lines = markdown.split('\n');
    const blocks = [];
    let currentBlock = null;
    let inCodeBlock = false;
    let codeContent = [];
    let inList = false;
    let listItems = [];
    let listType = 'unordered';
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // –ö–æ–¥ –±–ª–æ–∫
        if (line.startsWith('```')) {
            if (inCodeBlock) {
                blocks.push({
                    type: 'code',
                    data: { code: codeContent.join('\n') }
                });
                codeContent = [];
                inCodeBlock = false;
            } else {
                inCodeBlock = true;
            }
            continue;
        }
        
        if (inCodeBlock) {
            codeContent.push(line);
            continue;
        }
        
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        if (line.match(/^#{1,3}\s/)) {
            if (inList) {
                blocks.push({ type: 'list', data: { style: listType, items: listItems } });
                listItems = [];
                inList = false;
            }
            const level = line.match(/^(#{1,3})/)[1].length;
            const text = line.replace(/^#{1,3}\s/, '').trim();
            blocks.push({
                type: 'header',
                data: { text: text, level: level }
            });
            continue;
        }
        
        // –°–ø–∏—Å–∫–∏
        if (line.match(/^[-*]\s/) || line.match(/^\d+\.\s/)) {
            const isOrdered = line.match(/^\d+\.\s/);
            const text = line.replace(/^[-*]\s|^\d+\.\s/, '').trim();
            
            if (!inList) {
                inList = true;
                listType = isOrdered ? 'ordered' : 'unordered';
            }
            
            listItems.push(text);
            continue;
        } else if (inList && line.trim() === '') {
            blocks.push({
                type: 'list',
                data: { style: listType, items: listItems }
            });
            listItems = [];
            inList = false;
            continue;
        }
        
        // –¶–∏—Ç–∞—Ç—ã
        if (line.startsWith('> ')) {
            blocks.push({
                type: 'quote',
                data: { text: line.replace(/^>\s/, ''), caption: '' }
            });
            continue;
        }
        
        // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        if (line.match(/^---+$/)) {
            blocks.push({ type: 'delimiter', data: {} });
            continue;
        }
        
        // –û–±—ã—á–Ω—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ
        if (line.trim()) {
            blocks.push({
                type: 'paragraph',
                data: { text: line.trim() }
            });
        }
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    if (inList) {
        blocks.push({
            type: 'list',
            data: { style: listType, items: listItems }
        });
    }
    
    return blocks.length > 0 ? blocks : [{ type: 'paragraph', data: { text: '' } }];
}

// –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä Editor.js blocks -> Markdown
function blocksToMarkdown(blocks) {
    let markdown = '';
    
    blocks.forEach((block, index) => {
        switch (block.type) {
            case 'header':
                const hashes = '#'.repeat(block.data.level);
                markdown += `${hashes} ${block.data.text}\n\n`;
                break;
            
            case 'paragraph':
                markdown += `${block.data.text}\n\n`;
                break;
            
            case 'list':
                block.data.items.forEach((item, i) => {
                    const prefix = block.data.style === 'ordered' ? `${i + 1}. ` : '- ';
                    markdown += `${prefix}${item}\n`;
                });
                markdown += '\n';
                break;
            
            case 'code':
                markdown += `\`\`\`\n${block.data.code}\n\`\`\`\n\n`;
                break;
            
            case 'quote':
                markdown += `> ${block.data.text}\n\n`;
                break;
            
            case 'delimiter':
                markdown += `---\n\n`;
                break;
            
            case 'warning':
                markdown += `!> ${block.data.title}\n${block.data.message}\n\n`;
                break;
            
            case 'table':
                // –ü—Ä–æ—Å—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞
                if (block.data.content && block.data.content.length > 0) {
                    const headers = block.data.content[0];
                    markdown += '| ' + headers.join(' | ') + ' |\n';
                    markdown += '|' + headers.map(() => '---').join('|') + '|\n';
                    for (let i = 1; i < block.data.content.length; i++) {
                        markdown += '| ' + block.data.content[i].join(' | ') + ' |\n';
                    }
                    markdown += '\n';
                }
                break;
            
            default:
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –±–ª–æ–∫–∏
                break;
        }
    });
    
    return markdown.trim();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Editor.js
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Editor.js...');
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å–ø–∏–Ω–Ω–µ—Ä–∞
    function hideSpinner() {
        document.getElementById('loading-spinner').style.display = 'none';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
    function switchToFallbackEditor() {
        console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä...');
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
        hideSpinner();
        document.getElementById('editorjs').style.display = 'none';
        document.getElementById('fallback-editor').style.display = 'block';
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        document.getElementById('saveBtn').addEventListener('click', function() {
            const content = document.getElementById('simple-editor').value;
            document.getElementById('markdownContent').value = content;
            document.getElementById('wikiForm').submit();
        });
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        document.getElementById('previewBtn').addEventListener('click', function() {
            const wikiUrl = '{{ wiki_url }}';
            console.log('üîç –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä Wiki:', wikiUrl);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Wiki —Å–µ—Ä–≤–µ—Ä–∞
            fetch(wikiUrl)
                .then(response => {
                    if (response.ok) {
                        console.log('‚úÖ Wiki —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω');
                        window.open(wikiUrl, '_blank');
                    } else {
                        console.warn('‚ö†Ô∏è Wiki —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
                        alert('Wiki —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä docs –∑–∞–ø—É—â–µ–Ω (docker compose up -d docs)');
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Wiki —Å–µ—Ä–≤–µ—Ä—É:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Wiki —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä docs –∑–∞–ø—É—â–µ–Ω (docker compose up -d docs)');
                });
        });
        
        console.log('‚úÖ –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
    }
    
    // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
    setTimeout(function() {
        try {
            console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Editor.js...');
            console.log('window.EditorJS:', typeof window.EditorJS);
            console.log('window.Header:', typeof window.Header);
            console.log('window.List:', typeof window.List);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –ø–ª–∞–≥–∏–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (typeof EditorJS === 'undefined') {
                console.error('‚ùå EditorJS –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                console.log('üîç –î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:', Object.keys(window).filter(key => key.includes('Editor') || key.includes('Header') || key.includes('List')));
                switchToFallbackEditor();
                return;
            }
            
            if (typeof Header === 'undefined') {
                console.error('‚ùå Header –ø–ª–∞–≥–∏–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Header –ø–ª–∞–≥–∏–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            
            if (typeof List === 'undefined') {
                console.error('‚ùå List –ø–ª–∞–≥–∏–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ List –ø–ª–∞–≥–∏–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            
            console.log('‚úÖ –í—Å–µ –ø–ª–∞–≥–∏–Ω—ã Editor.js –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');
            
            const originalMarkdown = document.getElementById('originalMarkdown').value;
            const initialBlocks = parseMarkdownToBlocks(originalMarkdown);
            
            editor = new EditorJS({
                holder: 'editorjs',
                tools: {
                    header: {
                        class: Header,
                        inlineToolbar: true,
                        config: {
                            placeholder: '–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫',
                            levels: [1, 2, 3],
                            defaultLevel: 2
                        }
                    },
                    list: {
                        class: List,
                        inlineToolbar: true,
                        config: {
                            defaultStyle: 'unordered'
                        }
                    },
                    code: Code,
                    inlineCode: {
                        class: InlineCode,
                        shortcut: 'CMD+SHIFT+M'
                    }
                },
                data: {
                    blocks: initialBlocks
                },
                placeholder: '–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ + –¥–ª—è –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞...',
                onReady: () => {
                    console.log('‚úÖ Editor.js –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
                }
            });
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º isReady –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            editor.isReady
                .then(() => {
                    console.log('‚úÖ Editor.js –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                    hideSpinner();
                    document.getElementById('editorjs').style.display = 'block';
                })
                .catch((reason) => {
                    console.error('‚ùå Editor.js –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å:', reason);
                    switchToFallbackEditor();
                });
            
            // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            document.getElementById('saveBtn').addEventListener('click', async function() {
                try {
                    const outputData = await editor.save();
                    const markdown = blocksToMarkdown(outputData.blocks);
                    document.getElementById('markdownContent').value = markdown;
                    document.getElementById('wikiForm').submit();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
                }
            });
            
            // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            document.getElementById('previewBtn').addEventListener('click', function() {
                const wikiUrl = 'http://localhost:3001';
                console.log('üîç –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä Wiki:', wikiUrl);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Wiki —Å–µ—Ä–≤–µ—Ä–∞
                fetch(wikiUrl)
                    .then(response => {
                        if (response.ok) {
                            console.log('‚úÖ Wiki —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω');
                            window.open(wikiUrl, '_blank');
                        } else {
                            console.warn('‚ö†Ô∏è Wiki —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
                            alert('Wiki —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä docs –∑–∞–ø—É—â–µ–Ω (docker compose up -d docs)');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Wiki —Å–µ—Ä–≤–µ—Ä—É:', error);
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Wiki —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä docs –∑–∞–ø—É—â–µ–Ω (docker compose up -d docs)');
                    });
            });
            
            // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
            document.addEventListener('keydown', function(e) {
                // Ctrl+S –∏–ª–∏ Cmd+S - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    document.getElementById('saveBtn').click();
                }
                
                // Ctrl+E –∏–ª–∏ Cmd+E - –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    document.getElementById('previewBtn').click();
                }
            });
            
            console.log('‚ú® Editor.js –≥–æ—Ç–æ–≤!\nüí° –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:\n- Ctrl+S (Cmd+S) - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å\n- Ctrl+E (Cmd+E) - –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä\n- Tab - –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –±–ª–æ–∫–æ–≤');
            
        } catch (error) {
            console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
        }
    }, 5000); // –ñ–¥—ë–º 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
});
</script>

{% endblock %}

