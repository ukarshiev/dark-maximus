{% extends "base.html" %} 
{% block title %}dark-maximus.com{% endblock %}
{% block header_title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block header_buttons %}
    <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
    <button onclick="refreshPage()" class="button button-refresh" style="margin-right: 8px;" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏">
        <i class="fas fa-sync-alt"></i>
        –û–±–Ω–æ–≤–∏—Ç—å
    </button>
{% endblock %}

{% block content %}

<!-- –í–∫–ª–∞–¥–∫–∏ -->
<div class="tabs-container">
    <div class="tabs">
        <a href="{{ url_for('dashboard_page') }}" class="tab active">
            <i class="icon">üìä</i>
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        </a>
        <a href="{{ url_for('performance_page') }}" class="tab">
            <i class="icon">‚ö°</i>
            –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        </a>
    </div>
</div>

<section class="stats-section">
	<div class="stats-grid">
		<div class="stat-card">
			<h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
			<p class="stat-number">{{ stats.user_count or 0 }}</p>
		</div>
		<div class="stat-card">
			<h3>–í—Å–µ–≥–æ –∫–ª—é—á–µ–π</h3>
			<p class="stat-number">{{ stats.total_keys or 0 }}</p>
		</div>
		<div class="stat-card">
			<h3>–í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</h3>
			<p class="stat-number">
				{{ (stats.total_spent or 0) | round(2) }} <small>RUB</small>
			</p>
		</div>
		<div class="stat-card">
			<h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ö–æ—Å—Ç–æ–≤</h3>
			<p class="stat-number">{{ stats.host_count or 0 }}</p>
		</div>
		<div class="stat-card">
			<h3>–í—Å–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
			<p class="stat-number">{{ stats.total_notifications or 0 }}</p>
		</div>
	</div>
</section>

<!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–∞ –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É -->
<section class="analytics-section">
	<h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</h2>
	<div class="charts-grid">
		<div class="chart-container">
			<h3>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –∫–ª—é—á–∏</h3>
			<canvas id="combinedChart"></canvas>
		</div>
	</div>
</section>

<!-- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ -->
<section class="analytics-section">
	<h2>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞</h2>
	<div class="charts-grid">
		<div class="chart-container">
			<h3>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã</h3>
			<canvas id="monitoringChart"></canvas>
		</div>
	</div>
</section>

<script>
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
	document.addEventListener('DOMContentLoaded', function() {
		const combinedCtx = document.getElementById('combinedChart').getContext('2d');
		new Chart(combinedCtx, {
			type: 'line',
			data: {
				labels: {{ chart_data.dates | tojson }},
				datasets: [{
					label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
					data: {{ chart_data.new_users | tojson }},
					borderColor: '#4CAF50',
					backgroundColor: 'rgba(76, 175, 80, 0.1)',
					tension: 0.4,
					pointRadius: 4,
					pointHoverRadius: 6,
					borderWidth: 2
				}, {
					label: '–ù–æ–≤—ã–µ –∫–ª—é—á–∏',
					data: {{ chart_data.new_keys | tojson }},
					borderColor: '#2196F3',
					backgroundColor: 'rgba(33, 150, 243, 0.1)',
					tension: 0.4,
					pointRadius: 4,
					pointHoverRadius: 6,
					borderWidth: 2
				}, {
					label: '–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ (RUB)',
					data: {{ chart_data.earned_sum | tojson }},
					borderColor: '#FF9800',
					backgroundColor: 'rgba(255, 152, 0, 0.1)',
					yAxisID: 'y1',
					pointRadius: 4,
					pointHoverRadius: 6,
					borderWidth: 2
				}, {
					label: '–ù–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
					data: {{ chart_data.new_notifications | tojson }},
					borderColor: '#9C27B0',
					backgroundColor: 'rgba(156, 39, 176, 0.1)',
					tension: 0.4,
					pointRadius: 4,
					pointHoverRadius: 6,
					borderWidth: 2
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				layout: {
					padding: {
						top: 5,
						right: 5,
						bottom: 5,
						left: 5
					}
				},
				plugins: {
					legend: {
						display: true,
						position: 'top',
						labels: {
							font: {
								size: 12
							},
							usePointStyle: true,
							padding: 15
						}
					}
				},
				scales: {
					x: {
						display: true,
						title: {
							display: true,
							text: '–î–∞—Ç–∞',
							font: {
								size: 10
							}
						},
						ticks: {
							font: {
								size: 9
							},
							maxRotation: 45,
							padding: 3
						},
						grid: {
							display: true,
							drawBorder: true
						}
					},
					y: {
						display: true,
						beginAtZero: true,
						title: {
							display: true,
							text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
							font: {
								size: 10
							}
						},
						ticks: {
							font: {
								size: 9
							},
							padding: 3,
							stepSize: 1
						},
						grid: {
							display: true,
							drawBorder: true
						}
					},
					y1: {
						display: true,
						position: 'right',
						beginAtZero: true,
						title: {
							display: true,
							text: 'RUB',
							font: { size: 10 }
						}
					}
				},
				interaction: {
					intersect: false,
					mode: 'index'
				},
				elements: {
					point: {
						radius: 4,
						hoverRadius: 6
					},
					line: {
						tension: 0.4
					}
				}
			}
		});
		
		// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
		loadMonitoringChart();
	});
	
	// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
	async function loadMonitoringChart() {
		try {
			const response = await fetch('/api/monitoring/hourly-stats?hours=24');
			if (!response.ok) {
				throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞');
			}
			
			const data = await response.json();
			createMonitoringChart(data);
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:', error);
			// –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
			createMonitoringChart({
				hours: [],
				total_operations: [],
				avg_response_time: [],
				slow_operations: [],
				error_count: []
			});
		}
	}
	
	// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
	function createMonitoringChart(data) {
		const monitoringCtx = document.getElementById('monitoringChart').getContext('2d');
		new Chart(monitoringCtx, {
			type: 'line',
			data: {
				labels: data.hours || [],
				datasets: [{
					label: '–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —á–∞—Å',
					data: data.total_operations || [],
					borderColor: '#4CAF50',
					backgroundColor: 'rgba(76, 175, 80, 0.1)',
					tension: 0.4,
					pointRadius: 4,
					pointHoverRadius: 6,
					borderWidth: 2,
					yAxisID: 'y'
				}, {
					label: '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (—Å)',
					data: data.avg_response_time || [],
					borderColor: '#2196F3',
					backgroundColor: 'rgba(33, 150, 243, 0.1)',
					tension: 0.4,
					pointRadius: 4,
					pointHoverRadius: 6,
					borderWidth: 2,
					yAxisID: 'y1'
				}, {
					label: '–ú–µ–¥–ª–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —á–∞—Å',
					data: data.slow_operations || [],
					borderColor: '#FF9800',
					backgroundColor: 'rgba(255, 152, 0, 0.1)',
					tension: 0.4,
					pointRadius: 4,
					pointHoverRadius: 6,
					borderWidth: 2,
					yAxisID: 'y'
				}, {
					label: '–û—à–∏–±–æ–∫ –≤ —á–∞—Å',
					data: data.error_count || [],
					borderColor: '#F44336',
					backgroundColor: 'rgba(244, 67, 54, 0.1)',
					tension: 0.4,
					pointRadius: 4,
					pointHoverRadius: 6,
					borderWidth: 2,
					yAxisID: 'y'
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				layout: {
					padding: {
						top: 5,
						right: 5,
						bottom: 5,
						left: 5
					}
				},
				plugins: {
					legend: {
						display: true,
						position: 'top',
						labels: {
							font: {
								size: 12
							},
							usePointStyle: true,
							padding: 15
						}
					}
				},
				scales: {
					x: {
						display: true,
						title: {
							display: true,
							text: '–í—Ä–µ–º—è',
							font: {
								size: 10
							}
						},
						ticks: {
							font: {
								size: 9
							},
							maxRotation: 45,
							padding: 3
						},
						grid: {
							display: true,
							drawBorder: true
						}
					},
					y: {
						display: true,
						beginAtZero: true,
						title: {
							display: true,
							text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
							font: {
								size: 10
							}
						},
						ticks: {
							font: {
								size: 9
							},
							padding: 3,
							stepSize: 1
						},
						grid: {
							display: true,
							drawBorder: true
						}
					},
					y1: {
						display: true,
						position: 'right',
						beginAtZero: true,
						title: {
							display: true,
							text: '–°–µ–∫—É–Ω–¥—ã',
							font: { size: 10 }
						},
						ticks: {
							font: {
								size: 9
							},
							padding: 3,
							callback: function(value) {
								return value.toFixed(3) + '—Å';
							}
						}
					}
				},
				interaction: {
					intersect: false,
					mode: 'index'
				},
				elements: {
					point: {
						radius: 4,
						hoverRadius: 6
					},
					line: {
						tension: 0.4
					}
				}
			}
		});
	}
	
	// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
	function refreshPage() {
		window.location.reload();
	}
</script>

{% endblock %}