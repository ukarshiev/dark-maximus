{% extends "base.html" %} 
{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–æ—Ç–∞ –∏ –•–æ—Å—Ç–æ–≤{% endblock %}
{% block header_title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏{% endblock %}
{% block content %}


<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø–æ–¥–º–µ–Ω—é -->
    <div class="tab-navigation">
    	<button class="nav-button active" onclick="showTab('servers', this)" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤">
			<i class="fas fa-server"></i>
			–°–µ—Ä–≤–µ—Ä—ã
		</button>
    	<button class="nav-button" onclick="showTab('panel', this)" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏">
			<i class="fas fa-cog"></i>
			–ü–∞–Ω–µ–ª—å
		</button>
    	<button class="nav-button" onclick="showTab('bot', this)" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞">
			<i class="fas fa-robot"></i>
			–ë–æ—Ç
		</button>
    	<button class="nav-button" onclick="showTab('payments', this)" title="–ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã">
			<i class="fas fa-credit-card"></i>
			–ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
		</button>
    	<button class="nav-button" onclick="showTab('database', this)" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö">
			<i class="fas fa-database"></i>
			–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
		</button>
    	<button class="nav-button" onclick="showTab('backup', this)" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è">
			<i class="fas fa-save"></i>
			–ë–µ–∫–∞–ø—ã
		</button>
    	<button class="nav-button" onclick="showTab('directories', this)" title="–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏">
			<i class="fas fa-book"></i>
			–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
		</button>
    </div>

<div class="settings-container">
	
	<!-- –í–∫–ª–∞–¥–∫–∞ "–°–µ—Ä–≤–µ—Ä—ã" -->
	<div id="servers-tab" class="settings-tab active">
		<section class="settings-section">
			<div class="host-header section-top">
				<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞–º–∏</h2>
				<div class="host-actions">
					<button type="button" class="button button-primary" data-size="md" title="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä" onclick="openHostModal()">
						<i class="fas fa-plus"></i>
						–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
					</button>
				</div>
			</div>
			<form action="{{ url_for('add_host_route') }}" method="post" style="display:none" id="hiddenAddHostForm">
				<div class="form-group">
					<label for="host_name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞:</label>
					<input
						type="text"
						id="host_name"
						name="host_name"
						required
						maxlength="26"
					/>
				</div>
				<div class="form-group">
					<label for="host_url">URL –ø–∞–Ω–µ–ª–∏ XUI:</label>
					<input
						type="url"
						id="host_url"
						name="host_url"
						placeholder="http://123.45.67.89:54321"
						required
					/>
				</div>
				<div class="form-group">
					<label for="host_username">–õ–æ–≥–∏–Ω XUI:</label>
					<input
						type="text"
						id="host_username"
						name="host_username"
						required
						autocomplete="username"
					/>
				</div>
				<div class="form-group password-wrapper">
					<label for="host_pass">–ü–∞—Ä–æ–ª—å XUI:</label>
					<input type="password" id="host_pass" name="host_pass" required autocomplete="current-password" />
					<button type="button" class="toggle-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
						<i class="fas fa-eye"></i>
					</button>
				</div>
                <div class="form-group">
					<label for="host_inbound_id">ID –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</label>
					<input
						type="number"
						id="host_inbound_id"
						name="host_inbound_id"
						required
					/>
				</div>
                <div class="form-group">
                    <label for="host_code">–ö–æ–¥ 3x-ui (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π, –¥–ª—è email):</label>
                    <input type="text" id="host_code" name="host_code" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: amsterdam" />
                    <small class="text-muted">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞–¥—Ä–µ—Å–µ email –∫–ª—é—á–∞ –≤–º–µ—Å—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏—è. –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞ –±–µ–∑ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π.</small>
                </div>
				<button type="submit" class="button button-primary" data-size="md" title="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä">
					<i class="fas fa-plus"></i>
					–î–æ–±–∞–≤–∏—Ç—å
				</button>
			</form>

			{% if hosts %}
			<div class="servers-grid">
			{% for host in hosts %}
			<div class="host-card">
                <div class="host-header">
                    <h3>{{ host.host_name }}</h3>
					<div class="host-actions">
						<button class="button button-primary button-small" type="button" data-size="sm" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ" onclick="openPlanModalData(this)" data-host-name="{{ host.host_name }}">
							<i class="fas fa-plus"></i>
							–°–æ–∑–¥–∞—Ç—å —Ç–∞—Ä–∏—Ñ
						</button>
						<div class="kebab-wrapper">
							<button class="kebab-btn" onclick="toggleKebabMenu('kebab-server-{{ host.host_name }}')" title="–î–µ–π—Å—Ç–≤–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º">
								<i class="fas fa-ellipsis-v"></i>
							</button>
							<div class="kebab-menu" id="kebab-server-{{ host.host_name }}">
								<button type="button" class="kebab-item" onclick="closeKebabMenu('kebab-server-{{ host.host_name }}'); checkHost('{{ host.host_name }}')" title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º">
									<i class="fas fa-plug"></i>
									<span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</span>
								</button>
                                <button type="button" class="kebab-item" onclick="closeKebabMenu('kebab-server-{{ host.host_name }}'); openHostModalData(this)" data-host-name="{{ host.host_name }}" data-host-url="{{ host.host_url }}" data-host-username="{{ host.host_username }}" data-host-inbound-id="{{ host.host_inbound_id }}" data-host-code="{{ host.host_code or '' }}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞">
									<i class="fas fa-edit"></i>
									<span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
								</button>
								<button type="button" class="kebab-item danger" onclick="closeKebabMenu('kebab-server-{{ host.host_name }}'); deleteHost('{{ host.host_name }}')" title="–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä">
									<i class="fas fa-trash"></i>
									<span>–£–¥–∞–ª–∏—Ç—å</span>
								</button>
							</div>
						</div>
					</div>
				</div>
				<div class="plans-section">
                    {% if host.plans %}
                    <div class="plans-table-wrap">
                        <table class="plans-table" data-host-name="{{ host.host_name }}">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–°—Ä–æ–∫</th>
                                    <th>–¶–µ–Ω–∞</th>
                                    <th>–¢—Ä–∞—Ñ–∏–∫</th>
                                    <th>–†–µ–∂–∏–º</th>
                                    <th>–ì—Ä—É–ø–ø—ã</th>
                                    <th style="width:70px; text-align:right;">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plan in host.plans %}
                                {% set months = plan.get('months', 0) %}
                                {% set days = plan.get('days', 0) %}
                                {% set hours = plan.get('hours', 0) %}
                                {% set traffic = plan.get('traffic_gb', 0) %}
                                {% set provision_mode = plan.get('key_provision_mode', 'key') %}
                                {% set display_mode = plan.get('display_mode', 'all') %}
                                {% set display_mode_groups = plan.get('display_mode_groups') or [] %}
                                {% set display_mode_groups_str = display_mode_groups|map('string')|join(',') if display_mode_groups else '' %}
                                <tr class="plan-row"
                                    data-plan-id="{{ plan.plan_id }}"
                                    data-plan-name="{{ plan.plan_name }}"
                                    data-plan-months="{{ months }}"
                                    data-plan-days="{{ days }}"
                                    data-plan-price="{{ plan.price }}"
                                    data-plan-hours="{{ hours }}"
                                    data-plan-traffic="{{ traffic }}"
                                    data-plan-provision-mode="{{ provision_mode }}"
                                    data-plan-display-mode="{{ display_mode }}"
                                    data-plan-display-mode-groups="{{ display_mode_groups_str }}"
                                    data-host-name="{{ host.host_name }}"
                                >
                                    <td title="–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–∞—Ä–∏—Ñ–∞">{{ plan.plan_id }}</td>
                                    <td>{{ plan.plan_name }}</td>
                                    <td>
                                        {% if months and months|int > 0 %}{{ months }} –º–µ—Å{% endif %}
                                        {% if days and days|int > 0 %}{% if months and months|int > 0 %} ¬∑ {% endif %}{{ days }} –¥–Ω{% endif %}
                                        {% if hours and hours|int > 0 %}{% if (months and months|int > 0) or (days and days|int > 0) %} ¬∑ {% endif %}{{ hours }} —á{% endif %}
                                        {% if (not months or months|int == 0) and (not days or days|int == 0) and (not hours or hours|int == 0) %}‚Äî{% endif %}
                                    </td>
                                    <td>{{ plan.price|round(0) }} RUB</td>
                                    <td>{{ traffic and (traffic|round(2) ~ ' –ì–ë') or '‚àû' }}</td>
                                    <td title="–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞">
                                        {% if display_mode == 'all' %}
                                            <span style="color: #4CAF50;">üëÅÔ∏è –í—Å–µ–º</span>
                                        {% elif display_mode == 'hidden_all' %}
                                            <span style="color: #f44336;">üö´ –°–∫—Ä—ã—Ç</span>
                                        {% elif display_mode == 'hidden_new' %}
                                            <span style="color: #ff9800;">üÜï –°–∫—Ä—ã—Ç —É –Ω–æ–≤—ã—Ö</span>
                                        {% elif display_mode == 'hidden_old' %}
                                            <span style="color: #2196F3;">üë¥ –°–∫—Ä—ã—Ç —É —Å—Ç–∞—Ä—ã—Ö</span>
                                        {% endif %}
                                    </td>
                                    <td title="–ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
                                        {% if display_mode_groups and display_mode_groups|length > 0 %}
                                            {% set group_names = [] %}
                                            {% for group_id in display_mode_groups %}
                                                {% for g in user_groups %}
                                                    {% if g.group_id == group_id %}
                                                        {% set _ = group_names.append(g.group_name) %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                            {% if group_names|length > 0 %}
                                                <span style="color: #008771;">üë• {{ group_names|join(', ') }}</span>
                                            {% else %}
                                                <span style="color: #888;">‚Äî</span>
                                            {% endif %}
                                        {% else %}
                                            <span style="color: #888;">–í—Å–µ</span>
                                        {% endif %}
                                    </td>
								<td style="text-align:right; position:relative;">
								<div class="kebab-wrapper">
									<button class="kebab-btn" onclick="toggleKebabMenu('kebab-plan-{{ plan.plan_id }}')" title="–î–µ–π—Å—Ç–≤–∏—è —Å —Ç–∞—Ä–∏—Ñ–æ–º">
										<i class="fas fa-ellipsis-v"></i>
									</button>
									<div class="kebab-menu" id="kebab-plan-{{ plan.plan_id }}">
                                            <button type="button" class="kebab-item"
                                                onclick="closeKebabMenu('kebab-plan-{{ plan.plan_id }}'); openPlanModalData(this)"
                                                data-plan-id="{{ plan.plan_id }}" data-plan-name="{{ plan.plan_name }}" data-plan-months="{{ months }}" data-plan-days="{{ days }}" data-plan-hours="{{ hours }}" data-plan-price="{{ plan.price }}" data-plan-traffic="{{ traffic }}" data-plan-provision-mode="{{ provision_mode }}" data-plan-display-mode="{{ display_mode }}" data-plan-display-mode-groups="{{ display_mode_groups_str }}" data-host-name="{{ host.host_name }}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞—Ä–∏—Ñ">
												<i class="fas fa-edit"></i>
												<span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
											</button>
											<button type="button" class="kebab-item danger" onclick="closeKebabMenu('kebab-plan-{{ plan.plan_id }}'); deletePlan('{{ plan.plan_id }}')" title="–£–¥–∞–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ">
												<i class="fas fa-trash"></i>
												<span>–£–¥–∞–ª–∏—Ç—å</span>
											</button>
										</div>
									</div>
								</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p>–¢–∞—Ä–∏—Ñ—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>
                    {% endif %}
                    <h5 style="display:none">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ:</h5>
				</div>
			</div>
			{% endfor %}
			</div>
			{% else %}
			<p>–•–æ—Å—Ç—ã –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>
			{% endif %}
		</section>
	</div>

	<!-- –í–∫–ª–∞–¥–∫–∞ "–ü–∞–Ω–µ–ª—å" -->
	<div id="panel-tab" class="settings-tab">
		<form action="{{ url_for('save_panel_settings') }}" method="post" role="form" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏" data-form-purpose="panel-settings" novalidate>
			<fieldset>
				<legend>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏</legend>
				<section class="settings-section">
					<h2>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
				<div class="form-group">
					<label for="global_domain">–î–æ–º–µ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</label>
					<div class="input-with-button">
						<input
							type="url"
							id="global_domain"
							name="global_domain"
							value="{{ settings.global_domain or '' }}"
							placeholder="https://your-domain.com"
							title="–û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫"
						/>
						<button type="button" class="button button-secondary button-sm" onclick="openDomain('global_domain')" title="–û—Ç–∫—Ä—ã—Ç—å –¥–æ–º–µ–Ω –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ">
							<i class="fas fa-external-link-alt"></i>
						</button>
					</div>
					<small class="text-muted">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫ –≤ –±–æ—Ç–µ, TON Connect –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –∏ –¥—Ä—É–≥–∏—Ö –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ö</small>
				</div>
				<div class="form-group">
					<label for="docs_domain">–î–æ–º–µ–Ω docs –¥–ª—è –í–∏–∫–∏:</label>
					<div class="input-with-button">
						<input
							type="url"
							id="docs_domain"
							name="docs_domain"
							value="{{ settings.docs_domain or '' }}"
							placeholder="https://docs.dark-maximus.com"
							title="–î–æ–º–µ–Ω –¥–ª—è Wiki –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
						/>
						<button type="button" class="button button-secondary button-sm" onclick="openDomain('docs_domain')" title="–û—Ç–∫—Ä—ã—Ç—å –¥–æ–º–µ–Ω –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ">
							<i class="fas fa-external-link-alt"></i>
						</button>
					</div>
					<small class="text-muted">–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è localhost:3001</small>
				</div>
				<div class="form-group">
					<label for="codex_docs_domain">–î–æ–º–µ–Ω codex-docs –¥–ª—è –ë–∞–∑—ã –∑–Ω–∞–Ω–∏–π:</label>
					<div class="input-with-button">
						<input
							type="url"
							id="codex_docs_domain"
							name="codex_docs_domain"
							value="{{ settings.codex_docs_domain or '' }}"
							placeholder="https://help.dark-maximus.com"
							title="–î–æ–º–µ–Ω –¥–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π"
						/>
						<button type="button" class="button button-secondary button-sm" onclick="openDomain('codex_docs_domain')" title="–û—Ç–∫—Ä—ã—Ç—å –¥–æ–º–µ–Ω –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ">
							<i class="fas fa-external-link-alt"></i>
						</button>
					</div>
					<small class="text-muted">–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è localhost:3002</small>
				</div>
				<div class="form-group">
					<label for="admin_timezone">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–∞–Ω–µ–ª–∏:</label>
					<select id="admin_timezone" name="admin_timezone" title="–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è">
						{% for tz_name, tz_label, _ in timezone_options %}
							<option value="{{ tz_name }}" {% if (settings.admin_timezone or 'Europe/Moscow') == tz_name %}selected{% endif %}>{{ tz_label }}</option>
						{% endfor %}
					</select>
					<small class="text-muted">–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç –∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö.</small>
				</div>
			</section>
			
			<section class="settings-section">
				<h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–∞–Ω–µ–ª–∏</h2>
				<div class="form-group">
					<label for="panel_login">–õ–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ø–∞–Ω–µ–ª—å:</label>
					<input
						type="text"
						id="panel_login"
						name="panel_login"
						value="{{ settings.panel_login or '' }}"
						required
						title="–õ–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–Ω–µ–ª—å"
						autocomplete="username"
					/>
				</div>
				<div class="form-group password-wrapper">
					<label for="panel_password"
						>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å):</label
					>
					<input type="password" id="panel_password" name="panel_password" title="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ø–∞–Ω–µ–ª—å" autocomplete="new-password" />
					<button type="button" class="toggle-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
						<i class="fas fa-eye"></i>
					</button>
				</div>
			</section>
			
			<section class="settings-section">
				<h2>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è</h2>
				<div class="form-group">
					<label class="checkbox-label" for="auto_delete_orphans" title="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –ø–∞–Ω–µ–ª—è—Ö, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞">
						<input
							type="checkbox"
							id="auto_delete_orphans"
							name="auto_delete_orphans"
							value="true"
							{% if settings.auto_delete_orphans == 'true' %}checked{% endif %}
						/>
						<span>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å orphan clients</span>
					</label>
					<small class="text-muted">
						–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –±–æ—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –ø–∞–Ω–µ–ª—è—Ö XUI, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞. 
						–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å inbound'–∞–º–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º–∏ –∫ —Ö–æ—Å—Ç–∞–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–æ—Ç–∞.
					</small>
				</div>
				<div class="form-group mt-3">
					<a href="{{ url_for('orphan_deletions_log') }}" class="button button-secondary" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å –ª–æ–≥ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö orphan –∫–ª–∏–µ–Ω—Ç–æ–≤">
						<i class="fas fa-list-alt"></i>
						–õ–æ–≥ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
					</a>
					<small class="text-muted d-block mt-2">
						<i class="fas fa-info-circle"></i>
						–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö orphan –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –ø–∞–Ω–µ–ª–µ–π XUI.
					</small>
				</div>
			</section>

			<section class="settings-section">
				<h2>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h2>
				<div class="form-group">
					<label class="checkbox-label" for="monitoring_enabled" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞">
						<input type="hidden" name="monitoring_enabled" value="false" />
						<input type="checkbox" id="monitoring_enabled" name="monitoring_enabled" value="true" {% if settings.monitoring_enabled == 'true' or settings.monitoring_enabled is none %}checked{% endif %} />
						<span>–í–∫–ª—é—á–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</span>
					</label>
				</div>
				<div class="form-group">
					<label for="monitoring_max_metrics">–ú–∞–∫—Å–∏–º—É–º –º–µ—Ç—Ä–∏–∫ –≤ –ø–∞–º—è—Ç–∏:</label>
					<input type="number" id="monitoring_max_metrics" name="monitoring_max_metrics" min="100" step="100" value="{{ settings.monitoring_max_metrics or 1000 }}" title="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö –º–µ—Ç—Ä–∏–∫ –≤ –ø–∞–º—è—Ç–∏" />
				</div>
				<div class="form-group">
					<label for="monitoring_slow_threshold">–ü–æ—Ä–æ–≥ –º–µ–¥–ª–µ–Ω–Ω–æ—Å—Ç–∏ (—Å–µ–∫):</label>
					<input type="number" id="monitoring_slow_threshold" name="monitoring_slow_threshold" min="0.1" step="0.1" value="{{ settings.monitoring_slow_threshold or 1.0 }}" title="–ó–∞–ø—Ä–æ—Å—ã –¥–æ–ª—å—à–µ –ø–æ—Ä–æ–≥–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏" />
				</div>
				<div class="form-group">
					<label for="monitoring_cleanup_hours">–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç—Ä–∏–∫:</label>
					<select id="monitoring_cleanup_hours" name="monitoring_cleanup_hours" title="–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–µ –º–µ—Ç—Ä–∏–∫–∏">
						{% set opts = ['0.5','1','2','6','12','24'] %}
						{% for h in opts %}
							<option value="{{ h }}" {% if (settings.monitoring_cleanup_hours or '24') == h %}selected{% endif %}>{{ h }} —á</option>
						{% endfor %}
					</select>
				</div>
				<div class="form-group">
					<a href="/api/monitoring/export" class="button" title="–°–∫–∞—á–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ JSON" target="_blank">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ (JSON)</a>
				</div>
			</section>
			
			<button type="submit" class="button button-primary" data-size="md" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏">
				<i class="fas fa-save"></i>
				–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏
			</button>
			</fieldset>
		</form>
	</div>

	<!-- –í–∫–ª–∞–¥–∫–∞ "–ë–æ—Ç" -->
	<div id="bot-tab" class="settings-tab">
		<form action="{{ url_for('save_bot_settings') }}" method="post" role="form" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–æ–≤" data-form-purpose="bot-settings" novalidate>
			<fieldset>
				<legend>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–æ–≤</legend>
				<section class="settings-section">
					<h2>–ë–æ—Ç –º–∞–≥–∞–∑–∏–Ω–∞</h2>
			<div class="form-group password-wrapper">
				<label for="telegram_bot_token">–¢–æ–∫–µ–Ω –±–æ—Ç–∞:</label>
				<input
					type="password"
					id="telegram_bot_token"
					name="telegram_bot_token"
					autocomplete="new-password"
					value="{{ settings.telegram_bot_token or '' }}"
					required
				/>
				<button type="button" class="toggle-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
					<i class="fas fa-eye"></i>
				</button>
			</div>
			<div class="form-group">
				<label for="telegram_bot_username">Username –±–æ—Ç–∞ (–±–µ–∑ @):</label>
				<input
					type="text"
					id="telegram_bot_username"
					name="telegram_bot_username"
					value="{{ hidden_mode and '' or (settings.telegram_bot_username or '') }}"
					required
				/>
			</div>
			<div class="form-group">
				<label for="admin_telegram_id">Telegram ID –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</label>
				<input
					type="text"
					id="admin_telegram_id"
					name="admin_telegram_id"
					value="{{ hidden_mode and '' or (settings.admin_telegram_id or '') }}"
					required
				/>
			</div>
		</section>
		<section class="settings-section">
			<h2>–ë–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h2>
            <div class="form-group form-group-checkbox">
                <input type="hidden" name="support_enabled" value="false" />
                <input type="checkbox" id="support_enabled" name="support_enabled" value="true" {% if settings.support_enabled == 'true' %}checked{% endif %}>
                <label for="support_enabled">–í–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</label>
            </div>
			<div class="form-group">
				<label for="support_user">URL –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–ª–∏ –ë–æ—Ç–∞-–°–∞–ø–ø–æ—Ä—Ç–∞:</label>
				<input
					type="text"
					id="support_user"
					name="support_user"
					value="{{ settings.support_user or '' }}"
					placeholder="@username –∏–ª–∏ https://t.me/username"
				/>
			</div>
			<div class="form-group password-wrapper">
				<label for="support_bot_token"
					>–¢–æ–∫–µ–Ω Support-–±–æ—Ç–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):</label
				>
				<input
					type="password"
					id="support_bot_token"
					name="support_bot_token"
					autocomplete="new-password"
					value="{{ settings.support_bot_token or '' }}"
				/>
				<button type="button" class="toggle-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
					<i class="fas fa-eye"></i>
				</button>
			</div>
			<div class="form-group">
				<label for="support_group_id"
					>ID –ì—Ä—É–ø–ø—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä—É–º–∞
					(Topics)):</label
				>
				<input
					type="text"
					id="support_group_id"
					name="support_group_id"
					value="{{ settings.support_group_id or '' }}"
				/>
			</div>
			<div class="form-group" style="margin-top: 20px;">
				<label style="display: block; margin-bottom: 10px; font-weight: 600;">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏:</label>
				<div style="display: flex; gap: 10px; flex-wrap: wrap;">
					<button type="button" class="button button-secondary" onclick="checkSupportConfig(event)" title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (ID –≥—Ä—É–ø–ø—ã, —Ç–æ–∫–µ–Ω, —Ç–µ–º—ã)">
						<i class="fas fa-cog"></i>
						–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
					</button>
					<button type="button" class="button button-secondary" onclick="testSupportBot()" title="–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–¥–æ—Å—Ç—É–ø –∫ –≥—Ä—É–ø–ø–µ, –ø—Ä–∞–≤–∞, –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è)">
						<i class="fas fa-vial"></i>
						–¢–µ—Å—Ç –±–æ—Ç–∞
					</button>
				</div>
				<div id="support-diagnostic-result" style="margin-top: 15px;"></div>
			</div>
		</section>
		<section class="settings-section">
			<h2>–ë–æ—Ç –¥–ª—è –ª–æ–≥–æ–≤</h2>
			<p class="text-muted" style="margin-bottom: 15px;">
				–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–æ–≤ –æ—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –≤ Telegram.
				–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –±—ã—Å—Ç—Ä–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ —Å–∏—Å—Ç–µ–º–µ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤.
			</p>
			<div class="form-group password-wrapper">
				<label for="logging_bot_token">–¢–æ–∫–µ–Ω –±–æ—Ç–∞:</label>
				<input
					type="password"
					id="logging_bot_token"
					name="logging_bot_token"
					autocomplete="new-password"
					value="{{ settings.logging_bot_token or '' }}"
					placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz"
					title="–¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–æ–≤"
				/>
				<button type="button" class="toggle-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
					<i class="fas fa-eye"></i>
				</button>
			</div>
			<div class="form-group">
				<label for="logging_bot_username">Username –±–æ—Ç–∞ (–±–µ–∑ @):</label>
				<input
					type="text"
					id="logging_bot_username"
					name="logging_bot_username"
					value="{{ settings.logging_bot_username or '' }}"
					placeholder="my_logging_bot"
					title="Username –±–æ—Ç–∞ –¥–ª—è –ª–æ–≥–æ–≤"
				/>
			</div>
			<div class="form-group">
				<label for="logging_bot_admin_chat_id">Telegram ID –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</label>
				<input
					type="text"
					id="logging_bot_admin_chat_id"
					name="logging_bot_admin_chat_id"
					value="{{ settings.logging_bot_admin_chat_id or '' }}"
					placeholder="123456789"
					title="ID —á–∞—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –∫—É–¥–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ª–æ–≥–∏"
				/>
				<small class="text-muted">–£–∑–Ω–∞—Ç—å —Å–≤–æ–π ID –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ @userinfobot</small>
			</div>
			<div class="form-group">
				<label for="logging_bot_level">–£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–æ–≤:</label>
				<select
					id="logging_bot_level"
					name="logging_bot_level"
					title="–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"
				>
					<option value="none" {% if settings.logging_bot_level == 'none' %}selected{% endif %}>none - –û—Ç–∫–ª—é—á–µ–Ω–æ</option>
					<option value="error" {% if settings.logging_bot_level == 'error' or not settings.logging_bot_level %}selected{% endif %}>error - –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏</option>
					<option value="warning" {% if settings.logging_bot_level == 'warning' %}selected{% endif %}>warning - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏</option>
					<option value="all" {% if settings.logging_bot_level == 'all' %}selected{% endif %}>–≤—Å–µ –ª–æ–≥–∏ - –í—Å–µ (–≤–∫–ª—é—á–∞—è warning –∏ error)</option>
				</select>
				<small class="text-muted">
					‚Ä¢ none - –±–æ—Ç –æ—Ç–∫–ª—é—á–µ–Ω<br>
					‚Ä¢ error - –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏<br>
					‚Ä¢ warning - –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏<br>
					‚Ä¢ –≤—Å–µ –ª–æ–≥–∏ - –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤—Å–µ –ª–æ–≥–∏ (–≤–∫–ª—é—á–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ)
				</small>
			</div>
			<div class="form-group" style="margin-top: 20px;">
				<button type="button" class="button button-secondary" onclick="testLoggingBot()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–æ—Ç–∞ –ª–æ–≥–æ–≤">
					<i class="fas fa-paper-plane"></i>
					–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
				</button>
			</div>
		</section>
		<section class="settings-section">
			<h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ö–æ–Ω—Ç–µ–Ω—Ç–∞</h2>
			<div class="form-group">
				<div class="form-group-header">
					<label for="about_content">–û –ø—Ä–æ–µ–∫—Ç–µ</label>
					<button type="button" class="button button-primary button-small button-icon" onclick="openContentModalWithAutoSave('about_content', '–¢–µ–∫—Å—Ç –û –ø—Ä–æ–µ–∫—Ç–µ', 'textarea')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –æ –ø—Ä–æ–µ–∫—Ç–µ">
						<i class="fas fa-edit"></i>
					</button>
				</div>
				<textarea id="about_content" name="about_content" class="textarea-small" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ –ø—Ä–æ–µ–∫—Ç–µ" readonly>{{ about_content or '' }}</textarea>
			</div>
			<div class="form-group">
				<div class="form-group-header">
					<label for="support_content">–ü–æ–º–æ—â—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞</label>
					<button type="button" class="button button-primary button-small button-icon" onclick="openContentModalWithAutoSave('support_content', '–¢–µ–∫—Å—Ç –≤ —Ä–∞–∑–¥–µ–ª–µ –ü–æ–¥–¥–µ—Ä–∂–∫–∞', 'textarea')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏">
						<i class="fas fa-edit"></i>
					</button>
				</div>
				<textarea id="support_content" name="support_content" class="textarea-small" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏" readonly>{{ support_content or '' }}</textarea>
			</div>
			<div class="form-group">
				<label for="terms_content">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</label>
				<div class="content-field-wrapper">
					<input type="url" id="terms_content" name="terms_content" value="{{ terms_content or '' }}" placeholder="https://example.com/terms" readonly>
				<button type="button" class="button button-primary button-small button-icon" onclick="openHtmlEditor('terms')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É—Å–ª–æ–≤–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è">
					<i class="fas fa-code"></i>
				</button>
				</div>
			</div>
			<div class="form-group">
				<label for="privacy_content">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</label>
				<div class="content-field-wrapper">
					<input type="url" id="privacy_content" name="privacy_content" value="{{ privacy_content or '' }}" placeholder="https://example.com/privacy" readonly>
				<button type="button" class="button button-primary button-small button-icon" onclick="openHtmlEditor('privacy')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏">
					<i class="fas fa-code"></i>
				</button>
				</div>
			</div>
			<div class="form-group">
				<label for="channel_url"
					>Telegram-–∫–∞–Ω–∞–ª</label
				>
				<input
					type="url"
					id="channel_url"
					name="channel_url"
					value="{{ settings.channel_url or '' }}"
				/>
			</div>
			<div class="form-group form-group-checkbox">
				<input type="hidden" name="force_subscription" value="false" />
				<input type="checkbox" id="force_subscription"
				name="force_subscription" value="true" {% if
				settings.force_subscription == 'true' %}checked{% endif %}>
				<label for="force_subscription"
					>–¢—Ä–µ–±–æ–≤–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª</label
				>
			</div>
		</section>
		<section class="settings-section">
			<h2>–ü–ª–∞—Ç–µ–∂–∏ –≤ –±–æ—Ç–µ</h2>
			<div class="form-group">
				<label for="minimum_topup">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (RUB):</label>
				<input type="number" step="1" id="minimum_topup" name="minimum_topup" value="{{ settings.minimum_topup or '50' }}" />
				<small class="text-muted">–≠—Ç–∞ —Å—É–º–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–≤–µ—Ä–∫–µ "–í–≤–µ—Å—Ç–∏ –¥—Ä—É–≥—É—é —Å—É–º–º—É".</small>
			</div>
		</section>
		<section class="settings-section">
			<h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ü—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞</h2>
			<div class="form-group form-group-checkbox">
				<input type="hidden" name="trial_enabled" value="false" />
				<input type="checkbox" id="trial_enabled" name="trial_enabled"
				value="true" {% if settings.trial_enabled == 'true' %}checked{% endif
				%}>
				<label for="trial_enabled">–í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥</label>
			</div>
			<div class="form-group">
				<label for="trial_duration_days"
					>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (–≤ –¥–Ω—è—Ö):</label
				>
				<input
					type="number"
					id="trial_duration_days"
					name="trial_duration_days"
					value="{{ settings.trial_duration_days or '3' }}"
				/>
			</div>
		</section>
		<section class="settings-section">
			<h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã</h2>
			<div class="form-group form-group-checkbox">
				<input type="hidden" name="enable_referrals" value="false" />
				<input type="checkbox" id="enable_referrals" name="enable_referrals"
				value="true" {% if settings.enable_referrals == 'true' %}checked{%
				endif %}>
				<label for="enable_referrals">–í–∫–ª—é—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É</label>
			</div>
			<div class="form-group">
				<label for="minimum_withdrawal">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞:</label>
				<input
					type="number"
					id="minimum_withdrawal"
					name="minimum_withdrawal"
					value="{{ settings.minimum_withdrawal or '10' }}"
				/>
			</div>
			<div class="form-group">
				<label for="referral_percentage"
					>–ü—Ä–æ—Ü–µ–Ω—Ç –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–º—É (%):</label
				>
				<input
					type="number"
					id="referral_percentage"
					name="referral_percentage"
					value="{{ settings.referral_percentage or '10' }}"
				/>
			</div>
			<div class="form-group">
				<label for="referral_discount"
					>–°–∫–∏–¥–∫–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø–µ—Ä–≤—É—é –ø–æ–∫—É–ø–∫—É (%):</label
				>
				<input
					type="number"
					id="referral_discount"
					name="referral_discount"
					value="{{ settings.referral_discount or '5' }}"
				/>
			</div>
		</section>
			
			<button type="submit" class="button button-primary" data-size="md" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞">
				<i class="fas fa-save"></i>
				–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
			</button>
			</fieldset>
		</form>
	</div>

	<!-- –í–∫–ª–∞–¥–∫–∞ "–ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã" -->
	<div id="payments-tab" class="settings-tab">
		<form action="{{ url_for('save_payment_settings') }}" method="post" role="form" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º" data-form-purpose="payment-settings" novalidate>
			<fieldset>
				<legend>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º</legend>
				<section class="settings-section">
					<h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–ª–∞—Ç–µ–∂–Ω—ã—Ö –°–∏—Å—Ç–µ–º</h2>
				<div class="payment-systems-grid">
					<!-- –ö–æ–ª–æ–Ω–∫–∞ 1 -->
					<div class="payment-column">
						<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Stars -->
						<div class="payment-system-card">
							<h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Stars</h3>
							<div class="form-group form-group-checkbox">
								<input type="hidden" name="stars_enabled" value="false" />
								<input type="checkbox" id="stars_enabled" name="stars_enabled"
								value="true" {% if settings.stars_enabled == 'true' %}checked{% endif %}>
								<label for="stars_enabled">–í–∫–ª—é—á–∏—Ç—å –æ–ø–ª–∞—Ç—É –∑–≤–µ–∑–¥–∞–º–∏ Telegram</label>
							</div>
							<div class="form-group">
								<label for="stars_conversion_rate">–ö—É—Ä—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ (—Ä—É–±–ª–µ–π –∑–∞ 1 –∑–≤–µ–∑–¥—É):</label>
								<div style="display: flex; gap: 10px; align-items: center;">
									<input
										type="number"
										step="0.01"
										id="stars_conversion_rate"
										name="stars_conversion_rate"
										value="{{ settings.stars_conversion_rate or '1.79' }}"
										placeholder="1.79"
										style="flex: 1;"
										title="–ö—É—Ä—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ä—É–±–ª–µ–π –≤ –∑–≤–µ–∑–¥—ã Telegram"
									/>
									<button type="button" onclick="updateStarsRate()" class="button button-small" style="white-space: nowrap;" title="–û–±–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å –¥–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è">
										üîÑ –û–±–Ω–æ–≤–∏—Ç—å
									</button>
								</div>
								<small class="text-muted">
									üí° <strong>–ö–∞–∫ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å:</strong><br>
									‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫—É—Ä—Å –≤ Telegram: 100 –∑–≤–µ–∑–¥ = 179 —Ä—É–±–ª–µ–π<br>
									‚Ä¢ –ó–Ω–∞—á–∏—Ç 1 –∑–≤–µ–∑–¥–∞ = 1.79 —Ä—É–±–ª–µ–π<br>
									‚Ä¢ –≠—Ç–æ—Ç –∫—É—Ä—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏<br>
									‚Ä¢ –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å" —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å (1.79)
								</small>
							</div>
						</div>

						<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TonConnect -->
						<div class="payment-system-card">
							<h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ TonConnect</h3>
							<div class="form-group">
								<label for="ton_wallet_address">Ton Wallet:</label>
								<input
									type="text"
									id="ton_wallet_address"
									name="ton_wallet_address"
									value="{{ settings.ton_wallet_address or '' }}"
								/>
							</div>
							<div class="form-group password-wrapper">
								<label for="tonapi_key">TonAPI Key:</label>
								<input
									type="password"
									id="tonapi_key"
									name="tonapi_key"
									autocomplete="new-password"
									value="{{ settings.tonapi_key or '' }}"
								/>
								<button type="button" class="toggle-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
									<i class="fas fa-eye"></i>
								</button>
							</div>
							<div class="form-group">
								<label for="ton_manifest_url">Ton manifest:</label>
								<div class="content-field-wrapper">
									<input
										type="url"
										id="ton_manifest_url"
										name="ton_manifest_url"
										value="{{ (settings.global_domain or settings.domain or 'https://panel.dark-maximus.com') + '/.well-known/tonconnect-manifest.json' }}"
										placeholder="https://example.com/.well-known/tonconnect-manifest.json"
										readonly
									/>
									<button type="button" class="button button-primary button-small button-icon" onclick="openTonManifest()" title="–ü–µ—Ä–µ–π—Ç–∏ –∫ –º–∞–Ω–∏—Ñ–µ—Å—Ç—É TON Connect">
										<i class="fas fa-external-link-alt"></i>
									</button>
									<button type="button" class="button button-primary button-small button-icon" onclick="openTonManifestEditor()" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç TON Connect">
										<i class="fas fa-edit"></i>
									</button>
								</div>
							</div>
						</div>
					</div>

					<!-- –ö–æ–ª–æ–Ω–∫–∞ 2 -->
					<div class="payment-column">
						<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ YooKassa -->
						<div class="payment-system-card">
							<h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ YooKassa</h3>
							
							<!-- –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
							<div class="form-group form-group-checkbox">
								<input type="hidden" name="sbp_enabled" value="false" />
								<input type="checkbox" id="sbp_enabled" name="sbp_enabled"
								value="true" {% if settings.sbp_enabled == 'true' %}checked{% endif
								%}>
								<label for="sbp_enabled">–í–∫–ª—é—á–∏—Ç—å –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ –°–ë–ü</label>
							</div>
							
							<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ YooKassa -->
							<div class="form-group form-group-toggle">
								<div class="toggle-container">
									<label for="yookassa_test_mode" class="toggle-label-text">
										<span id="mode-label-text">
											{% if settings.yookassa_test_mode == 'false' %}
												–†–µ–∂–∏–º: –ë–æ–µ–≤–æ–π ON
											{% else %}
												–†–µ–∂–∏–º: –ë–æ–µ–≤–æ–π OFF, –¢–µ—Å—Ç–æ–≤—ã–π ON
											{% endif %}
										</span>
									</label>
									<label class="modern-toggle">
										<input type="hidden" name="yookassa_test_mode" value="true" />
										<input type="checkbox" id="yookassa_test_mode" name="yookassa_test_mode"
										value="false" {% if settings.yookassa_test_mode == 'false' %}checked{% endif
										%} onchange="toggleYooKassaMode()">
										<span class="toggle-slider"></span>
									</label>
								</div>
							</div>
							
							<div class="form-group">
								<label for="receipt_email">–ü–æ—á—Ç–∞ –¥–ª—è —á–µ–∫–æ–≤:</label>
								<input
									type="text"
									id="receipt_email"
									name="receipt_email"
									value="{{ settings.receipt_email or '' }}"
									title="Email –∞–¥—Ä–µ—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–æ–≤"
								/>
							</div>
							
							<!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
							<div class="settings-divider"></div>
							
							<!-- –ë–æ–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
							<h4 style="color: #e74c3c; margin: 20px 0 15px 0; font-size: 16px;">üî¥ –ë–æ–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
							
							<div class="form-group">
								<label for="yookassa_api_url">API URL:</label>
								<input
									type="text"
									id="yookassa_api_url"
									name="yookassa_api_url"
									value="{{ settings.yookassa_api_url or 'https://api.yookassa.ru/v3' }}"
									placeholder="https://api.yookassa.ru/v3"
									title="–ë–∞–∑–æ–≤—ã–π URL API YooKassa –¥–ª—è –±–æ–µ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞"
								/>
							</div>
							
							<div class="form-group">
								<input type="checkbox" id="yookassa_verify_ssl" name="yookassa_verify_ssl" value="true" {% if (settings.yookassa_verify_ssl or 'true') == 'true' %}checked{% endif %}>
								<label for="yookassa_verify_ssl">–ü—Ä–æ–≤–µ—Ä—è—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</label>
							</div>
							
							<div class="form-group">
								<label for="yookassa_shop_id">Shop ID:</label>
								<input
									type="text"
									id="yookassa_shop_id"
									name="yookassa_shop_id"
									value="{{ settings.yookassa_shop_id or '' }}"
									title="–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ –≤ YooKassa"
								/>
							</div>
							
							<div class="form-group password-wrapper">
								<label for="yookassa_secret_key">Secret Key:</label>
								<input
									type="password"
									id="yookassa_secret_key"
									name="yookassa_secret_key"
									autocomplete="new-password"
									value="{{ settings.yookassa_secret_key or '' }}"
									title="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è API YooKassa"
								/>
								<button type="button" class="toggle-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
									<i class="fas fa-eye"></i>
								</button>
							</div>
							
							<!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
							<div class="settings-divider"></div>
							
							<!-- –¢–µ—Å—Ç–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
							<h4 style="color: #f39c12; margin: 20px 0 15px 0; font-size: 16px;">üß™ –¢–µ—Å—Ç–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
							
							<div class="form-group">
								<label for="yookassa_test_api_url">API URL (—Ç–µ—Å—Ç):</label>
								<input
									type="text"
									id="yookassa_test_api_url"
									name="yookassa_test_api_url"
									value="{{ settings.yookassa_test_api_url or 'https://api.test.yookassa.ru/v3' }}"
									placeholder="https://api.test.yookassa.ru/v3"
									title="–ë–∞–∑–æ–≤—ã–π URL API YooKassa –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞"
								/>
							</div>
							
							<div class="form-group">
								<input type="checkbox" id="yookassa_test_verify_ssl" name="yookassa_test_verify_ssl" value="true" {% if (settings.yookassa_test_verify_ssl or 'false') == 'true' %}checked{% endif %}>
								<label for="yookassa_test_verify_ssl">–ü—Ä–æ–≤–µ—Ä—è—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (—Ç–µ—Å—Ç)</label>
							</div>
							
							<div class="form-group">
								<label for="yookassa_test_shop_id">Shop ID (—Ç–µ—Å—Ç):</label>
								<input
									type="text"
									id="yookassa_test_shop_id"
									name="yookassa_test_shop_id"
									value="{{ settings.yookassa_test_shop_id or '' }}"
									title="–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –≤ YooKassa"
								/>
							</div>
							
							<div class="form-group password-wrapper">
								<label for="yookassa_test_secret_key">Test Secret Key (—Ç–µ—Å—Ç):</label>
								<input
									type="password"
									id="yookassa_test_secret_key"
									name="yookassa_test_secret_key"
									autocomplete="new-password"
									value="{{ settings.yookassa_test_secret_key or '' }}"
									title="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ API YooKassa"
								/>
								<button type="button" class="toggle-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
									<i class="fas fa-eye"></i>
								</button>
							</div>
						</div>
					</div>

					<!-- –ö–æ–ª–æ–Ω–∫–∞ 3 -->
					<div class="payment-column">
						<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CryptoBot -->
						<div class="payment-system-card">
							<h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ CryptoBot</h3>
							<div class="form-group password-wrapper">
								<label for="cryptobot_token">CryptoBot Token:</label>
								<input
									type="password"
									id="cryptobot_token"
									name="cryptobot_token"
									autocomplete="new-password"
									value="{{ settings.cryptobot_token or '' }}"
								/>
								<button type="button" class="toggle-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
									<i class="fas fa-eye"></i>
								</button>
							</div>
						</div>

						<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Heleket -->
						<div class="payment-system-card">
							<h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Heleket</h3>
							<div class="form-group">
								<label for="heleket_merchant_id">Heleket Merchant ID:</label>
								<input
									type="text"
									id="heleket_merchant_id"
									name="heleket_merchant_id"
									value="{{ settings.heleket_merchant_id or '' }}"
								/>
							</div>
							<div class="form-group password-wrapper">
								<label for="heleket_api_key">Heleket API Key:</label>
								<input
									type="password"
									id="heleket_api_key"
									name="heleket_api_key"
									autocomplete="new-password"
									value="{{ settings.heleket_api_key or '' }}"
								/>
								<button type="button" class="toggle-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
									<i class="fas fa-eye"></i>
								</button>
							</div>
							<div class="form-group">
								<label for="domain">–í–∞—à –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, my-shop.com):</label>
								<input
									type="text"
									id="domain"
									name="domain"
									value="{{ settings.domain or '' }}"
								/>
							</div>
						</div>
					</div>
				</div>
			</section>

			
			<button type="submit" class="button button-primary">
				–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
			</button>
			</fieldset>
		</form>
	</div>

	<!-- –í–∫–ª–∞–¥–∫–∞ "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö" -->
	<div id="database-tab" class="settings-tab">
		<section class="settings-section">
			<div class="host-header section-top">
				<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö</h2>
				<div class="host-actions">
					<button type="button" class="button button-primary" data-size="md" title="–°–∫–∞—á–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö" onclick="downloadDatabase()">
						<i class="fas fa-download"></i>
						–°–∫–∞—á–∞—Ç—å –±–∞–∑—É
					</button>
					<button type="button" class="button button-secondary" data-size="md" title="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–∞–±–ª–∏—Ü" onclick="refreshDatabaseStats()">
						<i class="fas fa-sync-alt"></i>
						–û–±–Ω–æ–≤–∏—Ç—å
					</button>
				</div>
			</div>
			
			<div class="database-warning">
				<div class="alert alert-warning">
					<i class="fas fa-exclamation-triangle"></i>
					<strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
				</div>
			</div>

			<div class="database-tables-container">
				<table class="database-tables-table">
					<thead>
						<tr>
							<th>–¢–∞–±–ª–∏—Ü–∞</th>
							<th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
							<th>–ó–∞–ø–∏—Å–µ–π</th>
							<th>–†–∞–∑–º–µ—Ä</th>
							<th>–î–µ–π—Å—Ç–≤–∏—è</th>
						</tr>
					</thead>
					<tbody id="database-tables-tbody">
						<!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
					</tbody>
				</table>
			</div>
		</section>
	</div>

	<!-- –í–∫–ª–∞–¥–∫–∞ "–ë–µ–∫–∞–ø—ã" -->
	<div id="backup-tab" class="settings-tab">
		<form id="backup-settings-form" role="form" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è" data-form-purpose="backup-settings" novalidate>
			<fieldset>
				<legend>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</legend>
				
				<section class="settings-section">
					<h2>–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
					
					<div class="form-group">
						<label class="checkbox-label" for="backup_enabled" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö">
							<input type="checkbox" id="backup_enabled" name="backup_enabled" value="true" />
							<span>–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±–µ–∫–∞–ø—ã</span>
						</label>
					</div>
					
					<div class="form-group">
						<label for="backup_interval_hours">–ò–Ω—Ç–µ—Ä–≤–∞–ª –±–µ–∫–∞–ø–æ–≤:</label>
						<select id="backup_interval_hours" name="backup_interval_hours" title="–ö–∞–∫ —á–∞—Å—Ç–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–µ–∫–∞–ø—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö">
							<option value="1">1 —á–∞—Å</option>
							<option value="2">2 —á–∞—Å–∞</option>
							<option value="3">3 —á–∞—Å–∞</option>
							<option value="6">6 —á–∞—Å–æ–≤</option>
							<option value="12">12 —á–∞—Å–æ–≤</option>
							<option value="24" selected>1 –¥–µ–Ω—å</option>
							<option value="48">2 –¥–Ω—è</option>
							<option value="72">3 –¥–Ω—è</option>
						</select>
					</div>
					
					<div class="form-group">
						<label for="backup_retention_days">–•—Ä–∞–Ω–µ–Ω–∏–µ –±–µ–∫–∞–ø–æ–≤:</label>
						<select id="backup_retention_days" name="backup_retention_days" title="–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±–µ–∫–∞–ø—ã">
							<option value="1">1 –¥–µ–Ω—å</option>
							<option value="3">3 –¥–Ω—è</option>
							<option value="7">7 –¥–Ω–µ–π</option>
							<option value="14">14 –¥–Ω–µ–π</option>
							<option value="30" selected>30 –¥–Ω–µ–π</option>
							<option value="60">60 –¥–Ω–µ–π</option>
							<option value="90">90 –¥–Ω–µ–π</option>
							<option value="180">180 –¥–Ω–µ–π</option>
							<option value="365">1 –≥–æ–¥</option>
						</select>
					</div>
				</section>
				
				<section class="settings-section">
					<h2>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
					
					<div class="form-group">
						<label class="checkbox-label" for="backup_compression" title="–°–∂–∏–º–∞—Ç—å –±–µ–∫–∞–ø—ã gzip –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞">
							<input type="checkbox" id="backup_compression" name="backup_compression" value="true" checked />
							<span>–°–∂–∏–º–∞—Ç—å –±–µ–∫–∞–ø—ã (gzip)</span>
						</label>
					</div>
					
					<div class="form-group">
						<label class="checkbox-label" for="backup_verify" title="–ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –±–µ–∫–∞–ø–æ–≤ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è">
							<input type="checkbox" id="backup_verify" name="backup_verify" value="true" checked />
							<span>–ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –±–µ–∫–∞–ø–æ–≤</span>
						</label>
					</div>
				</section>
				
				<section class="settings-section">
					<h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
					<div class="backup-stats">
						<div class="stat-item">
							<strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="backup-status" class="status-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
						</div>
						<div class="stat-item">
							<strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –±–µ–∫–∞–ø:</strong> <span id="last-backup-time" class="time-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
						</div>
						<div class="stat-item">
							<strong>–°–ª–µ–¥—É—é—â–∏–π –±–µ–∫–∞–ø:</strong> <span id="next-backup-time" class="time-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
						</div>
						<div class="stat-item">
							<strong>–í—Å–µ–≥–æ –±–µ–∫–∞–ø–æ–≤:</strong> <span id="backup-count" class="count-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
						</div>
						<div class="stat-item">
							<strong>–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä:</strong> <span id="backup-size" class="size-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
						</div>
						<div class="stat-item">
							<strong>–ù–µ—É–¥–∞—á–Ω—ã—Ö –±–µ–∫–∞–ø–æ–≤:</strong> <span id="failed-backups" class="error-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
						</div>
					</div>
				</section>
				
				<section class="settings-section">
					<h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
					<div class="backup-actions">
						<button type="button" class="button button-primary" onclick="createManualBackup()" title="–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø –≤—Ä—É—á–Ω—É—é">
							<i class="fas fa-download"></i>
							–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø —Å–µ–π—á–∞—Å
						</button>
						<button type="button" class="button button-secondary" onclick="viewBackups()" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –±–µ–∫–∞–ø–æ–≤">
							<i class="fas fa-list"></i>
							–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±–µ–∫–∞–ø—ã
						</button>
						<button type="button" class="button button-secondary" onclick="refreshBackupStatus()" title="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É">
							<i class="fas fa-sync-alt"></i>
							–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
						</button>
					</div>
				</section>
				
				<button type="submit" class="button button-primary" data-size="md" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∫–∞–ø–æ–≤">
					<i class="fas fa-save"></i>
					–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∫–∞–ø–æ–≤
				</button>
			</fieldset>
		</form>
	</div>

	<!-- –í–∫–ª–∞–¥–∫–∞ "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏" -->
	<div id="directories-tab" class="settings-tab">
		<section class="settings-section">
			<h2>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</h2>
			<p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º—ã</p>
			
			<div class="directories-navigation">
				<button class="nav-button active" onclick="showDirectoryTab('groups', this)" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
					<i class="fas fa-users"></i>
					–ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
				</button>
			</div>
			
			<!-- –ü–æ–¥–≤–∫–ª–∞–¥–∫–∞ "–ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" -->
			<div id="groups-directory-tab" class="directory-tab active">
				<div class="directory-header">
					<h3>–ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
					<div class="directory-actions">
						<button type="button" class="button button-primary" data-size="md" onclick="openGroupModal()" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
							<i class="fas fa-plus"></i>
							–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É
						</button>
					</div>
				</div>
				
				<div class="directory-stats">
					<div class="stat-item">
						<span class="stat-label">–í—Å–µ–≥–æ –≥—Ä—É–ø–ø:</span>
						<span class="stat-value" id="total-groups-count">‚Äî</span>
					</div>
					<div class="stat-item">
						<span class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</span>
						<span class="stat-value" id="total-users-count">‚Äî</span>
					</div>
				</div>
				
				<div class="table-scroll-x">
					<table class="groups-table">
						<thead>
							<tr>
								<th>ID</th>
								<th>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</th>
								<th>–ö–æ–¥</th>
								<th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
								<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</th>
								<th>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</th>
								<th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
								<th class="actions-cell">–î–µ–π—Å—Ç–≤–∏—è</th>
							</tr>
						</thead>
						<tbody id="groups-table-body">
							<!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
						</tbody>
					</table>
				</div>
			</div>
		</section>
	</div>

</div>

<style>

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
.settings-tab {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.settings-tab.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Settings Dark Theme v2.2 - Added tab navigation & moved content settings */
/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
.settings-container {
    border-radius: 8px;
    padding: 20px;
    margin-top: 10px;
    color: #ffffff;
}

/* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å–µ–∫—Ü–∏–∏ –°–µ—Ä–≤–µ—Ä—ã –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –¥–ª—è 2 –∫–æ–ª–æ–Ω–æ–∫ */
#servers-tab > section.settings-section {
    width: clamp(600px, 90vw, 1500px);
    min-width: 600px;
    max-width: 1500px;
    margin-left: auto;
    margin-right: auto;
}

.settings-section {
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    color: #ffffff;
}

/* –°–µ—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤: –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ 700px, —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
.servers-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
}

.servers-grid .host-card {
    flex: 0 1 700px;
    width: 700px;
    max-width: 100%;
    margin: 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
.settings-container .button {
    background: var(--primary-color);
    color: #ffffff;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.3s ease;
}

.settings-container .button:hover {
    background: var(--primary-hover);
}

.settings-container .button-small {
    padding: 8px 16px;
    font-size: 14px;
}

.settings-container .button-primary {
    background: #28a745;
}

.settings-container .button-primary:hover {
    background: #1e7e34;
}

.settings-container .button-danger {
    background: #dc3545;
}

.settings-container .button-danger:hover {
    background: #c82333;
}

.host-header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.host-actions{ display:flex; gap:8px; padding:10px;}
.button-icon{ width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; padding:0; }

/* –°–µ—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ (–û—Ç–º–µ–Ω–∞) */
/* –û—Ç–º–µ–Ω–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ .button.button-secondary */

/* –¢–∞–±–ª–∏—Ü–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ */
.plans-table-wrap { overflow-x: visible; }
@media (max-width: 900px) { .plans-table-wrap { overflow-x: auto; } }
.plans-table {
    width: 100%;
    border-collapse: collapse;
}
.plans-table th, .plans-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #3a4147;
    text-align: left;
}
.plans-table thead th { background: #32383f; position: sticky; top: 0; }
.plans-table tbody tr:hover { background: #363c43; cursor: pointer; }

/* –§—É—Ç–µ—Ä –º–æ–¥–∞–ª–∫–∏ —Å —Ç—Ä–µ–º—è –∫–Ω–æ–ø–∫–∞–º–∏ */
.modal-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-top: 8px;
}
.modal-actions .button { flex: 1; }

@media (max-width: 600px) {
    .modal-actions { flex-direction: column; }
    .modal-actions .button { width: 100%; }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
.settings-container input,
.settings-container textarea,
.settings-container select {
    background: #3a4147;
    color: #ffffff;
    border: 1px solid #4a5058;
    border-radius: 4px;
    padding: 8px 12px;
}

.settings-container input:focus,
.settings-container textarea:focus,
.settings-container select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(0, 135, 113, 0.25);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ª–µ–π–±–ª–æ–≤ */
.settings-container label {
    color: #ffffff;
    font-weight: 500;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
.settings-container .text-muted {
    color: #bdc3c7 !important;
}

/* ---- Custom overrides for servers tab controls ---- */
/* Kebab buttons only in main host header (not in plans table) */
.servers-grid .host-card > .host-header .kebab-btn{
    background: #282b30 !important;
}

/* "–°–æ–∑–¥–∞—Ç—å —Ç–∞—Ä–∏—Ñ" button styles */
.servers-grid .host-card > .host-header .host-actions .button-primary.button-small{
    background: #008771 !important;
}
.servers-grid .host-card > .host-header .host-actions .button-primary.button-small:hover{
    background: #006e5e !important;
}

/* "–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä" button styles */
.host-header.section-top .host-actions .button-primary{
    background: #008771 !important;
}
.host-header.section-top .host-actions .button-primary:hover{
    background: #006e5e !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è —Å –∫–Ω–æ–ø–∫–∞–º–∏ (content-field-wrapper) */
.content-field-wrapper {
    display: flex;
    gap: 8px;
    align-items: center;
}

.content-field-wrapper input {
    flex: 1;
}

.content-field-wrapper .button-small {
    white-space: nowrap;
    flex-shrink: 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≥—Ä—É–ø–ø—ã —Å –∫–Ω–æ–ø–∫–æ–π */
.form-group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.form-group-header label {
    margin-bottom: 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è textarea —Å –∫–æ–¥–æ–º */
.textarea-code {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.4;
    background: #2d3748;
    color: #e2e8f0;
    border: 1px solid #4a5568;
    border-radius: 6px;
    padding: 12px;
    resize: vertical;
}

.textarea-code:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(0, 135, 113, 0.25);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –±–æ–ª—å—à–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ */
.modal-large {
    width: 90% !important;
    max-width: 1200px !important;
    max-height: 90vh !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è form-actions */
.form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #4a5568;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è form-help */
.form-help {
    color: #a0aec0;
    font-size: 13px;
    margin-top: 8px;
    display: block;
}

.form-help a {
    color: var(--primary-color);
    text-decoration: none;
}

.form-help a:hover {
    text-decoration: underline;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö" */
.database-warning {
    margin-bottom: 20px;
}

.database-tables-container {
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #4a5058;
}

.database-tables-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg-surface);
}

.database-tables-table th,
.database-tables-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #4a5058;
    text-align: left;
}

.database-tables-table thead th {
    background: #32383f;
    position: sticky;
    top: 0;
    font-weight: 600;
    color: #ffffff;
}

.database-tables-table tbody tr:hover {
    background: #363c43;
}

.database-tables-table tbody tr:last-child td {
    border-bottom: none;
}

.table-name {
    font-weight: 600;
    color: var(--primary-color);
}

.table-description {
    color: #bdc3c7;
    font-size: 14px;
}

.table-count {
    font-weight: 500;
    color: #ffffff;
}

.table-size {
    color: #95a5a6;
    font-size: 14px;
}

.table-actions {
    text-align: right;
}

.delete-table-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s ease;
}

.delete-table-btn:hover {
    background: #c82333;
}

.delete-table-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è alert-—Å–æ–æ–±—â–µ–Ω–∏–π */
.alert {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.alert-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.alert-danger {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.alert i {
    font-size: 16px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    .database-tables-table th,
    .database-tables-table td {
        padding: 8px 12px;
        font-size: 14px;
    }
    
    .table-description {
        display: none;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ë–µ–∫–∞–ø—ã" */
.backup-stats {
    background: #2c3136;
    border: 1px solid #4a5058;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.backup-stats .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #3a4147;
}

.backup-stats .stat-item:last-child {
    border-bottom: none;
}

.backup-stats .stat-item strong {
    color: #ffffff;
    font-weight: 600;
}

.status-text {
    color: #28a745;
    font-weight: 500;
}

.time-text {
    color: #17a2b8;
    font-family: monospace;
}

.count-text {
    color: #ffffff;
    font-weight: 500;
}

.size-text {
    color: #ffc107;
    font-weight: 500;
}

.error-text {
    color: #dc3545;
    font-weight: 500;
}

.backup-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.backup-actions .button {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    .backup-actions {
        flex-direction: column;
    }
    
    .backup-actions .button {
        width: 100%;
        justify-content: center;
    }
    
    .backup-stats .stat-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
}


</style>

<!-- –°–∫—Ä—ã—Ç—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –º–æ–¥–∞–ª–∫–µ) -->
<template id="user-groups-template">
  <select name="display_mode_groups[]" multiple size="4" title="–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞)" class="plan-groups-select">
    {% if user_groups and user_groups|length > 0 %}
      {% for g in user_groups %}
        <option value="{{ g.group_id }}">{{ g.group_name }} ({{ g.user_count or 0 }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)</option>
      {% endfor %}
    {% else %}
      <option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø</option>
    {% endif %}
  </select>
</template>

<script>
// ===== Kebab menu styles —Ç–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ style.css =====

    function showTab(tabName, el) {
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    const tabs = document.querySelectorAll('.settings-tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
    });
    
    // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    const buttons = document.querySelectorAll('.nav-button');
    buttons.forEach(button => {
        button.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É
    if (el) { 
        el.classList.add('active'); 
    } else {
        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∞, –Ω–∞–π–¥–µ–º –µ—ë –ø–æ tabName
        const targetButton = Array.from(document.querySelectorAll('.nav-button'))
            .find(btn => (btn.getAttribute('onclick') || '').includes("'" + tabName + "'"));
        if (targetButton) {
            targetButton.classList.add('active');
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –≤ URL
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.replaceState({}, '', url);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
    if (tabName === 'directories') {
        loadGroupsData();
    }
}

function updateStarsRate() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram
    document.getElementById('stars_conversion_rate').value = '1.79';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    alert('–ö—É—Ä—Å –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ 1.79 —Ä—É–±–ª–µ–π –∑–∞ 1 –∑–≤–µ–∑–¥—É.\n\n–≠—Ç–æ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ:\n100 –∑–≤–µ–∑–¥ = 179 —Ä—É–±–ª–µ–π\n\n–î–ª—è —Ç–æ—á–Ω–æ–≥–æ –∫—É—Ä—Å–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –≤ Telegram.');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é —Å —Å–µ—Ä–≤–µ—Ä–∞
    const urlParams = new URLSearchParams(window.location.search);
    const urlTab = urlParams.get('tab');
    const serverTab = '{{ active_tab or "servers" }}';
    const currentActiveTab = urlTab || serverTab;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    showTab(currentActiveTab);

    // Kebab toggling —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ script.js

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ dblclick –ø–æ —Å—Ç—Ä–æ–∫–∞–º —Ç–∞—Ä–∏—Ñ–æ–≤
    document.body.addEventListener('dblclick', function(e){
        const tr = e.target.closest('tr.plan-row');
        if (!tr) return;
        const planId = tr.getAttribute('data-plan-id');
        const name = tr.getAttribute('data-plan-name') || '';
        const months = tr.getAttribute('data-plan-months') || '';
        const days = tr.getAttribute('data-plan-days') || '';
        const price = tr.getAttribute('data-plan-price') || '';
        const traffic = tr.getAttribute('data-plan-traffic') || '';
        const hours = tr.getAttribute('data-plan-hours') || '';
        const keyProvisionMode = tr.getAttribute('data-plan-provision-mode') || 'key';
        const displayMode = tr.getAttribute('data-plan-display-mode') || 'all';
        const displayModeGroups = tr.getAttribute('data-plan-display-mode-groups') || null;
        const hostName = tr.getAttribute('data-host-name') || '';
        openPlanModal(planId, name, months, days, price, traffic, hostName, hours, keyProvisionMode, displayMode, displayModeGroups);
    });
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Ö–æ—Å—Ç–æ–º
async function checkHost(hostName, btn){
    try{
        if(btn){ btn.disabled = true; btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...'; }
        const form = new FormData();
        form.append('host_name', hostName);
        const res = await fetch('/check-host', {method:'POST', body: form});
        const data = await res.json();
        alert((data.status==='success'?'‚úÖ ':'‚ùå ') + (data.message || ''));
    }catch(e){
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏');
    }finally{
        if(btn){ btn.disabled = false; btn.textContent = 'üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å'; }
    }
}

// –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —Ö–æ—Å—Ç–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
function openHostModal(name='', url='', user='', pass='', inbound='', code=''){
    const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>${name? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ö–æ—Å—Ç' : '–î–æ–±–∞–≤–∏—Ç—å —Ö–æ—Å—Ç'}</h3>
            <span class="close" onclick="closeModal()">&times;</span>
          </div>
          <div class="modal-body">
            <form method="post" action="${name? '/edit-host' : '/add-host'}" role="form">
              ${name? `<input type="hidden" name="old_host_name" value="${name}">` : ''}
              <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" name="host_name" value="${name}" required></div>
              <div class="form-group"><label>URL –ø–∞–Ω–µ–ª–∏ XUI</label><input type="url" name="host_url" value="${url}" placeholder="https://host:port/secret" required></div>
              <div class="form-group"><label>–õ–æ–≥–∏–Ω</label><input type="text" name="host_username" value="${user}" required></div>
              <div class="form-group"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" name="host_pass" value="${pass||''}" autocomplete="current-password" required></div>
              <div class="form-group"><label>ID –∏–Ω–±–∞—É–Ω–¥–∞</label><input type="number" name="host_inbound_id" value="${inbound}" required></div>
              <div class="form-group"><label>–ö–æ–¥ 3x‚Äëui (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π)</label><input type="text" name="host_code" value="${code||''}" placeholder="amsterdam"></div>
              <div class="modal-actions">
                <span></span>
                <button type="button" class="button button-secondary" onclick="closeModal()" title="–û—Ç–º–µ–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="button button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>`;
    showModal(html);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ data-* –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ —Ö–æ—Å—Ç–∞
function openHostModalData(el){
    if(!el) return;
    const name = el.getAttribute('data-host-name') || '';
    const url = el.getAttribute('data-host-url') || '';
    const user = el.getAttribute('data-host-username') || '';
    const inbound = el.getAttribute('data-host-inbound-id') || '';
    const code = el.getAttribute('data-host-code') || '';
    openHostModal(name, url, user, '', inbound, code);
}

// –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
function openPlanModal(planId, name, months, days, price, traffic, hostName, hours, keyProvisionMode, displayMode, displayModeGroups){
    const isEdit = !!planId;
    const action = isEdit ? `/edit-plan/${planId}` : '/add-plan';
    const hiddenHost = isEdit ? '' : `<input type="hidden" name="host_name" value="${hostName}">`;
    const provisionMode = keyProvisionMode || 'key';
    displayMode = displayMode || 'all';
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º displayModeGroups –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    // displayModeGroups –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: "1,2,3")
    let selectedGroups = [];
    if (displayModeGroups) {
        try {
            // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, —Ä–∞–∑–±–∏–≤–∞–µ–º –µ—ë
            const groupsStr = String(displayModeGroups).trim();
            if (groupsStr) {
                selectedGroups = groupsStr.split(',').map(g => parseInt(g.trim())).filter(g => !isNaN(g));
            }
        } catch(e) {
            selectedGroups = [];
        }
    }
    
    console.log('displayModeGroups:', displayModeGroups);
    console.log('selectedGroups:', selectedGroups);
    
    // –ü–æ–ª—É—á–∞–µ–º HTML –¥–ª—è –≥—Ä—É–ø–ø –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ (–∫–∞–∫ –≤ –ø—Ä–æ–º–æ–∫–æ–¥–∞—Ö)
    const groupsTemplate = document.getElementById('user-groups-template');
    const groupsSelectHtml = groupsTemplate ? groupsTemplate.innerHTML : '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø</option>';
    
    const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>${isEdit? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞—Ä–∏—Ñ' : '–î–æ–±–∞–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ'}</h3>
            <span class="close" onclick="closeModal()">&times;</span>
          </div>
          <div class="modal-body">
            <form method="post" action="${action}" role="form">
              ${hiddenHost}
              <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" name="plan_name" value="${name||''}" placeholder="–ù–∞–ø—Ä. –ë–∞–∑–æ–≤—ã–π" required title="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞"></div>
              <div class="form-group"><label>–ú–µ—Å—è—Ü—ã</label><input type="number" name="months" value="${months||''}" placeholder="0" title="–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤"></div>
              <div class="form-group"><label>–î–Ω–∏</label><input type="number" name="days" value="${days||''}" placeholder="0" title="–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π"></div>
              <div class="form-group"><label>–ß–∞—Å—ã</label><input type="number" name="hours" value="${hours||''}" placeholder="0" min="0" max="24" title="–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ (0‚Äì24)"></div>
              <div class="form-group"><label>–¶–µ–Ω–∞ (RUB)</label><input type="number" step="0.01" name="price" value="${price||''}" placeholder="0" required title="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É —Ç–∞—Ä–∏—Ñ–∞, –≤ —Ä—É–±–ª—è—Ö"></div>
              <div class="form-group"><label>–¢—Ä–∞—Ñ–∏–∫ (–ì–ë)</label><input type="number" step="0.01" name="traffic_gb" value="${traffic||''}" placeholder="0 (–±–µ–∑–ª–∏–º–∏—Ç)" title="–í–≤–µ–¥–∏—Ç–µ –ª–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ –≤ –ì–ë –∏–ª–∏ 0 –¥–ª—è –±–µ–∑–ª–∏–º–∏—Ç–∞"></div>
              <div class="form-group">
                <label title="–í—ã–±–µ—Ä–∏—Ç–µ —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ç–∞—Ä–∏—Ñ–∞">–†–µ–∂–∏–º –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è</label>
                <select name="key_provision_mode" title="–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –∫–ª—é—á, –ø–æ–¥–ø–∏—Å–∫–∞ –∏–ª–∏ –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞">
                  <option value="key" ${provisionMode === 'key' ? 'selected' : ''}>–ö–ª—é—á</option>
                  <option value="subscription" ${provisionMode === 'subscription' ? 'selected' : ''}>–ü–æ–¥–ø–∏—Å–∫–∞</option>
                  <option value="both" ${provisionMode === 'both' ? 'selected' : ''}>–ö–ª—é—á + –ü–æ–¥–ø–∏—Å–∫–∞</option>
                </select>
              </div>
              <div class="form-group">
                <label title="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                <select name="display_mode" title="–ö–æ–º—É –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —ç—Ç–æ—Ç —Ç–∞—Ä–∏—Ñ –≤ –±–æ—Ç–µ">
                  <option value="all" ${displayMode === 'all' ? 'selected' : ''}>–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –≤—Å–µ–º</option>
                  <option value="hidden_all" ${displayMode === 'hidden_all' ? 'selected' : ''}>–°–∫—Ä—ã—Ç—å —É –≤—Å–µ—Ö</option>
                  <option value="hidden_new" ${displayMode === 'hidden_new' ? 'selected' : ''}>–°–∫—Ä—ã—Ç—å —É –Ω–æ–≤—ã—Ö</option>
                  <option value="hidden_old" ${displayMode === 'hidden_old' ? 'selected' : ''}>–°–∫—Ä—ã—Ç—å —É —Å—Ç–∞—Ä—ã—Ö</option>
                </select>
              </div>
              <div class="form-group">
                <label title="–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω —ç—Ç–æ—Ç —Ç–∞—Ä–∏—Ñ">–ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</label>
                ${groupsSelectHtml}
                <small class="form-hint">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≥—Ä—É–ø–ø. –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã, —Ç–∞—Ä–∏—Ñ –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º</small>
              </div>
              <div class="modal-actions">
                <span></span>
                <button type="button" class="button button-secondary" onclick="closeModal()" title="–û—Ç–º–µ–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="button button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>`;
    showModal(html);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–∞–ª–∫–∏
    if (selectedGroups.length > 0) {
      setTimeout(() => {
        const select = document.querySelector('select.plan-groups-select');
        if (select) {
          Array.from(select.options).forEach(option => {
            if (selectedGroups.includes(parseInt(option.value))) {
              option.selected = true;
            }
          });
        }
      }, 100);
    }
}

// Delete helpers
function deleteHost(hostName){
    if (!hostName) return;
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ö–æ—Å—Ç –∏ –≤—Å–µ –µ–≥–æ —Ç–∞—Ä–∏—Ñ—ã?')) return;
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/delete-host/${hostName}`;
    
    // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

function deletePlan(planId){
    if (!planId) return;
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ?')) return;
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/delete-plan/${planId}`;
    
    // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ —Ç–∞—Ä–∏—Ñ–∞ (add/edit) —á–µ—Ä–µ–∑ data-*
function openPlanModalData(el){
    if(!el) return;
    const planId = el.getAttribute('data-plan-id');
    const hostName = el.getAttribute('data-host-name') || '';
    if (planId) {
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
        const name = el.getAttribute('data-plan-name') || '';
        const months = el.getAttribute('data-plan-months') || '';
        const days = el.getAttribute('data-plan-days') || '';
        const price = el.getAttribute('data-plan-price') || '';
        const traffic = el.getAttribute('data-plan-traffic') || '';
        const hours = el.getAttribute('data-plan-hours') || '';
        const keyProvisionMode = el.getAttribute('data-plan-provision-mode') || 'key';
        const displayMode = el.getAttribute('data-plan-display-mode') || 'all';
        const displayModeGroups = el.getAttribute('data-plan-display-mode-groups') || null;
        openPlanModal(planId, name, months, days, price, traffic, hostName, hours, keyProvisionMode, displayMode, displayModeGroups);
    } else {
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
        openPlanModal(null, '', '', '', '', '', hostName, '', 'key', 'all', null);
    }
}

function showModal(html){
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
    const existingModals = document.querySelectorAll('.modal-backdrop');
    existingModals.forEach(modal => modal.remove());
    
    const wrap = document.createElement('div');
    wrap.innerHTML = html;
    document.body.appendChild(wrap);
    const modal = wrap.querySelector('.modal');
    const backdrop = wrap.querySelector('.modal-backdrop');
    const modalContent = wrap.querySelector('.modal-content');
    
    if (modal) modal.style.display = 'flex';
    if (backdrop) backdrop.style.display = 'block';
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    if (modalContent) {
        // –ï—Å–ª–∏ —É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ—Ç —è–≤–Ω–æ –∑–∞–¥–∞–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ
        if (!modalContent.style.width && !modalContent.style.maxWidth) {
            modalContent.style.width = '90%';
            modalContent.style.maxWidth = '500px';
            modalContent.style.maxHeight = '90vh';
        }
    }
}
function closeModal(){
    const el = document.querySelector('.modal-backdrop');
    if(el) el.remove();
}

function closeHtmlEditor(){
    const el = document.querySelector('.modal-backdrop');
    if(el) el.remove();
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
function openContentModal(fieldId, fieldLabel, fieldType) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    const currentValue = field.value || '';
    const isTextarea = fieldType === 'textarea';
    
    const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <div class="modal-content" style="width: 90%; max-width: 500px; max-height: 90vh;">
          <div class="modal-header">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ${fieldLabel}</h3>
            <span class="close" onclick="closeModal()">&times;</span>
          </div>
          <div class="modal-body">
            <form id="contentEditForm" role="form">
              <div class="form-group">
                <label for="contentValue">${fieldLabel}:</label>
                ${isTextarea ? 
                    `<textarea id="contentValue" name="contentValue" class="textarea-small" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ ${fieldLabel.toLowerCase()}" required>${currentValue}</textarea>` :
                    `<input type="${fieldType}" id="contentValue" name="contentValue" value="${currentValue}" placeholder="–í–≤–µ–¥–∏—Ç–µ ${fieldLabel.toLowerCase()}" required>`
                }
              </div>
              <div class="modal-actions">
                <span></span>
                <button type="button" class="button button-secondary" onclick="closeModal()" title="–û—Ç–º–µ–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="button button-primary" onclick="saveContent('${fieldId}')" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>`;
    showModal(html);
}

function saveContent(fieldId) {
    const contentValue = document.getElementById('contentValue');
    if (!contentValue) return;
    
    const newValue = contentValue.value.trim();
    const originalField = document.getElementById(fieldId);
    
    if (originalField) {
        originalField.value = newValue;
    }
    
    closeModal();
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
function openContentModalWithAutoSave(fieldId, fieldLabel, fieldType) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    const currentValue = field.value || '';
    const isTextarea = fieldType === 'textarea';
    
    const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <div class="modal-content" style="width: 90%; max-width: 500px; max-height: 90vh;">
          <div class="modal-header">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ${fieldLabel}</h3>
            <span class="close" onclick="closeModal()">&times;</span>
          </div>
          <div class="modal-body">
            <form id="contentEditForm" role="form">
              <div class="form-group">
                <label for="contentValue">${fieldLabel}:</label>
                ${isTextarea ? 
                    `<textarea id="contentValue" name="contentValue" class="textarea-small" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ ${fieldLabel.toLowerCase()}" required>${currentValue}</textarea>` :
                    `<input type="${fieldType}" id="contentValue" name="contentValue" value="${currentValue}" placeholder="–í–≤–µ–¥–∏—Ç–µ ${fieldLabel.toLowerCase()}" required>`
                }
              </div>
              <div class="modal-actions">
                <span></span>
                <button type="button" class="button button-secondary" onclick="closeModal()" title="–û—Ç–º–µ–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="button button-primary" onclick="saveContentWithAutoSave('${fieldId}')" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>`;
    showModal(html);
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
async function saveContentWithAutoSave(fieldId) {
    const contentValue = document.getElementById('contentValue');
    if (!contentValue) return;
    
    const newValue = contentValue.value.trim();
    const originalField = document.getElementById(fieldId);
    
    if (!originalField) return;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const saveButton = document.querySelector('button[onclick*="saveContentWithAutoSave"]');
    const originalText = saveButton.textContent;
    saveButton.disabled = true;
    saveButton.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        const formData = new FormData();
        formData.append(fieldId, newValue);
        
        const response = await fetch('/save-content-setting', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤ —Ñ–æ—Ä–º–µ
            originalField.value = newValue;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            closeModal();
        } else {
            throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏', 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        saveButton.disabled = false;
        saveButton.textContent = originalText;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'success') {
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#dc3545' : '#28a745'};
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // –£–±–∏—Ä–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è HTML-—Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
function openHtmlEditor(pageType) {
    const pageTitle = pageType === 'terms' ? '–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è' : '–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏';
    const previewUrl = pageType === 'terms' ? '/terms' : '/privacy';
    
    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <div class="modal-content modal-large" style="width: 90%; max-width: 1200px; max-height: 90vh;">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${pageTitle}</h2>
                <span class="close" onclick="closeHtmlEditor()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="htmlEditForm" method="POST" action="/edit-${pageType}" role="form">
                    <div class="form-group">
                        <label for="html_content">HTML-–∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:</label>
                        <textarea 
                            id="html_content" 
                            name="${pageType}_content" 
                            class="textarea-code"
                            rows="30" 
                            placeholder="–í–≤–µ–¥–∏—Ç–µ HTML-–∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã..."
                            required
                        ></textarea>
                        <small class="form-help">
                            –í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å HTML-–∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageTitle.toLowerCase()}. 
                            <a href="${previewUrl}" target="_blank">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</a>
                        </small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="button button-secondary" onclick="closeHtmlEditor()" title="–û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è">
                            <i class="fas fa-times"></i>
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="button button-primary" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è">
                            <i class="fas fa-save"></i>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
      </div>
    </div>`;
    
    showModal(html);
    
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
    const form = document.getElementById('htmlEditForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                // –û–±–Ω–æ–≤–ª—è–µ–º URL –≤ –ø–æ–ª–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                const fieldId = pageType === 'terms' ? 'terms_content' : 'privacy_content';
                const field = document.getElementById(fieldId);
                if (field) {
                    const baseUrl = window.location.origin;
                    field.value = baseUrl + previewUrl;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                showNotification('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!', 'success');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                closeHtmlEditor();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π', 'error');
        });
    });
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
    loadCurrentContent(pageType);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
function loadCurrentContent(pageType) {
    const apiUrl = pageType === 'terms' ? '/api/get-terms-content' : '/api/get-privacy-content';
    fetch(apiUrl, {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            document.getElementById('html_content').value = data.content || '';
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:', error);
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeHtmlEditor() {
    const modal = document.querySelector('.modal-backdrop');
    if (modal) {
        modal.remove();
    }
    // –£–¥–∞–ª—è–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏
    const style = document.querySelector('style');
    if (style && style.textContent.includes('.modal-backdrop')) {
        style.remove();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ TON Connect –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
function openTonManifest() {
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç TON Connect –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
    const manifestUrl = '/.well-known/tonconnect-manifest.json';
    window.open(manifestUrl, '_blank');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ TON Connect
function openTonManifestEditor() {
    const html = `
    <div class="modal-backdrop">
      <div class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Ton Connect Manifest</h2>
                <span class="close" onclick="closeTonManifestEditor()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="tonManifestForm" class="ton-manifest-form" role="form">
                    <div class="form-group">
                        <label for="ton_manifest_name">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</label>
                        <input type="text" id="ton_manifest_name" name="ton_manifest_name" 
                               value="" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="app_url">URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</label>
                        <input type="url" id="app_url" name="app_url" 
                               value="" 
                               placeholder="https://example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ton_manifest_icon_url">URL –∏–∫–æ–Ω–∫–∏:</label>
                        <div class="icon-upload-container">
                            <div class="icon-url-input">
                                <input type="url" id="ton_manifest_icon_url" name="ton_manifest_icon_url" 
                                       value="" 
                                       placeholder="https://example.com/icon.png" required>
                                <button type="button" class="button button-secondary" onclick="document.getElementById('icon_file_input').click()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª">
                                    <i class="fas fa-upload"></i>
                                    –ó–∞–≥—Ä—É–∑–∏—Ç—å
                                </button>
                            </div>
                            <input type="file" id="icon_file_input" accept="image/png,image/jpg,image/jpeg,image/gif,image/webp" style="display: none;">
                            <div class="icon-preview" id="icon_preview">
                                <img id="icon_preview_img" src="" alt="–ü—Ä–µ–≤—å—é –∏–∫–æ–Ω–∫–∏">
                            </div>
                            <small>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 256x256 –ø–∏–∫—Å–µ–ª–µ–π (PNG, JPG, JPEG, GIF, WEBP)</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ton_manifest_terms_url">URL —É—Å–ª–æ–≤–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</label>
                        <input type="url" id="ton_manifest_terms_url" name="ton_manifest_terms_url" 
                               value="" 
                               placeholder="https://example.com/terms" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ton_manifest_privacy_url">URL –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏:</label>
                        <input type="url" id="ton_manifest_privacy_url" name="ton_manifest_privacy_url" 
                               value="" 
                               placeholder="https://example.com/privacy" required>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="button button-secondary" onclick="closeTonManifestEditor()" title="–û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è">
                            <i class="fas fa-times"></i>
                            –û—Ç–º–µ–Ω–∏—Ç—å
                        </button>
                        <button type="submit" class="button button-primary" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞">
                            <i class="fas fa-save"></i>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
      </div>
    </div>`;
    
    showModal(html);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    loadTonManifestData();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    const form = document.getElementById('tonManifestForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            
            fetch('/save-ton-manifest-settings', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Ton Connect –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                    closeTonManifestEditor();
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
            });
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∫–æ–Ω–∫–∏
    const iconFileInput = document.getElementById('icon_file_input');
    if (iconFileInput) {
        iconFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                uploadIconFile(file);
            }
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Ton manifest
function loadTonManifestData() {
    console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞...');
    
    fetch('/api/get-ton-manifest-data', {
        credentials: 'same-origin'
    })
        .then(response => {
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
            
            if (data.success) {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                const nameField = document.getElementById('ton_manifest_name');
                const urlField = document.getElementById('app_url');
                const iconUrlField = document.getElementById('ton_manifest_icon_url');
                const termsUrlField = document.getElementById('ton_manifest_terms_url');
                const privacyUrlField = document.getElementById('ton_manifest_privacy_url');
                
                if (nameField) nameField.value = data.data.name || '';
                if (urlField) urlField.value = data.data.url || '';
                if (iconUrlField) iconUrlField.value = data.data.iconUrl || '';
                if (termsUrlField) termsUrlField.value = data.data.termsOfUseUrl || '';
                if (privacyUrlField) privacyUrlField.value = data.data.privacyPolicyUrl || '';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –∏–∫–æ–Ω–∫–∏
                const previewImg = document.getElementById('icon_preview_img');
                if (previewImg) previewImg.src = data.data.iconUrl || '';
                
                console.log('–ü–æ–ª—è —Ñ–æ—Ä–º—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã:', {
                    name: data.data.name,
                    url: data.data.url,
                    iconUrl: data.data.iconUrl,
                    termsUrl: data.data.termsOfUseUrl,
                    privacyUrl: data.data.privacyPolicyUrl
                });
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', data.message);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞', 'error');
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –∏–∫–æ–Ω–∫–∏
function uploadIconFile(file) {
    const formData = new FormData();
    formData.append('icon', file);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const iconPreview = document.getElementById('icon_preview');
    const iconUrlInput = document.getElementById('ton_manifest_icon_url');
    const uploadButton = document.querySelector('.icon-url-input .button');
    
    iconPreview.classList.add('icon-upload-loading');
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
    
    fetch('/upload-ton-icon', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º URL –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            iconUrlInput.value = data.icon_url;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
            const previewImg = document.getElementById('icon_preview_img');
            previewImg.src = data.icon_url;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            showNotification('–ò–∫–æ–Ω–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∫–æ–Ω–∫–∏: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∫–æ–Ω–∫–∏', 'error');
    })
    .finally(() => {
        // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        iconPreview.classList.remove('icon-upload-loading');
        uploadButton.disabled = false;
        uploadButton.innerHTML = '<i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å';
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ TON Connect
function closeTonManifestEditor() {
    const modal = document.querySelector('.modal-backdrop');
    if (modal) {
        modal.remove();
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ YooKassa
function toggleYooKassaMode() {
    const testModeCheckbox = document.getElementById('yookassa_test_mode');
    const modeLabelText = document.getElementById('mode-label-text');
    
    if (testModeCheckbox.checked) {
        // –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω
        modeLabelText.textContent = '–†–µ–∂–∏–º: –¢–µ—Å—Ç–æ–≤—ã–π';
    } else {
        // –ë–æ–µ–≤–æ–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω
        modeLabelText.textContent = '–†–µ–∂–∏–º: –ë–æ–µ–≤–æ–π';
    }
    
    console.log('–†–µ–∂–∏–º YooKassa –∏–∑–º–µ–Ω–µ–Ω:', testModeCheckbox.checked ? '–¢–µ—Å—Ç–æ–≤—ã–π' : '–ë–æ–µ–≤–æ–π');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –ª–æ–≥–æ–≤
async function testLoggingBot() {
    const token = document.getElementById('logging_bot_token').value;
    const chatId = document.getElementById('logging_bot_admin_chat_id').value;
    
    if (!token || !chatId) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'warning');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    try {
        const response = await fetch('/test-logging-bot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                token: token,
                chat_id: chatId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.', 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
async function checkSupportConfig(event) {
    const resultDiv = document.getElementById('support-diagnostic-result');
    resultDiv.innerHTML = '<p style="color: #666;">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...</p>';
    
    const button = event ? event.target.closest('button') : document.querySelector('button[onclick*="checkSupportConfig"]');
    if (!button) {
        console.error('Button not found for checkSupportConfig');
        return;
    }
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    
    try {
        const response = await fetch('/api/support/check-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `<pre style="padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; font-size: 13px; line-height: 1.6; border: 1px solid var(--border-color, #ddd); color: var(--text-color, inherit);">${data.message}</pre>`;
            showNotification('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
        } else {
            resultDiv.innerHTML = `<p style="color: #d32f2f;">‚ùå ${data.message}</p>`;
            showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        resultDiv.innerHTML = `<p style="color: #d32f2f;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ${error}</p>`;
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
async function testSupportBot() {
    const resultDiv = document.getElementById('support-diagnostic-result');
    resultDiv.innerHTML = '<p style="color: #666;">‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞...</p>';
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';
    
    try {
        const response = await fetch('/api/support/check-test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `<pre style="padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; font-size: 13px; line-height: 1.6; border: 1px solid var(--border-color, #ddd); color: var(--text-color, inherit);">${data.message}</pre>`;
            showNotification('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', 'success');
        } else {
            resultDiv.innerHTML = `<p style="color: #d32f2f;">‚ùå ${data.message}</p>`;
            showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        resultDiv.innerHTML = `<p style="color: #d32f2f;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ${error}</p>`;
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –±–æ—Ç–∞', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

// –î–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
const DATABASE_TABLES = [
    { name: 'users', description: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', icon: 'fas fa-users' },
    { name: 'transactions', description: '–ü–ª–∞—Ç–µ–∂–∏', icon: 'fas fa-credit-card' },
    { name: 'vpn_keys', description: 'VPN –∫–ª—é—á–∏', icon: 'fas fa-key' },
    { name: 'promo_codes', description: '–ü—Ä–æ–º–æ–∫–æ–¥—ã', icon: 'fas fa-ticket-alt' },
    { name: 'promo_code_usage', description: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã', icon: 'fas fa-history' },
    { name: 'notifications', description: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', icon: 'fas fa-bell' },
    { name: 'video_instructions', description: '–í–∏–¥–µ–æ–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏', icon: 'fas fa-video' },
    { name: 'bot_settings', description: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', icon: 'fas fa-cog' },
    { name: 'xui_hosts', description: '–•–æ—Å—Ç—ã XUI', icon: 'fas fa-server' },
    { name: 'hosts', description: '–•–æ—Å—Ç—ã', icon: 'fas fa-server' },
    { name: 'plans', description: '–¢–∞—Ä–∏—Ñ—ã', icon: 'fas fa-list-alt' },
    { name: 'support_threads', description: '–ó–∞–ø—Ä–æ—Å—ã –≤ —Å–∞–ø–ø–æ—Ä—Ç', icon: 'fas fa-comments' }
];

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
async function loadDatabaseStats() {
    const tbody = document.getElementById('database-tables-tbody');
    if (!tbody) return;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;"><div class="loading-spinner"></div> –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</td></tr>';
    
    try {
        const response = await fetch('/api/database/stats', {
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success) {
            renderDatabaseTables(data.tables);
        } else {
            throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc3545; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</td></tr>';
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
function renderDatabaseTables(tablesData) {
    const tbody = document.getElementById('database-tables-tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    DATABASE_TABLES.forEach(table => {
        const tableData = tablesData[table.name] || { count: 0, size: '0 KB' };
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="${table.icon}" style="color: var(--primary-color);"></i>
                    <span class="table-name">${table.name}</span>
                </div>
            </td>
            <td class="table-description">${table.description}</td>
            <td class="table-count">${tableData.count.toLocaleString()}</td>
            <td class="table-size">${tableData.size}</td>
            <td class="table-actions">
                <button class="delete-table-btn" onclick="confirmDeleteTable('${table.name}', '${table.description}')" 
                        ${tableData.count === 0 ? 'disabled' : ''} 
                        title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã ${table.name}">
                    <i class="fas fa-trash"></i>
                    –£–¥–∞–ª–∏—Ç—å
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
function confirmDeleteTable(tableName, tableDescription) {
    const modalHtml = `
    <div class="modal-backdrop">
        <div class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" style="margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!
                    </div>
                    <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å <strong>–≤—Å–µ –∑–∞–ø–∏—Å–∏</strong> –∏–∑ —Ç–∞–±–ª–∏—Ü—ã <code>${tableName}</code>?</p>
                    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${tableDescription}</p>
                    <div class="form-group" style="margin-top: 20px;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="confirmDeleteCheckbox" required>
                            <span>–Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é —É–¥–∞–ª–µ–Ω–∏–µ</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button button-secondary" onclick="closeModal()" title="–û—Ç–º–µ–Ω–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ">
                        <i class="fas fa-times"></i>
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="button" class="button button-danger" onclick="deleteTable('${tableName}')" id="deleteConfirmBtn" disabled title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã">
                        <i class="fas fa-trash"></i>
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>`;
    
    showModal(modalHtml);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    document.getElementById('confirmDeleteCheckbox').addEventListener('change', function() {
        document.getElementById('deleteConfirmBtn').disabled = !this.checked;
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
async function deleteTable(tableName) {
    const deleteBtn = document.getElementById('deleteConfirmBtn');
    const originalText = deleteBtn.innerHTML;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<div class="loading-spinner"></div> –£–¥–∞–ª–µ–Ω–∏–µ...';
    
    try {
        const response = await fetch(`/api/database/delete-table/${tableName}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`–¢–∞–±–ª–∏—Ü–∞ ${tableName} —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞. –£–¥–∞–ª–µ–Ω–æ ${data.deleted_count} –∑–∞–ø–∏—Å–µ–π.`, 'success');
            closeModal();
            loadDatabaseStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        } else {
            throw new Error(data.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
    }
}

// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
async function downloadDatabase() {
    const downloadBtn = document.querySelector('button[onclick="downloadDatabase()"]');
    const originalText = downloadBtn.innerHTML;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    downloadBtn.disabled = true;
    downloadBtn.innerHTML = '<div class="loading-spinner"></div> –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';
    
    try {
        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const link = document.createElement('a');
        link.href = '/api/database/download';
        link.download = `database_backup_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.db`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –≤ DOM –∏ –∫–ª–∏–∫–∞–µ–º –ø–æ –Ω–µ–π
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('–ù–∞—á–∞—Ç–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö', 'success');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        downloadBtn.disabled = false;
        downloadBtn.innerHTML = originalText;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
function refreshDatabaseStats() {
    loadDatabaseStats();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö"
document.addEventListener('DOMContentLoaded', function() {
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    const originalShowTab = window.showTab;
    window.showTab = function(tabName, el) {
        originalShowTab(tabName, el);
        
        // –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö", –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        if (tabName === 'database') {
            loadDatabaseStats();
        }
    };
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–æ–º–µ–Ω–∞ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
function openDomain(inputId) {
    const input = document.getElementById(inputId);
    if (!input) {
        console.error('–ü–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:', inputId);
        return;
    }
    
    let url = input.value.trim();
    
    // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (!url) {
        showNotification('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω –≤ –ø–æ–ª–µ', 'warning');
        input.focus();
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
    }
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
    try {
        window.open(url, '_blank');
        showNotification('–û—Ç–∫—Ä—ã–≤–∞—é –¥–æ–º–µ–Ω –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ', 'success');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–æ–º–µ–Ω–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–æ–º–µ–Ω–∞: ' + error.message, 'error');
    }
}

// ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ë–ï–ö–ê–ü–û–í ====================

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–µ–∫–∞–ø–æ–≤
async function loadBackupStatus() {
    try {
        const response = await fetch('/api/backup/status');
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        document.getElementById('backup-status').textContent = 
            data.enabled ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞' : '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–∞';
        document.getElementById('backup-status').className = 
            data.enabled ? 'status-text' : 'error-text';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–µ–∫–∞–ø–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç last_backup_panel)
        if (data.last_backup_panel || data.last_backup_msk || data.last_backup) {
            const lastIso = data.last_backup_panel || data.last_backup_msk || data.last_backup;
            const formattedLastBackup = formatPanelDateTime(lastIso);
            document.getElementById('last-backup-time').textContent = formattedLastBackup !== 'N/A' ? formattedLastBackup : (lastIso || '–ù–∏–∫–æ–≥–¥–∞');
        } else {
            document.getElementById('last-backup-time').textContent = '–ù–∏–∫–æ–≥–¥–∞';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–µ–∫–∞–ø–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç next_backup_panel)
        if (data.next_backup_panel || data.next_backup_msk || data.next_backup) {
            const nextIso = data.next_backup_panel || data.next_backup_msk || data.next_backup;
            const formattedNextBackup = formatPanelDateTime(nextIso);
            document.getElementById('next-backup-time').textContent = formattedNextBackup !== 'N/A' ? formattedNextBackup : (nextIso || '‚Äî');
        } else {
            document.getElementById('next-backup-time').textContent = '‚Äî';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ–∫–∞–ø–æ–≤
        document.getElementById('backup-count').textContent = data.total_backups;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä
        document.getElementById('backup-size').textContent = formatBytes(data.total_size);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–µ—É–¥–∞—á–Ω—ã–µ –±–µ–∫–∞–ø—ã
        document.getElementById('failed-backups').textContent = data.failed_backups;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–µ–∫–∞–ø–æ–≤:', error);
        document.getElementById('backup-status').textContent = '‚ùå –û—à–∏–±–∫–∞';
        document.getElementById('backup-status').className = 'error-text';
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∫–∞–ø–æ–≤
async function loadBackupSettings() {
    try {
        const response = await fetch('/api/backup/settings');
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
        const enabledCheckbox = document.querySelector('input[name="backup_enabled"]');
        const intervalSelect = document.querySelector('select[name="backup_interval_hours"]');
        const retentionSelect = document.querySelector('select[name="backup_retention_days"]');
        const compressionCheckbox = document.querySelector('input[name="backup_compression"]');
        const verifyCheckbox = document.querySelector('input[name="backup_verify"]');
        
        if (enabledCheckbox) enabledCheckbox.checked = data.backup_enabled === 'True';
        if (intervalSelect) {
            intervalSelect.value = data.backup_interval_hours || '24';
            intervalSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }
        if (retentionSelect) {
            retentionSelect.value = data.backup_retention_days || '30';
            retentionSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }
        if (compressionCheckbox) compressionCheckbox.checked = data.backup_compression === 'True';
        if (verifyCheckbox) verifyCheckbox.checked = data.backup_verify === 'True';
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∫–∞–ø–æ–≤:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∫–∞–ø–æ–≤', 'error');
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∫–∞–ø–æ–≤
async function saveBackupSettings(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ (—á–∏—Ç–∞–µ–º –±—É–ª–µ–≤—ã –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —á–µ–∫–±–æ–∫—Å–æ–≤)
    const settings = {
        backup_enabled: document.querySelector('input[name="backup_enabled"]').checked,
        backup_interval_hours: parseInt(formData.get('backup_interval_hours')),
        backup_retention_days: parseInt(formData.get('backup_retention_days')),
        backup_compression: document.querySelector('input[name="backup_compression"]').checked,
        backup_verify: document.querySelector('input[name="backup_verify"]').checked
    };
    
    const saveBtn = form.querySelector('button[type="submit"]');
    const originalText = saveBtn.innerHTML;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<div class="loading-spinner"></div> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    
    try {
        const response = await fetch('/api/backup/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∫–∞–ø–æ–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        loadBackupStatus(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        
        // –°–æ–∑–¥–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–µ–∫–∞–ø –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
        createAutoBackup();
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
        setTimeout(() => {
            window.location.reload();
        }, 2000);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∫–∞–ø–æ–≤:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –±–µ–∫–∞–ø–∞ –≤—Ä—É—á–Ω—É—é
async function createManualBackup() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<div class="loading-spinner"></div> –°–æ–∑–¥–∞–Ω–∏–µ...';
    
    try {
        const response = await fetch('/api/backup/create', { method: 'POST' });
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification(`–ë–µ–∫–∞–ø —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: ${data.backup_name}`, 'success');
            loadBackupStatus(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–∫–∞–ø–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–∫–∞–ø–∞: ' + error.message, 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±–µ–∫–∞–ø–∞ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
async function createAutoBackup() {
    try {
        console.log('–°–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –±–µ–∫–∞–ø–∞ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫...');
        const response = await fetch('/api/backup/create', { method: 'POST' });
        const data = await response.json();
        
        if (data.status === 'success') {
            console.log(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–µ–∫–∞–ø —Å–æ–∑–¥–∞–Ω: ${data.backup_name}`);
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–µ–∫–∞–ø–æ–≤
            loadBackupStatus();
        } else {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–µ–∫–∞–ø:', data.message);
        }
    } catch (error) {
        console.warn('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –±–µ–∫–∞–ø–∞:', error);
        // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    }
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –±–µ–∫–∞–ø–æ–≤
async function viewBackups() {
    try {
        const response = await fetch('/api/backup/list');
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ —Å–ø–∏—Å–∫–æ–º –±–µ–∫–∞–ø–æ–≤
        showBackupListModal(data);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –±–µ–∫–∞–ø–æ–≤:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –±–µ–∫–∞–ø–æ–≤: ' + error.message, 'error');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±–µ–∫–∞–ø–æ–≤
async function refreshBackupStatus() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<div class="loading-spinner"></div> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    
    try {
        await loadBackupStatus();
        showNotification('–°—Ç–∞—Ç—É—Å –±–µ–∫–∞–ø–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –±–µ–∫–∞–ø–æ–≤
function showBackupListModal(data) {
    const modalHtml = `
        <div class="modal-backdrop">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="backupListTitle">
                <div class="modal-content modal-content--medium">
                    <div class="modal-header">
                        <h3 id="backupListTitle">–°–ø–∏—Å–æ–∫ –±–µ–∫–∞–ø–æ–≤</h3>
                        <span class="close" onclick="closeModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="backup-list-stats">
                            <p><strong>–í—Å–µ–≥–æ –±–µ–∫–∞–ø–æ–≤:</strong> ${data.total_backups}</p>
                            <p><strong>–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä:</strong> ${formatBytes(data.total_size)}</p>
                            <p><strong>–ù–µ—É–¥–∞—á–Ω—ã—Ö –±–µ–∫–∞–ø–æ–≤:</strong> ${data.failed_backups}</p>
                        </div>
                        <div class="backup-list">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>–ë–µ–∫–∞–ø</th>
                                        <th>–†–∞–∑–º–µ—Ä</th>
                                        <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (GMT+3)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.backups ? data.backups.map(backup => `
                                        <tr>
                                            <td>${backup.display_name || backup.name}</td>
                                            <td>${formatBytes(backup.size)}</td>
                                            <td>${(() => {
                                                const formatted = formatPanelDate(backup.created_at_msk || backup.created_at, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                                                return formatted !== 'N/A' ? formatted : ((backup.created_at_msk || backup.created_at) || 'N/A')
                                            })()}</td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="3">–ë–µ–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    showModal(modalHtml);
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –≤ –±–∞–π—Ç–∞—Ö
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∫–∞–ø–æ–≤
    const backupForm = document.getElementById('backup-settings-form');
    if (backupForm) {
        backupForm.addEventListener('submit', saveBackupSettings);
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ –±–µ–∫–∞–ø–æ–≤
    const backupTab = document.getElementById('backup-tab');
    if (backupTab) {
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadBackupSettings();
        loadBackupStatus();
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
        setTimeout(function() {
            loadBackupSettings();
            loadBackupStatus();
        }, 500);
        
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (backupTab.classList.contains('active')) {
                        loadBackupSettings();
                        loadBackupStatus();
                    }
                }
            });
        });
        observer.observe(backupTab, { attributes: true });
    }
});

// ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ì–†–£–ü–ü–ê–ú–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ====================

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–æ–¥–≤–∫–ª–∞–¥–∫–∞–º–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
function showDirectoryTab(tabName, button) {
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.directories-navigation .nav-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.directory-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É –∏ –ø–æ–¥–≤–∫–ª–∞–¥–∫—É
    button.classList.add('active');
    document.getElementById(tabName + '-directory-tab').classList.add('active');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏
    if (tabName === 'groups') {
        loadGroupsData();
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
async function loadGroupsData() {
    try {
        const response = await fetch('/api/user-groups');
        const data = await response.json();
        
        if (data.success) {
            displayGroups(data.groups);
            loadGroupsStatistics();
        } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', data.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', error);
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä—É–ø–ø –≤ —Ç–∞–±–ª–∏—Ü–µ
function displayGroups(groups) {
    const tbody = document.getElementById('groups-table-body');
    tbody.innerHTML = '';
    
    groups.forEach(group => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${group.group_id}</td>
            <td>
                <span class="group-name">${group.group_name}</span>
            </td>
            <td>
                <span class="group-code">${group.group_code || '‚Äî'}</span>
            </td>
            <td>
                <span class="group-description">${group.group_description || '‚Äî'}</span>
            </td>
            <td>
                <span class="user-count">${group.user_count}</span>
                <button class="button button-secondary button-xs" onclick="showGroupUsers(${group.group_id}, '${group.group_name}')" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥—Ä—É–ø–ø—ã">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
            <td>
                ${group.is_default ? '<span class="badge badge-success">–î–∞</span>' : '<span class="badge badge-secondary">–ù–µ—Ç</span>'}
            </td>
            <td>${(() => {
                const formatted = formatPanelDateTime(group.created_date, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                return formatted !== 'N/A' ? formatted : (group.created_date || 'N/A')
            })()}</td>
            <td class="actions-cell">
                <div class="kebab-wrapper">
                    <button class="kebab-btn" onclick="toggleKebabMenu('kebab-group-${group.group_id}')" title="–î–µ–π—Å—Ç–≤–∏—è —Å –≥—Ä—É–ø–ø–æ–π">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="kebab-menu" id="kebab-group-${group.group_id}">
                        <button type="button" class="kebab-item" onclick="editGroup(${group.group_id}, '${(group.group_name || '').replace(/'/g, "\\'")}', '${(group.group_description || '').replace(/'/g, "\\'")}', '${(group.group_code || '').replace(/'/g, "\\'")}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É">
                            <i class="fas fa-edit"></i>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        ${!group.is_default ? `
                        <button type="button" class="kebab-item danger" onclick="deleteGroup(${group.group_id}, '${(group.group_name || '').replace(/'/g, "\\'")}', ${group.user_count})" title="–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É">
                            <i class="fas fa-trash"></i>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                        ` : ''}
                    </div>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥—Ä—É–ø–ø
async function loadGroupsStatistics() {
    try {
        const response = await fetch('/api/user-groups/statistics');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('total-groups-count').textContent = data.statistics.total_groups;
            document.getElementById('total-users-count').textContent = data.statistics.total_users;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥—Ä—É–ø–ø:', error);
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π –≥—Ä—É–ø–ø—ã
let currentEditingGroupId = null;

// Drawer –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã
function openGroupModal(groupId = null, groupName = '', groupDescription = '', groupCode = '') {
    const drawer = document.getElementById('groupDrawer');
    if (!drawer) {
        console.error('Drawer element not found');
        return;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≥—Ä—É–ø–ø—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ saveGroup
    currentEditingGroupId = groupId;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏
    document.getElementById('groupName').value = groupName;
    document.getElementById('groupCode').value = groupCode;
    document.getElementById('groupDescription').value = groupDescription;
    document.getElementById('isDefault').checked = false;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.getElementById('groupDrawerTitle');
    title.textContent = groupId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É' : '–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º drawer
    drawer.style.display = 'flex';
    setTimeout(() => {
        document.getElementById('groupDrawerPanel').classList.add('open');
    }, 10);
    
    // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    document.getElementById('groupName').focus();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã
async function saveGroup() {
    const groupName = document.getElementById('groupName').value.trim();
    const groupCode = document.getElementById('groupCode').value.trim();
    const groupDescription = document.getElementById('groupDescription').value.trim();
    const isDefault = document.getElementById('isDefault').checked;
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è ID –≥—Ä—É–ø–ø—ã
    const groupId = currentEditingGroupId;
    
    const data = {
        group_name: groupName,
        group_description: groupDescription,
        is_default: isDefault
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º group_code —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ –ø—É—Å—Ç–æ–π
    if (groupCode) {
        data.group_code = groupCode;
    }
    
    if (!data.group_name) {
        alert('–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –≥—Ä—É–ø–ø—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
    if (data.group_code && !data.group_code.trim()) {
        alert('–ö–æ–¥ –≥—Ä—É–ø–ø—ã –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
        return;
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞ –≥—Ä—É–ø–ø—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω)
    if (data.group_code) {
        const codePattern = /^[a-z0-9_-]+$/;
        if (!codePattern.test(data.group_code)) {
            alert('–ö–æ–¥ –≥—Ä—É–ø–ø—ã –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ');
            return;
        }
    }
    
    try {
        const url = groupId ? `/api/user-groups/${groupId}` : '/api/user-groups';
        const method = groupId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeGroupDrawer();
            loadGroupsData();
            showNotification(result.message, 'success');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã');
    }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
function editGroup(groupId, groupName, groupDescription, groupCode = '') {
    closeKebabMenu(`kebab-group-${groupId}`);
    openGroupModal(groupId, groupName, groupDescription, groupCode);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ drawer –≥—Ä—É–ø–ø
function closeGroupDrawer() {
    const drawerPanel = document.getElementById('groupDrawerPanel');
    drawerPanel.classList.remove('open');
    
    setTimeout(() => {
        document.getElementById('groupDrawer').style.display = 'none';
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('group-form').reset();
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        document.getElementById('groupDrawerTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É';
        // –û—á–∏—â–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        currentEditingGroupId = null;
    }, 300);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã
async function deleteGroup(groupId, groupName, userCount) {
    closeKebabMenu(`kebab-group-${groupId}`);
    
    const message = userCount > 0 
        ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É "${groupName}"?\n\n–í –≥—Ä—É–ø–ø–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è ${userCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –û–Ω–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –≤ –≥—Ä—É–ø–ø—É "–ì–æ—Å—Ç—å".`
        : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É "${groupName}"?`;
    
    if (!confirm(message)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/user-groups/${groupId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadGroupsData();
            showNotification(result.message, 'success');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã:', error);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã');
    }
}

// Inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã
function editGroupName(groupId, currentName) {
    const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:', currentName);
    if (newName && newName.trim() && newName.trim() !== currentName) {
        updateGroupField(groupId, 'group_name', newName.trim());
    }
}

// Inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã
function editGroupDescription(groupId, currentDescription) {
    const newDescription = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:', currentDescription);
    if (newDescription !== null && newDescription.trim() !== currentDescription) {
        updateGroupField(groupId, 'group_description', newDescription.trim());
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è –≥—Ä—É–ø–ø—ã
async function updateGroupField(groupId, field, value) {
    try {
        const data = {};
        data[field] = value;
        
        const response = await fetch(`/api/user-groups/${groupId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadGroupsData();
            showNotification('–ì—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã:', error);
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥—Ä—É–ø–ø—ã
async function showGroupUsers(groupId, groupName) {
    try {
        const response = await fetch(`/api/user-groups/${groupId}/users`);
        const data = await response.json();
        
        if (data.success) {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≥—Ä—É–ø–ø—ã "${groupName}"</h3>
                            <button class="modal-close" onclick="closeGroupUsersModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="users-list">
                                ${data.users.length > 0 ? data.users.map(user => `
                                    <div class="user-item">
                                        <div class="user-info">
                                            <strong>ID:</strong> ${user.telegram_id}<br>
                                            <strong>Username:</strong> @${user.username || 'N/A'}<br>
                                            <strong>–ò–º—è:</strong> ${user.fullname || 'N/A'}<br>
                                            <strong>–§–ò–û:</strong> ${user.fio || 'N/A'}<br>
                                            <strong>Email:</strong> ${user.email || 'N/A'}
                                        </div>
                                    </div>
                                `).join('') : '<p>–í –≥—Ä—É–ø–ø–µ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>'}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="button button-secondary" onclick="closeGroupUsersModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
                                <i class="fas fa-times"></i>
                                –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥—Ä—É–ø–ø—ã: ' + data.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥—Ä—É–ø–ø—ã:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥—Ä—É–ø–ø—ã');
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥—Ä—É–ø–ø—ã
function closeGroupUsersModal() {
    const modal = document.querySelector('.modal-backdrop');
    if (modal) {
        modal.remove();
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
    const directoriesTab = document.getElementById('directories-tab');
    if (directoriesTab) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (directoriesTab.classList.contains('active')) {
                        loadGroupsData();
                    }
                }
            });
        });
        observer.observe(directoriesTab, { attributes: true });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞
        if (directoriesTab.classList.contains('active')) {
            loadGroupsData();
        }
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ drawer –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
    document.getElementById('groupDrawer')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeGroupDrawer();
        }
    });
});

</script>



<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ */
.directories-navigation {
    margin-bottom: 20px;
    border-bottom: 1px solid #444;
    padding-bottom: 10px;
}

.directories-navigation .nav-button {
    margin-right: 10px;
    margin-bottom: 5px;
}

.directory-tab {
    display: none;
}

.directory-tab.active {
    display: block;
}

.directory-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #444;
}

.directory-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.stat-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.stat-label {
    font-size: 14px;
    color: #aaa;
}

.stat-value {
    font-size: 18px;
    font-weight: bold;
    color: #fff;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –≥—Ä—É–ø–ø */
.groups-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.groups-table th,
.groups-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #444;
}

.groups-table th {
    background: rgba(255, 255, 255, 0.1);
    font-weight: bold;
    color: #fff;
}

.groups-table td {
    color: #ccc;
}

.group-name-cell,
.group-description-cell {
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
}

.group-name,
.group-description {
    flex: 1;
}

.edit-group-name,
.edit-group-description {
    cursor: pointer;
    color: #007bff;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.edit-group-name:hover,
.edit-group-description:hover {
    opacity: 1;
}

.user-count {
    font-weight: bold;
    margin-right: 8px;
}

.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.badge-success {
    background: #28a745;
    color: white;
}

.badge-secondary {
    background: #6c757d;
    color: white;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≥—Ä—É–ø–ø */
#group-form .form-group {
    margin-bottom: 15px;
}

#group-form label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #fff;
}

#group-form input,
#group-form textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #555;
    border-radius: 4px;
    background: #333;
    color: #fff;
    font-size: 14px;
}

#group-form input:focus,
#group-form textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥—Ä—É–ø–ø—ã */
.users-list {
    max-height: 400px;
    overflow-y: auto;
}

.user-item {
    padding: 15px;
    margin-bottom: 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px solid #444;
}

.user-info {
    color: #ccc;
    line-height: 1.6;
}

.user-info strong {
    color: #fff;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ */
@media (max-width: 768px) {
    .directory-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .directory-stats {
        flex-direction: column;
        gap: 10px;
    }
    
    .groups-table {
        font-size: 14px;
    }
    
    .groups-table th,
    .groups-table td {
        padding: 8px;
    }
}

/* Drawer —Å—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∞–≤–Ω—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π */
.drawer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: flex;
    justify-content: flex-end;
    align-items: stretch;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.drawer-overlay[style*="display: flex"] {
    opacity: 1;
}

.drawer {
    background: var(--bg-surface);
    width: 100%;
    max-width: 600px;
    height: 100%;
    display: flex;
    flex-direction: column;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.drawer.open {
    transform: translateX(0);
}

.drawer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.drawer-header h3 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
}

.drawer-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-muted);
    transition: color 0.2s ease;
}

.drawer-close:hover {
    color: var(--text-primary);
}

.drawer-body {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.drawer-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-top: 1px solid var(--border-color);
    gap: 12px;
}

.drawer-footer-left,
.drawer-footer-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    .drawer {
        max-width: 100%;
    }
    
    .drawer-footer {
        flex-direction: column;
        gap: 12px;
    }
    
    .drawer-footer-left,
    .drawer-footer-right {
        width: 100%;
        justify-content: center;
    }
}
</style>

<!-- Drawer –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–∞–º–∏ -->
<div id="groupDrawer" class="drawer-overlay" style="display: none;">
    <div class="drawer" id="groupDrawerPanel">
        <div class="drawer-header">
            <h3 id="groupDrawerTitle">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</h3>
            <button class="drawer-close" onclick="closeGroupDrawer()" title="–ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="drawer-body">
            <form id="group-form">
                <div class="form-group">
                    <label for="groupName">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
                    <input type="text" id="groupName" name="groupName" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
                </div>
                <div class="form-group">
                    <label for="groupCode">–ö–æ–¥ –≥—Ä—É–ø–ø—ã:</label>
                    <input type="text" id="groupCode" name="groupCode" title="–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: friends)" required>
                    <small class="form-help">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ deeplink. –¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ</small>
                </div>
                <div class="form-group">
                    <label for="groupDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="groupDescription" name="groupDescription" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã"></textarea>
                </div>
                <div class="form-group form-group-checkbox">
                    <input type="hidden" name="isDefault" value="false" />
                    <input type="checkbox" id="isDefault" name="isDefault" value="true">
                    <label for="isDefault">–ì—Ä—É–ø–ø–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                </div>
            </form>
        </div>

        <!-- Footer —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="drawer-footer">
            <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
            <div class="drawer-footer-left">
                <button type="button" class="button button-secondary" onclick="closeGroupDrawer()" title="–û—Ç–º–µ–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å">
                    <i class="fas fa-times"></i>
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
            <div class="drawer-footer-right">
                <button type="button" class="button button-primary" onclick="saveGroup()" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É">
                    <i class="fas fa-save"></i>
                    <span id="groupSubmitBtnText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
