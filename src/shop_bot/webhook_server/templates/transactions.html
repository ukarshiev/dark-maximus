{% extends "base.html" %} {% block title %}–ù–µ–¥–∞–≤–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏{% endblock %} {%
block content %}

<div class="transactions-container">
	<div class="transactions-header">
		<h1 style="text-align: center;">–ü–ª–∞—Ç–µ–∂–∏</h1>
	</div>

	<section class="transactions-section">
		<div class="transactions-table">
			<table>
				<thead>
					<tr>
						<th>ID</th>
						<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
						<th>–•–æ—Å—Ç</th>
						<th>–ü–ª–∞–Ω</th>
						<th>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</th>
						<th>–¶–µ–Ω–∞</th>
						<th>–ó–≤–µ–∑–¥—ã</th>
						<th>–°—Ç–∞—Ç—É—Å</th>
						<th>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è</th>
						<th>–î–∞—Ç–∞</th>
                        <th>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</th>
						<th>–ö–ª—é—á</th>
					</tr>
				</thead>
				<tbody>
					{% for tx in transactions %}
					<tr class="tx-row">
						<td>{{ tx.transaction_id }}</td>
						<td>
							<div class="user-info">
								<div data-field="user_id" data-original="{{ tx.user_id }}">
									<div class="cell-inline">
										<div class="cell-left">
											<strong>ID:</strong>
											<span>{{ hidden_mode and '***' or tx.user_id }}</span>
										</div>
										<div class="cell-actions">
											<button class="modal-action-btn" onclick="openUserModal({{ tx.user_id }}, '{{ tx.username or 'N/A' }}', false, 0)" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É">üîç</button>
										</div>
									</div>
								</div>
								<div data-field="tx_username" data-original="{{ tx.username or 'N/A' }}"><strong>Username:</strong> {{ hidden_mode and '***' or (tx.username or 'N/A') }}</div>
							</div>
						</td>
                        <td>{{ tx.host_name }}</td>
                        <td>
                            {% if tx.metadata and tx.metadata.get('operation') == 'topup' %}
                                -
                            {% else %}
                                {{ tx.plan_name or 'N/A' }}
                            {% endif %}
                        </td>
						<td>{{ tx.payment_method or '-' }}</td>
						<td data-field="price" data-original="{{ tx.amount_rub | round(2) }} RUB">{{ hidden_mode and '*** RUB' or (tx.amount_rub | round(2)) ~ ' RUB' }}</td>
						<td>
							{% if tx.payment_method == 'Stars' %}
								{% set meta = tx.metadata %}
								{% if meta %}
									{% set stars = meta.get('stars_paid') or (tx.amount_currency) %}
									{% set rate = meta.get('stars_rate') %}
									{{ (stars | int) }}‚≠êÔ∏è{% if rate %} - {{ rate }}{% endif %}
								{% else %}
									{{ (tx.amount_currency or 0) | int }}‚≠êÔ∏è
								{% endif %}
							{% else %}-{% endif %}
						</td>
						<td>
							{% if tx.status == 'paid' %}
								<span class="status-badge status-paid">–û–ø–ª–∞—á–µ–Ω–æ</span>
							{% elif tx.status == 'pending' %}
								<span class="status-badge status-pending">–û–∂–∏–¥–∞–µ—Ç</span>
							{% else %}
								<span class="status-badge status-{{ tx.status }}">{{ tx.status }}</span>
							{% endif %}
						</td>
						<td>
							<div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
								{% if tx.transaction_hash %}
									{% if tx.payment_method == 'TON Connect' %}
										<a href="https://tonscan.org/tx/{{ tx.transaction_hash }}" target="_blank" class="transaction-link">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>
									{% elif tx.payment_method == 'Stars' %}
										<button class="copy-btn" onclick="copyPaymentLink('{{ tx.transaction_hash }}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID">üìã</button>
									{% else %}
										<code>{{ tx.transaction_hash }}</code>
									{% endif %}
								{% else %}
									<span>-</span>
								{% endif %}

								{% if tx.payment_link %}
									<button class="copy-btn" onclick="copyPaymentLink('{{ tx.payment_link }}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">üìã</button>
								{% endif %}
							</div>
						</td>
						<td>
							{% if tx.created_date %}
								{{ tx.created_date.strftime('%Y-%m-%d %H:%M:%S') }}
							{% else %}
								N/A
							{% endif %}
						</td>
                        <td>
                            {% if tx.metadata %}
                                {% if tx.metadata.get('operation') == 'topup' %}
                                    –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
                                {% elif tx.metadata.get('action') %}
                                    {% if tx.metadata.get('action') == 'new' %}–Ω–æ–≤—ã–π{% else %}–ø—Ä–æ–¥–ª–µ–Ω–∏–µ{% endif %}
                                {% else %}-{% endif %}
                            {% else %}-{% endif %}
                        </td>
						<td>
							{% if tx.metadata and tx.metadata.get('connection_string') %}
								<div class="key-cell">
									<span class="key-text" title="{{ tx.metadata.get('connection_string') }}">{{ tx.metadata.get('connection_string')[:40] }}{% if tx.metadata.get('connection_string')|length > 40 %}...{% endif %}</span>
									<button class="copy-btn" onclick="copyPaymentLink('{{ tx.metadata.get('connection_string') }}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á">üìã</button>
								</div>
							{% else %}
								-
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</section>

	<!-- –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
	<div class="pagination-panel">
		<div class="pagination-controls">
			<!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
			<button class="button button-primary button-small-refresh" onclick="refreshTransactions()" id="refreshBtn">
				<span id="refreshIcon">üîÑ</span>
				<span id="refreshText">–û–±–Ω–æ–≤–∏—Ç—å</span>
			</button>
			
			<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
			{% if total_pages > 1 %}
			<div class="pagination">
				{% if current_page > 1 %}
					<a href="{{ url_for('transactions_page', page=current_page-1, per_page=per_page) }}" class="pagination-link">¬´</a>
				{% endif %}
				
				{% for p in range(1, total_pages + 1) %}
					{% if p == current_page %}
						<span class="pagination-link active">{{ p }}</span>
					{% else %}
						<a href="{{ url_for('transactions_page', page=p, per_page=per_page) }}" class="pagination-link">{{ p }}</a>
					{% endif %}
				{% endfor %}
				
				{% if current_page < total_pages %}
					<a href="{{ url_for('transactions_page', page=current_page+1, per_page=per_page) }}" class="pagination-link">¬ª</a>
				{% endif %}
			</div>
			{% endif %}
			
			<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π -->
			<div class="per-page-selector">
				<select id="perPageSelect" onchange="changePerPage(this.value)">
					<option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
					<option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
					<option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
					<option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
					<option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
				</select>
			</div>
		</div>
	</div>
</div>

<script>
function changePerPage(value) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', value);
    url.searchParams.set('page', '1'); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    window.location.href = url.toString();
}

function refreshTransactions() {
    const refreshBtn = document.getElementById('refreshBtn');
    const refreshIcon = document.getElementById('refreshIcon');
    const refreshText = document.getElementById('refreshText');
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    refreshBtn.disabled = true;
    refreshIcon.classList.add('spinning');
    refreshText.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    fetch('/refresh-transactions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            refreshText.textContent = data.message;
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            refreshText.textContent = '–û—à–∏–±–∫–∞: ' + data.message;
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                refreshBtn.disabled = false;
                refreshIcon.classList.remove('spinning');
                refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        refreshText.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            refreshBtn.disabled = false;
            refreshIcon.classList.remove('spinning');
            refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
        }, 2000);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É
function copyPaymentLink(link) {
    navigator.clipboard.writeText(link).then(() => {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.textContent = '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
        `;
        document.body.appendChild(notification);
        
        // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 2000);
    }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
    });
}
</script>

{% endblock %}
