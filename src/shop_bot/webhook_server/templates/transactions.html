{% extends "base.html" %} {% block title %}–ù–µ–¥–∞–≤–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏{% endblock %} {%
block content %}

<div class="transactions-container">
	<div class="transactions-header">
		<h1 style="text-align: center;">–ü–ª–∞—Ç–µ–∂–∏</h1>
	</div>

	<section class="transactions-section">
		<div class="transactions-table">
			<table>
				<thead>
					<tr>
						<th>ID</th>
						<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
						<th>–•–æ—Å—Ç</th>
						<th>–ü–ª–∞–Ω</th>
						<th>–¶–µ–Ω–∞</th>
						<th>–°—Ç–∞—Ç—É—Å</th>
						<th>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è</th>
						<th>–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É</th>
						<th>–î–∞—Ç–∞</th>
					</tr>
				</thead>
				<tbody>
					{% for tx in transactions %}
					<tr>
						<td>{{ tx.transaction_id }}</td>
						<td>
							<div class="user-info">
								<div><strong>ID:</strong> 
									<a href="#" class="user-id-link" onclick="openUserModal({{ tx.user_id }}, '{{ tx.username or 'N/A' }}', false, 0)">
										{{ tx.user_id }}
									</a>
								</div>
								<div><strong>Username:</strong> {{ tx.username or 'N/A' }}</div>
								<div><strong>Email:</strong> {{ tx.customer_email or 'N/A' }}</div>
							</div>
						</td>
						<td>{{ tx.host_name }}</td>
						<td>{{ tx.plan_name or 'N/A' }}</td>
						<td>{{ tx.amount_rub | round(2) }} RUB</td>
						<td>
							{% if tx.status == 'paid' %}
								<span class="status-badge status-paid">–û–ø–ª–∞—á–µ–Ω–æ</span>
							{% elif tx.status == 'pending' %}
								<span class="status-badge status-pending">–û–∂–∏–¥–∞–µ—Ç</span>
							{% else %}
								<span class="status-badge status-{{ tx.status }}">{{ tx.status }}</span>
							{% endif %}
						</td>
						<td>
							{% if tx.transaction_hash %}
								<a href="https://tonscan.org/tx/{{ tx.transaction_hash }}" target="_blank" class="transaction-link">
									–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
								</a>
							{% else %}
								-
							{% endif %}
						</td>
						<td>
							{% if tx.payment_link %}
								<button class="copy-btn" onclick="copyPaymentLink('{{ tx.payment_link }}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
									üìã
								</button>
							{% else %}
								-
							{% endif %}
						</td>
						<td>
							{% if tx.created_date %}
								{{ tx.created_date.strftime('%Y-%m-%d %H:%M:%S') }}
							{% else %}
								N/A
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</section>

	<!-- –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
	<div class="pagination-panel">
		<div class="pagination-controls">
			<!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
			<button class="button button-primary button-small-refresh" onclick="refreshTransactions()" id="refreshBtn">
				<span id="refreshIcon">üîÑ</span>
				<span id="refreshText">–û–±–Ω–æ–≤–∏—Ç—å</span>
			</button>
			
			<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
			{% if total_pages > 1 %}
			<div class="pagination">
				{% if current_page > 1 %}
					<a href="{{ url_for('transactions_page', page=current_page-1, per_page=per_page) }}" class="pagination-link">¬´</a>
				{% endif %}
				
				{% for p in range(1, total_pages + 1) %}
					{% if p == current_page %}
						<span class="pagination-link active">{{ p }}</span>
					{% else %}
						<a href="{{ url_for('transactions_page', page=p, per_page=per_page) }}" class="pagination-link">{{ p }}</a>
					{% endif %}
				{% endfor %}
				
				{% if current_page < total_pages %}
					<a href="{{ url_for('transactions_page', page=current_page+1, per_page=per_page) }}" class="pagination-link">¬ª</a>
				{% endif %}
			</div>
			{% endif %}
			
			<!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π -->
			<div class="per-page-selector">
				<select id="perPageSelect" onchange="changePerPage(this.value)">
					<option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
					<option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
					<option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
					<option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
					<option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
				</select>
			</div>
		</div>
	</div>
</div>

<script>
function changePerPage(value) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', value);
    url.searchParams.set('page', '1'); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    window.location.href = url.toString();
}

function refreshTransactions() {
    const refreshBtn = document.getElementById('refreshBtn');
    const refreshIcon = document.getElementById('refreshIcon');
    const refreshText = document.getElementById('refreshText');
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    refreshBtn.disabled = true;
    refreshIcon.classList.add('spinning');
    refreshText.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    fetch('/refresh-transactions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            refreshText.textContent = data.message;
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            refreshText.textContent = '–û—à–∏–±–∫–∞: ' + data.message;
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                refreshBtn.disabled = false;
                refreshIcon.classList.remove('spinning');
                refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        refreshText.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            refreshBtn.disabled = false;
            refreshIcon.classList.remove('spinning');
            refreshText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
        }, 2000);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É
function copyPaymentLink(link) {
    navigator.clipboard.writeText(link).then(() => {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.textContent = '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
        `;
        document.body.appendChild(notification);
        
        // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 2000);
    }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
    });
}
</script>

{% endblock %}
