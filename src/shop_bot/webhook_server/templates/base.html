<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{% block title %}Панель управления Ботом{% endblock %}</title>
		<link
			rel="stylesheet"
			href="{{ url_for('static', filename='css/style.css', v=project_version or '1') }}?t=20241221"
		/>
		<link
			rel="stylesheet"
			href="{{ url_for('static', filename='css/tw.css', v=project_version or '1') }}"
		/>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<!-- Flatpickr Date Picker -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
		<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
		<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
		<!-- Font Awesome Icons -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
		<!-- Favicon -->
		<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
	</head>
    <body class="{% block body_class %}{% endblock %}">
		<!-- Закрепленная панель в head -->
		<header class="header-panel">
			<div class="header-panel-left">
				<!-- Блок меню и логотипа, перенесённый из sidebar в header (слева) -->
				<div class="menu-items-header menu-items-header--in-header">
					<button class="sidebar-burger" id="sidebarBurger" title="Скрыть боковое меню">
						<span></span>
						<span></span>
						<span></span>
					</button>
					<div class="sidebar-logo">
						<img src="{{ url_for('static', filename='logo.svg') }}" alt="Логотип" class="logo-img">
					</div>
				</div>
				<button class="header-burger" id="headerBurger" title="Открыть меню">
					<span></span>
					<span></span>
					<span></span>
				</button>
				<div class="header-title">{% block header_title %}Панель управления{% endblock %}</div>
			</div>
			<div class="header-panel-right">
				{% block header_buttons %}{% endblock %}
			</div>
		</header>
		
        <div class="container {% block container_class %}{% endblock %}">
			<!-- Боковое меню -->
			<aside class="sidebar" id="sidebar">
				
				<nav class="sidebar-nav">
					<a
						href="{{ url_for('dashboard_page') }}"
						class="nav-link {% if request.endpoint == 'dashboard_page' %}active{% endif %}"
						title="Главная"
					>
						<span class="nav-icon">🏠</span>
						<span class="nav-text">Главная</span>
					</a>
					<a
						href="{{ url_for('users_page') }}"
						class="nav-link {% if request.endpoint == 'users_page' %}active{% endif %}"
						title="Пользователи"
					>
						<span class="nav-icon">👥</span>
						<span class="nav-text">Пользователи</span>
					</a>
					<a
						href="{{ url_for('transactions_page') }}"
						class="nav-link {% if request.endpoint == 'transactions_page' %}active{% endif %}"
						title="Платежи"
					>
						<span class="nav-icon">💳</span>
						<span class="nav-text">Платежи</span>
					</a>
					<a
						href="{{ url_for('keys_page') }}"
						class="nav-link {% if request.endpoint == 'keys_page' %}active{% endif %}"
						title="Ключи"
					>
						<span class="nav-icon">🔑</span>
						<span class="nav-text">Ключи</span>
					</a>
					<a
						href="{{ url_for('promo_codes_page') }}"
						class="nav-link {% if request.endpoint == 'promo_codes_page' %}active{% endif %}"
						title="Промокоды"
					>
						<span class="nav-icon">🎫</span>
						<span class="nav-text">Промокоды</span>
					</a>
					<a
						href="{{ url_for('notifications_page') }}"
						class="nav-link {% if request.endpoint == 'notifications_page' %}active{% endif %}"
						title="Уведомления"
					>
						<span class="nav-icon">🔔</span>
						<span class="nav-text">Уведомления</span>
					</a>
					<a
						href="{{ url_for('instructions_page') }}"
						class="nav-link {% if request.endpoint == 'instructions_page' %}active{% endif %}"
						title="Инструкции"
					>
						<span class="nav-icon">📙</span>
						<span class="nav-text">Инструкции</span>
					</a>
					<a
						href="{{ url_for('wiki_editor_page') }}"
						class="nav-link {% if request.endpoint in ['wiki_editor_page', 'wiki_editor_edit'] %}active{% endif %}"
						title="Wiki редактор"
					>
						<span class="nav-icon">📚</span>
						<span class="nav-text">Wiki редактор</span>
					</a>
					<a
						href="{{ url_for('settings_page') }}"
						class="nav-link {% if request.endpoint == 'settings_page' %}active{% endif %}"
						title="Настройки"
					>
						<span class="nav-icon">⚙️</span>
						<span class="nav-text">Настройки</span>
					</a>
				</nav>

				<!-- Свернутое меню с иконками -->
				<nav class="sidebar-nav sidebar-nav-collapsed" style="display: none;">
					<!-- Основная навигация -->
					<div class="sidebar-nav-main">
						<a
							href="{{ url_for('dashboard_page') }}"
							class="nav-link {% if request.endpoint == 'dashboard_page' %}active{% endif %}"
							title="Главная"
						>
							<span class="nav-icon">🏠</span>
						</a>
						<a
							href="{{ url_for('users_page') }}"
							class="nav-link {% if request.endpoint == 'users_page' %}active{% endif %}"
							title="Пользователи"
						>
							<span class="nav-icon">👥</span>
						</a>
						<a
							href="{{ url_for('transactions_page') }}"
							class="nav-link {% if request.endpoint == 'transactions_page' %}active{% endif %}"
							title="Платежи"
						>
							<span class="nav-icon">💳</span>
						</a>
						<a
							href="{{ url_for('keys_page') }}"
							class="nav-link {% if request.endpoint == 'keys_page' %}active{% endif %}"
							title="Ключи"
						>
							<span class="nav-icon">🔑</span>
						</a>
						<a
							href="{{ url_for('promo_codes_page') }}"
							class="nav-link {% if request.endpoint == 'promo_codes_page' %}active{% endif %}"
							title="Промокоды"
						>
							<span class="nav-icon">🎫</span>
						</a>
						<a
							href="{{ url_for('notifications_page') }}"
							class="nav-link {% if request.endpoint == 'notifications_page' %}active{% endif %}"
							title="Уведомления"
						>
							<span class="nav-icon">🔔</span>
						</a>
						<a
							href="{{ url_for('instructions_page') }}"
							class="nav-link {% if request.endpoint == 'instructions_page' %}active{% endif %}"
							title="Инструкции"
						>
							<span class="nav-icon">📙</span>
						</a>
						<a
							href="{{ url_for('wiki_editor_page') }}"
							class="nav-link {% if request.endpoint in ['wiki_editor_page', 'wiki_editor_edit'] %}active{% endif %}"
							title="Wiki редактор"
						>
							<span class="nav-icon">📚</span>
						</a>
						<a
							href="{{ url_for('settings_page') }}"
							class="nav-link {% if request.endpoint == 'settings_page' %}active{% endif %}"
							title="Настройки"
						>
							<span class="nav-icon">⚙️</span>
						</a>
					</div>
					
					<!-- Кнопки управления (внизу) -->
					<div class="sidebar-nav-controls">
						<!-- Скрытый режим -->
						<div class="nav-link nav-toggle" title="Скрытый режим">
							<label class="bot-toggle">
								<input type="checkbox" 
									   class="bot-checkbox"
									   id="hiddenModeToggleCollapsed"
									   {% if hidden_mode %}checked{% endif %}>
								<span class="toggle-slider"></span>
							</label>
						</div>
						<!-- Бот витрина -->
						<div class="nav-link nav-toggle" title="Бот витрина">
							<label class="bot-toggle">
								<input type="checkbox" 
									   class="bot-checkbox" 
									   data-bot="shop"
									   {% if bot_status.shop_bot_running %}checked{% endif %}>
								<span class="toggle-slider"></span>
							</label>
						</div>
						<!-- Бот поддержки -->
						<div class="nav-link nav-toggle" title="Бот поддержки">
							<label class="bot-toggle">
								<input type="checkbox" 
									   class="bot-checkbox" 
									   data-bot="support"
									   {% if bot_status.support_bot_running %}checked{% endif %}>
								<span class="toggle-slider"></span>
							</label>
						</div>
						<!-- Версия -->
						<a
							href="{{ url_for('dev_page') }}"
							class="nav-link"
							title="Версия: {{ project_version or 'N/A' }}"
						>
							<i class="fas fa-server"></i>
						</a>
						<!-- Выйти -->
						<form action="{{ url_for('logout_page') }}" method="post" class="nav-link-form">
							<button type="submit" class="nav-link nav-button" title="Выйти из панели">
								<i class="fas fa-sign-out-alt"></i>
							</button>
						</form>
					</div>
				</nav>

				<!-- Управление ботами -->
				<div class="bot-controls">
					<div class="bot-control">
						<div class="bot-status">
							<div class="bot-label-row">
								<span class="bot-label">Скрытый режим:</span>
								<label class="bot-toggle">
									<input type="checkbox" 
										   class="bot-checkbox"
										   id="hiddenModeToggle"
										   {% if hidden_mode %}checked{% endif %}>
									<span class="toggle-slider"></span>
								</label>
								<span id="hiddenModeStatus" class="bot-status-text {% if hidden_mode %}status-running{% else %}status-stopped{% endif %}">
									{% if hidden_mode %}ON{% else %}OFF{% endif %}
								</span>
							</div>
						</div>
					</div>
					<div class="bot-control">
						<div class="bot-status">
							<div class="bot-label-row">
								<span class="bot-label">Бот магазина</span>
                                <label class="bot-toggle">
                                    <input type="checkbox" 
                                           class="bot-checkbox" 
                                           data-bot="shop"
                                           {% if bot_status.shop_bot_running %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                </label>
								<span class="bot-status-text {% if bot_status.shop_bot_running %}status-running{% else %}status-stopped{% endif %}">
									{% if bot_status.shop_bot_running %}ON{% else %}OFF{% endif %}
								</span>
							</div>
						</div>
					</div>

					<div class="bot-control">
						<div class="bot-status">
							<div class="bot-label-row">
								<span class="bot-label">Бот поддержка:</span>
								<label class="bot-toggle">
									<input type="checkbox" 
										   class="bot-checkbox" 
										   data-bot="support"
										   {% if bot_status.support_bot_running %}checked{% endif %}>
									<span class="toggle-slider"></span>
								</label>
								<span class="bot-status-text {% if bot_status.support_bot_running %}status-running{% else %}status-stopped{% endif %}">
									{% if bot_status.support_bot_running %}ON{% else %}OFF{% endif %}
								</span>
							</div>
						</div>
					</div>

				<div class="version-block">
					<a href="{{ url_for('dev_page') }}" class="version-info" style="text-decoration: none;" title="Версия: {{ project_version or 'N/A' }}">
						<div class="version-text">Версия: {{ project_version or 'N/A' }}</div>
					</a>
				</div>

				<div class="user-session-controls">
					<form action="{{ url_for('logout_page') }}" method="post" class="logout-form">
						<button type="submit" class="button button-logout" data-size="sm" title="Выйти из панели">
							<i class="fas fa-sign-out-alt"></i>
							Выйти
						</button>
					</form>
				</div>
			</aside>

			<!-- Основной контент -->
			<main class="main-content">
				{% with messages = get_flashed_messages(with_categories=true) %} {% if
				messages %} {% for category, message in messages %}
				<div class="flash flash-{{ category }}">
					<span class="flash-message">{{ message }}</span>
					<button class="flash-close" aria-label="Закрыть уведомление" title="Закрыть уведомление">&times;</button>
				</div>
				{% endfor %} {% endif %} {% endwith %}

				{% block content %}{% endblock %}
			</main>
		</div>

		<!-- Модальное окно пользователя -->
		<!-- User Drawer (Side Sheet) -->
		<div id="userDrawer" class="drawer-overlay" style="display: none;">
			<div class="drawer" id="userDrawerPanel">
				<div class="drawer-header">
					<h3>Карточка пользователя</h3>
					<button class="drawer-close" onclick="closeUserModal()" title="Закрыть карточку пользователя">
						<i class="fas fa-times"></i>
					</button>
				</div>
				
				<div class="drawer-body">
					<!-- Закрепленная информация о пользователе -->
					<div class="user-info-section">
						<div class="user-info-grid">
							<div class="user-info-item">
								<label>Telegram ID:</label>
								<span id="modalUserId" class="user-info-value"></span>
							</div>
							<div class="user-info-item">
								<label>Полное имя:</label>
								<span id="modalFullname" class="user-info-value"></span>
							</div>
							<div class="user-info-item">
								<label>Статус:</label>
								<span id="modalStatus" class="user-info-value"></span>
							</div>
							<div class="user-info-item">
								<label>Баланс:</label>
								<span id="modalBalance" class="user-info-value"></span>
							</div>
							<div class="user-info-item">
								<label>Заработано:</label>
								<span id="modalEarned" class="user-info-value"></span>
							</div>
						</div>
					</div>

					<!-- Вкладки -->
					<div class="drawer-tabs">
						<button class="tab-button active" onclick="switchTab('userdata')" title="Данные пользователя">
							<i class="fas fa-user"></i>
							Данные пользователя
						</button>
						<button class="tab-button" onclick="switchTab('payments')" title="Платежи пользователя">
							<i class="fas fa-credit-card"></i>
							Платежи
						</button>
						<button class="tab-button" onclick="switchTab('keys')" title="Ключи пользователя">
							<i class="fas fa-key"></i>
							Ключи
						</button>
						<button class="tab-button" onclick="switchTab('notifications')" title="Уведомления пользователя">
							<i class="fas fa-bell"></i>
							Уведомления
						</button>
					</div>

					<!-- Контент вкладок -->
					<div class="drawer-tabs-content">
						<!-- Вкладка: Данные пользователя -->
						<div class="tab-content active" id="tab-userdata">
							
							<!-- Группа: Общее -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-info-circle"></i>
									<span>Общее</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" title="Дата регистрации в системе">
										<label>Дата регистрации:</label>
										<span id="detailRegistrationDate">—</span>
									</div>
									<div class="user-detail-item" title="Статус бана пользователя">
										<label>Забанен:</label>
										<span id="detailIsBanned">—</span>
									</div>
								</div>
							</div>

							<!-- Группа: Персональные -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-user"></i>
									<span>Персональные</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" title="Внутренний идентификатор пользователя">
										<label>User ID:</label>
										<span id="detailUserId">—</span>
									</div>
									<div class="user-detail-item" title="Идентификатор пользователя в Telegram">
										<label>Telegram ID:</label>
										<span id="detailTelegramId">—</span>
									</div>
									<div class="user-detail-item" title="Имя пользователя в Telegram">
										<label>Username:</label>
										<span id="detailUsername">—</span>
									</div>
									<div class="user-detail-item" title="Полное имя из профиля Telegram">
										<label>Полное имя:</label>
										<span id="detailFullname">—</span>
									</div>
									<div class="user-detail-item" title="ФИО пользователя (заполняется вручную)">
										<label>ФИО:</label>
										<input type="text" id="detailFioInput" class="form-input" placeholder="Введите ФИО" title="Введите ФИО пользователя">
										<span id="detailFio" style="display: none;">—</span>
									</div>
									<div class="user-detail-item" title="Email пользователя">
										<label>Email:</label>
										<input type="email" id="detailEmailInput" class="form-input" placeholder="Введите email" title="Введите email пользователя">
										<span id="detailEmail" style="display: none;">—</span>
									</div>
									<div class="user-detail-item" title="Группа пользователя">
										<label>Группа:</label>
										<select id="detailGroupInput" class="form-select" title="Выберите группу пользователя">
											<option value="">Выберите группу</option>
										</select>
										<span id="detailGroup" style="display: none;">—</span>
									</div>
								</div>
							</div>

							<!-- Группа: Финансы -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-wallet"></i>
									<span>Финансы</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" title="Текущий баланс пользователя">
										<label>Баланс:</label>
										<span id="detailBalance" data-field="balance">—</span>
									</div>
									<div class="user-detail-item" title="Общая сумма трат пользователя">
										<label>Всего потрачено:</label>
										<span id="detailTotalSpent" data-field="total_spent">—</span>
									</div>
									<div class="user-detail-item" title="Сумма заработанная пользователем">
										<label>Заработано:</label>
										<span id="detailEarned" data-field="earned">—</span>
									</div>
								</div>
							</div>

							<!-- Группа: Сводная -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-chart-line"></i>
									<span>Сводная</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" title="Общее количество оплаченных месяцев">
										<label>Всего месяцев:</label>
										<span id="detailTotalMonths">—</span>
									</div>
									<div class="user-detail-item" title="Количество ключей пользователя">
										<label>Количество ключей:</label>
										<span id="detailKeysCount">—</span>
									</div>
									<div class="user-detail-item" title="Количество уведомлений пользователя">
										<label>Количество уведомлений:</label>
										<span id="detailNotificationsCount">—</span>
									</div>
								</div>
							</div>

							<!-- Группа: Триал -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-gift"></i>
									<span>Триал</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" title="Использовался ли триальный период">
										<label>Триал использован:</label>
										<span id="detailTrialUsed">—</span>
									</div>
									<div class="user-detail-item" title="Количество дней триального периода">
										<label>Дней триала выдано:</label>
										<span id="detailTrialDaysGiven">—</span>
									</div>
									<div class="user-detail-item" title="Количество повторных триалов">
										<label>Повторных триалов:</label>
										<span id="detailTrialReusesCount">—</span>
									</div>
								</div>
							</div>

							<!-- Группа: Реферальная программа -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-users"></i>
									<span>Реферальная программа</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" title="ID пользователя, который пригласил">
										<label>Реферер (ID):</label>
										<span id="detailReferredBy">—</span>
									</div>
									<div class="user-detail-item" title="Текущий реферальный баланс">
										<label>Реферальный баланс:</label>
										<span id="detailReferralBalance" data-field="referral_balance">—</span>
									</div>
									<div class="user-detail-item" title="Общая сумма заработанная по реферальной программе">
										<label>Всего заработано рефералами:</label>
										<span id="detailReferralBalanceAll" data-field="referral_balance_all">—</span>
									</div>
								</div>
							</div>

							<!-- Группа: Правила -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-file-contract"></i>
									<span>Правила</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" title="Согласие с условиями использования">
										<label>Согласие с условиями:</label>
										<span id="detailAgreedToTerms">—</span>
									</div>
									<div class="user-detail-item" title="Согласие с документами сервиса">
										<label>Согласие с документами:</label>
										<span id="detailAgreedToDocuments">—</span>
									</div>
									<div class="user-detail-item" title="Статус подписки на обязательные каналы">
										<label>Статус подписки:</label>
										<span id="detailSubscriptionStatus">—</span>
									</div>
								</div>
							</div>

						</div>

						<!-- Вкладка: Платежи -->
						<div class="tab-content" id="tab-payments">
							<div class="drawer-table-container">
								<table class="drawer-table">
									<thead>
										<tr>
											<th>Дата</th>
											<th>Тип</th>
											<th>Сумма</th>
											<th>Описание</th>
										</tr>
									</thead>
									<tbody id="modalPaymentsTable">
										<tr>
											<td colspan="4" class="text-center">Загрузка...</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>

						<!-- Вкладка: Ключи -->
						<div class="tab-content" id="tab-keys">
							<div class="drawer-table-container">
								<table class="drawer-table">
									<thead>
										<tr>
											<th>ID ключа</th>
											<th>Хост</th>
											<th>План</th>
											<th>Ключ</th>
											<th>Дата</th>
										</tr>
									</thead>
									<tbody id="modalKeysTable">
										<tr>
											<td colspan="5" class="text-center">Загрузка...</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>

						<!-- Вкладка: Уведомления -->
						<div class="tab-content" id="tab-notifications">
							<div class="drawer-table-container">
								<table class="drawer-table">
									<thead>
										<tr>
											<th>Дата</th>
											<th>Тип</th>
											<th>Текст</th>
											<th>Статус</th>
										</tr>
									</thead>
									<tbody id="modalNotificationsTable">
										<tr>
											<td colspan="4" class="text-center">Загрузка...</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>

				<!-- Footer с кнопками действий -->
				<div class="drawer-footer">
					<!-- Левая часть: кебаб-меню и закрыть -->
					<div class="drawer-footer-left">
						<!-- Кебаб-меню -->
						<div class="kebab-wrapper">
							<button class="kebab-btn" onclick="toggleDrawerKebabMenu('drawer-kebab-menu')" title="Действия с пользователем">
								<i class="fas fa-ellipsis-v"></i>
							</button>
							<div class="kebab-menu" id="drawer-kebab-menu">
								<button type="button" class="kebab-item" onclick="closeDrawerKebabMenu(); banUser()" id="drawerBanButton" style="display: none;" title="Заблокировать пользователя">
									<i class="fas fa-lock"></i>
									<span>Забанить</span>
								</button>
								<button type="button" class="kebab-item" onclick="closeDrawerKebabMenu(); unbanUser()" id="drawerUnbanButton" style="display: none;" title="Разблокировать пользователя">
									<i class="fas fa-unlock"></i>
									<span>Разбанить</span>
								</button>
								<button type="button" class="kebab-item" onclick="closeDrawerKebabMenu(); revokeKeys()" title="Отозвать все ключи пользователя">
									<i class="fas fa-key"></i>
									<span>Отозвать ключи</span>
								</button>
								<button type="button" class="kebab-item" onclick="closeDrawerKebabMenu(); revokeConsent()" id="drawerRevokeConsentButton" style="display: none;" title="Отозвать согласие пользователя с документами">
									<i class="fas fa-user-times"></i>
									<span>Отозвать согласие</span>
								</button>
								<button type="button" class="kebab-item" onclick="closeDrawerKebabMenu(); openTopupBalanceModal()" title="Пополнить баланс пользователя">
									<i class="fas fa-plus-circle"></i>
									<span>Пополнить баланс</span>
								</button>
							</div>
						</div>
						
						<button type="button" class="button button-secondary" onclick="closeUserModal()" title="Закрыть карточку пользователя">
							Закрыть
						</button>
					</div>
					
					<!-- Правая часть: сохранить -->
					<div class="drawer-footer-right">
						<button type="button" class="button button-primary" id="saveUserButton" onclick="saveUserChanges()" style="display: inline-block;" title="Сохранить изменения пользователя">
							<i class="fas fa-save"></i>
							Сохранить
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Transaction Drawer (Side Sheet) -->
		<div id="transactionDrawer" class="drawer-overlay" style="display: none;">
			<div class="drawer" id="transactionDrawerPanel">
				<div class="drawer-header">
					<h3>Детали платежа</h3>
					<button class="drawer-close" onclick="closeTransactionModal()" title="Закрыть детали платежа">
						<i class="fas fa-times"></i>
					</button>
				</div>
				
				<div class="drawer-body">
					<!-- Закрепленная информация о транзакции -->
					<div class="user-info-section">
						<div class="user-info-grid">
							<div class="user-info-item">
								<label>ID транзакции:</label>
								<span id="txModalId" class="user-info-value"></span>
							</div>
							<div class="user-info-item">
								<label>Статус:</label>
								<span id="txModalStatus" class="user-info-value"></span>
							</div>
							<div class="user-info-item">
								<label>Сумма:</label>
								<span id="txModalAmount" class="user-info-value"></span>
							</div>
							<div class="user-info-item">
								<label>Способ оплаты:</label>
								<span id="txModalPaymentMethod" class="user-info-value"></span>
							</div>
						</div>
					</div>

					<!-- Контент -->
					<div class="drawer-tabs-content">
						<div class="tab-content active">
							
							<!-- Группа: Пользователь -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-user"></i>
									<span>Пользователь</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" title="ID пользователя">
										<label>User ID:</label>
										<span id="txDetailUserId">—</span>
									</div>
									<div class="user-detail-item" title="Username пользователя">
										<label>Username:</label>
										<span id="txDetailUsername">—</span>
									</div>
								</div>
							</div>

							<!-- Группа: Платеж -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-credit-card"></i>
									<span>Платеж</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" title="Уникальный ID транзакции">
										<label>ID транзакции:</label>
										<span id="txDetailId">—</span>
									</div>
									<div class="user-detail-item" title="Дата создания транзакции">
										<label>Дата создания:</label>
										<span id="txDetailDate">—</span>
									</div>
									<div class="user-detail-item" title="Тип операции">
										<label>Тип операции:</label>
										<span id="txDetailOperationType">—</span>
									</div>
									<div class="user-detail-item" title="Способ оплаты">
										<label>Способ оплаты:</label>
										<span id="txDetailPaymentMethod">—</span>
									</div>
									<div class="user-detail-item" title="Сумма в рублях">
										<label>Сумма (RUB):</label>
										<span id="txDetailAmountRub">—</span>
									</div>
									<div class="user-detail-item" title="Сумма в валюте платежа">
										<label>Сумма (валюта):</label>
										<span id="txDetailAmountCurrency">—</span>
									</div>
									<div class="user-detail-item" title="Название валюты">
										<label>Валюта:</label>
										<span id="txDetailCurrencyName">—</span>
									</div>
									<div class="user-detail-item" title="Статус транзакции">
										<label>Статус:</label>
										<span id="txDetailStatus">—</span>
									</div>
									<div class="user-detail-item" title="ID платежа в платежной системе">
										<label>ID платежа:</label>
										<span id="txDetailPaymentId">—</span>
									</div>
								</div>
							</div>

							<!-- Группа: Детали платежа -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-receipt"></i>
									<span>Детали платежа</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" title="Хеш транзакции">
										<label>Хеш транзакции:</label>
										<span id="txDetailHash">—</span>
									</div>
									<div class="user-detail-item" title="Ссылка на оплату">
										<label>Ссылка на оплату:</label>
										<span id="txDetailPaymentLink">—</span>
									</div>
								</div>
							</div>

							<!-- Группа: Детали заказа -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-shopping-cart"></i>
									<span>Детали заказа</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" title="Хост сервера">
										<label>Хост:</label>
										<span id="txDetailHost">—</span>
									</div>
									<div class="user-detail-item" title="Название плана">
										<label>План:</label>
										<span id="txDetailPlan">—</span>
									</div>
									<div class="user-detail-item" title="Ключ подключения" style="grid-column: 1 / -1;">
										<label>Ключ:</label>
										<span id="txDetailConnectionString" style="word-break: break-all; font-size: 12px;">—</span>
									</div>
								</div>
							</div>

							<!-- Группа: Метаданные -->
							<div class="user-data-group">
								<div class="user-data-group-header">
									<i class="fas fa-database"></i>
									<span>Метаданные</span>
								</div>
								<div class="user-details-grid">
									<div class="user-detail-item" style="grid-column: 1 / -1;" title="JSON метаданные транзакции">
										<label>Метаданные (JSON):</label>
										<pre id="txDetailMetadata" style="padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; max-height: 300px;">—</pre>
									</div>
								</div>
							</div>

						</div>
					</div>
				</div>
				
				<div class="drawer-footer">
					<!-- Левая часть: кебаб меню и закрыть -->
					<div class="drawer-footer-left">
						<button type="button" class="button button-secondary" onclick="closeTransactionModal()" title="Закрыть детали платежа">
							Закрыть
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Key Drawer -->
		{% include 'key_drawer.html' %}

		<script>
		// ==================== ФУНКЦИИ ДЛЯ РАБОТЫ С ГРУППАМИ ПОЛЬЗОВАТЕЛЕЙ ====================
		
		let currentUserGroups = [];
		let currentUserId = null;
		
		// Загрузка списка групп пользователей
		async function loadUserGroups() {
			try {
				const response = await fetch('/api/user-groups');
				const data = await response.json();
				
				if (data.success) {
					currentUserGroups = data.groups;
					
					// Заполняем select в карточке пользователя
					const groupSelect = document.getElementById('detailGroupInput');
					if (groupSelect) {
						groupSelect.innerHTML = '<option value="">Выберите группу</option>';
						data.groups.forEach(group => {
							const option = document.createElement('option');
							option.value = group.group_id;
							option.textContent = group.group_name;
							groupSelect.appendChild(option);
						});
					}
					
					return data.groups;
				} else {
					console.error('Ошибка загрузки групп:', data.error);
					return [];
				}
			} catch (error) {
				console.error('Ошибка загрузки групп:', error);
				return [];
			}
		}
		
		// Изменение группы пользователя из таблицы
		async function changeUserGroup(userId, currentGroupName, currentGroupId) {
			currentUserId = userId;
			
			const groups = await loadUserGroups();
			if (groups.length === 0) {
				alert('Ошибка загрузки списка групп');
				return;
			}
			
			const modal = document.createElement('div');
			modal.className = 'modal-backdrop';
			modal.innerHTML = `
				<div class="modal">
					<div class="modal-content">
						<div class="modal-header">
							<h3>Изменить группу пользователя</h3>
							<span class="close" onclick="closeModal()">&times;</span>
						</div>
						<div class="modal-body">
							<div class="form-group">
								<label for="user-group-select">Выберите группу:</label>
								<select id="user-group-select" title="Выберите группу для пользователя">
									${groups.map(group => `
										<option value="${group.group_id}" ${group.group_id === currentGroupId ? 'selected' : ''}>
											${group.group_name} ${group.is_default ? '(по умолчанию)' : ''}
										</option>
									`).join('')}
								</select>
							</div>
							<div class="form-group">
								<label>Текущая группа:</label>
								<span class="current-group">${currentGroupName || 'N/A'}</span>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="button button-secondary" onclick="closeModal()" title="Отменить">
								<i class="fas fa-times"></i>
								Отменить
							</button>
							<button type="button" class="button button-primary" onclick="saveUserGroupChange()" title="Сохранить изменения">
								<i class="fas fa-save"></i>
								Сохранить
							</button>
						</div>
					</div>
				</div>
			`;
			
			document.body.appendChild(modal);
		}
		
		// Изменение группы пользователя из модального окна
		async function changeUserGroupFromModal() {
			if (!currentUserId) {
				alert('Ошибка: ID пользователя не определен');
				return;
			}
			
			// Получаем текущую группу из модального окна
			const currentGroupElement = document.getElementById('detailGroup');
			const currentGroupName = currentGroupElement ? currentGroupElement.textContent : 'N/A';
			
			await changeUserGroup(currentUserId, currentGroupName, null);
		}
		
		// Сохранение изменения группы пользователя
		async function saveUserGroupChange() {
			const groupSelect = document.getElementById('user-group-select');
			const newGroupId = groupSelect ? parseInt(groupSelect.value) : null;
			
			if (!newGroupId || !currentUserId) {
				alert('Ошибка: не выбрана группа или не определен пользователь');
				return;
			}
			
			try {
				const response = await fetch(`/api/users/${currentUserId}/group`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ group_id: newGroupId })
				});
				
				const result = await response.json();
				
				if (result.success) {
					closeModal();
					
					// Обновляем отображение в таблице пользователей
					const groupBadge = document.querySelector(`[data-user-id="${currentUserId}"] .group-badge`);
					if (groupBadge) {
						const selectedGroup = currentUserGroups.find(g => g.group_id === newGroupId);
						if (selectedGroup) {
							groupBadge.textContent = selectedGroup.group_name;
						}
					}
					
					// Обновляем отображение в модальном окне пользователя
					const detailGroup = document.getElementById('detailGroup');
					if (detailGroup) {
						const selectedGroup = currentUserGroups.find(g => g.group_id === newGroupId);
						if (selectedGroup) {
							detailGroup.textContent = selectedGroup.group_name;
						}
					}
					
					showNotification(result.message, 'success');
				} else {
					alert('Ошибка: ' + result.error);
				}
			} catch (error) {
				console.error('Ошибка изменения группы пользователя:', error);
				alert('Ошибка изменения группы пользователя');
			}
		}
		
		// Обновление информации о группе в модальном окне пользователя
		function updateUserGroupInModal(userData) {
			const detailGroup = document.getElementById('detailGroup');
			if (detailGroup && userData.group_name) {
				detailGroup.textContent = userData.group_name;
			}
		}
		
		// Показ уведомления
		function showNotification(message, type = 'info') {
			// Создаем элемент уведомления
			const notification = document.createElement('div');
			notification.className = `notification notification-${type}`;
			notification.innerHTML = `
				<div class="notification-content">
					<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
					<span>${message}</span>
				</div>
			`;
			
			// Добавляем стили для уведомления
			notification.style.cssText = `
				position: fixed;
				top: 20px;
				right: 20px;
				background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
				color: white;
				padding: 15px 20px;
				border-radius: 8px;
				box-shadow: 0 4px 12px rgba(0,0,0,0.3);
				z-index: 10000;
				animation: slideInRight 0.3s ease-out;
			`;
			
			document.body.appendChild(notification);
			
			// Удаляем уведомление через 3 секунды
			setTimeout(() => {
				notification.style.animation = 'slideOutRight 0.3s ease-in';
				setTimeout(() => {
					if (notification.parentNode) {
						notification.parentNode.removeChild(notification);
					}
				}, 300);
			}, 3000);
		}
		
		// Добавляем CSS анимации для уведомлений
		const style = document.createElement('style');
		style.textContent = `
			@keyframes slideInRight {
				from { transform: translateX(100%); opacity: 0; }
				to { transform: translateX(0); opacity: 1; }
			}
			@keyframes slideOutRight {
				from { transform: translateX(0); opacity: 1; }
				to { transform: translateX(100%); opacity: 0; }
			}
			.notification-content {
				display: flex;
				align-items: center;
				gap: 10px;
			}
		`;
		document.head.appendChild(style);
		
		// ==================== ФУНКЦИИ ДЛЯ РАБОТЫ С МОДАЛЬНЫМ ОКНОМ SHARE ====================
		
		// Открытие модального окна Share
		function openShareModal() {
			document.getElementById('shareModal').style.display = 'flex';
			loadShareModalData();
		}
		
		// Закрытие модального окна Share
		function closeShareModal() {
			document.getElementById('shareModal').style.display = 'none';
			clearShareForm();
		}
		
		// Загрузка данных для модального окна Share
		async function loadShareModalData() {
			try {
				// Загрузка ботов
				const botsResponse = await fetch('/api/bots');
				const botsData = await botsResponse.json();
				const botSelect = document.getElementById('shareBot');
				botSelect.innerHTML = '<option value="">Выберите бота</option>';
				botsData.bots.forEach(bot => {
					const option = document.createElement('option');
					option.value = bot.bot;
					option.setAttribute('data-username', bot.username);
					option.textContent = bot.name;
					botSelect.appendChild(option);
				});
				
				// Загрузка групп
				const groupsResponse = await fetch('/api/user-groups');
				const groupsData = await groupsResponse.json();
				const groupSelect = document.getElementById('shareGroup');
				groupSelect.innerHTML = '<option value="">Без группы</option>';
				groupsData.groups.forEach(group => {
					const option = document.createElement('option');
					option.value = group.group_code;
					option.textContent = group.group_name;
					groupSelect.appendChild(option);
				});
			} catch (error) {
				console.error('Ошибка загрузки данных:', error);
				showNotification('Ошибка загрузки данных', 'error');
			}
		}
		
		// Обновление списка промокодов при выборе бота
		document.addEventListener('DOMContentLoaded', function() {
			const botSelect = document.getElementById('shareBot');
			if (botSelect) {
				botSelect.addEventListener('change', async function() {
					const selectedBot = this.value;
					const promoSelect = document.getElementById('sharePromo');
					
					if (!selectedBot) {
						promoSelect.innerHTML = '<option value="">Без промокода</option>';
						return;
					}
					
					try {
						const response = await fetch(`/api/promo-codes/by-bot?bot=${selectedBot}`);
						const data = await response.json();
						promoSelect.innerHTML = '<option value="">Без промокода</option>';
						data.promo_codes.forEach(promo => {
							const option = document.createElement('option');
							option.value = promo.code;
							option.textContent = promo.code;
							promoSelect.appendChild(option);
						});
					} catch (error) {
						console.error('Ошибка загрузки промокодов:', error);
					}
				});
			}
		});
		
		// Генерация deeplink
		function updateShareLink() {
			const botSelect = document.getElementById('shareBot');
			const selectedBot = botSelect.options[botSelect.selectedIndex];
			const botUsername = selectedBot ? selectedBot.getAttribute('data-username') : '';
			const groupCode = document.getElementById('shareGroup').value;
			const promoCode = document.getElementById('sharePromo').value;
			
			if (!botUsername) {
				document.getElementById('shareLink').value = '';
				return;
			}
			
			// Если нет параметров, показываем базовую ссылку
			if (!groupCode && !promoCode) {
				document.getElementById('shareLink').value = `https://t.me/${botUsername}`;
				return;
			}
			
			// Генерируем ссылку через API с base64 кодированием
			fetch('/api/generate-deeplink', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					bot_username: botUsername,
					group_code: groupCode || null,
					promo_code: promoCode || null,
					referrer_id: null
				})
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					document.getElementById('shareLink').value = data.link;
				} else {
					console.error('Ошибка генерации ссылки:', data.error);
					// Fallback на старый формат для отладки
					document.getElementById('shareLink').value = `https://t.me/${botUsername}?start=error_${data.error}`;
				}
			})
			.catch(error => {
				console.error('Ошибка запроса:', error);
				// Fallback на базовую ссылку
				document.getElementById('shareLink').value = `https://t.me/${botUsername}`;
			});
		}
		
		// Копирование ссылки
		function copyShareLink() {
			const linkInput = document.getElementById('shareLink');
			if (linkInput.value) {
				linkInput.select();
				document.execCommand('copy');
				showNotification('Ссылка скопирована', 'success');
			} else {
				showNotification('Ссылка не сгенерирована', 'error');
			}
		}
		
		// Очистка формы Share
		function clearShareForm() {
			document.getElementById('shareBot').value = '';
			document.getElementById('shareGroup').value = '';
			document.getElementById('sharePromo').value = '';
			document.getElementById('shareLink').value = '';
		}
		</script>

		<script src="{{ url_for('static', filename='js/script.js') }}"></script>
		{% block scripts %}{% endblock %}
	</body>
</html>
