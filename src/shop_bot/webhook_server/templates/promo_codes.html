{% extends "base.html" %}

{% block title %}–ü—Ä–æ–º–æ–∫–æ–¥—ã - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}

{% block header_title %}–ü—Ä–æ–º–æ–∫–æ–¥—ã{% endblock %}

{% block header_buttons %}
	<!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ü—Ä–æ–º–æ–∫–æ–¥—ã" -->
	<div id="promocodesActions" class="tab-actions">
		<button type="button" class="button button-secondary" onclick="clearPromoFilters()" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã">
			<i class="fas fa-times"></i>
			–û—á–∏—Å—Ç–∏—Ç—å
		</button>
		<button type="button" class="button button-secondary" onclick="toggleViewMode()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è">
			<i class="fas fa-list" id="viewIcon"></i>
			<span id="viewText">–ö–∞—Ä—Ç–æ—á–∫–∏</span>
		</button>
		<button type="button" class="button button-secondary" onclick="refreshPromoCodes()" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤">
			<i class="fas fa-sync-alt"></i>
			–û–±–Ω–æ–≤–∏—Ç—å
		</button>
		<button type="button" class="button button-secondary" onclick="openPromoDrawer()" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥">
			<i class="fas fa-plus"></i>
			–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
		</button>
	</div>
	<!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ò—Å—Ç–æ—Ä–∏—è" -->
	<div id="historyActions" class="tab-actions" style="display: none;">
		<button type="button" class="button button-secondary" onclick="clearHistoryFilters()" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã">
			<i class="fas fa-times"></i>
			–û—á–∏—Å—Ç–∏—Ç—å
		</button>
		<button type="button" class="button button-secondary" onclick="refreshUsageHistory()" title="–û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è">
			<i class="fas fa-sync-alt"></i>
			–û–±–Ω–æ–≤–∏—Ç—å
		</button>
	</div>
{% endblock %}

{% block content %}

<!-- –í–∫–ª–∞–¥–∫–∏ -->
<div class="main-tabs">
	<button class="tab-button active" onclick="switchMainTab('promocodes')" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏">
		<i class="fas fa-ticket-alt"></i>
		–ü—Ä–æ–º–æ–∫–æ–¥—ã
		<span class="tab-count" id="promoCount">0</span>
	</button>
	<button class="tab-button" onclick="switchMainTab('history')" title="–ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤">
		<i class="fas fa-history"></i>
		–ò—Å—Ç–æ—Ä–∏—è
		<span class="tab-count" id="historyCount">0</span>
	</button>
</div>

<!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
<div class="main-tabs-content">
	<!-- –í–∫–ª–∞–¥–∫–∞ "–ü—Ä–æ–º–æ–∫–æ–¥—ã" -->
	<div class="tab-content active" id="tab-promocodes">

		<!-- –†–∞–∑–¥–µ–ª –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
		<div class="user-promo-section" id="userPromoSection" style="display: none;">
	<div class="user-promo-header">
		<div class="user-promo-title">
			<i class="fas fa-user-check"></i>
			<span>–ú–æ–∏ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã</span>
			<span class="user-promo-count" id="userPromoCount">0</span>
		</div>
		<div class="user-promo-actions">
			<button type="button" class="button button-secondary" onclick="refreshUserPromoCodes()" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤">
				<i class="fas fa-sync-alt"></i>
				–û–±–Ω–æ–≤–∏—Ç—å
			</button>
		</div>
	</div>
	
	<div class="user-promo-cards" id="userPromoCards">
		<div class="user-promo-card loading-card">
			<div class="promo-card-skeleton">
				<div class="skeleton-line skeleton-title"></div>
				<div class="skeleton-line skeleton-subtitle"></div>
				<div class="skeleton-line skeleton-text"></div>
				<div class="skeleton-line skeleton-text"></div>
			</div>
		</div>
	</div>
	
	<!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
	<div class="empty-state" id="userEmptyState" style="display: none;">
		<div class="empty-state-icon">
			<i class="fas fa-ticket-alt"></i>
		</div>
		<div class="empty-state-title">–ù–µ—Ç –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</div>
		<div class="empty-state-description">–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –≤ –±–æ—Ç–µ, —á—Ç–æ–±—ã –æ–Ω –æ—Ç–æ–±—Ä–∞–∑–∏–ª—Å—è –∑–¥–µ—Å—å</div>
	</div>
</div>

<!-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–º–µ—Å—Ç–æ —Ç–∞–±–ª–∏—Ü—ã -->
<div class="promo-cards-container" id="promoCardsContainer">
	
	<!-- –ö–∞—Ä—Ç–æ—á–Ω—ã–π –≤–∏–¥ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
	<div class="promo-cards-grid" id="promoCardsGrid" style="display: none;">
		<div class="promo-card loading-card">
			<div class="promo-card-skeleton">
				<div class="skeleton-line skeleton-title"></div>
				<div class="skeleton-line skeleton-subtitle"></div>
				<div class="skeleton-line skeleton-text"></div>
				<div class="skeleton-line skeleton-text"></div>
			</div>
		</div>
	</div>
	
	<!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
	<div class="promo-section" id="promoSection">
		<div class="promo-filters" id="promoFilters">
			<div class="filter-row">
				<div class="form-group">
					<label for="filterPromoCode">–ü—Ä–æ–º–æ–∫–æ–¥</label>
					<input type="text" id="filterPromoCode" class="form-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É" title="–ü–æ–∏—Å–∫ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É">
				</div>
				<div class="form-group">
					<label for="filterPromoBot">–ë–æ—Ç</label>
					<select id="filterPromoBot" class="form-select" title="–§–∏–ª—å—Ç—Ä –ø–æ –±–æ—Ç—É">
						<option value="">–í—Å–µ</option>
						<option value="shop">Shop</option>
						<option value="support">Support</option>
					</select>
				</div>
				<div class="form-group">
					<label for="filterPromoStatus">–°—Ç–∞—Ç—É—Å</label>
					<select id="filterPromoStatus" class="form-select" title="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É">
						<option value="">–í—Å–µ</option>
						<option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
						<option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
					</select>
				</div>
				<div class="form-group">
					<label for="filterPromoDateFrom">–î–∞—Ç–∞ –æ—Ç</label>
					<div class="date-input-wrapper">
						<input type="text" id="filterPromoDateFrom" class="form-input" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É" title="–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞" readonly>
						<i class="fas fa-calendar-alt date-icon"></i>
					</div>
				</div>
				<div class="form-group">
					<label for="filterPromoDateTo">–î–∞—Ç–∞ –¥–æ</label>
					<div class="date-input-wrapper">
						<input type="text" id="filterPromoDateTo" class="form-input" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É" title="–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è" readonly>
						<i class="fas fa-calendar-alt date-icon"></i>
					</div>
				</div>
				<div class="form-group">
					<label for="filterPromoGroups">–ì—Ä—É–ø–ø—ã</label>
					<select id="filterPromoGroups" class="form-select" title="–§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä—É–ø–ø–∞–º">
						<option value="">–í—Å–µ</option>
						<option value="with_groups">–° –≥—Ä—É–ø–ø–∞–º–∏</option>
						<option value="without_groups">–ë–µ–∑ –≥—Ä—É–ø–ø</option>
					</select>
				</div>
				<div class="form-group filter-actions">
					<label>&nbsp;</label>
					<div class="filter-buttons">
						<button type="button" class="button button-icon" onclick="filterPromoCodes()" title="–ü–æ–∏—Å–∫ –≤ –≥—Ä–∏–¥–µ">
							<svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true" data-testid="SearchIcon">
								<path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
							</svg>
						</button>
						<button type="button" class="button button-icon" onclick="clearPromoFilters()" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
							<svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true" data-testid="ClearIcon">
								<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
							</svg>
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- –¢–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
		<div class="table-container" id="tableContainer" style="width: 100%;">
			<table id="promoCodesTable">
				<thead>
					<tr>
						<th>ID</th>
						<th>–°–æ–∑–¥–∞–Ω</th>
						<th>–ü—Ä–æ–º–æ–∫–æ–¥</th>
						<th>–ë–æ—Ç</th>
						<th>–¢–∞—Ä–∏—Ñ VPN</th>
						<th>–°–∫–∏–¥–∫–∞ (‚ÇΩ)</th>
						<th>–°–∫–∏–¥–∫–∞ (%)</th>
						<th>–°–∫–∏–¥–∫–∞ (–ë)</th>
						<th>–ö–≤–æ—Ç–∞</th>
						<th>–°—Ä–æ–∫ —Å–≥–æ—Ä–∞–Ω–∏—è</th>
						<th>–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ</th>
						<th>–ì—Ä—É–ø–ø—ã</th>
						<th>–°—Å—ã–ª–∫–∞</th>
						<th>–°—Ç–∞—Ç—É—Å</th>
						<th>–î–µ–π—Å—Ç–≤–∏—è</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td colspan="15" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	
	<!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
	<div class="empty-state" id="emptyState" style="display: none;">
		<div class="empty-state-icon">
			<i class="fas fa-ticket-alt"></i>
		</div>
		<div class="empty-state-title">–ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
		<div class="empty-state-description">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</div>
		<button type="button" class="button button-primary" onclick="openPromoDrawer()" title="–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥">
			<i class="fas fa-plus"></i>
			–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
		</button>
	</div>
</div>
	</div>

	<!-- –í–∫–ª–∞–¥–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è" -->
	<div class="tab-content" id="tab-history">
		<div class="history-section">

			<!-- –§–∏–ª—å—Ç—Ä—ã -->
			<div class="history-filters">
				<div class="filter-row">
					<div class="form-group">
						<label for="filterDateFrom">–î–∞—Ç–∞ –æ—Ç</label>
						<div class="date-input-wrapper">
							<input type="text" id="filterDateFrom" class="form-input" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É" title="–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞" readonly>
							<i class="fas fa-calendar-alt date-icon"></i>
						</div>
					</div>
					<div class="form-group">
						<label for="filterDateTo">–î–∞—Ç–∞ –¥–æ</label>
						<div class="date-input-wrapper">
							<input type="text" id="filterDateTo" class="form-input" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É" title="–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è" readonly>
							<i class="fas fa-calendar-alt date-icon"></i>
						</div>
					</div>
					<div class="form-group">
						<label for="filterUser">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
						<input type="text" id="filterUser" class="form-input" placeholder="ID –∏–ª–∏ username" title="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é">
					</div>
					<div class="form-group">
						<label for="filterStatus">–°—Ç–∞—Ç—É—Å</label>
						<select id="filterStatus" class="form-select" title="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É">
							<option value="">–í—Å–µ</option>
							<option value="applied">–ü—Ä–∏–º–µ–Ω—ë–Ω</option>
							<option value="used">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</option>
						</select>
					</div>
					<div class="form-group">
						<label for="filterBot">–ë–æ—Ç</label>
						<select id="filterBot" class="form-select" title="–§–∏–ª—å—Ç—Ä –ø–æ –±–æ—Ç—É">
							<option value="">–í—Å–µ</option>
							<option value="shop">Shop</option>
							<option value="support">Support</option>
						</select>
					</div>
					<div class="form-group">
						<label for="filterPromoCode">–ü—Ä–æ–º–æ–∫–æ–¥</label>
						<input type="text" id="filterPromoCode" class="form-input" placeholder="–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞" title="–ü–æ–∏—Å–∫ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É">
					</div>
				</div>
			</div>

			<!-- –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
			<div class="table-container" style="width: 100%; margin-top: 20px;">
				<table id="usageHistoryTable">
						<thead>
							<tr>
								<th>ID</th>
								<th>–ü—Ä–æ–º–æ–∫–æ–¥</th>
								<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
								<th>Username</th>
								<th>–ë–æ—Ç</th>
								<th>–°–∫–∏–¥–∫–∞</th>
								<th>–ü–ª–∞–Ω</th>
								<th>–î–∞—Ç–∞</th>
								<th>–°—Ç–∞—Ç—É—Å</th>
								<th>–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td colspan="10" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
							</tr>
						</tbody>
					</table>
			</div>

			<!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ -->
			<div class="empty-state" id="historyEmptyState" style="display: none;">
				<div class="empty-state-icon">
					<i class="fas fa-history"></i>
				</div>
				<div class="empty-state-title">–ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>
				<div class="empty-state-description">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã</div>
			</div>
		</div>
	</div>
</div>

<!-- Drawer –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
<div id="promoDrawer" class="drawer-overlay" style="display: none;">
	<div class="drawer" id="promoDrawerPanel">
		<div class="drawer-header">
			<h3 id="promoDrawerTitle">–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞</h3>
			<button class="drawer-close" onclick="closePromoDrawer()" title="–ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å">
				<i class="fas fa-times"></i>
			</button>
		</div>

		<!-- –í–∫–ª–∞–¥–∫–∏ -->
		<div class="drawer-tabs">
			<button class="tab-button active" onclick="switchPromoTab('info')" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–º–æ–∫–æ–¥–µ">
				<i class="fas fa-info-circle"></i>
				–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
			</button>
			<button class="tab-button" onclick="switchPromoTab('usage')" title="–ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞">
				<i class="fas fa-history"></i>
				–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
			</button>
			<button class="tab-button" onclick="switchPromoTab('summary')" title="–†–µ–∑—é–º–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞">
				<i class="fas fa-clipboard-list"></i>
				–†–µ–∑—é–º–µ
			</button>
		</div>

		<div class="drawer-body">
			<!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
			<div class="drawer-tabs-content">
				<div class="tab-content active" id="tab-info">
					<!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
					<div class="promo-info-section">
						<div class="promo-info-grid">
							<!-- –ê—Ç—Ä–∏–±—É—Ç –ê–∫—Ç–∏–≤–Ω—ã–π –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ -->
							<div class="form-group">
								<label class="form-checkbox-label">
									<input type="checkbox" id="promoIsActive" class="form-checkbox" checked title="–ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥">
									<span class="checkbox-text">–ê–∫—Ç–∏–≤–Ω—ã–π</span>
								</label>
							</div>

							<!-- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É -->
							<div class="form-row form-row--3">
								<div class="form-group">
									<label for="promoCode">–ü—Ä–æ–º–æ–∫–æ–¥ *</label>
									<input type="text" id="promoCode" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" title="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞">
								</div>
								<div class="form-group">
									<label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–º–æ–∫–æ–¥</label>
									<div class="promo-link-container">
										<input type="text" id="promoLink" class="form-input" readonly title="–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–º–æ–∫–æ–¥ –≤ –±–æ—Ç–µ">
										<button type="button" class="button button-secondary" onclick="copyPromoLink()" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
											<i class="fas fa-copy"></i>
										</button>
									</div>
								</div>
								<div class="form-group">
									<label for="promoBot">–ë–æ—Ç *</label>
									<select id="promoBot" class="form-select" title="–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞">
										<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞</option>
										<option value="shop" data-username="{{ global_settings.telegram_bot_username or '' }}">Shop Bot</option>
									</select>
								</div>
							</div>

							<div class="form-row form-row--2">
								<div class="form-group">
									<label for="promoVpnPlan">–¢–∞—Ä–∏—Ñ—ã VPN</label>
									<select id="promoVpnPlan" class="form-select" multiple size="4" title="–í—ã–±–µ—Ä–∏—Ç–µ VPN —Ç–∞—Ä–∏—Ñ—ã (—É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞)">
										<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ—ã</option>
									</select>
									<small class="form-hint">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞—Ä–∏—Ñ–æ–≤</small>
								</div>
								<div class="form-group">
									<label for="promoTariff">–¢–∞—Ä–∏—Ñ—ã</label>
									<select id="promoTariff" class="form-select" multiple size="4" title="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ—ã (—É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞)">
										<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ—ã</option>
									</select>
									<small class="form-hint">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞—Ä–∏—Ñ–æ–≤</small>
								</div>
							</div>

							<div class="form-row form-row--3">
								<div class="form-group">
									<label for="promoDiscountAmount">–°–∫–∏–¥–∫–∞ (‚ÇΩ)</label>
									<input type="number" id="promoDiscountAmount" class="form-input" step="0.01" min="0" placeholder="0.00" title="–°—É–º–º–∞ —Å–∫–∏–¥–∫–∏ –≤ —Ä—É–±–ª—è—Ö">
								</div>
								<div class="form-group">
									<label for="promoDiscountPercent">–°–∫–∏–¥–∫–∞ (%)</label>
									<input type="number" id="promoDiscountPercent" class="form-input" step="0.01" min="0" max="100" placeholder="0.00" title="–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏">
								</div>
								<div class="form-group">
									<label for="promoDiscountBonus">–°–∫–∏–¥–∫–∞ (–±–æ–Ω—É—Å)</label>
									<input type="number" id="promoDiscountBonus" class="form-input" step="0.01" min="0" placeholder="0.00" title="–°—É–º–º–∞ –±–æ–Ω—É—Å–Ω–æ–π —Å–∫–∏–¥–∫–∏">
								</div>
							</div>
						</div>
					</div>

					<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
					<div class="promo-advanced-section">
						<h4>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
						<div class="promo-advanced-content">
							<div class="form-row form-row--3">
								<div class="form-group">
									<label for="promoUsageLimit">–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –Ω–∞ –±–æ—Ç–∞</label>
									<input type="number" id="promoUsageLimit" class="form-input" min="1" value="1" title="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –Ω–∞ –æ–¥–Ω–æ–≥–æ –±–æ—Ç–∞">
								</div>
								<div class="form-group">
									<label for="promoBurnAfterAt">–°—Ä–æ–∫ —Å–≥–æ—Ä–∞–Ω–∏—è</label>
									<input type="datetime-local" id="promoBurnAfterAt" class="form-input" title="–ú–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏, –∫–æ–≥–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥ —Å—Ç–∞–Ω–µ—Ç –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω">
								</div>
								<div class="form-group">
									<label for="promoValidUntil">–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ</label>
									<input type="datetime-local" id="promoValidUntil" class="form-input" title="–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞">
								</div>
							</div>

							<div class="form-group form-group--full">
								<label for="promoTargetGroups">–ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</label>
							<select id="promoTargetGroups" class="form-select" multiple size="4" title="–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞)">
								{% if user_groups and user_groups|length > 0 %}
									{% for g in user_groups %}
										<option value="{{ g.group_id }}">{{ g.group_name }} ({{ g.user_count or 0 }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)</option>
									{% endfor %}
								{% else %}
									<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</option>
								{% endif %}
							</select>
								<small class="form-hint">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≥—Ä—É–ø–ø. –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã, –ø—Ä–æ–º–æ–∫–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º</small>
							</div>
						</div>
					</div>

					<!-- –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
					<div class="promo-details">
						<h4>–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞</h4>
						<div class="info-grid">
							<div class="info-item">
								<label>ID:</label>
								<span id="promoDetailsId">-</span>
							</div>
							<div class="info-item">
								<label>–°–æ–∑–¥–∞–Ω:</label>
								<span id="promoDetailsCreated">-</span>
							</div>
							<div class="info-item">
								<label>–û–±–Ω–æ–≤–ª–µ–Ω:</label>
								<span id="promoDetailsUpdated">-</span>
							</div>
						</div>
					</div>
				</div>

				<div class="tab-content" id="tab-usage">
					<div class="modal-table-container">
					<table class="modal-table">
						<thead>
							<tr>
								<th class="actions-cell">–ú–µ–Ω—é</th>
								<th>ID</th>
								<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
								<th>Username</th>
								<th>–ë–æ—Ç</th>
								<th>–°–∫–∏–¥–∫–∞ ‚ÇΩ|%|–ë</th>
								<th>–ü–ª–∞–Ω</th>
								<th>–î–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</th>
								<th>–°—Ç–∞—Ç—É—Å</th>
								<th>–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</th>
							</tr>
						</thead>
						<tbody id="promoUsageTable">
							<tr>
								<td colspan="10" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
							</tr>
						</tbody>
					</table>
				</div>
				</div>
				<div class="tab-content" id="tab-summary">
					<div class="form-group form-group--full">
						<label for="promoSummaryText">–†–µ–∑—é–º–µ</label>
						<textarea id="promoSummaryText" class="form-input" rows="10" readonly title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞"></textarea>
						<div class="promo-actions" style="margin-top: 10px;">
							<button type="button" class="button button-secondary" onclick="copyPromoSummary()" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—é–º–µ">
								<i class="fas fa-copy"></i>
								–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="drawer-footer">
			<div class="drawer-footer-left">
				<button type="button" class="button button-secondary" onclick="closePromoDrawer()" title="–ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å">
					–ó–∞–∫—Ä—ã—Ç—å
				</button>
			</div>
			<div class="drawer-footer-right">
				<button type="button" class="button button-danger" id="deletePromoButton" onclick="deletePromoCode()" style="display: none;" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥">
					<i class="fas fa-trash"></i>
					–£–¥–∞–ª–∏—Ç—å
				</button>
				<button type="button" class="button button-primary" onclick="savePromoCode()" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥">
					<i class="fas fa-save"></i>
					–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
				</button>
			</div>
		</div>
	</div>
</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –≥–ª–∞–≤–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫ */
.main-tabs {
	display: flex;
	gap: 8px;
	margin-bottom: 0px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤–∫–ª–∞–¥–æ–∫ */
.tab-count {
	background: var(--primary-color);
	color: white;
	border-radius: 50%;
	padding: 2px 6px;
	font-size: 11px;
	font-weight: 600;
	margin-left: 6px;
	min-width: 18px;
	text-align: center;
	display: inline-block;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è tab-actions */
.tab-actions {
	display: flex;
	gap: 10px;
	align-items: center;
}

.main-tabs .tab-button {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 12px 20px;
	background: transparent;
	border: 1px solid transparent;
	border-radius: 8px 8px 0 0;
	color: var(--text-muted);
	font-size: 14px;
	font-weight: 500;
	cursor: pointer;
	transition: all 0.2s ease;
}

.main-tabs .tab-button:hover {
	background: var(--bg-elevated);
	color: var(--light-color);
}

.main-tabs .tab-button.active {
	background: var(--bg-surface);
	border-color: var(--border-color);
	border-bottom-color: var(--bg-surface);
	color: var(--light-color);
}

.main-tabs-content {
	margin-top: 0px;
}

.main-tabs-content .tab-content {
	display: none;
}

.main-tabs-content .tab-content.active {
	display: block;
	padding-top: 5px;
	padding-bottom: 5px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ */
.promo-section {
	background: var(--bg-surface);
	border-radius: 12px;
	border: 1px solid var(--border-color);
	overflow: hidden;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ */
.promo-filters {
	padding: 20px;
	border-bottom: 1px solid var(--border-color);
	background: var(--bg-surface);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
.promo-filters input[type="date"],
.promo-filters input[type="text"],
.promo-filters select {
	background: var(--bg-elevated) !important;
	border: 1px solid var(--border-color) !important;
	color: var(--light-color) !important;
	padding: 8px 12px !important;
	border-radius: 6px !important;
	font-size: 14px !important;
	transition: all 0.2s ease !important;
	height: 36px !important;
}

.promo-filters input[type="date"]:focus,
.promo-filters input[type="text"]:focus,
.promo-filters select:focus {
	outline: none !important;
	border-color: var(--primary-color) !important;
	box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.2) !important;
}

.promo-filters input[type="date"]:hover,
.promo-filters input[type="text"]:hover,
.promo-filters select:hover {
	border-color: var(--text-muted) !important;
}

.promo-filters input[type="date"]::-webkit-calendar-picker-indicator {
	background: transparent !important;
	color: var(--text-muted) !important;
	cursor: pointer !important;
	filter: invert(1) !important;
}

.promo-filters input[type="date"]::-webkit-calendar-picker-indicator:hover {
	color: var(--light-color) !important;
}

.promo-filters input[type="date"]::-moz-calendar-picker-indicator {
	background: transparent !important;
	color: var(--text-muted) !important;
	cursor: pointer !important;
	filter: invert(1) !important;
}

.promo-filters input[type="date"]::-moz-calendar-picker-indicator:hover {
	color: var(--light-color) !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.filter-actions {
	display: flex;
	flex-direction: column;
	justify-content: flex-end;
}

.filter-buttons {
	display: flex;
	gap: 8px;
	align-items: center;
	height: 36px;
}

.button-icon {
	background: var(--bg-elevated) !important;
	border: 1px solid var(--border-color) !important;
	color: var(--light-color) !important;
	padding: 8px !important;
	border-radius: 6px !important;
	width: 36px !important;
	height: 36px !important;
	display: flex !important;
	align-items: center !important;
	justify-content: center !important;
	cursor: pointer !important;
	transition: all 0.2s ease !important;
}

.button-icon:hover {
	background: var(--bg-hover) !important;
	border-color: var(--primary-color) !important;
	color: var(--primary-color) !important;
	transform: translateY(-1px) !important;
	box-shadow: 0 2px 8px rgba(49, 130, 206, 0.2) !important;
}

.button-icon:active {
	transform: translateY(0) !important;
	box-shadow: 0 1px 4px rgba(49, 130, 206, 0.3) !important;
}

.button-icon svg {
	width: 20px !important;
	height: 20px !important;
	fill: currentColor !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è */
.history-section {
	background: var(--bg-surface);
	border-radius: 12px;
	border: 1px solid var(--border-color);
	overflow: hidden;
}

.history-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 10px;
	border-bottom: 1px solid var(--border-color);
	background: var(--bg-elevated);
}

.history-title {
	display: flex;
	align-items: center;
	gap: 12px;
	font-size: 18px;
	font-weight: 600;
	color: var(--light-color);
}

.history-count {
	background: var(--primary-color);
	color: white;
	padding: 4px 8px;
	border-radius: 12px;
	font-size: 12px;
	font-weight: 500;
}

.history-actions {
	display: flex;
	gap: 8px;
}

.history-filters {
	padding: 20px;
	border-bottom: 1px solid var(--border-color);
	background: var(--bg-surface);
}

.filter-row {
	display: grid;
	grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr auto;
	gap: 15px;
	align-items: end;
	width: 100%;
}

.filter-row .form-group {
	margin-bottom: 0;
	display: flex;
	flex-direction: column;
	height: 100%;
}

.filter-row .form-group label {
	font-size: 12px;
	font-weight: 500;
	color: var(--text-muted);
	margin-bottom: 4px;
	flex-shrink: 0;
}

.filter-row .form-group input,
.filter-row .form-group select {
	height: 36px;
	flex: 1;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
.history-filters input[type="date"],
.history-filters input[type="text"],
.history-filters select {
	background: var(--bg-elevated) !important;
	border: 1px solid var(--border-color) !important;
	color: var(--light-color) !important;
	padding: 8px 12px !important;
	border-radius: 6px !important;
	font-size: 14px !important;
	transition: all 0.2s ease !important;
}

.history-filters input[type="date"]:focus,
.history-filters input[type="text"]:focus,
.history-filters select:focus {
	outline: none !important;
	border-color: var(--primary-color) !important;
	box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.2) !important;
}

.history-filters input[type="date"]:hover,
.history-filters input[type="text"]:hover,
.history-filters select:hover {
	border-color: var(--text-muted) !important;
}

.history-filters input[type="date"]::-webkit-calendar-picker-indicator {
	background: transparent !important;
	color: var(--text-muted) !important;
	cursor: pointer !important;
	filter: invert(1) !important;
}

.history-filters input[type="date"]::-webkit-calendar-picker-indicator:hover {
	color: var(--light-color) !important;
}

.history-filters input[type="date"]::-moz-calendar-picker-indicator {
	background: transparent !important;
	color: var(--text-muted) !important;
	cursor: pointer !important;
	filter: invert(1) !important;
}

.history-filters input[type="date"]::-moz-calendar-picker-indicator:hover {
	color: var(--light-color) !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û—á–∏—Å—Ç–∏—Ç—å" –≤ header */
.history-actions .button-outline {
	background: var(--primary-color) !important;
	border: 1px solid var(--primary-color) !important;
	color: white !important;
	padding: 8px 16px !important;
	border-radius: 6px !important;
	font-size: 14px !important;
	transition: all 0.2s ease !important;
	height: 36px !important;
	display: flex !important;
	align-items: center !important;
	gap: 6px !important;
	margin-right: 10px !important;
}

.history-actions .button-outline:hover {
	background: var(--primary-hover) !important;
	border-color: var(--primary-hover) !important;
	color: white !important;
	transform: translateY(-1px) !important;
	box-shadow: 0 4px 8px rgba(49, 130, 206, 0.3) !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è date picker —Å Flatpickr */
.date-input-wrapper {
	position: relative;
	width: 100%;
}

.date-input-wrapper .date-icon {
	position: absolute;
	right: 12px;
	top: 50%;
	transform: translateY(-50%);
	color: var(--text-muted);
	font-size: 14px;
	pointer-events: none;
	z-index: 1;
}

.date-input-wrapper input {
	padding-right: 35px !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è Flatpickr –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
.flatpickr-calendar {
	background: var(--bg-elevated) !important;
	border: 1px solid var(--border-color) !important;
	color: var(--light-color) !important;
}

.flatpickr-calendar .flatpickr-day {
	color: var(--light-color) !important;
}

.flatpickr-calendar .flatpickr-day:hover {
	background: var(--bg-hover) !important;
}

.flatpickr-calendar .flatpickr-day.selected {
	background: var(--primary-color) !important;
	color: white !important;
}

.flatpickr-calendar .flatpickr-day.today {
	border-color: var(--primary-color) !important;
}

.flatpickr-calendar .flatpickr-months {
	background: var(--bg-surface) !important;
}

.flatpickr-calendar .flatpickr-month {
	color: var(--light-color) !important;
}

.flatpickr-calendar .flatpickr-prev-month,
.flatpickr-calendar .flatpickr-next-month {
	color: var(--light-color) !important;
}

.flatpickr-calendar .flatpickr-prev-month:hover,
.flatpickr-calendar .flatpickr-next-month:hover {
	background: var(--bg-hover) !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ - –∫–∞–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ –ò—Å—Ç–æ—Ä–∏—è */
#promoCodesTable {
	width: 100% !important;
	border-collapse: collapse !important;
	background: var(--bg-surface) !important;
	overflow: visible !important;
}

#promoCodesTable th,
#promoCodesTable td {
	border: 1px solid var(--border-color) !important;
	padding: 10px !important;
	text-align: left !important;
	vertical-align: middle !important;
	color: var(--light-color) !important;
}

#promoCodesTable thead {
	background-color: #0a1222 !important;
}

#promoCodesTable th {
	font-weight: 600 !important;
}

#promoCodesTable tbody tr:hover {
	background: #1a2437 !important;
}

#promoCodesTable tbody tr {
	transition: background-color 0.2s ease;
}

#promoCodesTable tbody tr:hover {
	background: #1a2437 !important;
	transform: translateY(-1px);
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

#promoCodesTable tbody tr:last-child td {
	border-bottom: none !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∏—Å—Ç–æ—Ä–∏–∏ - –∫–∞–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ –ü–ª–∞—Ç–µ–∂–∏ */
#usageHistoryTable {
	width: 100% !important;
	border-collapse: collapse !important;
	margin-top: 20px !important;
	background: var(--bg-surface) !important;
	border-radius: 8px !important;
	overflow: visible !important;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
	border: 1px solid var(--border-color) !important;
}

#usageHistoryTable th,
#usageHistoryTable td {
	border: 1px solid var(--border-color) !important;
	padding: 10px !important;
	text-align: left !important;
	vertical-align: middle !important;
	color: var(--light-color) !important;
}

#usageHistoryTable thead {
	background-color: #0a1222 !important;
}

#usageHistoryTable th {
	font-weight: 600 !important;
}

#usageHistoryTable tbody tr:hover {
	background: #1a2437 !important;
}

#usageHistoryTable tbody tr:last-child td {
	border-bottom: none !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–π –∫–Ω–æ–ø–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö */
.button-sm {
	padding: 4px 8px !important;
	font-size: 12px !important;
	height: 24px !important;
	min-width: 24px !important;
	display: inline-flex !important;
	align-items: center !important;
	justify-content: center !important;
	background: var(--bg-elevated) !important;
	border: 1px solid var(--border-color) !important;
	color: var(--light-color) !important;
}

.button-sm:hover {
	background: var(--bg-hover) !important;
	border-color: var(--primary-color) !important;
	color: var(--primary-color) !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ */
.promo-advanced-section {
	margin-top: 20px;
	padding: 20px;
	border-radius: 8px;
}

.promo-advanced-section h4 {
	margin: 0 0 15px 0;
	color: #495057;
	font-size: 16px;
	font-weight: 600;
}

/* –ö–µ–±–∞–±-–º–µ–Ω—é –≤–æ –≤–∫–ª–∞–¥–∫–µ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ Drawer */
#promoDrawer .kebab-wrapper { position: relative; }
#promoDrawer .kebab-menu {
    position: absolute;
    top: calc(100% + 8px);
    /* –∏–∑–±–µ–≥–∞–µ–º left:0/right:0 —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º */
    left: 8px;
    z-index: 10050; /* –≤—ã—à–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ drawer */
}
#promoDrawer #tab-usage .modal-table-container { overflow: visible; }

/* –°—Ç–∏–ª–∏ –¥–ª—è datetime picker –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
input[type="datetime-local"] {
	-webkit-appearance: none;
	-moz-appearance: none;
	appearance: none;
	background: #2d3748;
	border: 1px solid #4a5568;
	border-radius: 6px;
	padding: 10px 12px;
	font-size: 14px;
	color: #e2e8f0;
	width: 100%;
	box-sizing: border-box;
	transition: all 0.2s ease;
}

input[type="datetime-local"]:focus {
	outline: none;
	border-color: #3182ce;
	box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
	background: #1a202c;
}

input[type="datetime-local"]:hover {
	border-color: #718096;
	background: #2d3748;
}

input[type="datetime-local"]::-webkit-calendar-picker-indicator {
	background: transparent;
	bottom: 0;
	color: #a0aec0;
	cursor: pointer;
	height: auto;
	left: 0;
	position: absolute;
	right: 0;
	top: 0;
	width: auto;
	filter: invert(1);
}

input[type="datetime-local"]::-webkit-calendar-picker-indicator:hover {
	color: #e2e8f0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è Firefox */
input[type="datetime-local"]::-moz-calendar-picker-indicator {
	background: transparent;
	color: #a0aec0;
	cursor: pointer;
	filter: invert(1);
}

input[type="datetime-local"]::-moz-calendar-picker-indicator:hover {
	color: #e2e8f0;
}

.promo-summary-textarea {
    white-space: pre-wrap;
}

.promo-advanced-content {
	display: flex;
	flex-direction: column;
	gap: 15px;
}

.form-group--full {
	grid-column: 1 / -1;
}

.promo-link-container {
	display: flex;
	gap: 8px;
}

.promo-link-container .form-input {
	flex: 1;
}

.promo-link-container .button {
	flex-shrink: 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Å –Ω–æ–≤—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ */
.promo-card-advanced {
	background: #fff;
	border: 1px solid #e9ecef;
	border-radius: 8px;
	padding: 15px;
	margin-bottom: 15px;
	box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.promo-card-advanced .promo-card-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 10px;
}

.promo-card-advanced .promo-card-title {
	font-size: 16px;
	font-weight: 600;
	color: #495057;
	margin: 0;
}

.promo-card-advanced .promo-card-status {
	padding: 4px 8px;
	border-radius: 4px;
	font-size: 12px;
	font-weight: 500;
}

.promo-card-advanced .promo-card-status.active {
	background: #d4edda;
	color: #155724;
}

.promo-card-advanced .promo-card-status.inactive {
	background: #f8d7da;
	color: #721c24;
}

.promo-card-advanced .promo-card-details {
	display: grid;
	grid-template-columns: 1fr 1fr;
	gap: 10px;
	margin-bottom: 10px;
}

.promo-card-advanced .promo-detail-item {
	display: flex;
	flex-direction: column;
}

.promo-card-advanced .promo-detail-label {
	font-size: 12px;
	color: #6c757d;
	margin-bottom: 2px;
}

.promo-card-advanced .promo-detail-value {
	font-size: 14px;
	color: #495057;
	font-weight: 500;
}

.promo-card-advanced .promo-link {
	background: #e9ecef;
	border: 1px solid #ced4da;
	border-radius: 4px;
	padding: 8px;
	font-size: 12px;
	color: #495057;
	word-break: break-all;
	margin-top: 10px;
}

.promo-card-advanced .promo-actions {
	display: flex;
	gap: 8px;
	margin-top: 10px;
}

.promo-card-advanced .button {
	padding: 6px 12px;
	font-size: 12px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å –Ω–æ–≤—ã–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏ */
.promo-table-advanced th,
.promo-table-advanced td {
	padding: 8px 12px;
	text-align: left;
	border-bottom: 1px solid #e9ecef;
}

.promo-table-advanced .promo-link-cell {
	max-width: 200px;
	word-break: break-all;
}

.promo-table-advanced .promo-groups-cell {
	max-width: 150px;
}

.promo-table-advanced .promo-dates-cell {
	font-size: 12px;
	color: #6c757d;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–º–æ–∫–æ–¥–∞ */
.promo-details {
	margin-top: 20px;
	padding: 20px;
	background: var(--bg-surface);
	border-radius: 8px;
	border: 1px solid var(--border-color);
}

.promo-details h4 {
	margin: 0 0 15px 0;
	color: var(--light-color);
	font-size: 16px;
	font-weight: 600;
}

.promo-details .info-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
	gap: 15px;
}

.promo-details .info-item {
	display: flex;
	flex-direction: column;
}

.promo-details .info-item label {
	font-size: 12px;
	color: var(--text-muted);
	margin-bottom: 4px;
	font-weight: 500;
}

.promo-details .info-item span {
	font-size: 14px;
	color: var(--light-color);
	font-weight: 500;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
	.promo-advanced-content {
		gap: 10px;
	}
	
	.promo-card-advanced .promo-card-details {
		grid-template-columns: 1fr;
	}

	.promo-details .info-grid {
		grid-template-columns: 1fr;
	}
}
</style>

<script>
let currentPromoId = null;
let vpnPlans = [];
// –ú–µ–Ω–µ–¥–∂–µ—Ä –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (best practice: –º–æ–¥—É–ª—å —Å —è–≤–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π)
const PromoGroupsManager = (function() {
    let groups = [];
    let pendingSelectedIds = [];
    let initialized = false;

    function getSelect() {
        return document.getElementById('promoTargetGroups');
    }

    async function load() {
        const select = getSelect();
        if (select) {
            select.innerHTML = '<option value="">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</option>';
        }
        try {
            const resp = await fetchWithCSRF('/api/user-groups', { method: 'GET' });
            const data = await resp.json();
            if (data && data.success && Array.isArray(data.groups)) {
                groups = data.groups;
                render();
                applyPendingSelection();
            } else {
                if (select) select.innerHTML = '<option value="">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø</option>';
            }
        } catch (e) {
            if (select) select.innerHTML = '<option value="">üí• –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø</option>';
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', e);
        }
    }

    function render() {
        const select = getSelect();
        if (!select) return;
        select.innerHTML = '';
        groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.group_id;
            opt.textContent = `${g.group_name} (${g.user_count || 0} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)`;
            select.appendChild(opt);
        });
        if (groups.length === 0) {
            select.innerHTML = '<option value="">‚ö†Ô∏è –ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
        }
    }

    function applyPendingSelection() {
        if (!pendingSelectedIds || pendingSelectedIds.length === 0) return;
        const select = getSelect();
        if (!select || select.options.length === 0) return;
        Array.from(select.options).forEach(opt => {
            opt.selected = pendingSelectedIds.includes(parseInt(opt.value));
        });
        pendingSelectedIds = [];
    }

    function selectByIds(ids) {
        const normalized = Array.isArray(ids) ? ids.map(x => parseInt(x)).filter(n => !isNaN(n)) : [];
        const select = getSelect();
        if (select && select.options.length > 0) {
            Array.from(select.options).forEach(opt => {
                opt.selected = normalized.includes(parseInt(opt.value));
            });
        } else {
            pendingSelectedIds = normalized;
        }
    }

    async function init() {
        if (initialized) return;
        initialized = true;
        await load();
    }

    function ensure() {
        if (!initialized) {
            // –ª–µ–Ω–∏–≤—ã–π —Å—Ç–∞—Ä—Ç –±–µ–∑ await
            init();
        }
    }

    return { init, ensure, load, render, selectByIds };
})();
let isCardView = false; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥
let allPromoCodes = [];
let filteredPromoCodes = [];
let userPromoCodes = [];
let promoCurrentUserId; // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è fetch –∑–∞–ø—Ä–æ—Å–æ–≤
async function fetchWithCSRF(url, options = {}) {
	const defaultOptions = {
		headers: {
			'Content-Type': 'application/json',
			...options.headers
		},
		credentials: 'same-origin'
	};
	
	return fetch(url, { ...defaultOptions, ...options });
}

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
let allUsageHistory = [];
let filteredUsageHistory = [];

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
	console.log('DOM loaded, starting data loading...');
	loadPromoCodes();
	loadVpnPlans();
    PromoGroupsManager.init();
	loadUserPromoCodes();
	loadUsageHistory();

	// –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∑—é–º–µ –∫ –ø–æ–ª—è–º —Ñ–æ—Ä–º—ã
	const bindIds = [
		'promoCode','promoBot','promoVpnPlan','promoTariff',
		'promoDiscountAmount','promoDiscountPercent','promoDiscountBonus',
		'promoUsageLimit','promoBurnAfterAt','promoValidUntil','promoTargetGroups'
	];
	bindIds.forEach(id => {
		const el = document.getElementById(id);
		if (!el) return;
		const evt = (el.tagName === 'SELECT' || el.type === 'checkbox' || el.type === 'datetime-local' || el.type === 'number') ? 'change' : 'input';
		el.addEventListener(evt, updatePromoSummary);
	});
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
async function loadPromoCodes() {
	try {
		console.log('Loading promo codes...');
		showLoadingState();
		const response = await fetchWithCSRF('/api/promo-codes');
		console.log('Promo codes response status:', response.status);
		
		if (response.redirected && response.url.includes('/login')) {
			console.error('Redirected to login page - authentication required for promo codes');
			showNotification('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
			showEmptyState();
			return;
		}
		
		const data = await response.json();
		console.log('Promo codes response data:', data);
		
		if (data.success) {
			allPromoCodes = data.promo_codes;
			filteredPromoCodes = [...allPromoCodes];
			updatePromoCount(allPromoCodes.length);
			
			if (allPromoCodes.length === 0) {
				showEmptyState();
			} else {
				if (isCardView) {
					renderPromoCards(filteredPromoCodes);
				} else {
					renderPromoCodesTable(filteredPromoCodes);
				}
			}
		} else {
			showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: ' + data.message, 'error');
			showEmptyState();
		}
	} catch (error) {
		console.error('Error loading promo codes:', error);
		showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤', 'error');
		showEmptyState();
	}
}

// –ó–∞–≥—Ä—É–∑–∫–∞ VPN –ø–ª–∞–Ω–æ–≤
async function loadVpnPlans() {
	try {
		const response = await fetchWithCSRF('/api/vpn-plans');
		const data = await response.json();
		
		if (data.success) {
			vpnPlans = data.plans;
			updateVpnPlansSelect();
		}
	} catch (error) {
		console.error('Error loading VPN plans:', error);
	}
}

// –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ loadUserGroups/updateUserGroupsSelect; –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è PromoGroupsManager

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ VPN –ø–ª–∞–Ω–æ–≤
function updateVpnPlansSelect() {
	const select = document.getElementById('promoVpnPlan');
	select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ</option>';
	
	vpnPlans.forEach(plan => {
		const option = document.createElement('option');
		option.value = plan.plan_id;
		option.textContent = `${plan.host_name} - ${plan.plan_name}`;
		select.appendChild(option);
	});
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–ò–°–ê–ù–ê
function updateUserGroupsSelect() {
	console.log('üîÑ Updating user groups select...');
	
	const select = document.getElementById('promoTargetGroups');
	if (!select) {
		console.error('‚ùå –°–µ–ª–µ–∫—Ç promoTargetGroups –Ω–µ –Ω–∞–π–¥–µ–Ω!');
		return;
	}
	
	// –û—á–∏—â–∞–µ–º —Å–µ–ª–µ–∫—Ç
	select.innerHTML = '';
	
	if (userGroups && userGroups.length > 0) {
		console.log('‚úÖ Updating select with', userGroups.length, 'groups');
		
		userGroups.forEach(group => {
			const option = document.createElement('option');
			option.value = group.group_id;
			option.textContent = `${group.group_name} (${group.user_count || 0} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)`;
			select.appendChild(option);
		});
		
		console.log('‚úÖ Select updated successfully');
	} else {
		console.warn('‚ö†Ô∏è No groups available');
		select.innerHTML = '<option value="">‚ö†Ô∏è –ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
	}
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function loadUserPromoCodes() {
	try {
		// –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª
		const urlParams = new URLSearchParams(window.location.search);
		promoCurrentUserId = urlParams.get('user_id');
		
		if (!promoCurrentUserId) {
			// –ï—Å–ª–∏ –Ω–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–∫—Ä—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª
			document.getElementById('userPromoSection').style.display = 'none';
			return;
		}
		
		showUserPromoLoadingState();
		const response = await fetchWithCSRF(`/api/user-promo-codes?user_id=${promoCurrentUserId}&bot=shop`);
		const data = await response.json();
		
		if (data.success) {
			userPromoCodes = data.promo_codes;
			updateUserPromoCount(userPromoCodes.length);
			
			if (userPromoCodes.length === 0) {
				showUserEmptyState();
			} else {
				renderUserPromoCards(userPromoCodes);
			}
			// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
			document.getElementById('userPromoSection').style.display = 'block';
		} else {
			showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: ' + data.message, 'error');
			showUserEmptyState();
		}
	} catch (error) {
		console.error('Error loading user promo codes:', error);
		showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤', 'error');
		showUserEmptyState();
	}
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function showUserPromoLoadingState() {
	const cardsContainer = document.getElementById('userPromoCards');
	const emptyState = document.getElementById('userEmptyState');
	
	emptyState.style.display = 'none';
	cardsContainer.innerHTML = `
		<div class="user-promo-card loading-card">
			<div class="promo-card-skeleton">
				<div class="skeleton-line skeleton-title"></div>
				<div class="skeleton-line skeleton-subtitle"></div>
				<div class="skeleton-line skeleton-text"></div>
				<div class="skeleton-line skeleton-text"></div>
			</div>
		</div>
	`;
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function showUserEmptyState() {
	const cardsContainer = document.getElementById('userPromoCards');
	const emptyState = document.getElementById('userEmptyState');
	
	cardsContainer.innerHTML = '';
	emptyState.style.display = 'flex';
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function updateUserPromoCount(count) {
	document.getElementById('userPromoCount').textContent = count;
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function renderUserPromoCards(promoCodes) {
	const cardsContainer = document.getElementById('userPromoCards');
	const emptyState = document.getElementById('userEmptyState');
	
	emptyState.style.display = 'none';
	
	cardsContainer.innerHTML = promoCodes.map(promo => `
		<div class="user-promo-card">
			<div class="user-promo-card-header">
				<div class="promo-code">
					<code>${promo.code}</code>
				</div>
				<div class="promo-status">
					<span class="badge badge-success">–ü—Ä–∏–º–µ–Ω—ë–Ω</span>
				</div>
			</div>
			
			<div class="user-promo-card-body">
				<div class="promo-info">
					<div class="info-row">
						<span class="info-label">–î–∞—Ç–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:</span>
						<span class="info-value">${formatDate(promo.used_at)}</span>
					</div>
					
					${promo.host_name ? `
					<div class="info-row">
						<span class="info-label">VPN —Ç–∞—Ä–∏—Ñ:</span>
						<span class="info-value">${promo.host_name} - ${promo.plan_name}</span>
					</div>
					` : ''}
					
					<div class="promo-discounts">
						${promo.discount_amount ? `
						<div class="discount-item">
							<span class="discount-label">–°–∫–∏–¥–∫–∞ (‚ÇΩ):</span>
							<span class="discount-value">${promo.discount_amount} ‚ÇΩ</span>
						</div>
						` : ''}
						
						${promo.discount_percent ? `
						<div class="discount-item">
							<span class="discount-label">–°–∫–∏–¥–∫–∞ (%):</span>
							<span class="discount-value">${promo.discount_percent}%</span>
						</div>
						` : ''}
						
						${promo.discount_bonus ? `
						<div class="discount-item">
							<span class="discount-label">–ë–æ–Ω—É—Å:</span>
							<span class="discount-value">${promo.discount_bonus}</span>
						</div>
						` : ''}
					</div>
				</div>
			</div>
			
			<div class="user-promo-card-actions">
				<button class="button button-sm button-danger" onclick="removeUserPromoCode(${promo.promo_id})" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞">
					<i class="fas fa-trash"></i>
					–£–¥–∞–ª–∏—Ç—å
				</button>
			</div>
		</div>
	`).join('');
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
async function removeUserPromoCode(promoId) {
	if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –∏–∑ –≤–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞?')) {
		return;
	}
	
	try {
		const response = await fetchWithCSRF(`/api/user-promo-codes/${promoId}`, {
			method: 'DELETE',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				user_id: promoCurrentUserId,
				bot: 'shop'
			})
		});
		
		const data = await response.json();
		
		if (data.success) {
			showNotification('–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω –∏–∑ –≤–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞', 'success');
			loadUserPromoCodes(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
		} else {
			showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.message, 'error');
		}
	} catch (error) {
		console.error('Error removing user promo code:', error);
		showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞', 'error');
	}
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function refreshUserPromoCodes() {
	loadUserPromoCodes();
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
function showLoadingState() {
	const cardsGrid = document.getElementById('promoCardsGrid');
	const tableContainer = document.getElementById('tableContainer');
	const promoSection = document.getElementById('promoSection');
	const emptyState = document.getElementById('emptyState');
	
	emptyState.style.display = 'none';
	
	if (isCardView) {
		cardsGrid.style.display = 'grid';
		tableContainer.style.display = 'none';
		promoSection.style.display = 'none';
		cardsGrid.innerHTML = `
			<div class="promo-card loading-card">
				<div class="promo-card-skeleton">
					<div class="skeleton-line skeleton-title"></div>
					<div class="skeleton-line skeleton-subtitle"></div>
					<div class="skeleton-line skeleton-text"></div>
					<div class="skeleton-line skeleton-text"></div>
				</div>
			</div>
		`;
	} else {
		cardsGrid.style.display = 'none';
		tableContainer.style.display = 'block';
		promoSection.style.display = 'block';
		const tbody = document.querySelector('#promoCodesTable tbody');
		tbody.innerHTML = '<tr><td colspan="15" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
	}
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
function showEmptyState() {
	const cardsGrid = document.getElementById('promoCardsGrid');
	const tableContainer = document.getElementById('tableContainer');
	const promoSection = document.getElementById('promoSection');
	const emptyState = document.getElementById('emptyState');
	
	cardsGrid.style.display = 'none';
	tableContainer.style.display = 'none';
	promoSection.style.display = 'none';
	emptyState.style.display = 'flex';
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function updatePromoCount(count) {
	document.getElementById('promoCount').textContent = count;
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function renderPromoCards(promoCodes) {
	const cardsGrid = document.getElementById('promoCardsGrid');
	const tableContainer = document.getElementById('tableContainer');
	const emptyState = document.getElementById('emptyState');
	
	emptyState.style.display = 'none';
	cardsGrid.style.display = 'grid';
	tableContainer.style.display = 'none';
	
	cardsGrid.innerHTML = promoCodes.map(promo => `
		<div class="promo-card ${promo.is_active ? 'active' : 'inactive'}">
			<div class="promo-card-header">
				<div class="promo-code">
					<code>${promo.code}</code>
				</div>
				<div class="promo-status">
					<span class="badge badge-${promo.is_active ? 'success' : 'danger'}">
						${promo.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
					</span>
				</div>
			</div>
			
			<div class="promo-card-body">
				<div class="promo-info">
					<div class="info-row">
						<span class="info-label">–ë–æ—Ç:</span>
						<span class="badge badge-${promo.bot === 'shop' ? 'primary' : 'secondary'}">
							${promo.bot === 'shop' ? 'Shop' : 'Support'}
						</span>
					</div>
					
					${promo.host_name ? `
					<div class="info-row">
						<span class="info-label">VPN —Ç–∞—Ä–∏—Ñ:</span>
						<span class="info-value">${promo.host_name} - ${promo.plan_name}</span>
					</div>
					` : ''}
					
					<div class="promo-discounts">
						${promo.discount_amount ? `
						<div class="discount-item">
							<span class="discount-label">–°–∫–∏–¥–∫–∞ (‚ÇΩ):</span>
							<span class="discount-value">${promo.discount_amount} ‚ÇΩ</span>
						</div>
						` : ''}
						
						${promo.discount_percent ? `
						<div class="discount-item">
							<span class="discount-label">–°–∫–∏–¥–∫–∞ (%):</span>
							<span class="discount-value">${promo.discount_percent}%</span>
						</div>
						` : ''}
						
						${promo.discount_bonus ? `
						<div class="discount-item">
							<span class="discount-label">–ë–æ–Ω—É—Å:</span>
							<span class="discount-value">${promo.discount_bonus}</span>
						</div>
						` : ''}
					</div>
					
					<div class="promo-stats">
						<div class="stat-item">
							<span class="stat-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π:</span>
							<span class="stat-value ${promo.usage_total > 0 ? 'text-warning' : ''}">${promo.usage_total || 0}</span>
						</div>
						<div class="stat-item">
							<span class="stat-label">–°–æ–∑–¥–∞–Ω:</span>
							<span class="stat-value">${formatDate(promo.created_at)}</span>
						</div>
						${promo.valid_until ? `
						<div class="stat-item">
							<span class="stat-label">–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ:</span>
							<span class="stat-value">${formatDate(promo.valid_until)}</span>
						</div>
						` : ''}
						${promo.burn_after_value && promo.burn_after_unit ? `
						<div class="stat-item">
							<span class="stat-label">–°—Ä–æ–∫ —Å–≥–æ—Ä–∞–Ω–∏—è:</span>
							<span class="stat-value">${promo.burn_after_value} ${getBurnUnitText(promo.burn_after_unit)}</span>
						</div>
						` : ''}
						${promo.target_group_ids && promo.target_group_ids.length > 0 ? `
						<div class="stat-item">
							<span class="stat-label">–ì—Ä—É–ø–ø—ã:</span>
							<span class="stat-value">${promo.target_group_ids.length} –≥—Ä—É–ø–ø</span>
						</div>
						` : ''}
						${promo.usage_total > 0 ? `
						<div class="stat-item">
							<span class="stat-label">–°—Ç–∞—Ç—É—Å:</span>
							<span class="stat-value text-warning">
								<i class="fas fa-lock"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
							</span>
						</div>
						` : ''}
					</div>
					
					${promo.promo_link ? `
					<div class="promo-link">
						<strong>–°—Å—ã–ª–∫–∞:</strong> 
						<a href="${promo.promo_link}" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ–º–æ–∫–æ–¥">${promo.promo_link}</a>
					</div>
					` : ''}
				</div>
			</div>
			
			<div class="promo-card-actions">
				<button class="button button-sm button-primary" onclick="editPromoCode(${promo.promo_id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥">
					<i class="fas fa-edit"></i>
					–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
				</button>
				${promo.usage_total > 0 ? `
				<button class="button button-sm button-secondary" disabled title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥">
					<i class="fas fa-lock"></i>
					–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
				</button>
				` : `
				<button class="button button-sm button-danger" onclick="confirmDeletePromoCode(${promo.promo_id})" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥">
					<i class="fas fa-trash"></i>
					–£–¥–∞–ª–∏—Ç—å
				</button>
				`}
			</div>
		</div>
	`).join('');
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function renderPromoCodesTable(promoCodes) {
	const tbody = document.querySelector('#promoCodesTable tbody');
	const cardsGrid = document.getElementById('promoCardsGrid');
	const tableContainer = document.getElementById('tableContainer');
	const promoSection = document.getElementById('promoSection');
	const emptyState = document.getElementById('emptyState');
	
	emptyState.style.display = 'none';
	cardsGrid.style.display = 'none';
	tableContainer.style.display = 'block';
	promoSection.style.display = 'block';
	
	if (promoCodes.length === 0) {
		tbody.innerHTML = '<tr><td colspan="15" class="text-center">–ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
		return;
	}
	
	tbody.innerHTML = promoCodes.map(promo => `
		<tr ondblclick="editPromoCode(${promo.promo_id})" style="cursor: pointer;" title="–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">
			<td>${promo.promo_id}</td>
			<td>${formatDate(promo.created_at)}</td>
			<td><code>${promo.code}</code></td>
			<td><span class="badge badge-${promo.bot === 'shop' ? 'primary' : 'secondary'}">${promo.bot === 'shop' ? 'Shop' : 'Support'}</span></td>
			<td>${promo.host_name ? `${promo.host_name} - ${promo.plan_name}` : '-'}</td>
			<td>${promo.discount_amount ? promo.discount_amount + ' ‚ÇΩ' : '-'}</td>
			<td>${promo.discount_percent ? promo.discount_percent + '%' : '-'}</td>
			<td>${promo.discount_bonus ? promo.discount_bonus + ' –ë' : '-'}</td>
			<td><span class="badge badge-info">${promo.usage_total || 0}</span></td>
			<td class="promo-dates-cell">${promo.burn_after_value && promo.burn_after_unit ? `${promo.burn_after_value} ${getBurnUnitText(promo.burn_after_unit)}` : '-'}</td>
			<td class="promo-dates-cell">${promo.valid_until ? formatDate(promo.valid_until) : '-'}</td>
			<td class="promo-groups-cell">${promo.target_group_ids && promo.target_group_ids.length > 0 ? `${promo.target_group_ids.length} –≥—Ä—É–ø–ø` : '–í—Å–µ'}</td>
			<td class="promo-link-cell">${promo.promo_link ? `<a href="${promo.promo_link}" target="_blank" onclick="event.stopPropagation();" title="–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É">–°—Å—ã–ª–∫–∞</a>` : '-'}</td>
			<td><span class="badge badge-${promo.is_active ? 'success' : 'danger'}">${promo.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span></td>
			<td>
				<button class="button button-sm button-primary" onclick="event.stopPropagation(); editPromoCode(${promo.promo_id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥">
					<i class="fas fa-edit"></i>
				</button>
				${promo.usage_total > 0 ? `
				<button class="button button-sm button-secondary" disabled title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥">
					<i class="fas fa-lock"></i>
				</button>
				` : `
				<button class="button button-sm button-danger" onclick="event.stopPropagation(); confirmDeletePromoCode(${promo.promo_id})" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥">
					<i class="fas fa-trash"></i>
				</button>
				`}
			</td>
		</tr>
	`).join('');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function toggleViewMode() {
	isCardView = !isCardView;
	const viewModeIcon = document.getElementById('viewIcon');
	const viewModeText = document.getElementById('viewText');
	
	if (isCardView) {
		viewModeIcon.className = 'fas fa-th';
		viewModeText.textContent = '–¢–∞–±–ª–∏—Ü–∞';
		renderPromoCards(filteredPromoCodes);
	} else {
		viewModeIcon.className = 'fas fa-list';
		viewModeText.textContent = '–ö–∞—Ä—Ç–æ—á–∫–∏';
		renderPromoCodesTable(filteredPromoCodes);
	}
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ Drawer –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
function openPromoDrawer() {
    currentPromoId = null;
    document.getElementById('promoDrawerTitle').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞';
    document.getElementById('deletePromoButton').style.display = 'none';
    clearPromoForm();
    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    PromoGroupsManager.ensure();
    const drawer = document.getElementById('promoDrawer');
    drawer.style.display = 'block';
    setTimeout(() => drawer.classList.add('active'), 10);
}
// –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∏–º–µ–Ω–µ–º
function openPromoModal() { openPromoDrawer(); }

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
async function editPromoCode(promoId) {
	try {
		const response = await fetchWithCSRF(`/api/promo-codes/${promoId}`);
		const data = await response.json();
		
		if (data.success) {
			currentPromoId = promoId;
            document.getElementById('promoDrawerTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞';
			document.getElementById('deletePromoButton').style.display = 'inline-block';
			populatePromoForm(data.promo_code);
			loadPromoUsageHistory(promoId);
            const drawer = document.getElementById('promoDrawer');
            drawer.style.display = 'block';
            setTimeout(() => drawer.classList.add('active'), 10);
		} else {
			showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞: ' + data.message, 'error');
		}
	} catch (error) {
		console.error('Error loading promo code:', error);
		showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞', 'error');
	}
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–æ–º–æ–∫–æ–¥–∞
function populatePromoForm(promo) {
	document.getElementById('promoCode').value = promo.code;
	document.getElementById('promoBot').value = promo.bot;
	
	// –û–±—Ä–∞–±–æ—Ç–∫–∞ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞ VPN –ø–ª–∞–Ω–æ–≤
	const vpnPlanSelect = document.getElementById('promoVpnPlan');
	if (promo.vpn_plan_id) {
		// –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤ ID, –≤—ã–±–∏—Ä–∞–µ–º –≤—Å–µ
		if (Array.isArray(promo.vpn_plan_id)) {
			Array.from(vpnPlanSelect.options).forEach(option => {
				option.selected = promo.vpn_plan_id.includes(parseInt(option.value));
			});
		} else {
			// –ï—Å–ª–∏ —ç—Ç–æ –æ–¥–∏–Ω–æ—á–Ω—ã–π ID
			vpnPlanSelect.value = promo.vpn_plan_id;
		}
	} else {
		// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
		Array.from(vpnPlanSelect.options).forEach(option => {
			option.selected = false;
		});
	}
	
	// –û–±—Ä–∞–±–æ—Ç–∫–∞ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ (—ç–ª–µ–º–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫—Ä—ã—Ç)
	const tariffSelect = document.getElementById('promoTariff');
	if (tariffSelect && promo.tariff_code) {
		// –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤ –∫–æ–¥–æ–≤, –≤—ã–±–∏—Ä–∞–µ–º –≤—Å–µ
		if (Array.isArray(promo.tariff_code)) {
			Array.from(tariffSelect.options).forEach(option => {
				option.selected = promo.tariff_code.includes(option.value);
			});
		} else {
			// –ï—Å–ª–∏ —ç—Ç–æ –æ–¥–∏–Ω–æ—á–Ω—ã–π –∫–æ–¥
			tariffSelect.value = promo.tariff_code;
		}
	} else if (tariffSelect) {
		// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
		Array.from(tariffSelect.options).forEach(option => {
			option.selected = false;
		});
	}
	
	document.getElementById('promoDiscountAmount').value = promo.discount_amount || '';
	document.getElementById('promoDiscountPercent').value = promo.discount_percent || '';
	document.getElementById('promoDiscountBonus').value = promo.discount_bonus || '';
	document.getElementById('promoUsageLimit').value = promo.usage_limit_per_bot || 1;
	document.getElementById('promoIsActive').checked = promo.is_active;
	
    // –ù–æ–≤—ã–µ –ø–æ–ª—è (datetime –¥–ª—è —Å—Ä–æ–∫–∞ —Å–≥–æ—Ä–∞–Ω–∏—è)
    const burnAtInput = document.getElementById('promoBurnAfterAt');
    if (promo.burn_after_value && promo.burn_after_unit) {
        let minutes = promo.burn_after_value;
        if (promo.burn_after_unit === 'hour') minutes *= 60;
        if (promo.burn_after_unit === 'day') minutes *= 1440;
        const target = new Date(Date.now() + minutes * 60000);
        const offset = target.getTimezoneOffset();
        const local = new Date(target.getTime() - offset * 60000);
        burnAtInput.value = local.toISOString().slice(0, 16);
    } else {
        burnAtInput.value = '';
    }
    document.getElementById('promoValidUntil').value = promo.valid_until ? promo.valid_until.slice(0, 16) : '';
	
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äî –¥–µ–ª–µ–≥–∏—Ä—É–µ–º –≤—ã–±–æ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä—É
    PromoGroupsManager.selectByIds(Array.isArray(promo.target_group_ids) ? promo.target_group_ids : []);
	
	// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ–º–æ–∫–æ–¥
	updatePromoLink();
	updatePromoSummary();
	
	// –î–µ—Ç–∞–ª–∏
	document.getElementById('promoDetailsId').textContent = promo.promo_id;
	document.getElementById('promoDetailsCreated').textContent = formatDate(promo.created_at);
	document.getElementById('promoDetailsUpdated').textContent = formatDate(promo.updated_at);
}

// –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–æ–º–æ–∫–æ–¥–∞
function clearPromoForm() {
	document.getElementById('promoCode').value = '';
	document.getElementById('promoBot').value = '';
	
	// –û—á–∏—â–∞–µ–º –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç—ã
	Array.from(document.getElementById('promoVpnPlan').options).forEach(option => {
		option.selected = false;
	});
	const tariffSelect = document.getElementById('promoTariff');
	if (tariffSelect) {
		Array.from(tariffSelect.options).forEach(option => {
			option.selected = false;
		});
	}
	
	document.getElementById('promoDiscountAmount').value = '';
	document.getElementById('promoDiscountPercent').value = '';
	document.getElementById('promoDiscountBonus').value = '';
	document.getElementById('promoUsageLimit').value = 1;
	document.getElementById('promoIsActive').checked = true;
	
    // –û—á–∏—â–∞–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è
    document.getElementById('promoBurnAfterAt').value = '';
    document.getElementById('promoValidUntil').value = '';
	
	// –û—á–∏—â–∞–µ–º –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
	Array.from(document.getElementById('promoTargetGroups').options).forEach(option => {
		option.selected = false;
	});
	
	// –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ–º–æ–∫–æ–¥
	document.getElementById('promoLink').value = '';

	// –û—á–∏—â–∞–µ–º —Ä–µ–∑—é–º–µ
	const summaryEl = document.getElementById('promoSummaryText');
	if (summaryEl) summaryEl.value = '';
	
	document.getElementById('promoDetailsId').textContent = '-';
	document.getElementById('promoDetailsCreated').textContent = '-';
	document.getElementById('promoDetailsUpdated').textContent = '-';
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ username –±–æ—Ç–∞ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
function getBotUsername() {
	const botSelect = document.getElementById('promoBot');
	const selectedBot = botSelect.options[botSelect.selectedIndex];
	
	if (selectedBot && selectedBot.value && selectedBot.value !== '') {
		// –ü–æ–ª—É—á–∞–µ–º username –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–æ—Ç–∞
        const raw = selectedBot.getAttribute('data-username') || selectedBot.value.toLowerCase().replace(' ', '_');
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º: —É–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–µ '@' –∏ –ø—Ä–æ–±–µ–ª—ã
        return (raw || '').toString().trim().replace(/^@+/, '');
	}
	return null;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–æ–º–æ–∫–æ–¥
function updatePromoLink() {
	const code = document.getElementById('promoCode').value;
	const botUsername = getBotUsername();
	
	if (code && botUsername) {
		document.getElementById('promoLink').value = `https://t.me/${botUsername}?start=promo_${code}`;
	} else {
		document.getElementById('promoLink').value = '';
	}
}

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–æ–º–æ–∫–æ–¥
function copyPromoLink() {
	const linkInput = document.getElementById('promoLink');
	if (linkInput.value) {
		linkInput.select();
		document.execCommand('copy');
		showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
	} else {
		showNotification('–°—Å—ã–ª–∫–∞ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞', 'error');
	}
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∑—é–º–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
function updatePromoSummary() {
    const code = document.getElementById('promoCode').value.trim();
    const link = document.getElementById('promoLink').value.trim();

    // VPN —Ç–∞—Ä–∏—Ñ—ã (–º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç): –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞–∫ "host_name ‚Äì plan_name" –∏–∑ options —Ç–µ–∫—Å—Ç–∞
    const vpnSelect = document.getElementById('promoVpnPlan');
    const selectedVpnTexts = Array.from(vpnSelect.selectedOptions)
        .map(opt => opt.textContent.trim())
        .filter(Boolean);

    // –¢–∞—Ä–∏—Ñ—ã (–º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç): –≤–∑—è—Ç—å –≤–∏–¥–∏–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∑ options —Ç–µ–∫—Å—Ç–∞
    const tariffSelect = document.getElementById('promoTariff');
    const selectedTariffTexts = tariffSelect
        ? Array.from(tariffSelect.selectedOptions).map(opt => opt.textContent.trim()).filter(Boolean)
        : [];

    // –°–∫–∏–¥–∫–∏
    const discountAmount = parseFloat(document.getElementById('promoDiscountAmount').value) || 0;
    const discountPercent = parseFloat(document.getElementById('promoDiscountPercent').value) || 0;
    const discountBonus = parseFloat(document.getElementById('promoDiscountBonus').value) || 0;

    // –õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
    const usageLimit = parseInt(document.getElementById('promoUsageLimit').value) || 0;

    // –°—Ä–æ–∫ —Å–≥–æ—Ä–∞–Ω–∏—è ‚Äî –±–µ—Ä—ë–º –ø–æ–ª–µ datetime-local –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
    const burnAtVal = document.getElementById('promoBurnAfterAt').value;

    // –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ
    const validUntilVal = document.getElementById('promoValidUntil').value;

    // –ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äî –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
    const groupsSelect = document.getElementById('promoTargetGroups');
    const selectedGroupNames = Array.from(groupsSelect.selectedOptions)
        .map(opt => opt.textContent.replace(/\s*\(.*\)$/,'').trim()) // —É–±—Ä–∞—Ç—å "(N –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)"
        .filter(Boolean);

    const lines = [];
    if (code) lines.push(`‚Ä¢ –ü—Ä–æ–º–æ–∫–æ–¥: ${code}`);
    if (link) lines.push(`‚Ä¢ –°—Å—ã–ª–∫–∞: ${link}`);

    const hasVpn = selectedVpnTexts.length > 0;
    const hasTariffs = selectedTariffTexts.length > 0;
    if (hasVpn || hasTariffs) {
        const vpnPart = hasVpn ? `–¢–∞—Ä–∏—Ñ VPN: ${selectedVpnTexts.join(', ')}` : '';
        const tariffsPart = hasTariffs ? `–¢–∞—Ä–∏—Ñ—ã: ${selectedTariffTexts.join(', ')}` : '';
        const tariffLine = [vpnPart, tariffsPart].filter(Boolean).join(' ');
        if (tariffLine) lines.push(`‚Ä¢ ${tariffLine}`);
    }

    const discountParts = [];
    if (discountAmount > 0) discountParts.push(`–°–∫–∏–¥–∫–∞ (‚ÇΩ): ${discountAmount}`);
    if (discountPercent > 0) discountParts.push(`–°–∫–∏–¥–∫–∞ (%): ${discountPercent}`);
    if (discountBonus > 0) discountParts.push(`–°–∫–∏–¥–∫–∞ (–±–æ–Ω—É—Å): ${discountBonus}`);
    if (discountParts.length > 0) lines.push(`‚Ä¢ ${discountParts.join(' ')}`);

    if (usageLimit > 0) lines.push(`‚Ä¢ –ö–≤–æ—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–π: ${usageLimit}`);
    if (burnAtVal) lines.push(`‚Ä¢ C—Ä–æ–∫ —Å–≥–æ—Ä–∞–Ω–∏—è: ${formatLocalDateTime(burnAtVal)}`);
    if (validUntilVal) lines.push(`‚Ä¢ –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: ${formatLocalDateTime(validUntilVal)}`);
    if (selectedGroupNames.length > 0) lines.push(`‚Ä¢ –ì—Ä—É–ø–ø–∞: ${selectedGroupNames.join(', ')}`);

    const summaryEl = document.getElementById('promoSummaryText');
    if (summaryEl) summaryEl.value = lines.join('\n');
}

function copyPromoSummary() {
    const el = document.getElementById('promoSummaryText');
    if (!el || !el.value) {
        showNotification('–†–µ–∑—é–º–µ –ø—É—Å—Ç–æ', 'error');
        return;
    }
    el.select();
    document.execCommand('copy');
    showNotification('–†–µ–∑—é–º–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
}

function formatLocalDateTime(val) {
    try {
        // val –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DDTHH:mm ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É
        const dt = new Date(val);
        return dt.toLocaleString('ru-RU');
    } catch (e) {
        return val;
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ–¥–∏–Ω–∏—Ü –≤—Ä–µ–º–µ–Ω–∏
function getBurnUnitText(unit) {
	const units = {
		'min': '–º–∏–Ω',
		'hour': '—á–∞—Å',
		'day': '–¥–Ω–µ–π'
	};
	return units[unit] || unit;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏
document.addEventListener('DOMContentLoaded', function() {
	const codeInput = document.getElementById('promoCode');
	const botSelect = document.getElementById('promoBot');
	
	if (codeInput) {
        codeInput.addEventListener('input', function(){ updatePromoLink(); updatePromoSummary(); });
	}
	if (botSelect) {
        botSelect.addEventListener('change', function(){ updatePromoLink(); updatePromoSummary(); });
	}
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
async function savePromoCode() {
	// –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ VPN –ø–ª–∞–Ω—ã
	const vpnPlanSelect = document.getElementById('promoVpnPlan');
	const selectedVpnPlans = Array.from(vpnPlanSelect.selectedOptions)
		.map(option => parseInt(option.value))
		.filter(value => !isNaN(value));
	
    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã (—ç–ª–µ–º–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫—Ä—ã—Ç)
    const tariffSelect = document.getElementById('promoTariff');
    const selectedTariffs = tariffSelect
        ? Array.from(tariffSelect.selectedOptions).map(option => option.value).filter(value => value.trim() !== '')
        : [];
	
	// –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
	const groupsSelect = document.getElementById('promoTargetGroups');
	const selectedGroups = Array.from(groupsSelect.selectedOptions)
		.map(option => parseInt(option.value))
		.filter(value => !isNaN(value));

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è datetime —Å—Ä–æ–∫–∞ —Å–≥–æ—Ä–∞–Ω–∏—è –≤ —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è value/unit
    let burn_after_value = null;
    let burn_after_unit = null;
    const burnAtVal = document.getElementById('promoBurnAfterAt').value;
    if (burnAtVal) {
        const target = new Date(burnAtVal);
        const now = new Date();
        const diffMs = target.getTime() - now.getTime();
        if (diffMs <= 0) {
            showNotification('–°—Ä–æ–∫ —Å–≥–æ—Ä–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º', 'error');
            return;
        }
        const minutes = Math.ceil(diffMs / 60000);
        if (minutes >= 2880) { // >= 2 –¥–Ω–µ–π
            burn_after_value = Math.ceil(minutes / 1440);
            burn_after_unit = 'day';
        } else if (minutes >= 120) { // >= 2 —á–∞—Å–æ–≤
            burn_after_value = Math.ceil(minutes / 60);
            burn_after_unit = 'hour';
        } else {
            burn_after_value = minutes;
            burn_after_unit = 'min';
        }
    }

    const formData = {
		code: document.getElementById('promoCode').value.trim(),
		bot: document.getElementById('promoBot').value,
		vpn_plan_id: selectedVpnPlans.length > 0 ? selectedVpnPlans : null,
		tariff_code: selectedTariffs.length > 0 ? selectedTariffs : null,
		discount_amount: parseFloat(document.getElementById('promoDiscountAmount').value) || 0,
		discount_percent: parseFloat(document.getElementById('promoDiscountPercent').value) || 0,
		discount_bonus: parseFloat(document.getElementById('promoDiscountBonus').value) || 0,
		usage_limit_per_bot: parseInt(document.getElementById('promoUsageLimit').value) || 1,
		is_active: document.getElementById('promoIsActive').checked,
        burn_after_value: burn_after_value,
        burn_after_unit: burn_after_unit,
		valid_until: document.getElementById('promoValidUntil').value || null,
		target_group_ids: selectedGroups.length > 0 ? selectedGroups : null,
		bot_username: getBotUsername()
	};
	
	// –í–∞–ª–∏–¥–∞—Ü–∏—è
	if (!formData.code) {
		showNotification('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
		return;
	}
	
	if (formData.code.length < 3) {
		showNotification('–ü—Ä–æ–º–æ–∫–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞', 'error');
		return;
	}
	
	if (formData.code.length > 50) {
		showNotification('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±–æ–ª–µ–µ 50 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
		return;
	}
	
	if (!/^[A-Z0-9_-]+$/.test(formData.code)) {
		showNotification('–ü—Ä–æ–º–æ–∫–æ–¥ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è', 'error');
		return;
	}
	
	if (!formData.bot) {
		showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞', 'error');
		return;
	}
	
	// –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∫–∏–¥–æ–∫
	if (formData.discount_amount < 0) {
		showNotification('–°–∫–∏–¥–∫–∞ –≤ —Ä—É–±–ª—è—Ö –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π', 'error');
		return;
	}
	
	if (formData.discount_percent < 0 || formData.discount_percent > 100) {
		showNotification('–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 100', 'error');
		return;
	}
	
	if (formData.discount_bonus < 0) {
		showNotification('–ë–æ–Ω—É—Å–Ω–∞—è —Å–∫–∏–¥–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π', 'error');
		return;
	}
	
	if (formData.usage_limit_per_bot < 1) {
		showNotification('–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 1', 'error');
		return;
	}
	
	// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É–∫–∞–∑–∞–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å–∫–∏–¥–∫–∞
	if (formData.discount_amount === 0 && formData.discount_percent === 0 && formData.discount_bonus === 0) {
		showNotification('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–ø —Å–∫–∏–¥–∫–∏', 'error');
		return;
	}
	
    // –î–æ–ø. –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è: –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ datetime
	
	try {
		const url = currentPromoId ? `/api/promo-codes/${currentPromoId}` : '/api/promo-codes';
		const method = currentPromoId ? 'PUT' : 'POST';
		
		console.log('Sending data:', formData);
		
		const response = await fetchWithCSRF(url, {
			method: method,
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(formData)
		});
		
		console.log('Response status:', response.status);
		console.log('Response headers:', response.headers);
		
		if (!response.ok) {
			const errorText = await response.text();
			console.error('Error response:', errorText);
			showNotification(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status}): ${errorText}`, 'error');
			return;
		}
		
		const data = await response.json();
		console.log('Response data:', data);
		
		if (data.success) {
			showNotification(currentPromoId ? '–ü—Ä–æ–º–æ–∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω', 'success');
			closePromoModal();
			loadPromoCodes();
		} else {
			showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
		}
	} catch (error) {
		console.error('Error saving promo code:', error);
		showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞: ' + error.message, 'error');
	}
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
async function deletePromoCode() {
	if (!currentPromoId) return;
	
	// –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
	try {
		const response = await fetchWithCSRF(`/api/promo-codes/${currentPromoId}/can-delete`);
		const data = await response.json();
		
		if (data.success) {
			if (!data.can_delete) {
				showNotification(`–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥: –æ–Ω –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω ${data.usage_count} —Ä–∞–∑(–∞). –£–¥–∞–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∏–∑ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.`, 'error');
				return;
			}
			
			if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
				return;
			}
			
			// –í—ã–ø–æ–ª–Ω—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
			const deleteResponse = await fetchWithCSRF(`/api/promo-codes/${currentPromoId}`, {
				method: 'DELETE'
			});
			
			const deleteData = await deleteResponse.json();
			
			if (deleteData.success) {
				showNotification('–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª–µ–Ω', 'success');
				closePromoModal();
				loadPromoCodes();
			} else {
				showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + deleteData.message, 'error');
			}
		} else {
			showNotification('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.message, 'error');
		}
	} catch (error) {
		console.error('Error deleting promo code:', error);
		showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞', 'error');
	}
}

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
async function confirmDeletePromoCode(promoId) {
	// –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
	try {
		const response = await fetchWithCSRF(`/api/promo-codes/${promoId}/can-delete`);
		const data = await response.json();
		
		if (data.success) {
			if (!data.can_delete) {
				showNotification(`–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥: –æ–Ω –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω ${data.usage_count} —Ä–∞–∑(–∞). –£–¥–∞–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∏–∑ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.`, 'error');
				return;
			}
			
			if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
				deletePromoCodeDirect(promoId);
			}
		} else {
			showNotification('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.message, 'error');
		}
	} catch (error) {
		console.error('Error checking deletion possibility:', error);
		showNotification('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
	}
}

// –ü—Ä—è–º–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
async function deletePromoCodeDirect(promoId) {
	try {
		const response = await fetchWithCSRF(`/api/promo-codes/${promoId}`, {
			method: 'DELETE'
		});
		
		const data = await response.json();
		
		if (data.success) {
			showNotification('–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª–µ–Ω', 'success');
			loadPromoCodes();
		} else {
			showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.message, 'error');
		}
	} catch (error) {
		console.error('Error deleting promo code:', error);
		showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞', 'error');
	}
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
async function loadPromoUsageHistory(promoId) {
	try {
		const response = await fetchWithCSRF(`/api/promo-codes/${promoId}/usage`);
		const data = await response.json();
		
		if (data.success) {
			renderPromoUsageTable(data.usage_history);
		}
	} catch (error) {
		console.error('Error loading promo usage history:', error);
	}
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
function renderPromoUsageTable(usageHistory) {
	const tbody = document.getElementById('promoUsageTable');
	
	if (usageHistory.length === 0) {
		tbody.innerHTML = '<tr><td colspan="10" class="text-center">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
		return;
	}
	
    tbody.innerHTML = usageHistory.map(usage => `
        <tr>
            <td class="actions-cell">
                <div class="kebab-wrapper">
                    <button class="kebab-btn" onclick="toggleKebabMenu('kebab-usage-${usage.usage_id}')" title="–î–µ–π—Å—Ç–≤–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="kebab-menu" id="kebab-usage-${usage.usage_id}">
                        <button type="button" class="kebab-item" onclick="closeKebabMenu('kebab-usage-${usage.usage_id}'); deletePromoUsage(${usage.usage_id}, ${usage.user_id}, '${usage.bot}')" title="–£–¥–∞–ª–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ">
                            <i class="fas fa-trash"></i>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
            </td>
            <td title="ID –∑–∞–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è">${usage.usage_id}</td>
            <td>${usage.user_id}</td>
            <td>${usage.username || '-'}</td>
            <td><span class="badge badge-${usage.bot === 'shop' ? 'primary' : 'secondary'}">${usage.bot === 'shop' ? 'Shop' : 'Support'}</span></td>
            <td>${formatDiscount(usage)}</td>
            <td>${usage.plan_name || '-'}</td>
            <td>${formatDate(usage.used_at)}</td>
            <td><span class="badge badge-${usage.status === 'used' ? 'success' : 'info'}" title="${usage.status === 'used' ? '–ü—Ä–æ–º–æ–∫–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ' : '–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω, –Ω–æ –ø–æ–∫—É–ø–∫–∞ –Ω–µ —Å–æ–≤–µ—Ä—à–µ–Ω–∞'}">${usage.status === 'used' ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' : '–ü—Ä–∏–º–µ–Ω—ë–Ω'}</span></td>
            <td>${usage.metadata ? `<button type="button" class="button button-outline button-sm" onclick="showMetadata(this)" data-metadata="${encodeURIComponent(usage.metadata)}" title="–ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ"><i class="fas fa-info-circle"></i></button>` : '-'}</td>
        </tr>
    `).join('');
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
async function deletePromoUsage(usageId, userId, bot) {
    if (!usageId || !userId) return;
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞?')) return;
    try {
        const normalizedBot = (bot || '').toString().toLowerCase();
        const response = await fetchWithCSRF(`/api/user-promo-codes/${usageId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, bot: normalizedBot })
        });
        const data = await response.json();
        if (data && data.success) {
            showNotification('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
            if (typeof currentPromoId === 'number' && currentPromoId) {
                await loadPromoUsageHistory(currentPromoId);
            }
        } else {
            showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data && data.message ? data.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞:', e);
        showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è', 'error');
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –≤ Drawer –ø—Ä–æ–º–æ–∫–æ–¥–∞
function switchPromoTab(tabName) {
    const scope = document.getElementById('promoDrawer');
    scope.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    scope.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    event.target.closest('.tab-button').classList.add('active');
    scope.querySelector(`#tab-${tabName}`).classList.add('active');
    if (tabName === 'summary') {
        updatePromoSummary();
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ Drawer
function closePromoDrawer() {
    const drawer = document.getElementById('promoDrawer');
    drawer.classList.remove('active');
    setTimeout(() => { drawer.style.display = 'none'; }, 300);
}
// –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
function closePromoModal() { closePromoDrawer(); }

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function refreshPromoCodes() {
	loadPromoCodes();
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
function formatDate(dateString) {
	if (!dateString) return '-';
	const date = new Date(dateString);
	return date.toLocaleString('ru-RU');
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
	// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
	const flashDiv = document.createElement('div');
	flashDiv.className = `flash flash-${type}`;
	flashDiv.innerHTML = `
		<span class="flash-message">${message}</span>
		<button class="flash-close" onclick="this.parentElement.remove()" title="–ó–∞–∫—Ä—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ">&times;</button>
	`;
	
	const mainContent = document.querySelector('.main-content');
	mainContent.insertBefore(flashDiv, mainContent.firstChild);
	
	// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
	setTimeout(() => {
		if (flashDiv.parentElement) {
			flashDiv.remove();
		}
	}, 5000);
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–∞–≤–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫
function switchMainTab(tabName) {
	// –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤–∫–ª–∞–¥–æ–∫
	document.querySelectorAll('.main-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
	event.target.closest('.tab-button').classList.add('active');
	
	// –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫
	document.querySelectorAll('.main-tabs-content .tab-content').forEach(content => content.classList.remove('active'));
	document.getElementById(`tab-${tabName}`).classList.add('active');
	
	// –û–±–Ω–æ–≤–ª—è–µ–º header-panel
	updateHeaderPanel(tabName);
	
	// –û–±–Ω–æ–≤–ª—è–µ–º URL
	updateURL(tabName);
	
	// –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∏—Å—Ç–æ—Ä–∏—é, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
	if (tabName === 'history' && allUsageHistory.length === 0) {
		loadUsageHistory();
	}
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ header-panel –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
function updateHeaderPanel(tabName) {
	const promocodesActions = document.getElementById('promocodesActions');
	const historyActions = document.getElementById('historyActions');
	
	if (tabName === 'promocodes') {
		promocodesActions.style.display = 'flex';
		historyActions.style.display = 'none';
	} else if (tabName === 'history') {
		promocodesActions.style.display = 'none';
		historyActions.style.display = 'flex';
	}
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL —Å query –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
function updateURL(tabName) {
	const url = new URL(window.location);
	if (tabName === 'promocodes') {
		url.searchParams.set('tab', 'promocodes');
	} else if (tabName === 'history') {
		url.searchParams.set('tab', 'promohistory');
	}
	window.history.pushState({}, '', url);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ –∏–∑ URL
function initTabFromURL() {
	const urlParams = new URLSearchParams(window.location.search);
	const tab = urlParams.get('tab');
	
	if (tab === 'promohistory') {
		// –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ò—Å—Ç–æ—Ä–∏—è"
		document.querySelectorAll('.main-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
		document.querySelector('.main-tabs .tab-button[onclick*="history"]').classList.add('active');
		
		document.querySelectorAll('.main-tabs-content .tab-content').forEach(content => content.classList.remove('active'));
		document.getElementById('tab-history').classList.add('active');
		
		updateHeaderPanel('history');
	} else {
		// –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª–∞–¥–∫–∞ "–ü—Ä–æ–º–æ–∫–æ–¥—ã"
		updateHeaderPanel('promocodes');
	}
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
async function loadUsageHistory() {
	try {
		console.log('Loading usage history...');
		showHistoryLoadingState();
		const response = await fetchWithCSRF('/api/promo-codes-usage-history');
		const data = await response.json();
		
		if (data.success) {
			allUsageHistory = data.usage_history;
			filteredUsageHistory = [...allUsageHistory];
			updateHistoryCount(allUsageHistory.length);
			renderUsageHistoryTable(filteredUsageHistory);
		} else {
			showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + data.message, 'error');
			showHistoryEmptyState();
		}
	} catch (error) {
		console.error('Error loading usage history:', error);
		showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏', 'error');
		showHistoryEmptyState();
	}
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
function showHistoryLoadingState() {
	const tbody = document.querySelector('#usageHistoryTable tbody');
	const emptyState = document.getElementById('historyEmptyState');
	
	emptyState.style.display = 'none';
	tbody.innerHTML = '<tr><td colspan="10" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
function showHistoryEmptyState() {
	const tbody = document.querySelector('#usageHistoryTable tbody');
	const emptyState = document.getElementById('historyEmptyState');
	
	tbody.innerHTML = '';
	emptyState.style.display = 'flex';
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –∏—Å—Ç–æ—Ä–∏–∏
function updateHistoryCount(count) {
	document.getElementById('historyCount').textContent = count;
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
function renderUsageHistoryTable(usageHistory) {
	const tbody = document.querySelector('#usageHistoryTable tbody');
	const emptyState = document.getElementById('historyEmptyState');
	
	emptyState.style.display = 'none';
	
	if (usageHistory.length === 0) {
		tbody.innerHTML = '<tr><td colspan="10" class="text-center">–ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
		return;
	}
	
	tbody.innerHTML = usageHistory.map(usage => `
		<tr>
			<td title="ID –∑–∞–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è">${usage.usage_id}</td>
			<td><code>${usage.code}</code></td>
			<td>${usage.user_id}</td>
			<td>${usage.username || '-'}</td>
			<td><span class="badge badge-${usage.bot === 'shop' ? 'primary' : 'secondary'}">${usage.bot === 'shop' ? 'Shop' : 'Support'}</span></td>
			<td>${formatDiscount(usage)}</td>
			<td>${usage.plan_name || '-'}</td>
			<td>${formatDate(usage.used_at)}</td>
			<td><span class="badge badge-${usage.status === 'used' ? 'success' : 'info'}" title="${usage.status === 'used' ? '–ü—Ä–æ–º–æ–∫–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ' : '–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω, –Ω–æ –ø–æ–∫—É–ø–∫–∞ –Ω–µ —Å–æ–≤–µ—Ä—à–µ–Ω–∞'}">${usage.status === 'used' ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' : '–ü—Ä–∏–º–µ–Ω—ë–Ω'}</span></td>
			<td>${usage.metadata ? `<button type="button" class="button button-outline button-sm" onclick="showMetadata(this)" data-metadata="${encodeURIComponent(usage.metadata)}" title="–ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ"><i class="fas fa-info-circle"></i></button>` : '-'}</td>
		</tr>
	`).join('');
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–∏–¥–∫–∏
function formatDiscount(usage) {
	const parts = [];
	if (usage.discount_amount && usage.discount_amount > 0) {
		parts.push(`${usage.discount_amount}‚ÇΩ`);
	}
	if (usage.discount_percent && usage.discount_percent > 0) {
		parts.push(`${usage.discount_percent}%`);
	}
	if (usage.discount_bonus && usage.discount_bonus > 0) {
		parts.push(`${usage.discount_bonus}–ë`);
	}
	return parts.length > 0 ? parts.join(' –∏ ') : '-';
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
function filterUsageHistory() {
	const dateFrom = document.getElementById('filterDateFrom').value;
	const dateTo = document.getElementById('filterDateTo').value;
	const user = document.getElementById('filterUser').value.toLowerCase();
	const status = document.getElementById('filterStatus').value;
	const bot = document.getElementById('filterBot').value;
	const promoCode = document.getElementById('filterPromoCode').value.toLowerCase();
	
	filteredUsageHistory = allUsageHistory.filter(usage => {
		// –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
		if (dateFrom) {
			const usageDate = new Date(usage.used_at);
			const fromDate = new Date(dateFrom);
			if (usageDate < fromDate) return false;
		}
		if (dateTo) {
			const usageDate = new Date(usage.used_at);
			const toDate = new Date(dateTo);
			toDate.setHours(23, 59, 59, 999); // –í–∫–ª—é—á–∞–µ–º –≤–µ—Å—å –¥–µ–Ω—å
			if (usageDate > toDate) return false;
		}
		
		// –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
		if (user) {
			const userStr = usage.user_id.toString() + (usage.username || '');
			if (!userStr.toLowerCase().includes(user)) return false;
		}
		
		// –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
		if (status && usage.status !== status) return false;
		
		// –§–∏–ª—å—Ç—Ä –ø–æ –±–æ—Ç—É
		if (bot && usage.bot !== bot) return false;
		
		// –§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É
		if (promoCode && !usage.code.toLowerCase().includes(promoCode)) return false;
		
		return true;
	});
	
	updateHistoryCount(filteredUsageHistory.length);
	renderUsageHistoryTable(filteredUsageHistory);
}

// –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function clearHistoryFilters() {
	document.getElementById('filterDateFrom').value = '';
	document.getElementById('filterDateTo').value = '';
	document.getElementById('filterUser').value = '';
	document.getElementById('filterStatus').value = '';
	document.getElementById('filterBot').value = '';
	document.getElementById('filterPromoCode').value = '';
	
	filteredUsageHistory = [...allUsageHistory];
	updateHistoryCount(filteredUsageHistory.length);
	renderUsageHistoryTable(filteredUsageHistory);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
function refreshUsageHistory() {
	loadUsageHistory();
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function filterPromoCodes() {
	const promoCode = document.getElementById('filterPromoCode').value.toLowerCase();
	const bot = document.getElementById('filterPromoBot').value;
	const status = document.getElementById('filterPromoStatus').value;
	const dateFrom = document.getElementById('filterPromoDateFrom').value;
	const dateTo = document.getElementById('filterPromoDateTo').value;
	const groups = document.getElementById('filterPromoGroups').value;
	
	filteredPromoCodes = allPromoCodes.filter(promo => {
		// –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–¥—É –ø—Ä–æ–º–æ–∫–æ–¥–∞
		if (promoCode && !promo.code.toLowerCase().includes(promoCode)) return false;
		
		// –§–∏–ª—å—Ç—Ä –ø–æ –±–æ—Ç—É
		if (bot && promo.bot !== bot) return false;
		
		// –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
		if (status) {
			if (status === 'active' && !promo.is_active) return false;
			if (status === 'inactive' && promo.is_active) return false;
		}
		
		// –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
		if (dateFrom) {
			const promoDate = new Date(promo.created_at);
			const fromDate = new Date(dateFrom);
			if (promoDate < fromDate) return false;
		}
		if (dateTo) {
			const promoDate = new Date(promo.created_at);
			const toDate = new Date(dateTo);
			toDate.setHours(23, 59, 59, 999); // –í–∫–ª—é—á–∞–µ–º –≤–µ—Å—å –¥–µ–Ω—å
			if (promoDate > toDate) return false;
		}
		
		// –§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä—É–ø–ø–∞–º
		if (groups) {
			const hasGroups = promo.target_group_ids && promo.target_group_ids.length > 0;
			if (groups === 'with_groups' && !hasGroups) return false;
			if (groups === 'without_groups' && hasGroups) return false;
		}
		
		return true;
	});
	
	updatePromoCount(filteredPromoCodes.length);
	if (isCardView) {
		renderPromoCards(filteredPromoCodes);
	} else {
		renderPromoCodesTable(filteredPromoCodes);
	}
}

// –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function clearPromoFilters() {
	document.getElementById('filterPromoCode').value = '';
	document.getElementById('filterPromoBot').value = '';
	document.getElementById('filterPromoStatus').value = '';
	document.getElementById('filterPromoDateFrom').value = '';
	document.getElementById('filterPromoDateTo').value = '';
	document.getElementById('filterPromoGroups').value = '';
	
	filteredPromoCodes = [...allPromoCodes];
	updatePromoCount(filteredPromoCodes.length);
	if (isCardView) {
		renderPromoCards(filteredPromoCodes);
	} else {
		renderPromoCodesTable(filteredPromoCodes);
	}
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
function showMetadata(buttonElement) {
	const encodedMetadata = buttonElement.getAttribute('data-metadata');
	if (!encodedMetadata) {
		showNotification('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
		return;
	}
	
	try {
		// –î–µ–∫–æ–¥–∏—Ä—É–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
		const metadata = decodeURIComponent(encodedMetadata);
		
		// –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
		const parsed = JSON.parse(metadata);
		const formatted = JSON.stringify(parsed, null, 2);
		showNotification(`–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:\n${formatted}`, 'info', 10000);
	} catch (e) {
		// –ï—Å–ª–∏ –Ω–µ JSON, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
		const metadata = decodeURIComponent(encodedMetadata);
		showNotification(`–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: ${metadata}`, 'info', 10000);
	}
}

// –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener('DOMContentLoaded', function() {
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ –∏–∑ URL
	initTabFromURL();
	
	// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫ —Ñ–∏–ª—å—Ç—Ä–∞–º –∏—Å—Ç–æ—Ä–∏–∏
	const historyFilterInputs = ['filterDateFrom', 'filterDateTo', 'filterUser', 'filterStatus', 'filterBot', 'filterPromoCode'];
	historyFilterInputs.forEach(id => {
		const element = document.getElementById(id);
		if (element) {
			element.addEventListener('input', filterUsageHistory);
			element.addEventListener('change', filterUsageHistory);
		}
	});
	
	// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫ —Ñ–∏–ª—å—Ç—Ä–∞–º –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
	const promoFilterInputs = ['filterPromoCode', 'filterPromoBot', 'filterPromoStatus', 'filterPromoDateFrom', 'filterPromoDateTo', 'filterPromoGroups'];
	promoFilterInputs.forEach(id => {
		const element = document.getElementById(id);
		if (element) {
			element.addEventListener('input', filterPromoCodes);
			element.addEventListener('change', filterPromoCodes);
		}
	});
	
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è date picker –¥–ª—è –ø–æ–ª–µ–π –¥–∞—Ç
	initDatePickers();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è date picker —Å Flatpickr
function initDatePickers() {
	// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Flatpickr –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
	const flatpickrConfig = {
		locale: 'ru',
		dateFormat: 'd.m.Y',
		allowInput: true,
		clickOpens: true,
		theme: 'dark',
		onChange: function(selectedDates, dateStr, instance) {
			// –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ change –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
			instance.element.dispatchEvent(new Event('change'));
		}
	};
	
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Flatpickr –¥–ª—è –ø–æ–ª–µ–π –¥–∞—Ç –∏—Å—Ç–æ—Ä–∏–∏
	const dateFromInput = document.getElementById('filterDateFrom');
	const dateToInput = document.getElementById('filterDateTo');
	
	if (dateFromInput) {
		flatpickr(dateFromInput, flatpickrConfig);
	}
	
	if (dateToInput) {
		flatpickr(dateToInput, flatpickrConfig);
	}
	
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Flatpickr –¥–ª—è –ø–æ–ª–µ–π –¥–∞—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
	const promoDateFromInput = document.getElementById('filterPromoDateFrom');
	const promoDateToInput = document.getElementById('filterPromoDateTo');
	
	if (promoDateFromInput) {
		flatpickr(promoDateFromInput, flatpickrConfig);
	}
	
	if (promoDateToInput) {
		flatpickr(promoDateToInput, flatpickrConfig);
	}
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ drawer –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('promoDrawer');
    if (overlay) {
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                closePromoDrawer();
            }
        });
    }
});
</script>
{% endblock %}

