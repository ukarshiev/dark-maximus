{% extends "base.html" %} 
{% block title %}Управление Пользователями{% endblock %}
{% block header_title %}Пользователи{% endblock %}

{% block header_buttons %}
<button class="button button-primary" data-size="sm" onclick="openTopupBalanceModal()" title="Пополнить баланс пользователя">
	<i class="fas fa-plus-circle"></i>
	Пополнить баланс
</button>
<button class="button button-warning" data-size="sm" onclick="openTrialResetModal()" title="Сбросить триал пользователя">
	<i class="fas fa-redo"></i>
	Сбросить триал
</button>
{% endblock %}

{% block content %}


<section class="settings-section settings-section--fluid">
	<div class="table-scroll-x">
		<table class="users-table">
			<thead>
				<tr>
					<th class="actions-cell">Меню</th>
					<th>Telegram ID</th>
					<th>Username</th>
					<th>Статус</th>
					<th>Согласие с документами</th>
					<th>Каналы</th>
					<th>Ключи</th>
					<th title="Количество уведомлений, отправленных пользователю">Уведомления</th>
					<th title="Исп-дней-повтор">Триал</th>
					<th>Баланс</th>
					<th>Заработано</th>
				</tr>
			</thead>
			<tbody>
				{% for user in users %}
				<tr class="user-row" data-user-id="{{ user.telegram_id }}" data-username="{{ user.username or 'N/A' }}" data-is-banned="{{ 'true' if user.is_banned else 'false' }}" data-keys-count="{{ user.user_keys|length if user.user_keys else 0 }}">
					<td class="actions-cell">
						<div class="kebab-wrapper">
							<button class="kebab-btn" onclick="toggleKebabMenu('kebab-user-{{ user.telegram_id }}')" title="Действия с пользователем">
								<i class="fas fa-ellipsis-v"></i>
							</button>
							<div class="kebab-menu" id="kebab-user-{{ user.telegram_id }}">
								{% if user.is_banned %}
								<form action="{{ url_for('unban_user_route', user_id=user.telegram_id) }}" method="post">
									<button type="submit" class="kebab-item" onclick="closeKebabMenu('kebab-user-{{ user.telegram_id }}')" title="Разблокировать пользователя">
										<i class="fas fa-unlock"></i>
										<span>Разбанить</span>
									</button>
								</form>
								{% else %}
								<form action="{{ url_for('ban_user_route', user_id=user.telegram_id) }}" method="post" data-confirm="Вы уверены, что хотите забанить этого пользователя? Он не сможет пользоваться ботом.">
									<button type="submit" class="kebab-item" onclick="closeKebabMenu('kebab-user-{{ user.telegram_id }}')" title="Заблокировать пользователя">
										<i class="fas fa-lock"></i>
										<span>Забанить</span>
									</button>
								</form>
								{% endif %}
								<form action="{{ url_for('revoke_keys_route', user_id=user.telegram_id) }}" method="post" data-confirm="ВНИМАНИЕ! Это действие удалит ВСЕ ключи пользователя с серверов. Вы уверены?">
									<button type="submit" class="kebab-item danger" onclick="closeKebabMenu('kebab-user-{{ user.telegram_id }}')" {% if not user.user_keys %}disabled title="Нет ключей для отзыва"{% endif %} title="{% if user.user_keys %}Отозвать все ключи пользователя{% else %}Нет ключей для отзыва{% endif %}">
										<i class="fas fa-key"></i>
										<span>Отозвать ключи</span>
									</button>
								</form>
								{% if user.agreed_to_documents %}
								<form action="{{ url_for('revoke_consent_route', user_id=user.telegram_id) }}" method="post" data-confirm="Вы уверены, что хотите отозвать согласие этого пользователя с документами?">
									<button type="submit" class="kebab-item warning" onclick="closeKebabMenu('kebab-user-{{ user.telegram_id }}')" title="Отозвать согласие пользователя с документами">
										<i class="fas fa-user-times"></i>
										<span>Отозвать согласие</span>
									</button>
								</form>
								{% endif %}
							<button type="button" class="kebab-item" onclick="closeKebabMenu('kebab-user-{{ user.telegram_id }}'); openUserModalFromElement(this)" title="Открыть карточку пользователя">
									<i class="fas fa-user"></i>
									<span>Открыть карточку</span>
								</button>
							<button type="button" class="kebab-item" onclick="closeKebabMenu('kebab-user-{{ user.telegram_id }}'); openTopupBalanceModalFromElement(this)" title="Пополнить баланс пользователя">
									<i class="fas fa-plus-circle"></i>
									<span>Пополнить баланс</span>
								</button>
								{% if user.trial_used %}
								<form action="{{ url_for('reset_trial_route', user_id=user.telegram_id) }}" method="post" data-confirm="Вы уверены, что хотите разрешить повторное использование триала?">
									<button type="submit" class="kebab-item" onclick="closeKebabMenu('kebab-user-{{ user.telegram_id }}')" title="Разрешить повторное использование пробного периода">
										<i class="fas fa-redo"></i>
										<span>Повторный триал</span>
									</button>
								</form>
								{% endif %}
							</div>
						</div>
					</td>
					<td data-field="telegram_id" data-original="{{ user.telegram_id }}">
						<div class="cell-inline">
							<span>{{ hidden_mode and '***' or user.telegram_id }}</span>
						</div>
					</td>
                    <td data-field="username" data-original="@{{ user.username or 'N/A' }}">
                        <div class="cell-inline">
                            <span class="username-text">{{ hidden_mode and '@***' or ('@' ~ (user.username or 'N/A')) }}</span>
                        </div>
                    </td>
					<td>
						{% if user.is_banned %}
						<span class="status-badge status-banned">Забанен</span>
						{% else %}
						<span class="status-badge status-active">Активен</span>
						{% endif %}
					</td>
					<td>
						{% if user.agreed_to_documents %}
						<span class="status-badge status-active">✅ Согласен</span>
						{% else %}
						<span class="status-badge status-banned">❌ Не согласен</span>
						{% endif %}
					</td>
					<td>
						{% if user.subscription_status == 'subscribed' %}
						<span class="status-badge status-active">✅ Подписан</span>
						{% elif user.subscription_status == 'not_subscribed' %}
						<span class="status-badge status-banned">❌ Не подписан</span>
						{% else %}
						<span class="status-badge status-banned">❓ Не проверено</span>
						{% endif %}
					</td>
					<td>
						{% if user.user_keys %} {{ user.user_keys | length }} шт. {% else %}
						0 {% endif %}
					</td>
                    <td>
                        {{ user.notifications_count or 0 }}
                    </td>
					<td title="Исп-дней-повтор">
						{{ (user.trial_used or 0) }}-{{ (user.trial_days_given or 0) }}-{{ (user.trial_reuses_count or 0) }}
					</td>
					<td class="user-balance" data-user-id="{{ user.telegram_id }}">
						{{ hidden_mode and '*** RUB' or ('%0.2f RUB'|format((user.balance or 0))) }}
					</td>
					<td data-field="earned" class="user-earned" data-user-id="{{ user.telegram_id }}">{{ hidden_mode and '*** RUB' or 'Загрузка...' }}</td>
					
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</section>

<!-- Модальное окно для пополнения баланса -->
<div id="topupBalanceModal" class="modal" style="display: none;">
	<div class="modal-content">
		<div class="modal-header">
			<h3>Пополнить баланс</h3>
			<span class="close" onclick="closeTopupBalanceModal()" title="Закрыть окно">&times;</span>
		</div>
		<div class="modal-body">
			<form id="topupBalanceForm">
				<div class="form-group">
					<label for="topupUserSearch">Пользователь:</label>
					<input type="text" id="topupUserSearch" placeholder="Введите Telegram ID или username для поиска" title="Введите Telegram ID или username для поиска" oninput="debouncedUserSearch(this.value, 'topup')">
					<div id="topupUserSuggestions" class="suggestions"></div>
					<input type="hidden" id="topupSelectedUserId">
					<div id="topupSelectedUserLabel" class="selected-user-label"></div>
				</div>
				<div class="form-group">
					<label for="topupAmount">Сумма (RUB):</label>
					<input type="number" id="topupAmount" min="1" step="1" placeholder="Введите сумму пополнения" title="Введите сумму пополнения в рублях">
				</div>
			</form>
		</div>
		<div class="modal-footer">
			<button type="button" class="button button-secondary" onclick="closeTopupBalanceModal()" title="Отменить пополнение баланса">
				Отменить
			</button>
			<button type="button" class="button button-primary" onclick="submitTopupBalance()" title="Сохранить пополнение баланса">
				Сохранить
			</button>
		</div>
	</div>
</div>

<!-- Модальное окно для сброса триала -->
<div id="trialResetModal" class="modal" style="display: none;">
	<div class="modal-content">
		<div class="modal-header">
			<h3>Сбросить триал пользователя</h3>
			<span class="close" onclick="closeTrialResetModal()" title="Закрыть окно">&times;</span>
		</div>
		<div class="modal-body">
			<div class="form-description">
				Эта функция полностью сбрасывает всю информацию о триале пользователя, 
				будто он никогда не использовал пробный период. Пользователь сможет 
				заново получить триал.
			</div>
			
			<form id="trialResetForm">
				<div class="form-group">
					<label for="trialResetUserSearch">Пользователь:</label>
					<input type="text" id="trialResetUserSearch" placeholder="Введите Telegram ID или username для поиска" title="Введите Telegram ID или username для поиска" oninput="debouncedUserSearch(this.value, 'trialReset')">
					<div id="trialResetUserSuggestions" class="suggestions"></div>
					<input type="hidden" id="trialResetSelectedUserId">
					<div id="trialResetSelectedUserLabel" class="selected-user-label"></div>
				</div>
				
				<div class="form-group">
					<label class="checkbox-label">
						<input 
							type="checkbox" 
							id="confirmTrialReset" 
							required
							title="Подтвердите, что понимаете последствия сброса триала"
						>
						<span class="checkbox-text">
							Я понимаю, что это действие полностью сбросит всю информацию о триале пользователя
						</span>
					</label>
				</div>
			</form>
			
			<div class="info-panel">
				<h4>Что происходит при сбросе триала:</h4>
				<ul>
					<li>Сбрасывается флаг использования триала (trial_used = 0)</li>
					<li>Обнуляется количество выданных дней триала (trial_days_given = 0)</li>
					<li>Обнуляется счетчик повторных использований (trial_reuses_count = 0)</li>
					<li>Пользователь сможет заново получить пробный период</li>
				</ul>
				
				<div class="warning-box">
					<i class="fas fa-exclamation-triangle"></i>
					<strong>Внимание:</strong> Это действие необратимо. Убедитесь, что вы выбрали правильного пользователя.
				</div>
			</div>
		</div>
		<div class="modal-footer">
			<button type="button" class="button button-secondary" onclick="closeTrialResetModal()" title="Отменить сброс триала">
				Отменить
			</button>
			<button type="button" class="button button-danger" onclick="submitTrialReset()" id="submitTrialResetButton" title="Выполнить сброс триала" disabled>
				<i class="fas fa-exclamation-triangle"></i>
				Сбросить триал
			</button>
		</div>
	</div>
</div>

{% endblock %}
