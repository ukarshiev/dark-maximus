{% extends "base.html" %} 
{% block title %}Управление Пользователями{% endblock %}
{% block header_title %}Пользователи{% endblock %}
%} {% block content %}


<section class="settings-section settings-section--fluid">
	<div class="table-scroll-x">
		<table class="users-table">
			<thead>
				<tr>
					<th class="actions-cell">Меню</th>
					<th>Telegram ID</th>
					<th>Username</th>
					<th>Статус</th>
					<th>Ключи</th>
					<th title="Количество уведомлений, отправленных пользователю">Уведомления</th>
					<th>Баланс</th>
					<th>Заработано</th>
				</tr>
			</thead>
			<tbody>
				{% for user in users %}
				<tr class="user-row" data-user-id="{{ user.telegram_id }}" data-username="{{ user.username or 'N/A' }}" data-is-banned="{{ 'true' if user.is_banned else 'false' }}" data-keys-count="{{ user.user_keys|length if user.user_keys else 0 }}">
					<td class="actions-cell">
						<div class="kebab-menu">
							<button type="button" class="kebab-toggle kebab-btn" aria-haspopup="true" aria-expanded="false" data-size="sm" title="Действия с пользователем">
								<i class="fas fa-ellipsis-v"></i>
							</button>
							<div class="kebab-dropdown">
								{% if user.is_banned %}
								<form action="{{ url_for('unban_user_route', user_id=user.telegram_id) }}" method="post">
									<button type="submit" class="kebab-item" title="Разблокировать пользователя">
										<i class="fas fa-unlock"></i>
										Разбанить
									</button>
								</form>
								{% else %}
								<form action="{{ url_for('ban_user_route', user_id=user.telegram_id) }}" method="post" data-confirm="Вы уверены, что хотите забанить этого пользователя? Он не сможет пользоваться ботом.">
									<button type="submit" class="kebab-item" title="Заблокировать пользователя">
										<i class="fas fa-lock"></i>
										Забанить
									</button>
								</form>
								{% endif %}
								<form action="{{ url_for('revoke_keys_route', user_id=user.telegram_id) }}" method="post" data-confirm="ВНИМАНИЕ! Это действие удалит ВСЕ ключи пользователя с серверов. Вы уверены?">
									<button type="submit" class="kebab-item kebab-item-danger" {% if not user.user_keys %}disabled title="Нет ключей для отзыва"{% endif %} title="{% if user.user_keys %}Отозвать все ключи пользователя{% else %}Нет ключей для отзыва{% endif %}">
										<i class="fas fa-key"></i>
										Отозвать ключи
									</button>
								</form>
							</div>
						</div>
					</td>
					<td data-field="telegram_id" data-original="{{ user.telegram_id }}">
						<div class="cell-inline">
							<span>{{ hidden_mode and '***' or user.telegram_id }}</span>
						</div>
					</td>
                    <td data-field="username" data-original="@{{ user.username or 'N/A' }}">
                        <div class="cell-inline">
                            <span class="username-text">{{ hidden_mode and '@***' or ('@' ~ (user.username or 'N/A')) }}</span>
                        </div>
                    </td>
					<td>
						{% if user.is_banned %}
						<span class="status-badge status-banned">Забанен</span>
						{% else %}
						<span class="status-badge status-active">Активен</span>
						{% endif %}
					</td>
					<td>
						{% if user.user_keys %} {{ user.user_keys | length }} шт. {% else %}
						0 {% endif %}
					</td>
                    <td>
                        {{ user.notifications_count or 0 }}
                    </td>
					<td class="user-balance" data-user-id="{{ user.telegram_id }}">
						{{ hidden_mode and '*** RUB' or ('%0.2f RUB'|format((user.balance or 0))) }}
					</td>
					<td data-field="earned" class="user-earned" data-user-id="{{ user.telegram_id }}">{{ hidden_mode and '*** RUB' or 'Загрузка...' }}</td>
					
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</section>

{% endblock %}
